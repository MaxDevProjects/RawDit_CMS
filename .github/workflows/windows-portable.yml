name: Windows portable

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci --omit=dev

      - name: Build assets
        run: npm run build

      - name: Prepare portable folder
        run: node core/scripts/package-windows-portable.js

      - name: Bundle Node runtime
        shell: pwsh
        run: |
          $nodePath = (Get-Command node).Source
          Copy-Item -Force $nodePath "dist\rawdit-windows-portable\runtime\node.exe"

      - name: Zip portable
        shell: pwsh
        run: |
          Compress-Archive -Force -Path "dist\rawdit-windows-portable\*" -DestinationPath "dist\rawdit-windows-portable.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rawdit-windows-portable
          path: dist/rawdit-windows-portable.zip

