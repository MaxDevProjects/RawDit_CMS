(()=>{document.addEventListener("DOMContentLoaded",()=>{console.log("[admin] Atelier charg\xE9");let Pt=document.querySelector("[data-logout]");Pt&&Pt.addEventListener("click",async()=>{Pt.disabled=!0;try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(r){console.error("[admin] Impossible de se d\xE9connecter",r)}finally{window.location.href="/admin/index.html"}});let nt=document.querySelector("[data-admin-sidebar]"),ye=document.querySelector("[data-admin-sidebar-overlay]"),is=document.querySelectorAll("[data-admin-sidebar-toggle]"),Bs=document.querySelectorAll("[data-admin-sidebar-close]"),Mt=document.body,yt=!1,vt=()=>{if(!nt)return;if(window.matchMedia("(min-width: 1024px)").matches){nt.classList.remove("hidden"),ye==null||ye.classList.add("hidden"),Mt.classList.remove("overflow-hidden");return}yt?(nt.classList.remove("hidden"),ye==null||ye.classList.remove("hidden"),Mt.classList.add("overflow-hidden")):(nt.classList.add("hidden"),ye==null||ye.classList.add("hidden"),Mt.classList.remove("overflow-hidden"))},$s=()=>{yt=!0,vt()},Dt=()=>{yt=!1,vt()};nt&&is.length>0&&(is.forEach(r=>{r.addEventListener("click",$s)}),Bs.forEach(r=>{r.addEventListener("click",Dt)}),ye==null||ye.addEventListener("click",Dt),window.addEventListener("resize",vt),window.addEventListener("keydown",r=>{r.key==="Escape"&&yt&&Dt()}),vt());let ls="clower:currentSite",cs="clower:currentSiteName",_={slug:null,name:""};(()=>{try{_.slug=window.localStorage.getItem(ls),_.name=window.localStorage.getItem(cs)||""}catch{_.slug=null,_.name=""}})();let Ot=document.querySelectorAll("[data-site-card]"),js=document.querySelectorAll("[data-site-select]"),ot=document.querySelector("[data-current-site-name]"),ds=document.querySelector("[data-workspace-site-name]"),us=document.querySelector("[data-workspace-back-name]"),Re=document.querySelector("[data-workspace-back-modal]"),Ns=document.querySelectorAll("[data-workspace-back]"),Ps=document.querySelectorAll("[data-workspace-back-cancel]"),Rt=document.querySelector("[data-workspace-back-confirm]"),Ms=document.querySelectorAll("[data-workspace-tab]"),Ut=document.querySelector("[data-site-toast]"),ms=document.querySelector("[data-site-toast-message]"),Ds=document.querySelectorAll("[data-site-create]"),ce=document.querySelector("[data-site-modal]"),je=document.querySelector("[data-site-form]"),we=document.querySelector("[data-site-name]"),qe=document.querySelector("[data-site-slug]"),fe=document.querySelector("[data-site-slug-error]"),ke=document.querySelector("[data-site-modal-error]"),Os=document.querySelectorAll("[data-site-modal-cancel]"),We=document.querySelector("[data-site-modal-submit]"),J=Ws(),bt=!1,xt=null,Ht=null,Rs='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',ps=r=>{if(!ce||ce.classList.contains("hidden")||r.key!=="Tab")return;let u=Array.from(ce.querySelectorAll(Rs)).filter(F=>!F.hasAttribute("disabled")&&!F.getAttribute("aria-hidden"));if(u.length===0)return;let v=u[0],C=u[u.length-1];r.shiftKey?document.activeElement===v&&(r.preventDefault(),C.focus()):document.activeElement===C&&(r.preventDefault(),v.focus())},N=r=>{!Ut||!ms||(ms.textContent=r,Ut.classList.remove("hidden"),Ht&&clearTimeout(Ht),Ht=setTimeout(()=>{Ut.classList.add("hidden")},2500))};function Ne(r){return r?r.startsWith("/")?r:`/${r}`:""}function Ae(r){return(r==null?void 0:r.replace(/^\//,""))||""}let wt=(r,u)=>{let v=r?Ne(r):null;try{v&&(window.localStorage.setItem(ls,v),_.slug=v),typeof u=="string"&&u.length>0&&(window.localStorage.setItem(cs,u),_.name=u)}catch{_.slug=v||_.slug,_.name=u||_.name}},fs=r=>{ot&&r&&(ot.textContent=r),ds&&r&&(ds.textContent=r),us&&r&&(us.textContent=r)},zt=r=>{Ms.forEach(u=>{let v=u.dataset.workspaceTab;if(!v)return;if(!r){u.href="#",u.classList.add("pointer-events-none","opacity-50","text-slate-400"),u.setAttribute("aria-disabled","true");return}let C=encodeURIComponent(Ae(r));u.href=`/admin/site/${C}/${v}`,u.classList.remove("pointer-events-none","opacity-50","text-slate-400"),u.removeAttribute("aria-disabled")})},St=(r,u={})=>{if(!r)return;let v=Ne(r),C=u.siteName||_.name||(ot==null?void 0:ot.dataset.defaultSiteName)||"";Ot.forEach(S=>{let k=Ne(S.dataset.siteCard||"")===v,h=S.querySelector("[data-site-active-badge]");k?(S.classList.add("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),S.classList.remove("border-slate-200"),h==null||h.classList.remove("hidden"),C=S.dataset.siteName||C):(S.classList.remove("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),S.classList.add("border-slate-200"),h==null||h.classList.add("hidden"))}),u.persist!==!1&&wt(v,u.siteName||C);let F=u.siteName||C;fs(F),zt(v)},Us=async(r,u)=>{let v=Ne(r);try{let C=await fetch("/api/sites/select",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slug:v})});if(!C.ok){let h=await C.json().catch(()=>({}));N(h.message||"Impossible de s\xE9lectionner ce site.");return}let F=await C.json().catch(()=>({})),S=Ne(F.slug||v),V=F.name||u;wt(S,V),St(S,{siteName:V,persist:!1});let k=encodeURIComponent(Ae(S));window.location.href=`/admin/site/${k}/design`}catch(C){console.error("[admin] Impossible de s\xE9lectionner le site",C),N("Erreur inattendue lors de la s\xE9lection.")}},Hs=async()=>{try{let r=await fetch("/api/sites/current",{credentials:"same-origin"});if(!r.ok){r.status===404&&J&&(window.location.href="/admin/sites");return}let u=await r.json(),v=Ne(u.slug);wt(v,u.name),St(v,{siteName:u.name,persist:!1})}catch(r){console.warn("[admin] Impossible de r\xE9cup\xE9rer le site actif",r)}};(()=>{if(_.slug){St(_.slug,{siteName:_.name,persist:!1});return}let r=document.querySelector('[data-site-card][data-site-default="true"]')||Ot[0];r&&St(r.dataset.siteCard,{siteName:r.dataset.siteName||"",persist:!1})})(),Hs(),J?zt(J.slugValue):_.slug&&zt(_.slug),js.forEach(r=>{r.addEventListener("click",()=>{if(r.disabled)return;let u=r.dataset.siteSelect,v=r.dataset.siteSelectName||"Ce site";u&&(r.disabled=!0,Us(u,v).finally(()=>{r.disabled=!1}))})});let rt=r=>r.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),zs=r=>{let u=rt(r||"");return u?`/${u}`:""},Vs=()=>{ce&&(xt=document.activeElement,ce.classList.remove("hidden"),ce.classList.add("flex"),bt=!1,je==null||je.reset(),fe&&(fe.textContent=""),ke&&(ke.textContent=""),qe&&we&&(qe.value=rt(we.value)),document.addEventListener("keydown",ps),window.setTimeout(()=>{we==null||we.focus()},0))},Lt=()=>{ce&&(ce.classList.add("hidden"),ce.classList.remove("flex"),document.removeEventListener("keydown",ps),bt=!1,je==null||je.reset(),fe&&(fe.textContent=""),ke&&(ke.textContent=""),xt==null||xt.focus())};Ds.forEach(r=>{r.addEventListener("click",Vs)}),Os.forEach(r=>{r.addEventListener("click",Lt)}),ce==null||ce.addEventListener("click",r=>{r.target===ce&&Lt()}),we==null||we.addEventListener("input",()=>{qe&&(!bt||qe.value.trim().length===0)&&(qe.value=rt(we.value))}),qe==null||qe.addEventListener("input",()=>{bt=!0,fe&&(fe.textContent="")});let Js=()=>new Set(Array.from(Ot).map(r=>Ne(r.dataset.siteCard||"")));je==null||je.addEventListener("submit",async r=>{if(r.preventDefault(),!we||!qe)return;let u=(we.value||"").trim(),v=qe.value||"";v||(v=u);let C=zs(v);if(!u||!C){fe&&(fe.textContent="Nom et slug sont requis.");return}if(Js().has(C)){fe&&(fe.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}fe&&(fe.textContent=""),ke&&(ke.textContent=""),We&&(We.disabled=!0,We.textContent="Cr\xE9ation...");try{let S=await fetch("/api/sites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:u,slug:C})});if(!S.ok){let M=await S.json().catch(()=>({})),L=M.message||"Impossible de cr\xE9er ce site.";ke&&(ke.textContent=L),M.field==="slug"&&fe&&(fe.textContent=L);return}let V=await S.json(),k=Ne((V==null?void 0:V.slug)||C),h=(V==null?void 0:V.name)||u;wt(k,h),Lt();let A=encodeURIComponent(Ae(k));window.location.href=`/admin/site/${A}/design`}catch(S){console.error("[admin] Impossible de cr\xE9er le site",S),ke&&(ke.textContent="Erreur inattendue. R\xE9essaie dans un instant.")}finally{We&&(We.disabled=!1,We.textContent="Cr\xE9er")}}),window.addEventListener("keydown",r=>{r.key==="Escape"&&(ce&&!ce.classList.contains("hidden")&&Lt(),Re&&!Re.classList.contains("hidden")&&gs(),blockDeleteModal&&!blockDeleteModal.classList.contains("hidden")&&closeBlockDeleteModal(),blockLibraryOpen&&closeBlockLibrary())});function Ws(){let r=window.location.pathname.match(/^\/admin\/site\/([^/]+)(?:\/([^/]+))?/);return r?{slugPart:decodeURIComponent(r[1]),slugValue:Ne(decodeURIComponent(r[1])),section:r[2]||"design"}:null}function Gs(){return document.querySelector("[data-page-list]")?"design":document.querySelector("[data-collection-list]")?"content":document.querySelector("[data-media-grid]")?"media":document.querySelector("[data-deploy-form]")?"deploy":null}function _s(){if(!Re){window.location.href="/admin/sites";return}Re.classList.remove("hidden"),Re.classList.add("flex")}function gs(){Re&&(Re.classList.add("hidden"),Re.classList.remove("flex"))}Ns.forEach(r=>{r.addEventListener("click",_s)}),Ps.forEach(r=>{r.addEventListener("click",gs)}),Rt==null||Rt.addEventListener("click",()=>{window.location.href="/admin/sites"});let at=(J==null?void 0:J.section)||Gs();at==="design"&&Ys(),at==="content"&&Ks(),at==="media"&&Qs(),at==="deploy"&&Xs(),at==="settings"&&Zs(),J&&_.name&&fs(_.name);function Ys(){let r=document.querySelectorAll("[data-page-list]");if(r.length===0)return;let u=document.querySelector("[data-active-page-title]"),v=document.querySelector("[data-active-page-slug]"),C=document.querySelector("[data-page-preview-tags]"),F=document.querySelector("[data-page-preview-frame]"),S=document.querySelector("[data-preview-open]"),V=document.querySelector("[data-preview-status]"),k=document.querySelector("[data-preview-highlight]"),h=document.querySelector("[data-seo-toggle]"),A=document.querySelector("[data-seo-panel]"),M=document.querySelector("[data-seo-close]"),L=document.querySelector("[data-seo-form]"),I=document.querySelector("[data-seo-title]"),y=document.querySelector("[data-seo-description]"),m=document.querySelector("[data-seo-feedback]"),w=document.querySelector("[data-seo-save]"),f=document.querySelector("[data-blocks-list]"),D=document.querySelector("[data-blocks-empty]"),oe=document.querySelector("[data-block-count]"),W=document.querySelector("[data-block-library-toggle]"),se=document.querySelector("[data-block-library]"),Y=document.querySelectorAll("[data-block-add]"),U=document.querySelector("[data-block-delete-modal]"),G=document.querySelector("[data-block-delete-confirm]"),H=document.querySelector("[data-block-delete-cancel]"),T=document.querySelector("[data-block-detail-empty]"),b=document.querySelector("[data-block-detail-status]"),g=document.querySelector("[data-block-editor]"),P=document.querySelector("[data-block-editor-block-name]"),l=document.querySelector("[data-block-editor-block-type]"),a=document.querySelector("[data-block-editor-unsupported]"),c=document.querySelector("[data-block-form]"),K=c?Array.from(c.querySelectorAll("[data-editor-section]")):[],O=c==null?void 0:c.querySelector('[name="collection-grid-collection"]'),Q=c==null?void 0:c.querySelector("[data-collection-selection-info]"),ge=document.querySelector("[data-block-form-cancel]"),ne=c==null?void 0:c.querySelector("[data-group-preview-mobile]"),ee=c==null?void 0:c.querySelector("[data-group-preview-desktop]"),ve={hero:{section:"hero",labelField:"title",descriptionField:"subtitle",fields:{title:"hero-title",subtitle:"hero-subtitle",ctaLabel:"hero-cta-label",ctaUrl:"hero-cta-url",image:"hero-image",align:"hero-align"}},paragraphe:{section:"paragraph",labelField:"title",descriptionField:"content",fields:{title:"paragraph-title",content:"paragraph-content",align:"paragraph-align"}},image:{section:"image",labelField:"alt",fields:{src:"image-src",alt:"image-alt",showCaption:"image-caption-toggle",caption:"image-caption"}},groupe:{section:"group",fields:{layout:"group-layout",columnsMobile:"group-columns-mobile",columnsDesktop:"group-columns-desktop"}},collectiongrid:{section:"collection",fields:{collectionId:"collection-grid-collection",limit:"collection-grid-limit"}},form:{section:"form",labelField:"formTitle",fields:{formTitle:"form-title",actionUrl:"form-action-url",method:"form-method",serviceName:"form-service-name",submitLabel:"form-submit-label",successMessage:"form-success-message"}},newsletterembed:{section:"newsletter",labelField:"title",fields:{title:"newsletter-title",serviceName:"newsletter-service-name",embedCode:"newsletter-embed-code"}}},Se={texte:"paragraphe",paragraph:"paragraphe",paragraphs:"paragraphe",paragraphes:"paragraphe",text:"paragraphe",hero:"hero",image:"image",groupe:"groupe",group:"groupe",collection:"collectiongrid",collectiongrid:"collectiongrid","collection-grid":"collectiongrid",form:"form",formulaire:"form",contact:"form",newsletterembed:"newsletterembed",newsletter:"newsletterembed",embed:"newsletterembed"},Le=(e,t)=>{if(!ne||!ee)return;let s=n=>Array.from({length:Number(n)||1}).map(()=>'<span class="block h-2 w-full rounded-full bg-slate-300"></span>').join("");ne.innerHTML=s(e),ee.innerHTML=s(t)},re=async()=>{if(!xe)return[];let e=await fetch(xe,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les pages.");let t=await e.json().catch(()=>[]);return Array.isArray(t)?t:[]},Pe=async({title:e,slug:t})=>{if(!xe)throw new Error("Site inconnu.");let s=await fetch(xe,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,slug:t})});if(!s.ok){let n=await s.json().catch(()=>({}));throw new Error(n.message||"Impossible de cr\xE9er la page.")}return s.json().catch(()=>({}))},ae=async e=>{if(!(!xe||!(e!=null&&e.id)))try{let t=await fetch(`${xe}/${encodeURIComponent(e.id)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let n=await t.json().catch(()=>({}));throw new Error(n.message||"Impossible de sauvegarder la page.")}let s=await t.json().catch(()=>({}));if(s!=null&&s.id){let n=pt(s);return Z=Z.map(d=>d.id===n.id?n:d),(q==null?void 0:q.id)===n.id&&(q=n),n}return s}catch(t){console.error("[design] Save page failed",t),N(t.message||"Sauvegarde impossible.")}},be=async()=>{if(!xe){Z=[],me=null,q=null,tt(Z,me),et(null),T==null||T.classList.remove("hidden"),g==null||g.classList.add("hidden");return}try{let e=await re();if(Z=(Array.isArray(e)?e:[]).map(t=>pt(t)),Z.length===0){me=null,q=null,tt(Z,me),et(null),T==null||T.classList.remove("hidden"),g==null||g.classList.add("hidden"),F&&(F.srcdoc=Ie());return}me=rn(Z),Be(me)}catch(e){console.error("[design] Impossible de charger les pages",e),N("Impossible de charger les pages.")}},Me=e=>(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),Ge=e=>{if(!e)return null;let t=Me(e.type),s=Se[t]||t;return ve[s]||null},_e=e=>{var s,n,d;if(!c||!g)return;e&&!e.settings&&(e.settings={});let t=Ge(e);if(P&&(P.textContent=(e==null?void 0:e.label)||"Bloc"),l&&(l.textContent=(e==null?void 0:e.type)||"Bloc"),!t){c.classList.add("hidden"),a==null||a.classList.remove("hidden"),c.dataset.blockId="";return}if(a==null||a.classList.add("hidden"),c.classList.remove("hidden"),c.reset(),c.dataset.blockId=e.id,K.forEach(E=>{E.dataset.editorSection===t.section?E.classList.remove("hidden"):E.classList.add("hidden")}),t.section==="collection"){let E=e.collectionId||((s=e.settings)==null?void 0:s.collectionId)||"";Bt(E)}if(Object.entries(t.fields).forEach(([E,z])=>{var Je;let X=c.querySelector(`[name="${z}"]`);if(!X)return;let le=(Je=e.settings)==null?void 0:Je[E];X.type==="checkbox"?X.checked=!!le:X.type==="number"?X.value=le!=null?le:1:(X.tagName,X.value=le!=null?le:"")}),t.section==="group"){let E=((n=c.querySelector('[name="group-columns-mobile"]'))==null?void 0:n.value)||"1",z=((d=c.querySelector('[name="group-columns-desktop"]'))==null?void 0:d.value)||"3";Le(E,z)}},Ye=e=>{if(!c||!e)return{};let t={};return Object.entries(e.fields).forEach(([s,n])=>{let d=c.querySelector(`[name="${n}"]`);if(d)if(d.type==="checkbox")t[s]=d.checked;else if(d.type==="number"){let E=Number(d.value);t[s]=Number.isFinite(E)?E:0}else d.tagName==="TEXTAREA"?t[s]=d.value||"":d.type==="select-one"?t[s]=d.value:t[s]=d.value||""}),t},Ce=e=>{if(V){if(!e){V.classList.add("hidden");return}V.classList.remove("hidden"),V.textContent=e}},Ke=e=>e?{id:e.id,title:e.title,slug:e.slug,badges:[...e.badges||[]],blocks:(e.blocks||[]).map(t=>{var s;return{id:t.id,type:t.type,label:t.label,status:t.status,description:t.description,props:t.props||[],settings:t.settings||{},collectionId:t.collectionId||((s=t.settings)==null?void 0:s.collectionId)||""}})}:null,Ie=()=>'<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#475569;background:#fff;">Pr\xE9paration de la pr\xE9visualisation\u2026</body></html>',i=e=>{if(!F||!e)return;let t=(J==null?void 0:J.slugValue)||_.slug||"",s={page:Ke(e),site:{title:_.name||"Site",slug:t}};es=!1,Ce("Actualisation\u2026"),F.srcdoc=Ie(),mt&&mt.abort();let n=new AbortController;mt=n,fetch("/api/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s),signal:n.signal}).then(d=>{if(!d.ok)throw new Error("Preview error");return d.json()}).then(d=>{n.signal.aborted||(Qt=d.html||"",F.setAttribute("title",`Pr\xE9visualisation de la page ${e.title||""}`.trim()),F.srcdoc=Qt||Ie(),Ce("\xC0 jour"))}).catch(d=>{n.signal.aborted||(console.error("[preview] Impossible de rendre la page",d),Ce("Erreur preview"),F.srcdoc='<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#be123c;background:#fff;">Erreur lors du rendu de la pr\xE9visualisation.</body></html>')}).finally(()=>{mt===n&&(mt=null)})},x=e=>{if(e.preventDefault(),!q||!pe)return;let t=Yt(),s=Ge(t);if(!t||!s)return;let n=Ye(s);if(s.section==="collection"){if(!n.collectionId){N("S\xE9lectionnez une collection.");return}n.limit=Math.max(1,Number(n.limit)||1)}let d=(q.blocks||[]).map(E=>{if(E.id!==t.id)return E;let z={...E.settings||{},...n},X={...E,settings:z};return s.labelField&&n[s.labelField]&&(X.label=n[s.labelField]),s.descriptionField&&n[s.descriptionField]&&(X.description=n[s.descriptionField]),s.section==="collection"&&(X.collectionId=n.collectionId,X.settings.collectionId=n.collectionId,X.settings.limit=n.limit),X});dt(d),N("Bloc mis \xE0 jour"),Be(q.id,{preserveBlock:!0})},R=document.querySelector("[data-page-drawer]"),B=document.querySelector("[data-page-drawer-backdrop]"),ze=document.querySelectorAll("[data-page-drawer-open]"),Xe=document.querySelectorAll("[data-page-drawer-close]"),Fe=document.querySelector("[data-add-page-toggle]"),he=document.querySelector("[data-add-page-form]"),o=document.querySelector("[data-add-page-title]"),p=document.querySelector("[data-add-page-slug]"),$=document.querySelector("[data-add-page-cancel]"),j=document.querySelector("[data-add-page-error]"),te=he==null?void 0:he.querySelector('[type="submit"]'),Ve=document.querySelector("[data-import-pages-toggle]"),ie=document.querySelector("[data-import-modal]"),Ue=document.querySelectorAll("[data-import-modal-close]"),de=document.querySelector("[data-import-dropzone]"),Ze=document.querySelector("[data-import-file-input]"),Qe=document.querySelector("[data-import-file-list]"),it=document.querySelector("[data-import-file-names]"),Ct=document.querySelector("[data-import-results]"),Et=document.querySelector("[data-import-results-content]"),ue=document.querySelector("[data-import-submit]"),hs=document.querySelectorAll("[data-import-tab]"),en=document.querySelectorAll("[data-import-panel]"),Vt=document.querySelector("[data-copy-template]"),ys=document.querySelector("[data-template-json]"),He=[],Te=document.querySelector("[data-delete-page-modal]"),vs=document.querySelector("[data-delete-page-name]"),Jt=document.querySelector("[data-delete-page-cancel]"),De=document.querySelector("[data-delete-page-confirm]"),lt=null,tn=Ae((J==null?void 0:J.slugValue)||_.slug||"default")||"default",sn=(J==null?void 0:J.slugValue)||_.slug||"",qt=Ae(sn)||"",xe=qt?`/api/sites/${encodeURIComponent(qt)}/pages`:null,bs=qt?`/api/sites/${encodeURIComponent(qt)}/collections`:null,xs={active:`clower:activePage:${tn}`},Wt=(e,t,s,n,d,E=[],z={})=>{let X={id:e,label:t,type:s,status:n,description:d,props:E,settings:{...z}};return X.settings.collectionId&&(X.collectionId=X.settings.collectionId),X},nn={hero:{type:"Hero",label:"Hero de page",description:"Section pleine largeur avec CTA principal.",status:"Brouillon",props:[{label:"CTA",value:"D\xE9couvrir"},{label:"Hauteur",value:"80vh"}],settings:{title:"Titre du hero",subtitle:"",ctaLabel:"D\xE9couvrir",ctaUrl:"#",image:"",align:"center"}},paragraph:{type:"Paragraphe",label:"Bloc \xE9ditorial",description:"Paragraphe libre pour raconter votre histoire.",status:"Brouillon",props:[{label:"Longueur",value:"150 mots"}],settings:{title:"Titre du paragraphe",content:"",align:"left"}},image:{type:"Image",label:"Bloc image",description:"Visuel seul avec l\xE9gende optionnelle.",status:"Brouillon",props:[{label:"Ratio",value:"16:9"},{label:"L\xE9gende",value:"Inactive"}],settings:{src:"",alt:"",showCaption:!1,caption:""}},group:{type:"Groupe",label:"Groupe de sections",description:"Conteneur pour imbriquer plusieurs sous-blocs.",status:"Brouillon",props:[{label:"Disposition",value:"Verticale"}],settings:{layout:"grid",columnsMobile:"1",columnsDesktop:"3"}},collectiongrid:{type:"CollectionGrid",label:"Grille de contenus",description:"Affiche automatiquement les items d\u2019une collection.",status:"Brouillon",settings:{collectionId:"",limit:6}},form:{type:"Form",label:"Formulaire de contact",description:"Formulaire avec envoi vers un service externe.",status:"Brouillon",settings:{formTitle:"Contactez-nous",actionUrl:"",method:"POST",serviceName:"",submitLabel:"Envoyer",successMessage:"Merci pour votre message !"}},newsletterembed:{type:"NewsletterEmbed",label:"Newsletter / Embed",description:"Int\xE9gration d'un formulaire newsletter externe (Brevo, Mailchimp\u2026).",status:"Brouillon",settings:{title:"Restez inform\xE9",serviceName:"",embedCode:""}}},on=e=>{try{window.localStorage.setItem(xs.active,e)}catch{}},rn=e=>{var t;try{let s=window.localStorage.getItem(xs.active);if(s&&e.some(n=>n.id===s))return s}catch{}return((t=e[0])==null?void 0:t.id)||null},an=e=>!e||e<=0?"0 bloc":e===1?"1 bloc":`${e} blocs`,ws=e=>{if(!e||e==="/")return"/";let t=rt(e.replace(/^\//,""));return t?`/${t}`:"/"},Gt=(e="page",t="block")=>`${e}-${t}-${Date.now().toString(36)}-${Math.floor(Math.random()*1e3)}`,Nn=(e,t)=>[Wt(Gt(e,"intro"),"Introduction","Paragraphe","Brouillon",`Paragraphe introductif pour "${t}".`,[{label:"Longueur",value:"2 paragraphes"}],{title:`Introduction \xE0 ${t}`,content:"Ajoutez votre premier paragraphe de pr\xE9sentation.",align:"left"}),Wt(Gt(e,"content"),"Zone de contenu","Groupe","Brouillon","Section principale \xE0 composer avec textes et visuels.",[{label:"Colonnes",value:"Auto"}],{layout:"grid",columnsMobile:"1",columnsDesktop:"2"})],ln=e=>{u&&(u.textContent=(e==null?void 0:e.title)||"Page"),v&&(v.textContent=(e==null?void 0:e.slug)||"/")},cn=e=>{if(!C)return;C.innerHTML="",(e&&e.badges&&e.badges.length>0?e.badges:["Structure en cours"]).forEach(s=>{let n=document.createElement("span");n.className="rounded-full bg-slate-100 px-3 py-1",n.textContent=s,C.appendChild(n)})},dn=e=>{switch((e||"").toLowerCase()){case"en ligne":return"bg-emerald-50 text-emerald-700";case"brouillon":return"bg-amber-50 text-amber-700";default:return"bg-slate-100 text-slate-600"}},kt=e=>{if(!(!T||!g)){if(!e){T.classList.remove("hidden"),g.classList.add("hidden"),a==null||a.classList.add("hidden"),c==null||c.classList.add("hidden"),b==null||b.classList.add("hidden");return}T.classList.add("hidden"),g.classList.remove("hidden"),b&&(e.status?(b.textContent=e.status,b.className=`rounded-full px-3 py-1 text-xs font-semibold ${dn(e.status)}`,b.classList.remove("hidden")):b.classList.add("hidden")),_e(e)}},ct=e=>{if(!F)return;let t=F.contentDocument;if(!t)return;t.querySelectorAll("[data-preview-block]").forEach(n=>{n.dataset.previewBlock===e?(n.classList.add("preview-block-active"),es&&e&&n.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})):n.classList.remove("preview-block-active")}),k&&(k.style.borderColor=e?"rgba(156, 107, 255, 0.5)":"transparent")},et=e=>{if(!f)return;f.innerHTML="";let t=(e==null?void 0:e.blocks)||[];if(oe&&(oe.textContent=an(t.length)),t.length===0){f.classList.add("hidden"),D==null||D.classList.remove("hidden");return}f.classList.remove("hidden"),D==null||D.classList.add("hidden"),t.forEach(s=>{var Ts;let n=s.id===pe,d=document.createElement("div");d.dataset.blockItem="true",d.dataset.blockId=s.id,d.setAttribute("role","option"),d.setAttribute("aria-selected",n?"true":"false"),d.tabIndex=0,d.className=["relative flex items-center gap-3 rounded-2xl border px-3 py-2 text-left transition",n?"bg-slate-100 border-[#9C6BFF]/40 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let E=document.createElement("span");E.className=`absolute inset-y-2 left-0 w-1 rounded-full bg-[#9C6BFF] ${n?"":"hidden"}`,d.appendChild(E);let z=document.createElement("div");z.className="flex flex-1 items-center gap-3";let X=document.createElement("div");X.className="hidden lg:flex cursor-grab flex-shrink-0 items-center text-lg text-slate-400",X.innerHTML="&#8801;",z.appendChild(X);let le=document.createElement("div");le.className="flex-1";let Je=document.createElement("div");Je.className="flex items-center gap-2 text-[11px] uppercase tracking-wide text-slate-500";let ns=document.createElement("span");ns.className="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600",ns.textContent=s.type;let os=document.createElement("span");os.className="text-slate-400",os.textContent=s.status,Je.appendChild(ns),Je.appendChild(os);let rs=document.createElement("p");rs.className="mt-1 text-sm font-semibold text-slate-900";let Tn=s.settings&&s.settings.title||s.label||"Bloc sans titre";if(rs.textContent=Tn,le.appendChild(Je),le.appendChild(rs),(s.type||"").toLowerCase()==="collectiongrid"&&s.collectionId){let Ee=((Ts=$e.find(Bn=>Bn.id===s.collectionId))==null?void 0:Ts.name)||s.collectionId,as=document.createElement("p");as.className="text-xs text-slate-400",as.textContent=`Collection : ${Ee}`,le.appendChild(as)}z.appendChild(le),d.appendChild(z);let jt=document.createElement("div");jt.className="flex flex-col gap-1 text-xs text-slate-400";let Nt=document.createElement("div");Nt.className="flex items-center gap-1 lg:hidden";let ft=document.createElement("button");ft.type="button",ft.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",ft.textContent="\u2191",ft.addEventListener("click",Ee=>{Ee.stopPropagation(),Ss(s.id,-1)});let gt=document.createElement("button");gt.type="button",gt.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",gt.textContent="\u2193",gt.addEventListener("click",Ee=>{Ee.stopPropagation(),Ss(s.id,1)}),Nt.appendChild(ft),Nt.appendChild(gt),jt.appendChild(Nt);let ht=document.createElement("button");ht.type="button",ht.className="inline-flex items-center justify-center rounded-lg border border-transparent px-2 py-1 text-[12px] text-rose-500 hover:text-rose-700",ht.innerHTML="\u{1F5D1}\uFE0F",ht.addEventListener("click",Ee=>{Ee.stopPropagation(),yn(s.id)}),jt.appendChild(ht),d.appendChild(jt),d.addEventListener("click",()=>{st(s.id)}),d.addEventListener("keydown",Ee=>{(Ee.key==="Enter"||Ee.key===" ")&&(Ee.preventDefault(),st(s.id))}),f.appendChild(d)})},un=e=>{!Te||!e||(lt=e,vs&&(vs.textContent=e.title||e.id),Te.classList.remove("hidden"),Te.classList.add("flex"))},_t=()=>{Te&&(Te.classList.add("hidden"),Te.classList.remove("flex"),lt=null)},mn=async()=>{if(!xe||!lt)return;let e=lt.id,t=lt.title||e;De&&(De.disabled=!0,De.textContent="Suppression...");try{let s=await fetch(`${xe}/${encodeURIComponent(e)}`,{method:"DELETE",credentials:"include"}),n=await s.json();if(!s.ok)throw new Error(n.message||"Erreur serveur");Z=Z.filter(d=>d.id!==e),me===e?Z.length>0?Be(Z[0].id):(me=null,q=null,tt(Z,null),et(null),T==null||T.classList.remove("hidden"),g==null||g.classList.add("hidden"),F&&(F.srcdoc=Ie())):tt(Z,me),_t(),N(`Page "${t}" supprim\xE9e`)}catch(s){console.error("[pages] delete failed",s),N(s.message||"Erreur suppression")}finally{De&&(De.disabled=!1,De.textContent="Supprimer")}},tt=(e,t)=>{r.forEach(s=>{s.innerHTML="",e.forEach(n=>{let d=document.createElement("li");d.className="flex items-center gap-1";let E=document.createElement("button");E.type="button",E.dataset.pageId=n.id,E.className=["flex-1 flex items-center gap-3 px-3 py-2 text-left transition",t===n.id?"bg-[#9C6BFF]/10 text-slate-900 border border-[#9C6BFF]/40 rounded-xl shadow-sm":"text-slate-700 hover:bg-slate-50 rounded-xl"].join(" "),t===n.id?E.setAttribute("aria-current","page"):E.removeAttribute("aria-current"),E.innerHTML=`
            <span class="flex h-9 w-9 items-center justify-center rounded-xl border border-slate-200 bg-white text-slate-500">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M6.5 4.5h7l4 4v11a1 1 0 0 1-1 1h-10a1 1 0 0 1-1-1v-14a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
                <path d="M13.5 4.5v4a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.4"/>
              </svg>
            </span>
            <div class="flex flex-col">
              <span class="text-sm font-semibold">${n.title}</span>
              <span class="text-xs text-slate-500">${n.slug}</span>
            </div>
          `,E.addEventListener("click",()=>{Be(n.id),Xt()||Zt()}),d.appendChild(E);let z=document.createElement("button");z.type="button",z.className="flex-shrink-0 p-2 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition",z.title="Supprimer cette page",z.setAttribute("aria-label",`Supprimer ${n.title}`),z.innerHTML=`
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14ZM10 11v6M14 11v6"/>
            </svg>
          `,z.addEventListener("click",X=>{X.stopPropagation(),un(n)}),d.appendChild(z),s.appendChild(d)})})},Yt=()=>!q||!Array.isArray(q.blocks)?null:q.blocks.find(e=>e.id===pe)||null,st=e=>{if(!q)return;if(!e){pe=null,et(q),kt(null),ct(null);return}let t=q.blocks.find(s=>s.id===e)||q.blocks[0]||null;pe=(t==null?void 0:t.id)||null,et(q),kt(t),ct(pe)},dt=e=>{if(!q)return;let t={...q,blocks:e};vn(t)},At=()=>window.matchMedia("(min-width: 1024px)").matches;function Ss(e,t){if(!q||!e||!t)return;let s=[...q.blocks||[]],n=s.findIndex(z=>z.id===e);if(n<0)return;let d=n+t;if(d<0||d>=s.length)return;let[E]=s.splice(n,1);s.splice(d,0,E),dt(s),Be(q.id,{preserveBlock:!0}),st(E.id)}function pn(e,t){if(!q||!e||!t||e===t)return;let s=[...q.blocks||[]],n=s.findIndex(z=>z.id===e),d=s.findIndex(z=>z.id===t);if(n<0||d<0)return;let[E]=s.splice(n,1);s.splice(d,0,E),dt(s),Be(q.id,{preserveBlock:!0}),st(E.id)}function Ls(){if(!f)return;let e=At();f.querySelectorAll("[data-block-item]").forEach(t=>{t.setAttribute("draggable",e?"true":"false")})}function It(){se&&(se.classList.add("hidden"),ut=!1)}function fn(){se&&(se.classList.remove("hidden"),ut=!0)}function gn(){ut?It():fn()}function hn(e){var E;if(!q||!e)return;let t=nn[e];if(!t)return;let s=(q.blocks||[]).filter(z=>z.type===t.type).length+1,n=Wt(Gt(q.id,e),`${t.label} ${s}`,t.type,t.status,t.description,t.props,t.settings||{});if((t.type||"").toLowerCase()==="collectiongrid"){let z=((E=$e[0])==null?void 0:E.id)||"";n.collectionId=z,n.settings.collectionId=z,n.settings.limit=n.settings.limit||6}let d=[...q.blocks||[],n];dt(d),Be(q.id,{preserveBlock:!0}),st(n.id),It(),N("Bloc ajout\xE9")}function Cs(e){var n,d;if(!q)return;let t=(q.blocks||[]).filter(E=>E.id!==e),s=e===pe?((n=t[0])==null?void 0:n.id)||null:pe||((d=t[0])==null?void 0:d.id)||null;dt(t),pe=s,Be(q.id,{preserveBlock:!0}),pe?st(pe):(kt(null),ct(null)),N("Bloc supprim\xE9")}function Kt(){U&&(U.classList.add("hidden"),U.classList.remove("flex"),Tt=null)}function yn(e){if(!U){Cs(e);return}Tt=e,U.classList.remove("hidden"),U.classList.add("flex")}let vn=e=>{if(!e)return;let t=pt(e);Z=Z.map(s=>s.id===t.id?t:s),q=t,ae(t)},Be=(e,t={})=>{var d,E;let s=Z.find(z=>z.id===e)||Z[0]||null;q=s?pt(s):null,me=(s==null?void 0:s.id)||null,(!t.preserveBlock||!q||!q.blocks.some(z=>z.id===pe))&&(pe=((E=(d=q==null?void 0:q.blocks)==null?void 0:d[0])==null?void 0:E.id)||null),me&&on(me),tt(Z,me),ln(q),cn(q),i(q),et(q),kt(Yt()),ct(pe),Ls(),ut&&It()},Xt=()=>window.matchMedia("(min-width: 1024px)").matches,Es=()=>{R&&(Xt()?(R.classList.add("is-open"),B==null||B.classList.add("hidden"),document.body.classList.remove("overflow-hidden")):R.classList.remove("is-open"))},bn=()=>{!R||Xt()||(R.classList.add("is-open"),B==null||B.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},Zt=()=>{R&&(R.classList.remove("is-open"),B==null||B.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))},xn=()=>{!he||!Fe||(he.classList.remove("hidden"),Fe.classList.add("hidden"),j&&(j.textContent=""),Ft=!1,o&&(o.value="",o.focus()),p&&(p.value=""))},qs=()=>{!he||!Fe||(he.classList.add("hidden"),Fe.classList.remove("hidden"),j&&(j.textContent=""),Ft=!1,he.reset())},wn=()=>{!o||!p||Ft&&p.value.trim().length>0||(p.value=ws(o.value))},Z=[],me=null,Ft=!1,q=null,pe=null,ut=!1,Tt=null,Qt="",es=!1,mt=null,$e=[],Sn=e=>{let t={...e,props:Array.isArray(e.props)?e.props:[],settings:{...e.settings||{}}};return(t.type||"").toLowerCase()==="collectiongrid"&&(t.collectionId=t.collectionId||t.settings.collectionId||"",t.settings.collectionId=t.collectionId,t.settings.limit=t.settings.limit||6),t},pt=e=>{var t,s;return{...e,blocks:(e.blocks||[]).map(n=>Sn(n)),seo:{title:(((t=e.seo)==null?void 0:t.title)||"").trim(),description:(((s=e.seo)==null?void 0:s.description)||"").trim()}}},Ln=async()=>{if(!bs){$e=[],Bt();return}try{let e=await fetch(bs,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les collections.");let t=await e.json().catch(()=>[]);$e=Array.isArray(t)?t:[];let s=(O==null?void 0:O.value)||"";Bt(s)}catch(e){console.error("[design] collections load",e),N("Collections indisponibles."),$e=[],Bt()}},ts=e=>{if(!Q)return;if(!e){Q.textContent=$e.length?"S\xE9lectionnez une collection pour afficher ses informations.":"Aucune collection disponible. Ajoutez-en depuis l\u2019onglet Contenus.";return}let t=$e.find(n=>n.id===e);if(!t){Q.textContent=`Collection ${e}`;return}let s=[];t.description&&s.push(t.description),t.type&&s.push(`Type\xA0: ${t.type}`),Q.textContent=s.join(" \xB7 ")||`Collection ${t.name||t.id}`},Bt=(e="")=>{if(O){if(O.innerHTML="",!$e.length){O.disabled=!0;let t=document.createElement("option");t.value="",t.textContent="Aucune collection disponible",O.appendChild(t),ts("");return}if(O.disabled=!1,e&&!$e.some(t=>t.id===e)){let t=document.createElement("option");t.value=e,t.textContent=e,O.appendChild(t)}$e.forEach(t=>{let s=document.createElement("option");s.value=t.id;let n=t.name||t.id;s.textContent=t.type?`${n} \xB7 ${t.type}`:n,s.dataset.description=t.description||"",O.appendChild(s)}),e&&(O.value=e),ts(O.value||"")}};Ln(),Es(),ze.forEach(e=>{e.addEventListener("click",bn)}),Xe.forEach(e=>{e.addEventListener("click",Zt)}),B==null||B.addEventListener("click",Zt),window.addEventListener("resize",()=>{Es(),Ls()}),Fe==null||Fe.addEventListener("click",xn),$==null||$.addEventListener("click",qs),o==null||o.addEventListener("input",wn),p==null||p.addEventListener("input",()=>{j&&(j.textContent=""),Ft=!0}),he==null||he.addEventListener("submit",async e=>{if(e.preventDefault(),!xe){j&&(j.textContent="Aucun site s\xE9lectionn\xE9.");return}if(!o||!p)return;let t=o.value.trim(),s=ws(p.value.trim()||t);if(!t||!s){j&&(j.textContent="Titre et slug sont requis.");return}j&&(j.textContent=""),te&&(te.disabled=!0,te.textContent="Cr\xE9ation...");try{let n=await Pe({title:t,slug:s});if(!n||!n.id)throw new Error("R\xE9ponse invalide.");Z=[...Z,pt(n)],qs(),N("Page cr\xE9\xE9e"),Be(n.id)}catch(n){console.error("[design] create page failed",n),j&&(j.textContent=n.message||"Impossible de cr\xE9er la page.")}finally{te&&(te.disabled=!1,te.textContent="Cr\xE9er")}});let Cn=()=>{ie&&(ie.classList.remove("hidden"),ie.classList.add("flex"),He=[],ss(),Ct&&Ct.classList.add("hidden"),Et&&(Et.innerHTML=""),ue&&(ue.disabled=!0))},ks=()=>{ie&&(ie.classList.add("hidden"),ie.classList.remove("flex"),He=[])},ss=()=>{if(!(!Qe||!it)){if(He.length===0){Qe.classList.add("hidden"),ue&&(ue.disabled=!0);return}Qe.classList.remove("hidden"),it.innerHTML=He.map(e=>`<li class="flex items-center gap-2"><span class="text-lg">\u{1F4C4}</span>${e.name}</li>`).join(""),ue&&(ue.disabled=!1)}},As=e=>{let t=Array.from(e).filter(s=>s.type==="application/json"||s.name.endsWith(".json"));if(t.length===0){N("Aucun fichier JSON valide.");return}He=t,ss()},En=async()=>{if(!(!xe||He.length===0)){ue&&(ue.disabled=!0,ue.textContent="Import...");try{let e=[];for(let n of He){let d=await n.text();try{let E=JSON.parse(d);Array.isArray(E)?e.push(...E):e.push(E)}catch(E){N(`Erreur JSON dans ${n.name}`),console.error("[import] parse error",n.name,E)}}if(e.length===0){N("Aucune page valide \xE0 importer.");return}let t=await fetch(`${xe}/import`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(e)}),s=await t.json();if(!t.ok)throw new Error(s.message||"Erreur serveur");if(Ct&&Et){Ct.classList.remove("hidden");let n="";s.imported&&s.imported.length>0&&(n+=`<p class="text-green-700">\u2713 ${s.imported.length} page(s) import\xE9e(s)</p>`,n+='<ul class="ml-4 text-xs text-slate-600">',s.imported.forEach(d=>{n+=`<li>${d.title} (${d.action==="updated"?"mise \xE0 jour":"cr\xE9\xE9e"})</li>`}),n+="</ul>"),s.errors&&s.errors.length>0&&(n+=`<p class="text-rose-600 mt-2">\u2717 ${s.errors.length} erreur(s)</p>`,n+='<ul class="ml-4 text-xs text-rose-500">',s.errors.forEach(d=>{n+=`<li>${d.title}: ${d.error}</li>`}),n+="</ul>"),Et.innerHTML=n}s.imported&&s.imported.length>0&&(Z=await re(),tt(Z,me),Z.length>0&&!me&&Be(Z[0].id),N(`${s.imported.length} page(s) import\xE9e(s)`)),He=[],ss()}catch(e){console.error("[import] failed",e),N(e.message||"Erreur import")}finally{ue&&(ue.disabled=!1,ue.textContent="Importer")}}};Ve==null||Ve.addEventListener("click",Cn),Ue.forEach(e=>e.addEventListener("click",ks)),ie==null||ie.addEventListener("click",e=>{e.target===ie&&ks()}),Ze==null||Ze.addEventListener("change",e=>{As(e.target.files)}),de==null||de.addEventListener("dragover",e=>{e.preventDefault(),de.classList.add("border-[#9C6BFF]","bg-[#9C6BFF]/10")}),de==null||de.addEventListener("dragleave",e=>{e.preventDefault(),de.classList.remove("border-[#9C6BFF]","bg-[#9C6BFF]/10")}),de==null||de.addEventListener("drop",e=>{e.preventDefault(),de.classList.remove("border-[#9C6BFF]","bg-[#9C6BFF]/10"),As(e.dataTransfer.files)}),ue==null||ue.addEventListener("click",En),hs.forEach(e=>{e.addEventListener("click",()=>{let t=e.dataset.importTab;hs.forEach(s=>{s.dataset.importTab===t?(s.classList.add("bg-[#9C6BFF]","text-white"),s.classList.remove("border","border-slate-200","text-slate-700")):(s.classList.remove("bg-[#9C6BFF]","text-white"),s.classList.add("border","border-slate-200","text-slate-700"))}),en.forEach(s=>{s.dataset.importPanel===t?s.classList.remove("hidden"):s.classList.add("hidden")})})}),Vt==null||Vt.addEventListener("click",async()=>{if(!ys)return;let e=ys.textContent||"";try{await navigator.clipboard.writeText(e),N("Template copi\xE9 !")}catch(t){console.error("[import] copy failed",t),N("Erreur copie")}}),Jt==null||Jt.addEventListener("click",_t),De==null||De.addEventListener("click",mn),Te==null||Te.addEventListener("click",e=>{e.target===Te&&_t()}),W==null||W.addEventListener("click",e=>{e.stopPropagation(),gn()}),document.addEventListener("click",e=>{ut&&(se!=null&&se.contains(e.target)||W!=null&&W.contains(e.target)||It())}),Y.forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();let s=e.dataset.blockAdd;hn(s)})}),H==null||H.addEventListener("click",()=>{Kt()}),G==null||G.addEventListener("click",()=>{Tt&&Cs(Tt),Kt()}),U==null||U.addEventListener("click",e=>{e.target===U&&Kt()}),c==null||c.addEventListener("input",e=>{var s,n;let t=e.target;if(!(!t||!t.name)&&(t.name==="group-columns-mobile"||t.name==="group-columns-desktop")){let d=((s=c.querySelector('[name="group-columns-mobile"]'))==null?void 0:s.value)||"1",E=((n=c.querySelector('[name="group-columns-desktop"]'))==null?void 0:n.value)||"3";Le(d,E)}}),O==null||O.addEventListener("change",e=>{let t=e.target;ts((t==null?void 0:t.value)||"")}),c==null||c.addEventListener("submit",x),ge==null||ge.addEventListener("click",e=>{e.preventDefault();let t=Yt();t&&_e(t)}),F==null||F.addEventListener("load",()=>{es=!0,Ce("\xC0 jour"),ct(pe)}),S==null||S.addEventListener("click",()=>{let e=window.open("","_blank");if(!e)return;e.opener=null;let t=e.document;t.open(),t.write(Qt||Ie()),t.close()});let Is=e=>{var t,s;A&&(e?(A.classList.remove("hidden"),q&&(I&&(I.value=((t=q.seo)==null?void 0:t.title)||""),y&&(y.value=((s=q.seo)==null?void 0:s.description)||""))):A.classList.add("hidden"))},$t=(e,t="muted")=>{if(!m)return;let s=t==="success"?"text-emerald-600":t==="error"?"text-rose-600":"text-slate-500";m.textContent=e||"",m.className=`text-sm ${s}`};h==null||h.addEventListener("click",()=>{let e=A&&!A.classList.contains("hidden");Is(!e)}),M==null||M.addEventListener("click",()=>Is(!1)),L==null||L.addEventListener("submit",async e=>{if(e.preventDefault(),!q){$t("Aucune page active.","error");return}w&&(w.disabled=!0),$t("");try{let t={title:((I==null?void 0:I.value)||"").trim(),description:((y==null?void 0:y.value)||"").trim()},s={...q,seo:t},n=await ae(s);n&&(q=n,$t("SEO enregistr\xE9.","success"),N("SEO mis \xE0 jour"),i(q))}catch(t){console.error("[seo] save failed",t),$t(t.message||"Erreur lors de la sauvegarde.","error")}finally{w&&(w.disabled=!1)}});let qn=e=>{let t=e.target.closest("[data-block-item]");!t||!At()||(Oe=t.dataset.blockId||null,Oe&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",Oe),t.classList.add("opacity-50")))},Fs=()=>{f==null||f.querySelectorAll("[data-block-item]").forEach(e=>e.classList.remove("opacity-50","ring-2","ring-[#9C6BFF]/50"))},kn=()=>{Oe=null,Fs()},An=e=>{if(!Oe||!At())return;let t=e.target.closest("[data-block-item]");!t||t.dataset.blockId===Oe||(e.preventDefault(),t.classList.add("ring-2","ring-[#9C6BFF]/50"))},In=e=>{let t=e.target.closest("[data-block-item]");t&&t.classList.remove("ring-2","ring-[#9C6BFF]/50")},Fn=e=>{if(!Oe||!At())return;e.preventDefault();let t=e.target.closest("[data-block-item]"),s=Oe;Oe=null,Fs();let n=(t==null?void 0:t.dataset.blockId)||null;n&&pn(s,n)},Oe=null;f==null||f.addEventListener("dragstart",qn),f==null||f.addEventListener("dragend",kn),f==null||f.addEventListener("dragover",An),f==null||f.addEventListener("dragleave",In),f==null||f.addEventListener("drop",Fn),be()}function Ks(){var Xe,Fe,he;let r=document.querySelector("[data-collection-list]");if(!r)return;let u=document.querySelector("[data-collection-empty]"),v=document.querySelector("[data-collection-items-empty]"),C=document.querySelector("[data-item-table-wrapper]"),F=document.querySelector("[data-item-table-body]"),S=document.querySelector("[data-collection-title]"),V=document.querySelector("[data-collection-description]"),k=document.querySelector("[data-collection-drawer]"),h=document.querySelector("[data-collection-drawer-backdrop]"),A=document.querySelectorAll("[data-collection-drawer-open]"),M=document.querySelectorAll("[data-collection-drawer-close]"),L=document.querySelector("[data-item-add]"),I=document.querySelector("[data-item-detail-empty]"),y=document.querySelector("[data-item-form]"),m=y?{title:y.querySelector('[name="item-title"]'),slug:y.querySelector('[name="item-slug"]'),excerpt:y.querySelector('[name="item-excerpt"]'),content:y.querySelector('[name="item-content"]'),image:y.querySelector('[name="item-image"]'),status:y.querySelector('[name="item-status"]')}:{},w=document.querySelector("[data-item-status-badge]"),f=document.querySelector("[data-item-delete]"),D=document.querySelector("[data-item-delete-modal]"),oe=document.querySelector("[data-item-delete-cancel]"),W=document.querySelector("[data-item-delete-confirm]"),se=document.querySelector("[data-item-cancel]"),Y=document.querySelector("[data-item-save]"),U="rounded-full px-3 py-1 text-xs font-semibold",G=Ae((J==null?void 0:J.slugValue)||_.slug||""),H=G?`/api/sites/${encodeURIComponent(G)}/collections`:null,T=[],b=[],g=null,P=null,l=!1,a=!1,c=null,K=()=>{k&&(k.classList.add("is-open"),k.style.transform="translateX(0)",h==null||h.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},O=()=>{k&&(k.classList.remove("is-open"),k.style.transform="",h==null||h.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))};A.forEach(o=>{o.addEventListener("click",K)}),M.forEach(o=>{o.addEventListener("click",O)}),h==null||h.addEventListener("click",O);let Q=o=>{let p=(o||"").trim();if(!p)return"";if(p==="/")return"/";let j=p.replace(/^\//,"").split("/").map(te=>rt(te||"")).filter(te=>te.length>0);return j.length?`/${j.join("/")}`:""},ge=o=>{if(!o)return"\u2014";let p=new Date(o);return Number.isNaN(p.getTime())?"\u2014":p.toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"})},ne=()=>{let o=T.find(p=>p.id===g);S&&(S.textContent=(o==null?void 0:o.name)||"S\xE9lectionnez une collection"),V&&(V.textContent=(o==null?void 0:o.description)||"")},ee=o=>{v&&(v.textContent=o||(g?"Aucun item dans cette collection pour le moment.":"Choisissez une collection dans le panneau de gauche."))},ve=()=>{y&&(y.classList.add("hidden"),y.dataset.itemId=""),I==null||I.classList.remove("hidden"),w&&(w.className=`hidden ${U}`,w.textContent=""),f&&(f.disabled=!0)},Se=()=>{y&&(y.classList.remove("hidden"),I==null||I.classList.add("hidden"))},Le=()=>{L&&(L.disabled=!g,L.disabled?L.classList.add("opacity-60","pointer-events-none"):L.classList.remove("opacity-60","pointer-events-none"))},re=o=>{if(!w)return;if(!o){w.className=`hidden ${U}`,w.textContent="";return}let p=o.toLowerCase(),$="bg-slate-100 text-slate-600 border border-slate-200";p==="publi\xE9"||p==="publie"?$="bg-emerald-50 text-emerald-700 border border-emerald-100":p==="brouillon"&&($="bg-amber-50 text-amber-700 border border-amber-100"),w.className=`${U} ${$}`,w.textContent=o},Pe=()=>{if(r.innerHTML="",!T.length){u==null||u.classList.remove("hidden");return}u==null||u.classList.add("hidden"),T.forEach(o=>{let p=o.id===g,$=document.createElement("button");$.type="button",$.dataset.collectionId=o.id,$.className=["w-full rounded-xl border px-3 py-2 text-left transition focus:outline-none focus:ring-2 focus:ring-[#9C6BFF]/40",p?"bg-[#F7F0FF] border-[#9C6BFF]/40 text-slate-900":"border-slate-200 text-slate-700 hover:border-[#9C6BFF]/40"].join(" "),$.setAttribute("role","option"),p?$.setAttribute("aria-current","true"):$.removeAttribute("aria-current"),$.innerHTML=`
          <div class="flex items-center justify-between gap-2">
            <div>
              <p class="text-sm font-semibold">${o.name||o.id}</p>
              <p class="text-xs text-slate-500">${o.description||""}</p>
            </div>
            <span class="text-[11px] uppercase tracking-wide text-slate-400">${o.type||""}</span>
          </div>
        `,$.addEventListener("click",()=>{Ke(o.id),window.matchMedia("(min-width: 1024px)").matches||O()}),r.appendChild($)})},ae=()=>{if(F){if(F.innerHTML="",!b.length||!g){v==null||v.classList.remove("hidden"),ee(),C==null||C.classList.add("hidden");return}v==null||v.classList.add("hidden"),C==null||C.classList.remove("hidden"),b.forEach(o=>{let p=document.createElement("tr");p.dataset.itemId=o.id;let $=o.id===P&&!l;p.className=["cursor-pointer transition focus-within:bg-[#F7F0FF]/70 focus:outline-none",$?"bg-[#F7F0FF]/70":"hover:bg-slate-50"].join(" "),p.tabIndex=0,p.setAttribute("role","button"),$?p.setAttribute("aria-current","true"):p.removeAttribute("aria-current");let j=o.status||"Brouillon",te=j.toLowerCase(),Ve=te==="publi\xE9"||te==="publie"?"bg-emerald-50 text-emerald-700 border border-emerald-100":"bg-amber-50 text-amber-700 border border-amber-100";p.innerHTML=`
          <td class="px-4 py-3 align-top">
            <div class="flex flex-col">
              <span class="text-sm font-semibold text-slate-900">${o.title||"Sans titre"}</span>
              <span class="text-xs text-slate-500">${o.summary||o.excerpt||""}</span>
            </div>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-600">${o.slug||""}</td>
          <td class="px-4 py-3 align-top">
            <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${Ve}">
              ${j}
            </span>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-500">${ge(o.updatedAt||o.createdAt)}</td>
        `;let ie=()=>{be(o.id)};p.addEventListener("click",ie),p.addEventListener("keydown",Ue=>{(Ue.key==="Enter"||Ue.key===" ")&&(Ue.preventDefault(),ie())}),F.appendChild(p)})}},be=o=>{let p=b.find($=>$.id===o);p&&(P=p.id,l=!1,a=!0,Me(p),ae())},Me=o=>{if(!y||!o){ve();return}Se(),y.dataset.itemId=o.id,m.title&&(m.title.value=o.title||""),m.slug&&(m.slug.value=o.slug||""),m.excerpt&&(m.excerpt.value=o.summary||o.excerpt||""),m.content&&(m.content.value=o.content||""),m.image&&(m.image.value=o.image||""),m.status&&(m.status.value=o.status||"Brouillon"),re(o.status||"Brouillon"),f&&(f.disabled=!1)},Ge=()=>{var o;y&&(l=!0,P=null,a=!1,y.dataset.itemId="",y.reset(),m.status&&(m.status.value="Brouillon"),m.slug&&(m.slug.value=""),re("Brouillon"),Se(),f&&(f.disabled=!0),(o=m.title)==null||o.focus())},_e=()=>{var ie,Ue,de,Ze,Qe,it;let o=(((ie=m.title)==null?void 0:ie.value)||"").trim(),p=(((Ue=m.slug)==null?void 0:Ue.value)||"").trim(),$=(((de=m.excerpt)==null?void 0:de.value)||"").trim(),j=(((Ze=m.content)==null?void 0:Ze.value)||"").trim(),te=(((Qe=m.image)==null?void 0:Qe.value)||"").trim(),Ve=((it=m.status)==null?void 0:it.value)||"Brouillon";return{title:o,slug:Q(p||o),summary:$,excerpt:$,content:j,image:te,status:Ve}},Ye=o=>{Y&&(Y.disabled=o,Y.textContent=o?"Enregistrement\u2026":"Enregistrer"),f&&!l&&P&&(f.disabled=o)},Ce=async o=>{if(!H)return[];let p=await fetch(`${H}/${encodeURIComponent(o)}/items`,{headers:{Accept:"application/json"}});if(!p.ok){let j=await p.json().catch(()=>({}));throw new Error(j.message||"Impossible de charger les items.")}let $=await p.json().catch(()=>({}));return Array.isArray($.items)?$.items:[]},Ke=async o=>{if(o&&(g=o,P=null,l=!1,a=!1,ne(),Le(),Pe(),ve(),b=[],ae(),ee("Chargement des items\u2026"),v==null||v.classList.remove("hidden"),C==null||C.classList.add("hidden"),!!H))try{b=await Ce(o),ae(),b.length||ee()}catch(p){console.error("[content] items failed",p),N(p.message||"Impossible de charger les items."),b=[],ae()}},Ie=async(o,p)=>{if(!H)throw new Error("Site inconnu.");let $=await fetch(`${H}/${encodeURIComponent(o)}/items`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});if(!$.ok){let j=await $.json().catch(()=>({}));throw new Error(j.message||"Impossible de cr\xE9er cet item.")}return $.json()},i=async(o,p,$)=>{if(!H)throw new Error("Site inconnu.");let j=await fetch(`${H}/${encodeURIComponent(o)}/items/${encodeURIComponent(p)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify($)});if(!j.ok){let te=await j.json().catch(()=>({}));throw new Error(te.message||"Impossible de sauvegarder cet item.")}return j.json()},x=async(o,p)=>{if(!H)throw new Error("Site inconnu.");let $=await fetch(`${H}/${encodeURIComponent(o)}/items/${encodeURIComponent(p)}`,{method:"DELETE"});if(!$.ok){let j=await $.json().catch(()=>({}));throw new Error(j.message||"Impossible de supprimer cet item.")}},R=async()=>{var o;if(!H){u==null||u.classList.remove("hidden"),g=null,b=[],ae(),ne(),Le();return}try{let p=await fetch(H,{headers:{Accept:"application/json"}});if(!p.ok)throw new Error("Impossible de charger les collections.");let $=await p.json().catch(()=>[]);if(T=Array.isArray($)?$:[],Pe(),T.length>0){let j=((o=T.find(te=>te.id===g))==null?void 0:o.id)||T[0].id;Ke(j)}else g=null,b=[],ne(),Le(),ae()}catch(p){console.error("[content] load collections",p),N(p.message||"Impossible de charger les collections.")}};L==null||L.addEventListener("click",()=>{if(!g){N("S\xE9lectionnez d\u2019abord une collection.");return}Ge(),ae()}),se==null||se.addEventListener("click",o=>{if(o.preventDefault(),l){l=!1,P=null,ve(),ae();return}if(P){let p=b.find($=>$.id===P);Me(p)}else ve()}),(Xe=m.status)==null||Xe.addEventListener("change",()=>{re(m.status.value)}),(Fe=m.title)==null||Fe.addEventListener("input",()=>{!l||!m.slug||a||(m.slug.value=Q(m.title.value))}),(he=m.slug)==null||he.addEventListener("input",()=>{l&&(a=!0)}),y==null||y.addEventListener("submit",async o=>{var $;if(o.preventDefault(),!g){N("S\xE9lectionnez une collection.");return}let p=_e();if(!p.title){N("Le titre est requis."),($=m.title)==null||$.focus();return}Ye(!0);try{let j;l||!P?(j=await Ie(g,p),b=[...b,j],N("Item cr\xE9\xE9")):(j=await i(g,P,p),b=b.map(te=>te.id===j.id?j:te),N("Item mis \xE0 jour")),l=!1,P=j.id,Me(j),ae()}catch(j){console.error("[content] save item failed",j),N(j.message||"Impossible de sauvegarder cet item.")}finally{Ye(!1)}});let B=()=>{D&&(D.classList.add("hidden"),D.classList.remove("flex"),c=null)},ze=()=>{!D||!P||(c=P,D.classList.remove("hidden"),D.classList.add("flex"))};f==null||f.addEventListener("click",o=>{o.preventDefault(),P&&ze()}),oe==null||oe.addEventListener("click",()=>{B()}),D==null||D.addEventListener("click",o=>{o.target===D&&B()}),W==null||W.addEventListener("click",async()=>{if(!c||!g){B();return}W.disabled=!0,W.textContent="Suppression\u2026";try{await x(g,c),b=b.filter(o=>o.id!==c),P===c&&(P=null,ve()),N("Item supprim\xE9"),ae()}catch(o){console.error("[content] delete item failed",o),N(o.message||"Impossible de supprimer cet item.")}finally{W.disabled=!1,W.textContent="Supprimer",B()}}),ne(),Le(),R()}function Xs(){let r=document.querySelector("[data-deploy-form]");if(!r)return;let u=document.querySelector("[data-deploy-protocol]"),v=document.querySelector("[data-deploy-host]"),C=document.querySelector("[data-deploy-port]"),F=document.querySelector("[data-deploy-user]"),S=document.querySelector("[data-deploy-password]"),V=document.querySelector("[data-deploy-show-password]"),k=document.querySelector("[data-deploy-remote-path]"),h=document.querySelector("[data-deploy-feedback]"),A=document.querySelector("[data-deploy-save]"),M=document.querySelector("[data-deploy-test]"),L=document.querySelector("[data-deploy-trigger]"),I=document.querySelector("[data-deploy-history]"),y=document.querySelector("[data-deploy-log]"),m=Ae((J==null?void 0:J.slugValue)||_.slug||""),w=m?`/api/sites/${encodeURIComponent(m)}/deploy-config`:null,f=m?`/api/sites/${encodeURIComponent(m)}/deploy`:null,D=m?`/api/sites/${encodeURIComponent(m)}/deploy-log`:null,oe=!1,W=null,se=l=>{let a=(l||"").trim();return a?a.startsWith("/")?a:`/${a}`:"/www"},Y=(l,a="muted")=>{if(!h)return;let c="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold",K=a==="success"?"bg-emerald-50 text-emerald-700 border border-emerald-100":a==="error"?"bg-rose-50 text-rose-700 border border-rose-100":"bg-slate-50 text-slate-600 border border-slate-100";if(!l){h.textContent="",h.className="text-sm text-slate-500";return}let O=a==="success"?"\u2705":a==="error"?"\u274C":"\u2139\uFE0F";h.innerHTML=`<span class="${c} ${K}">${O}<span>${l}</span></span>`,h.className="text-sm"},U=(l=null)=>{W=l;let a=!!l,c='<svg class="h-4 w-4 animate-spin text-white" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>';A&&(A.disabled=a,A.innerHTML=l==="save"?`<span class="inline-flex items-center gap-2">${c}<span>Enregistrement\u2026</span></span>`:"Enregistrer"),M&&(M.disabled=a,M.innerHTML=l==="test"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-slate-200 border-t-slate-600"></span><span>Test en cours\u2026</span></span>':"Tester la connexion"),L&&(L.disabled=a&&l!==null,L.innerHTML=l==="deploy"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-white/60 border-t-white"></span><span>D\xE9ploiement\u2026</span></span>':"D\xE9ployer maintenant")},G=l=>{u&&(u.value=l.protocol||"sftp"),v&&(v.value=l.host||""),C&&(C.value=l.port||""),F&&(F.value=l.user||""),k&&(k.value=l.remotePath||"/www"),oe=!!l.hasPassword,S&&(S.value="",S.placeholder=oe?"Non affich\xE9":"Mot de passe")},H=(l=[])=>{if(I){if(I.innerHTML="",!l.length){let a=document.createElement("li");a.className="text-slate-500",a.textContent="Aucun d\xE9ploiement pour le moment.",I.appendChild(a);return}l.forEach(a=>{let c=document.createElement("li");c.className="flex items-center justify-between gap-2 rounded-xl border border-slate-200 px-3 py-2";let K=a.status==="success"?'<span class="rounded-full bg-emerald-50 px-2 py-0.5 text-[11px] font-semibold text-emerald-700">Succ\xE8s</span>':'<span class="rounded-full bg-rose-50 px-2 py-0.5 text-[11px] font-semibold text-rose-700">\xC9chec</span>',O=a.finishedAt||a.startedAt||"",Q=a.durationMs&&Number(a.durationMs)>=0?`${Math.round(Number(a.durationMs)/1e3)}s`:"";c.innerHTML=`
          <div class="space-y-1">
            <div class="flex items-center gap-2">${K}<span class="text-xs text-slate-500">${O}</span></div>
            <p class="text-sm text-slate-800">${a.message||""}</p>
          </div>
          <div class="text-xs text-slate-500">${Q}</div>
        `,c.dataset.deployId=a.id||"",c.addEventListener("click",()=>{a.logs&&y&&(y.textContent=a.logs.join(`
`))}),I.appendChild(c)})}},T=(l=[])=>{y&&(y.textContent=l.length?l.join(`
`):"Aucun log pour le moment.")},b=async()=>{var l;if(D)try{let a=await fetch(D,{headers:{Accept:"application/json"}});if(!a.ok){if(a.status===404){H([]),T(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw new Error("Impossible de charger l\u2019historique.")}let c=await a.json().catch(()=>({})),K=Array.isArray(c.entries)?c.entries:[];H(K),(l=K[0])!=null&&l.logs&&T(K[0].logs)}catch(a){console.error("[deploy] history failed",a)}},g=async()=>{if(!w){Y("Aucun site actif s\xE9lectionn\xE9.","error");return}U("load");try{let l=await fetch(w,{headers:{Accept:"application/json"}}),a=await l.json().catch(()=>({}));l.ok?(G(a||{}),Y("Configuration charg\xE9e.","muted")):(G(a||{}),Y(a.message||"Configuration par d\xE9faut charg\xE9e.","muted"))}catch(l){console.error("[deploy] load failed",l),Y(l.message||"Erreur lors du chargement.","error")}finally{U(null)}},P=()=>{let l={protocol:(u==null?void 0:u.value)||"sftp",host:(v==null?void 0:v.value.trim())||"",port:Number(C==null?void 0:C.value)||void 0,user:(F==null?void 0:F.value.trim())||"",remotePath:se((k==null?void 0:k.value)||"/www")},a=(S==null?void 0:S.value)||"";return a.trim().length>0&&(l.password=a),l};r.addEventListener("submit",async l=>{if(l.preventDefault(),!w){Y("Aucun site actif s\xE9lectionn\xE9.","error");return}let a=P();U("save");try{let c=await fetch(w,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!c.ok){let O=await c.json().catch(()=>({}));throw new Error(O.message||"Sauvegarde impossible.")}let K=await c.json();G(K||{}),Y("Configuration enregistr\xE9e.","success"),N("Configuration d\xE9ploiement sauvegard\xE9e")}catch(c){console.error("[deploy] save failed",c),Y(c.message||"Erreur lors de la sauvegarde.","error")}finally{U(null)}}),M==null||M.addEventListener("click",async()=>{if(!w){Y("Aucun site actif s\xE9lectionn\xE9.","error");return}let l=P();if(!l.host||!l.user||!l.remotePath){Y("Remplissez les champs requis avant de tester.","error");return}U("test");try{let a=await fetch(`${w}/test`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}),c=await a.json().catch(()=>({}));if(!a.ok||c.success===!1){Y(c.message||"Test de connexion \xE9chou\xE9.","error");return}Y(c.message||"Connexion OK.","success"),N("Test de connexion r\xE9ussi")}catch(a){console.error("[deploy] test failed",a),Y(a.message||"Test de connexion \xE9chou\xE9.","error")}finally{U(null)}}),L==null||L.addEventListener("click",async()=>{if(!f){Y("Aucun site actif s\xE9lectionn\xE9.","error");return}U("deploy"),T(["D\xE9ploiement en cours\u2026"]);try{let l=await fetch(f,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(P())}),a=await l.json().catch(()=>({}));if(!l.ok){if(l.status===404){Y("API d\xE9ploiement indisponible (red\xE9marre le serveur).","error"),T(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw T(a.logs||[]),new Error(a.message||"D\xE9ploiement \xE9chou\xE9.")}T(a.logs||[]),await b(),N("D\xE9ploiement termin\xE9")}catch(l){console.error("[deploy] run failed",l),Y(l.message||"D\xE9ploiement \xE9chou\xE9.","error")}finally{U(null)}}),V==null||V.addEventListener("change",()=>{S&&(S.type=V.checked?"text":"password")}),g(),b()}function Zs(){let r=document.querySelectorAll("[data-settings-tab]"),u=document.querySelectorAll("[data-settings-panel]"),v=document.querySelector("[data-admin-password-form]"),C=document.querySelector("[data-site-config-form]"),F=document.querySelector("[data-site-config-feedback]"),S=document.querySelector("[data-theme-form]"),V=k=>{r.forEach(h=>{let A=h.dataset.settingsTab===k;h.setAttribute("aria-selected",A?"true":"false"),h.classList.toggle("bg-[#9C6BFF]",A),h.classList.toggle("text-white",A)}),u.forEach(h=>{h.classList.toggle("hidden",h.dataset.settingsPanel!==k)})};if(r.forEach(k=>{k.addEventListener("click",()=>V(k.dataset.settingsTab||"account"))}),V("account"),v){let k=v.querySelector("[data-admin-password-feedback]"),h=v.querySelector("[data-admin-password-submit]"),A=(M,L="muted")=>{if(!k)return;let I=L==="success"?"text-emerald-600":L==="error"?"text-rose-600":"text-slate-500";k.textContent=M||"",k.className=`text-sm ${I}`};v.addEventListener("submit",async M=>{M.preventDefault();let L=new FormData(v),I=L.get("currentPassword")||"",y=L.get("newPassword")||"",m=L.get("confirmPassword")||"";if(!I||!y||!m){A("Compl\xE8te tous les champs.","error");return}h&&(h.disabled=!0),A("");try{let w=await fetch("/api/admin/password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({currentPassword:I,newPassword:y,confirmPassword:m})}),f=await w.json().catch(()=>({}));if(!w.ok||f.success===!1)throw new Error(f.message||"Impossible de mettre \xE0 jour le mot de passe.");A(f.message||"Mot de passe mis \xE0 jour.","success"),v.reset()}catch(w){console.error("[settings] change password failed",w),A(w.message||"Erreur lors de la mise \xE0 jour.","error")}finally{h&&(h.disabled=!1)}})}if(C){let k=C.querySelector("[data-site-name]"),h=C.querySelector("[data-site-language]"),A=C.querySelector("[data-site-tagline]"),M=C.querySelector("[data-site-save]"),L=(w,f="muted")=>{if(!F)return;let D=f==="success"?"text-emerald-600":f==="error"?"text-rose-600":"text-slate-500";F.textContent=w||"",F.className=`text-sm ${D}`},I=Ae((J==null?void 0:J.slugValue)||_.slug||""),y=I?`/api/sites/${encodeURIComponent(I)}/config/site`:null,m=async()=>{if(y)try{let w=await fetch(y,{headers:{Accept:"application/json"}});if(!w.ok)return;let f=await w.json().catch(()=>({}));k&&(k.value=f.name||""),h&&(h.value=f.language||"fr"),A&&(A.value=f.tagline||"")}catch(w){console.error("[settings] load site config failed",w)}};C.addEventListener("submit",async w=>{if(w.preventDefault(),!y){L("Aucun site actif.","error");return}if(!(k!=null&&k.value.trim())){L("Nom requis.","error");return}M&&(M.disabled=!0),L("");try{let f={name:(k==null?void 0:k.value)||"",language:(h==null?void 0:h.value)||"fr",tagline:(A==null?void 0:A.value)||""},D=await fetch(y,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)}),oe=await D.json().catch(()=>({}));if(!D.ok||oe.success===!1)throw new Error(oe.message||"Sauvegarde impossible.");L(oe.message||"Param\xE8tres enregistr\xE9s.","success")}catch(f){console.error("[settings] save site config failed",f),L(f.message||"Erreur lors de la sauvegarde.","error")}finally{M&&(M.disabled=!1)}}),m()}if(S){let k=Ae((J==null?void 0:J.slugValue)||_.slug||""),h=k?`/api/sites/${encodeURIComponent(k)}/config/theme`:null,A={primary:S.querySelector("[data-theme-primary]"),secondary:S.querySelector("[data-theme-secondary]"),accent:S.querySelector("[data-theme-accent]"),background:S.querySelector("[data-theme-background]"),text:S.querySelector("[data-theme-text]")},M=S.querySelector("[data-theme-headings]"),L=S.querySelector("[data-theme-body]"),I=S.querySelector("[data-theme-radius-small]"),y=S.querySelector("[data-theme-radius-medium]"),m=S.querySelector("[data-theme-radius-large]"),w=S.querySelector("[data-theme-preview]"),f=S.querySelector("[data-theme-feedback]"),D=S.querySelector("[data-theme-apply]"),oe=["slate","gray","zinc","neutral","stone","red","orange","amber","yellow","lime","green","emerald","teal","cyan","sky","blue","indigo","violet","purple","fuchsia","pink","rose"],W=["50","100","200","300","400","500","600","700","800","900"],se=oe.flatMap(b=>W.map(g=>`${b}-${g}`)),Y=()=>{Object.values(A).forEach(b=>{!b||b.options.length||se.forEach(g=>{let P=document.createElement("option");P.value=g;let[l,a]=g.split("-");P.textContent=`${l.charAt(0).toUpperCase()+l.slice(1)} ${a}`,b.appendChild(P)})})},U=(b,g="muted")=>{if(!f)return;let P=g==="success"?"text-emerald-600":g==="error"?"text-rose-600":"text-slate-500";f.textContent=b||"",f.className=`text-sm ${P}`},G=()=>{var g,P,l,a,c;if(!w)return;let b=K=>{if(!K)return null;let[O,Q]=K.split("-"),ne={slate:"#e2e8f0",gray:"#d1d5db",zinc:"#d4d4d8",neutral:"#d4d4d4",stone:"#d6d3d1",red:"#ef4444",orange:"#f97316",amber:"#f59e0b",yellow:"#eab308",lime:"#84cc16",green:"#22c55e",emerald:"#10b981",teal:"#14b8a6",cyan:"#06b6d4",sky:"#0ea5e9",blue:"#3b82f6",indigo:"#6366f1",violet:"#8b5cf6",purple:"#a855f7",fuchsia:"#d946ef",pink:"#ec4899",rose:"#f43f5e"}[O];if(!ne)return null;let ee=Number(Q)||500,ve=Math.min(Math.max((ee-50)/900,0),1),Se=be=>be.match(/[A-Fa-f0-9]{2}/g).map(Me=>parseInt(Me,16)),[Le,re,Pe]=Se(ne.replace("#","")),ae=be=>Math.round(255-(255-be)*ve);return`rgb(${ae(Le)}, ${ae(re)}, ${ae(Pe)})`};w.style.setProperty("--color-primary",b((g=A.primary)==null?void 0:g.value)||"#9C6BFF"),w.style.setProperty("--color-secondary",b((P=A.secondary)==null?void 0:P.value)||"#0EA5E9"),w.style.setProperty("--color-accent",b((l=A.accent)==null?void 0:l.value)||"#F97316"),w.style.setProperty("--color-background",b((a=A.background)==null?void 0:a.value)||"#FFFFFF"),w.style.setProperty("--color-text",b((c=A.text)==null?void 0:c.value)||"#0F172A"),w.style.setProperty("--font-headings",(M==null?void 0:M.value)||"Inter, sans-serif"),w.style.setProperty("--font-body",(L==null?void 0:L.value)||"Inter, sans-serif"),w.style.setProperty("--radius-small",(I==null?void 0:I.value)||"8px"),w.style.setProperty("--radius-medium",(y==null?void 0:y.value)||"16px"),w.style.setProperty("--radius-large",(m==null?void 0:m.value)||"24px"),w.style.borderRadius=(y==null?void 0:y.value)||"16px"},H=(b,g)=>{A[b]&&(A[b].value=g)};Object.keys(A).forEach(b=>{var g;(g=A[b])==null||g.addEventListener("change",G)}),[M,L,I,y,m].forEach(b=>{b==null||b.addEventListener("change",G)});let T=async()=>{var b,g,P,l,a,c,K,O,Q,ge;if(h)try{let ne=await fetch(h,{headers:{Accept:"application/json"}});if(!ne.ok)return;let ee=await ne.json().catch(()=>({}));H("primary",((b=ee.colors)==null?void 0:b.primary)||"violet-500"),H("secondary",((g=ee.colors)==null?void 0:g.secondary)||"indigo-400"),H("accent",((P=ee.colors)==null?void 0:P.accent)||"emerald-500"),H("background",((l=ee.colors)==null?void 0:l.background)||"slate-50"),H("text",((a=ee.colors)==null?void 0:a.text)||"slate-900"),M&&(M.value=((c=ee.typography)==null?void 0:c.headings)||"Inter, sans-serif"),L&&(L.value=((K=ee.typography)==null?void 0:K.body)||"Inter, sans-serif"),I&&(I.value=((O=ee.radius)==null?void 0:O.small)||"8px"),y&&(y.value=((Q=ee.radius)==null?void 0:Q.medium)||"16px"),m&&(m.value=((ge=ee.radius)==null?void 0:ge.large)||"24px"),G()}catch(ne){console.error("[settings] load theme failed",ne)}};Y(),D==null||D.addEventListener("click",async b=>{var P,l,a,c,K;if(b.preventDefault(),!h){U("Aucun site actif.","error");return}let g={colors:{primary:((P=A.primary)==null?void 0:P.value)||"violet-500",secondary:((l=A.secondary)==null?void 0:l.value)||"indigo-400",accent:((a=A.accent)==null?void 0:a.value)||"emerald-500",background:((c=A.background)==null?void 0:c.value)||"slate-50",text:((K=A.text)==null?void 0:K.value)||"slate-900"},typography:{headings:(M==null?void 0:M.value)||"Inter, sans-serif",body:(L==null?void 0:L.value)||"Inter, sans-serif"},radius:{small:(I==null?void 0:I.value)||"8px",medium:(y==null?void 0:y.value)||"16px",large:(m==null?void 0:m.value)||"24px"}};D.disabled=!0,U("");try{let O=await fetch(h,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)}),Q=await O.json().catch(()=>({}));if(!O.ok||Q.success===!1)throw new Error(Q.message||"Application du th\xE8me \xE9chou\xE9e.");U(Q.message||"Th\xE8me appliqu\xE9.","success"),G()}catch(O){console.error("[settings] apply theme failed",O),U(O.message||"Erreur lors de l\u2019application du th\xE8me.","error")}finally{D.disabled=!1}}),Y(),T(),G()}}function Qs(){let r=document.querySelector("[data-media-grid]");if(!r)return;let u=document.querySelector("[data-media-empty]"),v=document.querySelector("[data-media-count]"),C=document.querySelector("[data-media-filter-type]"),F=document.querySelector("[data-media-detail-empty]"),S=document.querySelector("[data-media-detail]"),V=document.querySelector("[data-media-detail-preview]"),k=document.querySelector("[data-media-detail-name]"),h=document.querySelector("[data-media-detail-type]"),A=document.querySelector("[data-media-detail-size]"),M=document.querySelector("[data-media-detail-path]"),L=document.querySelector("[data-media-detail-used]"),I=document.querySelector("[data-media-alt-edit]"),y=document.querySelector("[data-media-save]"),m=document.querySelector("[data-media-delete]"),w=document.querySelector("[data-media-delete-modal]"),f=document.querySelector("[data-media-delete-cancel]"),D=document.querySelector("[data-media-delete-confirm]"),oe=document.querySelector("[data-media-upload-open]"),W=document.querySelector("[data-media-file-input]"),se=document.querySelector("[data-media-upload-status]"),Y=Ae((J==null?void 0:J.slugValue)||_.slug||""),U=Y?`/api/sites/${encodeURIComponent(Y)}/media`:null,G=[],H=[],T=null,b=null,g=null,P=!1,l=!1,a=!1,c=null,K=i=>{let x=(i.type||"").toLowerCase(),R=(i.filename||"").toLowerCase();return x.includes("image")||/\.(png|jpe?g|webp|svg|gif)$/i.test(R)?"image":x.includes("pdf")||x.includes("doc")||/\.(pdf|docx?)$/i.test(R)?"document":x.includes("video")||/\.(mp4|mov|webm)$/i.test(R)?"video":"other"},O=i=>K(i)==="image",Q=i=>{if(i.type)return i.type.toUpperCase();let x=(i.filename||"").split(".").pop();return x?x.toUpperCase():"FILE"},ge=i=>!i||i<=0?"\u2014":i<1024?`${i} o`:i<1024*1024?`${(i/1024).toFixed(1)} ko`:`${(i/(1024*1024)).toFixed(1)} Mo`,ne=()=>{S==null||S.classList.add("hidden"),F==null||F.classList.remove("hidden"),ee(),T=null,l=!1,re(!1),V&&(V.innerHTML='<span class="text-slate-400 text-sm">Aucun m\xE9dia s\xE9lectionn\xE9</span>'),k&&(k.textContent=""),h&&(h.textContent=""),A&&(A.textContent=""),I&&(I.value=""),M&&(M.textContent=""),L&&(L.innerHTML="")},ee=()=>{g=null,a=!1,P=!1,c&&(URL.revokeObjectURL(c),c=null),se&&(se.textContent="Aucun fichier s\xE9lectionn\xE9."),W&&(W.value="")},ve=()=>{v&&(H.length?H.length===1?v.textContent="1 m\xE9dia":v.textContent=`${H.length} m\xE9dias`:v.textContent="0 m\xE9dia")},Se=()=>{if(r.innerHTML="",!H.length){u==null||u.classList.remove("hidden"),ne();return}u==null||u.classList.add("hidden"),H.forEach(i=>{let x=document.createElement("button");x.type="button",x.dataset.mediaId=i.id;let R=i.id===T;x.className=["group relative flex flex-col rounded-2xl border px-3 py-3 text-left transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#9C6BFF]",R?"border-[#9C6BFF] bg-[#F7F0FF]/60 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let B=O(i)?`<img src="${i.path}" alt="${i.alt||i.filename}" class="h-full w-full object-cover" />`:'<div class="flex h-full w-full items-center justify-center text-3xl text-slate-400">\u{1F4C4}</div>';x.innerHTML=`
          <div class="relative aspect-[4/3] overflow-hidden rounded-xl bg-slate-100">
            ${B}
          </div>
          <div class="mt-2 space-y-1">
            <p class="text-sm font-semibold text-slate-900 truncate">${i.filename}</p>
            <p class="text-xs text-slate-500">
              ${Q(i)} \xB7 ${ge(i.size)}
            </p>
          </div>
        `,i.id===b&&(x.classList.add("ring-2","ring-[#9C6BFF]"),window.setTimeout(()=>{x.classList.remove("ring-2","ring-[#9C6BFF]")},1600)),x.addEventListener("click",()=>Pe(i.id)),r.appendChild(x)}),b=null},Le=i=>{if(L){if(L.innerHTML="",!i.usedIn||i.usedIn.length===0){let x=document.createElement("li");x.textContent="Non utilis\xE9",x.className="text-xs text-slate-400",L.appendChild(x);return}i.usedIn.forEach(x=>{let R=document.createElement("li");R.textContent=x,R.className="text-xs text-slate-600",L.appendChild(R)})}},re=i=>{if(y){if(a){y.textContent=i?"T\xE9l\xE9versement\u2026":"T\xE9l\xE9verser",y.disabled=i||!g,m&&m.classList.add("hidden");return}y.textContent=i?"Enregistrement\u2026":"Enregistrer",y.disabled=i||!l,m&&(m.classList.remove("hidden"),m.disabled=!T)}},Pe=i=>{let x=G.find(R=>R.id===i);if(!x){ne(),Se();return}ee(),T=x.id,l=!1,re(!1),Se(),F==null||F.classList.add("hidden"),S==null||S.classList.remove("hidden"),V&&(O(x)?V.innerHTML=`<img src="${x.path}" alt="${x.alt||x.filename}" class="h-full w-full rounded-2xl object-cover" />`:V.innerHTML='<div class="flex h-full w-full flex-col items-center justify-center gap-1 text-slate-400"><span class="text-3xl">\u{1F4C4}</span><span class="text-xs font-semibold">Document</span></div>'),k&&(k.textContent=x.filename||"Fichier"),h&&(h.textContent=Q(x)),A&&(A.textContent=ge(x.size)),I&&(I.value=x.alt||""),M&&(M.textContent=x.path||"\u2014"),Le(x)},ae=i=>{if(i){if(a=!0,l=!1,T=null,F==null||F.classList.add("hidden"),S==null||S.classList.remove("hidden"),c&&URL.revokeObjectURL(c),c=URL.createObjectURL(i),V&&(V.innerHTML=`<img src="${c}" alt="${i.name}" class="h-full w-full rounded-2xl object-cover" />`),k&&(k.textContent=i.name),h&&(h.textContent=Q({type:i.type,filename:i.name})),A&&(A.textContent=ge(i.size)),I&&!I.value.trim()&&(I.value=i.name.replace(/\.[^.]+$/,"").replace(/[-_]/g," ")),M&&(M.textContent="En attente de t\xE9l\xE9versement"),L){L.innerHTML="";let x=document.createElement("li");x.textContent="Non utilis\xE9",x.className="text-xs text-slate-400",L.appendChild(x)}re(!1)}},be=()=>{let i=(C==null?void 0:C.value)||"all";i==="all"?H=[...G]:H=G.filter(x=>x.groupType===i),H.some(x=>x.id===T)||ne(),ve(),Se()},Me=async()=>{if(!U){u==null||u.classList.remove("hidden");return}try{let i=await fetch(U,{headers:{Accept:"application/json"}});if(!i.ok)throw new Error("Impossible de charger les m\xE9dias.");let x=await i.json().catch(()=>({items:[]}));G=Array.isArray(x.items)?x.items.map(R=>({...R,groupType:K(R)})):[],be()}catch(i){console.error("[media] load failed",i),N(i.message||"Impossible de charger les m\xE9dias."),G=[],be()}};C==null||C.addEventListener("change",()=>{be()}),I==null||I.addEventListener("input",()=>{if(a){re(!1);return}T&&(l=!0,re(!1))});let Ge=i=>{if(i){if(!i.type.startsWith("image/")){N("Seules les images sont accept\xE9es pour le moment.");return}if(i.size>4*1024*1024){N("Fichier trop volumineux (4 Mo max).");return}g=i,ae(i),se&&(se.textContent=`${i.name} \xB7 ${ge(i.size)}`)}},_e=i=>new Promise((x,R)=>{let B=new FileReader;B.onload=()=>{let ze=B.result||"",[,Xe=""]=String(ze).split(",");x(Xe)},B.onerror=()=>R(new Error("Impossible de lire ce fichier.")),B.readAsDataURL(i)}),Ye=async()=>{if(!(!g||!U)){P=!0,re(!0);try{let i=await _e(g),x={filename:g.name,type:g.type,size:g.size,alt:(I==null?void 0:I.value)||"",data:i},R=await fetch(U,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(x)});if(!R.ok){let ze=await R.json().catch(()=>({}));throw new Error(ze.message||"Upload impossible.")}let B=await R.json();B.groupType=K(B),G=[...G,B],b=B.id,be(),Pe(B.id),N("M\xE9dia ajout\xE9"),ee()}catch(i){console.error("[media] upload failed",i),N(i.message||"Impossible de t\xE9l\xE9verser ce m\xE9dia.")}finally{P=!1,g=null,re(!1)}}};oe==null||oe.addEventListener("click",()=>W==null?void 0:W.click()),W==null||W.addEventListener("change",()=>{W.files&&W.files[0]&&Ge(W.files[0])});let Ce=()=>{w&&(w.classList.add("hidden"),w.classList.remove("flex"))},Ke=()=>{if(!(!T||a)){if(w){w.classList.remove("hidden"),w.classList.add("flex");return}window.confirm("Supprimer ce m\xE9dia ?")&&Ie()}},Ie=async()=>{if(!T||!U){Ce();return}let i=()=>{m&&(m.disabled=!0),D&&(D.disabled=!0,D.textContent="Suppression\u2026")},x=()=>{m&&(m.disabled=!1),D&&(D.disabled=!1,D.textContent="Supprimer")};i();try{let R=await fetch(`${U}/${encodeURIComponent(T)}`,{method:"DELETE"});if(!R.ok){let B=await R.json().catch(()=>({}));throw new Error(B.message||"Suppression impossible.")}G=G.filter(B=>B.id!==T),H=H.filter(B=>B.id!==T),N("M\xE9dia supprim\xE9"),ne(),ve(),Se()}catch(R){console.error("[media] delete failed",R),N(R.message||"Impossible de supprimer ce m\xE9dia.")}finally{x(),Ce()}};f==null||f.addEventListener("click",Ce),w==null||w.addEventListener("click",i=>{i.target===w&&Ce()}),D==null||D.addEventListener("click",()=>Ie()),m==null||m.addEventListener("click",Ke),y==null||y.addEventListener("click",async()=>{if(a){Ye();return}if(!(!T||!U||!I)){re(!0);try{let i={alt:I.value||""},x=await fetch(`${U}/${encodeURIComponent(T)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!x.ok){let B=await x.json().catch(()=>({}));throw new Error(B.message||"Impossible de mettre \xE0 jour ce m\xE9dia.")}let R=await x.json();G=G.map(B=>B.id===T?{...B,...R}:B),H=H.map(B=>B.id===T?{...B,...R}:B),l=!1,re(!1),N("M\xE9dia mis \xE0 jour")}catch(i){console.error("[media] update failed",i),N(i.message||"\xC9chec de la mise \xE0 jour."),re(!1)}}}),Me()}});})();
