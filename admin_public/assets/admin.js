(()=>{document.addEventListener("DOMContentLoaded",()=>{console.log("[admin] Atelier charg\xE9");let Ct=document.querySelector("[data-logout]");Ct&&Ct.addEventListener("click",async()=>{Ct.disabled=!0;try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(o){console.error("[admin] Impossible de se d\xE9connecter",o)}finally{window.location.href="/admin/index.html"}});let We=document.querySelector("[data-admin-sidebar]"),de=document.querySelector("[data-admin-sidebar-overlay]"),Jt=document.querySelectorAll("[data-admin-sidebar-toggle]"),ln=document.querySelectorAll("[data-admin-sidebar-close]"),Et=document.body,rt=!1,it=()=>{if(!We)return;if(window.matchMedia("(min-width: 1024px)").matches){We.classList.remove("hidden"),de==null||de.classList.add("hidden"),Et.classList.remove("overflow-hidden");return}rt?(We.classList.remove("hidden"),de==null||de.classList.remove("hidden"),Et.classList.add("overflow-hidden")):(We.classList.add("hidden"),de==null||de.classList.add("hidden"),Et.classList.remove("overflow-hidden"))},cn=()=>{rt=!0,it()},qt=()=>{rt=!1,it()};We&&Jt.length>0&&(Jt.forEach(o=>{o.addEventListener("click",cn)}),ln.forEach(o=>{o.addEventListener("click",qt)}),de==null||de.addEventListener("click",qt),window.addEventListener("resize",it),window.addEventListener("keydown",o=>{o.key==="Escape"&&rt&&qt()}),it());let Wt="clower:currentSite",Gt="clower:currentSiteName",O={slug:null,name:""};(()=>{try{O.slug=window.localStorage.getItem(Wt),O.name=window.localStorage.getItem(Gt)||""}catch{O.slug=null,O.name=""}})();let kt=document.querySelectorAll("[data-site-card]"),dn=document.querySelectorAll("[data-site-select]"),Ge=document.querySelector("[data-current-site-name]"),_t=document.querySelector("[data-workspace-site-name]"),Yt=document.querySelector("[data-workspace-back-name]"),Ie=document.querySelector("[data-workspace-back-modal]"),un=document.querySelectorAll("[data-workspace-back]"),mn=document.querySelectorAll("[data-workspace-back-cancel]"),It=document.querySelector("[data-workspace-back-confirm]"),pn=document.querySelectorAll("[data-workspace-tab]"),At=document.querySelector("[data-site-toast]"),Kt=document.querySelector("[data-site-toast-message]"),fn=document.querySelectorAll("[data-site-create]"),oe=document.querySelector("[data-site-modal]"),Ce=document.querySelector("[data-site-form]"),pe=document.querySelector("[data-site-name]"),be=document.querySelector("[data-site-slug]"),ie=document.querySelector("[data-site-slug-error]"),xe=document.querySelector("[data-site-modal-error]"),gn=document.querySelectorAll("[data-site-modal-cancel]"),He=document.querySelector("[data-site-modal-submit]"),V=Sn(),lt=!1,ct=null,Bt=null,hn='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',Xt=o=>{if(!oe||oe.classList.contains("hidden")||o.key!=="Tab")return;let l=Array.from(oe.querySelectorAll(hn)).filter(C=>!C.hasAttribute("disabled")&&!C.getAttribute("aria-hidden"));if(l.length===0)return;let h=l[0],v=l[l.length-1];o.shiftKey?document.activeElement===h&&(o.preventDefault(),v.focus()):document.activeElement===v&&(o.preventDefault(),h.focus())},$=o=>{!At||!Kt||(Kt.textContent=o,At.classList.remove("hidden"),Bt&&clearTimeout(Bt),Bt=setTimeout(()=>{At.classList.add("hidden")},2500))};function Ee(o){return o?o.startsWith("/")?o:`/${o}`:""}function Ae(o){return(o==null?void 0:o.replace(/^\//,""))||""}let dt=(o,l)=>{let h=o?Ee(o):null;try{h&&(window.localStorage.setItem(Wt,h),O.slug=h),typeof l=="string"&&l.length>0&&(window.localStorage.setItem(Gt,l),O.name=l)}catch{O.slug=h||O.slug,O.name=l||O.name}},Zt=o=>{Ge&&o&&(Ge.textContent=o),_t&&o&&(_t.textContent=o),Yt&&o&&(Yt.textContent=o)},Tt=o=>{pn.forEach(l=>{let h=l.dataset.workspaceTab;if(!h)return;if(!o){l.href="#",l.classList.add("pointer-events-none","opacity-50","text-slate-400"),l.setAttribute("aria-disabled","true");return}let v=encodeURIComponent(Ae(o));l.href=`/admin/site/${v}/${h}`,l.classList.remove("pointer-events-none","opacity-50","text-slate-400"),l.removeAttribute("aria-disabled")})},ut=(o,l={})=>{if(!o)return;let h=Ee(o),v=l.siteName||O.name||(Ge==null?void 0:Ge.dataset.defaultSiteName)||"";kt.forEach(L=>{let P=Ee(L.dataset.siteCard||"")===h,f=L.querySelector("[data-site-active-badge]");P?(L.classList.add("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),L.classList.remove("border-slate-200"),f==null||f.classList.remove("hidden"),v=L.dataset.siteName||v):(L.classList.remove("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),L.classList.add("border-slate-200"),f==null||f.classList.add("hidden"))}),l.persist!==!1&&dt(h,l.siteName||v);let C=l.siteName||v;Zt(C),Tt(h)},yn=async(o,l)=>{let h=Ee(o);try{let v=await fetch("/api/sites/select",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slug:h})});if(!v.ok){let f=await v.json().catch(()=>({}));$(f.message||"Impossible de s\xE9lectionner ce site.");return}let C=await v.json().catch(()=>({})),L=Ee(C.slug||h),F=C.name||l;dt(L,F),ut(L,{siteName:F,persist:!1});let P=encodeURIComponent(Ae(L));window.location.href=`/admin/site/${P}/design`}catch(v){console.error("[admin] Impossible de s\xE9lectionner le site",v),$("Erreur inattendue lors de la s\xE9lection.")}},vn=async()=>{try{let o=await fetch("/api/sites/current",{credentials:"same-origin"});if(!o.ok){o.status===404&&V&&(window.location.href="/admin/sites");return}let l=await o.json(),h=Ee(l.slug);dt(h,l.name),ut(h,{siteName:l.name,persist:!1})}catch(o){console.warn("[admin] Impossible de r\xE9cup\xE9rer le site actif",o)}};(()=>{if(O.slug){ut(O.slug,{siteName:O.name,persist:!1});return}let o=document.querySelector('[data-site-card][data-site-default="true"]')||kt[0];o&&ut(o.dataset.siteCard,{siteName:o.dataset.siteName||"",persist:!1})})(),vn(),V?Tt(V.slugValue):O.slug&&Tt(O.slug),dn.forEach(o=>{o.addEventListener("click",()=>{if(o.disabled)return;let l=o.dataset.siteSelect,h=o.dataset.siteSelectName||"Ce site";l&&(o.disabled=!0,yn(l,h).finally(()=>{o.disabled=!1}))})});let _e=o=>o.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),bn=o=>{let l=_e(o||"");return l?`/${l}`:""},xn=()=>{oe&&(ct=document.activeElement,oe.classList.remove("hidden"),oe.classList.add("flex"),lt=!1,Ce==null||Ce.reset(),ie&&(ie.textContent=""),xe&&(xe.textContent=""),be&&pe&&(be.value=_e(pe.value)),document.addEventListener("keydown",Xt),window.setTimeout(()=>{pe==null||pe.focus()},0))},mt=()=>{oe&&(oe.classList.add("hidden"),oe.classList.remove("flex"),document.removeEventListener("keydown",Xt),lt=!1,Ce==null||Ce.reset(),ie&&(ie.textContent=""),xe&&(xe.textContent=""),ct==null||ct.focus())};fn.forEach(o=>{o.addEventListener("click",xn)}),gn.forEach(o=>{o.addEventListener("click",mt)}),oe==null||oe.addEventListener("click",o=>{o.target===oe&&mt()}),pe==null||pe.addEventListener("input",()=>{be&&(!lt||be.value.trim().length===0)&&(be.value=_e(pe.value))}),be==null||be.addEventListener("input",()=>{lt=!0,ie&&(ie.textContent="")});let wn=()=>new Set(Array.from(kt).map(o=>Ee(o.dataset.siteCard||"")));Ce==null||Ce.addEventListener("submit",async o=>{if(o.preventDefault(),!pe||!be)return;let l=(pe.value||"").trim(),h=be.value||"";h||(h=l);let v=bn(h);if(!l||!v){ie&&(ie.textContent="Nom et slug sont requis.");return}if(wn().has(v)){ie&&(ie.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}ie&&(ie.textContent=""),xe&&(xe.textContent=""),He&&(He.disabled=!0,He.textContent="Cr\xE9ation...");try{let L=await fetch("/api/sites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:l,slug:v})});if(!L.ok){let Y=await L.json().catch(()=>({})),k=Y.message||"Impossible de cr\xE9er ce site.";xe&&(xe.textContent=k),Y.field==="slug"&&ie&&(ie.textContent=k);return}let F=await L.json(),P=Ee((F==null?void 0:F.slug)||v),f=(F==null?void 0:F.name)||l;dt(P,f),mt();let _=encodeURIComponent(Ae(P));window.location.href=`/admin/site/${_}/design`}catch(L){console.error("[admin] Impossible de cr\xE9er le site",L),xe&&(xe.textContent="Erreur inattendue. R\xE9essaie dans un instant.")}finally{He&&(He.disabled=!1,He.textContent="Cr\xE9er")}}),window.addEventListener("keydown",o=>{o.key==="Escape"&&(oe&&!oe.classList.contains("hidden")&&mt(),Ie&&!Ie.classList.contains("hidden")&&Qt(),blockDeleteModal&&!blockDeleteModal.classList.contains("hidden")&&closeBlockDeleteModal(),blockLibraryOpen&&closeBlockLibrary())});function Sn(){let o=window.location.pathname.match(/^\/admin\/site\/([^/]+)(?:\/([^/]+))?/);return o?{slugPart:decodeURIComponent(o[1]),slugValue:Ee(decodeURIComponent(o[1])),section:o[2]||"design"}:null}function Ln(){return document.querySelector("[data-page-list]")?"design":document.querySelector("[data-collection-list]")?"content":document.querySelector("[data-media-grid]")?"media":document.querySelector("[data-deploy-form]")?"deploy":null}function Cn(){if(!Ie){window.location.href="/admin/sites";return}Ie.classList.remove("hidden"),Ie.classList.add("flex")}function Qt(){Ie&&(Ie.classList.add("hidden"),Ie.classList.remove("flex"))}un.forEach(o=>{o.addEventListener("click",Cn)}),mn.forEach(o=>{o.addEventListener("click",Qt)}),It==null||It.addEventListener("click",()=>{window.location.href="/admin/sites"});let pt=(V==null?void 0:V.section)||Ln();pt==="design"&&En(),pt==="content"&&qn(),pt==="media"&&In(),pt==="deploy"&&kn(),V&&O.name&&Zt(O.name);function En(){let o=document.querySelectorAll("[data-page-list]");if(o.length===0)return;let l=document.querySelector("[data-active-page-title]"),h=document.querySelector("[data-active-page-slug]"),v=document.querySelector("[data-page-preview-tags]"),C=document.querySelector("[data-page-preview-frame]"),L=document.querySelector("[data-preview-open]"),F=document.querySelector("[data-preview-status]"),P=document.querySelector("[data-preview-highlight]"),f=document.querySelector("[data-blocks-list]"),_=document.querySelector("[data-blocks-empty]"),Y=document.querySelector("[data-block-count]"),k=document.querySelector("[data-block-library-toggle]"),I=document.querySelector("[data-block-library]"),q=document.querySelectorAll("[data-block-add]"),u=document.querySelector("[data-block-delete-modal]"),D=document.querySelector("[data-block-delete-confirm]"),G=document.querySelector("[data-block-delete-cancel]"),T=document.querySelector("[data-block-detail-empty]"),K=document.querySelector("[data-block-detail-status]"),j=document.querySelector("[data-block-editor]"),ce=document.querySelector("[data-block-editor-block-name]"),J=document.querySelector("[data-block-editor-block-type]"),M=document.querySelector("[data-block-editor-unsupported]"),g=document.querySelector("[data-block-form]"),R=g?Array.from(g.querySelectorAll("[data-editor-section]")):[],b=g==null?void 0:g.querySelector('[name="collection-grid-collection"]'),z=g==null?void 0:g.querySelector("[data-collection-selection-info]"),N=document.querySelector("[data-block-form-cancel]"),U=g==null?void 0:g.querySelector("[data-group-preview-mobile]"),i=g==null?void 0:g.querySelector("[data-group-preview-desktop]"),d={hero:{section:"hero",labelField:"title",descriptionField:"subtitle",fields:{title:"hero-title",subtitle:"hero-subtitle",ctaLabel:"hero-cta-label",ctaUrl:"hero-cta-url",image:"hero-image",align:"hero-align"}},paragraphe:{section:"paragraph",labelField:"title",descriptionField:"content",fields:{title:"paragraph-title",content:"paragraph-content",align:"paragraph-align"}},image:{section:"image",labelField:"alt",fields:{src:"image-src",alt:"image-alt",showCaption:"image-caption-toggle",caption:"image-caption"}},groupe:{section:"group",fields:{layout:"group-layout",columnsMobile:"group-columns-mobile",columnsDesktop:"group-columns-desktop"}},collectiongrid:{section:"collection",fields:{collectionId:"collection-grid-collection",limit:"collection-grid-limit"}}},E={texte:"paragraphe",paragraph:"paragraphe",paragraphs:"paragraphe",paragraphes:"paragraphe",text:"paragraphe",hero:"hero",image:"image",groupe:"groupe",group:"groupe",collection:"collectiongrid",collectiongrid:"collectiongrid","collection-grid":"collectiongrid"},Z=(e,t)=>{if(!U||!i)return;let n=a=>Array.from({length:Number(a)||1}).map(()=>'<span class="block h-2 w-full rounded-full bg-slate-300"></span>').join("");U.innerHTML=n(e),i.innerHTML=n(t)},le=async()=>{if(!s)return[];let e=await fetch(s,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les pages.");let t=await e.json().catch(()=>[]);return Array.isArray(t)?t:[]},fe=async({title:e,slug:t})=>{if(!s)throw new Error("Site inconnu.");let n=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,slug:t})});if(!n.ok){let a=await n.json().catch(()=>({}));throw new Error(a.message||"Impossible de cr\xE9er la page.")}return n.json().catch(()=>({}))},Be=async e=>{if(!(!s||!(e!=null&&e.id)))try{let t=await fetch(`${s}/${encodeURIComponent(e.id)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let a=await t.json().catch(()=>({}));throw new Error(a.message||"Impossible de sauvegarder la page.")}let n=await t.json().catch(()=>({}));if(n!=null&&n.id){let a=nt(n);return ae=ae.map(p=>p.id===a.id?a:p),(S==null?void 0:S.id)===a.id&&(S=a),a}return n}catch(t){console.error("[design] Save page failed",t),$(t.message||"Sauvegarde impossible.")}},ge=async()=>{if(!s){ae=[],Se=null,S=null,jt(ae,Se),Ze(null),T==null||T.classList.remove("hidden"),j==null||j.classList.add("hidden");return}try{let e=await le();if(ae=(Array.isArray(e)?e:[]).map(t=>nt(t)),ae.length===0){Se=null,S=null,jt(ae,Se),Ze(null),T==null||T.classList.remove("hidden"),j==null||j.classList.add("hidden"),C&&(C.srcdoc=Q());return}Se=Re(ae),Me(Se)}catch(e){console.error("[design] Impossible de charger les pages",e),$("Impossible de charger les pages.")}},qe=e=>(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),he=e=>{if(!e)return null;let t=qe(e.type),n=E[t]||t;return d[n]||null},we=e=>{var n,a,p;if(!g||!j)return;e&&!e.settings&&(e.settings={});let t=he(e);if(ce&&(ce.textContent=(e==null?void 0:e.label)||"Bloc"),J&&(J.textContent=(e==null?void 0:e.type)||"Bloc"),!t){g.classList.add("hidden"),M==null||M.classList.remove("hidden"),g.dataset.blockId="";return}if(M==null||M.classList.add("hidden"),g.classList.remove("hidden"),g.reset(),g.dataset.blockId=e.id,R.forEach(x=>{x.dataset.editorSection===t.section?x.classList.remove("hidden"):x.classList.add("hidden")}),t.section==="collection"){let x=e.collectionId||((n=e.settings)==null?void 0:n.collectionId)||"";wt(x)}if(Object.entries(t.fields).forEach(([x,H])=>{var ze;let W=g.querySelector(`[name="${H}"]`);if(!W)return;let se=(ze=e.settings)==null?void 0:ze[x];W.type==="checkbox"?W.checked=!!se:W.type==="number"?W.value=se!=null?se:1:(W.tagName,W.value=se!=null?se:"")}),t.section==="group"){let x=((a=g.querySelector('[name="group-columns-mobile"]'))==null?void 0:a.value)||"1",H=((p=g.querySelector('[name="group-columns-desktop"]'))==null?void 0:p.value)||"3";Z(x,H)}},Te=e=>{if(!g||!e)return{};let t={};return Object.entries(e.fields).forEach(([n,a])=>{let p=g.querySelector(`[name="${a}"]`);if(p)if(p.type==="checkbox")t[n]=p.checked;else if(p.type==="number"){let x=Number(p.value);t[n]=Number.isFinite(x)?x:0}else p.tagName==="TEXTAREA"?t[n]=p.value||"":p.type==="select-one"?t[n]=p.value:t[n]=p.value||""}),t},X=e=>{if(F){if(!e){F.classList.add("hidden");return}F.classList.remove("hidden"),F.textContent=e}},Ne=e=>e?{id:e.id,title:e.title,slug:e.slug,badges:[...e.badges||[]],blocks:(e.blocks||[]).map(t=>{var n;return{id:t.id,type:t.type,label:t.label,status:t.status,description:t.description,props:t.props||[],settings:t.settings||{},collectionId:t.collectionId||((n=t.settings)==null?void 0:n.collectionId)||""}})}:null,Q=()=>'<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#475569;background:#fff;">Pr\xE9paration de la pr\xE9visualisation\u2026</body></html>',$e=e=>{if(!C||!e)return;let t=(V==null?void 0:V.slugValue)||O.slug||"",n={page:Ne(e),site:{title:O.name||"Site",slug:t}};Rt=!1,X("Actualisation\u2026"),C.srcdoc=Q(),tt&&tt.abort();let a=new AbortController;tt=a,fetch("/api/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n),signal:a.signal}).then(p=>{if(!p.ok)throw new Error("Preview error");return p.json()}).then(p=>{a.signal.aborted||(Pt=p.html||"",C.setAttribute("title",`Pr\xE9visualisation de la page ${e.title||""}`.trim()),C.srcdoc=Pt||Q(),X("\xC0 jour"))}).catch(p=>{a.signal.aborted||(console.error("[preview] Impossible de rendre la page",p),X("Erreur preview"),C.srcdoc='<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#be123c;background:#fff;">Erreur lors du rendu de la pr\xE9visualisation.</body></html>')}).finally(()=>{tt===a&&(tt=null)})},De=e=>{if(e.preventDefault(),!S||!re)return;let t=Ft(),n=he(t);if(!t||!n)return;let a=Te(n);if(n.section==="collection"){if(!a.collectionId){$("S\xE9lectionnez une collection.");return}a.limit=Math.max(1,Number(a.limit)||1)}let p=(S.blocks||[]).map(x=>{if(x.id!==t.id)return x;let H={...x.settings||{},...a},W={...x,settings:H};return n.labelField&&a[n.labelField]&&(W.label=a[n.labelField]),n.descriptionField&&a[n.descriptionField]&&(W.description=a[n.descriptionField]),n.section==="collection"&&(W.collectionId=a.collectionId,W.settings.collectionId=a.collectionId,W.settings.limit=a.limit),W});Qe(p),$("Bloc mis \xE0 jour"),Me(S.id,{preserveBlock:!0})},ye=document.querySelector("[data-page-drawer]"),te=document.querySelector("[data-page-drawer-backdrop]"),Ue=document.querySelectorAll("[data-page-drawer-open]"),je=document.querySelectorAll("[data-page-drawer-close]"),ue=document.querySelector("[data-add-page-toggle]"),ne=document.querySelector("[data-add-page-form]"),r=document.querySelector("[data-add-page-title]"),c=document.querySelector("[data-add-page-slug]"),A=document.querySelector("[data-add-page-cancel]"),y=document.querySelector("[data-add-page-error]"),me=ne==null?void 0:ne.querySelector('[type="submit"]'),Oe=Ae((V==null?void 0:V.slugValue)||O.slug||"default")||"default",ft=(V==null?void 0:V.slugValue)||O.slug||"",Pe=Ae(ft)||"",s=Pe?`/api/sites/${encodeURIComponent(Pe)}/pages`:null,m=Pe?`/api/sites/${encodeURIComponent(Pe)}/collections`:null,w={active:`clower:activePage:${Oe}`},B=(e,t,n,a,p,x=[],H={})=>{let W={id:e,label:t,type:n,status:a,description:p,props:x,settings:{...H}};return W.settings.collectionId&&(W.collectionId=W.settings.collectionId),W},ee={hero:{type:"Hero",label:"Hero de page",description:"Section pleine largeur avec CTA principal.",status:"Brouillon",props:[{label:"CTA",value:"D\xE9couvrir"},{label:"Hauteur",value:"80vh"}],settings:{title:"Titre du hero",subtitle:"",ctaLabel:"D\xE9couvrir",ctaUrl:"#",image:"",align:"center"}},paragraph:{type:"Paragraphe",label:"Bloc \xE9ditorial",description:"Paragraphe libre pour raconter votre histoire.",status:"Brouillon",props:[{label:"Longueur",value:"150 mots"}],settings:{title:"Titre du paragraphe",content:"",align:"left"}},image:{type:"Image",label:"Bloc image",description:"Visuel seul avec l\xE9gende optionnelle.",status:"Brouillon",props:[{label:"Ratio",value:"16:9"},{label:"L\xE9gende",value:"Inactive"}],settings:{src:"",alt:"",showCaption:!1,caption:""}},group:{type:"Groupe",label:"Groupe de sections",description:"Conteneur pour imbriquer plusieurs sous-blocs.",status:"Brouillon",props:[{label:"Disposition",value:"Verticale"}],settings:{layout:"grid",columnsMobile:"1",columnsDesktop:"3"}},collectiongrid:{type:"CollectionGrid",label:"Grille de contenus",description:"Affiche automatiquement les items d\u2019une collection.",status:"Brouillon",settings:{collectionId:"",limit:6}}},Ye=e=>{try{window.localStorage.setItem(w.active,e)}catch{}},Re=e=>{var t;try{let n=window.localStorage.getItem(w.active);if(n&&e.some(a=>a.id===n))return n}catch{}return((t=e[0])==null?void 0:t.id)||null},Fe=e=>!e||e<=0?"0 bloc":e===1?"1 bloc":`${e} blocs`,Ke=e=>{if(!e||e==="/")return"/";let t=_e(e.replace(/^\//,""));return t?`/${t}`:"/"},Ve=(e="page",t="block")=>`${e}-${t}-${Date.now().toString(36)}-${Math.floor(Math.random()*1e3)}`,$t=(e,t)=>[B(Ve(e,"intro"),"Introduction","Paragraphe","Brouillon",`Paragraphe introductif pour "${t}".`,[{label:"Longueur",value:"2 paragraphes"}],{title:`Introduction \xE0 ${t}`,content:"Ajoutez votre premier paragraphe de pr\xE9sentation.",align:"left"}),B(Ve(e,"content"),"Zone de contenu","Groupe","Brouillon","Section principale \xE0 composer avec textes et visuels.",[{label:"Colonnes",value:"Auto"}],{layout:"grid",columnsMobile:"1",columnsDesktop:"2"})],gt=e=>{l&&(l.textContent=(e==null?void 0:e.title)||"Page"),h&&(h.textContent=(e==null?void 0:e.slug)||"/")},An=e=>{if(!v)return;v.innerHTML="",(e&&e.badges&&e.badges.length>0?e.badges:["Structure en cours"]).forEach(n=>{let a=document.createElement("span");a.className="rounded-full bg-slate-100 px-3 py-1",a.textContent=n,v.appendChild(a)})},Bn=e=>{switch((e||"").toLowerCase()){case"en ligne":return"bg-emerald-50 text-emerald-700";case"brouillon":return"bg-amber-50 text-amber-700";default:return"bg-slate-100 text-slate-600"}},ht=e=>{if(!(!T||!j)){if(!e){T.classList.remove("hidden"),j.classList.add("hidden"),M==null||M.classList.add("hidden"),g==null||g.classList.add("hidden"),K==null||K.classList.add("hidden");return}T.classList.add("hidden"),j.classList.remove("hidden"),K&&(e.status?(K.textContent=e.status,K.className=`rounded-full px-3 py-1 text-xs font-semibold ${Bn(e.status)}`,K.classList.remove("hidden")):K.classList.add("hidden")),we(e)}},Xe=e=>{if(!C)return;let t=C.contentDocument;if(!t)return;t.querySelectorAll("[data-preview-block]").forEach(a=>{a.dataset.previewBlock===e?(a.classList.add("preview-block-active"),Rt&&e&&a.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})):a.classList.remove("preview-block-active")}),P&&(P.style.borderColor=e?"rgba(156, 107, 255, 0.5)":"transparent")},Ze=e=>{if(!f)return;f.innerHTML="";let t=(e==null?void 0:e.blocks)||[];if(Y&&(Y.textContent=Fe(t.length)),t.length===0){f.classList.add("hidden"),_==null||_.classList.remove("hidden");return}f.classList.remove("hidden"),_==null||_.classList.add("hidden"),t.forEach(n=>{var rn;let a=n.id===re,p=document.createElement("div");p.dataset.blockItem="true",p.dataset.blockId=n.id,p.setAttribute("role","option"),p.setAttribute("aria-selected",a?"true":"false"),p.tabIndex=0,p.className=["relative flex items-center gap-3 rounded-2xl border px-3 py-2 text-left transition",a?"bg-slate-100 border-[#9C6BFF]/40 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let x=document.createElement("span");x.className=`absolute inset-y-2 left-0 w-1 rounded-full bg-[#9C6BFF] ${a?"":"hidden"}`,p.appendChild(x);let H=document.createElement("div");H.className="flex flex-1 items-center gap-3";let W=document.createElement("div");W.className="hidden lg:flex cursor-grab flex-shrink-0 items-center text-lg text-slate-400",W.innerHTML="&#8801;",H.appendChild(W);let se=document.createElement("div");se.className="flex-1";let ze=document.createElement("div");ze.className="flex items-center gap-2 text-[11px] uppercase tracking-wide text-slate-500";let Ht=document.createElement("span");Ht.className="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600",Ht.textContent=n.type;let Ut=document.createElement("span");Ut.className="text-slate-400",Ut.textContent=n.status,ze.appendChild(Ht),ze.appendChild(Ut);let Ot=document.createElement("p");Ot.className="mt-1 text-sm font-semibold text-slate-900";let Gn=n.settings&&n.settings.title||n.label||"Bloc sans titre";if(Ot.textContent=Gn,se.appendChild(ze),se.appendChild(Ot),(n.type||"").toLowerCase()==="collectiongrid"&&n.collectionId){let ve=((rn=Le.find(_n=>_n.id===n.collectionId))==null?void 0:rn.name)||n.collectionId,Vt=document.createElement("p");Vt.className="text-xs text-slate-400",Vt.textContent=`Collection : ${ve}`,se.appendChild(Vt)}H.appendChild(se),p.appendChild(H);let St=document.createElement("div");St.className="flex flex-col gap-1 text-xs text-slate-400";let Lt=document.createElement("div");Lt.className="flex items-center gap-1 lg:hidden";let st=document.createElement("button");st.type="button",st.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",st.textContent="\u2191",st.addEventListener("click",ve=>{ve.stopPropagation(),en(n.id,-1)});let ot=document.createElement("button");ot.type="button",ot.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",ot.textContent="\u2193",ot.addEventListener("click",ve=>{ve.stopPropagation(),en(n.id,1)}),Lt.appendChild(st),Lt.appendChild(ot),St.appendChild(Lt);let at=document.createElement("button");at.type="button",at.className="inline-flex items-center justify-center rounded-lg border border-transparent px-2 py-1 text-[12px] text-rose-500 hover:text-rose-700",at.innerHTML="\u{1F5D1}\uFE0F",at.addEventListener("click",ve=>{ve.stopPropagation(),Mn(n.id)}),St.appendChild(at),p.appendChild(St),p.addEventListener("click",()=>{Je(n.id)}),p.addEventListener("keydown",ve=>{(ve.key==="Enter"||ve.key===" ")&&(ve.preventDefault(),Je(n.id))}),f.appendChild(p)})},jt=(e,t)=>{o.forEach(n=>{n.innerHTML="",e.forEach(a=>{let p=document.createElement("li"),x=document.createElement("button");x.type="button",x.dataset.pageId=a.id,x.className=["w-full flex items-center justify-between gap-3 px-3 py-2 text-left transition",t===a.id?"bg-[#9C6BFF]/10 text-slate-900 border border-[#9C6BFF]/40 rounded-xl shadow-sm":"text-slate-700 hover:bg-slate-50 rounded-xl"].join(" "),t===a.id?x.setAttribute("aria-current","page"):x.removeAttribute("aria-current"),x.innerHTML=`
            <div class="flex items-center gap-3">
              <span class="flex h-9 w-9 items-center justify-center rounded-xl border border-slate-200 bg-white text-slate-500">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6.5 4.5h7l4 4v11a1 1 0 0 1-1 1h-10a1 1 0 0 1-1-1v-14a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
                  <path d="M13.5 4.5v4a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.4"/>
                </svg>
              </span>
              <div class="flex flex-col">
                <span class="text-sm font-semibold">${a.title}</span>
                <span class="text-xs text-slate-500">${a.slug}</span>
              </div>
            </div>
          `,x.addEventListener("click",()=>{Me(a.id),Nt()||Dt()}),p.appendChild(x),n.appendChild(p)})})},Ft=()=>!S||!Array.isArray(S.blocks)?null:S.blocks.find(e=>e.id===re)||null,Je=e=>{if(!S)return;if(!e){re=null,Ze(S),ht(null),Xe(null);return}let t=S.blocks.find(n=>n.id===e)||S.blocks[0]||null;re=(t==null?void 0:t.id)||null,Ze(S),ht(t),Xe(re)},Qe=e=>{if(!S)return;let t={...S,blocks:e};Nn(t)},yt=()=>window.matchMedia("(min-width: 1024px)").matches;function en(e,t){if(!S||!e||!t)return;let n=[...S.blocks||[]],a=n.findIndex(H=>H.id===e);if(a<0)return;let p=a+t;if(p<0||p>=n.length)return;let[x]=n.splice(a,1);n.splice(p,0,x),Qe(n),Me(S.id,{preserveBlock:!0}),Je(x.id)}function Tn(e,t){if(!S||!e||!t||e===t)return;let n=[...S.blocks||[]],a=n.findIndex(H=>H.id===e),p=n.findIndex(H=>H.id===t);if(a<0||p<0)return;let[x]=n.splice(a,1);n.splice(p,0,x),Qe(n),Me(S.id,{preserveBlock:!0}),Je(x.id)}function tn(){if(!f)return;let e=yt();f.querySelectorAll("[data-block-item]").forEach(t=>{t.setAttribute("draggable",e?"true":"false")})}function vt(){I&&(I.classList.add("hidden"),et=!1)}function $n(){I&&(I.classList.remove("hidden"),et=!0)}function jn(){et?vt():$n()}function Fn(e){var x;if(!S||!e)return;let t=ee[e];if(!t)return;let n=(S.blocks||[]).filter(H=>H.type===t.type).length+1,a=B(Ve(S.id,e),`${t.label} ${n}`,t.type,t.status,t.description,t.props,t.settings||{});if((t.type||"").toLowerCase()==="collectiongrid"){let H=((x=Le[0])==null?void 0:x.id)||"";a.collectionId=H,a.settings.collectionId=H,a.settings.limit=a.settings.limit||6}let p=[...S.blocks||[],a];Qe(p),Me(S.id,{preserveBlock:!0}),Je(a.id),vt(),$("Bloc ajout\xE9")}function nn(e){var a,p;if(!S)return;let t=(S.blocks||[]).filter(x=>x.id!==e),n=e===re?((a=t[0])==null?void 0:a.id)||null:re||((p=t[0])==null?void 0:p.id)||null;Qe(t),re=n,Me(S.id,{preserveBlock:!0}),re?Je(re):(ht(null),Xe(null)),$("Bloc supprim\xE9")}function Mt(){u&&(u.classList.add("hidden"),u.classList.remove("flex"),xt=null)}function Mn(e){if(!u){nn(e);return}xt=e,u.classList.remove("hidden"),u.classList.add("flex")}let Nn=e=>{if(!e)return;let t=nt(e);ae=ae.map(n=>n.id===t.id?t:n),S=t,Be(t)},Me=(e,t={})=>{var p,x;let n=ae.find(H=>H.id===e)||ae[0]||null;S=n?nt(n):null,Se=(n==null?void 0:n.id)||null,(!t.preserveBlock||!S||!S.blocks.some(H=>H.id===re))&&(re=((x=(p=S==null?void 0:S.blocks)==null?void 0:p[0])==null?void 0:x.id)||null),Se&&Ye(Se),jt(ae,Se),gt(S),An(S),$e(S),Ze(S),ht(Ft()),Xe(re),tn(),et&&vt()},Nt=()=>window.matchMedia("(min-width: 1024px)").matches,sn=()=>{ye&&(Nt()?(ye.classList.add("is-open"),te==null||te.classList.add("hidden"),document.body.classList.remove("overflow-hidden")):ye.classList.remove("is-open"))},Dn=()=>{!ye||Nt()||(ye.classList.add("is-open"),te==null||te.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},Dt=()=>{ye&&(ye.classList.remove("is-open"),te==null||te.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))},Pn=()=>{!ne||!ue||(ne.classList.remove("hidden"),ue.classList.add("hidden"),y&&(y.textContent=""),bt=!1,r&&(r.value="",r.focus()),c&&(c.value=""))},on=()=>{!ne||!ue||(ne.classList.add("hidden"),ue.classList.remove("hidden"),y&&(y.textContent=""),bt=!1,ne.reset())},Rn=()=>{!r||!c||bt&&c.value.trim().length>0||(c.value=Ke(r.value))},ae=[],Se=null,bt=!1,S=null,re=null,et=!1,xt=null,Pt="",Rt=!1,tt=null,Le=[],zn=e=>{let t={...e,props:Array.isArray(e.props)?e.props:[],settings:{...e.settings||{}}};return(t.type||"").toLowerCase()==="collectiongrid"&&(t.collectionId=t.collectionId||t.settings.collectionId||"",t.settings.collectionId=t.collectionId,t.settings.limit=t.settings.limit||6),t},nt=e=>({...e,blocks:(e.blocks||[]).map(t=>zn(t))}),Hn=async()=>{if(!m){Le=[],wt();return}try{let e=await fetch(m,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les collections.");let t=await e.json().catch(()=>[]);Le=Array.isArray(t)?t:[];let n=(b==null?void 0:b.value)||"";wt(n)}catch(e){console.error("[design] collections load",e),$("Collections indisponibles."),Le=[],wt()}},zt=e=>{if(!z)return;if(!e){z.textContent=Le.length?"S\xE9lectionnez une collection pour afficher ses informations.":"Aucune collection disponible. Ajoutez-en depuis l\u2019onglet Contenus.";return}let t=Le.find(a=>a.id===e);if(!t){z.textContent=`Collection ${e}`;return}let n=[];t.description&&n.push(t.description),t.type&&n.push(`Type\xA0: ${t.type}`),z.textContent=n.join(" \xB7 ")||`Collection ${t.name||t.id}`},wt=(e="")=>{if(b){if(b.innerHTML="",!Le.length){b.disabled=!0;let t=document.createElement("option");t.value="",t.textContent="Aucune collection disponible",b.appendChild(t),zt("");return}if(b.disabled=!1,e&&!Le.some(t=>t.id===e)){let t=document.createElement("option");t.value=e,t.textContent=e,b.appendChild(t)}Le.forEach(t=>{let n=document.createElement("option");n.value=t.id;let a=t.name||t.id;n.textContent=t.type?`${a} \xB7 ${t.type}`:a,n.dataset.description=t.description||"",b.appendChild(n)}),e&&(b.value=e),zt(b.value||"")}};Hn(),sn(),Ue.forEach(e=>{e.addEventListener("click",Dn)}),je.forEach(e=>{e.addEventListener("click",Dt)}),te==null||te.addEventListener("click",Dt),window.addEventListener("resize",()=>{sn(),tn()}),ue==null||ue.addEventListener("click",Pn),A==null||A.addEventListener("click",on),r==null||r.addEventListener("input",Rn),c==null||c.addEventListener("input",()=>{y&&(y.textContent=""),bt=!0}),ne==null||ne.addEventListener("submit",async e=>{if(e.preventDefault(),!s){y&&(y.textContent="Aucun site s\xE9lectionn\xE9.");return}if(!r||!c)return;let t=r.value.trim(),n=Ke(c.value.trim()||t);if(!t||!n){y&&(y.textContent="Titre et slug sont requis.");return}y&&(y.textContent=""),me&&(me.disabled=!0,me.textContent="Cr\xE9ation...");try{let a=await fe({title:t,slug:n});if(!a||!a.id)throw new Error("R\xE9ponse invalide.");ae=[...ae,nt(a)],on(),$("Page cr\xE9\xE9e"),Me(a.id)}catch(a){console.error("[design] create page failed",a),y&&(y.textContent=a.message||"Impossible de cr\xE9er la page.")}finally{me&&(me.disabled=!1,me.textContent="Cr\xE9er")}}),k==null||k.addEventListener("click",e=>{e.stopPropagation(),jn()}),document.addEventListener("click",e=>{et&&(I!=null&&I.contains(e.target)||k!=null&&k.contains(e.target)||vt())}),q.forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();let n=e.dataset.blockAdd;Fn(n)})}),G==null||G.addEventListener("click",()=>{Mt()}),D==null||D.addEventListener("click",()=>{xt&&nn(xt),Mt()}),u==null||u.addEventListener("click",e=>{e.target===u&&Mt()}),g==null||g.addEventListener("input",e=>{var n,a;let t=e.target;if(!(!t||!t.name)&&(t.name==="group-columns-mobile"||t.name==="group-columns-desktop")){let p=((n=g.querySelector('[name="group-columns-mobile"]'))==null?void 0:n.value)||"1",x=((a=g.querySelector('[name="group-columns-desktop"]'))==null?void 0:a.value)||"3";Z(p,x)}}),b==null||b.addEventListener("change",e=>{let t=e.target;zt((t==null?void 0:t.value)||"")}),g==null||g.addEventListener("submit",De),N==null||N.addEventListener("click",e=>{e.preventDefault();let t=Ft();t&&we(t)}),C==null||C.addEventListener("load",()=>{Rt=!0,X("\xC0 jour"),Xe(re)}),L==null||L.addEventListener("click",()=>{let e=window.open("","_blank");if(!e)return;e.opener=null;let t=e.document;t.open(),t.write(Pt||Q()),t.close()});let Un=e=>{let t=e.target.closest("[data-block-item]");!t||!yt()||(ke=t.dataset.blockId||null,ke&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",ke),t.classList.add("opacity-50")))},an=()=>{f==null||f.querySelectorAll("[data-block-item]").forEach(e=>e.classList.remove("opacity-50","ring-2","ring-[#9C6BFF]/50"))},On=()=>{ke=null,an()},Vn=e=>{if(!ke||!yt())return;let t=e.target.closest("[data-block-item]");!t||t.dataset.blockId===ke||(e.preventDefault(),t.classList.add("ring-2","ring-[#9C6BFF]/50"))},Jn=e=>{let t=e.target.closest("[data-block-item]");t&&t.classList.remove("ring-2","ring-[#9C6BFF]/50")},Wn=e=>{if(!ke||!yt())return;e.preventDefault();let t=e.target.closest("[data-block-item]"),n=ke;ke=null,an();let a=(t==null?void 0:t.dataset.blockId)||null;a&&Tn(n,a)},ke=null;f==null||f.addEventListener("dragstart",Un),f==null||f.addEventListener("dragend",On),f==null||f.addEventListener("dragover",Vn),f==null||f.addEventListener("dragleave",Jn),f==null||f.addEventListener("drop",Wn),ge()}function qn(){var Oe,ft,Pe;let o=document.querySelector("[data-collection-list]");if(!o)return;let l=document.querySelector("[data-collection-empty]"),h=document.querySelector("[data-collection-items-empty]"),v=document.querySelector("[data-item-table-wrapper]"),C=document.querySelector("[data-item-table-body]"),L=document.querySelector("[data-collection-title]"),F=document.querySelector("[data-collection-description]"),P=document.querySelector("[data-collection-drawer]"),f=document.querySelector("[data-collection-drawer-backdrop]"),_=document.querySelectorAll("[data-collection-drawer-open]"),Y=document.querySelectorAll("[data-collection-drawer-close]"),k=document.querySelector("[data-item-add]"),I=document.querySelector("[data-item-detail-empty]"),q=document.querySelector("[data-item-form]"),u=q?{title:q.querySelector('[name="item-title"]'),slug:q.querySelector('[name="item-slug"]'),excerpt:q.querySelector('[name="item-excerpt"]'),content:q.querySelector('[name="item-content"]'),image:q.querySelector('[name="item-image"]'),status:q.querySelector('[name="item-status"]')}:{},D=document.querySelector("[data-item-status-badge]"),G=document.querySelector("[data-item-delete]"),T=document.querySelector("[data-item-delete-modal]"),K=document.querySelector("[data-item-delete-cancel]"),j=document.querySelector("[data-item-delete-confirm]"),ce=document.querySelector("[data-item-cancel]"),J=document.querySelector("[data-item-save]"),M="rounded-full px-3 py-1 text-xs font-semibold",g=Ae((V==null?void 0:V.slugValue)||O.slug||""),R=g?`/api/sites/${encodeURIComponent(g)}/collections`:null,b=[],z=[],N=null,U=null,i=!1,d=!1,E=null,Z=()=>{P&&(P.classList.add("is-open"),P.style.transform="translateX(0)",f==null||f.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},le=()=>{P&&(P.classList.remove("is-open"),P.style.transform="",f==null||f.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))};_.forEach(s=>{s.addEventListener("click",Z)}),Y.forEach(s=>{s.addEventListener("click",le)}),f==null||f.addEventListener("click",le);let fe=s=>{let m=(s||"").trim();if(!m)return"";if(m==="/")return"/";let B=m.replace(/^\//,"").split("/").map(ee=>_e(ee||"")).filter(ee=>ee.length>0);return B.length?`/${B.join("/")}`:""},Be=s=>{if(!s)return"\u2014";let m=new Date(s);return Number.isNaN(m.getTime())?"\u2014":m.toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"})},ge=()=>{let s=b.find(m=>m.id===N);L&&(L.textContent=(s==null?void 0:s.name)||"S\xE9lectionnez une collection"),F&&(F.textContent=(s==null?void 0:s.description)||"")},qe=s=>{h&&(h.textContent=s||(N?"Aucun item dans cette collection pour le moment.":"Choisissez une collection dans le panneau de gauche."))},he=()=>{q&&(q.classList.add("hidden"),q.dataset.itemId=""),I==null||I.classList.remove("hidden"),D&&(D.className=`hidden ${M}`,D.textContent=""),G&&(G.disabled=!0)},we=()=>{q&&(q.classList.remove("hidden"),I==null||I.classList.add("hidden"))},Te=()=>{k&&(k.disabled=!N,k.disabled?k.classList.add("opacity-60","pointer-events-none"):k.classList.remove("opacity-60","pointer-events-none"))},X=s=>{if(!D)return;if(!s){D.className=`hidden ${M}`,D.textContent="";return}let m=s.toLowerCase(),w="bg-slate-100 text-slate-600 border border-slate-200";m==="publi\xE9"||m==="publie"?w="bg-emerald-50 text-emerald-700 border border-emerald-100":m==="brouillon"&&(w="bg-amber-50 text-amber-700 border border-amber-100"),D.className=`${M} ${w}`,D.textContent=s},Ne=()=>{if(o.innerHTML="",!b.length){l==null||l.classList.remove("hidden");return}l==null||l.classList.add("hidden"),b.forEach(s=>{let m=s.id===N,w=document.createElement("button");w.type="button",w.dataset.collectionId=s.id,w.className=["w-full rounded-xl border px-3 py-2 text-left transition focus:outline-none focus:ring-2 focus:ring-[#9C6BFF]/40",m?"bg-[#F7F0FF] border-[#9C6BFF]/40 text-slate-900":"border-slate-200 text-slate-700 hover:border-[#9C6BFF]/40"].join(" "),w.setAttribute("role","option"),m?w.setAttribute("aria-current","true"):w.removeAttribute("aria-current"),w.innerHTML=`
          <div class="flex items-center justify-between gap-2">
            <div>
              <p class="text-sm font-semibold">${s.name||s.id}</p>
              <p class="text-xs text-slate-500">${s.description||""}</p>
            </div>
            <span class="text-[11px] uppercase tracking-wide text-slate-400">${s.type||""}</span>
          </div>
        `,w.addEventListener("click",()=>{ue(s.id),window.matchMedia("(min-width: 1024px)").matches||le()}),o.appendChild(w)})},Q=()=>{if(C){if(C.innerHTML="",!z.length||!N){h==null||h.classList.remove("hidden"),qe(),v==null||v.classList.add("hidden");return}h==null||h.classList.add("hidden"),v==null||v.classList.remove("hidden"),z.forEach(s=>{let m=document.createElement("tr");m.dataset.itemId=s.id;let w=s.id===U&&!i;m.className=["cursor-pointer transition focus-within:bg-[#F7F0FF]/70 focus:outline-none",w?"bg-[#F7F0FF]/70":"hover:bg-slate-50"].join(" "),m.tabIndex=0,m.setAttribute("role","button"),w?m.setAttribute("aria-current","true"):m.removeAttribute("aria-current");let B=s.status||"Brouillon",ee=B.toLowerCase(),Ye=ee==="publi\xE9"||ee==="publie"?"bg-emerald-50 text-emerald-700 border border-emerald-100":"bg-amber-50 text-amber-700 border border-amber-100";m.innerHTML=`
          <td class="px-4 py-3 align-top">
            <div class="flex flex-col">
              <span class="text-sm font-semibold text-slate-900">${s.title||"Sans titre"}</span>
              <span class="text-xs text-slate-500">${s.summary||s.excerpt||""}</span>
            </div>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-600">${s.slug||""}</td>
          <td class="px-4 py-3 align-top">
            <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${Ye}">
              ${B}
            </span>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-500">${Be(s.updatedAt||s.createdAt)}</td>
        `;let Re=()=>{$e(s.id)};m.addEventListener("click",Re),m.addEventListener("keydown",Fe=>{(Fe.key==="Enter"||Fe.key===" ")&&(Fe.preventDefault(),Re())}),C.appendChild(m)})}},$e=s=>{let m=z.find(w=>w.id===s);m&&(U=m.id,i=!1,d=!0,De(m),Q())},De=s=>{if(!q||!s){he();return}we(),q.dataset.itemId=s.id,u.title&&(u.title.value=s.title||""),u.slug&&(u.slug.value=s.slug||""),u.excerpt&&(u.excerpt.value=s.summary||s.excerpt||""),u.content&&(u.content.value=s.content||""),u.image&&(u.image.value=s.image||""),u.status&&(u.status.value=s.status||"Brouillon"),X(s.status||"Brouillon"),G&&(G.disabled=!1)},ye=()=>{var s;q&&(i=!0,U=null,d=!1,q.dataset.itemId="",q.reset(),u.status&&(u.status.value="Brouillon"),u.slug&&(u.slug.value=""),X("Brouillon"),we(),G&&(G.disabled=!0),(s=u.title)==null||s.focus())},te=()=>{var Re,Fe,Ke,Ve,$t,gt;let s=(((Re=u.title)==null?void 0:Re.value)||"").trim(),m=(((Fe=u.slug)==null?void 0:Fe.value)||"").trim(),w=(((Ke=u.excerpt)==null?void 0:Ke.value)||"").trim(),B=(((Ve=u.content)==null?void 0:Ve.value)||"").trim(),ee=((($t=u.image)==null?void 0:$t.value)||"").trim(),Ye=((gt=u.status)==null?void 0:gt.value)||"Brouillon";return{title:s,slug:fe(m||s),summary:w,excerpt:w,content:B,image:ee,status:Ye}},Ue=s=>{J&&(J.disabled=s,J.textContent=s?"Enregistrement\u2026":"Enregistrer"),G&&!i&&U&&(G.disabled=s)},je=async s=>{if(!R)return[];let m=await fetch(`${R}/${encodeURIComponent(s)}/items`,{headers:{Accept:"application/json"}});if(!m.ok){let B=await m.json().catch(()=>({}));throw new Error(B.message||"Impossible de charger les items.")}let w=await m.json().catch(()=>({}));return Array.isArray(w.items)?w.items:[]},ue=async s=>{if(s&&(N=s,U=null,i=!1,d=!1,ge(),Te(),Ne(),he(),z=[],Q(),qe("Chargement des items\u2026"),h==null||h.classList.remove("hidden"),v==null||v.classList.add("hidden"),!!R))try{z=await je(s),Q(),z.length||qe()}catch(m){console.error("[content] items failed",m),$(m.message||"Impossible de charger les items."),z=[],Q()}},ne=async(s,m)=>{if(!R)throw new Error("Site inconnu.");let w=await fetch(`${R}/${encodeURIComponent(s)}/items`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)});if(!w.ok){let B=await w.json().catch(()=>({}));throw new Error(B.message||"Impossible de cr\xE9er cet item.")}return w.json()},r=async(s,m,w)=>{if(!R)throw new Error("Site inconnu.");let B=await fetch(`${R}/${encodeURIComponent(s)}/items/${encodeURIComponent(m)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(w)});if(!B.ok){let ee=await B.json().catch(()=>({}));throw new Error(ee.message||"Impossible de sauvegarder cet item.")}return B.json()},c=async(s,m)=>{if(!R)throw new Error("Site inconnu.");let w=await fetch(`${R}/${encodeURIComponent(s)}/items/${encodeURIComponent(m)}`,{method:"DELETE"});if(!w.ok){let B=await w.json().catch(()=>({}));throw new Error(B.message||"Impossible de supprimer cet item.")}},A=async()=>{var s;if(!R){l==null||l.classList.remove("hidden"),N=null,z=[],Q(),ge(),Te();return}try{let m=await fetch(R,{headers:{Accept:"application/json"}});if(!m.ok)throw new Error("Impossible de charger les collections.");let w=await m.json().catch(()=>[]);if(b=Array.isArray(w)?w:[],Ne(),b.length>0){let B=((s=b.find(ee=>ee.id===N))==null?void 0:s.id)||b[0].id;ue(B)}else N=null,z=[],ge(),Te(),Q()}catch(m){console.error("[content] load collections",m),$(m.message||"Impossible de charger les collections.")}};k==null||k.addEventListener("click",()=>{if(!N){$("S\xE9lectionnez d\u2019abord une collection.");return}ye(),Q()}),ce==null||ce.addEventListener("click",s=>{if(s.preventDefault(),i){i=!1,U=null,he(),Q();return}if(U){let m=z.find(w=>w.id===U);De(m)}else he()}),(Oe=u.status)==null||Oe.addEventListener("change",()=>{X(u.status.value)}),(ft=u.title)==null||ft.addEventListener("input",()=>{!i||!u.slug||d||(u.slug.value=fe(u.title.value))}),(Pe=u.slug)==null||Pe.addEventListener("input",()=>{i&&(d=!0)}),q==null||q.addEventListener("submit",async s=>{var w;if(s.preventDefault(),!N){$("S\xE9lectionnez une collection.");return}let m=te();if(!m.title){$("Le titre est requis."),(w=u.title)==null||w.focus();return}Ue(!0);try{let B;i||!U?(B=await ne(N,m),z=[...z,B],$("Item cr\xE9\xE9")):(B=await r(N,U,m),z=z.map(ee=>ee.id===B.id?B:ee),$("Item mis \xE0 jour")),i=!1,U=B.id,De(B),Q()}catch(B){console.error("[content] save item failed",B),$(B.message||"Impossible de sauvegarder cet item.")}finally{Ue(!1)}});let y=()=>{T&&(T.classList.add("hidden"),T.classList.remove("flex"),E=null)},me=()=>{!T||!U||(E=U,T.classList.remove("hidden"),T.classList.add("flex"))};G==null||G.addEventListener("click",s=>{s.preventDefault(),U&&me()}),K==null||K.addEventListener("click",()=>{y()}),T==null||T.addEventListener("click",s=>{s.target===T&&y()}),j==null||j.addEventListener("click",async()=>{if(!E||!N){y();return}j.disabled=!0,j.textContent="Suppression\u2026";try{await c(N,E),z=z.filter(s=>s.id!==E),U===E&&(U=null,he()),$("Item supprim\xE9"),Q()}catch(s){console.error("[content] delete item failed",s),$(s.message||"Impossible de supprimer cet item.")}finally{j.disabled=!1,j.textContent="Supprimer",y()}}),ge(),Te(),A()}function kn(){let o=document.querySelector("[data-deploy-form]");if(!o)return;let l=document.querySelector("[data-deploy-protocol]"),h=document.querySelector("[data-deploy-host]"),v=document.querySelector("[data-deploy-port]"),C=document.querySelector("[data-deploy-user]"),L=document.querySelector("[data-deploy-password]"),F=document.querySelector("[data-deploy-show-password]"),P=document.querySelector("[data-deploy-remote-path]"),f=document.querySelector("[data-deploy-feedback]"),_=document.querySelector("[data-deploy-save]"),Y=document.querySelector("[data-deploy-test]"),k=document.querySelector("[data-deploy-trigger]"),I=document.querySelector("[data-deploy-history]"),q=document.querySelector("[data-deploy-log]"),u=Ae((V==null?void 0:V.slugValue)||O.slug||""),D=u?`/api/sites/${encodeURIComponent(u)}/deploy-config`:null,G=u?`/api/sites/${encodeURIComponent(u)}/deploy`:null,T=u?`/api/sites/${encodeURIComponent(u)}/deploy-log`:null,K=!1,j=null,ce=i=>{let d=(i||"").trim();return d?d.startsWith("/")?d:`/${d}`:"/www"},J=(i,d="muted")=>{if(!f)return;let E="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold",Z=d==="success"?"bg-emerald-50 text-emerald-700 border border-emerald-100":d==="error"?"bg-rose-50 text-rose-700 border border-rose-100":"bg-slate-50 text-slate-600 border border-slate-100";if(!i){f.textContent="",f.className="text-sm text-slate-500";return}let le=d==="success"?"\u2705":d==="error"?"\u274C":"\u2139\uFE0F";f.innerHTML=`<span class="${E} ${Z}">${le}<span>${i}</span></span>`,f.className="text-sm"},M=(i=null)=>{j=i;let d=!!i,E='<svg class="h-4 w-4 animate-spin text-white" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>';_&&(_.disabled=d,_.innerHTML=i==="save"?`<span class="inline-flex items-center gap-2">${E}<span>Enregistrement\u2026</span></span>`:"Enregistrer"),Y&&(Y.disabled=d,Y.innerHTML=i==="test"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-slate-200 border-t-slate-600"></span><span>Test en cours\u2026</span></span>':"Tester la connexion"),k&&(k.disabled=d&&i!==null,k.innerHTML=i==="deploy"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-white/60 border-t-white"></span><span>D\xE9ploiement\u2026</span></span>':"D\xE9ployer maintenant")},g=i=>{l&&(l.value=i.protocol||"sftp"),h&&(h.value=i.host||""),v&&(v.value=i.port||""),C&&(C.value=i.user||""),P&&(P.value=i.remotePath||"/www"),K=!!i.hasPassword,L&&(L.value="",L.placeholder=K?"Non affich\xE9":"Mot de passe")},R=(i=[])=>{if(I){if(I.innerHTML="",!i.length){let d=document.createElement("li");d.className="text-slate-500",d.textContent="Aucun d\xE9ploiement pour le moment.",I.appendChild(d);return}i.forEach(d=>{let E=document.createElement("li");E.className="flex items-center justify-between gap-2 rounded-xl border border-slate-200 px-3 py-2";let Z=d.status==="success"?'<span class="rounded-full bg-emerald-50 px-2 py-0.5 text-[11px] font-semibold text-emerald-700">Succ\xE8s</span>':'<span class="rounded-full bg-rose-50 px-2 py-0.5 text-[11px] font-semibold text-rose-700">\xC9chec</span>',le=d.finishedAt||d.startedAt||"",fe=d.durationMs&&Number(d.durationMs)>=0?`${Math.round(Number(d.durationMs)/1e3)}s`:"";E.innerHTML=`
          <div class="space-y-1">
            <div class="flex items-center gap-2">${Z}<span class="text-xs text-slate-500">${le}</span></div>
            <p class="text-sm text-slate-800">${d.message||""}</p>
          </div>
          <div class="text-xs text-slate-500">${fe}</div>
        `,E.dataset.deployId=d.id||"",E.addEventListener("click",()=>{d.logs&&q&&(q.textContent=d.logs.join(`
`))}),I.appendChild(E)})}},b=(i=[])=>{q&&(q.textContent=i.length?i.join(`
`):"Aucun log pour le moment.")},z=async()=>{var i;if(T)try{let d=await fetch(T,{headers:{Accept:"application/json"}});if(!d.ok){if(d.status===404){R([]),b(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw new Error("Impossible de charger l\u2019historique.")}let E=await d.json().catch(()=>({})),Z=Array.isArray(E.entries)?E.entries:[];R(Z),(i=Z[0])!=null&&i.logs&&b(Z[0].logs)}catch(d){console.error("[deploy] history failed",d)}},N=async()=>{if(!D){J("Aucun site actif s\xE9lectionn\xE9.","error");return}M("load");try{let i=await fetch(D,{headers:{Accept:"application/json"}}),d=await i.json().catch(()=>({}));i.ok?(g(d||{}),J("Configuration charg\xE9e.","muted")):(g(d||{}),J(d.message||"Configuration par d\xE9faut charg\xE9e.","muted"))}catch(i){console.error("[deploy] load failed",i),J(i.message||"Erreur lors du chargement.","error")}finally{M(null)}},U=()=>{let i={protocol:(l==null?void 0:l.value)||"sftp",host:(h==null?void 0:h.value.trim())||"",port:Number(v==null?void 0:v.value)||void 0,user:(C==null?void 0:C.value.trim())||"",remotePath:ce((P==null?void 0:P.value)||"/www")},d=(L==null?void 0:L.value)||"";return d.trim().length>0&&(i.password=d),i};o.addEventListener("submit",async i=>{if(i.preventDefault(),!D){J("Aucun site actif s\xE9lectionn\xE9.","error");return}let d=U();M("save");try{let E=await fetch(D,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(!E.ok){let le=await E.json().catch(()=>({}));throw new Error(le.message||"Sauvegarde impossible.")}let Z=await E.json();g(Z||{}),J("Configuration enregistr\xE9e.","success"),$("Configuration d\xE9ploiement sauvegard\xE9e")}catch(E){console.error("[deploy] save failed",E),J(E.message||"Erreur lors de la sauvegarde.","error")}finally{M(null)}}),Y==null||Y.addEventListener("click",async()=>{if(!D){J("Aucun site actif s\xE9lectionn\xE9.","error");return}let i=U();if(!i.host||!i.user||!i.remotePath){J("Remplissez les champs requis avant de tester.","error");return}M("test");try{let d=await fetch(`${D}/test`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),E=await d.json().catch(()=>({}));if(!d.ok||E.success===!1){J(E.message||"Test de connexion \xE9chou\xE9.","error");return}J(E.message||"Connexion OK.","success"),$("Test de connexion r\xE9ussi")}catch(d){console.error("[deploy] test failed",d),J(d.message||"Test de connexion \xE9chou\xE9.","error")}finally{M(null)}}),k==null||k.addEventListener("click",async()=>{if(!G){J("Aucun site actif s\xE9lectionn\xE9.","error");return}M("deploy"),b(["D\xE9ploiement en cours\u2026"]);try{let i=await fetch(G,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(U())}),d=await i.json().catch(()=>({}));if(!i.ok){if(i.status===404){J("API d\xE9ploiement indisponible (red\xE9marre le serveur).","error"),b(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw b(d.logs||[]),new Error(d.message||"D\xE9ploiement \xE9chou\xE9.")}b(d.logs||[]),await z(),$("D\xE9ploiement termin\xE9")}catch(i){console.error("[deploy] run failed",i),J(i.message||"D\xE9ploiement \xE9chou\xE9.","error")}finally{M(null)}}),F==null||F.addEventListener("change",()=>{L&&(L.type=F.checked?"text":"password")}),N(),z()}function In(){let o=document.querySelector("[data-media-grid]");if(!o)return;let l=document.querySelector("[data-media-empty]"),h=document.querySelector("[data-media-count]"),v=document.querySelector("[data-media-filter-type]"),C=document.querySelector("[data-media-detail-empty]"),L=document.querySelector("[data-media-detail]"),F=document.querySelector("[data-media-detail-preview]"),P=document.querySelector("[data-media-detail-name]"),f=document.querySelector("[data-media-detail-type]"),_=document.querySelector("[data-media-detail-size]"),Y=document.querySelector("[data-media-detail-path]"),k=document.querySelector("[data-media-detail-used]"),I=document.querySelector("[data-media-alt-edit]"),q=document.querySelector("[data-media-save]"),u=document.querySelector("[data-media-delete]"),D=document.querySelector("[data-media-delete-modal]"),G=document.querySelector("[data-media-delete-cancel]"),T=document.querySelector("[data-media-delete-confirm]"),K=document.querySelector("[data-media-upload-open]"),j=document.querySelector("[data-media-file-input]"),ce=document.querySelector("[data-media-upload-status]"),J=Ae((V==null?void 0:V.slugValue)||O.slug||""),M=J?`/api/sites/${encodeURIComponent(J)}/media`:null,g=[],R=[],b=null,z=null,N=null,U=!1,i=!1,d=!1,E=null,Z=r=>{let c=(r.type||"").toLowerCase(),A=(r.filename||"").toLowerCase();return c.includes("image")||/\.(png|jpe?g|webp|svg|gif)$/i.test(A)?"image":c.includes("pdf")||c.includes("doc")||/\.(pdf|docx?)$/i.test(A)?"document":c.includes("video")||/\.(mp4|mov|webm)$/i.test(A)?"video":"other"},le=r=>Z(r)==="image",fe=r=>{if(r.type)return r.type.toUpperCase();let c=(r.filename||"").split(".").pop();return c?c.toUpperCase():"FILE"},Be=r=>!r||r<=0?"\u2014":r<1024?`${r} o`:r<1024*1024?`${(r/1024).toFixed(1)} ko`:`${(r/(1024*1024)).toFixed(1)} Mo`,ge=()=>{L==null||L.classList.add("hidden"),C==null||C.classList.remove("hidden"),qe(),b=null,i=!1,X(!1),F&&(F.innerHTML='<span class="text-slate-400 text-sm">Aucun m\xE9dia s\xE9lectionn\xE9</span>'),P&&(P.textContent=""),f&&(f.textContent=""),_&&(_.textContent=""),I&&(I.value=""),Y&&(Y.textContent=""),k&&(k.innerHTML="")},qe=()=>{N=null,d=!1,U=!1,E&&(URL.revokeObjectURL(E),E=null),ce&&(ce.textContent="Aucun fichier s\xE9lectionn\xE9."),j&&(j.value="")},he=()=>{h&&(R.length?R.length===1?h.textContent="1 m\xE9dia":h.textContent=`${R.length} m\xE9dias`:h.textContent="0 m\xE9dia")},we=()=>{if(o.innerHTML="",!R.length){l==null||l.classList.remove("hidden"),ge();return}l==null||l.classList.add("hidden"),R.forEach(r=>{let c=document.createElement("button");c.type="button",c.dataset.mediaId=r.id;let A=r.id===b;c.className=["group relative flex flex-col rounded-2xl border px-3 py-3 text-left transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#9C6BFF]",A?"border-[#9C6BFF] bg-[#F7F0FF]/60 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let y=le(r)?`<img src="${r.path}" alt="${r.alt||r.filename}" class="h-full w-full object-cover" />`:'<div class="flex h-full w-full items-center justify-center text-3xl text-slate-400">\u{1F4C4}</div>';c.innerHTML=`
          <div class="relative aspect-[4/3] overflow-hidden rounded-xl bg-slate-100">
            ${y}
          </div>
          <div class="mt-2 space-y-1">
            <p class="text-sm font-semibold text-slate-900 truncate">${r.filename}</p>
            <p class="text-xs text-slate-500">
              ${fe(r)} \xB7 ${Be(r.size)}
            </p>
          </div>
        `,r.id===z&&(c.classList.add("ring-2","ring-[#9C6BFF]"),window.setTimeout(()=>{c.classList.remove("ring-2","ring-[#9C6BFF]")},1600)),c.addEventListener("click",()=>Ne(r.id)),o.appendChild(c)}),z=null},Te=r=>{if(k){if(k.innerHTML="",!r.usedIn||r.usedIn.length===0){let c=document.createElement("li");c.textContent="Non utilis\xE9",c.className="text-xs text-slate-400",k.appendChild(c);return}r.usedIn.forEach(c=>{let A=document.createElement("li");A.textContent=c,A.className="text-xs text-slate-600",k.appendChild(A)})}},X=r=>{if(q){if(d){q.textContent=r?"T\xE9l\xE9versement\u2026":"T\xE9l\xE9verser",q.disabled=r||!N,u&&u.classList.add("hidden");return}q.textContent=r?"Enregistrement\u2026":"Enregistrer",q.disabled=r||!i,u&&(u.classList.remove("hidden"),u.disabled=!b)}},Ne=r=>{let c=g.find(A=>A.id===r);if(!c){ge(),we();return}qe(),b=c.id,i=!1,X(!1),we(),C==null||C.classList.add("hidden"),L==null||L.classList.remove("hidden"),F&&(le(c)?F.innerHTML=`<img src="${c.path}" alt="${c.alt||c.filename}" class="h-full w-full rounded-2xl object-cover" />`:F.innerHTML='<div class="flex h-full w-full flex-col items-center justify-center gap-1 text-slate-400"><span class="text-3xl">\u{1F4C4}</span><span class="text-xs font-semibold">Document</span></div>'),P&&(P.textContent=c.filename||"Fichier"),f&&(f.textContent=fe(c)),_&&(_.textContent=Be(c.size)),I&&(I.value=c.alt||""),Y&&(Y.textContent=c.path||"\u2014"),Te(c)},Q=r=>{if(r){if(d=!0,i=!1,b=null,C==null||C.classList.add("hidden"),L==null||L.classList.remove("hidden"),E&&URL.revokeObjectURL(E),E=URL.createObjectURL(r),F&&(F.innerHTML=`<img src="${E}" alt="${r.name}" class="h-full w-full rounded-2xl object-cover" />`),P&&(P.textContent=r.name),f&&(f.textContent=fe({type:r.type,filename:r.name})),_&&(_.textContent=Be(r.size)),I&&!I.value.trim()&&(I.value=r.name.replace(/\.[^.]+$/,"").replace(/[-_]/g," ")),Y&&(Y.textContent="En attente de t\xE9l\xE9versement"),k){k.innerHTML="";let c=document.createElement("li");c.textContent="Non utilis\xE9",c.className="text-xs text-slate-400",k.appendChild(c)}X(!1)}},$e=()=>{let r=(v==null?void 0:v.value)||"all";r==="all"?R=[...g]:R=g.filter(c=>c.groupType===r),R.some(c=>c.id===b)||ge(),he(),we()},De=async()=>{if(!M){l==null||l.classList.remove("hidden");return}try{let r=await fetch(M,{headers:{Accept:"application/json"}});if(!r.ok)throw new Error("Impossible de charger les m\xE9dias.");let c=await r.json().catch(()=>({items:[]}));g=Array.isArray(c.items)?c.items.map(A=>({...A,groupType:Z(A)})):[],$e()}catch(r){console.error("[media] load failed",r),$(r.message||"Impossible de charger les m\xE9dias."),g=[],$e()}};v==null||v.addEventListener("change",()=>{$e()}),I==null||I.addEventListener("input",()=>{if(d){X(!1);return}b&&(i=!0,X(!1))});let ye=r=>{if(r){if(!r.type.startsWith("image/")){$("Seules les images sont accept\xE9es pour le moment.");return}if(r.size>4*1024*1024){$("Fichier trop volumineux (4 Mo max).");return}N=r,Q(r),ce&&(ce.textContent=`${r.name} \xB7 ${Be(r.size)}`)}},te=r=>new Promise((c,A)=>{let y=new FileReader;y.onload=()=>{let me=y.result||"",[,Oe=""]=String(me).split(",");c(Oe)},y.onerror=()=>A(new Error("Impossible de lire ce fichier.")),y.readAsDataURL(r)}),Ue=async()=>{if(!(!N||!M)){U=!0,X(!0);try{let r=await te(N),c={filename:N.name,type:N.type,size:N.size,alt:(I==null?void 0:I.value)||"",data:r},A=await fetch(M,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!A.ok){let me=await A.json().catch(()=>({}));throw new Error(me.message||"Upload impossible.")}let y=await A.json();y.groupType=Z(y),g=[...g,y],z=y.id,$e(),Ne(y.id),$("M\xE9dia ajout\xE9"),qe()}catch(r){console.error("[media] upload failed",r),$(r.message||"Impossible de t\xE9l\xE9verser ce m\xE9dia.")}finally{U=!1,N=null,X(!1)}}};K==null||K.addEventListener("click",()=>j==null?void 0:j.click()),j==null||j.addEventListener("change",()=>{j.files&&j.files[0]&&ye(j.files[0])});let je=()=>{D&&(D.classList.add("hidden"),D.classList.remove("flex"))},ue=()=>{if(!(!b||d)){if(D){D.classList.remove("hidden"),D.classList.add("flex");return}window.confirm("Supprimer ce m\xE9dia ?")&&ne()}},ne=async()=>{if(!b||!M){je();return}let r=()=>{u&&(u.disabled=!0),T&&(T.disabled=!0,T.textContent="Suppression\u2026")},c=()=>{u&&(u.disabled=!1),T&&(T.disabled=!1,T.textContent="Supprimer")};r();try{let A=await fetch(`${M}/${encodeURIComponent(b)}`,{method:"DELETE"});if(!A.ok){let y=await A.json().catch(()=>({}));throw new Error(y.message||"Suppression impossible.")}g=g.filter(y=>y.id!==b),R=R.filter(y=>y.id!==b),$("M\xE9dia supprim\xE9"),ge(),he(),we()}catch(A){console.error("[media] delete failed",A),$(A.message||"Impossible de supprimer ce m\xE9dia.")}finally{c(),je()}};G==null||G.addEventListener("click",je),D==null||D.addEventListener("click",r=>{r.target===D&&je()}),T==null||T.addEventListener("click",()=>ne()),u==null||u.addEventListener("click",ue),q==null||q.addEventListener("click",async()=>{if(d){Ue();return}if(!(!b||!M||!I)){X(!0);try{let r={alt:I.value||""},c=await fetch(`${M}/${encodeURIComponent(b)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!c.ok){let y=await c.json().catch(()=>({}));throw new Error(y.message||"Impossible de mettre \xE0 jour ce m\xE9dia.")}let A=await c.json();g=g.map(y=>y.id===b?{...y,...A}:y),R=R.map(y=>y.id===b?{...y,...A}:y),i=!1,X(!1),$("M\xE9dia mis \xE0 jour")}catch(r){console.error("[media] update failed",r),$(r.message||"\xC9chec de la mise \xE0 jour."),X(!1)}}}),De()}});})();
