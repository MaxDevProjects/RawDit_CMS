(()=>{document.addEventListener("DOMContentLoaded",()=>{console.log("[admin] Atelier charg\xE9");let $t=document.querySelector("[data-logout]");$t&&$t.addEventListener("click",async()=>{$t.disabled=!0;try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(r){console.error("[admin] Impossible de se d\xE9connecter",r)}finally{window.location.href="/admin/index.html"}});let Qe=document.querySelector("[data-admin-sidebar]"),he=document.querySelector("[data-admin-sidebar-overlay]"),ss=document.querySelectorAll("[data-admin-sidebar-toggle]"),qs=document.querySelectorAll("[data-admin-sidebar-close]"),jt=document.body,pt=!1,ft=()=>{if(!Qe)return;if(window.matchMedia("(min-width: 1024px)").matches){Qe.classList.remove("hidden"),he==null||he.classList.add("hidden"),jt.classList.remove("overflow-hidden");return}pt?(Qe.classList.remove("hidden"),he==null||he.classList.remove("hidden"),jt.classList.add("overflow-hidden")):(Qe.classList.add("hidden"),he==null||he.classList.add("hidden"),jt.classList.remove("overflow-hidden"))},ks=()=>{pt=!0,ft()},Nt=()=>{pt=!1,ft()};Qe&&ss.length>0&&(ss.forEach(r=>{r.addEventListener("click",ks)}),qs.forEach(r=>{r.addEventListener("click",Nt)}),he==null||he.addEventListener("click",Nt),window.addEventListener("resize",ft),window.addEventListener("keydown",r=>{r.key==="Escape"&&pt&&Nt()}),ft());let ns="clower:currentSite",os="clower:currentSiteName",_={slug:null,name:""};(()=>{try{_.slug=window.localStorage.getItem(ns),_.name=window.localStorage.getItem(os)||""}catch{_.slug=null,_.name=""}})();let Pt=document.querySelectorAll("[data-site-card]"),As=document.querySelectorAll("[data-site-select]"),et=document.querySelector("[data-current-site-name]"),rs=document.querySelector("[data-workspace-site-name]"),as=document.querySelector("[data-workspace-back-name]"),De=document.querySelector("[data-workspace-back-modal]"),Is=document.querySelectorAll("[data-workspace-back]"),Fs=document.querySelectorAll("[data-workspace-back-cancel]"),Mt=document.querySelector("[data-workspace-back-confirm]"),Ts=document.querySelectorAll("[data-workspace-tab]"),Dt=document.querySelector("[data-site-toast]"),is=document.querySelector("[data-site-toast-message]"),Bs=document.querySelectorAll("[data-site-create]"),ce=document.querySelector("[data-site-modal]"),Te=document.querySelector("[data-site-form]"),xe=document.querySelector("[data-site-name]"),Ee=document.querySelector("[data-site-slug]"),pe=document.querySelector("[data-site-slug-error]"),qe=document.querySelector("[data-site-modal-error]"),$s=document.querySelectorAll("[data-site-modal-cancel]"),Ve=document.querySelector("[data-site-modal-submit]"),V=Rs(),gt=!1,ht=null,Ot=null,js='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',ls=r=>{if(!ce||ce.classList.contains("hidden")||r.key!=="Tab")return;let d=Array.from(ce.querySelectorAll(js)).filter(B=>!B.hasAttribute("disabled")&&!B.getAttribute("aria-hidden"));if(d.length===0)return;let y=d[0],C=d[d.length-1];r.shiftKey?document.activeElement===y&&(r.preventDefault(),C.focus()):document.activeElement===C&&(r.preventDefault(),y.focus())},D=r=>{!Dt||!is||(is.textContent=r,Dt.classList.remove("hidden"),Ot&&clearTimeout(Ot),Ot=setTimeout(()=>{Dt.classList.add("hidden")},2500))};function Be(r){return r?r.startsWith("/")?r:`/${r}`:""}function ke(r){return(r==null?void 0:r.replace(/^\//,""))||""}let yt=(r,d)=>{let y=r?Be(r):null;try{y&&(window.localStorage.setItem(ns,y),_.slug=y),typeof d=="string"&&d.length>0&&(window.localStorage.setItem(os,d),_.name=d)}catch{_.slug=y||_.slug,_.name=d||_.name}},cs=r=>{et&&r&&(et.textContent=r),rs&&r&&(rs.textContent=r),as&&r&&(as.textContent=r)},Rt=r=>{Ts.forEach(d=>{let y=d.dataset.workspaceTab;if(!y)return;if(!r){d.href="#",d.classList.add("pointer-events-none","opacity-50","text-slate-400"),d.setAttribute("aria-disabled","true");return}let C=encodeURIComponent(ke(r));d.href=`/admin/site/${C}/${y}`,d.classList.remove("pointer-events-none","opacity-50","text-slate-400"),d.removeAttribute("aria-disabled")})},vt=(r,d={})=>{if(!r)return;let y=Be(r),C=d.siteName||_.name||(et==null?void 0:et.dataset.defaultSiteName)||"";Pt.forEach(S=>{let q=Be(S.dataset.siteCard||"")===y,g=S.querySelector("[data-site-active-badge]");q?(S.classList.add("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),S.classList.remove("border-slate-200"),g==null||g.classList.remove("hidden"),C=S.dataset.siteName||C):(S.classList.remove("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),S.classList.add("border-slate-200"),g==null||g.classList.add("hidden"))}),d.persist!==!1&&yt(y,d.siteName||C);let B=d.siteName||C;cs(B),Rt(y)},Ns=async(r,d)=>{let y=Be(r);try{let C=await fetch("/api/sites/select",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slug:y})});if(!C.ok){let g=await C.json().catch(()=>({}));D(g.message||"Impossible de s\xE9lectionner ce site.");return}let B=await C.json().catch(()=>({})),S=Be(B.slug||y),z=B.name||d;yt(S,z),vt(S,{siteName:z,persist:!1});let q=encodeURIComponent(ke(S));window.location.href=`/admin/site/${q}/design`}catch(C){console.error("[admin] Impossible de s\xE9lectionner le site",C),D("Erreur inattendue lors de la s\xE9lection.")}},Ps=async()=>{try{let r=await fetch("/api/sites/current",{credentials:"same-origin"});if(!r.ok){r.status===404&&V&&(window.location.href="/admin/sites");return}let d=await r.json(),y=Be(d.slug);yt(y,d.name),vt(y,{siteName:d.name,persist:!1})}catch(r){console.warn("[admin] Impossible de r\xE9cup\xE9rer le site actif",r)}};(()=>{if(_.slug){vt(_.slug,{siteName:_.name,persist:!1});return}let r=document.querySelector('[data-site-card][data-site-default="true"]')||Pt[0];r&&vt(r.dataset.siteCard,{siteName:r.dataset.siteName||"",persist:!1})})(),Ps(),V?Rt(V.slugValue):_.slug&&Rt(_.slug),As.forEach(r=>{r.addEventListener("click",()=>{if(r.disabled)return;let d=r.dataset.siteSelect,y=r.dataset.siteSelectName||"Ce site";d&&(r.disabled=!0,Ns(d,y).finally(()=>{r.disabled=!1}))})});let tt=r=>r.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),Ms=r=>{let d=tt(r||"");return d?`/${d}`:""},Ds=()=>{ce&&(ht=document.activeElement,ce.classList.remove("hidden"),ce.classList.add("flex"),gt=!1,Te==null||Te.reset(),pe&&(pe.textContent=""),qe&&(qe.textContent=""),Ee&&xe&&(Ee.value=tt(xe.value)),document.addEventListener("keydown",ls),window.setTimeout(()=>{xe==null||xe.focus()},0))},bt=()=>{ce&&(ce.classList.add("hidden"),ce.classList.remove("flex"),document.removeEventListener("keydown",ls),gt=!1,Te==null||Te.reset(),pe&&(pe.textContent=""),qe&&(qe.textContent=""),ht==null||ht.focus())};Bs.forEach(r=>{r.addEventListener("click",Ds)}),$s.forEach(r=>{r.addEventListener("click",bt)}),ce==null||ce.addEventListener("click",r=>{r.target===ce&&bt()}),xe==null||xe.addEventListener("input",()=>{Ee&&(!gt||Ee.value.trim().length===0)&&(Ee.value=tt(xe.value))}),Ee==null||Ee.addEventListener("input",()=>{gt=!0,pe&&(pe.textContent="")});let Os=()=>new Set(Array.from(Pt).map(r=>Be(r.dataset.siteCard||"")));Te==null||Te.addEventListener("submit",async r=>{if(r.preventDefault(),!xe||!Ee)return;let d=(xe.value||"").trim(),y=Ee.value||"";y||(y=d);let C=Ms(y);if(!d||!C){pe&&(pe.textContent="Nom et slug sont requis.");return}if(Os().has(C)){pe&&(pe.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}pe&&(pe.textContent=""),qe&&(qe.textContent=""),Ve&&(Ve.disabled=!0,Ve.textContent="Cr\xE9ation...");try{let S=await fetch("/api/sites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:d,slug:C})});if(!S.ok){let P=await S.json().catch(()=>({})),L=P.message||"Impossible de cr\xE9er ce site.";qe&&(qe.textContent=L),P.field==="slug"&&pe&&(pe.textContent=L);return}let z=await S.json(),q=Be((z==null?void 0:z.slug)||C),g=(z==null?void 0:z.name)||d;yt(q,g),bt();let k=encodeURIComponent(ke(q));window.location.href=`/admin/site/${k}/design`}catch(S){console.error("[admin] Impossible de cr\xE9er le site",S),qe&&(qe.textContent="Erreur inattendue. R\xE9essaie dans un instant.")}finally{Ve&&(Ve.disabled=!1,Ve.textContent="Cr\xE9er")}}),window.addEventListener("keydown",r=>{r.key==="Escape"&&(ce&&!ce.classList.contains("hidden")&&bt(),De&&!De.classList.contains("hidden")&&ds(),blockDeleteModal&&!blockDeleteModal.classList.contains("hidden")&&closeBlockDeleteModal(),blockLibraryOpen&&closeBlockLibrary())});function Rs(){let r=window.location.pathname.match(/^\/admin\/site\/([^/]+)(?:\/([^/]+))?/);return r?{slugPart:decodeURIComponent(r[1]),slugValue:Be(decodeURIComponent(r[1])),section:r[2]||"design"}:null}function Us(){return document.querySelector("[data-page-list]")?"design":document.querySelector("[data-collection-list]")?"content":document.querySelector("[data-media-grid]")?"media":document.querySelector("[data-deploy-form]")?"deploy":null}function Hs(){if(!De){window.location.href="/admin/sites";return}De.classList.remove("hidden"),De.classList.add("flex")}function ds(){De&&(De.classList.add("hidden"),De.classList.remove("flex"))}Is.forEach(r=>{r.addEventListener("click",Hs)}),Fs.forEach(r=>{r.addEventListener("click",ds)}),Mt==null||Mt.addEventListener("click",()=>{window.location.href="/admin/sites"});let st=(V==null?void 0:V.section)||Us();st==="design"&&zs(),st==="content"&&Vs(),st==="media"&&Gs(),st==="deploy"&&Js(),st==="settings"&&Ws(),V&&_.name&&cs(_.name);function zs(){let r=document.querySelectorAll("[data-page-list]");if(r.length===0)return;let d=document.querySelector("[data-active-page-title]"),y=document.querySelector("[data-active-page-slug]"),C=document.querySelector("[data-page-preview-tags]"),B=document.querySelector("[data-page-preview-frame]"),S=document.querySelector("[data-preview-open]"),z=document.querySelector("[data-preview-status]"),q=document.querySelector("[data-preview-highlight]"),g=document.querySelector("[data-seo-toggle]"),k=document.querySelector("[data-seo-panel]"),P=document.querySelector("[data-seo-close]"),L=document.querySelector("[data-seo-form]"),A=document.querySelector("[data-seo-title]"),h=document.querySelector("[data-seo-description]"),u=document.querySelector("[data-seo-feedback]"),x=document.querySelector("[data-seo-save]"),f=document.querySelector("[data-blocks-list]"),M=document.querySelector("[data-blocks-empty]"),ne=document.querySelector("[data-block-count]"),J=document.querySelector("[data-block-library-toggle]"),te=document.querySelector("[data-block-library]"),Y=document.querySelectorAll("[data-block-add]"),U=document.querySelector("[data-block-delete-modal]"),W=document.querySelector("[data-block-delete-confirm]"),H=document.querySelector("[data-block-delete-cancel]"),j=document.querySelector("[data-block-detail-empty]"),v=document.querySelector("[data-block-detail-status]"),w=document.querySelector("[data-block-editor]"),N=document.querySelector("[data-block-editor-block-name]"),l=document.querySelector("[data-block-editor-block-type]"),a=document.querySelector("[data-block-editor-unsupported]"),c=document.querySelector("[data-block-form]"),K=c?Array.from(c.querySelectorAll("[data-editor-section]")):[],O=c==null?void 0:c.querySelector('[name="collection-grid-collection"]'),Z=c==null?void 0:c.querySelector("[data-collection-selection-info]"),fe=document.querySelector("[data-block-form-cancel]"),se=c==null?void 0:c.querySelector("[data-group-preview-mobile]"),Q=c==null?void 0:c.querySelector("[data-group-preview-desktop]"),ye={hero:{section:"hero",labelField:"title",descriptionField:"subtitle",fields:{title:"hero-title",subtitle:"hero-subtitle",ctaLabel:"hero-cta-label",ctaUrl:"hero-cta-url",image:"hero-image",align:"hero-align"}},paragraphe:{section:"paragraph",labelField:"title",descriptionField:"content",fields:{title:"paragraph-title",content:"paragraph-content",align:"paragraph-align"}},image:{section:"image",labelField:"alt",fields:{src:"image-src",alt:"image-alt",showCaption:"image-caption-toggle",caption:"image-caption"}},groupe:{section:"group",fields:{layout:"group-layout",columnsMobile:"group-columns-mobile",columnsDesktop:"group-columns-desktop"}},collectiongrid:{section:"collection",fields:{collectionId:"collection-grid-collection",limit:"collection-grid-limit"}},form:{section:"form",labelField:"formTitle",fields:{formTitle:"form-title",actionUrl:"form-action-url",method:"form-method",serviceName:"form-service-name",submitLabel:"form-submit-label",successMessage:"form-success-message"}},newsletterembed:{section:"newsletter",labelField:"title",fields:{title:"newsletter-title",serviceName:"newsletter-service-name",embedCode:"newsletter-embed-code"}}},we={texte:"paragraphe",paragraph:"paragraphe",paragraphs:"paragraphe",paragraphes:"paragraphe",text:"paragraphe",hero:"hero",image:"image",groupe:"groupe",group:"groupe",collection:"collectiongrid",collectiongrid:"collectiongrid","collection-grid":"collectiongrid",form:"form",formulaire:"form",contact:"form",newsletterembed:"newsletterembed",newsletter:"newsletterembed",embed:"newsletterembed"},Se=(e,t)=>{if(!se||!Q)return;let s=n=>Array.from({length:Number(n)||1}).map(()=>'<span class="block h-2 w-full rounded-full bg-slate-300"></span>').join("");se.innerHTML=s(e),Q.innerHTML=s(t)},oe=async()=>{if(!Ie)return[];let e=await fetch(Ie,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les pages.");let t=await e.json().catch(()=>[]);return Array.isArray(t)?t:[]},$e=async({title:e,slug:t})=>{if(!Ie)throw new Error("Site inconnu.");let s=await fetch(Ie,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,slug:t})});if(!s.ok){let n=await s.json().catch(()=>({}));throw new Error(n.message||"Impossible de cr\xE9er la page.")}return s.json().catch(()=>({}))},re=async e=>{if(!(!Ie||!(e!=null&&e.id)))try{let t=await fetch(`${Ie}/${encodeURIComponent(e.id)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let n=await t.json().catch(()=>({}));throw new Error(n.message||"Impossible de sauvegarder la page.")}let s=await t.json().catch(()=>({}));if(s!=null&&s.id){let n=ct(s);return ae=ae.map(p=>p.id===n.id?n:p),(I==null?void 0:I.id)===n.id&&(I=n),n}return s}catch(t){console.error("[design] Save page failed",t),D(t.message||"Sauvegarde impossible.")}},ve=async()=>{if(!Ie){ae=[],be=null,I=null,Ct(ae,be),rt(null),j==null||j.classList.remove("hidden"),w==null||w.classList.add("hidden");return}try{let e=await oe();if(ae=(Array.isArray(e)?e:[]).map(t=>ct(t)),ae.length===0){be=null,I=null,Ct(ae,be),rt(null),j==null||j.classList.remove("hidden"),w==null||w.classList.add("hidden"),B&&(B.srcdoc=Ne());return}be=Qs(ae),Pe(be)}catch(e){console.error("[design] Impossible de charger les pages",e),D("Impossible de charger les pages.")}},je=e=>(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),Je=e=>{if(!e)return null;let t=je(e.type),s=we[t]||t;return ye[s]||null},We=e=>{var s,n,p;if(!c||!w)return;e&&!e.settings&&(e.settings={});let t=Je(e);if(N&&(N.textContent=(e==null?void 0:e.label)||"Bloc"),l&&(l.textContent=(e==null?void 0:e.type)||"Bloc"),!t){c.classList.add("hidden"),a==null||a.classList.remove("hidden"),c.dataset.blockId="";return}if(a==null||a.classList.add("hidden"),c.classList.remove("hidden"),c.reset(),c.dataset.blockId=e.id,K.forEach(E=>{E.dataset.editorSection===t.section?E.classList.remove("hidden"):E.classList.add("hidden")}),t.section==="collection"){let E=e.collectionId||((s=e.settings)==null?void 0:s.collectionId)||"";It(E)}if(Object.entries(t.fields).forEach(([E,G])=>{var ze;let X=c.querySelector(`[name="${G}"]`);if(!X)return;let le=(ze=e.settings)==null?void 0:ze[E];X.type==="checkbox"?X.checked=!!le:X.type==="number"?X.value=le!=null?le:1:(X.tagName,X.value=le!=null?le:"")}),t.section==="group"){let E=((n=c.querySelector('[name="group-columns-mobile"]'))==null?void 0:n.value)||"1",G=((p=c.querySelector('[name="group-columns-desktop"]'))==null?void 0:p.value)||"3";Se(E,G)}},Ge=e=>{if(!c||!e)return{};let t={};return Object.entries(e.fields).forEach(([s,n])=>{let p=c.querySelector(`[name="${n}"]`);if(p)if(p.type==="checkbox")t[s]=p.checked;else if(p.type==="number"){let E=Number(p.value);t[s]=Number.isFinite(E)?E:0}else p.tagName==="TEXTAREA"?t[s]=p.value||"":p.type==="select-one"?t[s]=p.value:t[s]=p.value||""}),t},Le=e=>{if(z){if(!e){z.classList.add("hidden");return}z.classList.remove("hidden"),z.textContent=e}},_e=e=>e?{id:e.id,title:e.title,slug:e.slug,badges:[...e.badges||[]],blocks:(e.blocks||[]).map(t=>{var s;return{id:t.id,type:t.type,label:t.label,status:t.status,description:t.description,props:t.props||[],settings:t.settings||{},collectionId:t.collectionId||((s=t.settings)==null?void 0:s.collectionId)||""}})}:null,Ne=()=>'<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#475569;background:#fff;">Pr\xE9paration de la pr\xE9visualisation\u2026</body></html>',i=e=>{if(!B||!e)return;let t=(V==null?void 0:V.slugValue)||_.slug||"",s={page:_e(e),site:{title:_.name||"Site",slug:t}};Yt=!1,Le("Actualisation\u2026"),B.srcdoc=Ne(),lt&&lt.abort();let n=new AbortController;lt=n,fetch("/api/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s),signal:n.signal}).then(p=>{if(!p.ok)throw new Error("Preview error");return p.json()}).then(p=>{n.signal.aborted||(_t=p.html||"",B.setAttribute("title",`Pr\xE9visualisation de la page ${e.title||""}`.trim()),B.srcdoc=_t||Ne(),Le("\xC0 jour"))}).catch(p=>{n.signal.aborted||(console.error("[preview] Impossible de rendre la page",p),Le("Erreur preview"),B.srcdoc='<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#be123c;background:#fff;">Erreur lors du rendu de la pr\xE9visualisation.</body></html>')}).finally(()=>{lt===n&&(lt=null)})},b=e=>{if(e.preventDefault(),!I||!me)return;let t=Vt(),s=Je(t);if(!t||!s)return;let n=Ge(s);if(s.section==="collection"){if(!n.collectionId){D("S\xE9lectionnez une collection.");return}n.limit=Math.max(1,Number(n.limit)||1)}let p=(I.blocks||[]).map(E=>{if(E.id!==t.id)return E;let G={...E.settings||{},...n},X={...E,settings:G};return s.labelField&&n[s.labelField]&&(X.label=n[s.labelField]),s.descriptionField&&n[s.descriptionField]&&(X.description=n[s.descriptionField]),s.section==="collection"&&(X.collectionId=n.collectionId,X.settings.collectionId=n.collectionId,X.settings.limit=n.limit),X});at(p),D("Bloc mis \xE0 jour"),Pe(I.id,{preserveBlock:!0})},R=document.querySelector("[data-page-drawer]"),F=document.querySelector("[data-page-drawer-backdrop]"),Ue=document.querySelectorAll("[data-page-drawer-open]"),Ye=document.querySelectorAll("[data-page-drawer-close]"),Ae=document.querySelector("[data-add-page-toggle]"),ge=document.querySelector("[data-add-page-form]"),o=document.querySelector("[data-add-page-title]"),m=document.querySelector("[data-add-page-slug]"),T=document.querySelector("[data-add-page-cancel]"),$=document.querySelector("[data-add-page-error]"),ee=ge==null?void 0:ge.querySelector('[type="submit"]'),He=document.querySelector("[data-import-pages-toggle]"),ie=document.querySelector("[data-import-modal]"),Oe=document.querySelectorAll("[data-import-modal-close]"),de=document.querySelector("[data-import-dropzone]"),Ke=document.querySelector("[data-import-file-input]"),Xe=document.querySelector("[data-import-file-list]"),nt=document.querySelector("[data-import-file-names]"),xt=document.querySelector("[data-import-results]"),wt=document.querySelector("[data-import-results-content]"),ue=document.querySelector("[data-import-submit]"),us=document.querySelectorAll("[data-import-tab]"),_s=document.querySelectorAll("[data-import-panel]"),Ut=document.querySelector("[data-copy-template]"),ms=document.querySelector("[data-template-json]"),Re=[],Ys=ke((V==null?void 0:V.slugValue)||_.slug||"default")||"default",Ks=(V==null?void 0:V.slugValue)||_.slug||"",St=ke(Ks)||"",Ie=St?`/api/sites/${encodeURIComponent(St)}/pages`:null,ps=St?`/api/sites/${encodeURIComponent(St)}/collections`:null,fs={active:`clower:activePage:${Ys}`},Ht=(e,t,s,n,p,E=[],G={})=>{let X={id:e,label:t,type:s,status:n,description:p,props:E,settings:{...G}};return X.settings.collectionId&&(X.collectionId=X.settings.collectionId),X},Xs={hero:{type:"Hero",label:"Hero de page",description:"Section pleine largeur avec CTA principal.",status:"Brouillon",props:[{label:"CTA",value:"D\xE9couvrir"},{label:"Hauteur",value:"80vh"}],settings:{title:"Titre du hero",subtitle:"",ctaLabel:"D\xE9couvrir",ctaUrl:"#",image:"",align:"center"}},paragraph:{type:"Paragraphe",label:"Bloc \xE9ditorial",description:"Paragraphe libre pour raconter votre histoire.",status:"Brouillon",props:[{label:"Longueur",value:"150 mots"}],settings:{title:"Titre du paragraphe",content:"",align:"left"}},image:{type:"Image",label:"Bloc image",description:"Visuel seul avec l\xE9gende optionnelle.",status:"Brouillon",props:[{label:"Ratio",value:"16:9"},{label:"L\xE9gende",value:"Inactive"}],settings:{src:"",alt:"",showCaption:!1,caption:""}},group:{type:"Groupe",label:"Groupe de sections",description:"Conteneur pour imbriquer plusieurs sous-blocs.",status:"Brouillon",props:[{label:"Disposition",value:"Verticale"}],settings:{layout:"grid",columnsMobile:"1",columnsDesktop:"3"}},collectiongrid:{type:"CollectionGrid",label:"Grille de contenus",description:"Affiche automatiquement les items d\u2019une collection.",status:"Brouillon",settings:{collectionId:"",limit:6}},form:{type:"Form",label:"Formulaire de contact",description:"Formulaire avec envoi vers un service externe.",status:"Brouillon",settings:{formTitle:"Contactez-nous",actionUrl:"",method:"POST",serviceName:"",submitLabel:"Envoyer",successMessage:"Merci pour votre message !"}},newsletterembed:{type:"NewsletterEmbed",label:"Newsletter / Embed",description:"Int\xE9gration d'un formulaire newsletter externe (Brevo, Mailchimp\u2026).",status:"Brouillon",settings:{title:"Restez inform\xE9",serviceName:"",embedCode:""}}},Zs=e=>{try{window.localStorage.setItem(fs.active,e)}catch{}},Qs=e=>{var t;try{let s=window.localStorage.getItem(fs.active);if(s&&e.some(n=>n.id===s))return s}catch{}return((t=e[0])==null?void 0:t.id)||null},en=e=>!e||e<=0?"0 bloc":e===1?"1 bloc":`${e} blocs`,gs=e=>{if(!e||e==="/")return"/";let t=tt(e.replace(/^\//,""));return t?`/${t}`:"/"},zt=(e="page",t="block")=>`${e}-${t}-${Date.now().toString(36)}-${Math.floor(Math.random()*1e3)}`,kn=(e,t)=>[Ht(zt(e,"intro"),"Introduction","Paragraphe","Brouillon",`Paragraphe introductif pour "${t}".`,[{label:"Longueur",value:"2 paragraphes"}],{title:`Introduction \xE0 ${t}`,content:"Ajoutez votre premier paragraphe de pr\xE9sentation.",align:"left"}),Ht(zt(e,"content"),"Zone de contenu","Groupe","Brouillon","Section principale \xE0 composer avec textes et visuels.",[{label:"Colonnes",value:"Auto"}],{layout:"grid",columnsMobile:"1",columnsDesktop:"2"})],tn=e=>{d&&(d.textContent=(e==null?void 0:e.title)||"Page"),y&&(y.textContent=(e==null?void 0:e.slug)||"/")},sn=e=>{if(!C)return;C.innerHTML="",(e&&e.badges&&e.badges.length>0?e.badges:["Structure en cours"]).forEach(s=>{let n=document.createElement("span");n.className="rounded-full bg-slate-100 px-3 py-1",n.textContent=s,C.appendChild(n)})},nn=e=>{switch((e||"").toLowerCase()){case"en ligne":return"bg-emerald-50 text-emerald-700";case"brouillon":return"bg-amber-50 text-amber-700";default:return"bg-slate-100 text-slate-600"}},Lt=e=>{if(!(!j||!w)){if(!e){j.classList.remove("hidden"),w.classList.add("hidden"),a==null||a.classList.add("hidden"),c==null||c.classList.add("hidden"),v==null||v.classList.add("hidden");return}j.classList.add("hidden"),w.classList.remove("hidden"),v&&(e.status?(v.textContent=e.status,v.className=`rounded-full px-3 py-1 text-xs font-semibold ${nn(e.status)}`,v.classList.remove("hidden")):v.classList.add("hidden")),We(e)}},ot=e=>{if(!B)return;let t=B.contentDocument;if(!t)return;t.querySelectorAll("[data-preview-block]").forEach(n=>{n.dataset.previewBlock===e?(n.classList.add("preview-block-active"),Yt&&e&&n.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})):n.classList.remove("preview-block-active")}),q&&(q.style.borderColor=e?"rgba(156, 107, 255, 0.5)":"transparent")},rt=e=>{if(!f)return;f.innerHTML="";let t=(e==null?void 0:e.blocks)||[];if(ne&&(ne.textContent=en(t.length)),t.length===0){f.classList.add("hidden"),M==null||M.classList.remove("hidden");return}f.classList.remove("hidden"),M==null||M.classList.add("hidden"),t.forEach(s=>{var Es;let n=s.id===me,p=document.createElement("div");p.dataset.blockItem="true",p.dataset.blockId=s.id,p.setAttribute("role","option"),p.setAttribute("aria-selected",n?"true":"false"),p.tabIndex=0,p.className=["relative flex items-center gap-3 rounded-2xl border px-3 py-2 text-left transition",n?"bg-slate-100 border-[#9C6BFF]/40 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let E=document.createElement("span");E.className=`absolute inset-y-2 left-0 w-1 rounded-full bg-[#9C6BFF] ${n?"":"hidden"}`,p.appendChild(E);let G=document.createElement("div");G.className="flex flex-1 items-center gap-3";let X=document.createElement("div");X.className="hidden lg:flex cursor-grab flex-shrink-0 items-center text-lg text-slate-400",X.innerHTML="&#8801;",G.appendChild(X);let le=document.createElement("div");le.className="flex-1";let ze=document.createElement("div");ze.className="flex items-center gap-2 text-[11px] uppercase tracking-wide text-slate-500";let Zt=document.createElement("span");Zt.className="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600",Zt.textContent=s.type;let Qt=document.createElement("span");Qt.className="text-slate-400",Qt.textContent=s.status,ze.appendChild(Zt),ze.appendChild(Qt);let es=document.createElement("p");es.className="mt-1 text-sm font-semibold text-slate-900";let Ln=s.settings&&s.settings.title||s.label||"Bloc sans titre";if(es.textContent=Ln,le.appendChild(ze),le.appendChild(es),(s.type||"").toLowerCase()==="collectiongrid"&&s.collectionId){let Ce=((Es=Fe.find(Cn=>Cn.id===s.collectionId))==null?void 0:Es.name)||s.collectionId,ts=document.createElement("p");ts.className="text-xs text-slate-400",ts.textContent=`Collection : ${Ce}`,le.appendChild(ts)}G.appendChild(le),p.appendChild(G);let Tt=document.createElement("div");Tt.className="flex flex-col gap-1 text-xs text-slate-400";let Bt=document.createElement("div");Bt.className="flex items-center gap-1 lg:hidden";let dt=document.createElement("button");dt.type="button",dt.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",dt.textContent="\u2191",dt.addEventListener("click",Ce=>{Ce.stopPropagation(),hs(s.id,-1)});let ut=document.createElement("button");ut.type="button",ut.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",ut.textContent="\u2193",ut.addEventListener("click",Ce=>{Ce.stopPropagation(),hs(s.id,1)}),Bt.appendChild(dt),Bt.appendChild(ut),Tt.appendChild(Bt);let mt=document.createElement("button");mt.type="button",mt.className="inline-flex items-center justify-center rounded-lg border border-transparent px-2 py-1 text-[12px] text-rose-500 hover:text-rose-700",mt.innerHTML="\u{1F5D1}\uFE0F",mt.addEventListener("click",Ce=>{Ce.stopPropagation(),cn(s.id)}),Tt.appendChild(mt),p.appendChild(Tt),p.addEventListener("click",()=>{Ze(s.id)}),p.addEventListener("keydown",Ce=>{(Ce.key==="Enter"||Ce.key===" ")&&(Ce.preventDefault(),Ze(s.id))}),f.appendChild(p)})},Ct=(e,t)=>{r.forEach(s=>{s.innerHTML="",e.forEach(n=>{let p=document.createElement("li"),E=document.createElement("button");E.type="button",E.dataset.pageId=n.id,E.className=["w-full flex items-center justify-between gap-3 px-3 py-2 text-left transition",t===n.id?"bg-[#9C6BFF]/10 text-slate-900 border border-[#9C6BFF]/40 rounded-xl shadow-sm":"text-slate-700 hover:bg-slate-50 rounded-xl"].join(" "),t===n.id?E.setAttribute("aria-current","page"):E.removeAttribute("aria-current"),E.innerHTML=`
            <div class="flex items-center gap-3">
              <span class="flex h-9 w-9 items-center justify-center rounded-xl border border-slate-200 bg-white text-slate-500">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6.5 4.5h7l4 4v11a1 1 0 0 1-1 1h-10a1 1 0 0 1-1-1v-14a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
                  <path d="M13.5 4.5v4a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.4"/>
                </svg>
              </span>
              <div class="flex flex-col">
                <span class="text-sm font-semibold">${n.title}</span>
                <span class="text-xs text-slate-500">${n.slug}</span>
              </div>
            </div>
          `,E.addEventListener("click",()=>{Pe(n.id),Wt()||Gt()}),p.appendChild(E),s.appendChild(p)})})},Vt=()=>!I||!Array.isArray(I.blocks)?null:I.blocks.find(e=>e.id===me)||null,Ze=e=>{if(!I)return;if(!e){me=null,rt(I),Lt(null),ot(null);return}let t=I.blocks.find(s=>s.id===e)||I.blocks[0]||null;me=(t==null?void 0:t.id)||null,rt(I),Lt(t),ot(me)},at=e=>{if(!I)return;let t={...I,blocks:e};dn(t)},Et=()=>window.matchMedia("(min-width: 1024px)").matches;function hs(e,t){if(!I||!e||!t)return;let s=[...I.blocks||[]],n=s.findIndex(G=>G.id===e);if(n<0)return;let p=n+t;if(p<0||p>=s.length)return;let[E]=s.splice(n,1);s.splice(p,0,E),at(s),Pe(I.id,{preserveBlock:!0}),Ze(E.id)}function on(e,t){if(!I||!e||!t||e===t)return;let s=[...I.blocks||[]],n=s.findIndex(G=>G.id===e),p=s.findIndex(G=>G.id===t);if(n<0||p<0)return;let[E]=s.splice(n,1);s.splice(p,0,E),at(s),Pe(I.id,{preserveBlock:!0}),Ze(E.id)}function ys(){if(!f)return;let e=Et();f.querySelectorAll("[data-block-item]").forEach(t=>{t.setAttribute("draggable",e?"true":"false")})}function qt(){te&&(te.classList.add("hidden"),it=!1)}function rn(){te&&(te.classList.remove("hidden"),it=!0)}function an(){it?qt():rn()}function ln(e){var E;if(!I||!e)return;let t=Xs[e];if(!t)return;let s=(I.blocks||[]).filter(G=>G.type===t.type).length+1,n=Ht(zt(I.id,e),`${t.label} ${s}`,t.type,t.status,t.description,t.props,t.settings||{});if((t.type||"").toLowerCase()==="collectiongrid"){let G=((E=Fe[0])==null?void 0:E.id)||"";n.collectionId=G,n.settings.collectionId=G,n.settings.limit=n.settings.limit||6}let p=[...I.blocks||[],n];at(p),Pe(I.id,{preserveBlock:!0}),Ze(n.id),qt(),D("Bloc ajout\xE9")}function vs(e){var n,p;if(!I)return;let t=(I.blocks||[]).filter(E=>E.id!==e),s=e===me?((n=t[0])==null?void 0:n.id)||null:me||((p=t[0])==null?void 0:p.id)||null;at(t),me=s,Pe(I.id,{preserveBlock:!0}),me?Ze(me):(Lt(null),ot(null)),D("Bloc supprim\xE9")}function Jt(){U&&(U.classList.add("hidden"),U.classList.remove("flex"),At=null)}function cn(e){if(!U){vs(e);return}At=e,U.classList.remove("hidden"),U.classList.add("flex")}let dn=e=>{if(!e)return;let t=ct(e);ae=ae.map(s=>s.id===t.id?t:s),I=t,re(t)},Pe=(e,t={})=>{var p,E;let s=ae.find(G=>G.id===e)||ae[0]||null;I=s?ct(s):null,be=(s==null?void 0:s.id)||null,(!t.preserveBlock||!I||!I.blocks.some(G=>G.id===me))&&(me=((E=(p=I==null?void 0:I.blocks)==null?void 0:p[0])==null?void 0:E.id)||null),be&&Zs(be),Ct(ae,be),tn(I),sn(I),i(I),rt(I),Lt(Vt()),ot(me),ys(),it&&qt()},Wt=()=>window.matchMedia("(min-width: 1024px)").matches,bs=()=>{R&&(Wt()?(R.classList.add("is-open"),F==null||F.classList.add("hidden"),document.body.classList.remove("overflow-hidden")):R.classList.remove("is-open"))},un=()=>{!R||Wt()||(R.classList.add("is-open"),F==null||F.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},Gt=()=>{R&&(R.classList.remove("is-open"),F==null||F.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))},mn=()=>{!ge||!Ae||(ge.classList.remove("hidden"),Ae.classList.add("hidden"),$&&($.textContent=""),kt=!1,o&&(o.value="",o.focus()),m&&(m.value=""))},xs=()=>{!ge||!Ae||(ge.classList.add("hidden"),Ae.classList.remove("hidden"),$&&($.textContent=""),kt=!1,ge.reset())},pn=()=>{!o||!m||kt&&m.value.trim().length>0||(m.value=gs(o.value))},ae=[],be=null,kt=!1,I=null,me=null,it=!1,At=null,_t="",Yt=!1,lt=null,Fe=[],fn=e=>{let t={...e,props:Array.isArray(e.props)?e.props:[],settings:{...e.settings||{}}};return(t.type||"").toLowerCase()==="collectiongrid"&&(t.collectionId=t.collectionId||t.settings.collectionId||"",t.settings.collectionId=t.collectionId,t.settings.limit=t.settings.limit||6),t},ct=e=>{var t,s;return{...e,blocks:(e.blocks||[]).map(n=>fn(n)),seo:{title:(((t=e.seo)==null?void 0:t.title)||"").trim(),description:(((s=e.seo)==null?void 0:s.description)||"").trim()}}},gn=async()=>{if(!ps){Fe=[],It();return}try{let e=await fetch(ps,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les collections.");let t=await e.json().catch(()=>[]);Fe=Array.isArray(t)?t:[];let s=(O==null?void 0:O.value)||"";It(s)}catch(e){console.error("[design] collections load",e),D("Collections indisponibles."),Fe=[],It()}},Kt=e=>{if(!Z)return;if(!e){Z.textContent=Fe.length?"S\xE9lectionnez une collection pour afficher ses informations.":"Aucune collection disponible. Ajoutez-en depuis l\u2019onglet Contenus.";return}let t=Fe.find(n=>n.id===e);if(!t){Z.textContent=`Collection ${e}`;return}let s=[];t.description&&s.push(t.description),t.type&&s.push(`Type\xA0: ${t.type}`),Z.textContent=s.join(" \xB7 ")||`Collection ${t.name||t.id}`},It=(e="")=>{if(O){if(O.innerHTML="",!Fe.length){O.disabled=!0;let t=document.createElement("option");t.value="",t.textContent="Aucune collection disponible",O.appendChild(t),Kt("");return}if(O.disabled=!1,e&&!Fe.some(t=>t.id===e)){let t=document.createElement("option");t.value=e,t.textContent=e,O.appendChild(t)}Fe.forEach(t=>{let s=document.createElement("option");s.value=t.id;let n=t.name||t.id;s.textContent=t.type?`${n} \xB7 ${t.type}`:n,s.dataset.description=t.description||"",O.appendChild(s)}),e&&(O.value=e),Kt(O.value||"")}};gn(),bs(),Ue.forEach(e=>{e.addEventListener("click",un)}),Ye.forEach(e=>{e.addEventListener("click",Gt)}),F==null||F.addEventListener("click",Gt),window.addEventListener("resize",()=>{bs(),ys()}),Ae==null||Ae.addEventListener("click",mn),T==null||T.addEventListener("click",xs),o==null||o.addEventListener("input",pn),m==null||m.addEventListener("input",()=>{$&&($.textContent=""),kt=!0}),ge==null||ge.addEventListener("submit",async e=>{if(e.preventDefault(),!Ie){$&&($.textContent="Aucun site s\xE9lectionn\xE9.");return}if(!o||!m)return;let t=o.value.trim(),s=gs(m.value.trim()||t);if(!t||!s){$&&($.textContent="Titre et slug sont requis.");return}$&&($.textContent=""),ee&&(ee.disabled=!0,ee.textContent="Cr\xE9ation...");try{let n=await $e({title:t,slug:s});if(!n||!n.id)throw new Error("R\xE9ponse invalide.");ae=[...ae,ct(n)],xs(),D("Page cr\xE9\xE9e"),Pe(n.id)}catch(n){console.error("[design] create page failed",n),$&&($.textContent=n.message||"Impossible de cr\xE9er la page.")}finally{ee&&(ee.disabled=!1,ee.textContent="Cr\xE9er")}});let hn=()=>{ie&&(ie.classList.remove("hidden"),ie.classList.add("flex"),Re=[],Xt(),xt&&xt.classList.add("hidden"),wt&&(wt.innerHTML=""),ue&&(ue.disabled=!0))},ws=()=>{ie&&(ie.classList.add("hidden"),ie.classList.remove("flex"),Re=[])},Xt=()=>{if(!(!Xe||!nt)){if(Re.length===0){Xe.classList.add("hidden"),ue&&(ue.disabled=!0);return}Xe.classList.remove("hidden"),nt.innerHTML=Re.map(e=>`<li class="flex items-center gap-2"><span class="text-lg">\u{1F4C4}</span>${e.name}</li>`).join(""),ue&&(ue.disabled=!1)}},Ss=e=>{let t=Array.from(e).filter(s=>s.type==="application/json"||s.name.endsWith(".json"));if(t.length===0){D("Aucun fichier JSON valide.");return}Re=t,Xt()},yn=async()=>{if(!(!Ie||Re.length===0)){ue&&(ue.disabled=!0,ue.textContent="Import...");try{let e=[];for(let n of Re){let p=await n.text();try{let E=JSON.parse(p);Array.isArray(E)?e.push(...E):e.push(E)}catch(E){D(`Erreur JSON dans ${n.name}`),console.error("[import] parse error",n.name,E)}}if(e.length===0){D("Aucune page valide \xE0 importer.");return}let t=await fetch(`${Ie}/import`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(e)}),s=await t.json();if(!t.ok)throw new Error(s.message||"Erreur serveur");if(xt&&wt){xt.classList.remove("hidden");let n="";s.imported&&s.imported.length>0&&(n+=`<p class="text-green-700">\u2713 ${s.imported.length} page(s) import\xE9e(s)</p>`,n+='<ul class="ml-4 text-xs text-slate-600">',s.imported.forEach(p=>{n+=`<li>${p.title} (${p.action==="updated"?"mise \xE0 jour":"cr\xE9\xE9e"})</li>`}),n+="</ul>"),s.errors&&s.errors.length>0&&(n+=`<p class="text-rose-600 mt-2">\u2717 ${s.errors.length} erreur(s)</p>`,n+='<ul class="ml-4 text-xs text-rose-500">',s.errors.forEach(p=>{n+=`<li>${p.title}: ${p.error}</li>`}),n+="</ul>"),wt.innerHTML=n}s.imported&&s.imported.length>0&&(ae=await oe(),Ct(ae,be),ae.length>0&&!be&&Pe(ae[0].id),D(`${s.imported.length} page(s) import\xE9e(s)`)),Re=[],Xt()}catch(e){console.error("[import] failed",e),D(e.message||"Erreur import")}finally{ue&&(ue.disabled=!1,ue.textContent="Importer")}}};He==null||He.addEventListener("click",hn),Oe.forEach(e=>e.addEventListener("click",ws)),ie==null||ie.addEventListener("click",e=>{e.target===ie&&ws()}),Ke==null||Ke.addEventListener("change",e=>{Ss(e.target.files)}),de==null||de.addEventListener("dragover",e=>{e.preventDefault(),de.classList.add("border-[#9C6BFF]","bg-[#9C6BFF]/10")}),de==null||de.addEventListener("dragleave",e=>{e.preventDefault(),de.classList.remove("border-[#9C6BFF]","bg-[#9C6BFF]/10")}),de==null||de.addEventListener("drop",e=>{e.preventDefault(),de.classList.remove("border-[#9C6BFF]","bg-[#9C6BFF]/10"),Ss(e.dataTransfer.files)}),ue==null||ue.addEventListener("click",yn),us.forEach(e=>{e.addEventListener("click",()=>{let t=e.dataset.importTab;us.forEach(s=>{s.dataset.importTab===t?(s.classList.add("bg-[#9C6BFF]","text-white"),s.classList.remove("border","border-slate-200","text-slate-700")):(s.classList.remove("bg-[#9C6BFF]","text-white"),s.classList.add("border","border-slate-200","text-slate-700"))}),_s.forEach(s=>{s.dataset.importPanel===t?s.classList.remove("hidden"):s.classList.add("hidden")})})}),Ut==null||Ut.addEventListener("click",async()=>{if(!ms)return;let e=ms.textContent||"";try{await navigator.clipboard.writeText(e),D("Template copi\xE9 !")}catch(t){console.error("[import] copy failed",t),D("Erreur copie")}}),J==null||J.addEventListener("click",e=>{e.stopPropagation(),an()}),document.addEventListener("click",e=>{it&&(te!=null&&te.contains(e.target)||J!=null&&J.contains(e.target)||qt())}),Y.forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();let s=e.dataset.blockAdd;ln(s)})}),H==null||H.addEventListener("click",()=>{Jt()}),W==null||W.addEventListener("click",()=>{At&&vs(At),Jt()}),U==null||U.addEventListener("click",e=>{e.target===U&&Jt()}),c==null||c.addEventListener("input",e=>{var s,n;let t=e.target;if(!(!t||!t.name)&&(t.name==="group-columns-mobile"||t.name==="group-columns-desktop")){let p=((s=c.querySelector('[name="group-columns-mobile"]'))==null?void 0:s.value)||"1",E=((n=c.querySelector('[name="group-columns-desktop"]'))==null?void 0:n.value)||"3";Se(p,E)}}),O==null||O.addEventListener("change",e=>{let t=e.target;Kt((t==null?void 0:t.value)||"")}),c==null||c.addEventListener("submit",b),fe==null||fe.addEventListener("click",e=>{e.preventDefault();let t=Vt();t&&We(t)}),B==null||B.addEventListener("load",()=>{Yt=!0,Le("\xC0 jour"),ot(me)}),S==null||S.addEventListener("click",()=>{let e=window.open("","_blank");if(!e)return;e.opener=null;let t=e.document;t.open(),t.write(_t||Ne()),t.close()});let Ls=e=>{var t,s;k&&(e?(k.classList.remove("hidden"),I&&(A&&(A.value=((t=I.seo)==null?void 0:t.title)||""),h&&(h.value=((s=I.seo)==null?void 0:s.description)||""))):k.classList.add("hidden"))},Ft=(e,t="muted")=>{if(!u)return;let s=t==="success"?"text-emerald-600":t==="error"?"text-rose-600":"text-slate-500";u.textContent=e||"",u.className=`text-sm ${s}`};g==null||g.addEventListener("click",()=>{let e=k&&!k.classList.contains("hidden");Ls(!e)}),P==null||P.addEventListener("click",()=>Ls(!1)),L==null||L.addEventListener("submit",async e=>{if(e.preventDefault(),!I){Ft("Aucune page active.","error");return}x&&(x.disabled=!0),Ft("");try{let t={title:((A==null?void 0:A.value)||"").trim(),description:((h==null?void 0:h.value)||"").trim()},s={...I,seo:t},n=await re(s);n&&(I=n,Ft("SEO enregistr\xE9.","success"),D("SEO mis \xE0 jour"),i(I))}catch(t){console.error("[seo] save failed",t),Ft(t.message||"Erreur lors de la sauvegarde.","error")}finally{x&&(x.disabled=!1)}});let vn=e=>{let t=e.target.closest("[data-block-item]");!t||!Et()||(Me=t.dataset.blockId||null,Me&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",Me),t.classList.add("opacity-50")))},Cs=()=>{f==null||f.querySelectorAll("[data-block-item]").forEach(e=>e.classList.remove("opacity-50","ring-2","ring-[#9C6BFF]/50"))},bn=()=>{Me=null,Cs()},xn=e=>{if(!Me||!Et())return;let t=e.target.closest("[data-block-item]");!t||t.dataset.blockId===Me||(e.preventDefault(),t.classList.add("ring-2","ring-[#9C6BFF]/50"))},wn=e=>{let t=e.target.closest("[data-block-item]");t&&t.classList.remove("ring-2","ring-[#9C6BFF]/50")},Sn=e=>{if(!Me||!Et())return;e.preventDefault();let t=e.target.closest("[data-block-item]"),s=Me;Me=null,Cs();let n=(t==null?void 0:t.dataset.blockId)||null;n&&on(s,n)},Me=null;f==null||f.addEventListener("dragstart",vn),f==null||f.addEventListener("dragend",bn),f==null||f.addEventListener("dragover",xn),f==null||f.addEventListener("dragleave",wn),f==null||f.addEventListener("drop",Sn),ve()}function Vs(){var Ye,Ae,ge;let r=document.querySelector("[data-collection-list]");if(!r)return;let d=document.querySelector("[data-collection-empty]"),y=document.querySelector("[data-collection-items-empty]"),C=document.querySelector("[data-item-table-wrapper]"),B=document.querySelector("[data-item-table-body]"),S=document.querySelector("[data-collection-title]"),z=document.querySelector("[data-collection-description]"),q=document.querySelector("[data-collection-drawer]"),g=document.querySelector("[data-collection-drawer-backdrop]"),k=document.querySelectorAll("[data-collection-drawer-open]"),P=document.querySelectorAll("[data-collection-drawer-close]"),L=document.querySelector("[data-item-add]"),A=document.querySelector("[data-item-detail-empty]"),h=document.querySelector("[data-item-form]"),u=h?{title:h.querySelector('[name="item-title"]'),slug:h.querySelector('[name="item-slug"]'),excerpt:h.querySelector('[name="item-excerpt"]'),content:h.querySelector('[name="item-content"]'),image:h.querySelector('[name="item-image"]'),status:h.querySelector('[name="item-status"]')}:{},x=document.querySelector("[data-item-status-badge]"),f=document.querySelector("[data-item-delete]"),M=document.querySelector("[data-item-delete-modal]"),ne=document.querySelector("[data-item-delete-cancel]"),J=document.querySelector("[data-item-delete-confirm]"),te=document.querySelector("[data-item-cancel]"),Y=document.querySelector("[data-item-save]"),U="rounded-full px-3 py-1 text-xs font-semibold",W=ke((V==null?void 0:V.slugValue)||_.slug||""),H=W?`/api/sites/${encodeURIComponent(W)}/collections`:null,j=[],v=[],w=null,N=null,l=!1,a=!1,c=null,K=()=>{q&&(q.classList.add("is-open"),q.style.transform="translateX(0)",g==null||g.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},O=()=>{q&&(q.classList.remove("is-open"),q.style.transform="",g==null||g.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))};k.forEach(o=>{o.addEventListener("click",K)}),P.forEach(o=>{o.addEventListener("click",O)}),g==null||g.addEventListener("click",O);let Z=o=>{let m=(o||"").trim();if(!m)return"";if(m==="/")return"/";let $=m.replace(/^\//,"").split("/").map(ee=>tt(ee||"")).filter(ee=>ee.length>0);return $.length?`/${$.join("/")}`:""},fe=o=>{if(!o)return"\u2014";let m=new Date(o);return Number.isNaN(m.getTime())?"\u2014":m.toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"})},se=()=>{let o=j.find(m=>m.id===w);S&&(S.textContent=(o==null?void 0:o.name)||"S\xE9lectionnez une collection"),z&&(z.textContent=(o==null?void 0:o.description)||"")},Q=o=>{y&&(y.textContent=o||(w?"Aucun item dans cette collection pour le moment.":"Choisissez une collection dans le panneau de gauche."))},ye=()=>{h&&(h.classList.add("hidden"),h.dataset.itemId=""),A==null||A.classList.remove("hidden"),x&&(x.className=`hidden ${U}`,x.textContent=""),f&&(f.disabled=!0)},we=()=>{h&&(h.classList.remove("hidden"),A==null||A.classList.add("hidden"))},Se=()=>{L&&(L.disabled=!w,L.disabled?L.classList.add("opacity-60","pointer-events-none"):L.classList.remove("opacity-60","pointer-events-none"))},oe=o=>{if(!x)return;if(!o){x.className=`hidden ${U}`,x.textContent="";return}let m=o.toLowerCase(),T="bg-slate-100 text-slate-600 border border-slate-200";m==="publi\xE9"||m==="publie"?T="bg-emerald-50 text-emerald-700 border border-emerald-100":m==="brouillon"&&(T="bg-amber-50 text-amber-700 border border-amber-100"),x.className=`${U} ${T}`,x.textContent=o},$e=()=>{if(r.innerHTML="",!j.length){d==null||d.classList.remove("hidden");return}d==null||d.classList.add("hidden"),j.forEach(o=>{let m=o.id===w,T=document.createElement("button");T.type="button",T.dataset.collectionId=o.id,T.className=["w-full rounded-xl border px-3 py-2 text-left transition focus:outline-none focus:ring-2 focus:ring-[#9C6BFF]/40",m?"bg-[#F7F0FF] border-[#9C6BFF]/40 text-slate-900":"border-slate-200 text-slate-700 hover:border-[#9C6BFF]/40"].join(" "),T.setAttribute("role","option"),m?T.setAttribute("aria-current","true"):T.removeAttribute("aria-current"),T.innerHTML=`
          <div class="flex items-center justify-between gap-2">
            <div>
              <p class="text-sm font-semibold">${o.name||o.id}</p>
              <p class="text-xs text-slate-500">${o.description||""}</p>
            </div>
            <span class="text-[11px] uppercase tracking-wide text-slate-400">${o.type||""}</span>
          </div>
        `,T.addEventListener("click",()=>{_e(o.id),window.matchMedia("(min-width: 1024px)").matches||O()}),r.appendChild(T)})},re=()=>{if(B){if(B.innerHTML="",!v.length||!w){y==null||y.classList.remove("hidden"),Q(),C==null||C.classList.add("hidden");return}y==null||y.classList.add("hidden"),C==null||C.classList.remove("hidden"),v.forEach(o=>{let m=document.createElement("tr");m.dataset.itemId=o.id;let T=o.id===N&&!l;m.className=["cursor-pointer transition focus-within:bg-[#F7F0FF]/70 focus:outline-none",T?"bg-[#F7F0FF]/70":"hover:bg-slate-50"].join(" "),m.tabIndex=0,m.setAttribute("role","button"),T?m.setAttribute("aria-current","true"):m.removeAttribute("aria-current");let $=o.status||"Brouillon",ee=$.toLowerCase(),He=ee==="publi\xE9"||ee==="publie"?"bg-emerald-50 text-emerald-700 border border-emerald-100":"bg-amber-50 text-amber-700 border border-amber-100";m.innerHTML=`
          <td class="px-4 py-3 align-top">
            <div class="flex flex-col">
              <span class="text-sm font-semibold text-slate-900">${o.title||"Sans titre"}</span>
              <span class="text-xs text-slate-500">${o.summary||o.excerpt||""}</span>
            </div>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-600">${o.slug||""}</td>
          <td class="px-4 py-3 align-top">
            <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${He}">
              ${$}
            </span>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-500">${fe(o.updatedAt||o.createdAt)}</td>
        `;let ie=()=>{ve(o.id)};m.addEventListener("click",ie),m.addEventListener("keydown",Oe=>{(Oe.key==="Enter"||Oe.key===" ")&&(Oe.preventDefault(),ie())}),B.appendChild(m)})}},ve=o=>{let m=v.find(T=>T.id===o);m&&(N=m.id,l=!1,a=!0,je(m),re())},je=o=>{if(!h||!o){ye();return}we(),h.dataset.itemId=o.id,u.title&&(u.title.value=o.title||""),u.slug&&(u.slug.value=o.slug||""),u.excerpt&&(u.excerpt.value=o.summary||o.excerpt||""),u.content&&(u.content.value=o.content||""),u.image&&(u.image.value=o.image||""),u.status&&(u.status.value=o.status||"Brouillon"),oe(o.status||"Brouillon"),f&&(f.disabled=!1)},Je=()=>{var o;h&&(l=!0,N=null,a=!1,h.dataset.itemId="",h.reset(),u.status&&(u.status.value="Brouillon"),u.slug&&(u.slug.value=""),oe("Brouillon"),we(),f&&(f.disabled=!0),(o=u.title)==null||o.focus())},We=()=>{var ie,Oe,de,Ke,Xe,nt;let o=(((ie=u.title)==null?void 0:ie.value)||"").trim(),m=(((Oe=u.slug)==null?void 0:Oe.value)||"").trim(),T=(((de=u.excerpt)==null?void 0:de.value)||"").trim(),$=(((Ke=u.content)==null?void 0:Ke.value)||"").trim(),ee=(((Xe=u.image)==null?void 0:Xe.value)||"").trim(),He=((nt=u.status)==null?void 0:nt.value)||"Brouillon";return{title:o,slug:Z(m||o),summary:T,excerpt:T,content:$,image:ee,status:He}},Ge=o=>{Y&&(Y.disabled=o,Y.textContent=o?"Enregistrement\u2026":"Enregistrer"),f&&!l&&N&&(f.disabled=o)},Le=async o=>{if(!H)return[];let m=await fetch(`${H}/${encodeURIComponent(o)}/items`,{headers:{Accept:"application/json"}});if(!m.ok){let $=await m.json().catch(()=>({}));throw new Error($.message||"Impossible de charger les items.")}let T=await m.json().catch(()=>({}));return Array.isArray(T.items)?T.items:[]},_e=async o=>{if(o&&(w=o,N=null,l=!1,a=!1,se(),Se(),$e(),ye(),v=[],re(),Q("Chargement des items\u2026"),y==null||y.classList.remove("hidden"),C==null||C.classList.add("hidden"),!!H))try{v=await Le(o),re(),v.length||Q()}catch(m){console.error("[content] items failed",m),D(m.message||"Impossible de charger les items."),v=[],re()}},Ne=async(o,m)=>{if(!H)throw new Error("Site inconnu.");let T=await fetch(`${H}/${encodeURIComponent(o)}/items`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)});if(!T.ok){let $=await T.json().catch(()=>({}));throw new Error($.message||"Impossible de cr\xE9er cet item.")}return T.json()},i=async(o,m,T)=>{if(!H)throw new Error("Site inconnu.");let $=await fetch(`${H}/${encodeURIComponent(o)}/items/${encodeURIComponent(m)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(T)});if(!$.ok){let ee=await $.json().catch(()=>({}));throw new Error(ee.message||"Impossible de sauvegarder cet item.")}return $.json()},b=async(o,m)=>{if(!H)throw new Error("Site inconnu.");let T=await fetch(`${H}/${encodeURIComponent(o)}/items/${encodeURIComponent(m)}`,{method:"DELETE"});if(!T.ok){let $=await T.json().catch(()=>({}));throw new Error($.message||"Impossible de supprimer cet item.")}},R=async()=>{var o;if(!H){d==null||d.classList.remove("hidden"),w=null,v=[],re(),se(),Se();return}try{let m=await fetch(H,{headers:{Accept:"application/json"}});if(!m.ok)throw new Error("Impossible de charger les collections.");let T=await m.json().catch(()=>[]);if(j=Array.isArray(T)?T:[],$e(),j.length>0){let $=((o=j.find(ee=>ee.id===w))==null?void 0:o.id)||j[0].id;_e($)}else w=null,v=[],se(),Se(),re()}catch(m){console.error("[content] load collections",m),D(m.message||"Impossible de charger les collections.")}};L==null||L.addEventListener("click",()=>{if(!w){D("S\xE9lectionnez d\u2019abord une collection.");return}Je(),re()}),te==null||te.addEventListener("click",o=>{if(o.preventDefault(),l){l=!1,N=null,ye(),re();return}if(N){let m=v.find(T=>T.id===N);je(m)}else ye()}),(Ye=u.status)==null||Ye.addEventListener("change",()=>{oe(u.status.value)}),(Ae=u.title)==null||Ae.addEventListener("input",()=>{!l||!u.slug||a||(u.slug.value=Z(u.title.value))}),(ge=u.slug)==null||ge.addEventListener("input",()=>{l&&(a=!0)}),h==null||h.addEventListener("submit",async o=>{var T;if(o.preventDefault(),!w){D("S\xE9lectionnez une collection.");return}let m=We();if(!m.title){D("Le titre est requis."),(T=u.title)==null||T.focus();return}Ge(!0);try{let $;l||!N?($=await Ne(w,m),v=[...v,$],D("Item cr\xE9\xE9")):($=await i(w,N,m),v=v.map(ee=>ee.id===$.id?$:ee),D("Item mis \xE0 jour")),l=!1,N=$.id,je($),re()}catch($){console.error("[content] save item failed",$),D($.message||"Impossible de sauvegarder cet item.")}finally{Ge(!1)}});let F=()=>{M&&(M.classList.add("hidden"),M.classList.remove("flex"),c=null)},Ue=()=>{!M||!N||(c=N,M.classList.remove("hidden"),M.classList.add("flex"))};f==null||f.addEventListener("click",o=>{o.preventDefault(),N&&Ue()}),ne==null||ne.addEventListener("click",()=>{F()}),M==null||M.addEventListener("click",o=>{o.target===M&&F()}),J==null||J.addEventListener("click",async()=>{if(!c||!w){F();return}J.disabled=!0,J.textContent="Suppression\u2026";try{await b(w,c),v=v.filter(o=>o.id!==c),N===c&&(N=null,ye()),D("Item supprim\xE9"),re()}catch(o){console.error("[content] delete item failed",o),D(o.message||"Impossible de supprimer cet item.")}finally{J.disabled=!1,J.textContent="Supprimer",F()}}),se(),Se(),R()}function Js(){let r=document.querySelector("[data-deploy-form]");if(!r)return;let d=document.querySelector("[data-deploy-protocol]"),y=document.querySelector("[data-deploy-host]"),C=document.querySelector("[data-deploy-port]"),B=document.querySelector("[data-deploy-user]"),S=document.querySelector("[data-deploy-password]"),z=document.querySelector("[data-deploy-show-password]"),q=document.querySelector("[data-deploy-remote-path]"),g=document.querySelector("[data-deploy-feedback]"),k=document.querySelector("[data-deploy-save]"),P=document.querySelector("[data-deploy-test]"),L=document.querySelector("[data-deploy-trigger]"),A=document.querySelector("[data-deploy-history]"),h=document.querySelector("[data-deploy-log]"),u=ke((V==null?void 0:V.slugValue)||_.slug||""),x=u?`/api/sites/${encodeURIComponent(u)}/deploy-config`:null,f=u?`/api/sites/${encodeURIComponent(u)}/deploy`:null,M=u?`/api/sites/${encodeURIComponent(u)}/deploy-log`:null,ne=!1,J=null,te=l=>{let a=(l||"").trim();return a?a.startsWith("/")?a:`/${a}`:"/www"},Y=(l,a="muted")=>{if(!g)return;let c="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold",K=a==="success"?"bg-emerald-50 text-emerald-700 border border-emerald-100":a==="error"?"bg-rose-50 text-rose-700 border border-rose-100":"bg-slate-50 text-slate-600 border border-slate-100";if(!l){g.textContent="",g.className="text-sm text-slate-500";return}let O=a==="success"?"\u2705":a==="error"?"\u274C":"\u2139\uFE0F";g.innerHTML=`<span class="${c} ${K}">${O}<span>${l}</span></span>`,g.className="text-sm"},U=(l=null)=>{J=l;let a=!!l,c='<svg class="h-4 w-4 animate-spin text-white" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>';k&&(k.disabled=a,k.innerHTML=l==="save"?`<span class="inline-flex items-center gap-2">${c}<span>Enregistrement\u2026</span></span>`:"Enregistrer"),P&&(P.disabled=a,P.innerHTML=l==="test"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-slate-200 border-t-slate-600"></span><span>Test en cours\u2026</span></span>':"Tester la connexion"),L&&(L.disabled=a&&l!==null,L.innerHTML=l==="deploy"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-white/60 border-t-white"></span><span>D\xE9ploiement\u2026</span></span>':"D\xE9ployer maintenant")},W=l=>{d&&(d.value=l.protocol||"sftp"),y&&(y.value=l.host||""),C&&(C.value=l.port||""),B&&(B.value=l.user||""),q&&(q.value=l.remotePath||"/www"),ne=!!l.hasPassword,S&&(S.value="",S.placeholder=ne?"Non affich\xE9":"Mot de passe")},H=(l=[])=>{if(A){if(A.innerHTML="",!l.length){let a=document.createElement("li");a.className="text-slate-500",a.textContent="Aucun d\xE9ploiement pour le moment.",A.appendChild(a);return}l.forEach(a=>{let c=document.createElement("li");c.className="flex items-center justify-between gap-2 rounded-xl border border-slate-200 px-3 py-2";let K=a.status==="success"?'<span class="rounded-full bg-emerald-50 px-2 py-0.5 text-[11px] font-semibold text-emerald-700">Succ\xE8s</span>':'<span class="rounded-full bg-rose-50 px-2 py-0.5 text-[11px] font-semibold text-rose-700">\xC9chec</span>',O=a.finishedAt||a.startedAt||"",Z=a.durationMs&&Number(a.durationMs)>=0?`${Math.round(Number(a.durationMs)/1e3)}s`:"";c.innerHTML=`
          <div class="space-y-1">
            <div class="flex items-center gap-2">${K}<span class="text-xs text-slate-500">${O}</span></div>
            <p class="text-sm text-slate-800">${a.message||""}</p>
          </div>
          <div class="text-xs text-slate-500">${Z}</div>
        `,c.dataset.deployId=a.id||"",c.addEventListener("click",()=>{a.logs&&h&&(h.textContent=a.logs.join(`
`))}),A.appendChild(c)})}},j=(l=[])=>{h&&(h.textContent=l.length?l.join(`
`):"Aucun log pour le moment.")},v=async()=>{var l;if(M)try{let a=await fetch(M,{headers:{Accept:"application/json"}});if(!a.ok){if(a.status===404){H([]),j(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw new Error("Impossible de charger l\u2019historique.")}let c=await a.json().catch(()=>({})),K=Array.isArray(c.entries)?c.entries:[];H(K),(l=K[0])!=null&&l.logs&&j(K[0].logs)}catch(a){console.error("[deploy] history failed",a)}},w=async()=>{if(!x){Y("Aucun site actif s\xE9lectionn\xE9.","error");return}U("load");try{let l=await fetch(x,{headers:{Accept:"application/json"}}),a=await l.json().catch(()=>({}));l.ok?(W(a||{}),Y("Configuration charg\xE9e.","muted")):(W(a||{}),Y(a.message||"Configuration par d\xE9faut charg\xE9e.","muted"))}catch(l){console.error("[deploy] load failed",l),Y(l.message||"Erreur lors du chargement.","error")}finally{U(null)}},N=()=>{let l={protocol:(d==null?void 0:d.value)||"sftp",host:(y==null?void 0:y.value.trim())||"",port:Number(C==null?void 0:C.value)||void 0,user:(B==null?void 0:B.value.trim())||"",remotePath:te((q==null?void 0:q.value)||"/www")},a=(S==null?void 0:S.value)||"";return a.trim().length>0&&(l.password=a),l};r.addEventListener("submit",async l=>{if(l.preventDefault(),!x){Y("Aucun site actif s\xE9lectionn\xE9.","error");return}let a=N();U("save");try{let c=await fetch(x,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!c.ok){let O=await c.json().catch(()=>({}));throw new Error(O.message||"Sauvegarde impossible.")}let K=await c.json();W(K||{}),Y("Configuration enregistr\xE9e.","success"),D("Configuration d\xE9ploiement sauvegard\xE9e")}catch(c){console.error("[deploy] save failed",c),Y(c.message||"Erreur lors de la sauvegarde.","error")}finally{U(null)}}),P==null||P.addEventListener("click",async()=>{if(!x){Y("Aucun site actif s\xE9lectionn\xE9.","error");return}let l=N();if(!l.host||!l.user||!l.remotePath){Y("Remplissez les champs requis avant de tester.","error");return}U("test");try{let a=await fetch(`${x}/test`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}),c=await a.json().catch(()=>({}));if(!a.ok||c.success===!1){Y(c.message||"Test de connexion \xE9chou\xE9.","error");return}Y(c.message||"Connexion OK.","success"),D("Test de connexion r\xE9ussi")}catch(a){console.error("[deploy] test failed",a),Y(a.message||"Test de connexion \xE9chou\xE9.","error")}finally{U(null)}}),L==null||L.addEventListener("click",async()=>{if(!f){Y("Aucun site actif s\xE9lectionn\xE9.","error");return}U("deploy"),j(["D\xE9ploiement en cours\u2026"]);try{let l=await fetch(f,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(N())}),a=await l.json().catch(()=>({}));if(!l.ok){if(l.status===404){Y("API d\xE9ploiement indisponible (red\xE9marre le serveur).","error"),j(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw j(a.logs||[]),new Error(a.message||"D\xE9ploiement \xE9chou\xE9.")}j(a.logs||[]),await v(),D("D\xE9ploiement termin\xE9")}catch(l){console.error("[deploy] run failed",l),Y(l.message||"D\xE9ploiement \xE9chou\xE9.","error")}finally{U(null)}}),z==null||z.addEventListener("change",()=>{S&&(S.type=z.checked?"text":"password")}),w(),v()}function Ws(){let r=document.querySelectorAll("[data-settings-tab]"),d=document.querySelectorAll("[data-settings-panel]"),y=document.querySelector("[data-admin-password-form]"),C=document.querySelector("[data-site-config-form]"),B=document.querySelector("[data-site-config-feedback]"),S=document.querySelector("[data-theme-form]"),z=q=>{r.forEach(g=>{let k=g.dataset.settingsTab===q;g.setAttribute("aria-selected",k?"true":"false"),g.classList.toggle("bg-[#9C6BFF]",k),g.classList.toggle("text-white",k)}),d.forEach(g=>{g.classList.toggle("hidden",g.dataset.settingsPanel!==q)})};if(r.forEach(q=>{q.addEventListener("click",()=>z(q.dataset.settingsTab||"account"))}),z("account"),y){let q=y.querySelector("[data-admin-password-feedback]"),g=y.querySelector("[data-admin-password-submit]"),k=(P,L="muted")=>{if(!q)return;let A=L==="success"?"text-emerald-600":L==="error"?"text-rose-600":"text-slate-500";q.textContent=P||"",q.className=`text-sm ${A}`};y.addEventListener("submit",async P=>{P.preventDefault();let L=new FormData(y),A=L.get("currentPassword")||"",h=L.get("newPassword")||"",u=L.get("confirmPassword")||"";if(!A||!h||!u){k("Compl\xE8te tous les champs.","error");return}g&&(g.disabled=!0),k("");try{let x=await fetch("/api/admin/password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({currentPassword:A,newPassword:h,confirmPassword:u})}),f=await x.json().catch(()=>({}));if(!x.ok||f.success===!1)throw new Error(f.message||"Impossible de mettre \xE0 jour le mot de passe.");k(f.message||"Mot de passe mis \xE0 jour.","success"),y.reset()}catch(x){console.error("[settings] change password failed",x),k(x.message||"Erreur lors de la mise \xE0 jour.","error")}finally{g&&(g.disabled=!1)}})}if(C){let q=C.querySelector("[data-site-name]"),g=C.querySelector("[data-site-language]"),k=C.querySelector("[data-site-tagline]"),P=C.querySelector("[data-site-save]"),L=(x,f="muted")=>{if(!B)return;let M=f==="success"?"text-emerald-600":f==="error"?"text-rose-600":"text-slate-500";B.textContent=x||"",B.className=`text-sm ${M}`},A=ke((V==null?void 0:V.slugValue)||_.slug||""),h=A?`/api/sites/${encodeURIComponent(A)}/config/site`:null,u=async()=>{if(h)try{let x=await fetch(h,{headers:{Accept:"application/json"}});if(!x.ok)return;let f=await x.json().catch(()=>({}));q&&(q.value=f.name||""),g&&(g.value=f.language||"fr"),k&&(k.value=f.tagline||"")}catch(x){console.error("[settings] load site config failed",x)}};C.addEventListener("submit",async x=>{if(x.preventDefault(),!h){L("Aucun site actif.","error");return}if(!(q!=null&&q.value.trim())){L("Nom requis.","error");return}P&&(P.disabled=!0),L("");try{let f={name:(q==null?void 0:q.value)||"",language:(g==null?void 0:g.value)||"fr",tagline:(k==null?void 0:k.value)||""},M=await fetch(h,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)}),ne=await M.json().catch(()=>({}));if(!M.ok||ne.success===!1)throw new Error(ne.message||"Sauvegarde impossible.");L(ne.message||"Param\xE8tres enregistr\xE9s.","success")}catch(f){console.error("[settings] save site config failed",f),L(f.message||"Erreur lors de la sauvegarde.","error")}finally{P&&(P.disabled=!1)}}),u()}if(S){let q=ke((V==null?void 0:V.slugValue)||_.slug||""),g=q?`/api/sites/${encodeURIComponent(q)}/config/theme`:null,k={primary:S.querySelector("[data-theme-primary]"),secondary:S.querySelector("[data-theme-secondary]"),accent:S.querySelector("[data-theme-accent]"),background:S.querySelector("[data-theme-background]"),text:S.querySelector("[data-theme-text]")},P=S.querySelector("[data-theme-headings]"),L=S.querySelector("[data-theme-body]"),A=S.querySelector("[data-theme-radius-small]"),h=S.querySelector("[data-theme-radius-medium]"),u=S.querySelector("[data-theme-radius-large]"),x=S.querySelector("[data-theme-preview]"),f=S.querySelector("[data-theme-feedback]"),M=S.querySelector("[data-theme-apply]"),ne=["slate","gray","zinc","neutral","stone","red","orange","amber","yellow","lime","green","emerald","teal","cyan","sky","blue","indigo","violet","purple","fuchsia","pink","rose"],J=["50","100","200","300","400","500","600","700","800","900"],te=ne.flatMap(v=>J.map(w=>`${v}-${w}`)),Y=()=>{Object.values(k).forEach(v=>{!v||v.options.length||te.forEach(w=>{let N=document.createElement("option");N.value=w;let[l,a]=w.split("-");N.textContent=`${l.charAt(0).toUpperCase()+l.slice(1)} ${a}`,v.appendChild(N)})})},U=(v,w="muted")=>{if(!f)return;let N=w==="success"?"text-emerald-600":w==="error"?"text-rose-600":"text-slate-500";f.textContent=v||"",f.className=`text-sm ${N}`},W=()=>{var w,N,l,a,c;if(!x)return;let v=K=>{if(!K)return null;let[O,Z]=K.split("-"),se={slate:"#e2e8f0",gray:"#d1d5db",zinc:"#d4d4d8",neutral:"#d4d4d4",stone:"#d6d3d1",red:"#ef4444",orange:"#f97316",amber:"#f59e0b",yellow:"#eab308",lime:"#84cc16",green:"#22c55e",emerald:"#10b981",teal:"#14b8a6",cyan:"#06b6d4",sky:"#0ea5e9",blue:"#3b82f6",indigo:"#6366f1",violet:"#8b5cf6",purple:"#a855f7",fuchsia:"#d946ef",pink:"#ec4899",rose:"#f43f5e"}[O];if(!se)return null;let Q=Number(Z)||500,ye=Math.min(Math.max((Q-50)/900,0),1),we=ve=>ve.match(/[A-Fa-f0-9]{2}/g).map(je=>parseInt(je,16)),[Se,oe,$e]=we(se.replace("#","")),re=ve=>Math.round(255-(255-ve)*ye);return`rgb(${re(Se)}, ${re(oe)}, ${re($e)})`};x.style.setProperty("--color-primary",v((w=k.primary)==null?void 0:w.value)||"#9C6BFF"),x.style.setProperty("--color-secondary",v((N=k.secondary)==null?void 0:N.value)||"#0EA5E9"),x.style.setProperty("--color-accent",v((l=k.accent)==null?void 0:l.value)||"#F97316"),x.style.setProperty("--color-background",v((a=k.background)==null?void 0:a.value)||"#FFFFFF"),x.style.setProperty("--color-text",v((c=k.text)==null?void 0:c.value)||"#0F172A"),x.style.setProperty("--font-headings",(P==null?void 0:P.value)||"Inter, sans-serif"),x.style.setProperty("--font-body",(L==null?void 0:L.value)||"Inter, sans-serif"),x.style.setProperty("--radius-small",(A==null?void 0:A.value)||"8px"),x.style.setProperty("--radius-medium",(h==null?void 0:h.value)||"16px"),x.style.setProperty("--radius-large",(u==null?void 0:u.value)||"24px"),x.style.borderRadius=(h==null?void 0:h.value)||"16px"},H=(v,w)=>{k[v]&&(k[v].value=w)};Object.keys(k).forEach(v=>{var w;(w=k[v])==null||w.addEventListener("change",W)}),[P,L,A,h,u].forEach(v=>{v==null||v.addEventListener("change",W)});let j=async()=>{var v,w,N,l,a,c,K,O,Z,fe;if(g)try{let se=await fetch(g,{headers:{Accept:"application/json"}});if(!se.ok)return;let Q=await se.json().catch(()=>({}));H("primary",((v=Q.colors)==null?void 0:v.primary)||"violet-500"),H("secondary",((w=Q.colors)==null?void 0:w.secondary)||"indigo-400"),H("accent",((N=Q.colors)==null?void 0:N.accent)||"emerald-500"),H("background",((l=Q.colors)==null?void 0:l.background)||"slate-50"),H("text",((a=Q.colors)==null?void 0:a.text)||"slate-900"),P&&(P.value=((c=Q.typography)==null?void 0:c.headings)||"Inter, sans-serif"),L&&(L.value=((K=Q.typography)==null?void 0:K.body)||"Inter, sans-serif"),A&&(A.value=((O=Q.radius)==null?void 0:O.small)||"8px"),h&&(h.value=((Z=Q.radius)==null?void 0:Z.medium)||"16px"),u&&(u.value=((fe=Q.radius)==null?void 0:fe.large)||"24px"),W()}catch(se){console.error("[settings] load theme failed",se)}};Y(),M==null||M.addEventListener("click",async v=>{var N,l,a,c,K;if(v.preventDefault(),!g){U("Aucun site actif.","error");return}let w={colors:{primary:((N=k.primary)==null?void 0:N.value)||"violet-500",secondary:((l=k.secondary)==null?void 0:l.value)||"indigo-400",accent:((a=k.accent)==null?void 0:a.value)||"emerald-500",background:((c=k.background)==null?void 0:c.value)||"slate-50",text:((K=k.text)==null?void 0:K.value)||"slate-900"},typography:{headings:(P==null?void 0:P.value)||"Inter, sans-serif",body:(L==null?void 0:L.value)||"Inter, sans-serif"},radius:{small:(A==null?void 0:A.value)||"8px",medium:(h==null?void 0:h.value)||"16px",large:(u==null?void 0:u.value)||"24px"}};M.disabled=!0,U("");try{let O=await fetch(g,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(w)}),Z=await O.json().catch(()=>({}));if(!O.ok||Z.success===!1)throw new Error(Z.message||"Application du th\xE8me \xE9chou\xE9e.");U(Z.message||"Th\xE8me appliqu\xE9.","success"),W()}catch(O){console.error("[settings] apply theme failed",O),U(O.message||"Erreur lors de l\u2019application du th\xE8me.","error")}finally{M.disabled=!1}}),Y(),j(),W()}}function Gs(){let r=document.querySelector("[data-media-grid]");if(!r)return;let d=document.querySelector("[data-media-empty]"),y=document.querySelector("[data-media-count]"),C=document.querySelector("[data-media-filter-type]"),B=document.querySelector("[data-media-detail-empty]"),S=document.querySelector("[data-media-detail]"),z=document.querySelector("[data-media-detail-preview]"),q=document.querySelector("[data-media-detail-name]"),g=document.querySelector("[data-media-detail-type]"),k=document.querySelector("[data-media-detail-size]"),P=document.querySelector("[data-media-detail-path]"),L=document.querySelector("[data-media-detail-used]"),A=document.querySelector("[data-media-alt-edit]"),h=document.querySelector("[data-media-save]"),u=document.querySelector("[data-media-delete]"),x=document.querySelector("[data-media-delete-modal]"),f=document.querySelector("[data-media-delete-cancel]"),M=document.querySelector("[data-media-delete-confirm]"),ne=document.querySelector("[data-media-upload-open]"),J=document.querySelector("[data-media-file-input]"),te=document.querySelector("[data-media-upload-status]"),Y=ke((V==null?void 0:V.slugValue)||_.slug||""),U=Y?`/api/sites/${encodeURIComponent(Y)}/media`:null,W=[],H=[],j=null,v=null,w=null,N=!1,l=!1,a=!1,c=null,K=i=>{let b=(i.type||"").toLowerCase(),R=(i.filename||"").toLowerCase();return b.includes("image")||/\.(png|jpe?g|webp|svg|gif)$/i.test(R)?"image":b.includes("pdf")||b.includes("doc")||/\.(pdf|docx?)$/i.test(R)?"document":b.includes("video")||/\.(mp4|mov|webm)$/i.test(R)?"video":"other"},O=i=>K(i)==="image",Z=i=>{if(i.type)return i.type.toUpperCase();let b=(i.filename||"").split(".").pop();return b?b.toUpperCase():"FILE"},fe=i=>!i||i<=0?"\u2014":i<1024?`${i} o`:i<1024*1024?`${(i/1024).toFixed(1)} ko`:`${(i/(1024*1024)).toFixed(1)} Mo`,se=()=>{S==null||S.classList.add("hidden"),B==null||B.classList.remove("hidden"),Q(),j=null,l=!1,oe(!1),z&&(z.innerHTML='<span class="text-slate-400 text-sm">Aucun m\xE9dia s\xE9lectionn\xE9</span>'),q&&(q.textContent=""),g&&(g.textContent=""),k&&(k.textContent=""),A&&(A.value=""),P&&(P.textContent=""),L&&(L.innerHTML="")},Q=()=>{w=null,a=!1,N=!1,c&&(URL.revokeObjectURL(c),c=null),te&&(te.textContent="Aucun fichier s\xE9lectionn\xE9."),J&&(J.value="")},ye=()=>{y&&(H.length?H.length===1?y.textContent="1 m\xE9dia":y.textContent=`${H.length} m\xE9dias`:y.textContent="0 m\xE9dia")},we=()=>{if(r.innerHTML="",!H.length){d==null||d.classList.remove("hidden"),se();return}d==null||d.classList.add("hidden"),H.forEach(i=>{let b=document.createElement("button");b.type="button",b.dataset.mediaId=i.id;let R=i.id===j;b.className=["group relative flex flex-col rounded-2xl border px-3 py-3 text-left transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#9C6BFF]",R?"border-[#9C6BFF] bg-[#F7F0FF]/60 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let F=O(i)?`<img src="${i.path}" alt="${i.alt||i.filename}" class="h-full w-full object-cover" />`:'<div class="flex h-full w-full items-center justify-center text-3xl text-slate-400">\u{1F4C4}</div>';b.innerHTML=`
          <div class="relative aspect-[4/3] overflow-hidden rounded-xl bg-slate-100">
            ${F}
          </div>
          <div class="mt-2 space-y-1">
            <p class="text-sm font-semibold text-slate-900 truncate">${i.filename}</p>
            <p class="text-xs text-slate-500">
              ${Z(i)} \xB7 ${fe(i.size)}
            </p>
          </div>
        `,i.id===v&&(b.classList.add("ring-2","ring-[#9C6BFF]"),window.setTimeout(()=>{b.classList.remove("ring-2","ring-[#9C6BFF]")},1600)),b.addEventListener("click",()=>$e(i.id)),r.appendChild(b)}),v=null},Se=i=>{if(L){if(L.innerHTML="",!i.usedIn||i.usedIn.length===0){let b=document.createElement("li");b.textContent="Non utilis\xE9",b.className="text-xs text-slate-400",L.appendChild(b);return}i.usedIn.forEach(b=>{let R=document.createElement("li");R.textContent=b,R.className="text-xs text-slate-600",L.appendChild(R)})}},oe=i=>{if(h){if(a){h.textContent=i?"T\xE9l\xE9versement\u2026":"T\xE9l\xE9verser",h.disabled=i||!w,u&&u.classList.add("hidden");return}h.textContent=i?"Enregistrement\u2026":"Enregistrer",h.disabled=i||!l,u&&(u.classList.remove("hidden"),u.disabled=!j)}},$e=i=>{let b=W.find(R=>R.id===i);if(!b){se(),we();return}Q(),j=b.id,l=!1,oe(!1),we(),B==null||B.classList.add("hidden"),S==null||S.classList.remove("hidden"),z&&(O(b)?z.innerHTML=`<img src="${b.path}" alt="${b.alt||b.filename}" class="h-full w-full rounded-2xl object-cover" />`:z.innerHTML='<div class="flex h-full w-full flex-col items-center justify-center gap-1 text-slate-400"><span class="text-3xl">\u{1F4C4}</span><span class="text-xs font-semibold">Document</span></div>'),q&&(q.textContent=b.filename||"Fichier"),g&&(g.textContent=Z(b)),k&&(k.textContent=fe(b.size)),A&&(A.value=b.alt||""),P&&(P.textContent=b.path||"\u2014"),Se(b)},re=i=>{if(i){if(a=!0,l=!1,j=null,B==null||B.classList.add("hidden"),S==null||S.classList.remove("hidden"),c&&URL.revokeObjectURL(c),c=URL.createObjectURL(i),z&&(z.innerHTML=`<img src="${c}" alt="${i.name}" class="h-full w-full rounded-2xl object-cover" />`),q&&(q.textContent=i.name),g&&(g.textContent=Z({type:i.type,filename:i.name})),k&&(k.textContent=fe(i.size)),A&&!A.value.trim()&&(A.value=i.name.replace(/\.[^.]+$/,"").replace(/[-_]/g," ")),P&&(P.textContent="En attente de t\xE9l\xE9versement"),L){L.innerHTML="";let b=document.createElement("li");b.textContent="Non utilis\xE9",b.className="text-xs text-slate-400",L.appendChild(b)}oe(!1)}},ve=()=>{let i=(C==null?void 0:C.value)||"all";i==="all"?H=[...W]:H=W.filter(b=>b.groupType===i),H.some(b=>b.id===j)||se(),ye(),we()},je=async()=>{if(!U){d==null||d.classList.remove("hidden");return}try{let i=await fetch(U,{headers:{Accept:"application/json"}});if(!i.ok)throw new Error("Impossible de charger les m\xE9dias.");let b=await i.json().catch(()=>({items:[]}));W=Array.isArray(b.items)?b.items.map(R=>({...R,groupType:K(R)})):[],ve()}catch(i){console.error("[media] load failed",i),D(i.message||"Impossible de charger les m\xE9dias."),W=[],ve()}};C==null||C.addEventListener("change",()=>{ve()}),A==null||A.addEventListener("input",()=>{if(a){oe(!1);return}j&&(l=!0,oe(!1))});let Je=i=>{if(i){if(!i.type.startsWith("image/")){D("Seules les images sont accept\xE9es pour le moment.");return}if(i.size>4*1024*1024){D("Fichier trop volumineux (4 Mo max).");return}w=i,re(i),te&&(te.textContent=`${i.name} \xB7 ${fe(i.size)}`)}},We=i=>new Promise((b,R)=>{let F=new FileReader;F.onload=()=>{let Ue=F.result||"",[,Ye=""]=String(Ue).split(",");b(Ye)},F.onerror=()=>R(new Error("Impossible de lire ce fichier.")),F.readAsDataURL(i)}),Ge=async()=>{if(!(!w||!U)){N=!0,oe(!0);try{let i=await We(w),b={filename:w.name,type:w.type,size:w.size,alt:(A==null?void 0:A.value)||"",data:i},R=await fetch(U,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)});if(!R.ok){let Ue=await R.json().catch(()=>({}));throw new Error(Ue.message||"Upload impossible.")}let F=await R.json();F.groupType=K(F),W=[...W,F],v=F.id,ve(),$e(F.id),D("M\xE9dia ajout\xE9"),Q()}catch(i){console.error("[media] upload failed",i),D(i.message||"Impossible de t\xE9l\xE9verser ce m\xE9dia.")}finally{N=!1,w=null,oe(!1)}}};ne==null||ne.addEventListener("click",()=>J==null?void 0:J.click()),J==null||J.addEventListener("change",()=>{J.files&&J.files[0]&&Je(J.files[0])});let Le=()=>{x&&(x.classList.add("hidden"),x.classList.remove("flex"))},_e=()=>{if(!(!j||a)){if(x){x.classList.remove("hidden"),x.classList.add("flex");return}window.confirm("Supprimer ce m\xE9dia ?")&&Ne()}},Ne=async()=>{if(!j||!U){Le();return}let i=()=>{u&&(u.disabled=!0),M&&(M.disabled=!0,M.textContent="Suppression\u2026")},b=()=>{u&&(u.disabled=!1),M&&(M.disabled=!1,M.textContent="Supprimer")};i();try{let R=await fetch(`${U}/${encodeURIComponent(j)}`,{method:"DELETE"});if(!R.ok){let F=await R.json().catch(()=>({}));throw new Error(F.message||"Suppression impossible.")}W=W.filter(F=>F.id!==j),H=H.filter(F=>F.id!==j),D("M\xE9dia supprim\xE9"),se(),ye(),we()}catch(R){console.error("[media] delete failed",R),D(R.message||"Impossible de supprimer ce m\xE9dia.")}finally{b(),Le()}};f==null||f.addEventListener("click",Le),x==null||x.addEventListener("click",i=>{i.target===x&&Le()}),M==null||M.addEventListener("click",()=>Ne()),u==null||u.addEventListener("click",_e),h==null||h.addEventListener("click",async()=>{if(a){Ge();return}if(!(!j||!U||!A)){oe(!0);try{let i={alt:A.value||""},b=await fetch(`${U}/${encodeURIComponent(j)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!b.ok){let F=await b.json().catch(()=>({}));throw new Error(F.message||"Impossible de mettre \xE0 jour ce m\xE9dia.")}let R=await b.json();W=W.map(F=>F.id===j?{...F,...R}:F),H=H.map(F=>F.id===j?{...F,...R}:F),l=!1,oe(!1),D("M\xE9dia mis \xE0 jour")}catch(i){console.error("[media] update failed",i),D(i.message||"\xC9chec de la mise \xE0 jour."),oe(!1)}}}),je()}});})();
