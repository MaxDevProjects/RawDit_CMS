(()=>{document.addEventListener("DOMContentLoaded",()=>{console.log("[admin] Atelier charg\xE9");let Ce=document.querySelector("[data-logout]");Ce&&Ce.addEventListener("click",async()=>{Ce.disabled=!0;try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(s){console.error("[admin] Impossible de se d\xE9connecter",s)}finally{window.location.href="/admin/index.html"}});let G=document.querySelector("[data-admin-sidebar]"),y=document.querySelector("[data-admin-sidebar-overlay]"),_e=document.querySelectorAll("[data-admin-sidebar-toggle]"),vt=document.querySelectorAll("[data-admin-sidebar-close]"),Ee=document.body,se=!1,ne=()=>{if(!G)return;if(window.matchMedia("(min-width: 1024px)").matches){G.classList.remove("hidden"),y==null||y.classList.add("hidden"),Ee.classList.remove("overflow-hidden");return}se?(G.classList.remove("hidden"),y==null||y.classList.remove("hidden"),Ee.classList.add("overflow-hidden")):(G.classList.add("hidden"),y==null||y.classList.add("hidden"),Ee.classList.remove("overflow-hidden"))},ht=()=>{se=!0,ne()},Be=()=>{se=!1,ne()};G&&_e.length>0&&(_e.forEach(s=>{s.addEventListener("click",ht)}),vt.forEach(s=>{s.addEventListener("click",Be)}),y==null||y.addEventListener("click",Be),window.addEventListener("resize",ne),window.addEventListener("keydown",s=>{s.key==="Escape"&&se&&Be()}),ne());let Je="clower:currentSite",Ge="clower:currentSiteName",p={slug:null,name:""};(()=>{try{p.slug=window.localStorage.getItem(Je),p.name=window.localStorage.getItem(Ge)||""}catch{p.slug=null,p.name=""}})();let qe=document.querySelectorAll("[data-site-card]"),bt=document.querySelectorAll("[data-site-select]"),Y=document.querySelector("[data-current-site-name]"),Ye=document.querySelector("[data-workspace-site-name]"),Ze=document.querySelector("[data-workspace-back-name]"),j=document.querySelector("[data-workspace-back-modal]"),yt=document.querySelectorAll("[data-workspace-back]"),xt=document.querySelectorAll("[data-workspace-back-cancel]"),Ae=document.querySelector("[data-workspace-back-confirm]"),St=document.querySelectorAll("[data-workspace-tab]"),Te=document.querySelector("[data-site-toast]"),Qe=document.querySelector("[data-site-toast-message]"),wt=document.querySelectorAll("[data-site-create]"),f=document.querySelector("[data-site-modal]"),I=document.querySelector("[data-site-form]"),L=document.querySelector("[data-site-name]"),C=document.querySelector("[data-site-slug]"),v=document.querySelector("[data-site-slug-error]"),E=document.querySelector("[data-site-modal-error]"),Lt=document.querySelectorAll("[data-site-modal-cancel]"),U=document.querySelector("[data-site-modal-submit]"),B=Tt(),ae=!1,oe=null,De=null,kt='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',Xe=s=>{if(!f||f.classList.contains("hidden")||s.key!=="Tab")return;let o=Array.from(f.querySelectorAll(kt)).filter(k=>!k.hasAttribute("disabled")&&!k.getAttribute("aria-hidden"));if(o.length===0)return;let d=o[0],u=o[o.length-1];s.shiftKey?document.activeElement===d&&(s.preventDefault(),u.focus()):document.activeElement===u&&(s.preventDefault(),d.focus())},re=s=>{!Te||!Qe||(Qe.textContent=s,Te.classList.remove("hidden"),De&&clearTimeout(De),De=setTimeout(()=>{Te.classList.add("hidden")},2500))},P=s=>s?s.startsWith("/")?s:`/${s}`:"",ie=s=>(s==null?void 0:s.replace(/^\//,""))||"",le=(s,o)=>{let d=s?P(s):null;try{d&&(window.localStorage.setItem(Je,d),p.slug=d),typeof o=="string"&&o.length>0&&(window.localStorage.setItem(Ge,o),p.name=o)}catch{p.slug=d||p.slug,p.name=o||p.name}},et=s=>{Y&&s&&(Y.textContent=s),Ye&&s&&(Ye.textContent=s),Ze&&s&&(Ze.textContent=s)},Ne=s=>{St.forEach(o=>{let d=o.dataset.workspaceTab;if(!d)return;if(!s){o.href="#",o.classList.add("pointer-events-none","opacity-50","text-slate-400"),o.setAttribute("aria-disabled","true");return}let u=encodeURIComponent(ie(s));o.href=`/admin/site/${u}/${d}`,o.classList.remove("pointer-events-none","opacity-50","text-slate-400"),o.removeAttribute("aria-disabled")})},ce=(s,o={})=>{if(!s)return;let d=P(s),u=o.siteName||p.name||(Y==null?void 0:Y.dataset.defaultSiteName)||"";qe.forEach(m=>{let b=P(m.dataset.siteCard||"")===d,l=m.querySelector("[data-site-active-badge]");b?(m.classList.add("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),m.classList.remove("border-slate-200"),l==null||l.classList.remove("hidden"),u=m.dataset.siteName||u):(m.classList.remove("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),m.classList.add("border-slate-200"),l==null||l.classList.add("hidden"))}),o.persist!==!1&&le(d,o.siteName||u);let k=o.siteName||u;et(k),Ne(d)},Ct=async(s,o)=>{let d=P(s);try{let u=await fetch("/api/sites/select",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slug:d})});if(!u.ok){let l=await u.json().catch(()=>({}));re(l.message||"Impossible de s\xE9lectionner ce site.");return}let k=await u.json().catch(()=>({})),m=P(k.slug||d),h=k.name||o;le(m,h),ce(m,{siteName:h,persist:!1});let b=encodeURIComponent(ie(m));window.location.href=`/admin/site/${b}/design`}catch(u){console.error("[admin] Impossible de s\xE9lectionner le site",u),re("Erreur inattendue lors de la s\xE9lection.")}},Et=async()=>{try{let s=await fetch("/api/sites/current",{credentials:"same-origin"});if(!s.ok){s.status===404&&B&&(window.location.href="/admin/sites");return}let o=await s.json(),d=P(o.slug);le(d,o.name),ce(d,{siteName:o.name,persist:!1})}catch(s){console.warn("[admin] Impossible de r\xE9cup\xE9rer le site actif",s)}};(()=>{if(p.slug){ce(p.slug,{siteName:p.name,persist:!1});return}let s=document.querySelector('[data-site-card][data-site-default="true"]')||qe[0];s&&ce(s.dataset.siteCard,{siteName:s.dataset.siteName||"",persist:!1})})(),Et(),B?Ne(B.slugValue):p.slug&&Ne(p.slug),bt.forEach(s=>{s.addEventListener("click",()=>{if(s.disabled)return;let o=s.dataset.siteSelect,d=s.dataset.siteSelectName||"Ce site";o&&(s.disabled=!0,Ct(o,d).finally(()=>{s.disabled=!1}))})});let de=s=>s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),Bt=s=>{let o=de(s||"");return o?`/${o}`:""},qt=()=>{f&&(oe=document.activeElement,f.classList.remove("hidden"),f.classList.add("flex"),ae=!1,I==null||I.reset(),v&&(v.textContent=""),E&&(E.textContent=""),C&&L&&(C.value=de(L.value)),document.addEventListener("keydown",Xe),window.setTimeout(()=>{L==null||L.focus()},0))},ue=()=>{f&&(f.classList.add("hidden"),f.classList.remove("flex"),document.removeEventListener("keydown",Xe),ae=!1,I==null||I.reset(),v&&(v.textContent=""),E&&(E.textContent=""),oe==null||oe.focus())};wt.forEach(s=>{s.addEventListener("click",qt)}),Lt.forEach(s=>{s.addEventListener("click",ue)}),f==null||f.addEventListener("click",s=>{s.target===f&&ue()}),L==null||L.addEventListener("input",()=>{C&&(!ae||C.value.trim().length===0)&&(C.value=de(L.value))}),C==null||C.addEventListener("input",()=>{ae=!0,v&&(v.textContent="")});let At=()=>new Set(Array.from(qe).map(s=>P(s.dataset.siteCard||"")));I==null||I.addEventListener("submit",async s=>{if(s.preventDefault(),!L||!C)return;let o=(L.value||"").trim(),d=C.value||"";d||(d=o);let u=Bt(d);if(!o||!u){v&&(v.textContent="Nom et slug sont requis.");return}if(At().has(u)){v&&(v.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}v&&(v.textContent=""),E&&(E.textContent=""),U&&(U.disabled=!0,U.textContent="Cr\xE9ation...");try{let m=await fetch("/api/sites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:o,slug:u})});if(!m.ok){let Z=await m.json().catch(()=>({})),F=Z.message||"Impossible de cr\xE9er ce site.";E&&(E.textContent=F),Z.field==="slug"&&v&&(v.textContent=F);return}let h=await m.json(),b=P((h==null?void 0:h.slug)||u),l=(h==null?void 0:h.name)||o;le(b,l),ue();let H=encodeURIComponent(ie(b));window.location.href=`/admin/site/${H}/design`}catch(m){console.error("[admin] Impossible de cr\xE9er le site",m),E&&(E.textContent="Erreur inattendue. R\xE9essaie dans un instant.")}finally{U&&(U.disabled=!1,U.textContent="Cr\xE9er")}}),window.addEventListener("keydown",s=>{s.key==="Escape"&&(f&&!f.classList.contains("hidden")&&ue(),j&&!j.classList.contains("hidden")&&tt(),blockDeleteModal&&!blockDeleteModal.classList.contains("hidden")&&closeBlockDeleteModal(),blockLibraryOpen&&closeBlockLibrary())});function Tt(){let s=window.location.pathname.match(/^\/admin\/site\/([^/]+)(?:\/([^/]+))?/);return s?{slugPart:decodeURIComponent(s[1]),slugValue:P(decodeURIComponent(s[1])),section:s[2]||"design"}:null}function Dt(){if(!j){window.location.href="/admin/sites";return}j.classList.remove("hidden"),j.classList.add("flex")}function tt(){j&&(j.classList.add("hidden"),j.classList.remove("flex"))}yt.forEach(s=>{s.addEventListener("click",Dt)}),xt.forEach(s=>{s.addEventListener("click",tt)}),Ae==null||Ae.addEventListener("click",()=>{window.location.href="/admin/sites"}),(B==null?void 0:B.section)==="design"&&Nt(),B&&p.name&&et(p.name);function Nt(){let s=document.querySelectorAll("[data-page-list]");if(s.length===0)return;let o=document.querySelector("[data-active-page-title]"),d=document.querySelector("[data-active-page-slug]"),u=document.querySelector("[data-page-preview-title]"),k=document.querySelector("[data-page-preview-description]"),m=document.querySelector("[data-page-preview-tags]"),h=document.querySelector("[data-preview-blocks]"),b=document.querySelector("[data-preview-blocks-empty]"),l=document.querySelector("[data-blocks-list]"),H=document.querySelector("[data-blocks-empty]"),Z=document.querySelector("[data-block-count]"),F=document.querySelector("[data-block-library-toggle]"),O=document.querySelector("[data-block-library]"),It=document.querySelectorAll("[data-block-add]"),q=document.querySelector("[data-block-delete-modal]"),Ie=document.querySelector("[data-block-delete-confirm]"),Pe=document.querySelector("[data-block-delete-cancel]"),Fe=document.querySelector("[data-block-detail]"),Me=document.querySelector("[data-block-detail-empty]"),st=document.querySelector("[data-block-detail-title]"),nt=document.querySelector("[data-block-detail-type]"),at=document.querySelector("[data-block-detail-description]"),me=document.querySelector("[data-block-detail-props]"),V=document.querySelector("[data-block-detail-status]"),R=document.querySelector("[data-page-drawer]"),x=document.querySelector("[data-page-drawer-backdrop]"),Pt=document.querySelectorAll("[data-page-drawer-open]"),Ft=document.querySelectorAll("[data-page-drawer-close]"),W=document.querySelector("[data-add-page-toggle]"),z=document.querySelector("[data-add-page-form]"),A=document.querySelector("[data-add-page-title]"),T=document.querySelector("[data-add-page-slug]"),$e=document.querySelector("[data-add-page-cancel]"),D=document.querySelector("[data-add-page-error]"),ot=ie((B==null?void 0:B.slugValue)||p.slug||"default")||"default",pe={pages:`clower:pages:${ot}`,active:`clower:activePage:${ot}`},g=(e,t,n,a,i,c=[])=>({id:e,label:t,type:n,status:a,description:i,props:c}),Mt=[{id:"home",title:"Accueil",slug:"/",description:"Hero immersif avec CTA, mise en avant des services et preuve sociale.",badges:["Hero","Services","CTA"],blocks:[g("home-hero","Hero principal","Hero","En ligne","Section immersive avec visuel plein \xE9cran et CTA principal.",[{label:"CTA",value:"Commencer"},{label:"Visuel",value:"Photo plein \xE9cran"}]),g("home-services","Services cl\xE9s","Sections","En ligne","Pr\xE9sentation synth\xE9tique des offres principales.",[{label:"Colonnes",value:"3"},{label:"Style",value:"Cards"}]),g("home-social","Preuves clients","Logos","En ligne","Logos et t\xE9moignages courts pour rassurer.",[{label:"Logos",value:"8"},{label:"Notes",value:"4.9/5"}])]},{id:"services",title:"Services",slug:"/services",description:"D\xE9tail des offres avec mise en page \xE9ditoriale et appels \xE0 l\u2019action.",badges:["Offres","Storytelling","CTA"],blocks:[g("services-intro","Introduction","Texte","En ligne","Paragraphe d\u2019ouverture qui pose la promesse.",[{label:"Longueur",value:"120 mots"}]),g("services-grid","Offres d\xE9taill\xE9es","Cards","En ligne","Cartes d\xE9taill\xE9es pour chaque service propos\xE9.",[{label:"Cartes",value:"4"},{label:"CTA",value:"D\xE9couvrir"}]),g("services-cases","\xC9tudes de cas","Portfolio","Brouillon","S\xE9lection de projets marquants.",[{label:"Projets",value:"3"}])]},{id:"realisations",title:"R\xE9alisations",slug:"/realisations",description:"S\xE9lection de projets r\xE9cents avec focus sur les r\xE9sultats.",badges:["Portfolio","Stats","Confiance"],blocks:[g("work-hero","Projets vedettes","Grid","En ligne","Mosa\xEFque des r\xE9alisations \xE0 mettre en avant.",[{label:"Layouts",value:"Masonry"}]),g("work-stats","Chiffres cl\xE9s","Stats","En ligne","Bloc m\xE9triques pour parler r\xE9sultats.",[{label:"KPI",value:"6"}]),g("work-reviews","Avis clients","Quotes","Brouillon","Citations extraites des entretiens clients.",[{label:"Avis",value:"2"}])]},{id:"contact",title:"Contact",slug:"/contact",description:"Formulaire de prise de contact simple et acc\xE8s aux coordonn\xE9es.",badges:["Formulaire","CTA","Infos"],blocks:[g("contact-header","Header court","Texte","En ligne","Intro concise pour inciter \xE0 prendre contact.",[{label:"Ton",value:"Direct"}]),g("contact-form","Formulaire","Form","En ligne","Formulaire de contact avec 4 champs.",[{label:"Champs",value:"Nom, Email, Projet, Budget"}]),g("contact-infos","Coordonn\xE9es","Infos","En ligne","Bloc avec adresse, t\xE9l\xE9phone et r\xE9seaux.",[{label:"Fuseau",value:"CET"}])]}],$t={hero:{type:"Hero",label:"Hero de page",description:"Section pleine largeur avec CTA principal.",status:"Brouillon",props:[{label:"CTA",value:"D\xE9couvrir"},{label:"Hauteur",value:"80vh"}]},paragraph:{type:"Paragraphe",label:"Bloc \xE9ditorial",description:"Paragraphe libre pour raconter votre histoire.",status:"Brouillon",props:[{label:"Longueur",value:"150 mots"}]},image:{type:"Image",label:"Bloc image",description:"Visuel seul avec l\xE9gende optionnelle.",status:"Brouillon",props:[{label:"Ratio",value:"16:9"},{label:"L\xE9gende",value:"Inactive"}]},group:{type:"Groupe",label:"Groupe de sections",description:"Conteneur pour imbriquer plusieurs sous-blocs.",status:"Brouillon",props:[{label:"Disposition",value:"Verticale"}]}},rt=e=>e.map(t=>({...t,badges:[...t.badges||[]],blocks:(t.blocks||[]).map(n=>({...n,props:(n.props||[]).map(a=>({...a}))}))})),jt=()=>{try{let e=window.localStorage.getItem(pe.pages);if(e){let t=JSON.parse(e);if(Array.isArray(t))return rt(t)}}catch{}return rt(Mt)},it=e=>{try{window.localStorage.setItem(pe.pages,JSON.stringify(e))}catch{}},Ht=e=>{try{window.localStorage.setItem(pe.active,e)}catch{}},zt=e=>{var t;try{let n=window.localStorage.getItem(pe.active);if(n&&e.some(a=>a.id===n))return n}catch{}return((t=e[0])==null?void 0:t.id)||null},Ot=e=>!e||e<=0?"0 bloc":e===1?"1 bloc":`${e} blocs`,lt=e=>{if(!e||e==="/")return"/";let t=de(e.replace(/^\//,""));return t?`/${t}`:"/"},je=(e="page",t="block")=>`${e}-${t}-${Date.now().toString(36)}-${Math.floor(Math.random()*1e3)}`,Vt=(e,t)=>[g(je(e,"intro"),"Introduction","Texte","Brouillon",`Paragraphe introductif pour "${t}".`,[{label:"Longueur",value:"2 paragraphes"}]),g(je(e,"content"),"Zone de contenu","Section","Brouillon","Section principale \xE0 composer avec textes et visuels.",[{label:"Colonnes",value:"Auto"}])],Rt=e=>{o&&(o.textContent=(e==null?void 0:e.title)||"Page"),d&&(d.textContent=(e==null?void 0:e.slug)||"/")},Wt=e=>{e&&(u&&(u.textContent=e.title),k&&(k.textContent=e.description||"S\xE9lectionnez une page pour afficher son aper\xE7u."),m&&(m.innerHTML="",(e.badges&&e.badges.length>0?e.badges:["Aucun bloc"]).forEach(n=>{let a=document.createElement("span");a.className="rounded-full bg-slate-100 px-3 py-1",a.textContent=n,m.appendChild(a)})))},fe=e=>{if(!h)return;h.innerHTML="";let t=(e==null?void 0:e.blocks)||[];if(!t.length){b==null||b.classList.remove("hidden");return}b==null||b.classList.add("hidden"),t.forEach((n,a)=>{let i=n.id===w,c=document.createElement("div");c.dataset.previewBlockId=n.id,c.className=["rounded-2xl border bg-white/80 px-4 py-3 shadow-sm transition",i?"border-[#9C6BFF]/50 ring-2 ring-[#9C6BFF]/40":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" "),c.innerHTML=`
          <p class="text-[11px] uppercase tracking-wide text-slate-400">Bloc ${a+1}</p>
          <p class="text-sm font-semibold text-slate-900">${n.label}</p>
          <p class="text-xs text-slate-500">${n.type} \u2022 ${n.status}</p>
        `,h.appendChild(c)})},Kt=e=>{switch((e||"").toLowerCase()){case"en ligne":return"bg-emerald-50 text-emerald-700";case"brouillon":return"bg-amber-50 text-amber-700";default:return"bg-slate-100 text-slate-600"}},ge=e=>{if(!(!Fe||!Me)){if(!e){Fe.classList.add("hidden"),Me.classList.remove("hidden"),V==null||V.classList.add("hidden");return}if(Fe.classList.remove("hidden"),Me.classList.add("hidden"),st&&(st.textContent=e.label),nt&&(nt.textContent=e.type),at&&(at.textContent=e.description||"Aucune description pour ce bloc."),me)if(me.innerHTML="",e.props&&e.props.length>0)e.props.forEach(t=>{let n=document.createElement("div");n.className="flex items-center justify-between gap-3 rounded-xl border border-slate-200 px-3 py-2 text-sm",n.innerHTML=`
              <span class="text-xs uppercase tracking-wide text-slate-500">${t.label}</span>
              <span class="font-semibold text-slate-900">${t.value}</span>
            `,me.appendChild(n)});else{let t=document.createElement("div");t.className="rounded-xl border border-dashed border-slate-200 px-3 py-2 text-sm text-slate-500",t.textContent="Aucune propri\xE9t\xE9 d\xE9clar\xE9e.",me.appendChild(t)}V&&(V.textContent=e.status,V.className=`rounded-full px-3 py-1 text-xs font-semibold ${Kt(e.status)}`,V.classList.remove("hidden"))}},He=e=>{if(!l)return;l.innerHTML="";let t=(e==null?void 0:e.blocks)||[];if(Z&&(Z.textContent=Ot(t.length)),t.length===0){l.classList.add("hidden"),H==null||H.classList.remove("hidden");return}l.classList.remove("hidden"),H==null||H.classList.add("hidden"),t.forEach(n=>{let a=n.id===w,i=document.createElement("div");i.dataset.blockItem="true",i.dataset.blockId=n.id,i.setAttribute("role","option"),i.setAttribute("aria-selected",a?"true":"false"),i.tabIndex=0,i.className=["relative flex items-center gap-3 rounded-2xl border px-3 py-2 text-left transition",a?"bg-slate-100 border-[#9C6BFF]/40 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let c=document.createElement("span");c.className=`absolute inset-y-2 left-0 w-1 rounded-full bg-[#9C6BFF] ${a?"":"hidden"}`,i.appendChild(c);let N=document.createElement("div");N.className="flex flex-1 items-center gap-3";let Re=document.createElement("div");Re.className="hidden lg:flex cursor-grab flex-shrink-0 items-center text-lg text-slate-400",Re.innerHTML="&#8801;",N.appendChild(Re);let Se=document.createElement("div");Se.className="flex-1";let we=document.createElement("div");we.className="flex items-center gap-2 text-[11px] uppercase tracking-wide text-slate-500";let We=document.createElement("span");We.className="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600",We.textContent=n.type;let Ke=document.createElement("span");Ke.className="text-slate-400",Ke.textContent=n.status,we.appendChild(We),we.appendChild(Ke);let Ue=document.createElement("p");Ue.className="mt-1 text-sm font-semibold text-slate-900",Ue.textContent=n.label,Se.appendChild(we),Se.appendChild(Ue),N.appendChild(Se),i.appendChild(N);let Le=document.createElement("div");Le.className="flex flex-col gap-1 text-xs text-slate-400";let ke=document.createElement("div");ke.className="flex items-center gap-1 lg:hidden";let X=document.createElement("button");X.type="button",X.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",X.textContent="\u2191",X.addEventListener("click",$=>{$.stopPropagation(),dt(n.id,-1)});let ee=document.createElement("button");ee.type="button",ee.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",ee.textContent="\u2193",ee.addEventListener("click",$=>{$.stopPropagation(),dt(n.id,1)}),ke.appendChild(X),ke.appendChild(ee),Le.appendChild(ke);let te=document.createElement("button");te.type="button",te.className="inline-flex items-center justify-center rounded-lg border border-transparent px-2 py-1 text-[12px] text-rose-500 hover:text-rose-700",te.innerHTML="\u{1F5D1}\uFE0F",te.addEventListener("click",$=>{$.stopPropagation(),Zt(n.id)}),Le.appendChild(te),i.appendChild(Le),i.addEventListener("click",()=>{_(n.id)}),i.addEventListener("keydown",$=>{($.key==="Enter"||$.key===" ")&&($.preventDefault(),_(n.id))}),l.appendChild(i)})},ct=(e,t)=>{s.forEach(n=>{n.innerHTML="",e.forEach(a=>{let i=document.createElement("li"),c=document.createElement("button");c.type="button",c.dataset.pageId=a.id,c.className=["w-full flex items-center justify-between gap-3 px-3 py-2 text-left transition",t===a.id?"bg-[#9C6BFF]/10 text-slate-900 border border-[#9C6BFF]/40 rounded-xl shadow-sm":"text-slate-700 hover:bg-slate-50 rounded-xl"].join(" "),t===a.id?c.setAttribute("aria-current","page"):c.removeAttribute("aria-current"),c.innerHTML=`
            <div class="flex items-center gap-3">
              <span class="flex h-9 w-9 items-center justify-center rounded-xl border border-slate-200 bg-white text-slate-500">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6.5 4.5h7l4 4v11a1 1 0 0 1-1 1h-10a1 1 0 0 1-1-1v-14a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
                  <path d="M13.5 4.5v4a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.4"/>
                </svg>
              </span>
              <div class="flex flex-col">
                <span class="text-sm font-semibold">${a.title}</span>
                <span class="text-xs text-slate-500">${a.slug}</span>
              </div>
            </div>
          `,c.addEventListener("click",()=>{K(a.id),Oe()||Ve()}),i.appendChild(c),n.appendChild(i)})})},Ut=()=>!r||!Array.isArray(r.blocks)?null:r.blocks.find(e=>e.id===w)||null,_=e=>{if(!r)return;if(!e){w=null,He(r),ge(null),fe(r);return}let t=r.blocks.find(n=>n.id===e)||r.blocks[0]||null;w=(t==null?void 0:t.id)||null,He(r),ge(t),fe(r)},ve=e=>{if(!r)return;let t={...r,blocks:e};Qt(t)},he=()=>window.matchMedia("(min-width: 1024px)").matches,dt=(e,t)=>{if(!r||!e||!t)return;let n=[...r.blocks||[]],a=n.findIndex(N=>N.id===e);if(a<0)return;let i=a+t;if(i<0||i>=n.length)return;let[c]=n.splice(a,1);n.splice(i,0,c),ve(n),K(r.id,{preserveBlock:!0}),_(c.id)},_t=(e,t)=>{if(!r||!e||!t||e===t)return;let n=[...r.blocks||[]],a=n.findIndex(N=>N.id===e),i=n.findIndex(N=>N.id===t);if(a<0||i<0)return;let[c]=n.splice(a,1);n.splice(i,0,c),ve(n),K(r.id,{preserveBlock:!0}),_(c.id)},ut=()=>{if(!l)return;let e=he();l.querySelectorAll("[data-block-item]").forEach(t=>{t.setAttribute("draggable",e?"true":"false")})},be=()=>{O&&(O.classList.add("hidden"),Q=!1)},Jt=()=>{O&&(O.classList.remove("hidden"),Q=!0)},Gt=()=>{Q?be():Jt()},Yt=e=>{if(!r||!e)return;let t=$t[e];if(!t)return;let n=(r.blocks||[]).filter(c=>c.type===t.type).length+1,a=g(je(r.id,e),`${t.label} ${n}`,t.type,t.status,t.description,t.props),i=[...r.blocks||[],a];ve(i),K(r.id,{preserveBlock:!0}),_(a.id),be(),re("Bloc ajout\xE9")},mt=e=>{var a,i;if(!r)return;let t=(r.blocks||[]).filter(c=>c.id!==e),n=e===w?((a=t[0])==null?void 0:a.id)||null:w||((i=t[0])==null?void 0:i.id)||null;ve(t),w=n,K(r.id,{preserveBlock:!0}),w?_(w):(ge(null),fe(r)),re("Bloc supprim\xE9")},ze=()=>{q&&(q.classList.add("hidden"),q.classList.remove("flex"),xe=null)},Zt=e=>{if(!q){mt(e);return}xe=e,q.classList.remove("hidden"),q.classList.add("flex")},Qt=e=>{e&&(S=S.map(t=>t.id===e.id?e:t),r=e,it(S))},K=(e,t={})=>{var a,i;let n=S.find(c=>c.id===e)||S[0]||null;r=n,J=(n==null?void 0:n.id)||null,(!t.preserveBlock||!r||!r.blocks.some(c=>c.id===w))&&(w=((i=(a=r==null?void 0:r.blocks)==null?void 0:a[0])==null?void 0:i.id)||null),J&&Ht(J),ct(S,J),Rt(r),Wt(r),He(r),ge(Ut()),fe(r),ut(),Q&&be()},Oe=()=>window.matchMedia("(min-width: 1024px)").matches,pt=()=>{R&&(Oe()?(R.classList.add("is-open"),x==null||x.classList.add("hidden"),document.body.classList.remove("overflow-hidden")):R.classList.remove("is-open"))},Xt=()=>{!R||Oe()||(R.classList.add("is-open"),x==null||x.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},Ve=()=>{R&&(R.classList.remove("is-open"),x==null||x.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))},es=()=>{!z||!W||(z.classList.remove("hidden"),W.classList.add("hidden"),D&&(D.textContent=""),ye=!1,A&&(A.value="",A.focus()),T&&(T.value=""))},ft=()=>{!z||!W||(z.classList.add("hidden"),W.classList.remove("hidden"),D&&(D.textContent=""),ye=!1,z.reset())},ts=()=>{!A||!T||ye&&T.value.trim().length>0||(T.value=lt(A.value))},S=jt(),J=zt(S),ye=!1,r=null,w=null,Q=!1,xe=null;ct(S,J),K(J),pt(),Pt.forEach(e=>{e.addEventListener("click",Xt)}),Ft.forEach(e=>{e.addEventListener("click",Ve)}),x==null||x.addEventListener("click",Ve),window.addEventListener("resize",()=>{pt(),ut()}),W==null||W.addEventListener("click",es),$e==null||$e.addEventListener("click",ft),A==null||A.addEventListener("input",ts),T==null||T.addEventListener("input",()=>{D&&(D.textContent=""),ye=!0}),z==null||z.addEventListener("submit",e=>{if(e.preventDefault(),!A||!T)return;let t=A.value.trim(),n=lt(T.value.trim()||t);if(!t||!n){D&&(D.textContent="Titre et slug sont requis.");return}if(S.some(c=>c.slug===n)){D&&(D.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}let a=`page-${Date.now().toString(36)}`,i={id:a,title:t,slug:n,description:`Nouvelle page "${t}" pr\xEAte \xE0 \xEAtre maquett\xE9e.`,badges:["Layout","Texte"],blocks:Vt(a,t)};S=[...S,i],it(S),ft(),K(i.id)}),F==null||F.addEventListener("click",e=>{e.stopPropagation(),Gt()}),document.addEventListener("click",e=>{Q&&(O!=null&&O.contains(e.target)||F!=null&&F.contains(e.target)||be())}),It.forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();let n=e.dataset.blockAdd;Yt(n)})}),Pe==null||Pe.addEventListener("click",()=>{ze()}),Ie==null||Ie.addEventListener("click",()=>{xe&&mt(xe),ze()}),q==null||q.addEventListener("click",e=>{e.target===q&&ze()});let ss=e=>{let t=e.target.closest("[data-block-item]");!t||!he()||(M=t.dataset.blockId||null,M&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",M),t.classList.add("opacity-50")))},gt=()=>{l==null||l.querySelectorAll("[data-block-item]").forEach(e=>e.classList.remove("opacity-50","ring-2","ring-[#9C6BFF]/50"))},ns=()=>{M=null,gt()},as=e=>{if(!M||!he())return;let t=e.target.closest("[data-block-item]");!t||t.dataset.blockId===M||(e.preventDefault(),t.classList.add("ring-2","ring-[#9C6BFF]/50"))},os=e=>{let t=e.target.closest("[data-block-item]");t&&t.classList.remove("ring-2","ring-[#9C6BFF]/50")},rs=e=>{if(!M||!he())return;e.preventDefault();let t=e.target.closest("[data-block-item]"),n=M;M=null,gt();let a=(t==null?void 0:t.dataset.blockId)||null;a&&_t(n,a)},M=null;l==null||l.addEventListener("dragstart",ss),l==null||l.addEventListener("dragend",ns),l==null||l.addEventListener("dragover",as),l==null||l.addEventListener("dragleave",os),l==null||l.addEventListener("drop",rs)}});})();
