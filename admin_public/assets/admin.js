(()=>{document.addEventListener("DOMContentLoaded",()=>{console.log("[admin] Atelier charg\xE9");let Ne=document.querySelector("[data-logout]");Ne&&Ne.addEventListener("click",async()=>{Ne.disabled=!0;try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(s){console.error("[admin] Impossible de se d\xE9connecter",s)}finally{window.location.href="/admin/index.html"}});let se=document.querySelector("[data-admin-sidebar]"),C=document.querySelector("[data-admin-sidebar-overlay]"),st=document.querySelectorAll("[data-admin-sidebar-toggle]"),qt=document.querySelectorAll("[data-admin-sidebar-close]"),Pe=document.body,ge=!1,he=()=>{if(!se)return;if(window.matchMedia("(min-width: 1024px)").matches){se.classList.remove("hidden"),C==null||C.classList.add("hidden"),Pe.classList.remove("overflow-hidden");return}ge?(se.classList.remove("hidden"),C==null||C.classList.remove("hidden"),Pe.classList.add("overflow-hidden")):(se.classList.add("hidden"),C==null||C.classList.add("hidden"),Pe.classList.remove("overflow-hidden"))},At=()=>{ge=!0,he()},Me=()=>{ge=!1,he()};se&&st.length>0&&(st.forEach(s=>{s.addEventListener("click",At)}),qt.forEach(s=>{s.addEventListener("click",Me)}),C==null||C.addEventListener("click",Me),window.addEventListener("resize",he),window.addEventListener("keydown",s=>{s.key==="Escape"&&ge&&Me()}),he());let at="clower:currentSite",ot="clower:currentSiteName",m={slug:null,name:""};(()=>{try{m.slug=window.localStorage.getItem(at),m.name=window.localStorage.getItem(ot)||""}catch{m.slug=null,m.name=""}})();let Fe=document.querySelectorAll("[data-site-card]"),Tt=document.querySelectorAll("[data-site-select]"),ae=document.querySelector("[data-current-site-name]"),rt=document.querySelector("[data-workspace-site-name]"),it=document.querySelector("[data-workspace-back-name]"),W=document.querySelector("[data-workspace-back-modal]"),It=document.querySelectorAll("[data-workspace-back]"),Dt=document.querySelectorAll("[data-workspace-back-cancel]"),je=document.querySelector("[data-workspace-back-confirm]"),Nt=document.querySelectorAll("[data-workspace-tab]"),$e=document.querySelector("[data-site-toast]"),lt=document.querySelector("[data-site-toast-message]"),Pt=document.querySelectorAll("[data-site-create]"),v=document.querySelector("[data-site-modal]"),F=document.querySelector("[data-site-form]"),B=document.querySelector("[data-site-name]"),A=document.querySelector("[data-site-slug]"),L=document.querySelector("[data-site-slug-error]"),T=document.querySelector("[data-site-modal-error]"),Mt=document.querySelectorAll("[data-site-modal-cancel]"),ee=document.querySelector("[data-site-modal-submit]"),k=Ht(),ve=!1,ye=null,Ve=null,Ft='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',ct=s=>{if(!v||v.classList.contains("hidden")||s.key!=="Tab")return;let i=Array.from(v.querySelectorAll(Ft)).filter(f=>!f.hasAttribute("disabled")&&!f.getAttribute("aria-hidden"));if(i.length===0)return;let u=i[0],p=i[i.length-1];s.shiftKey?document.activeElement===u&&(s.preventDefault(),p.focus()):document.activeElement===p&&(s.preventDefault(),u.focus())},U=s=>{!$e||!lt||(lt.textContent=s,$e.classList.remove("hidden"),Ve&&clearTimeout(Ve),Ve=setTimeout(()=>{$e.classList.add("hidden")},2500))};function j(s){return s?s.startsWith("/")?s:`/${s}`:""}function oe(s){return(s==null?void 0:s.replace(/^\//,""))||""}let be=(s,i)=>{let u=s?j(s):null;try{u&&(window.localStorage.setItem(at,u),m.slug=u),typeof i=="string"&&i.length>0&&(window.localStorage.setItem(ot,i),m.name=i)}catch{m.slug=u||m.slug,m.name=i||m.name}},dt=s=>{ae&&s&&(ae.textContent=s),rt&&s&&(rt.textContent=s),it&&s&&(it.textContent=s)},Oe=s=>{Nt.forEach(i=>{let u=i.dataset.workspaceTab;if(!u)return;if(!s){i.href="#",i.classList.add("pointer-events-none","opacity-50","text-slate-400"),i.setAttribute("aria-disabled","true");return}let p=encodeURIComponent(oe(s));i.href=`/admin/site/${p}/${u}`,i.classList.remove("pointer-events-none","opacity-50","text-slate-400"),i.removeAttribute("aria-disabled")})},Se=(s,i={})=>{if(!s)return;let u=j(s),p=i.siteName||m.name||(ae==null?void 0:ae.dataset.defaultSiteName)||"";Fe.forEach(g=>{let $=j(g.dataset.siteCard||"")===u,c=g.querySelector("[data-site-active-badge]");$?(g.classList.add("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),g.classList.remove("border-slate-200"),c==null||c.classList.remove("hidden"),p=g.dataset.siteName||p):(g.classList.remove("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),g.classList.add("border-slate-200"),c==null||c.classList.add("hidden"))}),i.persist!==!1&&be(u,i.siteName||p);let f=i.siteName||p;dt(f),Oe(u)},jt=async(s,i)=>{let u=j(s);try{let p=await fetch("/api/sites/select",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slug:u})});if(!p.ok){let c=await p.json().catch(()=>({}));U(c.message||"Impossible de s\xE9lectionner ce site.");return}let f=await p.json().catch(()=>({})),g=j(f.slug||u),y=f.name||i;be(g,y),Se(g,{siteName:y,persist:!1});let $=encodeURIComponent(oe(g));window.location.href=`/admin/site/${$}/design`}catch(p){console.error("[admin] Impossible de s\xE9lectionner le site",p),U("Erreur inattendue lors de la s\xE9lection.")}},$t=async()=>{try{let s=await fetch("/api/sites/current",{credentials:"same-origin"});if(!s.ok){s.status===404&&k&&(window.location.href="/admin/sites");return}let i=await s.json(),u=j(i.slug);be(u,i.name),Se(u,{siteName:i.name,persist:!1})}catch(s){console.warn("[admin] Impossible de r\xE9cup\xE9rer le site actif",s)}};(()=>{if(m.slug){Se(m.slug,{siteName:m.name,persist:!1});return}let s=document.querySelector('[data-site-card][data-site-default="true"]')||Fe[0];s&&Se(s.dataset.siteCard,{siteName:s.dataset.siteName||"",persist:!1})})(),$t(),k?Oe(k.slugValue):m.slug&&Oe(m.slug),Tt.forEach(s=>{s.addEventListener("click",()=>{if(s.disabled)return;let i=s.dataset.siteSelect,u=s.dataset.siteSelectName||"Ce site";i&&(s.disabled=!0,jt(i,u).finally(()=>{s.disabled=!1}))})});let we=s=>s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),Vt=s=>{let i=we(s||"");return i?`/${i}`:""},Ot=()=>{v&&(ye=document.activeElement,v.classList.remove("hidden"),v.classList.add("flex"),ve=!1,F==null||F.reset(),L&&(L.textContent=""),T&&(T.textContent=""),A&&B&&(A.value=we(B.value)),document.addEventListener("keydown",ct),window.setTimeout(()=>{B==null||B.focus()},0))},Le=()=>{v&&(v.classList.add("hidden"),v.classList.remove("flex"),document.removeEventListener("keydown",ct),ve=!1,F==null||F.reset(),L&&(L.textContent=""),T&&(T.textContent=""),ye==null||ye.focus())};Pt.forEach(s=>{s.addEventListener("click",Ot)}),Mt.forEach(s=>{s.addEventListener("click",Le)}),v==null||v.addEventListener("click",s=>{s.target===v&&Le()}),B==null||B.addEventListener("input",()=>{A&&(!ve||A.value.trim().length===0)&&(A.value=we(B.value))}),A==null||A.addEventListener("input",()=>{ve=!0,L&&(L.textContent="")});let zt=()=>new Set(Array.from(Fe).map(s=>j(s.dataset.siteCard||"")));F==null||F.addEventListener("submit",async s=>{if(s.preventDefault(),!B||!A)return;let i=(B.value||"").trim(),u=A.value||"";u||(u=i);let p=Vt(u);if(!i||!p){L&&(L.textContent="Nom et slug sont requis.");return}if(zt().has(p)){L&&(L.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}L&&(L.textContent=""),T&&(T.textContent=""),ee&&(ee.disabled=!0,ee.textContent="Cr\xE9ation...");try{let g=await fetch("/api/sites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:i,slug:p})});if(!g.ok){let re=await g.json().catch(()=>({})),V=re.message||"Impossible de cr\xE9er ce site.";T&&(T.textContent=V),re.field==="slug"&&L&&(L.textContent=V);return}let y=await g.json(),$=j((y==null?void 0:y.slug)||p),c=(y==null?void 0:y.name)||i;be($,c),Le();let _=encodeURIComponent(oe($));window.location.href=`/admin/site/${_}/design`}catch(g){console.error("[admin] Impossible de cr\xE9er le site",g),T&&(T.textContent="Erreur inattendue. R\xE9essaie dans un instant.")}finally{ee&&(ee.disabled=!1,ee.textContent="Cr\xE9er")}}),window.addEventListener("keydown",s=>{s.key==="Escape"&&(v&&!v.classList.contains("hidden")&&Le(),W&&!W.classList.contains("hidden")&&ut(),blockDeleteModal&&!blockDeleteModal.classList.contains("hidden")&&closeBlockDeleteModal(),blockLibraryOpen&&closeBlockLibrary())});function Ht(){let s=window.location.pathname.match(/^\/admin\/site\/([^/]+)(?:\/([^/]+))?/);return s?{slugPart:decodeURIComponent(s[1]),slugValue:j(decodeURIComponent(s[1])),section:s[2]||"design"}:null}function Rt(){if(!W){window.location.href="/admin/sites";return}W.classList.remove("hidden"),W.classList.add("flex")}function ut(){W&&(W.classList.add("hidden"),W.classList.remove("flex"))}It.forEach(s=>{s.addEventListener("click",Rt)}),Dt.forEach(s=>{s.addEventListener("click",ut)}),je==null||je.addEventListener("click",()=>{window.location.href="/admin/sites"}),(k==null?void 0:k.section)==="design"&&Wt(),k&&m.name&&dt(m.name);function Wt(){let s=document.querySelectorAll("[data-page-list]");if(s.length===0)return;let i=document.querySelector("[data-active-page-title]"),u=document.querySelector("[data-active-page-slug]"),p=document.querySelector("[data-page-preview-tags]"),f=document.querySelector("[data-page-preview-frame]"),g=document.querySelector("[data-preview-open]"),y=document.querySelector("[data-preview-status]"),$=document.querySelector("[data-preview-highlight]"),c=document.querySelector("[data-blocks-list]"),_=document.querySelector("[data-blocks-empty]"),re=document.querySelector("[data-block-count]"),V=document.querySelector("[data-block-library-toggle]"),K=document.querySelector("[data-block-library]"),Ut=document.querySelectorAll("[data-block-add]"),I=document.querySelector("[data-block-delete-modal]"),ze=document.querySelector("[data-block-delete-confirm]"),He=document.querySelector("[data-block-delete-cancel]"),O=document.querySelector("[data-block-detail-empty]"),J=document.querySelector("[data-block-detail-status]"),D=document.querySelector("[data-block-editor]"),pt=document.querySelector("[data-block-editor-block-name]"),mt=document.querySelector("[data-block-editor-block-type]"),z=document.querySelector("[data-block-editor-unsupported]"),d=document.querySelector("[data-block-form]"),_t=d?Array.from(d.querySelectorAll("[data-editor-section]")):[],Re=document.querySelector("[data-block-form-cancel]"),ft=d==null?void 0:d.querySelector("[data-group-preview-mobile]"),gt=d==null?void 0:d.querySelector("[data-group-preview-desktop]"),Jt={hero:{section:"hero",labelField:"title",descriptionField:"subtitle",fields:{title:"hero-title",subtitle:"hero-subtitle",ctaLabel:"hero-cta-label",ctaUrl:"hero-cta-url",image:"hero-image",align:"hero-align"}},paragraphe:{section:"paragraph",labelField:"title",descriptionField:"content",fields:{title:"paragraph-title",content:"paragraph-content",align:"paragraph-align"}},image:{section:"image",labelField:"alt",fields:{src:"image-src",alt:"image-alt",showCaption:"image-caption-toggle",caption:"image-caption"}},groupe:{section:"group",fields:{layout:"group-layout",columnsMobile:"group-columns-mobile",columnsDesktop:"group-columns-desktop"}}},Gt={texte:"paragraphe",paragraph:"paragraphe",paragraphs:"paragraphe",paragraphes:"paragraphe",text:"paragraphe",hero:"hero",image:"image",groupe:"groupe",group:"groupe"},ht=(e,t)=>{if(!ft||!gt)return;let n=a=>Array.from({length:Number(a)||1}).map(()=>'<span class="block h-2 w-full rounded-full bg-slate-300"></span>').join("");ft.innerHTML=n(e),gt.innerHTML=n(t)},Yt=async()=>{if(!G)return[];let e=await fetch(G,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les pages.");let t=await e.json().catch(()=>[]);return Array.isArray(t)?t:[]},Kt=async({title:e,slug:t})=>{if(!G)throw new Error("Site inconnu.");let n=await fetch(G,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,slug:t})});if(!n.ok){let a=await n.json().catch(()=>({}));throw new Error(a.message||"Impossible de cr\xE9er la page.")}return n.json().catch(()=>({}))},Xt=async e=>{if(!(!G||!(e!=null&&e.id)))try{let t=await fetch(`${G}/${encodeURIComponent(e.id)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let a=await t.json().catch(()=>({}));throw new Error(a.message||"Impossible de sauvegarder la page.")}let n=await t.json().catch(()=>({}));return n!=null&&n.id&&(b=b.map(a=>a.id===n.id?n:a),(r==null?void 0:r.id)===n.id&&(r=n)),n}catch(t){console.error("[design] Save page failed",t),U(t.message||"Sauvegarde impossible.")}},Zt=async()=>{if(!G){b=[],M=null,r=null,Je(b,M),le(null),O==null||O.classList.remove("hidden"),D==null||D.classList.add("hidden");return}try{let e=await Yt();if(b=Array.isArray(e)?e:[],b.length===0){M=null,r=null,Je(b,M),le(null),O==null||O.classList.remove("hidden"),D==null||D.classList.add("hidden"),f&&(f.srcdoc=ke());return}M=un(b),Y(M)}catch(e){console.error("[design] Impossible de charger les pages",e),U("Impossible de charger les pages.")}},Qt=e=>(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),vt=e=>{if(!e)return null;let t=Qt(e.type),n=Gt[t]||t;return Jt[n]||null},yt=e=>{var n,a;if(!d||!D)return;e&&!e.settings&&(e.settings={});let t=vt(e);if(pt&&(pt.textContent=(e==null?void 0:e.label)||"Bloc"),mt&&(mt.textContent=(e==null?void 0:e.type)||"Bloc"),!t){d.classList.add("hidden"),z==null||z.classList.remove("hidden"),d.dataset.blockId="";return}if(z==null||z.classList.add("hidden"),d.classList.remove("hidden"),d.reset(),d.dataset.blockId=e.id,_t.forEach(o=>{o.dataset.editorSection===t.section?o.classList.remove("hidden"):o.classList.add("hidden")}),Object.entries(t.fields).forEach(([o,l])=>{var Q;let h=d.querySelector(`[name="${l}"]`);if(!h)return;let w=(Q=e.settings)==null?void 0:Q[o];h.type==="checkbox"?h.checked=!!w:(h.tagName,h.value=w!=null?w:"")}),t.section==="group"){let o=((n=d.querySelector('[name="group-columns-mobile"]'))==null?void 0:n.value)||"1",l=((a=d.querySelector('[name="group-columns-desktop"]'))==null?void 0:a.value)||"3";ht(o,l)}},en=e=>{if(!d||!e)return{};let t={};return Object.entries(e.fields).forEach(([n,a])=>{let o=d.querySelector(`[name="${a}"]`);o&&(o.type==="checkbox"?t[n]=o.checked:o.tagName==="TEXTAREA"?t[n]=o.value||"":o.type==="select-one"?t[n]=o.value:t[n]=o.value||"")}),t},xe=e=>{if(y){if(!e){y.classList.add("hidden");return}y.classList.remove("hidden"),y.textContent=e}},tn=e=>e?{id:e.id,title:e.title,slug:e.slug,badges:[...e.badges||[]],blocks:(e.blocks||[]).map(t=>({id:t.id,type:t.type,label:t.label,status:t.status,description:t.description,props:t.props||[],settings:t.settings||{}}))}:null,ke=()=>'<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#475569;background:#fff;">Pr\xE9paration de la pr\xE9visualisation\u2026</body></html>',nn=e=>{if(!f||!e)return;let t={page:tn(e),site:{title:m.name||"Site",slug:m.slug||""}};Qe=!1,xe("Actualisation\u2026"),f.srcdoc=ke(),ue&&ue.abort();let n=new AbortController;ue=n,fetch("/api/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:n.signal}).then(a=>{if(!a.ok)throw new Error("Preview error");return a.json()}).then(a=>{n.signal.aborted||(Ze=a.html||"",f.setAttribute("title",`Pr\xE9visualisation de la page ${e.title||""}`.trim()),f.srcdoc=Ze||ke(),xe("\xC0 jour"))}).catch(a=>{n.signal.aborted||(console.error("[preview] Impossible de rendre la page",a),xe("Erreur preview"),f.srcdoc='<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#be123c;background:#fff;">Erreur lors du rendu de la pr\xE9visualisation.</body></html>')}).finally(()=>{ue===n&&(ue=null)})},sn=e=>{if(e.preventDefault(),!r||!S)return;let t=Ge(),n=vt(t);if(!t||!n)return;let a=en(n),o=(r.blocks||[]).map(l=>{if(l.id!==t.id)return l;let h={...l.settings||{},...a},w={...l,settings:h};return n.labelField&&a[n.labelField]&&(w.label=a[n.labelField]),n.descriptionField&&a[n.descriptionField]&&(w.description=a[n.descriptionField]),w});ce(o),U("Bloc mis \xE0 jour"),Y(r.id,{preserveBlock:!0})},X=document.querySelector("[data-page-drawer]"),E=document.querySelector("[data-page-drawer-backdrop]"),an=document.querySelectorAll("[data-page-drawer-open]"),on=document.querySelectorAll("[data-page-drawer-close]"),Z=document.querySelector("[data-add-page-toggle]"),q=document.querySelector("[data-add-page-form]"),N=document.querySelector("[data-add-page-title]"),P=document.querySelector("[data-add-page-slug]"),We=document.querySelector("[data-add-page-cancel]"),x=document.querySelector("[data-add-page-error]"),te=q==null?void 0:q.querySelector('[type="submit"]'),rn=oe((k==null?void 0:k.slugValue)||m.slug||"default")||"default",ln=(k==null?void 0:k.slugValue)||m.slug||"",bt=oe(ln)||"",G=bt?`/api/sites/${encodeURIComponent(bt)}/pages`:null,St={active:`clower:activePage:${rn}`},Ue=(e,t,n,a,o,l=[],h={})=>({id:e,label:t,type:n,status:a,description:o,props:l,settings:{...h}}),cn={hero:{type:"Hero",label:"Hero de page",description:"Section pleine largeur avec CTA principal.",status:"Brouillon",props:[{label:"CTA",value:"D\xE9couvrir"},{label:"Hauteur",value:"80vh"}],settings:{title:"Titre du hero",subtitle:"",ctaLabel:"D\xE9couvrir",ctaUrl:"#",image:"",align:"center"}},paragraph:{type:"Paragraphe",label:"Bloc \xE9ditorial",description:"Paragraphe libre pour raconter votre histoire.",status:"Brouillon",props:[{label:"Longueur",value:"150 mots"}],settings:{title:"Titre du paragraphe",content:"",align:"left"}},image:{type:"Image",label:"Bloc image",description:"Visuel seul avec l\xE9gende optionnelle.",status:"Brouillon",props:[{label:"Ratio",value:"16:9"},{label:"L\xE9gende",value:"Inactive"}],settings:{src:"",alt:"",showCaption:!1,caption:""}},group:{type:"Groupe",label:"Groupe de sections",description:"Conteneur pour imbriquer plusieurs sous-blocs.",status:"Brouillon",props:[{label:"Disposition",value:"Verticale"}],settings:{layout:"grid",columnsMobile:"1",columnsDesktop:"3"}}},dn=e=>{try{window.localStorage.setItem(St.active,e)}catch{}},un=e=>{var t;try{let n=window.localStorage.getItem(St.active);if(n&&e.some(a=>a.id===n))return n}catch{}return((t=e[0])==null?void 0:t.id)||null},pn=e=>!e||e<=0?"0 bloc":e===1?"1 bloc":`${e} blocs`,wt=e=>{if(!e||e==="/")return"/";let t=we(e.replace(/^\//,""));return t?`/${t}`:"/"},_e=(e="page",t="block")=>`${e}-${t}-${Date.now().toString(36)}-${Math.floor(Math.random()*1e3)}`,Nn=(e,t)=>[Ue(_e(e,"intro"),"Introduction","Paragraphe","Brouillon",`Paragraphe introductif pour "${t}".`,[{label:"Longueur",value:"2 paragraphes"}],{title:`Introduction \xE0 ${t}`,content:"Ajoutez votre premier paragraphe de pr\xE9sentation.",align:"left"}),Ue(_e(e,"content"),"Zone de contenu","Groupe","Brouillon","Section principale \xE0 composer avec textes et visuels.",[{label:"Colonnes",value:"Auto"}],{layout:"grid",columnsMobile:"1",columnsDesktop:"2"})],mn=e=>{i&&(i.textContent=(e==null?void 0:e.title)||"Page"),u&&(u.textContent=(e==null?void 0:e.slug)||"/")},fn=e=>{if(!p)return;p.innerHTML="",(e&&e.badges&&e.badges.length>0?e.badges:["Structure en cours"]).forEach(n=>{let a=document.createElement("span");a.className="rounded-full bg-slate-100 px-3 py-1",a.textContent=n,p.appendChild(a)})},gn=e=>{switch((e||"").toLowerCase()){case"en ligne":return"bg-emerald-50 text-emerald-700";case"brouillon":return"bg-amber-50 text-amber-700";default:return"bg-slate-100 text-slate-600"}},Ce=e=>{if(!(!O||!D)){if(!e){O.classList.remove("hidden"),D.classList.add("hidden"),z==null||z.classList.add("hidden"),d==null||d.classList.add("hidden"),J==null||J.classList.add("hidden");return}O.classList.add("hidden"),D.classList.remove("hidden"),J&&(e.status?(J.textContent=e.status,J.className=`rounded-full px-3 py-1 text-xs font-semibold ${gn(e.status)}`,J.classList.remove("hidden")):J.classList.add("hidden")),yt(e)}},ie=e=>{if(!f)return;let t=f.contentDocument;if(!t)return;t.querySelectorAll("[data-preview-block]").forEach(a=>{a.dataset.previewBlock===e?(a.classList.add("preview-block-active"),Qe&&e&&a.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})):a.classList.remove("preview-block-active")}),$&&($.style.borderColor=e?"rgba(156, 107, 255, 0.5)":"transparent")},le=e=>{if(!c)return;c.innerHTML="";let t=(e==null?void 0:e.blocks)||[];if(re&&(re.textContent=pn(t.length)),t.length===0){c.classList.add("hidden"),_==null||_.classList.remove("hidden");return}c.classList.remove("hidden"),_==null||_.classList.add("hidden"),t.forEach(n=>{let a=n.id===S,o=document.createElement("div");o.dataset.blockItem="true",o.dataset.blockId=n.id,o.setAttribute("role","option"),o.setAttribute("aria-selected",a?"true":"false"),o.tabIndex=0,o.className=["relative flex items-center gap-3 rounded-2xl border px-3 py-2 text-left transition",a?"bg-slate-100 border-[#9C6BFF]/40 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let l=document.createElement("span");l.className=`absolute inset-y-2 left-0 w-1 rounded-full bg-[#9C6BFF] ${a?"":"hidden"}`,o.appendChild(l);let h=document.createElement("div");h.className="flex flex-1 items-center gap-3";let w=document.createElement("div");w.className="hidden lg:flex cursor-grab flex-shrink-0 items-center text-lg text-slate-400",w.innerHTML="&#8801;",h.appendChild(w);let Q=document.createElement("div");Q.className="flex-1";let Te=document.createElement("div");Te.className="flex items-center gap-2 text-[11px] uppercase tracking-wide text-slate-500";let et=document.createElement("span");et.className="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600",et.textContent=n.type;let tt=document.createElement("span");tt.className="text-slate-400",tt.textContent=n.status,Te.appendChild(et),Te.appendChild(tt);let nt=document.createElement("p");nt.className="mt-1 text-sm font-semibold text-slate-900";let Tn=n.settings&&n.settings.title||n.label||"Bloc sans titre";nt.textContent=Tn,Q.appendChild(Te),Q.appendChild(nt),h.appendChild(Q),o.appendChild(h);let Ie=document.createElement("div");Ie.className="flex flex-col gap-1 text-xs text-slate-400";let De=document.createElement("div");De.className="flex items-center gap-1 lg:hidden";let pe=document.createElement("button");pe.type="button",pe.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",pe.textContent="\u2191",pe.addEventListener("click",R=>{R.stopPropagation(),Lt(n.id,-1)});let me=document.createElement("button");me.type="button",me.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",me.textContent="\u2193",me.addEventListener("click",R=>{R.stopPropagation(),Lt(n.id,1)}),De.appendChild(pe),De.appendChild(me),Ie.appendChild(De);let fe=document.createElement("button");fe.type="button",fe.className="inline-flex items-center justify-center rounded-lg border border-transparent px-2 py-1 text-[12px] text-rose-500 hover:text-rose-700",fe.innerHTML="\u{1F5D1}\uFE0F",fe.addEventListener("click",R=>{R.stopPropagation(),Sn(n.id)}),Ie.appendChild(fe),o.appendChild(Ie),o.addEventListener("click",()=>{ne(n.id)}),o.addEventListener("keydown",R=>{(R.key==="Enter"||R.key===" ")&&(R.preventDefault(),ne(n.id))}),c.appendChild(o)})},Je=(e,t)=>{s.forEach(n=>{n.innerHTML="",e.forEach(a=>{let o=document.createElement("li"),l=document.createElement("button");l.type="button",l.dataset.pageId=a.id,l.className=["w-full flex items-center justify-between gap-3 px-3 py-2 text-left transition",t===a.id?"bg-[#9C6BFF]/10 text-slate-900 border border-[#9C6BFF]/40 rounded-xl shadow-sm":"text-slate-700 hover:bg-slate-50 rounded-xl"].join(" "),t===a.id?l.setAttribute("aria-current","page"):l.removeAttribute("aria-current"),l.innerHTML=`
            <div class="flex items-center gap-3">
              <span class="flex h-9 w-9 items-center justify-center rounded-xl border border-slate-200 bg-white text-slate-500">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6.5 4.5h7l4 4v11a1 1 0 0 1-1 1h-10a1 1 0 0 1-1-1v-14a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
                  <path d="M13.5 4.5v4a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.4"/>
                </svg>
              </span>
              <div class="flex flex-col">
                <span class="text-sm font-semibold">${a.title}</span>
                <span class="text-xs text-slate-500">${a.slug}</span>
              </div>
            </div>
          `,l.addEventListener("click",()=>{Y(a.id),Ke()||Xe()}),o.appendChild(l),n.appendChild(o)})})},Ge=()=>!r||!Array.isArray(r.blocks)?null:r.blocks.find(e=>e.id===S)||null,ne=e=>{if(!r)return;if(!e){S=null,le(r),Ce(null),ie(null);return}let t=r.blocks.find(n=>n.id===e)||r.blocks[0]||null;S=(t==null?void 0:t.id)||null,le(r),Ce(t),ie(S)},ce=e=>{if(!r)return;let t={...r,blocks:e};wn(t)},Ee=()=>window.matchMedia("(min-width: 1024px)").matches;function Lt(e,t){if(!r||!e||!t)return;let n=[...r.blocks||[]],a=n.findIndex(h=>h.id===e);if(a<0)return;let o=a+t;if(o<0||o>=n.length)return;let[l]=n.splice(a,1);n.splice(o,0,l),ce(n),Y(r.id,{preserveBlock:!0}),ne(l.id)}function hn(e,t){if(!r||!e||!t||e===t)return;let n=[...r.blocks||[]],a=n.findIndex(h=>h.id===e),o=n.findIndex(h=>h.id===t);if(a<0||o<0)return;let[l]=n.splice(a,1);n.splice(o,0,l),ce(n),Y(r.id,{preserveBlock:!0}),ne(l.id)}function xt(){if(!c)return;let e=Ee();c.querySelectorAll("[data-block-item]").forEach(t=>{t.setAttribute("draggable",e?"true":"false")})}function Be(){K&&(K.classList.add("hidden"),de=!1)}function vn(){K&&(K.classList.remove("hidden"),de=!0)}function yn(){de?Be():vn()}function bn(e){if(!r||!e)return;let t=cn[e];if(!t)return;let n=(r.blocks||[]).filter(l=>l.type===t.type).length+1,a=Ue(_e(r.id,e),`${t.label} ${n}`,t.type,t.status,t.description,t.props,t.settings||{}),o=[...r.blocks||[],a];ce(o),Y(r.id,{preserveBlock:!0}),ne(a.id),Be(),U("Bloc ajout\xE9")}function kt(e){var a,o;if(!r)return;let t=(r.blocks||[]).filter(l=>l.id!==e),n=e===S?((a=t[0])==null?void 0:a.id)||null:S||((o=t[0])==null?void 0:o.id)||null;ce(t),S=n,Y(r.id,{preserveBlock:!0}),S?ne(S):(Ce(null),ie(null)),U("Bloc supprim\xE9")}function Ye(){I&&(I.classList.add("hidden"),I.classList.remove("flex"),Ae=null)}function Sn(e){if(!I){kt(e);return}Ae=e,I.classList.remove("hidden"),I.classList.add("flex")}let wn=e=>{e&&(b=b.map(t=>t.id===e.id?e:t),r=e,Xt(e))},Y=(e,t={})=>{var a,o;let n=b.find(l=>l.id===e)||b[0]||null;r=n,M=(n==null?void 0:n.id)||null,(!t.preserveBlock||!r||!r.blocks.some(l=>l.id===S))&&(S=((o=(a=r==null?void 0:r.blocks)==null?void 0:a[0])==null?void 0:o.id)||null),M&&dn(M),Je(b,M),mn(r),fn(r),nn(r),le(r),Ce(Ge()),ie(S),xt(),de&&Be()},Ke=()=>window.matchMedia("(min-width: 1024px)").matches,Ct=()=>{X&&(Ke()?(X.classList.add("is-open"),E==null||E.classList.add("hidden"),document.body.classList.remove("overflow-hidden")):X.classList.remove("is-open"))},Ln=()=>{!X||Ke()||(X.classList.add("is-open"),E==null||E.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},Xe=()=>{X&&(X.classList.remove("is-open"),E==null||E.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))},xn=()=>{!q||!Z||(q.classList.remove("hidden"),Z.classList.add("hidden"),x&&(x.textContent=""),qe=!1,N&&(N.value="",N.focus()),P&&(P.value=""))},Et=()=>{!q||!Z||(q.classList.add("hidden"),Z.classList.remove("hidden"),x&&(x.textContent=""),qe=!1,q.reset())},kn=()=>{!N||!P||qe&&P.value.trim().length>0||(P.value=wt(N.value))},b=[],M=null,qe=!1,r=null,S=null,de=!1,Ae=null,Ze="",Qe=!1,ue=null;Ct(),an.forEach(e=>{e.addEventListener("click",Ln)}),on.forEach(e=>{e.addEventListener("click",Xe)}),E==null||E.addEventListener("click",Xe),window.addEventListener("resize",()=>{Ct(),xt()}),Z==null||Z.addEventListener("click",xn),We==null||We.addEventListener("click",Et),N==null||N.addEventListener("input",kn),P==null||P.addEventListener("input",()=>{x&&(x.textContent=""),qe=!0}),q==null||q.addEventListener("submit",async e=>{if(e.preventDefault(),!G){x&&(x.textContent="Aucun site s\xE9lectionn\xE9.");return}if(!N||!P)return;let t=N.value.trim(),n=wt(P.value.trim()||t);if(!t||!n){x&&(x.textContent="Titre et slug sont requis.");return}x&&(x.textContent=""),te&&(te.disabled=!0,te.textContent="Cr\xE9ation...");try{let a=await Kt({title:t,slug:n});if(!a||!a.id)throw new Error("R\xE9ponse invalide.");b=[...b,a],Et(),U("Page cr\xE9\xE9e"),Y(a.id)}catch(a){console.error("[design] create page failed",a),x&&(x.textContent=a.message||"Impossible de cr\xE9er la page.")}finally{te&&(te.disabled=!1,te.textContent="Cr\xE9er")}}),V==null||V.addEventListener("click",e=>{e.stopPropagation(),yn()}),document.addEventListener("click",e=>{de&&(K!=null&&K.contains(e.target)||V!=null&&V.contains(e.target)||Be())}),Ut.forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();let n=e.dataset.blockAdd;bn(n)})}),He==null||He.addEventListener("click",()=>{Ye()}),ze==null||ze.addEventListener("click",()=>{Ae&&kt(Ae),Ye()}),I==null||I.addEventListener("click",e=>{e.target===I&&Ye()}),d==null||d.addEventListener("input",e=>{var n,a;let t=e.target;if(!(!t||!t.name)&&(t.name==="group-columns-mobile"||t.name==="group-columns-desktop")){let o=((n=d.querySelector('[name="group-columns-mobile"]'))==null?void 0:n.value)||"1",l=((a=d.querySelector('[name="group-columns-desktop"]'))==null?void 0:a.value)||"3";ht(o,l)}}),d==null||d.addEventListener("submit",sn),Re==null||Re.addEventListener("click",e=>{e.preventDefault();let t=Ge();t&&yt(t)}),f==null||f.addEventListener("load",()=>{Qe=!0,xe("\xC0 jour"),ie(S)}),g==null||g.addEventListener("click",()=>{let e=window.open("","_blank");if(!e)return;e.opener=null;let t=e.document;t.open(),t.write(Ze||ke()),t.close()});let Cn=e=>{let t=e.target.closest("[data-block-item]");!t||!Ee()||(H=t.dataset.blockId||null,H&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",H),t.classList.add("opacity-50")))},Bt=()=>{c==null||c.querySelectorAll("[data-block-item]").forEach(e=>e.classList.remove("opacity-50","ring-2","ring-[#9C6BFF]/50"))},En=()=>{H=null,Bt()},Bn=e=>{if(!H||!Ee())return;let t=e.target.closest("[data-block-item]");!t||t.dataset.blockId===H||(e.preventDefault(),t.classList.add("ring-2","ring-[#9C6BFF]/50"))},qn=e=>{let t=e.target.closest("[data-block-item]");t&&t.classList.remove("ring-2","ring-[#9C6BFF]/50")},An=e=>{if(!H||!Ee())return;e.preventDefault();let t=e.target.closest("[data-block-item]"),n=H;H=null,Bt();let a=(t==null?void 0:t.dataset.blockId)||null;a&&hn(n,a)},H=null;c==null||c.addEventListener("dragstart",Cn),c==null||c.addEventListener("dragend",En),c==null||c.addEventListener("dragover",Bn),c==null||c.addEventListener("dragleave",qn),c==null||c.addEventListener("drop",An),Zt()}});})();
