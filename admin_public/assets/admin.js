(()=>{document.addEventListener("DOMContentLoaded",()=>{console.log("[admin] Atelier charg\xE9");let Ct=document.querySelector("[data-logout]");Ct&&Ct.addEventListener("click",async()=>{Ct.disabled=!0;try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(n){console.error("[admin] Impossible de se d\xE9connecter",n)}finally{window.location.href="/admin/index.html"}});let We=document.querySelector("[data-admin-sidebar]"),de=document.querySelector("[data-admin-sidebar-overlay]"),Jt=document.querySelectorAll("[data-admin-sidebar-toggle]"),is=document.querySelectorAll("[data-admin-sidebar-close]"),Et=document.body,it=!1,lt=()=>{if(!We)return;if(window.matchMedia("(min-width: 1024px)").matches){We.classList.remove("hidden"),de==null||de.classList.add("hidden"),Et.classList.remove("overflow-hidden");return}it?(We.classList.remove("hidden"),de==null||de.classList.remove("hidden"),Et.classList.add("overflow-hidden")):(We.classList.add("hidden"),de==null||de.classList.add("hidden"),Et.classList.remove("overflow-hidden"))},ls=()=>{it=!0,lt()},qt=()=>{it=!1,lt()};We&&Jt.length>0&&(Jt.forEach(n=>{n.addEventListener("click",ls)}),is.forEach(n=>{n.addEventListener("click",qt)}),de==null||de.addEventListener("click",qt),window.addEventListener("resize",lt),window.addEventListener("keydown",n=>{n.key==="Escape"&&it&&qt()}),lt());let Wt="clower:currentSite",Gt="clower:currentSiteName",J={slug:null,name:""};(()=>{try{J.slug=window.localStorage.getItem(Wt),J.name=window.localStorage.getItem(Gt)||""}catch{J.slug=null,J.name=""}})();let kt=document.querySelectorAll("[data-site-card]"),cs=document.querySelectorAll("[data-site-select]"),Ge=document.querySelector("[data-current-site-name]"),_t=document.querySelector("[data-workspace-site-name]"),Yt=document.querySelector("[data-workspace-back-name]"),Ae=document.querySelector("[data-workspace-back-modal]"),ds=document.querySelectorAll("[data-workspace-back]"),us=document.querySelectorAll("[data-workspace-back-cancel]"),It=document.querySelector("[data-workspace-back-confirm]"),ms=document.querySelectorAll("[data-workspace-tab]"),At=document.querySelector("[data-site-toast]"),Kt=document.querySelector("[data-site-toast-message]"),ps=document.querySelectorAll("[data-site-create]"),oe=document.querySelector("[data-site-modal]"),Ce=document.querySelector("[data-site-form]"),pe=document.querySelector("[data-site-name]"),be=document.querySelector("[data-site-slug]"),ie=document.querySelector("[data-site-slug-error]"),xe=document.querySelector("[data-site-modal-error]"),fs=document.querySelectorAll("[data-site-modal-cancel]"),ze=document.querySelector("[data-site-modal-submit]"),z=ws(),ct=!1,dt=null,Bt=null,gs='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',Xt=n=>{if(!oe||oe.classList.contains("hidden")||n.key!=="Tab")return;let i=Array.from(oe.querySelectorAll(gs)).filter(b=>!b.hasAttribute("disabled")&&!b.getAttribute("aria-hidden"));if(i.length===0)return;let h=i[0],f=i[i.length-1];n.shiftKey?document.activeElement===h&&(n.preventDefault(),f.focus()):document.activeElement===f&&(n.preventDefault(),h.focus())},F=n=>{!At||!Kt||(Kt.textContent=n,At.classList.remove("hidden"),Bt&&clearTimeout(Bt),Bt=setTimeout(()=>{At.classList.add("hidden")},2500))};function Ee(n){return n?n.startsWith("/")?n:`/${n}`:""}function qe(n){return(n==null?void 0:n.replace(/^\//,""))||""}let ut=(n,i)=>{let h=n?Ee(n):null;try{h&&(window.localStorage.setItem(Wt,h),J.slug=h),typeof i=="string"&&i.length>0&&(window.localStorage.setItem(Gt,i),J.name=i)}catch{J.slug=h||J.slug,J.name=i||J.name}},Zt=n=>{Ge&&n&&(Ge.textContent=n),_t&&n&&(_t.textContent=n),Yt&&n&&(Yt.textContent=n)},Tt=n=>{ms.forEach(i=>{let h=i.dataset.workspaceTab;if(!h)return;if(!n){i.href="#",i.classList.add("pointer-events-none","opacity-50","text-slate-400"),i.setAttribute("aria-disabled","true");return}let f=encodeURIComponent(qe(n));i.href=`/admin/site/${f}/${h}`,i.classList.remove("pointer-events-none","opacity-50","text-slate-400"),i.removeAttribute("aria-disabled")})},mt=(n,i={})=>{if(!n)return;let h=Ee(n),f=i.siteName||J.name||(Ge==null?void 0:Ge.dataset.defaultSiteName)||"";kt.forEach(v=>{let k=Ee(v.dataset.siteCard||"")===h,u=v.querySelector("[data-site-active-badge]");k?(v.classList.add("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),v.classList.remove("border-slate-200"),u==null||u.classList.remove("hidden"),f=v.dataset.siteName||f):(v.classList.remove("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),v.classList.add("border-slate-200"),u==null||u.classList.add("hidden"))}),i.persist!==!1&&ut(h,i.siteName||f);let b=i.siteName||f;Zt(b),Tt(h)},hs=async(n,i)=>{let h=Ee(n);try{let f=await fetch("/api/sites/select",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slug:h})});if(!f.ok){let u=await f.json().catch(()=>({}));F(u.message||"Impossible de s\xE9lectionner ce site.");return}let b=await f.json().catch(()=>({})),v=Ee(b.slug||h),A=b.name||i;ut(v,A),mt(v,{siteName:A,persist:!1});let k=encodeURIComponent(qe(v));window.location.href=`/admin/site/${k}/design`}catch(f){console.error("[admin] Impossible de s\xE9lectionner le site",f),F("Erreur inattendue lors de la s\xE9lection.")}},ys=async()=>{try{let n=await fetch("/api/sites/current",{credentials:"same-origin"});if(!n.ok){n.status===404&&z&&(window.location.href="/admin/sites");return}let i=await n.json(),h=Ee(i.slug);ut(h,i.name),mt(h,{siteName:i.name,persist:!1})}catch(n){console.warn("[admin] Impossible de r\xE9cup\xE9rer le site actif",n)}};(()=>{if(J.slug){mt(J.slug,{siteName:J.name,persist:!1});return}let n=document.querySelector('[data-site-card][data-site-default="true"]')||kt[0];n&&mt(n.dataset.siteCard,{siteName:n.dataset.siteName||"",persist:!1})})(),ys(),z?Tt(z.slugValue):J.slug&&Tt(J.slug),cs.forEach(n=>{n.addEventListener("click",()=>{if(n.disabled)return;let i=n.dataset.siteSelect,h=n.dataset.siteSelectName||"Ce site";i&&(n.disabled=!0,hs(i,h).finally(()=>{n.disabled=!1}))})});let _e=n=>n.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),vs=n=>{let i=_e(n||"");return i?`/${i}`:""},bs=()=>{oe&&(dt=document.activeElement,oe.classList.remove("hidden"),oe.classList.add("flex"),ct=!1,Ce==null||Ce.reset(),ie&&(ie.textContent=""),xe&&(xe.textContent=""),be&&pe&&(be.value=_e(pe.value)),document.addEventListener("keydown",Xt),window.setTimeout(()=>{pe==null||pe.focus()},0))},pt=()=>{oe&&(oe.classList.add("hidden"),oe.classList.remove("flex"),document.removeEventListener("keydown",Xt),ct=!1,Ce==null||Ce.reset(),ie&&(ie.textContent=""),xe&&(xe.textContent=""),dt==null||dt.focus())};ps.forEach(n=>{n.addEventListener("click",bs)}),fs.forEach(n=>{n.addEventListener("click",pt)}),oe==null||oe.addEventListener("click",n=>{n.target===oe&&pt()}),pe==null||pe.addEventListener("input",()=>{be&&(!ct||be.value.trim().length===0)&&(be.value=_e(pe.value))}),be==null||be.addEventListener("input",()=>{ct=!0,ie&&(ie.textContent="")});let xs=()=>new Set(Array.from(kt).map(n=>Ee(n.dataset.siteCard||"")));Ce==null||Ce.addEventListener("submit",async n=>{if(n.preventDefault(),!pe||!be)return;let i=(pe.value||"").trim(),h=be.value||"";h||(h=i);let f=vs(h);if(!i||!f){ie&&(ie.textContent="Nom et slug sont requis.");return}if(xs().has(f)){ie&&(ie.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}ie&&(ie.textContent=""),xe&&(xe.textContent=""),ze&&(ze.disabled=!0,ze.textContent="Cr\xE9ation...");try{let v=await fetch("/api/sites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:i,slug:f})});if(!v.ok){let W=await v.json().catch(()=>({})),w=W.message||"Impossible de cr\xE9er ce site.";xe&&(xe.textContent=w),W.field==="slug"&&ie&&(ie.textContent=w);return}let A=await v.json(),k=Ee((A==null?void 0:A.slug)||f),u=(A==null?void 0:A.name)||i;ut(k,u),pt();let R=encodeURIComponent(qe(k));window.location.href=`/admin/site/${R}/design`}catch(v){console.error("[admin] Impossible de cr\xE9er le site",v),xe&&(xe.textContent="Erreur inattendue. R\xE9essaie dans un instant.")}finally{ze&&(ze.disabled=!1,ze.textContent="Cr\xE9er")}}),window.addEventListener("keydown",n=>{n.key==="Escape"&&(oe&&!oe.classList.contains("hidden")&&pt(),Ae&&!Ae.classList.contains("hidden")&&Qt(),blockDeleteModal&&!blockDeleteModal.classList.contains("hidden")&&closeBlockDeleteModal(),blockLibraryOpen&&closeBlockLibrary())});function ws(){let n=window.location.pathname.match(/^\/admin\/site\/([^/]+)(?:\/([^/]+))?/);return n?{slugPart:decodeURIComponent(n[1]),slugValue:Ee(decodeURIComponent(n[1])),section:n[2]||"design"}:null}function Ss(){return document.querySelector("[data-page-list]")?"design":document.querySelector("[data-collection-list]")?"content":document.querySelector("[data-media-grid]")?"media":document.querySelector("[data-deploy-form]")?"deploy":null}function Ls(){if(!Ae){window.location.href="/admin/sites";return}Ae.classList.remove("hidden"),Ae.classList.add("flex")}function Qt(){Ae&&(Ae.classList.add("hidden"),Ae.classList.remove("flex"))}ds.forEach(n=>{n.addEventListener("click",Ls)}),us.forEach(n=>{n.addEventListener("click",Qt)}),It==null||It.addEventListener("click",()=>{window.location.href="/admin/sites"});let Ye=(z==null?void 0:z.section)||Ss();Ye==="design"&&Cs(),Ye==="content"&&Es(),Ye==="media"&&Is(),Ye==="deploy"&&qs(),Ye==="settings"&&ks(),z&&J.name&&Zt(J.name);function Cs(){let n=document.querySelectorAll("[data-page-list]");if(n.length===0)return;let i=document.querySelector("[data-active-page-title]"),h=document.querySelector("[data-active-page-slug]"),f=document.querySelector("[data-page-preview-tags]"),b=document.querySelector("[data-page-preview-frame]"),v=document.querySelector("[data-preview-open]"),A=document.querySelector("[data-preview-status]"),k=document.querySelector("[data-preview-highlight]"),u=document.querySelector("[data-blocks-list]"),R=document.querySelector("[data-blocks-empty]"),W=document.querySelector("[data-block-count]"),w=document.querySelector("[data-block-library-toggle]"),x=document.querySelector("[data-block-library]"),I=document.querySelectorAll("[data-block-add]"),m=document.querySelector("[data-block-delete-modal]"),D=document.querySelector("[data-block-delete-confirm]"),Y=document.querySelector("[data-block-delete-cancel]"),j=document.querySelector("[data-block-detail-empty]"),K=document.querySelector("[data-block-detail-status]"),N=document.querySelector("[data-block-editor]"),ce=document.querySelector("[data-block-editor-block-name]"),G=document.querySelector("[data-block-editor-block-type]"),M=document.querySelector("[data-block-editor-unsupported]"),y=document.querySelector("[data-block-form]"),U=y?Array.from(y.querySelectorAll("[data-editor-section]")):[],L=y==null?void 0:y.querySelector('[name="collection-grid-collection"]'),H=y==null?void 0:y.querySelector("[data-collection-selection-info]"),P=document.querySelector("[data-block-form-cancel]"),V=y==null?void 0:y.querySelector("[data-group-preview-mobile]"),l=y==null?void 0:y.querySelector("[data-group-preview-desktop]"),d={hero:{section:"hero",labelField:"title",descriptionField:"subtitle",fields:{title:"hero-title",subtitle:"hero-subtitle",ctaLabel:"hero-cta-label",ctaUrl:"hero-cta-url",image:"hero-image",align:"hero-align"}},paragraphe:{section:"paragraph",labelField:"title",descriptionField:"content",fields:{title:"paragraph-title",content:"paragraph-content",align:"paragraph-align"}},image:{section:"image",labelField:"alt",fields:{src:"image-src",alt:"image-alt",showCaption:"image-caption-toggle",caption:"image-caption"}},groupe:{section:"group",fields:{layout:"group-layout",columnsMobile:"group-columns-mobile",columnsDesktop:"group-columns-desktop"}},collectiongrid:{section:"collection",fields:{collectionId:"collection-grid-collection",limit:"collection-grid-limit"}}},B={texte:"paragraphe",paragraph:"paragraphe",paragraphs:"paragraphe",paragraphes:"paragraphe",text:"paragraphe",hero:"hero",image:"image",groupe:"groupe",group:"groupe",collection:"collectiongrid",collectiongrid:"collectiongrid","collection-grid":"collectiongrid"},Z=(e,t)=>{if(!V||!l)return;let s=a=>Array.from({length:Number(a)||1}).map(()=>'<span class="block h-2 w-full rounded-full bg-slate-300"></span>').join("");V.innerHTML=s(e),l.innerHTML=s(t)},le=async()=>{if(!o)return[];let e=await fetch(o,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les pages.");let t=await e.json().catch(()=>[]);return Array.isArray(t)?t:[]},fe=async({title:e,slug:t})=>{if(!o)throw new Error("Site inconnu.");let s=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,slug:t})});if(!s.ok){let a=await s.json().catch(()=>({}));throw new Error(a.message||"Impossible de cr\xE9er la page.")}return s.json().catch(()=>({}))},Be=async e=>{if(!(!o||!(e!=null&&e.id)))try{let t=await fetch(`${o}/${encodeURIComponent(e.id)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let a=await t.json().catch(()=>({}));throw new Error(a.message||"Impossible de sauvegarder la page.")}let s=await t.json().catch(()=>({}));if(s!=null&&s.id){let a=nt(s);return ae=ae.map(g=>g.id===a.id?a:g),(q==null?void 0:q.id)===a.id&&(q=a),a}return s}catch(t){console.error("[design] Save page failed",t),F(t.message||"Sauvegarde impossible.")}},ge=async()=>{if(!o){ae=[],Se=null,q=null,jt(ae,Se),Qe(null),j==null||j.classList.remove("hidden"),N==null||N.classList.add("hidden");return}try{let e=await le();if(ae=(Array.isArray(e)?e:[]).map(t=>nt(t)),ae.length===0){Se=null,q=null,jt(ae,Se),Qe(null),j==null||j.classList.remove("hidden"),N==null||N.classList.add("hidden"),b&&(b.srcdoc=Q());return}Se=Re(ae),Ne(Se)}catch(e){console.error("[design] Impossible de charger les pages",e),F("Impossible de charger les pages.")}},ke=e=>(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),he=e=>{if(!e)return null;let t=ke(e.type),s=B[t]||t;return d[s]||null},we=e=>{var s,a,g;if(!y||!N)return;e&&!e.settings&&(e.settings={});let t=he(e);if(ce&&(ce.textContent=(e==null?void 0:e.label)||"Bloc"),G&&(G.textContent=(e==null?void 0:e.type)||"Bloc"),!t){y.classList.add("hidden"),M==null||M.classList.remove("hidden"),y.dataset.blockId="";return}if(M==null||M.classList.add("hidden"),y.classList.remove("hidden"),y.reset(),y.dataset.blockId=e.id,U.forEach(C=>{C.dataset.editorSection===t.section?C.classList.remove("hidden"):C.classList.add("hidden")}),t.section==="collection"){let C=e.collectionId||((s=e.settings)==null?void 0:s.collectionId)||"";wt(C)}if(Object.entries(t.fields).forEach(([C,O])=>{var Ue;let _=y.querySelector(`[name="${O}"]`);if(!_)return;let ne=(Ue=e.settings)==null?void 0:Ue[C];_.type==="checkbox"?_.checked=!!ne:_.type==="number"?_.value=ne!=null?ne:1:(_.tagName,_.value=ne!=null?ne:"")}),t.section==="group"){let C=((a=y.querySelector('[name="group-columns-mobile"]'))==null?void 0:a.value)||"1",O=((g=y.querySelector('[name="group-columns-desktop"]'))==null?void 0:g.value)||"3";Z(C,O)}},Te=e=>{if(!y||!e)return{};let t={};return Object.entries(e.fields).forEach(([s,a])=>{let g=y.querySelector(`[name="${a}"]`);if(g)if(g.type==="checkbox")t[s]=g.checked;else if(g.type==="number"){let C=Number(g.value);t[s]=Number.isFinite(C)?C:0}else g.tagName==="TEXTAREA"?t[s]=g.value||"":g.type==="select-one"?t[s]=g.value:t[s]=g.value||""}),t},X=e=>{if(A){if(!e){A.classList.add("hidden");return}A.classList.remove("hidden"),A.textContent=e}},Me=e=>e?{id:e.id,title:e.title,slug:e.slug,badges:[...e.badges||[]],blocks:(e.blocks||[]).map(t=>{var s;return{id:t.id,type:t.type,label:t.label,status:t.status,description:t.description,props:t.props||[],settings:t.settings||{},collectionId:t.collectionId||((s=t.settings)==null?void 0:s.collectionId)||""}})}:null,Q=()=>'<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#475569;background:#fff;">Pr\xE9paration de la pr\xE9visualisation\u2026</body></html>',$e=e=>{if(!b||!e)return;let t=(z==null?void 0:z.slugValue)||J.slug||"",s={page:Me(e),site:{title:J.name||"Site",slug:t}};Rt=!1,X("Actualisation\u2026"),b.srcdoc=Q(),st&&st.abort();let a=new AbortController;st=a,fetch("/api/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s),signal:a.signal}).then(g=>{if(!g.ok)throw new Error("Preview error");return g.json()}).then(g=>{a.signal.aborted||(Dt=g.html||"",b.setAttribute("title",`Pr\xE9visualisation de la page ${e.title||""}`.trim()),b.srcdoc=Dt||Q(),X("\xC0 jour"))}).catch(g=>{a.signal.aborted||(console.error("[preview] Impossible de rendre la page",g),X("Erreur preview"),b.srcdoc='<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#be123c;background:#fff;">Erreur lors du rendu de la pr\xE9visualisation.</body></html>')}).finally(()=>{st===a&&(st=null)})},Pe=e=>{if(e.preventDefault(),!q||!re)return;let t=Ft(),s=he(t);if(!t||!s)return;let a=Te(s);if(s.section==="collection"){if(!a.collectionId){F("S\xE9lectionnez une collection.");return}a.limit=Math.max(1,Number(a.limit)||1)}let g=(q.blocks||[]).map(C=>{if(C.id!==t.id)return C;let O={...C.settings||{},...a},_={...C,settings:O};return s.labelField&&a[s.labelField]&&(_.label=a[s.labelField]),s.descriptionField&&a[s.descriptionField]&&(_.description=a[s.descriptionField]),s.section==="collection"&&(_.collectionId=a.collectionId,_.settings.collectionId=a.collectionId,_.settings.limit=a.limit),_});et(g),F("Bloc mis \xE0 jour"),Ne(q.id,{preserveBlock:!0})},ye=document.querySelector("[data-page-drawer]"),te=document.querySelector("[data-page-drawer-backdrop]"),He=document.querySelectorAll("[data-page-drawer-open]"),je=document.querySelectorAll("[data-page-drawer-close]"),ue=document.querySelector("[data-add-page-toggle]"),se=document.querySelector("[data-add-page-form]"),r=document.querySelector("[data-add-page-title]"),c=document.querySelector("[data-add-page-slug]"),T=document.querySelector("[data-add-page-cancel]"),S=document.querySelector("[data-add-page-error]"),me=se==null?void 0:se.querySelector('[type="submit"]'),Oe=qe((z==null?void 0:z.slugValue)||J.slug||"default")||"default",ft=(z==null?void 0:z.slugValue)||J.slug||"",De=qe(ft)||"",o=De?`/api/sites/${encodeURIComponent(De)}/pages`:null,p=De?`/api/sites/${encodeURIComponent(De)}/collections`:null,E={active:`clower:activePage:${Oe}`},$=(e,t,s,a,g,C=[],O={})=>{let _={id:e,label:t,type:s,status:a,description:g,props:C,settings:{...O}};return _.settings.collectionId&&(_.collectionId=_.settings.collectionId),_},ee={hero:{type:"Hero",label:"Hero de page",description:"Section pleine largeur avec CTA principal.",status:"Brouillon",props:[{label:"CTA",value:"D\xE9couvrir"},{label:"Hauteur",value:"80vh"}],settings:{title:"Titre du hero",subtitle:"",ctaLabel:"D\xE9couvrir",ctaUrl:"#",image:"",align:"center"}},paragraph:{type:"Paragraphe",label:"Bloc \xE9ditorial",description:"Paragraphe libre pour raconter votre histoire.",status:"Brouillon",props:[{label:"Longueur",value:"150 mots"}],settings:{title:"Titre du paragraphe",content:"",align:"left"}},image:{type:"Image",label:"Bloc image",description:"Visuel seul avec l\xE9gende optionnelle.",status:"Brouillon",props:[{label:"Ratio",value:"16:9"},{label:"L\xE9gende",value:"Inactive"}],settings:{src:"",alt:"",showCaption:!1,caption:""}},group:{type:"Groupe",label:"Groupe de sections",description:"Conteneur pour imbriquer plusieurs sous-blocs.",status:"Brouillon",props:[{label:"Disposition",value:"Verticale"}],settings:{layout:"grid",columnsMobile:"1",columnsDesktop:"3"}},collectiongrid:{type:"CollectionGrid",label:"Grille de contenus",description:"Affiche automatiquement les items d\u2019une collection.",status:"Brouillon",settings:{collectionId:"",limit:6}}},Ke=e=>{try{window.localStorage.setItem(E.active,e)}catch{}},Re=e=>{var t;try{let s=window.localStorage.getItem(E.active);if(s&&e.some(a=>a.id===s))return s}catch{}return((t=e[0])==null?void 0:t.id)||null},Fe=e=>!e||e<=0?"0 bloc":e===1?"1 bloc":`${e} blocs`,Xe=e=>{if(!e||e==="/")return"/";let t=_e(e.replace(/^\//,""));return t?`/${t}`:"/"},Ve=(e="page",t="block")=>`${e}-${t}-${Date.now().toString(36)}-${Math.floor(Math.random()*1e3)}`,$t=(e,t)=>[$(Ve(e,"intro"),"Introduction","Paragraphe","Brouillon",`Paragraphe introductif pour "${t}".`,[{label:"Longueur",value:"2 paragraphes"}],{title:`Introduction \xE0 ${t}`,content:"Ajoutez votre premier paragraphe de pr\xE9sentation.",align:"left"}),$(Ve(e,"content"),"Zone de contenu","Groupe","Brouillon","Section principale \xE0 composer avec textes et visuels.",[{label:"Colonnes",value:"Auto"}],{layout:"grid",columnsMobile:"1",columnsDesktop:"2"})],gt=e=>{i&&(i.textContent=(e==null?void 0:e.title)||"Page"),h&&(h.textContent=(e==null?void 0:e.slug)||"/")},As=e=>{if(!f)return;f.innerHTML="",(e&&e.badges&&e.badges.length>0?e.badges:["Structure en cours"]).forEach(s=>{let a=document.createElement("span");a.className="rounded-full bg-slate-100 px-3 py-1",a.textContent=s,f.appendChild(a)})},Bs=e=>{switch((e||"").toLowerCase()){case"en ligne":return"bg-emerald-50 text-emerald-700";case"brouillon":return"bg-amber-50 text-amber-700";default:return"bg-slate-100 text-slate-600"}},ht=e=>{if(!(!j||!N)){if(!e){j.classList.remove("hidden"),N.classList.add("hidden"),M==null||M.classList.add("hidden"),y==null||y.classList.add("hidden"),K==null||K.classList.add("hidden");return}j.classList.add("hidden"),N.classList.remove("hidden"),K&&(e.status?(K.textContent=e.status,K.className=`rounded-full px-3 py-1 text-xs font-semibold ${Bs(e.status)}`,K.classList.remove("hidden")):K.classList.add("hidden")),we(e)}},Ze=e=>{if(!b)return;let t=b.contentDocument;if(!t)return;t.querySelectorAll("[data-preview-block]").forEach(a=>{a.dataset.previewBlock===e?(a.classList.add("preview-block-active"),Rt&&e&&a.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})):a.classList.remove("preview-block-active")}),k&&(k.style.borderColor=e?"rgba(156, 107, 255, 0.5)":"transparent")},Qe=e=>{if(!u)return;u.innerHTML="";let t=(e==null?void 0:e.blocks)||[];if(W&&(W.textContent=Fe(t.length)),t.length===0){u.classList.add("hidden"),R==null||R.classList.remove("hidden");return}u.classList.remove("hidden"),R==null||R.classList.add("hidden"),t.forEach(s=>{var rs;let a=s.id===re,g=document.createElement("div");g.dataset.blockItem="true",g.dataset.blockId=s.id,g.setAttribute("role","option"),g.setAttribute("aria-selected",a?"true":"false"),g.tabIndex=0,g.className=["relative flex items-center gap-3 rounded-2xl border px-3 py-2 text-left transition",a?"bg-slate-100 border-[#9C6BFF]/40 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let C=document.createElement("span");C.className=`absolute inset-y-2 left-0 w-1 rounded-full bg-[#9C6BFF] ${a?"":"hidden"}`,g.appendChild(C);let O=document.createElement("div");O.className="flex flex-1 items-center gap-3";let _=document.createElement("div");_.className="hidden lg:flex cursor-grab flex-shrink-0 items-center text-lg text-slate-400",_.innerHTML="&#8801;",O.appendChild(_);let ne=document.createElement("div");ne.className="flex-1";let Ue=document.createElement("div");Ue.className="flex items-center gap-2 text-[11px] uppercase tracking-wide text-slate-500";let zt=document.createElement("span");zt.className="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600",zt.textContent=s.type;let Ht=document.createElement("span");Ht.className="text-slate-400",Ht.textContent=s.status,Ue.appendChild(zt),Ue.appendChild(Ht);let Ot=document.createElement("p");Ot.className="mt-1 text-sm font-semibold text-slate-900";let Gs=s.settings&&s.settings.title||s.label||"Bloc sans titre";if(Ot.textContent=Gs,ne.appendChild(Ue),ne.appendChild(Ot),(s.type||"").toLowerCase()==="collectiongrid"&&s.collectionId){let ve=((rs=Le.find(_s=>_s.id===s.collectionId))==null?void 0:rs.name)||s.collectionId,Vt=document.createElement("p");Vt.className="text-xs text-slate-400",Vt.textContent=`Collection : ${ve}`,ne.appendChild(Vt)}O.appendChild(ne),g.appendChild(O);let St=document.createElement("div");St.className="flex flex-col gap-1 text-xs text-slate-400";let Lt=document.createElement("div");Lt.className="flex items-center gap-1 lg:hidden";let ot=document.createElement("button");ot.type="button",ot.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",ot.textContent="\u2191",ot.addEventListener("click",ve=>{ve.stopPropagation(),es(s.id,-1)});let at=document.createElement("button");at.type="button",at.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",at.textContent="\u2193",at.addEventListener("click",ve=>{ve.stopPropagation(),es(s.id,1)}),Lt.appendChild(ot),Lt.appendChild(at),St.appendChild(Lt);let rt=document.createElement("button");rt.type="button",rt.className="inline-flex items-center justify-center rounded-lg border border-transparent px-2 py-1 text-[12px] text-rose-500 hover:text-rose-700",rt.innerHTML="\u{1F5D1}\uFE0F",rt.addEventListener("click",ve=>{ve.stopPropagation(),Ns(s.id)}),St.appendChild(rt),g.appendChild(St),g.addEventListener("click",()=>{Je(s.id)}),g.addEventListener("keydown",ve=>{(ve.key==="Enter"||ve.key===" ")&&(ve.preventDefault(),Je(s.id))}),u.appendChild(g)})},jt=(e,t)=>{n.forEach(s=>{s.innerHTML="",e.forEach(a=>{let g=document.createElement("li"),C=document.createElement("button");C.type="button",C.dataset.pageId=a.id,C.className=["w-full flex items-center justify-between gap-3 px-3 py-2 text-left transition",t===a.id?"bg-[#9C6BFF]/10 text-slate-900 border border-[#9C6BFF]/40 rounded-xl shadow-sm":"text-slate-700 hover:bg-slate-50 rounded-xl"].join(" "),t===a.id?C.setAttribute("aria-current","page"):C.removeAttribute("aria-current"),C.innerHTML=`
            <div class="flex items-center gap-3">
              <span class="flex h-9 w-9 items-center justify-center rounded-xl border border-slate-200 bg-white text-slate-500">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6.5 4.5h7l4 4v11a1 1 0 0 1-1 1h-10a1 1 0 0 1-1-1v-14a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
                  <path d="M13.5 4.5v4a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.4"/>
                </svg>
              </span>
              <div class="flex flex-col">
                <span class="text-sm font-semibold">${a.title}</span>
                <span class="text-xs text-slate-500">${a.slug}</span>
              </div>
            </div>
          `,C.addEventListener("click",()=>{Ne(a.id),Mt()||Pt()}),g.appendChild(C),s.appendChild(g)})})},Ft=()=>!q||!Array.isArray(q.blocks)?null:q.blocks.find(e=>e.id===re)||null,Je=e=>{if(!q)return;if(!e){re=null,Qe(q),ht(null),Ze(null);return}let t=q.blocks.find(s=>s.id===e)||q.blocks[0]||null;re=(t==null?void 0:t.id)||null,Qe(q),ht(t),Ze(re)},et=e=>{if(!q)return;let t={...q,blocks:e};Ms(t)},yt=()=>window.matchMedia("(min-width: 1024px)").matches;function es(e,t){if(!q||!e||!t)return;let s=[...q.blocks||[]],a=s.findIndex(O=>O.id===e);if(a<0)return;let g=a+t;if(g<0||g>=s.length)return;let[C]=s.splice(a,1);s.splice(g,0,C),et(s),Ne(q.id,{preserveBlock:!0}),Je(C.id)}function Ts(e,t){if(!q||!e||!t||e===t)return;let s=[...q.blocks||[]],a=s.findIndex(O=>O.id===e),g=s.findIndex(O=>O.id===t);if(a<0||g<0)return;let[C]=s.splice(a,1);s.splice(g,0,C),et(s),Ne(q.id,{preserveBlock:!0}),Je(C.id)}function ts(){if(!u)return;let e=yt();u.querySelectorAll("[data-block-item]").forEach(t=>{t.setAttribute("draggable",e?"true":"false")})}function vt(){x&&(x.classList.add("hidden"),tt=!1)}function $s(){x&&(x.classList.remove("hidden"),tt=!0)}function js(){tt?vt():$s()}function Fs(e){var C;if(!q||!e)return;let t=ee[e];if(!t)return;let s=(q.blocks||[]).filter(O=>O.type===t.type).length+1,a=$(Ve(q.id,e),`${t.label} ${s}`,t.type,t.status,t.description,t.props,t.settings||{});if((t.type||"").toLowerCase()==="collectiongrid"){let O=((C=Le[0])==null?void 0:C.id)||"";a.collectionId=O,a.settings.collectionId=O,a.settings.limit=a.settings.limit||6}let g=[...q.blocks||[],a];et(g),Ne(q.id,{preserveBlock:!0}),Je(a.id),vt(),F("Bloc ajout\xE9")}function ss(e){var a,g;if(!q)return;let t=(q.blocks||[]).filter(C=>C.id!==e),s=e===re?((a=t[0])==null?void 0:a.id)||null:re||((g=t[0])==null?void 0:g.id)||null;et(t),re=s,Ne(q.id,{preserveBlock:!0}),re?Je(re):(ht(null),Ze(null)),F("Bloc supprim\xE9")}function Nt(){m&&(m.classList.add("hidden"),m.classList.remove("flex"),xt=null)}function Ns(e){if(!m){ss(e);return}xt=e,m.classList.remove("hidden"),m.classList.add("flex")}let Ms=e=>{if(!e)return;let t=nt(e);ae=ae.map(s=>s.id===t.id?t:s),q=t,Be(t)},Ne=(e,t={})=>{var g,C;let s=ae.find(O=>O.id===e)||ae[0]||null;q=s?nt(s):null,Se=(s==null?void 0:s.id)||null,(!t.preserveBlock||!q||!q.blocks.some(O=>O.id===re))&&(re=((C=(g=q==null?void 0:q.blocks)==null?void 0:g[0])==null?void 0:C.id)||null),Se&&Ke(Se),jt(ae,Se),gt(q),As(q),$e(q),Qe(q),ht(Ft()),Ze(re),ts(),tt&&vt()},Mt=()=>window.matchMedia("(min-width: 1024px)").matches,ns=()=>{ye&&(Mt()?(ye.classList.add("is-open"),te==null||te.classList.add("hidden"),document.body.classList.remove("overflow-hidden")):ye.classList.remove("is-open"))},Ps=()=>{!ye||Mt()||(ye.classList.add("is-open"),te==null||te.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},Pt=()=>{ye&&(ye.classList.remove("is-open"),te==null||te.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))},Ds=()=>{!se||!ue||(se.classList.remove("hidden"),ue.classList.add("hidden"),S&&(S.textContent=""),bt=!1,r&&(r.value="",r.focus()),c&&(c.value=""))},os=()=>{!se||!ue||(se.classList.add("hidden"),ue.classList.remove("hidden"),S&&(S.textContent=""),bt=!1,se.reset())},Rs=()=>{!r||!c||bt&&c.value.trim().length>0||(c.value=Xe(r.value))},ae=[],Se=null,bt=!1,q=null,re=null,tt=!1,xt=null,Dt="",Rt=!1,st=null,Le=[],Us=e=>{let t={...e,props:Array.isArray(e.props)?e.props:[],settings:{...e.settings||{}}};return(t.type||"").toLowerCase()==="collectiongrid"&&(t.collectionId=t.collectionId||t.settings.collectionId||"",t.settings.collectionId=t.collectionId,t.settings.limit=t.settings.limit||6),t},nt=e=>({...e,blocks:(e.blocks||[]).map(t=>Us(t))}),zs=async()=>{if(!p){Le=[],wt();return}try{let e=await fetch(p,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les collections.");let t=await e.json().catch(()=>[]);Le=Array.isArray(t)?t:[];let s=(L==null?void 0:L.value)||"";wt(s)}catch(e){console.error("[design] collections load",e),F("Collections indisponibles."),Le=[],wt()}},Ut=e=>{if(!H)return;if(!e){H.textContent=Le.length?"S\xE9lectionnez une collection pour afficher ses informations.":"Aucune collection disponible. Ajoutez-en depuis l\u2019onglet Contenus.";return}let t=Le.find(a=>a.id===e);if(!t){H.textContent=`Collection ${e}`;return}let s=[];t.description&&s.push(t.description),t.type&&s.push(`Type\xA0: ${t.type}`),H.textContent=s.join(" \xB7 ")||`Collection ${t.name||t.id}`},wt=(e="")=>{if(L){if(L.innerHTML="",!Le.length){L.disabled=!0;let t=document.createElement("option");t.value="",t.textContent="Aucune collection disponible",L.appendChild(t),Ut("");return}if(L.disabled=!1,e&&!Le.some(t=>t.id===e)){let t=document.createElement("option");t.value=e,t.textContent=e,L.appendChild(t)}Le.forEach(t=>{let s=document.createElement("option");s.value=t.id;let a=t.name||t.id;s.textContent=t.type?`${a} \xB7 ${t.type}`:a,s.dataset.description=t.description||"",L.appendChild(s)}),e&&(L.value=e),Ut(L.value||"")}};zs(),ns(),He.forEach(e=>{e.addEventListener("click",Ps)}),je.forEach(e=>{e.addEventListener("click",Pt)}),te==null||te.addEventListener("click",Pt),window.addEventListener("resize",()=>{ns(),ts()}),ue==null||ue.addEventListener("click",Ds),T==null||T.addEventListener("click",os),r==null||r.addEventListener("input",Rs),c==null||c.addEventListener("input",()=>{S&&(S.textContent=""),bt=!0}),se==null||se.addEventListener("submit",async e=>{if(e.preventDefault(),!o){S&&(S.textContent="Aucun site s\xE9lectionn\xE9.");return}if(!r||!c)return;let t=r.value.trim(),s=Xe(c.value.trim()||t);if(!t||!s){S&&(S.textContent="Titre et slug sont requis.");return}S&&(S.textContent=""),me&&(me.disabled=!0,me.textContent="Cr\xE9ation...");try{let a=await fe({title:t,slug:s});if(!a||!a.id)throw new Error("R\xE9ponse invalide.");ae=[...ae,nt(a)],os(),F("Page cr\xE9\xE9e"),Ne(a.id)}catch(a){console.error("[design] create page failed",a),S&&(S.textContent=a.message||"Impossible de cr\xE9er la page.")}finally{me&&(me.disabled=!1,me.textContent="Cr\xE9er")}}),w==null||w.addEventListener("click",e=>{e.stopPropagation(),js()}),document.addEventListener("click",e=>{tt&&(x!=null&&x.contains(e.target)||w!=null&&w.contains(e.target)||vt())}),I.forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();let s=e.dataset.blockAdd;Fs(s)})}),Y==null||Y.addEventListener("click",()=>{Nt()}),D==null||D.addEventListener("click",()=>{xt&&ss(xt),Nt()}),m==null||m.addEventListener("click",e=>{e.target===m&&Nt()}),y==null||y.addEventListener("input",e=>{var s,a;let t=e.target;if(!(!t||!t.name)&&(t.name==="group-columns-mobile"||t.name==="group-columns-desktop")){let g=((s=y.querySelector('[name="group-columns-mobile"]'))==null?void 0:s.value)||"1",C=((a=y.querySelector('[name="group-columns-desktop"]'))==null?void 0:a.value)||"3";Z(g,C)}}),L==null||L.addEventListener("change",e=>{let t=e.target;Ut((t==null?void 0:t.value)||"")}),y==null||y.addEventListener("submit",Pe),P==null||P.addEventListener("click",e=>{e.preventDefault();let t=Ft();t&&we(t)}),b==null||b.addEventListener("load",()=>{Rt=!0,X("\xC0 jour"),Ze(re)}),v==null||v.addEventListener("click",()=>{let e=window.open("","_blank");if(!e)return;e.opener=null;let t=e.document;t.open(),t.write(Dt||Q()),t.close()});let Hs=e=>{let t=e.target.closest("[data-block-item]");!t||!yt()||(Ie=t.dataset.blockId||null,Ie&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",Ie),t.classList.add("opacity-50")))},as=()=>{u==null||u.querySelectorAll("[data-block-item]").forEach(e=>e.classList.remove("opacity-50","ring-2","ring-[#9C6BFF]/50"))},Os=()=>{Ie=null,as()},Vs=e=>{if(!Ie||!yt())return;let t=e.target.closest("[data-block-item]");!t||t.dataset.blockId===Ie||(e.preventDefault(),t.classList.add("ring-2","ring-[#9C6BFF]/50"))},Js=e=>{let t=e.target.closest("[data-block-item]");t&&t.classList.remove("ring-2","ring-[#9C6BFF]/50")},Ws=e=>{if(!Ie||!yt())return;e.preventDefault();let t=e.target.closest("[data-block-item]"),s=Ie;Ie=null,as();let a=(t==null?void 0:t.dataset.blockId)||null;a&&Ts(s,a)},Ie=null;u==null||u.addEventListener("dragstart",Hs),u==null||u.addEventListener("dragend",Os),u==null||u.addEventListener("dragover",Vs),u==null||u.addEventListener("dragleave",Js),u==null||u.addEventListener("drop",Ws),ge()}function Es(){var Oe,ft,De;let n=document.querySelector("[data-collection-list]");if(!n)return;let i=document.querySelector("[data-collection-empty]"),h=document.querySelector("[data-collection-items-empty]"),f=document.querySelector("[data-item-table-wrapper]"),b=document.querySelector("[data-item-table-body]"),v=document.querySelector("[data-collection-title]"),A=document.querySelector("[data-collection-description]"),k=document.querySelector("[data-collection-drawer]"),u=document.querySelector("[data-collection-drawer-backdrop]"),R=document.querySelectorAll("[data-collection-drawer-open]"),W=document.querySelectorAll("[data-collection-drawer-close]"),w=document.querySelector("[data-item-add]"),x=document.querySelector("[data-item-detail-empty]"),I=document.querySelector("[data-item-form]"),m=I?{title:I.querySelector('[name="item-title"]'),slug:I.querySelector('[name="item-slug"]'),excerpt:I.querySelector('[name="item-excerpt"]'),content:I.querySelector('[name="item-content"]'),image:I.querySelector('[name="item-image"]'),status:I.querySelector('[name="item-status"]')}:{},D=document.querySelector("[data-item-status-badge]"),Y=document.querySelector("[data-item-delete]"),j=document.querySelector("[data-item-delete-modal]"),K=document.querySelector("[data-item-delete-cancel]"),N=document.querySelector("[data-item-delete-confirm]"),ce=document.querySelector("[data-item-cancel]"),G=document.querySelector("[data-item-save]"),M="rounded-full px-3 py-1 text-xs font-semibold",y=qe((z==null?void 0:z.slugValue)||J.slug||""),U=y?`/api/sites/${encodeURIComponent(y)}/collections`:null,L=[],H=[],P=null,V=null,l=!1,d=!1,B=null,Z=()=>{k&&(k.classList.add("is-open"),k.style.transform="translateX(0)",u==null||u.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},le=()=>{k&&(k.classList.remove("is-open"),k.style.transform="",u==null||u.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))};R.forEach(o=>{o.addEventListener("click",Z)}),W.forEach(o=>{o.addEventListener("click",le)}),u==null||u.addEventListener("click",le);let fe=o=>{let p=(o||"").trim();if(!p)return"";if(p==="/")return"/";let $=p.replace(/^\//,"").split("/").map(ee=>_e(ee||"")).filter(ee=>ee.length>0);return $.length?`/${$.join("/")}`:""},Be=o=>{if(!o)return"\u2014";let p=new Date(o);return Number.isNaN(p.getTime())?"\u2014":p.toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"})},ge=()=>{let o=L.find(p=>p.id===P);v&&(v.textContent=(o==null?void 0:o.name)||"S\xE9lectionnez une collection"),A&&(A.textContent=(o==null?void 0:o.description)||"")},ke=o=>{h&&(h.textContent=o||(P?"Aucun item dans cette collection pour le moment.":"Choisissez une collection dans le panneau de gauche."))},he=()=>{I&&(I.classList.add("hidden"),I.dataset.itemId=""),x==null||x.classList.remove("hidden"),D&&(D.className=`hidden ${M}`,D.textContent=""),Y&&(Y.disabled=!0)},we=()=>{I&&(I.classList.remove("hidden"),x==null||x.classList.add("hidden"))},Te=()=>{w&&(w.disabled=!P,w.disabled?w.classList.add("opacity-60","pointer-events-none"):w.classList.remove("opacity-60","pointer-events-none"))},X=o=>{if(!D)return;if(!o){D.className=`hidden ${M}`,D.textContent="";return}let p=o.toLowerCase(),E="bg-slate-100 text-slate-600 border border-slate-200";p==="publi\xE9"||p==="publie"?E="bg-emerald-50 text-emerald-700 border border-emerald-100":p==="brouillon"&&(E="bg-amber-50 text-amber-700 border border-amber-100"),D.className=`${M} ${E}`,D.textContent=o},Me=()=>{if(n.innerHTML="",!L.length){i==null||i.classList.remove("hidden");return}i==null||i.classList.add("hidden"),L.forEach(o=>{let p=o.id===P,E=document.createElement("button");E.type="button",E.dataset.collectionId=o.id,E.className=["w-full rounded-xl border px-3 py-2 text-left transition focus:outline-none focus:ring-2 focus:ring-[#9C6BFF]/40",p?"bg-[#F7F0FF] border-[#9C6BFF]/40 text-slate-900":"border-slate-200 text-slate-700 hover:border-[#9C6BFF]/40"].join(" "),E.setAttribute("role","option"),p?E.setAttribute("aria-current","true"):E.removeAttribute("aria-current"),E.innerHTML=`
          <div class="flex items-center justify-between gap-2">
            <div>
              <p class="text-sm font-semibold">${o.name||o.id}</p>
              <p class="text-xs text-slate-500">${o.description||""}</p>
            </div>
            <span class="text-[11px] uppercase tracking-wide text-slate-400">${o.type||""}</span>
          </div>
        `,E.addEventListener("click",()=>{ue(o.id),window.matchMedia("(min-width: 1024px)").matches||le()}),n.appendChild(E)})},Q=()=>{if(b){if(b.innerHTML="",!H.length||!P){h==null||h.classList.remove("hidden"),ke(),f==null||f.classList.add("hidden");return}h==null||h.classList.add("hidden"),f==null||f.classList.remove("hidden"),H.forEach(o=>{let p=document.createElement("tr");p.dataset.itemId=o.id;let E=o.id===V&&!l;p.className=["cursor-pointer transition focus-within:bg-[#F7F0FF]/70 focus:outline-none",E?"bg-[#F7F0FF]/70":"hover:bg-slate-50"].join(" "),p.tabIndex=0,p.setAttribute("role","button"),E?p.setAttribute("aria-current","true"):p.removeAttribute("aria-current");let $=o.status||"Brouillon",ee=$.toLowerCase(),Ke=ee==="publi\xE9"||ee==="publie"?"bg-emerald-50 text-emerald-700 border border-emerald-100":"bg-amber-50 text-amber-700 border border-amber-100";p.innerHTML=`
          <td class="px-4 py-3 align-top">
            <div class="flex flex-col">
              <span class="text-sm font-semibold text-slate-900">${o.title||"Sans titre"}</span>
              <span class="text-xs text-slate-500">${o.summary||o.excerpt||""}</span>
            </div>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-600">${o.slug||""}</td>
          <td class="px-4 py-3 align-top">
            <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${Ke}">
              ${$}
            </span>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-500">${Be(o.updatedAt||o.createdAt)}</td>
        `;let Re=()=>{$e(o.id)};p.addEventListener("click",Re),p.addEventListener("keydown",Fe=>{(Fe.key==="Enter"||Fe.key===" ")&&(Fe.preventDefault(),Re())}),b.appendChild(p)})}},$e=o=>{let p=H.find(E=>E.id===o);p&&(V=p.id,l=!1,d=!0,Pe(p),Q())},Pe=o=>{if(!I||!o){he();return}we(),I.dataset.itemId=o.id,m.title&&(m.title.value=o.title||""),m.slug&&(m.slug.value=o.slug||""),m.excerpt&&(m.excerpt.value=o.summary||o.excerpt||""),m.content&&(m.content.value=o.content||""),m.image&&(m.image.value=o.image||""),m.status&&(m.status.value=o.status||"Brouillon"),X(o.status||"Brouillon"),Y&&(Y.disabled=!1)},ye=()=>{var o;I&&(l=!0,V=null,d=!1,I.dataset.itemId="",I.reset(),m.status&&(m.status.value="Brouillon"),m.slug&&(m.slug.value=""),X("Brouillon"),we(),Y&&(Y.disabled=!0),(o=m.title)==null||o.focus())},te=()=>{var Re,Fe,Xe,Ve,$t,gt;let o=(((Re=m.title)==null?void 0:Re.value)||"").trim(),p=(((Fe=m.slug)==null?void 0:Fe.value)||"").trim(),E=(((Xe=m.excerpt)==null?void 0:Xe.value)||"").trim(),$=(((Ve=m.content)==null?void 0:Ve.value)||"").trim(),ee=((($t=m.image)==null?void 0:$t.value)||"").trim(),Ke=((gt=m.status)==null?void 0:gt.value)||"Brouillon";return{title:o,slug:fe(p||o),summary:E,excerpt:E,content:$,image:ee,status:Ke}},He=o=>{G&&(G.disabled=o,G.textContent=o?"Enregistrement\u2026":"Enregistrer"),Y&&!l&&V&&(Y.disabled=o)},je=async o=>{if(!U)return[];let p=await fetch(`${U}/${encodeURIComponent(o)}/items`,{headers:{Accept:"application/json"}});if(!p.ok){let $=await p.json().catch(()=>({}));throw new Error($.message||"Impossible de charger les items.")}let E=await p.json().catch(()=>({}));return Array.isArray(E.items)?E.items:[]},ue=async o=>{if(o&&(P=o,V=null,l=!1,d=!1,ge(),Te(),Me(),he(),H=[],Q(),ke("Chargement des items\u2026"),h==null||h.classList.remove("hidden"),f==null||f.classList.add("hidden"),!!U))try{H=await je(o),Q(),H.length||ke()}catch(p){console.error("[content] items failed",p),F(p.message||"Impossible de charger les items."),H=[],Q()}},se=async(o,p)=>{if(!U)throw new Error("Site inconnu.");let E=await fetch(`${U}/${encodeURIComponent(o)}/items`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});if(!E.ok){let $=await E.json().catch(()=>({}));throw new Error($.message||"Impossible de cr\xE9er cet item.")}return E.json()},r=async(o,p,E)=>{if(!U)throw new Error("Site inconnu.");let $=await fetch(`${U}/${encodeURIComponent(o)}/items/${encodeURIComponent(p)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(E)});if(!$.ok){let ee=await $.json().catch(()=>({}));throw new Error(ee.message||"Impossible de sauvegarder cet item.")}return $.json()},c=async(o,p)=>{if(!U)throw new Error("Site inconnu.");let E=await fetch(`${U}/${encodeURIComponent(o)}/items/${encodeURIComponent(p)}`,{method:"DELETE"});if(!E.ok){let $=await E.json().catch(()=>({}));throw new Error($.message||"Impossible de supprimer cet item.")}},T=async()=>{var o;if(!U){i==null||i.classList.remove("hidden"),P=null,H=[],Q(),ge(),Te();return}try{let p=await fetch(U,{headers:{Accept:"application/json"}});if(!p.ok)throw new Error("Impossible de charger les collections.");let E=await p.json().catch(()=>[]);if(L=Array.isArray(E)?E:[],Me(),L.length>0){let $=((o=L.find(ee=>ee.id===P))==null?void 0:o.id)||L[0].id;ue($)}else P=null,H=[],ge(),Te(),Q()}catch(p){console.error("[content] load collections",p),F(p.message||"Impossible de charger les collections.")}};w==null||w.addEventListener("click",()=>{if(!P){F("S\xE9lectionnez d\u2019abord une collection.");return}ye(),Q()}),ce==null||ce.addEventListener("click",o=>{if(o.preventDefault(),l){l=!1,V=null,he(),Q();return}if(V){let p=H.find(E=>E.id===V);Pe(p)}else he()}),(Oe=m.status)==null||Oe.addEventListener("change",()=>{X(m.status.value)}),(ft=m.title)==null||ft.addEventListener("input",()=>{!l||!m.slug||d||(m.slug.value=fe(m.title.value))}),(De=m.slug)==null||De.addEventListener("input",()=>{l&&(d=!0)}),I==null||I.addEventListener("submit",async o=>{var E;if(o.preventDefault(),!P){F("S\xE9lectionnez une collection.");return}let p=te();if(!p.title){F("Le titre est requis."),(E=m.title)==null||E.focus();return}He(!0);try{let $;l||!V?($=await se(P,p),H=[...H,$],F("Item cr\xE9\xE9")):($=await r(P,V,p),H=H.map(ee=>ee.id===$.id?$:ee),F("Item mis \xE0 jour")),l=!1,V=$.id,Pe($),Q()}catch($){console.error("[content] save item failed",$),F($.message||"Impossible de sauvegarder cet item.")}finally{He(!1)}});let S=()=>{j&&(j.classList.add("hidden"),j.classList.remove("flex"),B=null)},me=()=>{!j||!V||(B=V,j.classList.remove("hidden"),j.classList.add("flex"))};Y==null||Y.addEventListener("click",o=>{o.preventDefault(),V&&me()}),K==null||K.addEventListener("click",()=>{S()}),j==null||j.addEventListener("click",o=>{o.target===j&&S()}),N==null||N.addEventListener("click",async()=>{if(!B||!P){S();return}N.disabled=!0,N.textContent="Suppression\u2026";try{await c(P,B),H=H.filter(o=>o.id!==B),V===B&&(V=null,he()),F("Item supprim\xE9"),Q()}catch(o){console.error("[content] delete item failed",o),F(o.message||"Impossible de supprimer cet item.")}finally{N.disabled=!1,N.textContent="Supprimer",S()}}),ge(),Te(),T()}function qs(){let n=document.querySelector("[data-deploy-form]");if(!n)return;let i=document.querySelector("[data-deploy-protocol]"),h=document.querySelector("[data-deploy-host]"),f=document.querySelector("[data-deploy-port]"),b=document.querySelector("[data-deploy-user]"),v=document.querySelector("[data-deploy-password]"),A=document.querySelector("[data-deploy-show-password]"),k=document.querySelector("[data-deploy-remote-path]"),u=document.querySelector("[data-deploy-feedback]"),R=document.querySelector("[data-deploy-save]"),W=document.querySelector("[data-deploy-test]"),w=document.querySelector("[data-deploy-trigger]"),x=document.querySelector("[data-deploy-history]"),I=document.querySelector("[data-deploy-log]"),m=qe((z==null?void 0:z.slugValue)||J.slug||""),D=m?`/api/sites/${encodeURIComponent(m)}/deploy-config`:null,Y=m?`/api/sites/${encodeURIComponent(m)}/deploy`:null,j=m?`/api/sites/${encodeURIComponent(m)}/deploy-log`:null,K=!1,N=null,ce=l=>{let d=(l||"").trim();return d?d.startsWith("/")?d:`/${d}`:"/www"},G=(l,d="muted")=>{if(!u)return;let B="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold",Z=d==="success"?"bg-emerald-50 text-emerald-700 border border-emerald-100":d==="error"?"bg-rose-50 text-rose-700 border border-rose-100":"bg-slate-50 text-slate-600 border border-slate-100";if(!l){u.textContent="",u.className="text-sm text-slate-500";return}let le=d==="success"?"\u2705":d==="error"?"\u274C":"\u2139\uFE0F";u.innerHTML=`<span class="${B} ${Z}">${le}<span>${l}</span></span>`,u.className="text-sm"},M=(l=null)=>{N=l;let d=!!l,B='<svg class="h-4 w-4 animate-spin text-white" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>';R&&(R.disabled=d,R.innerHTML=l==="save"?`<span class="inline-flex items-center gap-2">${B}<span>Enregistrement\u2026</span></span>`:"Enregistrer"),W&&(W.disabled=d,W.innerHTML=l==="test"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-slate-200 border-t-slate-600"></span><span>Test en cours\u2026</span></span>':"Tester la connexion"),w&&(w.disabled=d&&l!==null,w.innerHTML=l==="deploy"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-white/60 border-t-white"></span><span>D\xE9ploiement\u2026</span></span>':"D\xE9ployer maintenant")},y=l=>{i&&(i.value=l.protocol||"sftp"),h&&(h.value=l.host||""),f&&(f.value=l.port||""),b&&(b.value=l.user||""),k&&(k.value=l.remotePath||"/www"),K=!!l.hasPassword,v&&(v.value="",v.placeholder=K?"Non affich\xE9":"Mot de passe")},U=(l=[])=>{if(x){if(x.innerHTML="",!l.length){let d=document.createElement("li");d.className="text-slate-500",d.textContent="Aucun d\xE9ploiement pour le moment.",x.appendChild(d);return}l.forEach(d=>{let B=document.createElement("li");B.className="flex items-center justify-between gap-2 rounded-xl border border-slate-200 px-3 py-2";let Z=d.status==="success"?'<span class="rounded-full bg-emerald-50 px-2 py-0.5 text-[11px] font-semibold text-emerald-700">Succ\xE8s</span>':'<span class="rounded-full bg-rose-50 px-2 py-0.5 text-[11px] font-semibold text-rose-700">\xC9chec</span>',le=d.finishedAt||d.startedAt||"",fe=d.durationMs&&Number(d.durationMs)>=0?`${Math.round(Number(d.durationMs)/1e3)}s`:"";B.innerHTML=`
          <div class="space-y-1">
            <div class="flex items-center gap-2">${Z}<span class="text-xs text-slate-500">${le}</span></div>
            <p class="text-sm text-slate-800">${d.message||""}</p>
          </div>
          <div class="text-xs text-slate-500">${fe}</div>
        `,B.dataset.deployId=d.id||"",B.addEventListener("click",()=>{d.logs&&I&&(I.textContent=d.logs.join(`
`))}),x.appendChild(B)})}},L=(l=[])=>{I&&(I.textContent=l.length?l.join(`
`):"Aucun log pour le moment.")},H=async()=>{var l;if(j)try{let d=await fetch(j,{headers:{Accept:"application/json"}});if(!d.ok){if(d.status===404){U([]),L(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw new Error("Impossible de charger l\u2019historique.")}let B=await d.json().catch(()=>({})),Z=Array.isArray(B.entries)?B.entries:[];U(Z),(l=Z[0])!=null&&l.logs&&L(Z[0].logs)}catch(d){console.error("[deploy] history failed",d)}},P=async()=>{if(!D){G("Aucun site actif s\xE9lectionn\xE9.","error");return}M("load");try{let l=await fetch(D,{headers:{Accept:"application/json"}}),d=await l.json().catch(()=>({}));l.ok?(y(d||{}),G("Configuration charg\xE9e.","muted")):(y(d||{}),G(d.message||"Configuration par d\xE9faut charg\xE9e.","muted"))}catch(l){console.error("[deploy] load failed",l),G(l.message||"Erreur lors du chargement.","error")}finally{M(null)}},V=()=>{let l={protocol:(i==null?void 0:i.value)||"sftp",host:(h==null?void 0:h.value.trim())||"",port:Number(f==null?void 0:f.value)||void 0,user:(b==null?void 0:b.value.trim())||"",remotePath:ce((k==null?void 0:k.value)||"/www")},d=(v==null?void 0:v.value)||"";return d.trim().length>0&&(l.password=d),l};n.addEventListener("submit",async l=>{if(l.preventDefault(),!D){G("Aucun site actif s\xE9lectionn\xE9.","error");return}let d=V();M("save");try{let B=await fetch(D,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(!B.ok){let le=await B.json().catch(()=>({}));throw new Error(le.message||"Sauvegarde impossible.")}let Z=await B.json();y(Z||{}),G("Configuration enregistr\xE9e.","success"),F("Configuration d\xE9ploiement sauvegard\xE9e")}catch(B){console.error("[deploy] save failed",B),G(B.message||"Erreur lors de la sauvegarde.","error")}finally{M(null)}}),W==null||W.addEventListener("click",async()=>{if(!D){G("Aucun site actif s\xE9lectionn\xE9.","error");return}let l=V();if(!l.host||!l.user||!l.remotePath){G("Remplissez les champs requis avant de tester.","error");return}M("test");try{let d=await fetch(`${D}/test`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}),B=await d.json().catch(()=>({}));if(!d.ok||B.success===!1){G(B.message||"Test de connexion \xE9chou\xE9.","error");return}G(B.message||"Connexion OK.","success"),F("Test de connexion r\xE9ussi")}catch(d){console.error("[deploy] test failed",d),G(d.message||"Test de connexion \xE9chou\xE9.","error")}finally{M(null)}}),w==null||w.addEventListener("click",async()=>{if(!Y){G("Aucun site actif s\xE9lectionn\xE9.","error");return}M("deploy"),L(["D\xE9ploiement en cours\u2026"]);try{let l=await fetch(Y,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(V())}),d=await l.json().catch(()=>({}));if(!l.ok){if(l.status===404){G("API d\xE9ploiement indisponible (red\xE9marre le serveur).","error"),L(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw L(d.logs||[]),new Error(d.message||"D\xE9ploiement \xE9chou\xE9.")}L(d.logs||[]),await H(),F("D\xE9ploiement termin\xE9")}catch(l){console.error("[deploy] run failed",l),G(l.message||"D\xE9ploiement \xE9chou\xE9.","error")}finally{M(null)}}),A==null||A.addEventListener("change",()=>{v&&(v.type=A.checked?"text":"password")}),P(),H()}function ks(){let n=document.querySelector("[data-admin-password-form]"),i=document.querySelector("[data-site-config-form]"),h=document.querySelector("[data-site-config-feedback]");if(n){let f=n.querySelector("[data-admin-password-feedback]"),b=n.querySelector("[data-admin-password-submit]"),v=(A,k="muted")=>{if(!f)return;let u=k==="success"?"text-emerald-600":k==="error"?"text-rose-600":"text-slate-500";f.textContent=A||"",f.className=`text-sm ${u}`};n.addEventListener("submit",async A=>{A.preventDefault();let k=new FormData(n),u=k.get("currentPassword")||"",R=k.get("newPassword")||"",W=k.get("confirmPassword")||"";if(!u||!R||!W){v("Compl\xE8te tous les champs.","error");return}b&&(b.disabled=!0),v("");try{let w=await fetch("/api/admin/password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({currentPassword:u,newPassword:R,confirmPassword:W})}),x=await w.json().catch(()=>({}));if(!w.ok||x.success===!1)throw new Error(x.message||"Impossible de mettre \xE0 jour le mot de passe.");v(x.message||"Mot de passe mis \xE0 jour.","success"),n.reset()}catch(w){console.error("[settings] change password failed",w),v(w.message||"Erreur lors de la mise \xE0 jour.","error")}finally{b&&(b.disabled=!1)}})}if(i){let f=i.querySelector("[data-site-name]"),b=i.querySelector("[data-site-language]"),v=i.querySelector("[data-site-tagline]"),A=i.querySelector("[data-site-save]"),k=(w,x="muted")=>{if(!h)return;let I=x==="success"?"text-emerald-600":x==="error"?"text-rose-600":"text-slate-500";h.textContent=w||"",h.className=`text-sm ${I}`},u=qe((z==null?void 0:z.slugValue)||J.slug||""),R=u?`/api/sites/${encodeURIComponent(u)}/config/site`:null,W=async()=>{if(R)try{let w=await fetch(R,{headers:{Accept:"application/json"}});if(!w.ok)return;let x=await w.json().catch(()=>({}));f&&(f.value=x.name||""),b&&(b.value=x.language||"fr"),v&&(v.value=x.tagline||"")}catch(w){console.error("[settings] load site config failed",w)}};i.addEventListener("submit",async w=>{if(w.preventDefault(),!R){k("Aucun site actif.","error");return}if(!(f!=null&&f.value.trim())){k("Nom requis.","error");return}A&&(A.disabled=!0),k("");try{let x={name:(f==null?void 0:f.value)||"",language:(b==null?void 0:b.value)||"fr",tagline:(v==null?void 0:v.value)||""},I=await fetch(R,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(x)}),m=await I.json().catch(()=>({}));if(!I.ok||m.success===!1)throw new Error(m.message||"Sauvegarde impossible.");k(m.message||"Param\xE8tres enregistr\xE9s.","success")}catch(x){console.error("[settings] save site config failed",x),k(x.message||"Erreur lors de la sauvegarde.","error")}finally{A&&(A.disabled=!1)}}),W()}}function Is(){let n=document.querySelector("[data-media-grid]");if(!n)return;let i=document.querySelector("[data-media-empty]"),h=document.querySelector("[data-media-count]"),f=document.querySelector("[data-media-filter-type]"),b=document.querySelector("[data-media-detail-empty]"),v=document.querySelector("[data-media-detail]"),A=document.querySelector("[data-media-detail-preview]"),k=document.querySelector("[data-media-detail-name]"),u=document.querySelector("[data-media-detail-type]"),R=document.querySelector("[data-media-detail-size]"),W=document.querySelector("[data-media-detail-path]"),w=document.querySelector("[data-media-detail-used]"),x=document.querySelector("[data-media-alt-edit]"),I=document.querySelector("[data-media-save]"),m=document.querySelector("[data-media-delete]"),D=document.querySelector("[data-media-delete-modal]"),Y=document.querySelector("[data-media-delete-cancel]"),j=document.querySelector("[data-media-delete-confirm]"),K=document.querySelector("[data-media-upload-open]"),N=document.querySelector("[data-media-file-input]"),ce=document.querySelector("[data-media-upload-status]"),G=qe((z==null?void 0:z.slugValue)||J.slug||""),M=G?`/api/sites/${encodeURIComponent(G)}/media`:null,y=[],U=[],L=null,H=null,P=null,V=!1,l=!1,d=!1,B=null,Z=r=>{let c=(r.type||"").toLowerCase(),T=(r.filename||"").toLowerCase();return c.includes("image")||/\.(png|jpe?g|webp|svg|gif)$/i.test(T)?"image":c.includes("pdf")||c.includes("doc")||/\.(pdf|docx?)$/i.test(T)?"document":c.includes("video")||/\.(mp4|mov|webm)$/i.test(T)?"video":"other"},le=r=>Z(r)==="image",fe=r=>{if(r.type)return r.type.toUpperCase();let c=(r.filename||"").split(".").pop();return c?c.toUpperCase():"FILE"},Be=r=>!r||r<=0?"\u2014":r<1024?`${r} o`:r<1024*1024?`${(r/1024).toFixed(1)} ko`:`${(r/(1024*1024)).toFixed(1)} Mo`,ge=()=>{v==null||v.classList.add("hidden"),b==null||b.classList.remove("hidden"),ke(),L=null,l=!1,X(!1),A&&(A.innerHTML='<span class="text-slate-400 text-sm">Aucun m\xE9dia s\xE9lectionn\xE9</span>'),k&&(k.textContent=""),u&&(u.textContent=""),R&&(R.textContent=""),x&&(x.value=""),W&&(W.textContent=""),w&&(w.innerHTML="")},ke=()=>{P=null,d=!1,V=!1,B&&(URL.revokeObjectURL(B),B=null),ce&&(ce.textContent="Aucun fichier s\xE9lectionn\xE9."),N&&(N.value="")},he=()=>{h&&(U.length?U.length===1?h.textContent="1 m\xE9dia":h.textContent=`${U.length} m\xE9dias`:h.textContent="0 m\xE9dia")},we=()=>{if(n.innerHTML="",!U.length){i==null||i.classList.remove("hidden"),ge();return}i==null||i.classList.add("hidden"),U.forEach(r=>{let c=document.createElement("button");c.type="button",c.dataset.mediaId=r.id;let T=r.id===L;c.className=["group relative flex flex-col rounded-2xl border px-3 py-3 text-left transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#9C6BFF]",T?"border-[#9C6BFF] bg-[#F7F0FF]/60 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let S=le(r)?`<img src="${r.path}" alt="${r.alt||r.filename}" class="h-full w-full object-cover" />`:'<div class="flex h-full w-full items-center justify-center text-3xl text-slate-400">\u{1F4C4}</div>';c.innerHTML=`
          <div class="relative aspect-[4/3] overflow-hidden rounded-xl bg-slate-100">
            ${S}
          </div>
          <div class="mt-2 space-y-1">
            <p class="text-sm font-semibold text-slate-900 truncate">${r.filename}</p>
            <p class="text-xs text-slate-500">
              ${fe(r)} \xB7 ${Be(r.size)}
            </p>
          </div>
        `,r.id===H&&(c.classList.add("ring-2","ring-[#9C6BFF]"),window.setTimeout(()=>{c.classList.remove("ring-2","ring-[#9C6BFF]")},1600)),c.addEventListener("click",()=>Me(r.id)),n.appendChild(c)}),H=null},Te=r=>{if(w){if(w.innerHTML="",!r.usedIn||r.usedIn.length===0){let c=document.createElement("li");c.textContent="Non utilis\xE9",c.className="text-xs text-slate-400",w.appendChild(c);return}r.usedIn.forEach(c=>{let T=document.createElement("li");T.textContent=c,T.className="text-xs text-slate-600",w.appendChild(T)})}},X=r=>{if(I){if(d){I.textContent=r?"T\xE9l\xE9versement\u2026":"T\xE9l\xE9verser",I.disabled=r||!P,m&&m.classList.add("hidden");return}I.textContent=r?"Enregistrement\u2026":"Enregistrer",I.disabled=r||!l,m&&(m.classList.remove("hidden"),m.disabled=!L)}},Me=r=>{let c=y.find(T=>T.id===r);if(!c){ge(),we();return}ke(),L=c.id,l=!1,X(!1),we(),b==null||b.classList.add("hidden"),v==null||v.classList.remove("hidden"),A&&(le(c)?A.innerHTML=`<img src="${c.path}" alt="${c.alt||c.filename}" class="h-full w-full rounded-2xl object-cover" />`:A.innerHTML='<div class="flex h-full w-full flex-col items-center justify-center gap-1 text-slate-400"><span class="text-3xl">\u{1F4C4}</span><span class="text-xs font-semibold">Document</span></div>'),k&&(k.textContent=c.filename||"Fichier"),u&&(u.textContent=fe(c)),R&&(R.textContent=Be(c.size)),x&&(x.value=c.alt||""),W&&(W.textContent=c.path||"\u2014"),Te(c)},Q=r=>{if(r){if(d=!0,l=!1,L=null,b==null||b.classList.add("hidden"),v==null||v.classList.remove("hidden"),B&&URL.revokeObjectURL(B),B=URL.createObjectURL(r),A&&(A.innerHTML=`<img src="${B}" alt="${r.name}" class="h-full w-full rounded-2xl object-cover" />`),k&&(k.textContent=r.name),u&&(u.textContent=fe({type:r.type,filename:r.name})),R&&(R.textContent=Be(r.size)),x&&!x.value.trim()&&(x.value=r.name.replace(/\.[^.]+$/,"").replace(/[-_]/g," ")),W&&(W.textContent="En attente de t\xE9l\xE9versement"),w){w.innerHTML="";let c=document.createElement("li");c.textContent="Non utilis\xE9",c.className="text-xs text-slate-400",w.appendChild(c)}X(!1)}},$e=()=>{let r=(f==null?void 0:f.value)||"all";r==="all"?U=[...y]:U=y.filter(c=>c.groupType===r),U.some(c=>c.id===L)||ge(),he(),we()},Pe=async()=>{if(!M){i==null||i.classList.remove("hidden");return}try{let r=await fetch(M,{headers:{Accept:"application/json"}});if(!r.ok)throw new Error("Impossible de charger les m\xE9dias.");let c=await r.json().catch(()=>({items:[]}));y=Array.isArray(c.items)?c.items.map(T=>({...T,groupType:Z(T)})):[],$e()}catch(r){console.error("[media] load failed",r),F(r.message||"Impossible de charger les m\xE9dias."),y=[],$e()}};f==null||f.addEventListener("change",()=>{$e()}),x==null||x.addEventListener("input",()=>{if(d){X(!1);return}L&&(l=!0,X(!1))});let ye=r=>{if(r){if(!r.type.startsWith("image/")){F("Seules les images sont accept\xE9es pour le moment.");return}if(r.size>4*1024*1024){F("Fichier trop volumineux (4 Mo max).");return}P=r,Q(r),ce&&(ce.textContent=`${r.name} \xB7 ${Be(r.size)}`)}},te=r=>new Promise((c,T)=>{let S=new FileReader;S.onload=()=>{let me=S.result||"",[,Oe=""]=String(me).split(",");c(Oe)},S.onerror=()=>T(new Error("Impossible de lire ce fichier.")),S.readAsDataURL(r)}),He=async()=>{if(!(!P||!M)){V=!0,X(!0);try{let r=await te(P),c={filename:P.name,type:P.type,size:P.size,alt:(x==null?void 0:x.value)||"",data:r},T=await fetch(M,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!T.ok){let me=await T.json().catch(()=>({}));throw new Error(me.message||"Upload impossible.")}let S=await T.json();S.groupType=Z(S),y=[...y,S],H=S.id,$e(),Me(S.id),F("M\xE9dia ajout\xE9"),ke()}catch(r){console.error("[media] upload failed",r),F(r.message||"Impossible de t\xE9l\xE9verser ce m\xE9dia.")}finally{V=!1,P=null,X(!1)}}};K==null||K.addEventListener("click",()=>N==null?void 0:N.click()),N==null||N.addEventListener("change",()=>{N.files&&N.files[0]&&ye(N.files[0])});let je=()=>{D&&(D.classList.add("hidden"),D.classList.remove("flex"))},ue=()=>{if(!(!L||d)){if(D){D.classList.remove("hidden"),D.classList.add("flex");return}window.confirm("Supprimer ce m\xE9dia ?")&&se()}},se=async()=>{if(!L||!M){je();return}let r=()=>{m&&(m.disabled=!0),j&&(j.disabled=!0,j.textContent="Suppression\u2026")},c=()=>{m&&(m.disabled=!1),j&&(j.disabled=!1,j.textContent="Supprimer")};r();try{let T=await fetch(`${M}/${encodeURIComponent(L)}`,{method:"DELETE"});if(!T.ok){let S=await T.json().catch(()=>({}));throw new Error(S.message||"Suppression impossible.")}y=y.filter(S=>S.id!==L),U=U.filter(S=>S.id!==L),F("M\xE9dia supprim\xE9"),ge(),he(),we()}catch(T){console.error("[media] delete failed",T),F(T.message||"Impossible de supprimer ce m\xE9dia.")}finally{c(),je()}};Y==null||Y.addEventListener("click",je),D==null||D.addEventListener("click",r=>{r.target===D&&je()}),j==null||j.addEventListener("click",()=>se()),m==null||m.addEventListener("click",ue),I==null||I.addEventListener("click",async()=>{if(d){He();return}if(!(!L||!M||!x)){X(!0);try{let r={alt:x.value||""},c=await fetch(`${M}/${encodeURIComponent(L)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!c.ok){let S=await c.json().catch(()=>({}));throw new Error(S.message||"Impossible de mettre \xE0 jour ce m\xE9dia.")}let T=await c.json();y=y.map(S=>S.id===L?{...S,...T}:S),U=U.map(S=>S.id===L?{...S,...T}:S),l=!1,X(!1),F("M\xE9dia mis \xE0 jour")}catch(r){console.error("[media] update failed",r),F(r.message||"\xC9chec de la mise \xE0 jour."),X(!1)}}}),Pe()}});})();
