(()=>{document.addEventListener("DOMContentLoaded",()=>{console.log("[admin] Atelier charg\xE9");let T=document.querySelector("[data-logout]");T&&T.addEventListener("click",async()=>{T.disabled=!0;try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(e){console.error("[admin] Impossible de se d\xE9connecter",e)}finally{window.location.href="/admin/login.html"}});let L=document.querySelector("[data-admin-sidebar]"),r=document.querySelector("[data-admin-sidebar-overlay]"),R=document.querySelectorAll("[data-admin-sidebar-toggle]"),X=document.querySelectorAll("[data-admin-sidebar-close]"),N=document.body,v=!1,C=()=>{if(!L)return;if(window.matchMedia("(min-width: 1024px)").matches){L.classList.remove("hidden"),r==null||r.classList.add("hidden"),N.classList.remove("overflow-hidden");return}v?(L.classList.remove("hidden"),r==null||r.classList.remove("hidden"),N.classList.add("overflow-hidden")):(L.classList.add("hidden"),r==null||r.classList.add("hidden"),N.classList.remove("overflow-hidden"))},Z=()=>{v=!0,C()},I=()=>{v=!1,C()};L&&R.length>0&&(R.forEach(e=>{e.addEventListener("click",Z)}),X.forEach(e=>{e.addEventListener("click",I)}),r==null||r.addEventListener("click",I),window.addEventListener("resize",C),window.addEventListener("keydown",e=>{e.key==="Escape"&&v&&I()}),C());let F="clower:currentSite",U="clower:currentSiteName",n={slug:null,name:""};(()=>{try{n.slug=window.localStorage.getItem(F),n.name=window.localStorage.getItem(U)||""}catch{n.slug=null,n.name=""}})();let pe={design:"design",content:"content",media:"media",deploy:"deploy",settings:"settings"},B=document.querySelectorAll("[data-site-card]"),ee=document.querySelectorAll("[data-site-select]"),b=document.querySelector("[data-current-site-name]"),_=document.querySelector("[data-workspace-site-name]"),V=document.querySelector("[data-workspace-back-name]"),g=document.querySelector("[data-workspace-back-modal]"),te=document.querySelectorAll("[data-workspace-back]"),se=document.querySelectorAll("[data-workspace-back-cancel]"),M=document.querySelector("[data-workspace-back-confirm]"),ae=document.querySelectorAll("[data-workspace-tab]"),j=document.querySelector("[data-site-toast]"),O=document.querySelector("[data-site-toast-message]"),ne=document.querySelectorAll("[data-site-create]"),i=document.querySelector("[data-site-modal]"),h=document.querySelector("[data-site-form]"),d=document.querySelector("[data-site-name]"),l=document.querySelector("[data-site-slug]"),c=document.querySelector("[data-site-slug-error]"),u=document.querySelector("[data-site-modal-error]"),oe=document.querySelectorAll("[data-site-modal-cancel]"),w=document.querySelector("[data-site-modal-submit]"),z=fe(),E=!1,k=null,D=null,ie='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',W=e=>{if(!i||i.classList.contains("hidden")||e.key!=="Tab")return;let t=Array.from(i.querySelectorAll(ie)).filter(p=>!p.hasAttribute("disabled")&&!p.getAttribute("aria-hidden"));if(t.length===0)return;let s=t[0],a=t[t.length-1];e.shiftKey?document.activeElement===s&&(e.preventDefault(),a.focus()):document.activeElement===a&&(e.preventDefault(),s.focus())},K=e=>{!j||!O||(O.textContent=e,j.classList.remove("hidden"),D&&clearTimeout(D),D=setTimeout(()=>{j.classList.add("hidden")},2500))},S=e=>e?e.startsWith("/")?e:`/${e}`:"",$=e=>(e==null?void 0:e.replace(/^\//,""))||"",x=(e,t)=>{let s=e?S(e):null;try{s&&(window.localStorage.setItem(F,s),n.slug=s),typeof t=="string"&&t.length>0&&(window.localStorage.setItem(U,t),n.name=t)}catch{n.slug=s||n.slug,n.name=t||n.name}},ce=document.querySelectorAll("[data-hub-tab]"),H=e=>{b&&e&&(b.textContent=e),_&&e&&(_.textContent=e),V&&e&&(V.textContent=e)},J=e=>{ce.forEach(t=>{let s=t.dataset.hubTab;if(!s){t.classList.remove("pointer-events-none","opacity-50","text-slate-400"),t.removeAttribute("aria-disabled");return}if(!e){t.href="#",t.classList.add("pointer-events-none","opacity-50","text-slate-400"),t.setAttribute("aria-disabled","true");return}let a=encodeURIComponent($(e));t.href=`/admin/site/${a}/${s}`,t.classList.remove("pointer-events-none","opacity-50","text-slate-400"),t.removeAttribute("aria-disabled")})},q=(e,t={})=>{if(!e)return;let s=S(e),a=t.siteName||n.name||(b==null?void 0:b.dataset.defaultSiteName)||"";B.forEach(o=>{let y=S(o.dataset.siteCard||"")===s,f=o.querySelector("[data-site-active-badge]");y?(o.classList.add("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),o.classList.remove("border-slate-200"),f==null||f.classList.remove("hidden"),a=o.dataset.siteName||a):(o.classList.remove("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),o.classList.add("border-slate-200"),f==null||f.classList.add("hidden"))}),t.persist!==!1&&x(s,t.siteName||a);let p=t.siteName||a;H(p),J(s)},re=async(e,t)=>{let s=S(e);try{let a=await fetch("/api/sites/select",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slug:s})});if(!a.ok){let f=await a.json().catch(()=>({}));K(f.message||"Impossible de s\xE9lectionner ce site.");return}let p=await a.json().catch(()=>({})),o=S(p.slug||s),m=p.name||t;x(o,m),q(o,{siteName:m,persist:!1});let y=encodeURIComponent($(o));window.location.href=`/admin/site/${y}/design`}catch(a){console.error("[admin] Impossible de s\xE9lectionner le site",a),K("Erreur inattendue lors de la s\xE9lection.")}},de=async()=>{try{let e=await fetch("/api/sites/current",{credentials:"same-origin"});if(!e.ok){e.status===404&&z&&(window.location.href="/admin/sites");return}let t=await e.json(),s=S(t.slug);x(s,t.name),q(s,{siteName:t.name,persist:!1})}catch(e){console.warn("[admin] Impossible de r\xE9cup\xE9rer le site actif",e)}};(()=>{if(n.slug){q(n.slug,{siteName:n.name,persist:!1});return}let e=document.querySelector('[data-site-card][data-site-default="true"]')||B[0];e&&q(e.dataset.siteCard,{siteName:e.dataset.siteName||"",persist:!1})})(),de(),J(n.slug),ee.forEach(e=>{e.addEventListener("click",()=>{if(e.disabled)return;let t=e.dataset.siteSelect,s=e.dataset.siteSelectName||"Ce site";t&&(e.disabled=!0,re(t,s).finally(()=>{e.disabled=!1}))})});let P=e=>e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),le=e=>{let t=P(e||"");return t?`/${t}`:""},ue=()=>{i&&(k=document.activeElement,i.classList.remove("hidden"),i.classList.add("flex"),E=!1,h==null||h.reset(),c&&(c.textContent=""),u&&(u.textContent=""),l&&d&&(l.value=P(d.value)),document.addEventListener("keydown",W),window.setTimeout(()=>{d==null||d.focus()},0))},A=()=>{i&&(i.classList.add("hidden"),i.classList.remove("flex"),document.removeEventListener("keydown",W),E=!1,h==null||h.reset(),c&&(c.textContent=""),u&&(u.textContent=""),k==null||k.focus())};ne.forEach(e=>{e.addEventListener("click",ue)}),oe.forEach(e=>{e.addEventListener("click",A)}),i==null||i.addEventListener("click",e=>{e.target===i&&A()}),d==null||d.addEventListener("input",()=>{l&&(!E||l.value.trim().length===0)&&(l.value=P(d.value))}),l==null||l.addEventListener("input",()=>{E=!0,c&&(c.textContent="")});let me=()=>new Set(Array.from(B).map(e=>S(e.dataset.siteCard||"")));h==null||h.addEventListener("submit",async e=>{if(e.preventDefault(),!d||!l)return;let t=(d.value||"").trim(),s=l.value||"";s||(s=t);let a=le(s);if(!t||!a){c&&(c.textContent="Nom et slug sont requis.");return}if(me().has(a)){c&&(c.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}c&&(c.textContent=""),u&&(u.textContent=""),w&&(w.disabled=!0,w.textContent="Cr\xE9ation...");try{let o=await fetch("/api/sites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,slug:a})});if(!o.ok){let G=await o.json().catch(()=>({})),Q=G.message||"Impossible de cr\xE9er ce site.";u&&(u.textContent=Q),G.field==="slug"&&c&&(c.textContent=Q);return}let m=await o.json(),y=S((m==null?void 0:m.slug)||a),f=(m==null?void 0:m.name)||t;x(y,f),A();let Se=encodeURIComponent($(y));window.location.href=`/admin/site/${Se}/design`}catch(o){console.error("[admin] Impossible de cr\xE9er le site",o),u&&(u.textContent="Erreur inattendue. R\xE9essaie dans un instant.")}finally{w&&(w.disabled=!1,w.textContent="Cr\xE9er")}}),window.addEventListener("keydown",e=>{e.key==="Escape"&&(i&&!i.classList.contains("hidden")&&A(),g&&!g.classList.contains("hidden")&&Y())});function fe(){let e=window.location.pathname.match(/^\/admin\/site\/([^/]+)(?:\/([^/]+))?/);return e?{slugPart:decodeURIComponent(e[1]),slugValue:S(decodeURIComponent(e[1])),section:e[2]||"design"}:null}function he(){if(!g){window.location.href="/admin/sites";return}g.classList.remove("hidden"),g.classList.add("flex")}function Y(){g&&(g.classList.add("hidden"),g.classList.remove("flex"))}te.forEach(e=>{e.addEventListener("click",he)}),se.forEach(e=>{e.addEventListener("click",Y)}),M==null||M.addEventListener("click",()=>{window.location.href="/admin/sites"}),z&&(ae.forEach(e=>{let t=e.dataset.workspaceTab;if(!t)return;let s=`/admin/site/${encodeURIComponent(z.slugPart)}/${t}`;e.href=s}),n.name&&H(n.name))});})();
