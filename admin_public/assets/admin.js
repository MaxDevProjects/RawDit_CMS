(()=>{document.addEventListener("DOMContentLoaded",()=>{console.log("[admin] Atelier charg\xE9");let Ws=document.querySelector("[data-logout]");Ws&&Ws.addEventListener("click",async()=>{Ws.disabled=!0;try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(o){console.error("[admin] Impossible de se d\xE9connecter",o)}finally{window.location.href="/admin/index.html"}});let cs=document.querySelector("[data-admin-sidebar]"),dt=document.querySelector("[data-admin-sidebar-overlay]"),wo=document.querySelectorAll("[data-admin-sidebar-toggle]"),_o=document.querySelectorAll("[data-admin-sidebar-close]"),Ks=document.body,Ss=!1,Ls=()=>{if(!cs)return;if(window.matchMedia("(min-width: 1024px)").matches){cs.classList.remove("hidden"),dt==null||dt.classList.add("hidden"),Ks.classList.remove("overflow-hidden");return}Ss?(cs.classList.remove("hidden"),dt==null||dt.classList.remove("hidden"),Ks.classList.add("overflow-hidden")):(cs.classList.add("hidden"),dt==null||dt.classList.add("hidden"),Ks.classList.remove("overflow-hidden"))},Yo=()=>{Ss=!0,Ls()},Zs=()=>{Ss=!1,Ls()};cs&&wo.length>0&&(wo.forEach(o=>{o.addEventListener("click",Yo)}),_o.forEach(o=>{o.addEventListener("click",Zs)}),dt==null||dt.addEventListener("click",Zs),window.addEventListener("resize",Ls),window.addEventListener("keydown",o=>{o.key==="Escape"&&Ss&&Zs()}),Ls());let So="clower:currentSite",Lo="clower:currentSiteName",Y={slug:null,name:""};(()=>{try{Y.slug=window.localStorage.getItem(So),Y.name=window.localStorage.getItem(Lo)||""}catch{Y.slug=null,Y.name=""}})();let _s=document.querySelectorAll("[data-site-card]"),Xo=document.querySelectorAll("[data-site-select]"),ds=document.querySelector("[data-current-site-name]"),ko=document.querySelector("[data-workspace-site-name]"),Co=document.querySelector("[data-workspace-back-name]"),Nt=document.querySelector("[data-workspace-back-modal]"),Qo=document.querySelectorAll("[data-workspace-back]"),er=document.querySelectorAll("[data-workspace-back-cancel]"),Ys=document.querySelector("[data-workspace-back-confirm]"),tr=document.querySelectorAll("[data-workspace-tab]"),Xs=document.querySelector("[data-site-toast]"),Eo=document.querySelector("[data-site-toast-message]"),sr=document.querySelectorAll("[data-site-create]"),Ve=document.querySelector("[data-site-modal]"),Je=document.querySelector("[data-site-form]"),Ue=Je==null?void 0:Je.querySelector('input[name="siteName"]'),qe=Je==null?void 0:Je.querySelector('input[name="siteSlug"]'),Re=document.querySelector("[data-site-slug-error]"),Oe=document.querySelector("[data-site-modal-error]"),or=document.querySelectorAll("[data-site-modal-cancel]"),Yt=document.querySelector("[data-site-modal-submit]"),G=dr(),ks=!1,Cs=null,Qs=null,rr='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',qo=o=>{if(!Ve||Ve.classList.contains("hidden")||o.key!=="Tab")return;let a=Array.from(Ve.querySelectorAll(rr)).filter(f=>!f.hasAttribute("disabled")&&!f.getAttribute("aria-hidden"));if(a.length===0)return;let d=a[0],y=a[a.length-1];o.shiftKey?document.activeElement===d&&(o.preventDefault(),y.focus()):document.activeElement===y&&(o.preventDefault(),d.focus())},$=o=>{!Xs||!Eo||(Eo.textContent=o,Xs.classList.remove("hidden"),Qs&&clearTimeout(Qs),Qs=setTimeout(()=>{Xs.classList.add("hidden")},2500))};function $t(o){return o?o.startsWith("/")?o:`/${o}`:""}function Se(o){return(o==null?void 0:o.replace(/^\//,""))||""}let Es=(o,a)=>{let d=o?$t(o):null;try{d&&(window.localStorage.setItem(So,d),Y.slug=d),typeof a=="string"&&a.length>0&&(window.localStorage.setItem(Lo,a),Y.name=a)}catch{Y.slug=d||Y.slug,Y.name=a||Y.name}},Ao=o=>{ds&&o&&(ds.textContent=o),ko&&o&&(ko.textContent=o),Co&&o&&(Co.textContent=o)},eo=o=>{tr.forEach(a=>{let d=a.dataset.workspaceTab;if(!d)return;if(!o){a.href="#",a.classList.add("pointer-events-none","opacity-50","text-slate-400"),a.setAttribute("aria-disabled","true");return}let y=encodeURIComponent(Se(o));a.href=`/admin/site/${y}/${d}`,a.classList.remove("pointer-events-none","opacity-50","text-slate-400"),a.removeAttribute("aria-disabled")})},qs=(o,a={})=>{if(!o)return;let d=$t(o),y=a.siteName||Y.name||(ds==null?void 0:ds.dataset.defaultSiteName)||"";_s.forEach(h=>{let Z=$t(h.dataset.siteCard||"")===d,U=h.querySelector("[data-site-active-badge]");Z?(h.classList.add("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),h.classList.remove("border-slate-200"),U==null||U.classList.remove("hidden"),y=h.dataset.siteName||y):(h.classList.remove("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),h.classList.add("border-slate-200"),U==null||U.classList.add("hidden"))}),a.persist!==!1&&Es(d,a.siteName||y);let f=a.siteName||y;Ao(f),eo(d)},nr=async(o,a)=>{let d=$t(o);try{let y=await fetch("/api/sites/select",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slug:d})});if(!y.ok){let U=await y.json().catch(()=>({}));$(U.message||"Impossible de s\xE9lectionner ce site.");return}let f=await y.json().catch(()=>({})),h=$t(f.slug||d),z=f.name||a;Es(h,z),qs(h,{siteName:z,persist:!1});let Z=encodeURIComponent(Se(h));window.location.href=`/admin/site/${Z}/design`}catch(y){console.error("[admin] Impossible de s\xE9lectionner le site",y),$("Erreur inattendue lors de la s\xE9lection.")}},ar=async()=>{try{let o=await fetch("/api/sites/current",{credentials:"same-origin"});if(!o.ok){o.status===404&&G&&(window.location.href="/admin/sites");return}let a=await o.json(),d=$t(a.slug);Es(d,a.name),qs(d,{siteName:a.name,persist:!1})}catch(o){console.warn("[admin] Impossible de r\xE9cup\xE9rer le site actif",o)}};(()=>{if(Y.slug){qs(Y.slug,{siteName:Y.name,persist:!1});return}let o=document.querySelector('[data-site-card][data-site-default="true"]')||_s[0];o&&qs(o.dataset.siteCard,{siteName:o.dataset.siteName||"",persist:!1})})(),ar(),G?eo(G.slugValue):Y.slug&&eo(Y.slug),Xo.forEach(o=>{o.addEventListener("click",()=>{if(o.disabled)return;let a=o.dataset.siteSelect,d=o.dataset.siteSelectName||"Ce site";a&&(o.disabled=!0,nr(a,d).finally(()=>{o.disabled=!1}))})});let zt=o=>(o||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),ir=o=>{let a=zt(o||"");return a?`/${a}`:""},lr=()=>{Ve&&(Cs=document.activeElement,Ve.classList.remove("hidden"),Ve.classList.add("flex"),ks=!1,Je==null||Je.reset(),Re&&(Re.textContent=""),Oe&&(Oe.textContent=""),qe&&Ue&&(qe.value=zt(Ue.value)),document.addEventListener("keydown",qo),window.setTimeout(()=>{Ue==null||Ue.focus()},0))},As=()=>{Ve&&(Ve.classList.add("hidden"),Ve.classList.remove("flex"),document.removeEventListener("keydown",qo),ks=!1,Je==null||Je.reset(),Re&&(Re.textContent=""),Oe&&(Oe.textContent=""),Cs==null||Cs.focus())};sr.forEach(o=>{o.addEventListener("click",lr)}),or.forEach(o=>{o.addEventListener("click",As)}),Ve==null||Ve.addEventListener("click",o=>{o.target===Ve&&As()}),Ue==null||Ue.addEventListener("input",()=>{qe&&((!ks||qe.value.trim().length===0)&&(qe.value=zt(Ue.value)),Re&&(Re.textContent=""),Oe&&(Oe.textContent=""))}),qe==null||qe.addEventListener("focus",()=>{let o=(qe==null?void 0:qe.value)||"",a=(Ue==null?void 0:Ue.value)||"";!o.trim()&&a.trim()&&(qe.value=zt(a))}),qe==null||qe.addEventListener("input",()=>{ks=!0,Re&&(Re.textContent=""),Oe&&(Oe.textContent="")});let cr=()=>new Set(Array.from(_s).map(o=>$t(o.dataset.siteCard||"")));Je==null||Je.addEventListener("submit",async o=>{if(o.preventDefault(),console.log("[admin] Form submit - siteNameInput:",Ue,"siteSlugInput:",qe),!Ue||!qe){console.log("[admin] Missing inputs, aborting");return}let a=(Ue.value||"").trim(),d=(qe.value||"").trim();console.log("[admin] nameValue:",a,"slugValue:",d),!d&&a&&(d=zt(a),qe.value=d,console.log("[admin] Auto-generated slug:",d));let y=ir(d);if(console.log("[admin] normalizedSlug:",y),!a){console.log("[admin] Name validation failed"),Oe&&(Oe.textContent="Le nom du site est requis."),Ue.focus();return}if(!y){console.log("[admin] Slug validation failed"),Re&&(Re.textContent="Le slug ne peut pas \xEAtre vide ou contenir uniquement des caract\xE8res sp\xE9ciaux."),qe.focus();return}if(cr().has(y)){Re&&(Re.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}Re&&(Re.textContent=""),Oe&&(Oe.textContent=""),Yt&&(Yt.disabled=!0,Yt.textContent="Cr\xE9ation...");try{let h=await fetch("/api/sites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a,slug:y})});if(!h.ok){let k=await h.json().catch(()=>({})),p=k.message||"Impossible de cr\xE9er ce site.";Oe&&(Oe.textContent=p),k.field==="slug"&&Re&&(Re.textContent=p);return}let z=await h.json(),Z=$t((z==null?void 0:z.slug)||y),U=(z==null?void 0:z.name)||a;Es(Z,U),As();let Q=encodeURIComponent(Se(Z));window.location.href=`/admin/site/${Q}/design`}catch(h){console.error("[admin] Impossible de cr\xE9er le site",h),Oe&&(Oe.textContent="Erreur inattendue. R\xE9essaie dans un instant.")}finally{Yt&&(Yt.disabled=!1,Yt.textContent="Cr\xE9er")}}),window.addEventListener("keydown",o=>{o.key==="Escape"&&(Ve&&!Ve.classList.contains("hidden")&&As(),Nt&&!Nt.classList.contains("hidden")&&To(),blockDeleteModal&&!blockDeleteModal.classList.contains("hidden")&&closeBlockDeleteModal(),blockLibraryOpen&&closeBlockLibrary())});function dr(){let o=window.location.pathname.match(/^\/admin\/site\/([^/]+)(?:\/([^/]+))?/);return o?{slugPart:decodeURIComponent(o[1]),slugValue:$t(decodeURIComponent(o[1])),section:o[2]||"design"}:null}function ur(){return document.querySelector("[data-page-list]")?"design":document.querySelector("[data-collection-list]")?"content":document.querySelector("[data-media-grid]")?"media":document.querySelector("[data-deploy-form]")?"deploy":null}function mr(){if(!Nt){window.location.href="/admin/sites";return}Nt.classList.remove("hidden"),Nt.classList.add("flex")}function To(){Nt&&(Nt.classList.add("hidden"),Nt.classList.remove("flex"))}Qo.forEach(o=>{o.addEventListener("click",mr)}),er.forEach(o=>{o.addEventListener("click",To)}),Ys==null||Ys.addEventListener("click",()=>{window.location.href="/admin/sites"});let us=(G==null?void 0:G.section)||ur();us==="design"&&pr(),us==="content"&&fr(),us==="media"&&vr(),us==="deploy"&&gr(),us==="settings"&&hr(),G&&Y.name&&Ao(Y.name);function pr(){let o=document.querySelectorAll("[data-page-list]");if(o.length===0)return;let a=document.querySelector("[data-active-page-title]"),d=document.querySelector("[data-active-page-slug]"),y=document.querySelector("[data-page-preview-tags]"),f=document.querySelector("[data-page-preview-frame]"),h=document.querySelector("[data-preview-open]"),z=document.querySelector("[data-preview-status]"),Z=document.querySelector("[data-preview-highlight]"),U=document.querySelector("[data-seo-toggle]"),Q=document.querySelector("[data-seo-panel]"),k=document.querySelector("[data-seo-close]"),p=document.querySelector("[data-seo-form]"),S=document.querySelector("[data-seo-title]"),P=document.querySelector("[data-seo-description]"),q=document.querySelector("[data-seo-indexed]"),F=document.querySelector("[data-seo-feedback]"),M=document.querySelector("[data-seo-save]"),R=document.querySelector("[data-page-props-toggle]"),C=document.querySelector("[data-page-props-panel]"),m=document.querySelector("[data-page-props-close]"),D=document.querySelector("[data-page-props-form]"),N=document.querySelector("[data-page-name]"),V=document.querySelector("[data-page-title-input]"),_=document.querySelector("[data-page-slug-input]"),ce=document.querySelector("[data-page-description]"),X=document.querySelector("[data-page-props-feedback]"),pe=document.querySelector("[data-page-props-save]"),H=document.querySelector("[data-blocks-list]"),xe=document.querySelector("[data-blocks-empty]"),T=document.querySelector("[data-block-count]"),w=document.querySelector("[data-block-library-toggle]"),b=document.querySelector("[data-block-library]"),W=document.querySelectorAll("[data-block-add]"),K=document.querySelector("[data-block-delete-modal]"),fe=document.querySelector("[data-block-delete-confirm]"),ye=document.querySelector("[data-block-delete-cancel]"),oe=document.querySelector("[data-block-detail-empty]"),he=document.querySelector("[data-block-detail-status]"),re=document.querySelector("[data-block-editor]"),Ae=document.querySelector("[data-block-editor-block-name]"),Ct=document.querySelector("[data-block-editor-block-type]"),ne=document.querySelector("[data-block-editor-unsupported]"),E=document.querySelector("[data-block-form]"),We=E?Array.from(E.querySelectorAll("[data-editor-section]")):[],Le=document.querySelectorAll("[data-block-tab]"),Ke="content",Et=document.querySelectorAll("[data-left-tab]"),It=document.querySelector('[data-left-panel="blocks"]'),vt=document.querySelector('[data-left-panel="pages"]'),Te="blocks",mt=e=>{Te=e,Et.forEach(t=>{let s=t.dataset.leftTab===e;t.setAttribute("aria-selected",s?"true":"false"),s?(t.classList.add("text-[#9C6BFF]"),t.classList.remove("text-slate-500","hover:text-slate-700"),t.classList.add("after:absolute","after:bottom-0","after:left-0","after:right-0","after:h-0.5","after:bg-[#9C6BFF]")):(t.classList.remove("text-[#9C6BFF]"),t.classList.add("text-slate-500","hover:text-slate-700"),t.classList.remove("after:absolute","after:bottom-0","after:left-0","after:right-0","after:h-0.5","after:bg-[#9C6BFF]"))}),It&&It.classList.toggle("hidden",e!=="blocks"),vt&&vt.classList.toggle("hidden",e!=="pages")};Et.forEach(e=>{e.addEventListener("click",()=>{mt(e.dataset.leftTab)})});let de=document.querySelector("[data-block-form-actions]"),i=document.querySelector("[data-block-form-autosave]"),A=e=>{Ke=e,Le.forEach(s=>{let n=s.dataset.blockTab===e;s.setAttribute("aria-selected",n?"true":"false"),n?(s.classList.add("text-[#9C6BFF]"),s.classList.remove("text-slate-500","hover:text-slate-700"),s.classList.add("after:absolute","after:bottom-0","after:left-0","after:right-0","after:h-0.5","after:bg-[#9C6BFF]")):(s.classList.remove("text-[#9C6BFF]"),s.classList.add("text-slate-500","hover:text-slate-700"),s.classList.remove("after:absolute","after:bottom-0","after:left-0","after:right-0","after:h-0.5","after:bg-[#9C6BFF]"))});let t=E==null?void 0:E.querySelector("[data-editor-section]:not(.hidden)");t&&t.querySelectorAll("[data-block-panel]").forEach(n=>{n.dataset.blockPanel===e?n.classList.remove("hidden"):n.classList.add("hidden")}),de&&i&&(e==="content"?(de.classList.remove("hidden"),i.classList.add("hidden")):(de.classList.add("hidden"),i.classList.remove("hidden")))};Le.forEach(e=>{e.addEventListener("click",()=>{A(e.dataset.blockTab)})});let j=E==null?void 0:E.querySelector('[name="collection-grid-collection"]'),J=E==null?void 0:E.querySelector("[data-collection-selection-info]"),yt=document.querySelector("[data-block-form-cancel]"),pt=E==null?void 0:E.querySelector("[data-group-preview-mobile]"),Qt=E==null?void 0:E.querySelector("[data-group-preview-desktop]"),es=E==null?void 0:E.querySelector("[data-collection-preview-mobile]"),ts=E==null?void 0:E.querySelector("[data-collection-preview-desktop]"),Bs={hero:{section:"hero",labelField:"title",descriptionField:"subtitle",fields:{title:"hero-title",subtitle:"hero-subtitle",ctaLabel:"hero-cta-label",ctaUrl:"hero-cta-url",image:"hero-image",layout:"hero-layout",height:"hero-height",contentAlign:"hero-content-align",horizontalAlign:"hero-horizontal-align",textAlign:"hero-text-align",overlay:"hero-overlay",titleSize:"hero-title-size",bg:"hero-bg",borderRadius:"hero-border-radius",shadow:"hero-shadow"}},paragraphe:{section:"paragraph",labelField:"title",descriptionField:"content",fields:{title:"paragraph-title",content:"paragraph-content",align:"paragraph-align",titleSize:"paragraph-title-size",textSize:"paragraph-text-size",spacing:"paragraph-spacing",bg:"paragraph-bg",borderRadius:"paragraph-border-radius",shadow:"paragraph-shadow"}},image:{section:"image",labelField:"alt",fields:{src:"image-src",alt:"image-alt",showCaption:"image-caption-toggle",caption:"image-caption",rounded:"image-rounded",shadow:"image-shadow",maxWidth:"image-max-width",height:"image-height",objectFit:"image-object-fit",align:"image-align",bg:"image-bg",borderRadius:"image-border-radius"}},groupe:{section:"group",fields:{columnsMobile:"group-columns-mobile",columnsDesktop:"group-columns-desktop",gap:"group-gap",itemsAlign:"group-items-align",bg:"group-bg",borderRadius:"group-border-radius",shadow:"group-shadow"}},collectiongrid:{section:"collection",fields:{collectionId:"collection-grid-collection",limit:"collection-grid-limit",columnsMobile:"collection-columns-mobile",columnsDesktop:"collection-columns-desktop",gap:"collection-gap",itemsAlign:"collection-items-align",cardRounded:"collection-card-rounded",bg:"collection-bg",borderRadius:"collection-border-radius",shadow:"collection-shadow"}},form:{section:"form",labelField:"formTitle",fields:{formTitle:"form-title",actionUrl:"form-action-url",method:"form-method",serviceName:"form-service-name",submitLabel:"form-submit-label",successMessage:"form-success-message",maxWidth:"form-max-width",align:"form-align",buttonRounded:"form-button-rounded",spacing:"form-spacing",bg:"form-bg",borderRadius:"form-border-radius",shadow:"form-shadow"}},newsletterembed:{section:"newsletter",labelField:"title",fields:{title:"newsletter-title",serviceName:"newsletter-service-name",embedCode:"newsletter-embed-code",maxWidth:"newsletter-max-width",align:"newsletter-align",padding:"newsletter-padding",bg:"newsletter-bg",borderRadius:"newsletter-border-radius",shadow:"newsletter-shadow"}}},st={texte:"paragraphe",paragraph:"paragraphe",paragraphs:"paragraphe",paragraphes:"paragraphe",text:"paragraphe",hero:"hero",image:"image",groupe:"groupe",group:"groupe",collection:"collectiongrid",collectiongrid:"collectiongrid","collection-grid":"collectiongrid",form:"form",formulaire:"form",contact:"form",newsletterembed:"newsletterembed",newsletter:"newsletterembed",embed:"newsletterembed"},bt=(e,t)=>{if(!pt||!Qt)return;let s=n=>Array.from({length:Number(n)||1}).map(()=>'<span class="block h-2 w-full rounded-full bg-slate-300"></span>').join("");pt.innerHTML=s(e),Qt.innerHTML=s(t)},$e=(e,t)=>{if(!es||!ts)return;let s=n=>Array.from({length:Number(n)||1}).map(()=>'<span class="block h-2 w-full rounded-full bg-violet-300"></span>').join("");es.innerHTML=s(e),ts.innerHTML=s(t)},Ie=async()=>{if(!Ye)return[];let e=await fetch(Ye,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les pages.");let t=await e.json().catch(()=>[]);return Array.isArray(t)?t:[]},Fe=async({name:e,title:t,slug:s})=>{if(!Ye)throw new Error("Site inconnu.");let n=await fetch(Ye,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,title:t,slug:s})});if(!n.ok){let l=await n.json().catch(()=>({}));throw new Error(l.message||"Impossible de cr\xE9er la page.")}return n.json().catch(()=>({}))},ze=async e=>{if(!(!Ye||!(e!=null&&e.id)))try{let t=await fetch(`${Ye}/${encodeURIComponent(e.id)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let n=await t.json().catch(()=>({}));throw new Error(n.message||"Impossible de sauvegarder la page.")}let s=await t.json().catch(()=>({}));if(s!=null&&s.id){let n=is(s);return le=le.map(l=>l.id===n.id?n:l),(u==null?void 0:u.id)===n.id&&(u=n),n}return s}catch(t){console.error("[design] Save page failed",t),$(t.message||"Sauvegarde impossible.")}},Vt=async()=>{if(!Ye){le=[],Be=null,u=null,Zt(le,Be),ht(null),oe==null||oe.classList.remove("hidden"),re==null||re.classList.add("hidden");return}try{let e=await Ie();if(le=(Array.isArray(e)?e:[]).map(t=>is(t)),le.length===0){Be=null,u=null,Zt(le,Be),ht(null),oe==null||oe.classList.remove("hidden"),re==null||re.classList.add("hidden"),f&&(f.srcdoc=Ht());return}Be=jr(le),Lt(Be)}catch(e){console.error("[design] Impossible de charger les pages",e),$("Impossible de charger les pages.")}},Dt=e=>(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),Bt=e=>{if(!e)return null;let t=Dt(e.type),s=st[t]||t;return Bs[s]||null},js=e=>{var s,n,l,v,x;if(!E||!re)return;e&&!e.settings&&(e.settings={});let t=Bt(e);if(Ae&&(Ae.textContent=(e==null?void 0:e.label)||"Bloc"),Ct&&(Ct.textContent=(e==null?void 0:e.type)||"Bloc"),!t){E.classList.add("hidden"),ne==null||ne.classList.remove("hidden"),E.dataset.blockId="";return}if(ne==null||ne.classList.add("hidden"),E.classList.remove("hidden"),E.reset(),E.dataset.blockId=e.id,We.forEach(L=>{L.dataset.editorSection===t.section?L.classList.remove("hidden"):L.classList.add("hidden")}),A("content"),t.section==="collection"){let L=e.collectionId||((s=e.settings)==null?void 0:s.collectionId)||"";Js(L)}if(Object.entries(t.fields).forEach(([L,te])=>{var Qe;let ke=E.querySelector(`[name="${te}"]`);if(!ke)return;let be=(Qe=e.settings)==null?void 0:Qe[L];ke.type==="checkbox"?ke.checked=!!be:ke.type==="number"?ke.value=be!=null?be:1:(ke.tagName,ke.value=be!=null?be:"")}),t.section==="group"){let L=((n=E.querySelector('[name="group-columns-mobile"]'))==null?void 0:n.value)||"1",te=((l=E.querySelector('[name="group-columns-desktop"]'))==null?void 0:l.value)||"3";bt(L,te)}if(t.section==="collection"){let L=((v=E.querySelector('[name="collection-columns-mobile"]'))==null?void 0:v.value)||"1",te=((x=E.querySelector('[name="collection-columns-desktop"]'))==null?void 0:x.value)||"3";$e(L,te)}E.querySelectorAll("[data-color-select]").forEach(L=>{var Qe,Mt;let te=L.options[L.selectedIndex],ke=((Qe=te==null?void 0:te.dataset)==null?void 0:Qe.color)||"#ffffff",be=(Mt=L.closest(".relative"))==null?void 0:Mt.querySelector("[data-color-preview]");be&&(ke==="transparent"?be.style.background="repeating-conic-gradient(#ccc 0% 25%, white 0% 50%) 50% / 8px 8px":(be.style.backgroundColor=ke,be.style.background=""))})},jt=e=>{if(!E||!e)return{};let t={};return Object.entries(e.fields).forEach(([s,n])=>{let l=E.querySelector(`[name="${n}"]`);if(l)if(l.type==="checkbox")t[s]=l.checked;else if(l.type==="number"){let v=Number(l.value);t[s]=Number.isFinite(v)?v:0}else l.tagName==="TEXTAREA"?t[s]=l.value||"":l.type==="select-one"?t[s]=l.value:t[s]=l.value||""}),t},xt=e=>{if(z){if(!e){z.classList.add("hidden");return}z.classList.remove("hidden"),z.textContent=e}},Jt=e=>{if(!e)return null;let t=s=>{var n;return{id:s.id,type:s.type,label:s.label,status:s.status,description:s.description,props:s.props||[],settings:s.settings||{},collectionId:s.collectionId||((n=s.settings)==null?void 0:n.collectionId)||"",children:(s.children||[]).map(t)}};return{id:e.id,title:e.title,slug:e.slug,badges:[...e.badges||[]],seo:e.seo||{},blocks:(e.blocks||[]).map(t)}},Ht=()=>'<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#475569;background:#fff;">Pr\xE9paration de la pr\xE9visualisation\u2026</body></html>',Gt=(e,t)=>{let s;return(...n)=>{clearTimeout(s),s=setTimeout(()=>e(...n),t)}},Fs=null,Ps=()=>{if(!u||!He)return;let e=ns(),t=Bt(e);if(!e||!t)return;let s=jt(t),n=(u.blocks||[]).map(v=>{if(v.id!==e.id)return v;let x={...v.settings||{},...s};return{...v,settings:x}}),l={...u,blocks:n};u=l,ze(l)},ft=(e,t)=>{!f||!f.contentWindow||f.contentWindow.postMessage({type:"updateBlockStyles",blockId:e,settings:t},"*")},ao=Gt(()=>{Ps(),xt("Sauvegard\xE9"),setTimeout(()=>xt("\xC0 jour"),1500)},800),ms=Gt(()=>{u&&Ut(u)},1500),Ms=(e,t)=>{ft(e,t),xt("Modification\u2026"),ao(),ms()},Ut=e=>{if(!f||!e)return;let t=(G==null?void 0:G.slugValue)||Y.slug||"",s={page:Jt(e),site:{title:Y.name||"Site",slug:t}};ho=!1,xt("Actualisation\u2026"),f.srcdoc=Ht(),xs&&xs.abort();let n=new AbortController;xs=n,fetch("/api/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s),signal:n.signal}).then(l=>{if(!l.ok)throw new Error("Preview error");return l.json()}).then(l=>{n.signal.aborted||(go=l.html||"",f.setAttribute("title",`Pr\xE9visualisation de la page ${e.title||""}`.trim()),f.srcdoc=go||Ht(),xt("\xC0 jour"))}).catch(l=>{n.signal.aborted||(console.error("[preview] Impossible de rendre la page",l),xt("Erreur preview"),f.srcdoc='<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#be123c;background:#fff;">Erreur lors du rendu de la pr\xE9visualisation.</body></html>')}).finally(()=>{xs===n&&(xs=null)})},Ns=e=>{if(e.preventDefault(),!u||!He)return;let t=ns(),s=Bt(t);if(!t||!s)return;let n=jt(s);if(s.section==="collection"){if(!n.collectionId){$("S\xE9lectionnez une collection.");return}n.limit=Math.max(1,Number(n.limit)||1)}let l=(u.blocks||[]).map(v=>{if(v.id!==t.id)return v;let x={...v.settings||{},...n},L={...v,settings:x};return s.labelField&&n[s.labelField]&&(L.label=n[s.labelField]),s.descriptionField&&n[s.descriptionField]&&(L.description=n[s.descriptionField]),s.section==="collection"&&(L.collectionId=n.collectionId,L.settings.collectionId=n.collectionId,L.settings.limit=n.limit),L});as(l),$("Bloc mis \xE0 jour"),Lt(u.id,{preserveBlock:!0})},Ft=document.querySelector("[data-page-drawer]"),Ze=document.querySelector("[data-page-drawer-backdrop]"),io=document.querySelectorAll("[data-page-drawer-open]"),lo=document.querySelectorAll("[data-page-drawer-close]"),Pt=document.querySelector("[data-add-page-toggle]"),ot=document.querySelector("[data-add-page-form]"),_e=document.querySelector("[data-add-page-name]"),Wt=document.querySelector("[data-add-page-title]"),rt=document.querySelector("[data-add-page-slug]"),ss=document.querySelector("[data-add-page-cancel]"),Me=document.querySelector("[data-add-page-error]"),r=ot==null?void 0:ot.querySelector('[type="submit"]'),c=document.querySelector("[data-import-pages-toggle]"),g=document.querySelector("[data-import-modal]"),I=document.querySelectorAll("[data-import-modal-close]"),O=document.querySelector("[data-import-dropzone]"),ae=document.querySelector("[data-import-file-input]"),ie=document.querySelector("[data-import-file-list]"),ee=document.querySelector("[data-import-file-names]"),se=document.querySelector("[data-import-results]"),ue=document.querySelector("[data-import-results-content]"),ge=document.querySelector("[data-import-submit]"),Pe=document.querySelectorAll("[data-import-tab]"),Ne=document.querySelectorAll("[data-import-panel]"),De=document.querySelector("[data-copy-template]"),wt=document.querySelector("[data-template-json]"),we=document.querySelector("[data-import-paste-json]"),St=document.querySelector("[data-format-json]"),nt=document.querySelector("[data-import-paste-error]"),gt=[],qt="upload",at=document.querySelector("[data-delete-page-modal]"),ps=document.querySelector("[data-delete-page-name]"),os=document.querySelector("[data-delete-page-cancel]"),it=document.querySelector("[data-delete-page-confirm]"),Rt=null,Ds=Se((G==null?void 0:G.slugValue)||Y.slug||"default")||"default",Hs=(G==null?void 0:G.slugValue)||Y.slug||"",Kt=Se(Hs)||"",Ye=Kt?`/api/sites/${encodeURIComponent(Kt)}/pages`:null,fs=Kt?`/api/sites/${encodeURIComponent(Kt)}/collections`:null,gs={active:`clower:activePage:${Ds}`},rs=(e,t,s,n,l,v=[],x={})=>{let L={id:e,label:t,type:s,status:n,description:l,props:v,settings:{...x}};return L.settings.collectionId&&(L.collectionId=L.settings.collectionId),L},Us={hero:{type:"Hero",label:"Hero de page",description:"Section pleine largeur avec CTA principal.",status:"Brouillon",props:[{label:"CTA",value:"D\xE9couvrir"},{label:"Hauteur",value:"80vh"}],settings:{title:"Titre du hero",subtitle:"",ctaLabel:"D\xE9couvrir",ctaUrl:"#",image:"",align:"center"}},paragraph:{type:"Paragraphe",label:"Bloc \xE9ditorial",description:"Paragraphe libre pour raconter votre histoire.",status:"Brouillon",props:[{label:"Longueur",value:"150 mots"}],settings:{title:"Titre du paragraphe",content:"",align:"left"}},image:{type:"Image",label:"Bloc image",description:"Visuel seul avec l\xE9gende optionnelle.",status:"Brouillon",props:[{label:"Ratio",value:"16:9"},{label:"L\xE9gende",value:"Inactive"}],settings:{src:"",alt:"",showCaption:!1,caption:""}},group:{type:"Groupe",label:"Groupe de sections",description:"Conteneur pour imbriquer plusieurs sous-blocs.",status:"Brouillon",props:[{label:"Disposition",value:"Verticale"}],settings:{layout:"grid",columnsMobile:"1",columnsDesktop:"3"}},collectiongrid:{type:"CollectionGrid",label:"Grille de contenus",description:"Affiche automatiquement les items d\u2019une collection.",status:"Brouillon",settings:{collectionId:"",limit:6}},form:{type:"Form",label:"Formulaire de contact",description:"Formulaire avec envoi vers un service externe.",status:"Brouillon",settings:{formTitle:"Contactez-nous",actionUrl:"",method:"POST",serviceName:"",submitLabel:"Envoyer",successMessage:"Merci pour votre message !"}},newsletterembed:{type:"NewsletterEmbed",label:"Newsletter / Embed",description:"Int\xE9gration d'un formulaire newsletter externe (Brevo, Mailchimp\u2026).",status:"Brouillon",settings:{title:"Restez inform\xE9",serviceName:"",embedCode:""}}},Br=e=>{try{window.localStorage.setItem(gs.active,e)}catch{}},jr=e=>{var t;try{let s=window.localStorage.getItem(gs.active);if(s&&e.some(n=>n.id===s))return s}catch{}return((t=e[0])==null?void 0:t.id)||null},Fr=e=>!e||e<=0?"0 bloc":e===1?"1 bloc":`${e} blocs`,Fo=e=>{if(!e||e==="/")return"/";let t=zt(e.replace(/^\//,""));return t?`/${t}`:"/"},co=(e="page",t="block")=>`${e}-${t}-${Date.now().toString(36)}-${Math.floor(Math.random()*1e3)}`,pn=(e,t)=>[rs(co(e,"intro"),"Introduction","Paragraphe","Brouillon",`Paragraphe introductif pour "${t}".`,[{label:"Longueur",value:"2 paragraphes"}],{title:`Introduction \xE0 ${t}`,content:"Ajoutez votre premier paragraphe de pr\xE9sentation.",align:"left"}),rs(co(e,"content"),"Zone de contenu","Groupe","Brouillon","Section principale \xE0 composer avec textes et visuels.",[{label:"Colonnes",value:"Auto"}],{layout:"grid",columnsMobile:"1",columnsDesktop:"2"})],Po=e=>{a&&(a.textContent=(e==null?void 0:e.name)||(e==null?void 0:e.title)||"Page"),d&&(d.textContent=(e==null?void 0:e.slug)||"/")},Pr=e=>{if(!y)return;y.innerHTML="",(e&&e.badges&&e.badges.length>0?e.badges:["Structure en cours"]).forEach(s=>{let n=document.createElement("span");n.className="rounded-full bg-slate-100 px-3 py-1",n.textContent=s,y.appendChild(n)})},Mr=e=>{switch((e||"").toLowerCase()){case"en ligne":return"bg-emerald-50 text-emerald-700";case"brouillon":return"bg-amber-50 text-amber-700";default:return"bg-slate-100 text-slate-600"}},Rs=e=>{if(!(!oe||!re)){if(!e){oe.classList.remove("hidden"),re.classList.add("hidden"),ne==null||ne.classList.add("hidden"),E==null||E.classList.add("hidden"),he==null||he.classList.add("hidden");return}oe.classList.add("hidden"),re.classList.remove("hidden"),he&&(e.status?(he.textContent=e.status,he.className=`rounded-full px-3 py-1 text-xs font-semibold ${Mr(e.status)}`,he.classList.remove("hidden")):he.classList.add("hidden")),js(e)}},hs=e=>{if(!f)return;let t=f.contentDocument;if(!t)return;t.querySelectorAll("[data-preview-block]").forEach(n=>{n.dataset.previewBlock===e?(n.classList.add("preview-block-active"),ho&&e&&n.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})):n.classList.remove("preview-block-active")}),Z&&(Z.style.borderColor=e?"rgba(156, 107, 255, 0.5)":"transparent")},Mo=(e,t=!1,s=null)=>{var xo;let n=e.id===He,l=(e.type||"").toLowerCase(),v=l==="groupe"||l==="group"||l==="sections"||l==="grid",x=document.createElement("div");x.dataset.blockItem="true",x.dataset.blockId=e.id,s&&(x.dataset.parentBlockId=s),v&&(x.dataset.isGroup="true"),x.setAttribute("role","option"),x.setAttribute("aria-selected",n?"true":"false"),x.setAttribute("draggable","true"),x.tabIndex=0,x.className=["relative flex items-center gap-3 rounded-2xl border px-3 py-2 text-left transition group",t?"ml-6 border-dashed":"",n?"bg-slate-100 border-[#9C6BFF]/40 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let L=document.createElement("span");L.className=`absolute inset-y-2 left-0 w-1 rounded-full bg-[#9C6BFF] ${n?"":"hidden"}`,x.appendChild(L);let te=document.createElement("div");te.className="flex flex-1 items-center gap-3";let ke=document.createElement("div");ke.className="hidden lg:flex cursor-grab active:cursor-grabbing flex-shrink-0 items-center text-lg text-slate-400 hover:text-slate-600 transition-colors select-none",ke.innerHTML="\u22EE\u22EE",ke.setAttribute("title","Glisser pour r\xE9ordonner"),te.appendChild(ke);let be=document.createElement("div");be.className="flex-1";let Qe=document.createElement("div");Qe.className="flex items-center gap-2 text-[11px] uppercase tracking-wide text-slate-500";let Mt=document.createElement("span");Mt.className="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600",Mt.textContent=e.type;let Ce=document.createElement("span");if(Ce.className="text-slate-400",Ce.textContent=e.status,Qe.appendChild(Mt),v){let et=(e.children||[]).length,_t=document.createElement("span");_t.className="rounded-full bg-violet-100 px-2 py-0.5 text-[10px] font-semibold text-violet-600",_t.textContent=`${et} \xE9l\xE9ment${et!==1?"s":""}`,Qe.appendChild(_t)}Qe.appendChild(Ce);let B=document.createElement("p");B.className="mt-1 text-sm font-semibold text-slate-900";let lt=e.settings&&e.settings.title||e.label||"Bloc sans titre";if(B.textContent=lt,be.appendChild(Qe),be.appendChild(B),l==="collectiongrid"&&e.collectionId){let et=((xo=At.find(cn=>cn.id===e.collectionId))==null?void 0:xo.name)||e.collectionId,_t=document.createElement("p");_t.className="text-xs text-slate-400",_t.textContent=`Collection : ${et}`,be.appendChild(_t)}te.appendChild(be),x.appendChild(te);let Ee=document.createElement("div");Ee.className="flex flex-col gap-1 text-xs text-slate-400";let me=document.createElement("div");me.className="flex items-center gap-1 lg:hidden";let Xe=document.createElement("button");Xe.type="button",Xe.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",Xe.textContent="\u2191",Xe.addEventListener("click",et=>{et.stopPropagation(),s?No(s,e.id,-1):Ho(e.id,-1)});let ct=document.createElement("button");ct.type="button",ct.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",ct.textContent="\u2193",ct.addEventListener("click",et=>{et.stopPropagation(),s?No(s,e.id,1):Ho(e.id,1)}),me.appendChild(Xe),me.appendChild(ct),Ee.appendChild(me);let je=document.createElement("button");return je.type="button",je.className="inline-flex items-center justify-center rounded-lg border border-transparent px-2 py-1 text-[12px] text-rose-500 hover:text-rose-700",je.innerHTML="\u{1F5D1}\uFE0F",je.addEventListener("click",et=>{et.stopPropagation(),s?Hr(s,e.id):Wr(e.id)}),Ee.appendChild(je),x.appendChild(Ee),x.addEventListener("click",()=>{Ot(e.id,s)}),x.addEventListener("keydown",et=>{(et.key==="Enter"||et.key===" ")&&(et.preventDefault(),Ot(e.id,s))}),{item:x,isGroup:v,block:e}},Nr=e=>{let t=document.createElement("div");return t.dataset.groupDropZone=e.id,t.className="ml-6 border-2 border-dashed border-slate-200 rounded-xl p-3 text-center text-xs text-slate-400 hover:border-violet-300 hover:bg-violet-50/50 transition-colors cursor-pointer",t.innerHTML='<span class="pointer-events-none">\u{1F4E6} Glissez un bloc ici ou cliquez pour ajouter</span>',t.addEventListener("dragover",s=>{s.preventDefault(),s.stopPropagation(),t.classList.add("border-violet-400","bg-violet-50")}),t.addEventListener("dragleave",s=>{s.stopPropagation(),t.classList.remove("border-violet-400","bg-violet-50")}),t.addEventListener("drop",s=>{s.preventDefault(),s.stopPropagation(),t.classList.remove("border-violet-400","bg-violet-50");let n=s.dataTransfer.getData("text/plain");n&&n!==e.id&&Dr(n,e.id)}),t.addEventListener("click",()=>{Ur(e.id)}),t},ht=e=>{if(!H)return;H.innerHTML="";let t=(e==null?void 0:e.blocks)||[];if(T&&(T.textContent=Fr(t.length)),t.length===0){H.classList.add("hidden"),xe==null||xe.classList.remove("hidden");return}H.classList.remove("hidden"),xe==null||xe.classList.add("hidden"),t.forEach(s=>{let{item:n,isGroup:l}=Mo(s,!1,null);if(H.appendChild(n),l){(s.children||[]).forEach(L=>{let{item:te}=Mo(L,!0,s.id);H.appendChild(te)});let x=Nr(s);H.appendChild(x)}})},Dr=(e,t)=>{if(!u)return;let s=u.blocks.findIndex(L=>L.id===e),n=u.blocks.find(L=>L.id===t);if(s===-1||!n)return;let v=(u.blocks[s].type||"").toLowerCase();if(v==="groupe"||v==="group"){$("Impossible d'imbriquer des groupes","error");return}let[x]=u.blocks.splice(s,1);n.children||(n.children=[]),n.children.push(x),ht(u),savePageBlocks(),$("Bloc ajout\xE9 au groupe")},Hr=(e,t)=>{if(!u)return;let s=u.blocks.find(x=>x.id===e);if(!s||!s.children)return;let n=s.children.findIndex(x=>x.id===t);if(n===-1)return;let[l]=s.children.splice(n,1),v=u.blocks.findIndex(x=>x.id===e);u.blocks.splice(v+1,0,l),ht(u),savePageBlocks(),$("Bloc sorti du groupe")},No=(e,t,s)=>{if(!u)return;let n=u.blocks.find(L=>L.id===e);if(!n||!n.children)return;let l=n.children.findIndex(L=>L.id===t);if(l===-1)return;let v=l+s;if(v<0||v>=n.children.length)return;let[x]=n.children.splice(l,1);n.children.splice(v,0,x),ht(u),savePageBlocks()},Ur=e=>{vs=e,openBlockPicker()},vs=null,Rr=e=>{!at||!e||(Rt=e,ps&&(ps.textContent=e.title||e.id),at.classList.remove("hidden"),at.classList.add("flex"))},uo=()=>{at&&(at.classList.add("hidden"),at.classList.remove("flex"),Rt=null)},Or=async()=>{if(!Ye||!Rt)return;let e=Rt.id,t=Rt.title||e;it&&(it.disabled=!0,it.textContent="Suppression...");try{let s=await fetch(`${Ye}/${encodeURIComponent(e)}`,{method:"DELETE",credentials:"include"}),n=await s.json();if(!s.ok)throw new Error(n.message||"Erreur serveur");le=le.filter(l=>l.id!==e),Be===e?le.length>0?Lt(le[0].id):(Be=null,u=null,Zt(le,null),ht(null),oe==null||oe.classList.remove("hidden"),re==null||re.classList.add("hidden"),f&&(f.srcdoc=Ht())):Zt(le,Be),uo(),$(`Page "${t}" supprim\xE9e`)}catch(s){console.error("[pages] delete failed",s),$(s.message||"Erreur suppression")}finally{it&&(it.disabled=!1,it.textContent="Supprimer")}},Zt=(e,t)=>{o.forEach(s=>{s.innerHTML="",e.forEach(n=>{let l=document.createElement("li");l.className="flex items-center gap-1";let v=document.createElement("button");v.type="button",v.dataset.pageId=n.id,v.className=["flex-1 flex items-center gap-3 px-3 py-2 text-left transition",t===n.id?"bg-[#9C6BFF]/10 text-slate-900 border border-[#9C6BFF]/40 rounded-xl shadow-sm":"text-slate-700 hover:bg-slate-50 rounded-xl"].join(" "),t===n.id?v.setAttribute("aria-current","page"):v.removeAttribute("aria-current");let x=n.name||n.title;v.innerHTML=`
            <span class="flex h-9 w-9 items-center justify-center rounded-xl border border-slate-200 bg-white text-slate-500">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M6.5 4.5h7l4 4v11a1 1 0 0 1-1 1h-10a1 1 0 0 1-1-1v-14a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
                <path d="M13.5 4.5v4a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.4"/>
              </svg>
            </span>
            <div class="flex flex-col">
              <span class="text-sm font-semibold">${x}</span>
              <span class="text-xs text-slate-500">${n.slug}</span>
            </div>
          `,v.addEventListener("click",()=>{Lt(n.id),po()||fo()}),l.appendChild(v);let L=document.createElement("button");L.type="button",L.className="flex-shrink-0 p-2 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition",L.title="Supprimer cette page",L.setAttribute("aria-label",`Supprimer ${x}`),L.innerHTML=`
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14ZM10 11v6M14 11v6"/>
            </svg>
          `,L.addEventListener("click",te=>{te.stopPropagation(),Rr(n)}),l.appendChild(L),s.appendChild(l)})})},ns=()=>{if(!u||!Array.isArray(u.blocks))return null;let e=u.blocks.find(t=>t.id===He);if(!e){for(let t of u.blocks)if(t.children&&(e=t.children.find(s=>s.id===He),e))break}return e||null},Do=null,Ot=(e,t=null)=>{if(!u)return;if(!e){He=null,Do=null,ht(u),Rs(null),hs(null);return}let s=null;if(s=u.blocks.find(n=>n.id===e),!s&&t){let n=u.blocks.find(l=>l.id===t);n&&n.children&&(s=n.children.find(l=>l.id===e))}if(!s){for(let n of u.blocks)if(n.children){let l=n.children.find(v=>v.id===e);if(l){s=l,t=n.id;break}}}s||(s=u.blocks[0]||null,t=null),He=(s==null?void 0:s.id)||null,Do=t,ht(u),Rs(s),hs(He)},as=e=>{if(!u)return;let t={...u,blocks:e};Kr(t)},Os=()=>window.matchMedia("(min-width: 1024px)").matches;function Ho(e,t){if(!u||!e||!t)return;let s=[...u.blocks||[]],n=s.findIndex(x=>x.id===e);if(n<0)return;let l=n+t;if(l<0||l>=s.length)return;let[v]=s.splice(n,1);s.splice(l,0,v),as(s),Lt(u.id,{preserveBlock:!0}),Ot(v.id)}function fn(e,t){if(!u||!e||!t||e===t)return;let s=[...u.blocks||[]],n=s.findIndex(x=>x.id===e),l=s.findIndex(x=>x.id===t);if(n<0||l<0)return;let[v]=s.splice(n,1);s.splice(l,0,v),as(s),Lt(u.id,{preserveBlock:!0}),Ot(v.id)}function zr(e,t,s){if(!u||!e||!t||e===t)return;let n=[...u.blocks||[]],l=n.findIndex(te=>te.id===e),v=n.findIndex(te=>te.id===t);if(l<0||v<0)return;let[x]=n.splice(l,1);l<v&&v--;let L=s==="before"?v:v+1;n.splice(L,0,x),as(n),Lt(u.id,{preserveBlock:!0}),Ot(x.id)}function Uo(){if(!H)return;let e=Os();H.querySelectorAll("[data-block-item]").forEach(t=>{t.setAttribute("draggable",e?"true":"false")})}function ys(){b&&(b.classList.add("hidden"),bs=!1)}function Vr(){b&&(b.classList.remove("hidden"),bs=!0)}function Jr(){bs?ys():Vr()}function Gr(e){var v;if(!u||!e)return;let t=Us[e];if(!t)return;let s=(u.blocks||[]).filter(x=>x.type===t.type).length+1,n=rs(co(u.id,e),`${t.label} ${s}`,t.type,t.status,t.description,t.props,t.settings||{});if((t.type||"").toLowerCase()==="collectiongrid"){let x=((v=At[0])==null?void 0:v.id)||"";n.collectionId=x,n.settings.collectionId=x,n.settings.limit=n.settings.limit||6}if(vs){let x=u.blocks.find(L=>L.id===vs);if(x){x.children||(x.children=[]),x.children.push(n),vs=null,ht(u),savePageBlocks(),Ot(n.id,x.id),ys(),$("Bloc ajout\xE9 au groupe");return}vs=null}let l=[...u.blocks||[],n];as(l),Lt(u.id,{preserveBlock:!0}),Ot(n.id),ys(),$("Bloc ajout\xE9")}function Ro(e){var n,l;if(!u)return;let t=(u.blocks||[]).filter(v=>v.id!==e),s=e===He?((n=t[0])==null?void 0:n.id)||null:He||((l=t[0])==null?void 0:l.id)||null;as(t),He=s,Lt(u.id,{preserveBlock:!0}),He?Ot(He):(Rs(null),hs(null)),$("Bloc supprim\xE9")}function mo(){K&&(K.classList.add("hidden"),K.classList.remove("flex"),Vs=null)}function Wr(e){if(!K){Ro(e);return}Vs=e,K.classList.remove("hidden"),K.classList.add("flex")}let Kr=e=>{if(!e)return;let t=is(e);le=le.map(s=>s.id===t.id?t:s),u=t,ze(t)},Lt=(e,t={})=>{var l,v;let s=le.find(x=>x.id===e)||le[0]||null;u=s?is(s):null,Be=(s==null?void 0:s.id)||null,(!t.preserveBlock||!u||!u.blocks.some(x=>x.id===He))&&(He=((v=(l=u==null?void 0:u.blocks)==null?void 0:l[0])==null?void 0:v.id)||null),Be&&Br(Be),Zt(le,Be),Po(u),Pr(u),Ut(u),ht(u),Rs(ns()),hs(He),Uo(),bs&&ys()},po=()=>window.matchMedia("(min-width: 1024px)").matches,Oo=()=>{Ft&&(po()?(Ft.classList.add("is-open"),Ze==null||Ze.classList.add("hidden"),document.body.classList.remove("overflow-hidden")):Ft.classList.remove("is-open"))},Zr=()=>{!Ft||po()||(Ft.classList.add("is-open"),Ze==null||Ze.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},fo=()=>{Ft&&(Ft.classList.remove("is-open"),Ze==null||Ze.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))},_r=()=>{!ot||!Pt||(ot.classList.remove("hidden"),Pt.classList.add("hidden"),Me&&(Me.textContent=""),zs=!1,_e&&(_e.value="",_e.focus()),Wt&&(Wt.value=""),rt&&(rt.value=""))},zo=()=>{!ot||!Pt||(ot.classList.add("hidden"),Pt.classList.remove("hidden"),Me&&(Me.textContent=""),zs=!1,ot.reset())},Yr=()=>{!_e||!rt||zs&&rt.value.trim().length>0||(rt.value=Fo(_e.value))},le=[],Be=null,zs=!1,u=null,He=null,bs=!1,Vs=null,go="",ho=!1,xs=null,At=[],Xr=e=>{let t={...e,props:Array.isArray(e.props)?e.props:[],settings:{...e.settings||{}}};return(t.type||"").toLowerCase()==="collectiongrid"&&(t.collectionId=t.collectionId||t.settings.collectionId||"",t.settings.collectionId=t.collectionId,t.settings.limit=t.settings.limit||6),t},is=e=>{var t,s;return{...e,blocks:(e.blocks||[]).map(n=>Xr(n)),seo:{title:(((t=e.seo)==null?void 0:t.title)||"").trim(),description:(((s=e.seo)==null?void 0:s.description)||"").trim()}}},Qr=async()=>{if(!fs){At=[],Js();return}try{let e=await fetch(fs,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les collections.");let t=await e.json().catch(()=>[]);At=Array.isArray(t)?t:[];let s=(j==null?void 0:j.value)||"";Js(s)}catch(e){console.error("[design] collections load",e),$("Collections indisponibles."),At=[],Js()}},vo=e=>{if(!J)return;if(!e){J.textContent=At.length?"S\xE9lectionnez une collection pour afficher ses informations.":"Aucune collection disponible. Ajoutez-en depuis l\u2019onglet Contenus.";return}let t=At.find(n=>n.id===e);if(!t){J.textContent=`Collection ${e}`;return}let s=[];t.description&&s.push(t.description),t.type&&s.push(`Type\xA0: ${t.type}`),J.textContent=s.join(" \xB7 ")||`Collection ${t.name||t.id}`},Js=(e="")=>{if(j){if(j.innerHTML="",!At.length){j.disabled=!0;let t=document.createElement("option");t.value="",t.textContent="Aucune collection disponible",j.appendChild(t),vo("");return}if(j.disabled=!1,e&&!At.some(t=>t.id===e)){let t=document.createElement("option");t.value=e,t.textContent=e,j.appendChild(t)}At.forEach(t=>{let s=document.createElement("option");s.value=t.id;let n=t.name||t.id;s.textContent=t.type?`${n} \xB7 ${t.type}`:n,s.dataset.description=t.description||"",j.appendChild(s)}),e&&(j.value=e),vo(j.value||"")}};Qr(),Oo(),io.forEach(e=>{e.addEventListener("click",Zr)}),lo.forEach(e=>{e.addEventListener("click",fo)}),Ze==null||Ze.addEventListener("click",fo),window.addEventListener("resize",()=>{Oo(),Uo()}),Pt==null||Pt.addEventListener("click",_r),ss==null||ss.addEventListener("click",zo),_e==null||_e.addEventListener("input",Yr),rt==null||rt.addEventListener("input",()=>{Me&&(Me.textContent=""),zs=!0}),ot==null||ot.addEventListener("submit",async e=>{if(e.preventDefault(),!Ye){Me&&(Me.textContent="Aucun site s\xE9lectionn\xE9.");return}if(!_e||!rt)return;let t=_e.value.trim(),s=(Wt==null?void 0:Wt.value.trim())||t,n=Fo(rt.value.trim()||t);if(!t||!n){Me&&(Me.textContent="Nom et slug sont requis.");return}Me&&(Me.textContent=""),r&&(r.disabled=!0,r.textContent="Cr\xE9ation...");try{let l=await Fe({name:t,title:s,slug:n});if(!l||!l.id)throw new Error("R\xE9ponse invalide.");le=[...le,is(l)],zo(),$("Page cr\xE9\xE9e"),Lt(l.id)}catch(l){console.error("[design] create page failed",l),Me&&(Me.textContent=l.message||"Impossible de cr\xE9er la page.")}finally{r&&(r.disabled=!1,r.textContent="Cr\xE9er")}});let yo=()=>{we&&(we.value=""),nt&&(nt.classList.add("hidden"),nt.textContent="")},Vo=()=>{if(!we)return null;let e=we.value.trim();if(!e)return nt&&nt.classList.add("hidden"),null;try{let t=JSON.parse(e);return nt&&nt.classList.add("hidden"),t}catch(t){return nt&&(nt.classList.remove("hidden"),nt.textContent=`\u274C JSON invalide : ${t.message}`),null}},en=()=>{if(!we)return;let e=we.value.trim();if(e)try{let t=JSON.parse(e);we.value=JSON.stringify(t,null,2),Vo()}catch{}},ws=()=>{if(ge)if(qt==="upload")ge.disabled=gt.length===0;else if(qt==="paste"){let e=Vo();ge.disabled=!e}else ge.disabled=!0},tn=()=>{g&&(g.classList.remove("hidden"),g.classList.add("flex"),gt=[],qt="upload",bo(),yo(),se&&se.classList.add("hidden"),ue&&(ue.innerHTML=""),ws(),Pe.forEach(e=>{e.dataset.importTab==="upload"?(e.classList.add("bg-[#9C6BFF]","text-white"),e.classList.remove("border","border-slate-200","text-slate-700")):(e.classList.remove("bg-[#9C6BFF]","text-white"),e.classList.add("border","border-slate-200","text-slate-700"))}),Ne.forEach(e=>{e.dataset.importPanel==="upload"?e.classList.remove("hidden"):e.classList.add("hidden")}))},Jo=()=>{g&&(g.classList.add("hidden"),g.classList.remove("flex"),gt=[],yo())},bo=()=>{if(!(!ie||!ee)){if(gt.length===0){ie.classList.add("hidden"),ws();return}ie.classList.remove("hidden"),ee.innerHTML=gt.map(e=>`<li class="flex items-center gap-2"><span class="text-lg">\u{1F4C4}</span>${e.name}</li>`).join(""),ws()}},Go=e=>{let t=Array.from(e).filter(s=>s.type==="application/json"||s.name.endsWith(".json"));if(t.length===0){$("Aucun fichier JSON valide.");return}gt=t,bo()},sn=async()=>{var s,n,l,v,x,L,te,ke,be,Qe,Mt;if(!Ye)return;let e=[];if(console.log("[import] activeImportTab:",qt),qt==="paste"){let Ce=(s=we==null?void 0:we.value)==null?void 0:s.trim();if(console.log("[import] paste text length:",Ce==null?void 0:Ce.length),!Ce){$("Aucun JSON \xE0 importer."),se&&ue&&(se.classList.remove("hidden"),ue.innerHTML='<p class="text-amber-600">\u26A0 Le champ de texte est vide.</p>');return}try{let B=JSON.parse(Ce);console.log("[import] parsed JSON:",B),console.log("[import] parsed type:",typeof B,Array.isArray(B)?"array":"not array"),B&&!Array.isArray(B)&&B.pages?(console.log("[import] detected pages+collections format"),e=B):Array.isArray(B)?e.push(...B):e.push(B),console.log("[import] pagesData prepared:",e)}catch(B){let lt=B.message.match(/position (\d+)/),Ee=B.message;if(lt){let me=parseInt(lt[1],10),Xe=Ce.substring(0,me).split(`
`),ct=Xe.length,je=Xe[Xe.length-1].length+1;Ee=`Ligne ${ct}, colonne ${je}: ${B.message}`}$(`Erreur JSON : ${Ee}`,"error"),console.error("[import] paste parse error",B),se&&ue&&(se.classList.remove("hidden"),ue.innerHTML=`
              <div class="text-rose-600">
                <p class="font-medium">\u2717 Erreur de syntaxe JSON</p>
                <p class="text-xs mt-1">${Ee}</p>
                <p class="text-xs mt-2 text-slate-500">V\xE9rifiez les virgules, guillemets et accolades.</p>
              </div>
            `);return}}else if(qt==="upload"){if(gt.length===0)return;let Ce=[];for(let B of gt){let lt=await B.text();try{let Ee=JSON.parse(lt);Array.isArray(Ee)?e.push(...Ee):e.push(Ee)}catch(Ee){let me=Ee.message.match(/position (\d+)/),Xe=Ee.message;if(me){let ct=parseInt(me[1],10);Xe=`Ligne ${lt.substring(0,ct).split(`
`).length}: ${Ee.message}`}Ce.push({file:B.name,error:Xe}),console.error("[import] parse error",B.name,Ee)}}if(Ce.length>0){if(se&&ue){se.classList.remove("hidden");let B='<div class="text-rose-600"><p class="font-medium">\u2717 Erreurs de syntaxe JSON</p><ul class="ml-4 text-xs mt-1">';Ce.forEach(lt=>{B+=`<li><strong>${lt.file}</strong>: ${lt.error}</li>`}),B+="</ul></div>",e.length>0&&(B+=`<p class="text-amber-600 mt-2 text-sm">\u26A0 ${e.length} page(s) valide(s) seront import\xE9e(s)</p>`),ue.innerHTML=B}if(e.length===0){$("Tous les fichiers contiennent des erreurs JSON","error");return}}}else return;let t=Array.isArray(e)?e.length>0:e&&(((n=e.pages)==null?void 0:n.length)>0||e.title);if(console.log("[import] hasData check:",t,"pagesData:",e),!t){$("Aucune page valide \xE0 importer."),se&&ue&&(se.classList.remove("hidden"),ue.innerHTML=`
            <div class="text-amber-600">
              <p class="font-medium">\u26A0 Aucune page d\xE9tect\xE9e</p>
              <p class="text-xs mt-1">Le JSON doit contenir :</p>
              <ul class="text-xs ml-4 mt-1 list-disc">
                <li>Un objet page avec "title" : <code>{"title": "Ma page", ...}</code></li>
                <li>Un tableau de pages : <code>[{"title": "Page 1"}, {"title": "Page 2"}]</code></li>
                <li>Ou un objet combin\xE9 : <code>{"pages": [...], "collections": {...}}</code></li>
              </ul>
            </div>
          `);return}ge&&(ge.disabled=!0,ge.textContent="Import..."),console.log("[import] Sending to server:",JSON.stringify(e).substring(0,500));try{let Ce=await fetch(`${Ye}/import`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(e)});console.log("[import] Server response status:",Ce.status);let B=await Ce.json();if(console.log("[import] Server response body:",B),!Ce.ok)throw se&&ue&&(se.classList.remove("hidden"),ue.innerHTML=`
              <div class="text-rose-600">
                <p class="font-medium">\u2717 Erreur serveur</p>
                <p class="text-xs mt-1">${B.message||"Erreur inconnue"}</p>
                ${B.details?`<p class="text-xs mt-1 text-slate-500">${B.details}</p>`:""}
              </div>
            `),new Error(B.message||"Erreur serveur");if(se&&ue){se.classList.remove("hidden");let me="",Xe=((l=B.imported)==null?void 0:l.length)>0||((v=B.collectionsCreated)==null?void 0:v.length)>0,ct=((x=B.errors)==null?void 0:x.length)>0;Xe&&!ct?me+='<div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-2"><p class="text-green-800 font-medium">\u2713 Import r\xE9ussi</p></div>':Xe&&ct?me+='<div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-2"><p class="text-amber-800 font-medium">\u26A0 Import partiel</p></div>':ct&&(me+='<div class="bg-rose-50 border border-rose-200 rounded-lg p-3 mb-2"><p class="text-rose-800 font-medium">\u2717 Import \xE9chou\xE9</p></div>'),B.collectionsCreated&&B.collectionsCreated.length>0&&(me+=`<p class="text-violet-700 mt-2">\u2713 ${B.collectionsCreated.length} collection(s) cr\xE9\xE9e(s)</p>`,me+='<ul class="ml-4 text-xs text-slate-600">',B.collectionsCreated.forEach(je=>{me+=`<li>${je.name} (${je.itemsCount} item${je.itemsCount>1?"s":""})</li>`}),me+="</ul>"),B.imported&&B.imported.length>0&&(me+=`<p class="text-green-700 mt-2">\u2713 ${B.imported.length} page(s) import\xE9e(s)</p>`,me+='<ul class="ml-4 text-xs text-slate-600">',B.imported.forEach(je=>{me+=`<li><strong>${je.title}</strong> \u2192 ${je.slug} (${je.action==="updated"?"mise \xE0 jour":"cr\xE9\xE9e"})</li>`}),me+="</ul>"),B.errors&&B.errors.length>0&&(me+=`<p class="text-rose-600 mt-3 font-medium">\u2717 ${B.errors.length} erreur(s)</p>`,me+='<ul class="ml-4 text-xs text-rose-600 space-y-1 mt-1">',B.errors.forEach(je=>{me+=`<li class="bg-rose-50 p-2 rounded"><strong>${je.title}</strong><br/><span class="text-rose-500">${je.error}</span></li>`}),me+="</ul>"),ue.innerHTML=me}let lt=((L=B.imported)==null?void 0:L.length)>0||((te=B.collectionsCreated)==null?void 0:te.length)>0,Ee=((ke=B.errors)==null?void 0:ke.length)>0;if(B.imported&&B.imported.length>0&&(le=await Ie(),Zt(le,Be),le.length>0&&!Be&&Lt(le[0].id)),lt&&!Ee){let me=(be=B.collectionsCreated)!=null&&be.length?` + ${B.collectionsCreated.length} collection(s)`:"";$(`\u2713 Import r\xE9ussi : ${((Qe=B.imported)==null?void 0:Qe.length)||0} page(s)${me}`,"success")}else lt&&Ee?$(`\u26A0 Import partiel : ${((Mt=B.imported)==null?void 0:Mt.length)||0} page(s), ${B.errors.length} erreur(s)`,"warning"):Ee&&$(`\u2717 Import \xE9chou\xE9 : ${B.errors.length} erreur(s)`,"error");gt=[],bo(),yo()}catch(Ce){console.error("[import] failed",Ce),$(Ce.message||"Erreur import","error")}finally{ge&&(ge.disabled=!1,ge.textContent="Importer")}};c==null||c.addEventListener("click",tn),I.forEach(e=>e.addEventListener("click",Jo)),g==null||g.addEventListener("click",e=>{e.target===g&&Jo()}),ae==null||ae.addEventListener("change",e=>{Go(e.target.files)}),O==null||O.addEventListener("dragover",e=>{e.preventDefault(),O.classList.add("border-[#9C6BFF]","bg-[#9C6BFF]/10")}),O==null||O.addEventListener("dragleave",e=>{e.preventDefault(),O.classList.remove("border-[#9C6BFF]","bg-[#9C6BFF]/10")}),O==null||O.addEventListener("drop",e=>{e.preventDefault(),O.classList.remove("border-[#9C6BFF]","bg-[#9C6BFF]/10"),Go(e.dataTransfer.files)}),ge==null||ge.addEventListener("click",sn),we==null||we.addEventListener("input",()=>{ws()}),St==null||St.addEventListener("click",en),Pe.forEach(e=>{e.addEventListener("click",()=>{let t=e.dataset.importTab;qt=t,Pe.forEach(s=>{s.dataset.importTab===t?(s.classList.add("bg-[#9C6BFF]","text-white"),s.classList.remove("border","border-slate-200","text-slate-700")):(s.classList.remove("bg-[#9C6BFF]","text-white"),s.classList.add("border","border-slate-200","text-slate-700"))}),Ne.forEach(s=>{s.dataset.importPanel===t?s.classList.remove("hidden"):s.classList.add("hidden")}),ws()})}),De==null||De.addEventListener("click",async()=>{if(!wt)return;let e=wt.textContent||"";try{await navigator.clipboard.writeText(e),$("Template copi\xE9 !")}catch(t){console.error("[import] copy failed",t),$("Erreur copie")}}),os==null||os.addEventListener("click",uo),it==null||it.addEventListener("click",Or),at==null||at.addEventListener("click",e=>{e.target===at&&uo()}),w==null||w.addEventListener("click",e=>{e.stopPropagation(),Jr()}),document.addEventListener("click",e=>{bs&&(b!=null&&b.contains(e.target)||w!=null&&w.contains(e.target)||ys())}),W.forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();let s=e.dataset.blockAdd;Gr(s)})}),ye==null||ye.addEventListener("click",()=>{mo()}),fe==null||fe.addEventListener("click",()=>{Vs&&Ro(Vs),mo()}),K==null||K.addEventListener("click",e=>{e.target===K&&mo()}),E==null||E.addEventListener("input",e=>{var n,l,v,x;let t=e.target;if(!t||!t.name)return;if(t.name==="group-columns-mobile"||t.name==="group-columns-desktop"){let L=((n=E.querySelector('[name="group-columns-mobile"]'))==null?void 0:n.value)||"1",te=((l=E.querySelector('[name="group-columns-desktop"]'))==null?void 0:l.value)||"3";bt(L,te)}if(t.name==="collection-columns-mobile"||t.name==="collection-columns-desktop"){let L=((v=E.querySelector('[name="collection-columns-mobile"]'))==null?void 0:v.value)||"1",te=((x=E.querySelector('[name="collection-columns-desktop"]'))==null?void 0:x.value)||"3";$e(L,te)}let s=t.closest("[data-block-panel]");if(s&&s.dataset.blockPanel==="appearance"){let L=ns(),te=Bt(L);if(L&&te){let ke=jt(te);Ms(L.id,ke)}}}),E==null||E.addEventListener("change",e=>{var n,l;let t=e.target;if(!t||!t.name)return;if(t.hasAttribute("data-color-select")){let v=t.options[t.selectedIndex],x=((n=v==null?void 0:v.dataset)==null?void 0:n.color)||"#ffffff",L=(l=t.closest(".relative"))==null?void 0:l.querySelector("[data-color-preview]");L&&(x==="transparent"?L.style.background="repeating-conic-gradient(#ccc 0% 25%, white 0% 50%) 50% / 8px 8px":(L.style.backgroundColor=x,L.style.background=""))}let s=t.closest("[data-block-panel]");if(s&&s.dataset.blockPanel==="appearance"){let v=ns(),x=Bt(v);if(v&&x){let L=jt(x);Ms(v.id,L)}}}),j==null||j.addEventListener("change",e=>{let t=e.target;vo((t==null?void 0:t.value)||"")}),E==null||E.addEventListener("submit",Ns),yt==null||yt.addEventListener("click",e=>{e.preventDefault();let t=ns();t&&js(t)}),f==null||f.addEventListener("load",()=>{ho=!0,xt("\xC0 jour"),hs(He)}),h==null||h.addEventListener("click",()=>{let e=window.open("","_blank");if(!e)return;e.opener=null;let t=e.document;t.open(),t.write(go||Ht()),t.close()});let Wo=e=>{var t,s,n;Q&&(e?(Q.classList.remove("hidden"),u&&(S&&(S.value=((t=u.seo)==null?void 0:t.title)||""),P&&(P.value=((s=u.seo)==null?void 0:s.description)||""),q&&(q.checked=((n=u.seo)==null?void 0:n.indexed)!==!1))):Q.classList.add("hidden"))},Gs=(e,t="muted")=>{if(!F)return;let s=t==="success"?"text-emerald-600":t==="error"?"text-rose-600":"text-slate-500";F.textContent=e||"",F.className=`text-sm ${s}`};U==null||U.addEventListener("click",()=>{let e=Q&&!Q.classList.contains("hidden");Wo(!e)}),k==null||k.addEventListener("click",()=>Wo(!1)),p==null||p.addEventListener("submit",async e=>{var t;if(e.preventDefault(),!u){Gs("Aucune page active.","error");return}M&&(M.disabled=!0),Gs("");try{let s={title:((S==null?void 0:S.value)||"").trim(),description:((P==null?void 0:P.value)||"").trim(),indexed:(t=q==null?void 0:q.checked)!=null?t:!0},n={...u,seo:s},l=await ze(n);l&&(u=l,Gs("SEO enregistr\xE9.","success"),$("SEO mis \xE0 jour"),Ut(u))}catch(s){console.error("[seo] save failed",s),Gs(s.message||"Erreur lors de la sauvegarde.","error")}finally{M&&(M.disabled=!1)}});let Ko=e=>{C&&(e?(C.classList.remove("hidden"),u&&(N&&(N.value=u.name||""),V&&(V.value=u.title||""),_&&(_.value=u.slug||""),ce&&(ce.value=u.description||""))):C.classList.add("hidden"))},ls=(e,t="muted")=>{if(!X)return;let s=t==="success"?"text-emerald-600":t==="error"?"text-rose-600":"text-slate-500";X.textContent=e||"",X.className=`text-sm ${s}`};R==null||R.addEventListener("click",()=>{let e=C&&!C.classList.contains("hidden");Ko(!e)}),m==null||m.addEventListener("click",()=>Ko(!1)),D==null||D.addEventListener("submit",async e=>{if(e.preventDefault(),!u){ls("Aucune page active.","error");return}pe&&(pe.disabled=!0),ls("");try{let t=((N==null?void 0:N.value)||"").trim(),s=((V==null?void 0:V.value)||"").trim(),n=((_==null?void 0:_.value)||"").trim(),l=((ce==null?void 0:ce.value)||"").trim();if(!s){ls("Le titre est requis.","error"),pe&&(pe.disabled=!1);return}if(!n||!n.startsWith("/")){ls("Le slug doit commencer par /.","error"),pe&&(pe.disabled=!1);return}let v={...u,name:t||s,title:s,slug:n,description:l},x=await ze(v);x&&(u=x,le=le.map(L=>L.id===x.id?x:L),ls("Propri\xE9t\xE9s enregistr\xE9es.","success"),$("Page mise \xE0 jour"),Po(u),Zt(le,Be),Ut(u))}catch(t){console.error("[page-props] save failed",t),ls(t.message||"Erreur lors de la sauvegarde.","error")}finally{pe&&(pe.disabled=!1)}});let on=e=>{let t=e.target.closest("[data-block-item]");if(!t||!Os()){e.preventDefault();return}if(Tt=t.dataset.blockId||null,!Tt){e.preventDefault();return}e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",Tt),requestAnimationFrame(()=>{t.classList.add("opacity-50","scale-[0.98]","shadow-lg","ring-2","ring-[#9C6BFF]")})},Zo=()=>{H==null||H.querySelectorAll("[data-block-item]").forEach(e=>{e.classList.remove("opacity-50","scale-[0.98]","shadow-lg","ring-2","ring-[#9C6BFF]","border-t-4","border-b-4","border-t-[#9C6BFF]","border-b-[#9C6BFF]","pt-6","pb-6")})},rn=()=>{Tt=null,Zo()},nn=e=>{if(!Tt||!Os())return;let t=e.target.closest("[data-block-item]");if(!t||t.dataset.blockId===Tt)return;e.preventDefault(),e.dataTransfer.dropEffect="move";let s=t.getBoundingClientRect(),n=s.top+s.height/2,l=e.clientY<n;H==null||H.querySelectorAll("[data-block-item]").forEach(v=>{v!==t&&v.dataset.blockId!==Tt&&v.classList.remove("border-t-4","border-b-4","border-t-[#9C6BFF]","border-b-[#9C6BFF]","pt-6","pb-6")}),t.classList.remove("border-t-4","border-b-4","border-t-[#9C6BFF]","border-b-[#9C6BFF]","pt-6","pb-6"),l?t.classList.add("border-t-4","border-t-[#9C6BFF]","pt-6"):t.classList.add("border-b-4","border-b-[#9C6BFF]","pb-6"),t.dataset.dropPosition=l?"before":"after"},an=e=>{let t=e.target.closest("[data-block-item]");if(!t)return;let s=e.relatedTarget;s&&t.contains(s)||(t.classList.remove("border-t-4","border-b-4","border-t-[#9C6BFF]","border-b-[#9C6BFF]","pt-6","pb-6"),delete t.dataset.dropPosition)},ln=e=>{if(!Tt||!Os())return;e.preventDefault();let t=e.target.closest("[data-block-item]"),s=Tt,n=(t==null?void 0:t.dataset.dropPosition)||"after";Tt=null,Zo();let l=(t==null?void 0:t.dataset.blockId)||null;!l||s===l||zr(s,l,n)},Tt=null;H==null||H.addEventListener("dragstart",on),H==null||H.addEventListener("dragend",rn),H==null||H.addEventListener("dragover",nn),H==null||H.addEventListener("dragleave",an),H==null||H.addEventListener("drop",ln),Vt(),document.addEventListener("ai-page-updated",async e=>{var t;console.log("[design] Rafra\xEEchissement d\xE9clench\xE9 par IA",e.detail);try{let s=await Ie();if(le=(Array.isArray(s)?s:[]).map(n=>is(n)),(t=e.detail)!=null&&t.pageId){let n=le.find(l=>l.id===e.detail.pageId);n&&(u=n,Be=n.id,Ut(u),ht(u),$("Page mise \xE0 jour par l'IA"))}else if(Be){let n=le.find(l=>l.id===Be);n&&(u=n,Ut(u),ht(u))}}catch(s){console.error("[design] Erreur rafra\xEEchissement IA:",s)}})}function fr(){var rt,ss,Me;let o=document.querySelector("[data-collection-list]");if(!o)return;let a={empty:document.querySelector('[data-content-view="empty"]'),header:document.querySelector('[data-content-view="header"]'),collection:document.querySelector('[data-content-view="collection"]'),footer:document.querySelector('[data-content-view="footer"]')},d=document.querySelectorAll("[data-content-section]"),y=document.querySelectorAll("[data-content-section-trigger]"),f=document.querySelector("[data-content-drawer]"),h=document.querySelector("[data-content-drawer-backdrop]"),z=document.querySelectorAll("[data-content-drawer-open]"),Z=document.querySelectorAll("[data-content-drawer-close]"),U=document.querySelector("[data-header-status]"),Q=document.querySelector("[data-footer-status]"),k=document.querySelector("[data-collection-count]"),p={logo:document.querySelector('[name="header-logo"]'),logoAlt:document.querySelector('[name="header-logo-alt"]'),logoUrl:document.querySelector('[name="header-logo-url"]'),ctaText:document.querySelector('[name="header-cta-text"]'),ctaUrl:document.querySelector('[name="header-cta-url"]'),ctaStyle:document.querySelector('[name="header-cta-style"]'),position:document.querySelector('[name="header-position"]'),bg:document.querySelector('[name="header-bg"]')},S=document.querySelector("[data-header-nav-list]"),P=document.querySelector("[data-header-nav-add]"),q=document.querySelector("[data-header-save]"),F=document.querySelector("[data-template-header-nav-item]"),M=document.querySelector("[data-header-pages-list]"),R=[],C=[],m={linkedin:document.querySelector('[name="footer-social-linkedin"]'),twitter:document.querySelector('[name="footer-social-twitter"]'),instagram:document.querySelector('[name="footer-social-instagram"]'),facebook:document.querySelector('[name="footer-social-facebook"]'),youtube:document.querySelector('[name="footer-social-youtube"]'),github:document.querySelector('[name="footer-social-github"]'),copyright:document.querySelector('[name="footer-copyright"]'),legalUrl:document.querySelector('[name="footer-legal-url"]'),privacyUrl:document.querySelector('[name="footer-privacy-url"]'),bg:document.querySelector('[name="footer-bg"]'),columnsCount:document.querySelector('[name="footer-columns-count"]')},D=document.querySelector("[data-footer-columns-list]"),N=document.querySelector("[data-footer-column-add]"),V=document.querySelector("[data-footer-save]"),_=document.querySelector("[data-template-footer-column]"),ce=document.querySelector("[data-template-footer-link]"),X=null,pe={nav:[],logo:{},cta:{},style:{}},H={columns:[],socials:{},copyright:"",legal:{},style:{}},xe=Se((G==null?void 0:G.slugValue)||Y.slug||""),T=xe,w=xe?`/api/sites/${encodeURIComponent(xe)}/layout`:null,b=r=>{Object.entries(a).forEach(([c,g])=>{g&&g.classList.toggle("hidden",c!==r)}),d.forEach(c=>{c.dataset.contentSection===r?c.dataset.active="true":delete c.dataset.active}),X=r},W=()=>{f==null||f.classList.add("is-open"),f&&(f.style.transform="translateX(0)"),h==null||h.classList.remove("hidden"),document.body.classList.add("overflow-hidden")},K=()=>{f==null||f.classList.remove("is-open"),f&&(f.style.transform=""),h==null||h.classList.add("hidden"),document.body.classList.remove("overflow-hidden")};z.forEach(r=>r.addEventListener("click",W)),Z.forEach(r=>r.addEventListener("click",K)),h==null||h.addEventListener("click",K),d.forEach(r=>{r.addEventListener("click",()=>{let c=r.dataset.contentSection;(c==="header"||c==="footer")&&b(c),K()})}),y.forEach(r=>{r.addEventListener("click",()=>{let c=r.dataset.contentSectionTrigger;c&&b(c)})});let fe=async()=>{if(!(!T||!M))try{let r=await fetch(`/api/sites/${T}/pages`,{credentials:"include"});if(!r.ok)throw new Error("Erreur chargement pages");R=await r.json(),ye()}catch(r){console.error("[header] load pages error",r),M.innerHTML='<p class="text-xs text-red-500">Erreur chargement pages</p>'}},ye=()=>{if(M){if(M.innerHTML="",R.length===0){M.innerHTML='<p class="text-xs text-slate-400 italic">Aucune page disponible</p>';return}R.forEach(r=>{let c=r.slug||r.id,g=r.name||r.title||c,I=c==="index"?"/":`/${c}`,O=C.some(ee=>ee.url===I),ae=document.createElement("label");ae.className="flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer transition-colors",ae.innerHTML=`
          <input type="checkbox" name="nav-page" value="${I}" data-page-title="${g}"
                 class="w-4 h-4 rounded border-slate-300 text-violet-600 focus:ring-violet-500"
                 ${O?"checked":""}>
          <span class="flex-1 text-sm text-slate-700">${g}</span>
          <span class="text-xs text-slate-400">${I}</span>
        `;let ie=ae.querySelector("input");ie.addEventListener("change",()=>{ie.checked?C.some(ee=>ee.url===I)||C.push({label:g,url:I}):C=C.filter(ee=>ee.url!==I)}),M.appendChild(ae)})}},oe=()=>{var c,g,I,O,ae,ie,ee,se,ue,ge,Pe,Ne,De;let r=[];return M==null||M.querySelectorAll('input[name="nav-page"]:checked').forEach(wt=>{let we=wt.value,St=wt.dataset.pageTitle||we;r.push({label:St,url:we})}),{logo:{src:((g=(c=p.logo)==null?void 0:c.value)==null?void 0:g.trim())||"",alt:((O=(I=p.logoAlt)==null?void 0:I.value)==null?void 0:O.trim())||"",url:((ie=(ae=p.logoUrl)==null?void 0:ae.value)==null?void 0:ie.trim())||"/"},nav:r,cta:{text:((se=(ee=p.ctaText)==null?void 0:ee.value)==null?void 0:se.trim())||"",url:((ge=(ue=p.ctaUrl)==null?void 0:ue.value)==null?void 0:ge.trim())||"",style:((Pe=p.ctaStyle)==null?void 0:Pe.value)||"primary"},style:{position:((Ne=p.position)==null?void 0:Ne.value)||"static",bg:((De=p.bg)==null?void 0:De.value)||"bg-white"}}},he=async r=>{var g,I,O,ae,ie,ee,se,ue,ge,Pe,Ne;if(!r)return;p.logo&&(p.logo.value=((g=r.logo)==null?void 0:g.src)||""),p.logoAlt&&(p.logoAlt.value=((I=r.logo)==null?void 0:I.alt)||""),p.logoUrl&&(p.logoUrl.value=((O=r.logo)==null?void 0:O.url)||"/"),p.ctaText&&(p.ctaText.value=((ae=r.cta)==null?void 0:ae.text)||""),p.ctaUrl&&(p.ctaUrl.value=((ie=r.cta)==null?void 0:ie.url)||""),p.ctaStyle&&(p.ctaStyle.value=((ee=r.cta)==null?void 0:ee.style)||"primary"),p.position&&(p.position.value=((se=r.style)==null?void 0:se.position)||"static"),p.bg&&(p.bg.value=((ue=r.style)==null?void 0:ue.bg)||"bg-white"),C=r.nav||[],await fe();let c=((ge=r.logo)==null?void 0:ge.src)||((Pe=r.nav)==null?void 0:Pe.length)>0||((Ne=r.cta)==null?void 0:Ne.text);U&&(U.classList.toggle("bg-green-500",!!c),U.classList.toggle("bg-slate-300",!c),U.title=c?"Configur\xE9":"Non configur\xE9")};q==null||q.addEventListener("click",async()=>{if(w){q.disabled=!0,q.textContent="Enregistrement...";try{let r=oe();if(!(await fetch(`${w}/header`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(r)})).ok)throw new Error("Erreur serveur");pe=r,he(r),$("Header enregistr\xE9")}catch(r){console.error("[header] save error",r),$("Erreur lors de l'enregistrement","error")}finally{q.disabled=!1,q.textContent="Enregistrer"}}});let re=(r,c="",g="")=>{if(!ce||!r)return;let I=ce.content.cloneNode(!0),O=I.querySelector("[data-footer-link]"),ae=I.querySelector('[name="link-label"]'),ie=I.querySelector('[name="link-url"]'),ee=I.querySelector("[data-link-remove]");ae&&(ae.value=c),ie&&(ie.value=g),ee==null||ee.addEventListener("click",()=>O==null?void 0:O.remove()),r.appendChild(I)},Ae=(r="",c=[])=>{if(!_||!D)return;let g=_.content.cloneNode(!0),I=g.querySelector("[data-footer-column]"),O=g.querySelector('[name="column-title"]'),ae=g.querySelector("[data-column-links]"),ie=g.querySelector("[data-column-link-add]"),ee=g.querySelector("[data-column-remove]");O&&(O.value=r),c.forEach(se=>re(ae,se.label,se.url)),ie==null||ie.addEventListener("click",()=>re(ae)),ee==null||ee.addEventListener("click",()=>I==null?void 0:I.remove()),D.appendChild(g)},Ct=()=>{var c,g,I,O,ae,ie,ee,se,ue,ge,Pe,Ne,De,wt,we,St,nt,gt,qt,at;let r=[];return D==null||D.querySelectorAll("[data-footer-column]").forEach(ps=>{var Rt,Ds;let os=((Ds=(Rt=ps.querySelector('[name="column-title"]'))==null?void 0:Rt.value)==null?void 0:Ds.trim())||"",it=[];ps.querySelectorAll("[data-footer-link]").forEach(Hs=>{var fs,gs,rs,Us;let Kt=((gs=(fs=Hs.querySelector('[name="link-label"]'))==null?void 0:fs.value)==null?void 0:gs.trim())||"",Ye=((Us=(rs=Hs.querySelector('[name="link-url"]'))==null?void 0:rs.value)==null?void 0:Us.trim())||"";(Kt||Ye)&&it.push({label:Kt,url:Ye})}),(os||it.length>0)&&r.push({title:os,links:it})}),{columns:r,socials:{linkedin:((g=(c=m.linkedin)==null?void 0:c.value)==null?void 0:g.trim())||"",twitter:((O=(I=m.twitter)==null?void 0:I.value)==null?void 0:O.trim())||"",instagram:((ie=(ae=m.instagram)==null?void 0:ae.value)==null?void 0:ie.trim())||"",facebook:((se=(ee=m.facebook)==null?void 0:ee.value)==null?void 0:se.trim())||"",youtube:((ge=(ue=m.youtube)==null?void 0:ue.value)==null?void 0:ge.trim())||"",github:((Ne=(Pe=m.github)==null?void 0:Pe.value)==null?void 0:Ne.trim())||""},copyright:((wt=(De=m.copyright)==null?void 0:De.value)==null?void 0:wt.trim())||"",legal:{url:((St=(we=m.legalUrl)==null?void 0:we.value)==null?void 0:St.trim())||"",privacyUrl:((gt=(nt=m.privacyUrl)==null?void 0:nt.value)==null?void 0:gt.trim())||""},style:{bg:((qt=m.bg)==null?void 0:qt.value)||"bg-slate-900 text-white",columnsCount:((at=m.columnsCount)==null?void 0:at.value)||"4"}}},ne=r=>{var g,I,O,ae,ie,ee,se,ue,ge,Pe,Ne;if(!r)return;m.linkedin&&(m.linkedin.value=((g=r.socials)==null?void 0:g.linkedin)||""),m.twitter&&(m.twitter.value=((I=r.socials)==null?void 0:I.twitter)||""),m.instagram&&(m.instagram.value=((O=r.socials)==null?void 0:O.instagram)||""),m.facebook&&(m.facebook.value=((ae=r.socials)==null?void 0:ae.facebook)||""),m.youtube&&(m.youtube.value=((ie=r.socials)==null?void 0:ie.youtube)||""),m.github&&(m.github.value=((ee=r.socials)==null?void 0:ee.github)||""),m.copyright&&(m.copyright.value=r.copyright||""),m.legalUrl&&(m.legalUrl.value=((se=r.legal)==null?void 0:se.url)||""),m.privacyUrl&&(m.privacyUrl.value=((ue=r.legal)==null?void 0:ue.privacyUrl)||""),m.bg&&(m.bg.value=((ge=r.style)==null?void 0:ge.bg)||"bg-slate-900 text-white"),m.columnsCount&&(m.columnsCount.value=((Pe=r.style)==null?void 0:Pe.columnsCount)||"4"),D&&(D.innerHTML=""),(r.columns||[]).forEach(De=>Ae(De.title,De.links));let c=((Ne=r.columns)==null?void 0:Ne.length)>0||r.copyright||Object.values(r.socials||{}).some(De=>De);Q&&(Q.classList.toggle("bg-green-500",!!c),Q.classList.toggle("bg-slate-300",!c),Q.title=c?"Configur\xE9":"Non configur\xE9")};N==null||N.addEventListener("click",()=>Ae()),V==null||V.addEventListener("click",async()=>{if(w){V.disabled=!0,V.textContent="Enregistrement...";try{let r=Ct();if(!(await fetch(`${w}/footer`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(r)})).ok)throw new Error("Erreur serveur");H=r,ne(r),$("Footer enregistr\xE9")}catch(r){console.error("[footer] save error",r),$("Erreur lors de l'enregistrement","error")}finally{V.disabled=!1,V.textContent="Enregistrer"}}}),(async()=>{if(w)try{let r=await fetch(w,{credentials:"include"});if(r.ok){let c=await r.json();c.header&&(pe=c.header,he(c.header)),c.footer&&(H=c.footer,ne(c.footer))}}catch(r){console.error("[layout] load error",r)}})();let We=document.querySelector("[data-collection-empty]"),Le=document.querySelector("[data-collection-items-empty]"),Ke=document.querySelector("[data-item-table-wrapper]"),Et=document.querySelector("[data-item-table-body]"),It=document.querySelector("[data-collection-title]"),vt=document.querySelector("[data-collection-description]"),Te=document.querySelector("[data-item-add]"),mt=document.querySelector("[data-item-detail-empty]"),de=document.querySelector("[data-item-form]"),i=de?{title:de.querySelector('[name="item-title"]'),slug:de.querySelector('[name="item-slug"]'),excerpt:de.querySelector('[name="item-excerpt"]'),content:de.querySelector('[name="item-content"]'),image:de.querySelector('[name="item-image"]'),ctaText:de.querySelector('[name="item-cta-text"]'),ctaUrl:de.querySelector('[name="item-cta-url"]'),status:de.querySelector('[name="item-status"]')}:{},A=document.querySelector("[data-item-status-badge]"),j=document.querySelector("[data-item-delete]"),J=document.querySelector("[data-item-delete-modal]"),yt=document.querySelector("[data-item-delete-cancel]"),pt=document.querySelector("[data-item-delete-confirm]"),Qt=document.querySelector("[data-item-cancel]"),es=document.querySelector("[data-item-save]"),ts="rounded-full px-3 py-1 text-xs font-semibold",Bs=Se((G==null?void 0:G.slugValue)||Y.slug||""),st=Bs?`/api/sites/${encodeURIComponent(Bs)}/collections`:null,bt=[],$e=[],Ie=null,Fe=null,ze=!1,Vt=!1,Dt=null,Bt=r=>{let c=(r||"").trim();if(!c)return"";if(c==="/")return"/";let I=c.replace(/^\//,"").split("/").map(O=>zt(O||"")).filter(O=>O.length>0);return I.length?`/${I.join("/")}`:""},js=r=>{if(!r)return"\u2014";let c=new Date(r);return Number.isNaN(c.getTime())?"\u2014":c.toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"})},jt=()=>{let r=bt.find(c=>c.id===Ie);It&&(It.textContent=(r==null?void 0:r.name)||"S\xE9lectionnez une collection"),vt&&(vt.textContent=(r==null?void 0:r.description)||"")},xt=r=>{Le&&(Le.textContent=r||(Ie?"Aucun item dans cette collection pour le moment.":"Choisissez une collection dans le panneau de gauche."))},Jt=()=>{de&&(de.classList.add("hidden"),de.dataset.itemId=""),mt==null||mt.classList.remove("hidden"),A&&(A.className=`hidden ${ts}`,A.textContent=""),j&&(j.disabled=!0)},Ht=()=>{de&&(de.classList.remove("hidden"),mt==null||mt.classList.add("hidden"))},Gt=()=>{Te&&(Te.disabled=!Ie,Te.disabled?Te.classList.add("opacity-60","pointer-events-none"):Te.classList.remove("opacity-60","pointer-events-none"))},Fs=r=>{if(!A)return;if(!r){A.className=`hidden ${ts}`,A.textContent="";return}let c=r.toLowerCase(),g="bg-slate-100 text-slate-600 border border-slate-200";c==="publi\xE9"||c==="publie"?g="bg-emerald-50 text-emerald-700 border border-emerald-100":c==="brouillon"&&(g="bg-amber-50 text-amber-700 border border-amber-100"),A.className=`${ts} ${g}`,A.textContent=r},Ps=()=>{if(o.innerHTML="",k&&(k.textContent=bt.length),!bt.length){We==null||We.classList.remove("hidden");return}We==null||We.classList.add("hidden"),bt.forEach(r=>{let c=r.id===Ie,g=document.createElement("button");g.type="button",g.dataset.collectionId=r.id,g.className=["w-full rounded-xl border px-3 py-2 text-left transition focus:outline-none focus:ring-2 focus:ring-[#9C6BFF]/40",c?"bg-[#F7F0FF] border-[#9C6BFF]/40 text-slate-900":"border-slate-200 text-slate-700 hover:border-[#9C6BFF]/40"].join(" "),g.setAttribute("role","option"),c?g.setAttribute("aria-current","true"):g.removeAttribute("aria-current"),g.innerHTML=`
          <div class="flex items-center justify-between gap-2">
            <div>
              <p class="text-sm font-semibold">${r.name||r.id}</p>
              <p class="text-xs text-slate-500">${r.description||""}</p>
            </div>
            <span class="text-[11px] uppercase tracking-wide text-slate-400">${r.type||""}</span>
          </div>
        `,g.addEventListener("click",()=>{Ze(r.id),window.matchMedia("(min-width: 1024px)").matches||K()}),o.appendChild(g)})},ft=()=>{if(Et){if(Et.innerHTML="",!$e.length||!Ie){Le==null||Le.classList.remove("hidden"),xt(),Ke==null||Ke.classList.add("hidden");return}Le==null||Le.classList.add("hidden"),Ke==null||Ke.classList.remove("hidden"),$e.forEach(r=>{let c=document.createElement("tr");c.dataset.itemId=r.id;let g=r.id===Fe&&!ze;c.className=["cursor-pointer transition focus-within:bg-[#F7F0FF]/70 focus:outline-none",g?"bg-[#F7F0FF]/70":"hover:bg-slate-50"].join(" "),c.tabIndex=0,c.setAttribute("role","button"),g?c.setAttribute("aria-current","true"):c.removeAttribute("aria-current");let I=r.status||"Brouillon",O=I.toLowerCase(),ae=O==="publi\xE9"||O==="publie"?"bg-emerald-50 text-emerald-700 border border-emerald-100":"bg-amber-50 text-amber-700 border border-amber-100";c.innerHTML=`
          <td class="px-4 py-3 align-top">
            <div class="flex flex-col">
              <span class="text-sm font-semibold text-slate-900">${r.title||"Sans titre"}</span>
              <span class="text-xs text-slate-500">${r.summary||r.excerpt||""}</span>
            </div>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-600">${r.slug||""}</td>
          <td class="px-4 py-3 align-top">
            <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${ae}">
              ${I}
            </span>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-500">${js(r.updatedAt||r.createdAt)}</td>
        `;let ie=()=>{ao(r.id)};c.addEventListener("click",ie),c.addEventListener("keydown",ee=>{(ee.key==="Enter"||ee.key===" ")&&(ee.preventDefault(),ie())}),Et.appendChild(c)})}},ao=r=>{let c=$e.find(g=>g.id===r);c&&(Fe=c.id,ze=!1,Vt=!0,ms(c),ft())},ms=r=>{var c,g;if(!de||!r){Jt();return}Ht(),de.dataset.itemId=r.id,i.title&&(i.title.value=r.title||""),i.slug&&(i.slug.value=r.slug||""),i.excerpt&&(i.excerpt.value=r.summary||r.excerpt||""),i.content&&(i.content.value=r.content||""),i.image&&(i.image.value=r.image||""),i.ctaText&&(i.ctaText.value=((c=r.cta)==null?void 0:c.text)||r.ctaText||""),i.ctaUrl&&(i.ctaUrl.value=((g=r.cta)==null?void 0:g.url)||r.ctaUrl||""),i.status&&(i.status.value=r.status||"Brouillon"),Fs(r.status||"Brouillon"),j&&(j.disabled=!1)},Ms=()=>{var r;de&&(ze=!0,Fe=null,Vt=!1,de.dataset.itemId="",de.reset(),i.status&&(i.status.value="Brouillon"),i.slug&&(i.slug.value=""),Fs("Brouillon"),Ht(),j&&(j.disabled=!0),(r=i.title)==null||r.focus())},Ut=()=>{var ue,ge,Pe,Ne,De,wt,we,St;let r=(((ue=i.title)==null?void 0:ue.value)||"").trim(),c=(((ge=i.slug)==null?void 0:ge.value)||"").trim(),g=(((Pe=i.excerpt)==null?void 0:Pe.value)||"").trim(),I=(((Ne=i.content)==null?void 0:Ne.value)||"").trim(),O=(((De=i.image)==null?void 0:De.value)||"").trim(),ae=(((wt=i.ctaText)==null?void 0:wt.value)||"").trim(),ie=(((we=i.ctaUrl)==null?void 0:we.value)||"").trim(),ee=((St=i.status)==null?void 0:St.value)||"Brouillon",se=ae||ie?{text:ae,url:ie}:null;return{title:r,slug:Bt(c||r),summary:g,excerpt:g,content:I,image:O,status:ee,...se&&{cta:se}}},Ns=r=>{es&&(es.disabled=r,es.textContent=r?"Enregistrement\u2026":"Enregistrer"),j&&!ze&&Fe&&(j.disabled=r)},Ft=async r=>{if(!st)return[];let c=await fetch(`${st}/${encodeURIComponent(r)}/items`,{headers:{Accept:"application/json"}});if(!c.ok){let I=await c.json().catch(()=>({}));throw new Error(I.message||"Impossible de charger les items.")}let g=await c.json().catch(()=>({}));return Array.isArray(g.items)?g.items:[]},Ze=async r=>{if(r&&(Ie=r,Fe=null,ze=!1,Vt=!1,b("collection"),jt(),Gt(),Ps(),Jt(),$e=[],ft(),xt("Chargement des items\u2026"),Le==null||Le.classList.remove("hidden"),Ke==null||Ke.classList.add("hidden"),!!st))try{$e=await Ft(r),ft(),$e.length||xt()}catch(c){console.error("[content] items failed",c),$(c.message||"Impossible de charger les items."),$e=[],ft()}},io=async(r,c)=>{if(!st)throw new Error("Site inconnu.");let g=await fetch(`${st}/${encodeURIComponent(r)}/items`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!g.ok){let I=await g.json().catch(()=>({}));throw new Error(I.message||"Impossible de cr\xE9er cet item.")}return g.json()},lo=async(r,c,g)=>{if(!st)throw new Error("Site inconnu.");let I=await fetch(`${st}/${encodeURIComponent(r)}/items/${encodeURIComponent(c)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)});if(!I.ok){let O=await I.json().catch(()=>({}));throw new Error(O.message||"Impossible de sauvegarder cet item.")}return I.json()},Pt=async(r,c)=>{if(!st)throw new Error("Site inconnu.");let g=await fetch(`${st}/${encodeURIComponent(r)}/items/${encodeURIComponent(c)}`,{method:"DELETE"});if(!g.ok){let I=await g.json().catch(()=>({}));throw new Error(I.message||"Impossible de supprimer cet item.")}},ot=async()=>{var r;if(!st){We==null||We.classList.remove("hidden"),Ie=null,$e=[],ft(),jt(),Gt();return}try{let c=await fetch(st,{headers:{Accept:"application/json"}});if(!c.ok)throw new Error("Impossible de charger les collections.");let g=await c.json().catch(()=>[]);if(bt=Array.isArray(g)?g:[],Ps(),bt.length>0){let I=((r=bt.find(O=>O.id===Ie))==null?void 0:r.id)||bt[0].id;Ze(I)}else Ie=null,$e=[],jt(),Gt(),ft()}catch(c){console.error("[content] load collections",c),$(c.message||"Impossible de charger les collections.")}};Te==null||Te.addEventListener("click",()=>{if(!Ie){$("S\xE9lectionnez d\u2019abord une collection.");return}Ms(),ft()}),Qt==null||Qt.addEventListener("click",r=>{if(r.preventDefault(),ze){ze=!1,Fe=null,Jt(),ft();return}if(Fe){let c=$e.find(g=>g.id===Fe);ms(c)}else Jt()}),(rt=i.status)==null||rt.addEventListener("change",()=>{Fs(i.status.value)}),(ss=i.title)==null||ss.addEventListener("input",()=>{!ze||!i.slug||Vt||(i.slug.value=Bt(i.title.value))}),(Me=i.slug)==null||Me.addEventListener("input",()=>{ze&&(Vt=!0)}),de==null||de.addEventListener("submit",async r=>{var g;if(r.preventDefault(),!Ie){$("S\xE9lectionnez une collection.");return}let c=Ut();if(!c.title){$("Le titre est requis."),(g=i.title)==null||g.focus();return}Ns(!0);try{let I;ze||!Fe?(I=await io(Ie,c),$e=[...$e,I],$("Item cr\xE9\xE9")):(I=await lo(Ie,Fe,c),$e=$e.map(O=>O.id===I.id?I:O),$("Item mis \xE0 jour")),ze=!1,Fe=I.id,ms(I),ft()}catch(I){console.error("[content] save item failed",I),$(I.message||"Impossible de sauvegarder cet item.")}finally{Ns(!1)}});let _e=()=>{J&&(J.classList.add("hidden"),J.classList.remove("flex"),Dt=null)},Wt=()=>{!J||!Fe||(Dt=Fe,J.classList.remove("hidden"),J.classList.add("flex"))};j==null||j.addEventListener("click",r=>{r.preventDefault(),Fe&&Wt()}),yt==null||yt.addEventListener("click",()=>{_e()}),J==null||J.addEventListener("click",r=>{r.target===J&&_e()}),pt==null||pt.addEventListener("click",async()=>{if(!Dt||!Ie){_e();return}pt.disabled=!0,pt.textContent="Suppression\u2026";try{await Pt(Ie,Dt),$e=$e.filter(r=>r.id!==Dt),Fe===Dt&&(Fe=null,Jt()),$("Item supprim\xE9"),ft()}catch(r){console.error("[content] delete item failed",r),$(r.message||"Impossible de supprimer cet item.")}finally{pt.disabled=!1,pt.textContent="Supprimer",_e()}}),jt(),Gt(),ot()}function gr(){let o=document.querySelector("[data-deploy-form]");if(!o)return;let a=document.querySelector("[data-deploy-protocol]"),d=document.querySelector("[data-deploy-host]"),y=document.querySelector("[data-deploy-port]"),f=document.querySelector("[data-deploy-user]"),h=document.querySelector("[data-deploy-password]"),z=document.querySelector("[data-deploy-show-password]"),Z=document.querySelector("[data-deploy-remote-path]"),U=document.querySelector("[data-deploy-feedback]"),Q=document.querySelector("[data-deploy-save]"),k=document.querySelector("[data-deploy-test]"),p=document.querySelector("[data-deploy-trigger]"),S=document.querySelector("[data-deploy-history]"),P=document.querySelector("[data-deploy-log]"),q=Se((G==null?void 0:G.slugValue)||Y.slug||""),F=q?`/api/sites/${encodeURIComponent(q)}/deploy-config`:null,M=q?`/api/sites/${encodeURIComponent(q)}/deploy`:null,R=q?`/api/sites/${encodeURIComponent(q)}/deploy-log`:null,C=!1,m=null,D=T=>{let w=(T||"").trim();return w?w.startsWith("/")?w:`/${w}`:"/www"},N=(T,w="muted")=>{if(!U)return;let b="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold",W=w==="success"?"bg-emerald-50 text-emerald-700 border border-emerald-100":w==="error"?"bg-rose-50 text-rose-700 border border-rose-100":"bg-slate-50 text-slate-600 border border-slate-100";if(!T){U.textContent="",U.className="text-sm text-slate-500";return}let K=w==="success"?"\u2705":w==="error"?"\u274C":"\u2139\uFE0F";U.innerHTML=`<span class="${b} ${W}">${K}<span>${T}</span></span>`,U.className="text-sm"},V=(T=null)=>{m=T;let w=!!T,b='<svg class="h-4 w-4 animate-spin text-white" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>';Q&&(Q.disabled=w,Q.innerHTML=T==="save"?`<span class="inline-flex items-center gap-2">${b}<span>Enregistrement\u2026</span></span>`:"Enregistrer"),k&&(k.disabled=w,k.innerHTML=T==="test"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-slate-200 border-t-slate-600"></span><span>Test en cours\u2026</span></span>':"Tester la connexion"),p&&(p.disabled=w&&T!==null,p.innerHTML=T==="deploy"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-white/60 border-t-white"></span><span>D\xE9ploiement\u2026</span></span>':"D\xE9ployer maintenant")},_=T=>{a&&(a.value=T.protocol||"sftp"),d&&(d.value=T.host||""),y&&(y.value=T.port||""),f&&(f.value=T.user||""),Z&&(Z.value=T.remotePath||"/www"),C=!!T.hasPassword,h&&(h.value="",h.placeholder=C?"Non affich\xE9":"Mot de passe")},ce=(T=[])=>{if(S){if(S.innerHTML="",!T.length){let w=document.createElement("li");w.className="text-slate-500",w.textContent="Aucun d\xE9ploiement pour le moment.",S.appendChild(w);return}T.forEach(w=>{let b=document.createElement("li");b.className="flex items-center justify-between gap-2 rounded-xl border border-slate-200 px-3 py-2";let W=w.status==="success"?'<span class="rounded-full bg-emerald-50 px-2 py-0.5 text-[11px] font-semibold text-emerald-700">Succ\xE8s</span>':'<span class="rounded-full bg-rose-50 px-2 py-0.5 text-[11px] font-semibold text-rose-700">\xC9chec</span>',K=w.finishedAt||w.startedAt||"",fe=w.durationMs&&Number(w.durationMs)>=0?`${Math.round(Number(w.durationMs)/1e3)}s`:"";b.innerHTML=`
          <div class="space-y-1">
            <div class="flex items-center gap-2">${W}<span class="text-xs text-slate-500">${K}</span></div>
            <p class="text-sm text-slate-800">${w.message||""}</p>
          </div>
          <div class="text-xs text-slate-500">${fe}</div>
        `,b.dataset.deployId=w.id||"",b.addEventListener("click",()=>{w.logs&&P&&(P.textContent=w.logs.join(`
`))}),S.appendChild(b)})}},X=(T=[])=>{P&&(P.textContent=T.length?T.join(`
`):"Aucun log pour le moment.")},pe=async()=>{var T;if(R)try{let w=await fetch(R,{headers:{Accept:"application/json"}});if(!w.ok){if(w.status===404){ce([]),X(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw new Error("Impossible de charger l\u2019historique.")}let b=await w.json().catch(()=>({})),W=Array.isArray(b.entries)?b.entries:[];ce(W),(T=W[0])!=null&&T.logs&&X(W[0].logs)}catch(w){console.error("[deploy] history failed",w)}},H=async()=>{if(!F){N("Aucun site actif s\xE9lectionn\xE9.","error");return}V("load");try{let T=await fetch(F,{headers:{Accept:"application/json"}}),w=await T.json().catch(()=>({}));T.ok?(_(w||{}),N("Configuration charg\xE9e.","muted")):(_(w||{}),N(w.message||"Configuration par d\xE9faut charg\xE9e.","muted"))}catch(T){console.error("[deploy] load failed",T),N(T.message||"Erreur lors du chargement.","error")}finally{V(null)}},xe=()=>{let T={protocol:(a==null?void 0:a.value)||"sftp",host:(d==null?void 0:d.value.trim())||"",port:Number(y==null?void 0:y.value)||void 0,user:(f==null?void 0:f.value.trim())||"",remotePath:D((Z==null?void 0:Z.value)||"/www")},w=(h==null?void 0:h.value)||"";return w.trim().length>0&&(T.password=w),T};o.addEventListener("submit",async T=>{if(T.preventDefault(),!F){N("Aucun site actif s\xE9lectionn\xE9.","error");return}let w=xe();V("save");try{let b=await fetch(F,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(w)});if(!b.ok){let K=await b.json().catch(()=>({}));throw new Error(K.message||"Sauvegarde impossible.")}let W=await b.json();_(W||{}),N("Configuration enregistr\xE9e.","success"),$("Configuration d\xE9ploiement sauvegard\xE9e")}catch(b){console.error("[deploy] save failed",b),N(b.message||"Erreur lors de la sauvegarde.","error")}finally{V(null)}}),k==null||k.addEventListener("click",async()=>{if(!F){N("Aucun site actif s\xE9lectionn\xE9.","error");return}let T=xe();if(!T.host||!T.user||!T.remotePath){N("Remplissez les champs requis avant de tester.","error");return}V("test");try{let w=await fetch(`${F}/test`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(T)}),b=await w.json().catch(()=>({}));if(!w.ok||b.success===!1){N(b.message||"Test de connexion \xE9chou\xE9.","error");return}N(b.message||"Connexion OK.","success"),$("Test de connexion r\xE9ussi")}catch(w){console.error("[deploy] test failed",w),N(w.message||"Test de connexion \xE9chou\xE9.","error")}finally{V(null)}}),p==null||p.addEventListener("click",async()=>{if(!M){N("Aucun site actif s\xE9lectionn\xE9.","error");return}V("deploy"),X(["D\xE9ploiement en cours\u2026"]);try{let T=await fetch(M,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(xe())}),w=await T.json().catch(()=>({}));if(!T.ok){if(T.status===404){N("API d\xE9ploiement indisponible (red\xE9marre le serveur).","error"),X(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw X(w.logs||[]),new Error(w.message||"D\xE9ploiement \xE9chou\xE9.")}X(w.logs||[]),await pe(),$("D\xE9ploiement termin\xE9")}catch(T){console.error("[deploy] run failed",T),N(T.message||"D\xE9ploiement \xE9chou\xE9.","error")}finally{V(null)}}),z==null||z.addEventListener("change",()=>{h&&(h.type=z.checked?"text":"password")}),H(),pe()}function hr(){let o=document.querySelectorAll("[data-settings-tab]"),a=document.querySelectorAll("[data-settings-panel]"),d=document.querySelector("[data-admin-password-form]"),y=document.querySelector("[data-site-config-form]"),f=document.querySelector("[data-site-config-feedback]"),h=document.querySelector("[data-theme-form]"),z=k=>{o.forEach(p=>{let S=p.dataset.settingsTab===k;p.setAttribute("aria-selected",S?"true":"false"),p.classList.toggle("bg-[#9C6BFF]",S),p.classList.toggle("text-white",S)}),a.forEach(p=>{p.classList.toggle("hidden",p.dataset.settingsPanel!==k)})};if(o.forEach(k=>{k.addEventListener("click",()=>z(k.dataset.settingsTab||"account"))}),z("account"),d){let k=d.querySelector("[data-admin-password-feedback]"),p=d.querySelector("[data-admin-password-submit]"),S=(P,q="muted")=>{if(!k)return;let F=q==="success"?"text-emerald-600":q==="error"?"text-rose-600":"text-slate-500";k.textContent=P||"",k.className=`text-sm ${F}`};d.addEventListener("submit",async P=>{P.preventDefault();let q=new FormData(d),F=q.get("currentPassword")||"",M=q.get("newPassword")||"",R=q.get("confirmPassword")||"";if(!F||!M||!R){S("Compl\xE8te tous les champs.","error");return}p&&(p.disabled=!0),S("");try{let C=await fetch("/api/admin/password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({currentPassword:F,newPassword:M,confirmPassword:R})}),m=await C.json().catch(()=>({}));if(!C.ok||m.success===!1)throw new Error(m.message||"Impossible de mettre \xE0 jour le mot de passe.");S(m.message||"Mot de passe mis \xE0 jour.","success"),d.reset()}catch(C){console.error("[settings] change password failed",C),S(C.message||"Erreur lors de la mise \xE0 jour.","error")}finally{p&&(p.disabled=!1)}})}if(y){let k=y.querySelector("[data-site-name]"),p=y.querySelector("[data-site-language]"),S=y.querySelector("[data-site-tagline]"),P=y.querySelector("[data-site-save]"),q=(C,m="muted")=>{if(!f)return;let D=m==="success"?"text-emerald-600":m==="error"?"text-rose-600":"text-slate-500";f.textContent=C||"",f.className=`text-sm ${D}`},F=Se((G==null?void 0:G.slugValue)||Y.slug||""),M=F?`/api/sites/${encodeURIComponent(F)}/config/site`:null,R=async()=>{if(M)try{let C=await fetch(M,{headers:{Accept:"application/json"}});if(!C.ok)return;let m=await C.json().catch(()=>({}));k&&(k.value=m.name||""),p&&(p.value=m.language||"fr"),S&&(S.value=m.tagline||"")}catch(C){console.error("[settings] load site config failed",C)}};y.addEventListener("submit",async C=>{if(C.preventDefault(),!M){q("Aucun site actif.","error");return}if(!(k!=null&&k.value.trim())){q("Nom requis.","error");return}P&&(P.disabled=!0),q("");try{let m={name:(k==null?void 0:k.value)||"",language:(p==null?void 0:p.value)||"fr",tagline:(S==null?void 0:S.value)||""},D=await fetch(M,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)}),N=await D.json().catch(()=>({}));if(!D.ok||N.success===!1)throw new Error(N.message||"Sauvegarde impossible.");q(N.message||"Param\xE8tres enregistr\xE9s.","success")}catch(m){console.error("[settings] save site config failed",m),q(m.message||"Erreur lors de la sauvegarde.","error")}finally{P&&(P.disabled=!1)}}),R()}if(h){let k=Se((G==null?void 0:G.slugValue)||Y.slug||""),p=k?`/api/sites/${encodeURIComponent(k)}/config/theme`:null,S={primary:h.querySelector("[data-theme-primary]"),secondary:h.querySelector("[data-theme-secondary]"),accent:h.querySelector("[data-theme-accent]"),background:h.querySelector("[data-theme-background]"),text:h.querySelector("[data-theme-text]")},P=h.querySelector("[data-theme-headings]"),q=h.querySelector("[data-theme-body]"),F=h.querySelector("[data-theme-radius-small]"),M=h.querySelector("[data-theme-radius-medium]"),R=h.querySelector("[data-theme-radius-large]"),C=h.querySelector("[data-theme-preview]"),m=h.querySelector("[data-theme-feedback]"),D=h.querySelector("[data-theme-apply]"),N=["slate","gray","zinc","neutral","stone","red","orange","amber","yellow","lime","green","emerald","teal","cyan","sky","blue","indigo","violet","purple","fuchsia","pink","rose"],V=["50","100","200","300","400","500","600","700","800","900"],_=N.flatMap(b=>V.map(W=>`${b}-${W}`)),ce=()=>{Object.values(S).forEach(b=>{!b||b.options.length||_.forEach(W=>{let K=document.createElement("option");K.value=W;let[fe,ye]=W.split("-");K.textContent=`${fe.charAt(0).toUpperCase()+fe.slice(1)} ${ye}`,b.appendChild(K)})})},X=(b,W="muted")=>{if(!m)return;let K=W==="success"?"text-emerald-600":W==="error"?"text-rose-600":"text-slate-500";m.textContent=b||"",m.className=`text-sm ${K}`},pe=()=>{var W,K,fe,ye,oe;if(!C)return;let b=he=>{if(!he)return null;if(he==="white")return"#ffffff";if(he==="black")return"#000000";if(he==="transparent")return"transparent";let[re,Ae]=he.split("-");if(!re||!Ae)return null;let ne={slate:"#e2e8f0",gray:"#d1d5db",zinc:"#d4d4d8",neutral:"#d4d4d4",stone:"#d6d3d1",red:"#ef4444",orange:"#f97316",amber:"#f59e0b",yellow:"#eab308",lime:"#84cc16",green:"#22c55e",emerald:"#10b981",teal:"#14b8a6",cyan:"#06b6d4",sky:"#0ea5e9",blue:"#3b82f6",indigo:"#6366f1",violet:"#8b5cf6",purple:"#a855f7",fuchsia:"#d946ef",pink:"#ec4899",rose:"#f43f5e"}[re];if(!ne)return null;let E=Number(Ae)||500,We=Math.min(Math.max((E-50)/900,0),1),Le=Te=>Te.match(/[A-Fa-f0-9]{2}/g).map(mt=>parseInt(mt,16)),[Ke,Et,It]=Le(ne.replace("#","")),vt=Te=>Math.round(255-(255-Te)*We);return`rgb(${vt(Ke)}, ${vt(Et)}, ${vt(It)})`};C.style.setProperty("--color-primary",b((W=S.primary)==null?void 0:W.value)||"#9C6BFF"),C.style.setProperty("--color-secondary",b((K=S.secondary)==null?void 0:K.value)||"#0EA5E9"),C.style.setProperty("--color-accent",b((fe=S.accent)==null?void 0:fe.value)||"#F97316"),C.style.setProperty("--color-background",b((ye=S.background)==null?void 0:ye.value)||"#FFFFFF"),C.style.setProperty("--color-text",b((oe=S.text)==null?void 0:oe.value)||"#0F172A"),C.style.setProperty("--font-headings",(P==null?void 0:P.value)||"Inter, sans-serif"),C.style.setProperty("--font-body",(q==null?void 0:q.value)||"Inter, sans-serif"),C.style.setProperty("--radius-small",(F==null?void 0:F.value)||"8px"),C.style.setProperty("--radius-medium",(M==null?void 0:M.value)||"16px"),C.style.setProperty("--radius-large",(R==null?void 0:R.value)||"24px"),C.style.borderRadius=(M==null?void 0:M.value)||"16px"},H=(b,W)=>{S[b]&&(S[b].value=W)},xe=b=>{var ye,oe;if(!b)return;let W=b.options[b.selectedIndex],K=((ye=W==null?void 0:W.dataset)==null?void 0:ye.color)||"#ffffff",fe=(oe=b.closest(".relative"))==null?void 0:oe.querySelector("[data-color-preview]");fe&&(K==="transparent"?fe.style.background="repeating-conic-gradient(#ccc 0% 25%, white 0% 50%) 50% / 8px 8px":(fe.style.backgroundColor=K,fe.style.background=""))},T=()=>{Object.values(S).forEach(b=>{b&&(xe(b),b.addEventListener("change",()=>xe(b)))})};Object.keys(S).forEach(b=>{var W;(W=S[b])==null||W.addEventListener("change",pe)}),[P,q,F,M,R].forEach(b=>{b==null||b.addEventListener("change",pe)});let w=async()=>{var b,W,K,fe,ye,oe,he,re,Ae,Ct;if(p)try{let ne=await fetch(p,{headers:{Accept:"application/json"}});if(!ne.ok)return;let E=await ne.json().catch(()=>({}));H("primary",((b=E.colors)==null?void 0:b.primary)||"violet-500"),H("secondary",((W=E.colors)==null?void 0:W.secondary)||"indigo-400"),H("accent",((K=E.colors)==null?void 0:K.accent)||"emerald-500"),H("background",((fe=E.colors)==null?void 0:fe.background)||"slate-50"),H("text",((ye=E.colors)==null?void 0:ye.text)||"slate-900"),P&&(P.value=((oe=E.typography)==null?void 0:oe.headings)||"Inter, sans-serif"),q&&(q.value=((he=E.typography)==null?void 0:he.body)||"Inter, sans-serif"),F&&(F.value=((re=E.radius)==null?void 0:re.small)||"8px"),M&&(M.value=((Ae=E.radius)==null?void 0:Ae.medium)||"16px"),R&&(R.value=((Ct=E.radius)==null?void 0:Ct.large)||"24px"),pe(),Object.values(S).forEach(xe)}catch(ne){console.error("[settings] load theme failed",ne)}};ce(),T(),D==null||D.addEventListener("click",async b=>{var K,fe,ye,oe,he;if(b.preventDefault(),!p){X("Aucun site actif.","error");return}let W={colors:{primary:((K=S.primary)==null?void 0:K.value)||"violet-500",secondary:((fe=S.secondary)==null?void 0:fe.value)||"indigo-400",accent:((ye=S.accent)==null?void 0:ye.value)||"emerald-500",background:((oe=S.background)==null?void 0:oe.value)||"slate-50",text:((he=S.text)==null?void 0:he.value)||"slate-900"},typography:{headings:(P==null?void 0:P.value)||"Inter, sans-serif",body:(q==null?void 0:q.value)||"Inter, sans-serif"},radius:{small:(F==null?void 0:F.value)||"8px",medium:(M==null?void 0:M.value)||"16px",large:(R==null?void 0:R.value)||"24px"}};D.disabled=!0,X("");try{let re=await fetch(p,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(W)}),Ae=await re.json().catch(()=>({}));if(!re.ok||Ae.success===!1)throw new Error(Ae.message||"Application du th\xE8me \xE9chou\xE9e.");X(Ae.message||"Th\xE8me appliqu\xE9.","success"),pe()}catch(re){console.error("[settings] apply theme failed",re),X(re.message||"Erreur lors de l\u2019application du th\xE8me.","error")}finally{D.disabled=!1}}),ce(),T(),w(),pe()}let Z=document.querySelector("[data-seo-config-form]");if(Z){let k=Z.querySelector("[data-seo-index-all]"),p=Z.querySelector("[data-seo-config-feedback]"),S=Z.querySelector("[data-seo-save]"),P=Se((G==null?void 0:G.slugValue)||Y.slug||""),q=P?`/api/sites/${encodeURIComponent(P)}/config/site`:null,F=(R,C="muted")=>{if(!p)return;let m=C==="success"?"text-emerald-600":C==="error"?"text-rose-600":"text-slate-500";p.textContent=R||"",p.className=`text-sm ${m}`},M=async()=>{var R;if(q)try{let C=await fetch(q,{headers:{Accept:"application/json"}});if(!C.ok)return;let D=((R=(await C.json().catch(()=>({}))).seo)==null?void 0:R.indexAllPagesByDefault)!==!1;k&&(k.checked=D)}catch(C){console.error("[settings] load seo config failed",C)}};Z.addEventListener("submit",async R=>{var C;if(R.preventDefault(),!q){F("Aucun site actif.","error");return}S&&(S.disabled=!0),F("");try{let m=await fetch(q,{headers:{Accept:"application/json"}}),D=m.ok?await m.json().catch(()=>({})):{},N={...D,seo:{...D.seo||{},indexAllPagesByDefault:(C=k==null?void 0:k.checked)!=null?C:!0}},V=await fetch(q,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(N)}),_=await V.json().catch(()=>({}));if(!V.ok||_.success===!1)throw new Error(_.message||"Sauvegarde impossible.");F(_.message||"Param\xE8tres SEO enregistr\xE9s.","success")}catch(m){console.error("[settings] save seo config failed",m),F(m.message||"Erreur lors de la sauvegarde.","error")}finally{S&&(S.disabled=!1)}}),M()}let U=document.querySelector("[data-analytics-form]");if(U){let k=U.querySelector("[data-analytics-head]"),p=U.querySelector("[data-analytics-body]"),S=U.querySelector("[data-analytics-feedback]"),P=U.querySelector("[data-analytics-save]"),q=Se((G==null?void 0:G.slugValue)||Y.slug||""),F=q?`/api/sites/${encodeURIComponent(q)}/config/site`:null,M=(C,m="muted")=>{if(!S)return;let D=m==="success"?"text-emerald-600":m==="error"?"text-rose-600":"text-slate-500";S.textContent=C||"",S.className=`text-sm ${D}`},R=async()=>{var C,m;if(F)try{let D=await fetch(F,{headers:{Accept:"application/json"}});if(!D.ok)return;let N=await D.json().catch(()=>({}));k&&(k.value=((C=N.analytics)==null?void 0:C.headCode)||""),p&&(p.value=((m=N.analytics)==null?void 0:m.bodyEndCode)||"")}catch(D){console.error("[settings] load analytics config failed",D)}};U.addEventListener("submit",async C=>{if(C.preventDefault(),!F){M("Aucun site actif.","error");return}P&&(P.disabled=!0),M("");try{let m=await fetch(F,{headers:{Accept:"application/json"}}),N={...m.ok?await m.json().catch(()=>({})):{},analytics:{headCode:(k==null?void 0:k.value)||"",bodyEndCode:(p==null?void 0:p.value)||""}},V=await fetch(F,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(N)}),_=await V.json().catch(()=>({}));if(!V.ok||_.success===!1)throw new Error(_.message||"Sauvegarde impossible.");M(_.message||"Scripts enregistr\xE9s.","success")}catch(m){console.error("[settings] save analytics config failed",m),M(m.message||"Erreur lors de la sauvegarde.","error")}finally{P&&(P.disabled=!1)}}),R()}let Q=document.querySelector("[data-ai-config-form]");if(Q){let k=Q.querySelector("[data-ai-api-key]"),p=Q.querySelector("[data-ai-model]"),S=Q.querySelector("[data-ai-project-prompt]"),P=Q.querySelector("[data-ai-enabled]"),q=Q.querySelector("[data-ai-feedback]"),F=Q.querySelector("[data-ai-save]"),M=Se((G==null?void 0:G.slugValue)||Y.slug||""),R=M?`/api/sites/${encodeURIComponent(M)}/config/ai`:null,C=(D,N="muted")=>{if(!q)return;let V=N==="success"?"text-emerald-600":N==="error"?"text-rose-600":"text-slate-500";q.textContent=D||"",q.className=`text-sm ${V}`},m=async()=>{if(R)try{let D=await fetch(R,{headers:{Accept:"application/json"}});if(!D.ok)return;let N=await D.json().catch(()=>({}));k&&(k.value="",k.placeholder=N.hasApiKey?"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022":"Cl\xE9 API Gemini"),p&&(p.value=N.model||"gemini-2.5-flash"),S&&(S.value=N.projectPrompt||""),P&&(P.checked=N.enabled!==!1)}catch(D){console.error("[settings] load AI config failed",D)}};Q.addEventListener("submit",async D=>{var N,V;if(D.preventDefault(),!R){C("Aucun site actif.","error");return}F&&(F.disabled=!0),C("");try{let _={model:(p==null?void 0:p.value)||"gemini-2.5-flash",projectPrompt:(S==null?void 0:S.value)||"",enabled:(N=P==null?void 0:P.checked)!=null?N:!0},ce=(V=k==null?void 0:k.value)==null?void 0:V.trim();ce&&(_.apiKey=ce);let X=await fetch(R,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(_)}),pe=await X.json().catch(()=>({}));if(!X.ok||pe.success===!1)throw new Error(pe.message||"Sauvegarde impossible.");C(pe.message||"Configuration IA enregistr\xE9e.","success"),k&&(k.value="",k.placeholder="\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022")}catch(_){console.error("[settings] save AI config failed",_),C(_.message||"Erreur lors de la sauvegarde.","error")}finally{F&&(F.disabled=!1)}}),m()}}function vr(){let o=document.querySelector("[data-media-grid]");if(!o)return;let a=document.querySelector("[data-media-empty]"),d=document.querySelector("[data-media-count]"),y=document.querySelector("[data-media-filter-type]"),f=document.querySelector("[data-media-detail-empty]"),h=document.querySelector("[data-media-detail]"),z=document.querySelector("[data-media-detail-preview]"),Z=document.querySelector("[data-media-detail-name]"),U=document.querySelector("[data-media-detail-type]"),Q=document.querySelector("[data-media-detail-size]"),k=document.querySelector("[data-media-detail-path]"),p=document.querySelector("[data-media-detail-used]"),S=document.querySelector("[data-media-alt-edit]"),P=document.querySelector("[data-media-save]"),q=document.querySelector("[data-media-delete]"),F=document.querySelector("[data-media-delete-modal]"),M=document.querySelector("[data-media-delete-cancel]"),R=document.querySelector("[data-media-delete-confirm]"),C=document.querySelector("[data-media-upload-open]"),m=document.querySelector("[data-media-file-input]"),D=document.querySelector("[data-media-upload-status]"),N=Se((G==null?void 0:G.slugValue)||Y.slug||""),V=N?`/api/sites/${encodeURIComponent(N)}/media`:null,_=[],ce=[],X=null,pe=null,H=null,xe=!1,T=!1,w=!1,b=null,W=i=>{let A=(i.type||"").toLowerCase(),j=(i.filename||"").toLowerCase();return A.includes("image")||/\.(png|jpe?g|webp|svg|gif)$/i.test(j)?"image":A.includes("pdf")||A.includes("doc")||/\.(pdf|docx?)$/i.test(j)?"document":A.includes("video")||/\.(mp4|mov|webm)$/i.test(j)?"video":"other"},K=i=>W(i)==="image",fe=i=>{if(i.type)return i.type.toUpperCase();let A=(i.filename||"").split(".").pop();return A?A.toUpperCase():"FILE"},ye=i=>!i||i<=0?"\u2014":i<1024?`${i} o`:i<1024*1024?`${(i/1024).toFixed(1)} ko`:`${(i/(1024*1024)).toFixed(1)} Mo`,oe=()=>{h==null||h.classList.add("hidden"),f==null||f.classList.remove("hidden"),he(),X=null,T=!1,ne(!1),z&&(z.innerHTML='<span class="text-slate-400 text-sm">Aucun m\xE9dia s\xE9lectionn\xE9</span>'),Z&&(Z.textContent=""),U&&(U.textContent=""),Q&&(Q.textContent=""),S&&(S.value=""),k&&(k.textContent=""),p&&(p.innerHTML="")},he=()=>{H=null,w=!1,xe=!1,b&&(URL.revokeObjectURL(b),b=null),D&&(D.textContent="Aucun fichier s\xE9lectionn\xE9."),m&&(m.value="")},re=()=>{d&&(ce.length?ce.length===1?d.textContent="1 m\xE9dia":d.textContent=`${ce.length} m\xE9dias`:d.textContent="0 m\xE9dia")},Ae=()=>{if(o.innerHTML="",!ce.length){a==null||a.classList.remove("hidden"),oe();return}a==null||a.classList.add("hidden"),ce.forEach(i=>{let A=document.createElement("button");A.type="button",A.dataset.mediaId=i.id;let j=i.id===X;A.className=["group relative flex flex-col rounded-2xl border px-3 py-3 text-left transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#9C6BFF]",j?"border-[#9C6BFF] bg-[#F7F0FF]/60 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let J=K(i)?`<img src="${i.path}" alt="${i.alt||i.filename}" class="h-full w-full object-cover" />`:'<div class="flex h-full w-full items-center justify-center text-3xl text-slate-400">\u{1F4C4}</div>';A.innerHTML=`
          <div class="relative aspect-[4/3] overflow-hidden rounded-xl bg-slate-100">
            ${J}
          </div>
          <div class="mt-2 space-y-1">
            <p class="text-sm font-semibold text-slate-900 truncate">${i.filename}</p>
            <p class="text-xs text-slate-500">
              ${fe(i)} \xB7 ${ye(i.size)}
            </p>
          </div>
        `,i.id===pe&&(A.classList.add("ring-2","ring-[#9C6BFF]"),window.setTimeout(()=>{A.classList.remove("ring-2","ring-[#9C6BFF]")},1600)),A.addEventListener("click",()=>E(i.id)),o.appendChild(A)}),pe=null},Ct=i=>{if(p){if(p.innerHTML="",!i.usedIn||i.usedIn.length===0){let A=document.createElement("li");A.textContent="Non utilis\xE9",A.className="text-xs text-slate-400",p.appendChild(A);return}i.usedIn.forEach(A=>{let j=document.createElement("li");j.textContent=A,j.className="text-xs text-slate-600",p.appendChild(j)})}},ne=i=>{if(P){if(w){P.textContent=i?"T\xE9l\xE9versement\u2026":"T\xE9l\xE9verser",P.disabled=i||!H,q&&q.classList.add("hidden");return}P.textContent=i?"Enregistrement\u2026":"Enregistrer",P.disabled=i||!T,q&&(q.classList.remove("hidden"),q.disabled=!X)}},E=i=>{let A=_.find(j=>j.id===i);if(!A){oe(),Ae();return}he(),X=A.id,T=!1,ne(!1),Ae(),f==null||f.classList.add("hidden"),h==null||h.classList.remove("hidden"),z&&(K(A)?z.innerHTML=`<img src="${A.path}" alt="${A.alt||A.filename}" class="h-full w-full rounded-2xl object-cover" />`:z.innerHTML='<div class="flex h-full w-full flex-col items-center justify-center gap-1 text-slate-400"><span class="text-3xl">\u{1F4C4}</span><span class="text-xs font-semibold">Document</span></div>'),Z&&(Z.textContent=A.filename||"Fichier"),U&&(U.textContent=fe(A)),Q&&(Q.textContent=ye(A.size)),S&&(S.value=A.alt||""),k&&(k.textContent=A.path||"\u2014"),Ct(A)},We=i=>{if(i){if(w=!0,T=!1,X=null,f==null||f.classList.add("hidden"),h==null||h.classList.remove("hidden"),b&&URL.revokeObjectURL(b),b=URL.createObjectURL(i),z&&(z.innerHTML=`<img src="${b}" alt="${i.name}" class="h-full w-full rounded-2xl object-cover" />`),Z&&(Z.textContent=i.name),U&&(U.textContent=fe({type:i.type,filename:i.name})),Q&&(Q.textContent=ye(i.size)),S&&!S.value.trim()&&(S.value=i.name.replace(/\.[^.]+$/,"").replace(/[-_]/g," ")),k&&(k.textContent="En attente de t\xE9l\xE9versement"),p){p.innerHTML="";let A=document.createElement("li");A.textContent="Non utilis\xE9",A.className="text-xs text-slate-400",p.appendChild(A)}ne(!1)}},Le=()=>{let i=(y==null?void 0:y.value)||"all";i==="all"?ce=[..._]:ce=_.filter(A=>A.groupType===i),ce.some(A=>A.id===X)||oe(),re(),Ae()},Ke=async()=>{if(!V){a==null||a.classList.remove("hidden");return}try{let i=await fetch(V,{headers:{Accept:"application/json"}});if(!i.ok)throw new Error("Impossible de charger les m\xE9dias.");let A=await i.json().catch(()=>({items:[]}));_=Array.isArray(A.items)?A.items.map(j=>({...j,groupType:W(j)})):[],Le()}catch(i){console.error("[media] load failed",i),$(i.message||"Impossible de charger les m\xE9dias."),_=[],Le()}};y==null||y.addEventListener("change",()=>{Le()}),S==null||S.addEventListener("input",()=>{if(w){ne(!1);return}X&&(T=!0,ne(!1))});let Et=i=>{if(i){if(!i.type.startsWith("image/")){$("Seules les images sont accept\xE9es pour le moment.");return}if(i.size>4*1024*1024){$("Fichier trop volumineux (4 Mo max).");return}H=i,We(i),D&&(D.textContent=`${i.name} \xB7 ${ye(i.size)}`)}},It=i=>new Promise((A,j)=>{let J=new FileReader;J.onload=()=>{let yt=J.result||"",[,pt=""]=String(yt).split(",");A(pt)},J.onerror=()=>j(new Error("Impossible de lire ce fichier.")),J.readAsDataURL(i)}),vt=async()=>{if(!(!H||!V)){xe=!0,ne(!0);try{let i=await It(H),A={filename:H.name,type:H.type,size:H.size,alt:(S==null?void 0:S.value)||"",data:i},j=await fetch(V,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(A)});if(!j.ok){let yt=await j.json().catch(()=>({}));throw new Error(yt.message||"Upload impossible.")}let J=await j.json();J.groupType=W(J),_=[..._,J],pe=J.id,Le(),E(J.id),$("M\xE9dia ajout\xE9"),he()}catch(i){console.error("[media] upload failed",i),$(i.message||"Impossible de t\xE9l\xE9verser ce m\xE9dia.")}finally{xe=!1,H=null,ne(!1)}}};C==null||C.addEventListener("click",()=>m==null?void 0:m.click()),m==null||m.addEventListener("change",()=>{m.files&&m.files[0]&&Et(m.files[0])});let Te=()=>{F&&(F.classList.add("hidden"),F.classList.remove("flex"))},mt=()=>{if(!(!X||w)){if(F){F.classList.remove("hidden"),F.classList.add("flex");return}window.confirm("Supprimer ce m\xE9dia ?")&&de()}},de=async()=>{if(!X||!V){Te();return}let i=()=>{q&&(q.disabled=!0),R&&(R.disabled=!0,R.textContent="Suppression\u2026")},A=()=>{q&&(q.disabled=!1),R&&(R.disabled=!1,R.textContent="Supprimer")};i();try{let j=await fetch(`${V}/${encodeURIComponent(X)}`,{method:"DELETE"});if(!j.ok){let J=await j.json().catch(()=>({}));throw new Error(J.message||"Suppression impossible.")}_=_.filter(J=>J.id!==X),ce=ce.filter(J=>J.id!==X),$("M\xE9dia supprim\xE9"),oe(),re(),Ae()}catch(j){console.error("[media] delete failed",j),$(j.message||"Impossible de supprimer ce m\xE9dia.")}finally{A(),Te()}};M==null||M.addEventListener("click",Te),F==null||F.addEventListener("click",i=>{i.target===F&&Te()}),R==null||R.addEventListener("click",()=>de()),q==null||q.addEventListener("click",mt),P==null||P.addEventListener("click",async()=>{if(w){vt();return}if(!(!X||!V||!S)){ne(!0);try{let i={alt:S.value||""},A=await fetch(`${V}/${encodeURIComponent(X)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!A.ok){let J=await A.json().catch(()=>({}));throw new Error(J.message||"Impossible de mettre \xE0 jour ce m\xE9dia.")}let j=await A.json();_=_.map(J=>J.id===X?{...J,...j}:J),ce=ce.map(J=>J.id===X?{...J,...j}:J),T=!1,ne(!1),$("M\xE9dia mis \xE0 jour")}catch(i){console.error("[media] update failed",i),$(i.message||"\xC9chec de la mise \xE0 jour."),ne(!1)}}}),Ke()}let to=document.getElementById("ai-chat-toggle"),Xt=document.getElementById("ai-chat-panel"),Ge=document.getElementById("ai-chat-overlay"),so=document.getElementById("ai-chat-close"),oo=document.getElementById("ai-chat-clear"),ro=document.getElementById("ai-chat-form"),kt=document.getElementById("ai-chat-input"),ve=document.getElementById("ai-chat-messages"),mn=document.getElementById("ai-chat-status"),ut=document.getElementById("ai-chat-no-api"),yr=document.querySelectorAll("[data-ai-quick]"),Ts=!1,no=!1,$o=!1,br=!1;function xr(){Xt&&(Ts=!0,Xt.classList.remove("translate-x-full"),Xt.setAttribute("aria-hidden","false"),Ge==null||Ge.classList.remove("opacity-0","pointer-events-none"),Ge==null||Ge.classList.add("opacity-100"),document.body.classList.add("overflow-hidden"),kt==null||kt.focus(),$o||wr())}function $s(){Xt&&(Ts=!1,Xt.classList.add("translate-x-full"),Xt.setAttribute("aria-hidden","true"),Ge==null||Ge.classList.add("opacity-0","pointer-events-none"),Ge==null||Ge.classList.remove("opacity-100"),document.body.classList.remove("overflow-hidden"))}async function wr(){let o=Se(Y.slug||"");if(!o){ut==null||ut.classList.remove("hidden");return}try{let a=await fetch(`/api/sites/${encodeURIComponent(o)}/config/ai`);if(!a.ok)throw new Error("Config check failed");let d=await a.json();$o=!0,br=d.hasApiKey,!d.enabled||!d.hasApiKey?ut==null||ut.classList.remove("hidden"):(ut==null||ut.classList.add("hidden"),Sr())}catch(a){console.error("[AI] Config check failed:",a),ut==null||ut.classList.remove("hidden")}}async function Sr(){let o=Se(Y.slug||"");if(!(!o||!ve))try{let a=await fetch(`/api/sites/${encodeURIComponent(o)}/ai/history`);if(!a.ok)return;let d=await a.json();if(d.messages&&d.messages.length>0){let y=ve.querySelector("[data-ai-welcome]");y&&y.remove(),d.messages.forEach(f=>{Is(f.content,f.role==="user"?"user":"assistant")}),ve.scrollTop=ve.scrollHeight}}catch(a){console.error("[AI] History load failed:",a)}}function Is(o,a="assistant"){if(!ve)return;let d=document.createElement("div");if(d.className="flex gap-3",a==="user")d.innerHTML=`
        <div class="flex-1"></div>
        <div class="max-w-[80%] bg-violet-600 text-white rounded-2xl rounded-tr-none p-3">
          <p class="text-sm whitespace-pre-wrap">${tt(o)}</p>
        </div>
        <div class="w-8 h-8 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center">
          <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
        </div>
      `;else{let y=kr(o);d.innerHTML=`
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-violet-500 to-indigo-600 flex-shrink-0 flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
          </svg>
        </div>
        <div class="flex-1 bg-slate-50 rounded-2xl rounded-tl-none p-3 overflow-x-auto">
          <div class="text-sm text-slate-700 prose prose-sm max-w-none [&>pre]:bg-slate-800 [&>pre]:text-slate-100 [&>pre]:rounded-lg [&>pre]:p-3 [&>pre]:overflow-x-auto [&>code]:bg-slate-200 [&>code]:px-1 [&>code]:rounded">${y}</div>
        </div>
      `}ve.appendChild(d),ve.scrollTop=ve.scrollHeight}function Lr(){if(!ve)return;let o=document.createElement("div");o.className="flex gap-3",o.id="ai-loading-indicator",o.innerHTML=`
      <div class="w-8 h-8 rounded-full bg-gradient-to-br from-violet-500 to-indigo-600 flex-shrink-0 flex items-center justify-center">
        <svg class="w-4 h-4 text-white animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
        </svg>
      </div>
      <div class="flex-1 bg-slate-50 rounded-2xl rounded-tl-none p-3">
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 bg-violet-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
          <div class="w-2 h-2 bg-violet-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
          <div class="w-2 h-2 bg-violet-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
        </div>
      </div>
    `,ve.appendChild(o),ve.scrollTop=ve.scrollHeight}function Io(){let o=document.getElementById("ai-loading-indicator");o==null||o.remove()}function kr(o){if(!o)return"";let a=tt(o);return a=a.replace(/```(\w*)\n([\s\S]*?)```/g,(d,y,f)=>`<pre class="language-${y||"text"}"><code>${f.trim()}</code></pre>`),a=a.replace(/`([^`]+)`/g,"<code>$1</code>"),a=a.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),a=a.replace(/\*([^*]+)\*/g,"<em>$1</em>"),a=a.replace(/^### (.+)$/gm,'<h4 class="font-semibold text-slate-900 mt-3 mb-1">$1</h4>'),a=a.replace(/^## (.+)$/gm,'<h3 class="font-semibold text-slate-900 mt-3 mb-1">$1</h3>'),a=a.replace(/^# (.+)$/gm,'<h2 class="font-bold text-slate-900 mt-3 mb-2">$1</h2>'),a=a.replace(/^- (.+)$/gm,'<li class="ml-4">$1</li>'),a=a.replace(/^(\d+)\. (.+)$/gm,'<li class="ml-4">$2</li>'),a=a.replace(/\n\n/g,'</p><p class="mb-2">'),a='<p class="mb-2">'+a+"</p>",a=a.replace(/<p class="mb-2"><\/p>/g,""),a}function tt(o){let a=document.createElement("div");return a.textContent=o,a.innerHTML}async function Bo(o){let a=Se(Y.slug||"");if(!o||!a||no)return;no=!0,kt.disabled=!0;let d=ve==null?void 0:ve.querySelector("[data-ai-welcome]");d&&d.remove(),Is(o,"user"),Lr();try{let y=await fetch(`/api/sites/${encodeURIComponent(a)}/ai/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:o})});if(Io(),!y.ok){let h=await y.json().catch(()=>({}));throw new Error(h.message||"Erreur de communication")}let f=await y.json();f.response&&Is(f.response,"assistant"),f.editProposal&&Cr(f.editProposal),f.themeProposal&&Er(f.themeProposal)}catch(y){Io(),Is(`\u274C Erreur: ${y.message}`,"assistant")}finally{no=!1,kt.disabled=!1,kt.focus()}}function Cr(o){var y,f;if(!ve||!o)return;let a=document.createElement("div");a.className="flex gap-3 mt-2",a.dataset.proposalId=o.proposalId;let d="";if(o.changes&&(o.changes.title&&(d+=`<li>Titre \u2192 <strong>${tt(o.changes.title)}</strong></li>`),o.changes.description&&(d+=`<li>Description \u2192 ${tt(o.changes.description.substring(0,80))}...</li>`),o.changes.seo&&(o.changes.seo.metaTitle&&(d+=`<li>Meta title \u2192 ${tt(o.changes.seo.metaTitle)}</li>`),o.changes.seo.metaDescription&&(d+=`<li>Meta description \u2192 ${tt(o.changes.seo.metaDescription.substring(0,60))}...</li>`)),o.changes.blockUpdate&&(d+=`<li>Bloc "${o.changes.blockUpdate.blockId}" modifi\xE9</li>`,o.changes.blockUpdate.settings))){let h=o.changes.blockUpdate.settings;h.title&&(d+=`<li class="ml-4">\u2192 title: ${tt(h.title)}</li>`),h.content&&(d+='<li class="ml-4">\u2192 content modifi\xE9</li>')}a.innerHTML=`
      <div class="w-8 h-8 rounded-full bg-amber-500 flex-shrink-0 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
        </svg>
      </div>
      <div class="flex-1 bg-amber-50 border border-amber-200 rounded-2xl rounded-tl-none p-4">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-xs font-semibold text-amber-700 bg-amber-100 px-2 py-0.5 rounded">Proposition d'\xE9dition</span>
        </div>
        <p class="text-sm font-medium text-slate-800 mb-1">Page : ${tt(o.pageTitle||o.pageId)}</p>
        ${o.reason?`<p class="text-sm text-slate-600 mb-2">${tt(o.reason)}</p>`:""}
        <ul class="text-xs text-slate-600 space-y-1 mb-3 list-disc ml-4">
          ${d||"<li>Modifications propos\xE9es</li>"}
        </ul>
        <div class="flex gap-2">
          <button 
            class="ai-apply-edit px-3 py-1.5 text-xs font-medium text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg transition-colors flex items-center gap-1"
            data-proposal-id="${o.proposalId}"
          >
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Appliquer
          </button>
          <button 
            class="ai-reject-edit px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors flex items-center gap-1"
            data-proposal-id="${o.proposalId}"
          >
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            Rejeter
          </button>
        </div>
      </div>
    `,ve.appendChild(a),ve.scrollTop=ve.scrollHeight,(y=a.querySelector(".ai-apply-edit"))==null||y.addEventListener("click",Tr),(f=a.querySelector(".ai-reject-edit"))==null||f.addEventListener("click",jo)}function Er(o){var f,h,z,Z;if(!ve||!o)return;let a=document.createElement("div");a.className="flex gap-3 mt-2",a.dataset.proposalId=o.proposalId;let d="";if((f=o.changes)!=null&&f.colors){let U=o.changes.colors;for(let[Q,k]of Object.entries(U))d+=`<li class="flex items-center gap-2">
          <span class="w-4 h-4 rounded border border-slate-300" style="background: ${qr(k)}"></span>
          <span>${Q}: <strong>${tt(k)}</strong></span>
        </li>`}let y="";if((h=o.changes)!=null&&h.typography){let U=o.changes.typography;U.headings&&(y+=`<li>Titres \u2192 <strong>${tt(U.headings)}</strong></li>`),U.body&&(y+=`<li>Textes \u2192 <strong>${tt(U.body)}</strong></li>`)}a.innerHTML=`
      <div class="w-8 h-8 rounded-full bg-purple-500 flex-shrink-0 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
        </svg>
      </div>
      <div class="flex-1 bg-purple-50 border border-purple-200 rounded-2xl rounded-tl-none p-4">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-xs font-semibold text-purple-700 bg-purple-100 px-2 py-0.5 rounded">Modification du th\xE8me</span>
        </div>
        ${o.reason?`<p class="text-sm text-slate-600 mb-3">${tt(o.reason)}</p>`:""}
        ${d?`
          <p class="text-xs font-medium text-slate-700 mb-1">Couleurs :</p>
          <ul class="text-xs text-slate-600 space-y-1 mb-3">${d}</ul>
        `:""}
        ${y?`
          <p class="text-xs font-medium text-slate-700 mb-1">Typographies :</p>
          <ul class="text-xs text-slate-600 space-y-1 mb-3 list-disc ml-4">${y}</ul>
        `:""}
        <div class="flex gap-2">
          <button 
            class="ai-apply-theme px-3 py-1.5 text-xs font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors flex items-center gap-1"
            data-proposal-id="${o.proposalId}"
          >
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Appliquer
          </button>
          <button 
            class="ai-reject-theme px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors flex items-center gap-1"
            data-proposal-id="${o.proposalId}"
          >
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            Rejeter
          </button>
        </div>
      </div>
    `,ve.appendChild(a),ve.scrollTop=ve.scrollHeight,(z=a.querySelector(".ai-apply-theme"))==null||z.addEventListener("click",Ar),(Z=a.querySelector(".ai-reject-theme"))==null||Z.addEventListener("click",jo)}function qr(o){return{white:"#ffffff",black:"#000000",transparent:"transparent","slate-50":"#f8fafc","slate-100":"#f1f5f9","slate-200":"#e2e8f0","slate-300":"#cbd5e1","slate-400":"#94a3b8","slate-500":"#64748b","slate-600":"#475569","slate-700":"#334155","slate-800":"#1e293b","slate-900":"#0f172a","gray-50":"#f9fafb","gray-100":"#f3f4f6","gray-200":"#e5e7eb","gray-300":"#d1d5db","gray-400":"#9ca3af","gray-500":"#6b7280","gray-600":"#4b5563","gray-700":"#374151","gray-800":"#1f2937","gray-900":"#111827","violet-50":"#f5f3ff","violet-100":"#ede9fe","violet-200":"#ddd6fe","violet-300":"#c4b5fd","violet-400":"#a78bfa","violet-500":"#8b5cf6","violet-600":"#7c3aed","violet-700":"#6d28d9","violet-800":"#5b21b6","violet-900":"#4c1d95","purple-50":"#faf5ff","purple-100":"#f3e8ff","purple-200":"#e9d5ff","purple-300":"#d8b4fe","purple-400":"#c084fc","purple-500":"#a855f7","purple-600":"#9333ea","purple-700":"#7e22ce","purple-800":"#6b21a8","purple-900":"#581c87","blue-50":"#eff6ff","blue-100":"#dbeafe","blue-200":"#bfdbfe","blue-300":"#93c5fd","blue-400":"#60a5fa","blue-500":"#3b82f6","blue-600":"#2563eb","blue-700":"#1d4ed8","blue-800":"#1e40af","blue-900":"#1e3a8a","emerald-50":"#ecfdf5","emerald-100":"#d1fae5","emerald-200":"#a7f3d0","emerald-300":"#6ee7b7","emerald-400":"#34d399","emerald-500":"#10b981","emerald-600":"#059669","emerald-700":"#047857","emerald-800":"#065f46","emerald-900":"#064e3b","teal-50":"#f0fdfa","teal-100":"#ccfbf1","teal-200":"#99f6e4","teal-300":"#5eead4","teal-400":"#2dd4bf","teal-500":"#14b8a6","teal-600":"#0d9488","teal-700":"#0f766e","teal-800":"#115e59","teal-900":"#134e4a","amber-50":"#fffbeb","amber-100":"#fef3c7","amber-200":"#fde68a","amber-300":"#fcd34d","amber-400":"#fbbf24","amber-500":"#f59e0b","amber-600":"#d97706","amber-700":"#b45309","amber-800":"#92400e","amber-900":"#78350f","red-50":"#fef2f2","red-100":"#fee2e2","red-200":"#fecaca","red-300":"#fca5a5","red-400":"#f87171","red-500":"#ef4444","red-600":"#dc2626","red-700":"#b91c1c","red-800":"#991b1b","red-900":"#7f1d1d"}[o]||"#9C6BFF"}async function Ar(o){var f;let a=(f=o.target.closest("[data-proposal-id]"))==null?void 0:f.dataset.proposalId,d=Se(Y.slug||"");if(!a||!d)return;let y=o.target.closest("button");y.disabled=!0,y.innerHTML='<span class="animate-spin">\u23F3</span> Application...';try{let h=await fetch(`/api/sites/${encodeURIComponent(d)}/ai/apply-theme`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({proposalId:a})}),z=await h.json();if(h.ok&&z.success){let Z=document.querySelector(`[data-proposal-id="${a}"]`);Z&&(Z.innerHTML=`
            <div class="w-8 h-8 rounded-full bg-purple-500 flex-shrink-0 flex items-center justify-center">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <div class="flex-1 bg-purple-50 border border-purple-200 rounded-2xl rounded-tl-none p-3">
              <p class="text-sm text-purple-700">\u2705 Th\xE8me mis \xE0 jour avec succ\xE8s !</p>
              <p class="text-xs text-purple-600 mt-1">Rechargez la preview pour voir les changements.</p>
            </div>
          `),$("Th\xE8me mis \xE0 jour !"),document.dispatchEvent(new CustomEvent("ai-theme-updated",{detail:{updatedTheme:z.updatedTheme}}))}else throw new Error(z.message||"Erreur lors de l'application")}catch(h){y.disabled=!1,y.innerHTML='<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> R\xE9essayer',$(`Erreur: ${h.message}`)}}async function Tr(o){var f,h;let a=(f=o.target.closest("[data-proposal-id]"))==null?void 0:f.dataset.proposalId,d=Se(Y.slug||"");if(!a||!d)return;let y=o.target.closest("button");y.disabled=!0,y.innerHTML='<span class="animate-spin">\u23F3</span> Application...';try{let z=await fetch(`/api/sites/${encodeURIComponent(d)}/ai/apply-edit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({proposalId:a})}),Z=await z.json();if(z.ok&&Z.success){let U=document.querySelector(`[data-proposal-id="${a}"]`);U&&(U.innerHTML=`
            <div class="w-8 h-8 rounded-full bg-emerald-500 flex-shrink-0 flex items-center justify-center">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <div class="flex-1 bg-emerald-50 border border-emerald-200 rounded-2xl rounded-tl-none p-3">
              <p class="text-sm text-emerald-700">\u2705 Modifications appliqu\xE9es avec succ\xE8s !</p>
              <p class="text-xs text-emerald-600 mt-1">La preview se met \xE0 jour automatiquement.</p>
            </div>
          `),$("Modifications appliqu\xE9es !");let Q=((h=Z.updatedPage)==null?void 0:h.id)||null;document.dispatchEvent(new CustomEvent("ai-page-updated",{detail:{pageId:Q,updatedPage:Z.updatedPage}}))}else throw new Error(Z.message||"Erreur lors de l'application")}catch(z){y.disabled=!1,y.innerHTML='<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> R\xE9essayer',$(`Erreur: ${z.message}`)}}async function jo(o){var y;let a=(y=o.target.closest("[data-proposal-id]"))==null?void 0:y.dataset.proposalId,d=Se(Y.slug||"");if(!(!a||!d))try{await fetch(`/api/sites/${encodeURIComponent(d)}/ai/proposal/${a}`,{method:"DELETE"});let f=document.querySelector(`[data-proposal-id="${a}"]`);f&&(f.innerHTML=`
          <div class="w-8 h-8 rounded-full bg-slate-400 flex-shrink-0 flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </div>
          <div class="flex-1 bg-slate-100 rounded-2xl rounded-tl-none p-3">
            <p class="text-sm text-slate-500">Proposition rejet\xE9e.</p>
          </div>
        `)}catch(f){console.error("[AI] Reject edit error:",f)}}async function $r(){let o=Se(Y.slug||"");if(!(!o||!ve))try{await fetch(`/api/sites/${encodeURIComponent(o)}/ai/history`,{method:"DELETE"}),ve.innerHTML="",ve.innerHTML=`
        <div class="flex gap-3" data-ai-welcome>
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-violet-500 to-indigo-600 flex-shrink-0 flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
            </svg>
          </div>
          <div class="flex-1 bg-slate-50 rounded-2xl rounded-tl-none p-3">
            <p class="text-sm text-slate-700">
              Salut ! \u{1F44B} Je suis ton assistant IA pour ce site. Je peux t'aider \xE0 :
            </p>
            <ul class="mt-2 text-sm text-slate-600 space-y-1">
              <li>\u{1F3A8} Sugg\xE9rer des palettes de couleurs</li>
              <li>\u270D\uFE0F G\xE9n\xE9rer du contenu pour tes blocs</li>
              <li>\u{1F4C4} Cr\xE9er des structures de pages</li>
              <li>\u{1F50D} Am\xE9liorer ton SEO</li>
              <li>\u270F\uFE0F <strong>Analyser et modifier tes pages</strong> (avec validation)</li>
            </ul>
          </div>
        </div>
      `,$("Historique effac\xE9")}catch(a){console.error("[AI] Clear history failed:",a),$("Erreur lors de l'effacement")}}let Ir={colors:"Sugg\xE8re-moi 3 palettes de couleurs harmonieuses pour mon site. Pour chaque palette, donne les couleurs Tailwind: primary, secondary, accent, et background.",hero:"G\xE9n\xE8re un bloc Hero en JSON avec un titre accrocheur, un sous-titre engageant et un CTA.",seo:"Analyse mon site et sugg\xE8re des am\xE9liorations SEO pour le meta title et la meta description de ma page d'accueil.",landing:"G\xE9n\xE8re la structure JSON d'une landing page compl\xE8te avec: Hero, 3 sections de contenu, et un CTA final.",analyze:"Analyse le contenu de toutes mes pages et propose des am\xE9liorations concr\xE8tes. Pour chaque suggestion d'am\xE9lioration de texte ou de structure, utilise le format propose-edit pour que je puisse valider.",improveHome:"Analyse ma page d'accueil et propose une am\xE9lioration du titre ou du Hero pour le rendre plus impactant. Utilise le format propose-edit."};to==null||to.addEventListener("click",()=>{Ts?$s():xr()}),so==null||so.addEventListener("click",$s),Ge==null||Ge.addEventListener("click",$s),oo==null||oo.addEventListener("click",()=>{confirm("Effacer tout l'historique de conversation ?")&&$r()}),ro==null||ro.addEventListener("submit",o=>{var d;o.preventDefault();let a=(d=kt==null?void 0:kt.value)==null?void 0:d.trim();a&&(kt.value="",Bo(a))}),yr.forEach(o=>{o.addEventListener("click",()=>{let a=o.dataset.aiQuick,d=Ir[a];d&&Bo(d)})}),document.addEventListener("keydown",o=>{o.key==="Escape"&&Ts&&$s()})});})();
