(()=>{document.addEventListener("DOMContentLoaded",()=>{console.log("[admin] Atelier charg\xE9");let Re=document.querySelector("[data-logout]");Re&&Re.addEventListener("click",async()=>{Re.disabled=!0;try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(o){console.error("[admin] Impossible de se d\xE9connecter",o)}finally{window.location.href="/admin/index.html"}});let pe=document.querySelector("[data-admin-sidebar]"),D=document.querySelector("[data-admin-sidebar-overlay]"),ut=document.querySelectorAll("[data-admin-sidebar-toggle]"),Ft=document.querySelectorAll("[data-admin-sidebar-close]"),Ve=document.body,xe=!1,Ce=()=>{if(!pe)return;if(window.matchMedia("(min-width: 1024px)").matches){pe.classList.remove("hidden"),D==null||D.classList.add("hidden"),Ve.classList.remove("overflow-hidden");return}xe?(pe.classList.remove("hidden"),D==null||D.classList.remove("hidden"),Ve.classList.add("overflow-hidden")):(pe.classList.add("hidden"),D==null||D.classList.add("hidden"),Ve.classList.remove("overflow-hidden"))},Mt=()=>{xe=!0,Ce()},Ue=()=>{xe=!1,Ce()};pe&&ut.length>0&&(ut.forEach(o=>{o.addEventListener("click",Mt)}),Ft.forEach(o=>{o.addEventListener("click",Ue)}),D==null||D.addEventListener("click",Ue),window.addEventListener("resize",Ce),window.addEventListener("keydown",o=>{o.key==="Escape"&&xe&&Ue()}),Ce());let pt="clower:currentSite",mt="clower:currentSiteName",b={slug:null,name:""};(()=>{try{b.slug=window.localStorage.getItem(pt),b.name=window.localStorage.getItem(mt)||""}catch{b.slug=null,b.name=""}})();let We=document.querySelectorAll("[data-site-card]"),jt=document.querySelectorAll("[data-site-select]"),me=document.querySelector("[data-current-site-name]"),ft=document.querySelector("[data-workspace-site-name]"),gt=document.querySelector("[data-workspace-back-name]"),K=document.querySelector("[data-workspace-back-modal]"),$t=document.querySelectorAll("[data-workspace-back]"),zt=document.querySelectorAll("[data-workspace-back-cancel]"),Ge=document.querySelector("[data-workspace-back-confirm]"),Ht=document.querySelectorAll("[data-workspace-tab]"),_e=document.querySelector("[data-site-toast]"),ht=document.querySelector("[data-site-toast-message]"),Ot=document.querySelectorAll("[data-site-create]"),E=document.querySelector("[data-site-modal]"),J=document.querySelector("[data-site-form]"),j=document.querySelector("[data-site-name]"),R=document.querySelector("[data-site-slug]"),A=document.querySelector("[data-site-slug-error]"),V=document.querySelector("[data-site-modal-error]"),Rt=document.querySelectorAll("[data-site-modal-cancel]"),le=document.querySelector("[data-site-modal-submit]"),L=Yt(),Ee=!1,ke=null,Je=null,Vt='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',vt=o=>{if(!E||E.classList.contains("hidden")||o.key!=="Tab")return;let a=Array.from(E.querySelectorAll(Vt)).filter(h=>!h.hasAttribute("disabled")&&!h.getAttribute("aria-hidden"));if(a.length===0)return;let u=a[0],f=a[a.length-1];o.shiftKey?document.activeElement===u&&(o.preventDefault(),f.focus()):document.activeElement===f&&(o.preventDefault(),u.focus())},P=o=>{!_e||!ht||(ht.textContent=o,_e.classList.remove("hidden"),Je&&clearTimeout(Je),Je=setTimeout(()=>{_e.classList.add("hidden")},2500))};function Y(o){return o?o.startsWith("/")?o:`/${o}`:""}function ce(o){return(o==null?void 0:o.replace(/^\//,""))||""}let qe=(o,a)=>{let u=o?Y(o):null;try{u&&(window.localStorage.setItem(pt,u),b.slug=u),typeof a=="string"&&a.length>0&&(window.localStorage.setItem(mt,a),b.name=a)}catch{b.slug=u||b.slug,b.name=a||b.name}},yt=o=>{me&&o&&(me.textContent=o),ft&&o&&(ft.textContent=o),gt&&o&&(gt.textContent=o)},Ye=o=>{Ht.forEach(a=>{let u=a.dataset.workspaceTab;if(!u)return;if(!o){a.href="#",a.classList.add("pointer-events-none","opacity-50","text-slate-400"),a.setAttribute("aria-disabled","true");return}let f=encodeURIComponent(ce(o));a.href=`/admin/site/${f}/${u}`,a.classList.remove("pointer-events-none","opacity-50","text-slate-400"),a.removeAttribute("aria-disabled")})},Ae=(o,a={})=>{if(!o)return;let u=Y(o),f=a.siteName||b.name||(me==null?void 0:me.dataset.defaultSiteName)||"";We.forEach(v=>{let x=Y(v.dataset.siteCard||"")===u,c=v.querySelector("[data-site-active-badge]");x?(v.classList.add("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),v.classList.remove("border-slate-200"),c==null||c.classList.remove("hidden"),f=v.dataset.siteName||f):(v.classList.remove("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),v.classList.add("border-slate-200"),c==null||c.classList.add("hidden"))}),a.persist!==!1&&qe(u,a.siteName||f);let h=a.siteName||f;yt(h),Ye(u)},Ut=async(o,a)=>{let u=Y(o);try{let f=await fetch("/api/sites/select",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slug:u})});if(!f.ok){let c=await f.json().catch(()=>({}));P(c.message||"Impossible de s\xE9lectionner ce site.");return}let h=await f.json().catch(()=>({})),v=Y(h.slug||u),w=h.name||a;qe(v,w),Ae(v,{siteName:w,persist:!1});let x=encodeURIComponent(ce(v));window.location.href=`/admin/site/${x}/design`}catch(f){console.error("[admin] Impossible de s\xE9lectionner le site",f),P("Erreur inattendue lors de la s\xE9lection.")}},Wt=async()=>{try{let o=await fetch("/api/sites/current",{credentials:"same-origin"});if(!o.ok){o.status===404&&L&&(window.location.href="/admin/sites");return}let a=await o.json(),u=Y(a.slug);qe(u,a.name),Ae(u,{siteName:a.name,persist:!1})}catch(o){console.warn("[admin] Impossible de r\xE9cup\xE9rer le site actif",o)}};(()=>{if(b.slug){Ae(b.slug,{siteName:b.name,persist:!1});return}let o=document.querySelector('[data-site-card][data-site-default="true"]')||We[0];o&&Ae(o.dataset.siteCard,{siteName:o.dataset.siteName||"",persist:!1})})(),Wt(),L?Ye(L.slugValue):b.slug&&Ye(b.slug),jt.forEach(o=>{o.addEventListener("click",()=>{if(o.disabled)return;let a=o.dataset.siteSelect,u=o.dataset.siteSelectName||"Ce site";a&&(o.disabled=!0,Ut(a,u).finally(()=>{o.disabled=!1}))})});let Be=o=>o.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),Gt=o=>{let a=Be(o||"");return a?`/${a}`:""},_t=()=>{E&&(ke=document.activeElement,E.classList.remove("hidden"),E.classList.add("flex"),Ee=!1,J==null||J.reset(),A&&(A.textContent=""),V&&(V.textContent=""),R&&j&&(R.value=Be(j.value)),document.addEventListener("keydown",vt),window.setTimeout(()=>{j==null||j.focus()},0))},Ie=()=>{E&&(E.classList.add("hidden"),E.classList.remove("flex"),document.removeEventListener("keydown",vt),Ee=!1,J==null||J.reset(),A&&(A.textContent=""),V&&(V.textContent=""),ke==null||ke.focus())};Ot.forEach(o=>{o.addEventListener("click",_t)}),Rt.forEach(o=>{o.addEventListener("click",Ie)}),E==null||E.addEventListener("click",o=>{o.target===E&&Ie()}),j==null||j.addEventListener("input",()=>{R&&(!Ee||R.value.trim().length===0)&&(R.value=Be(j.value))}),R==null||R.addEventListener("input",()=>{Ee=!0,A&&(A.textContent="")});let Jt=()=>new Set(Array.from(We).map(o=>Y(o.dataset.siteCard||"")));J==null||J.addEventListener("submit",async o=>{if(o.preventDefault(),!j||!R)return;let a=(j.value||"").trim(),u=R.value||"";u||(u=a);let f=Gt(u);if(!a||!f){A&&(A.textContent="Nom et slug sont requis.");return}if(Jt().has(f)){A&&(A.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}A&&(A.textContent=""),V&&(V.textContent=""),le&&(le.disabled=!0,le.textContent="Cr\xE9ation...");try{let v=await fetch("/api/sites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a,slug:f})});if(!v.ok){let Z=await v.json().catch(()=>({})),B=Z.message||"Impossible de cr\xE9er ce site.";V&&(V.textContent=B),Z.field==="slug"&&A&&(A.textContent=B);return}let w=await v.json(),x=Y((w==null?void 0:w.slug)||f),c=(w==null?void 0:w.name)||a;qe(x,c),Ie();let U=encodeURIComponent(ce(x));window.location.href=`/admin/site/${U}/design`}catch(v){console.error("[admin] Impossible de cr\xE9er le site",v),V&&(V.textContent="Erreur inattendue. R\xE9essaie dans un instant.")}finally{le&&(le.disabled=!1,le.textContent="Cr\xE9er")}}),window.addEventListener("keydown",o=>{o.key==="Escape"&&(E&&!E.classList.contains("hidden")&&Ie(),K&&!K.classList.contains("hidden")&&bt(),blockDeleteModal&&!blockDeleteModal.classList.contains("hidden")&&closeBlockDeleteModal(),blockLibraryOpen&&closeBlockLibrary())});function Yt(){let o=window.location.pathname.match(/^\/admin\/site\/([^/]+)(?:\/([^/]+))?/);return o?{slugPart:decodeURIComponent(o[1]),slugValue:Y(decodeURIComponent(o[1])),section:o[2]||"design"}:null}function Xt(){if(!K){window.location.href="/admin/sites";return}K.classList.remove("hidden"),K.classList.add("flex")}function bt(){K&&(K.classList.add("hidden"),K.classList.remove("flex"))}$t.forEach(o=>{o.addEventListener("click",Xt)}),zt.forEach(o=>{o.addEventListener("click",bt)}),Ge==null||Ge.addEventListener("click",()=>{window.location.href="/admin/sites"}),(L==null?void 0:L.section)==="design"&&Kt(),(L==null?void 0:L.section)==="content"&&Zt(),L&&b.name&&yt(b.name);function Kt(){let o=document.querySelectorAll("[data-page-list]");if(o.length===0)return;let a=document.querySelector("[data-active-page-title]"),u=document.querySelector("[data-active-page-slug]"),f=document.querySelector("[data-page-preview-tags]"),h=document.querySelector("[data-page-preview-frame]"),v=document.querySelector("[data-preview-open]"),w=document.querySelector("[data-preview-status]"),x=document.querySelector("[data-preview-highlight]"),c=document.querySelector("[data-blocks-list]"),U=document.querySelector("[data-blocks-empty]"),Z=document.querySelector("[data-block-count]"),B=document.querySelector("[data-block-library-toggle]"),I=document.querySelector("[data-block-library]"),ne=document.querySelectorAll("[data-block-add]"),F=document.querySelector("[data-block-delete-modal]"),se=document.querySelector("[data-block-delete-confirm]"),oe=document.querySelector("[data-block-delete-cancel]"),T=document.querySelector("[data-block-detail-empty]"),$=document.querySelector("[data-block-detail-status]"),z=document.querySelector("[data-block-editor]"),m=document.querySelector("[data-block-editor-block-name]"),S=document.querySelector("[data-block-editor-block-type]"),p=document.querySelector("[data-block-editor-unsupported]"),d=document.querySelector("[data-block-form]"),Qt=d?Array.from(d.querySelectorAll("[data-editor-section]")):[],Xe=document.querySelector("[data-block-form-cancel]"),wt=d==null?void 0:d.querySelector("[data-group-preview-mobile]"),St=d==null?void 0:d.querySelector("[data-group-preview-desktop]"),en={hero:{section:"hero",labelField:"title",descriptionField:"subtitle",fields:{title:"hero-title",subtitle:"hero-subtitle",ctaLabel:"hero-cta-label",ctaUrl:"hero-cta-url",image:"hero-image",align:"hero-align"}},paragraphe:{section:"paragraph",labelField:"title",descriptionField:"content",fields:{title:"paragraph-title",content:"paragraph-content",align:"paragraph-align"}},image:{section:"image",labelField:"alt",fields:{src:"image-src",alt:"image-alt",showCaption:"image-caption-toggle",caption:"image-caption"}},groupe:{section:"group",fields:{layout:"group-layout",columnsMobile:"group-columns-mobile",columnsDesktop:"group-columns-desktop"}},collectiongrid:{section:"collection",fields:{collectionId:"collection-grid-collection",limit:"collection-grid-limit"}}},tn={texte:"paragraphe",paragraph:"paragraphe",paragraphs:"paragraphe",paragraphes:"paragraphe",text:"paragraphe",hero:"hero",image:"image",groupe:"groupe",group:"groupe",collection:"collectiongrid",collectiongrid:"collectiongrid","collection-grid":"collectiongrid"},Lt=(e,t)=>{if(!wt||!St)return;let n=s=>Array.from({length:Number(s)||1}).map(()=>'<span class="block h-2 w-full rounded-full bg-slate-300"></span>').join("");wt.innerHTML=n(e),St.innerHTML=n(t)},nn=async()=>{if(!Q)return[];let e=await fetch(Q,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les pages.");let t=await e.json().catch(()=>[]);return Array.isArray(t)?t:[]},sn=async({title:e,slug:t})=>{if(!Q)throw new Error("Site inconnu.");let n=await fetch(Q,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,slug:t})});if(!n.ok){let s=await n.json().catch(()=>({}));throw new Error(s.message||"Impossible de cr\xE9er la page.")}return n.json().catch(()=>({}))},on=async e=>{if(!(!Q||!(e!=null&&e.id)))try{let t=await fetch(`${Q}/${encodeURIComponent(e.id)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let s=await t.json().catch(()=>({}));throw new Error(s.message||"Impossible de sauvegarder la page.")}let n=await t.json().catch(()=>({}));if(n!=null&&n.id){let s=be(n);return k=k.map(i=>i.id===s.id?s:i),(l==null?void 0:l.id)===s.id&&(l=s),s}return n}catch(t){console.error("[design] Save page failed",t),P(t.message||"Sauvegarde impossible.")}},an=async()=>{if(!Q){k=[],_=null,l=null,et(k,_),ge(null),T==null||T.classList.remove("hidden"),z==null||z.classList.add("hidden");return}try{let e=await nn();if(k=(Array.isArray(e)?e:[]).map(t=>be(t)),k.length===0){_=null,l=null,et(k,_),ge(null),T==null||T.classList.remove("hidden"),z==null||z.classList.add("hidden"),h&&(h.srcdoc=Ne());return}_=yn(k),ee(_)}catch(e){console.error("[design] Impossible de charger les pages",e),P("Impossible de charger les pages.")}},rn=e=>(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),xt=e=>{if(!e)return null;let t=rn(e.type),n=tn[t]||t;return en[n]||null},Ct=e=>{var n,s,i;if(!d||!z)return;e&&!e.settings&&(e.settings={});let t=xt(e);if(m&&(m.textContent=(e==null?void 0:e.label)||"Bloc"),S&&(S.textContent=(e==null?void 0:e.type)||"Bloc"),!t){d.classList.add("hidden"),p==null||p.classList.remove("hidden"),d.dataset.blockId="";return}if(p==null||p.classList.add("hidden"),d.classList.remove("hidden"),d.reset(),d.dataset.blockId=e.id,Qt.forEach(r=>{r.dataset.editorSection===t.section?r.classList.remove("hidden"):r.classList.add("hidden")}),t.section==="collection"){let r=e.collectionId||((n=e.settings)==null?void 0:n.collectionId)||"";ze(r)}if(Object.entries(t.fields).forEach(([r,g])=>{var re;let y=d.querySelector(`[name="${g}"]`);if(!y)return;let C=(re=e.settings)==null?void 0:re[r];y.type==="checkbox"?y.checked=!!C:y.type==="number"?y.value=C!=null?C:1:(y.tagName,y.value=C!=null?C:"")}),t.section==="group"){let r=((s=d.querySelector('[name="group-columns-mobile"]'))==null?void 0:s.value)||"1",g=((i=d.querySelector('[name="group-columns-desktop"]'))==null?void 0:i.value)||"3";Lt(r,g)}},ln=e=>{if(!d||!e)return{};let t={};return Object.entries(e.fields).forEach(([n,s])=>{let i=d.querySelector(`[name="${s}"]`);if(i)if(i.type==="checkbox")t[n]=i.checked;else if(i.type==="number"){let r=Number(i.value);t[n]=Number.isFinite(r)?r:0}else i.tagName==="TEXTAREA"?t[n]=i.value||"":i.type==="select-one"?t[n]=i.value:t[n]=i.value||""}),t},Te=e=>{if(w){if(!e){w.classList.add("hidden");return}w.classList.remove("hidden"),w.textContent=e}},cn=e=>e?{id:e.id,title:e.title,slug:e.slug,badges:[...e.badges||[]],blocks:(e.blocks||[]).map(t=>{var n;return{id:t.id,type:t.type,label:t.label,status:t.status,description:t.description,props:t.props||[],settings:t.settings||{},collectionId:t.collectionId||((n=t.settings)==null?void 0:n.collectionId)||""}})}:null,Ne=()=>'<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#475569;background:#fff;">Pr\xE9paration de la pr\xE9visualisation\u2026</body></html>',dn=e=>{if(!h||!e)return;let t={page:cn(e),site:{title:b.name||"Site",slug:b.slug||""}};it=!1,Te("Actualisation\u2026"),h.srcdoc=Ne(),ye&&ye.abort();let n=new AbortController;ye=n,fetch("/api/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:n.signal}).then(s=>{if(!s.ok)throw new Error("Preview error");return s.json()}).then(s=>{n.signal.aborted||(at=s.html||"",h.setAttribute("title",`Pr\xE9visualisation de la page ${e.title||""}`.trim()),h.srcdoc=at||Ne(),Te("\xC0 jour"))}).catch(s=>{n.signal.aborted||(console.error("[preview] Impossible de rendre la page",s),Te("Erreur preview"),h.srcdoc='<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#be123c;background:#fff;">Erreur lors du rendu de la pr\xE9visualisation.</body></html>')}).finally(()=>{ye===n&&(ye=null)})},un=e=>{if(e.preventDefault(),!l||!q)return;let t=tt(),n=xt(t);if(!t||!n)return;let s=ln(n);if(n.section==="collection"){if(!s.collectionId){P("S\xE9lectionnez une collection.");return}s.limit=Math.max(1,Number(s.limit)||1)}let i=(l.blocks||[]).map(r=>{if(r.id!==t.id)return r;let g={...r.settings||{},...s},y={...r,settings:g};return n.labelField&&s[n.labelField]&&(y.label=s[n.labelField]),n.descriptionField&&s[n.descriptionField]&&(y.description=s[n.descriptionField]),n.section==="collection"&&(y.collectionId=s.collectionId,y.settings.collectionId=s.collectionId,y.settings.limit=s.limit),y});he(i),P("Bloc mis \xE0 jour"),ee(l.id,{preserveBlock:!0})},ae=document.querySelector("[data-page-drawer]"),M=document.querySelector("[data-page-drawer-backdrop]"),pn=document.querySelectorAll("[data-page-drawer-open]"),mn=document.querySelectorAll("[data-page-drawer-close]"),ie=document.querySelector("[data-add-page-toggle]"),H=document.querySelector("[data-add-page-form]"),W=document.querySelector("[data-add-page-title]"),G=document.querySelector("[data-add-page-slug]"),Ke=document.querySelector("[data-add-page-cancel]"),N=document.querySelector("[data-add-page-error]"),de=H==null?void 0:H.querySelector('[type="submit"]'),fn=ce((L==null?void 0:L.slugValue)||b.slug||"default")||"default",gn=(L==null?void 0:L.slugValue)||b.slug||"",De=ce(gn)||"",Q=De?`/api/sites/${encodeURIComponent(De)}/pages`:null,Et=De?`/api/sites/${encodeURIComponent(De)}/collections`:null,kt={active:`clower:activePage:${fn}`},Ze=(e,t,n,s,i,r=[],g={})=>{let y={id:e,label:t,type:n,status:s,description:i,props:r,settings:{...g}};return y.settings.collectionId&&(y.collectionId=y.settings.collectionId),y},hn={hero:{type:"Hero",label:"Hero de page",description:"Section pleine largeur avec CTA principal.",status:"Brouillon",props:[{label:"CTA",value:"D\xE9couvrir"},{label:"Hauteur",value:"80vh"}],settings:{title:"Titre du hero",subtitle:"",ctaLabel:"D\xE9couvrir",ctaUrl:"#",image:"",align:"center"}},paragraph:{type:"Paragraphe",label:"Bloc \xE9ditorial",description:"Paragraphe libre pour raconter votre histoire.",status:"Brouillon",props:[{label:"Longueur",value:"150 mots"}],settings:{title:"Titre du paragraphe",content:"",align:"left"}},image:{type:"Image",label:"Bloc image",description:"Visuel seul avec l\xE9gende optionnelle.",status:"Brouillon",props:[{label:"Ratio",value:"16:9"},{label:"L\xE9gende",value:"Inactive"}],settings:{src:"",alt:"",showCaption:!1,caption:""}},group:{type:"Groupe",label:"Groupe de sections",description:"Conteneur pour imbriquer plusieurs sous-blocs.",status:"Brouillon",props:[{label:"Disposition",value:"Verticale"}],settings:{layout:"grid",columnsMobile:"1",columnsDesktop:"3"}},collectiongrid:{type:"CollectionGrid",label:"Grille de contenus",description:"Affiche automatiquement les items d\u2019une collection.",status:"Brouillon",settings:{collectionId:"",limit:6}}},vn=e=>{try{window.localStorage.setItem(kt.active,e)}catch{}},yn=e=>{var t;try{let n=window.localStorage.getItem(kt.active);if(n&&e.some(s=>s.id===n))return n}catch{}return((t=e[0])==null?void 0:t.id)||null},bn=e=>!e||e<=0?"0 bloc":e===1?"1 bloc":`${e} blocs`,qt=e=>{if(!e||e==="/")return"/";let t=Be(e.replace(/^\//,""));return t?`/${t}`:"/"},Qe=(e="page",t="block")=>`${e}-${t}-${Date.now().toString(36)}-${Math.floor(Math.random()*1e3)}`,Vn=(e,t)=>[Ze(Qe(e,"intro"),"Introduction","Paragraphe","Brouillon",`Paragraphe introductif pour "${t}".`,[{label:"Longueur",value:"2 paragraphes"}],{title:`Introduction \xE0 ${t}`,content:"Ajoutez votre premier paragraphe de pr\xE9sentation.",align:"left"}),Ze(Qe(e,"content"),"Zone de contenu","Groupe","Brouillon","Section principale \xE0 composer avec textes et visuels.",[{label:"Colonnes",value:"Auto"}],{layout:"grid",columnsMobile:"1",columnsDesktop:"2"})],wn=e=>{a&&(a.textContent=(e==null?void 0:e.title)||"Page"),u&&(u.textContent=(e==null?void 0:e.slug)||"/")},Sn=e=>{if(!f)return;f.innerHTML="",(e&&e.badges&&e.badges.length>0?e.badges:["Structure en cours"]).forEach(n=>{let s=document.createElement("span");s.className="rounded-full bg-slate-100 px-3 py-1",s.textContent=n,f.appendChild(s)})},Ln=e=>{switch((e||"").toLowerCase()){case"en ligne":return"bg-emerald-50 text-emerald-700";case"brouillon":return"bg-amber-50 text-amber-700";default:return"bg-slate-100 text-slate-600"}},Pe=e=>{if(!(!T||!z)){if(!e){T.classList.remove("hidden"),z.classList.add("hidden"),p==null||p.classList.add("hidden"),d==null||d.classList.add("hidden"),$==null||$.classList.add("hidden");return}T.classList.add("hidden"),z.classList.remove("hidden"),$&&(e.status?($.textContent=e.status,$.className=`rounded-full px-3 py-1 text-xs font-semibold ${Ln(e.status)}`,$.classList.remove("hidden")):$.classList.add("hidden")),Ct(e)}},fe=e=>{if(!h)return;let t=h.contentDocument;if(!t)return;t.querySelectorAll("[data-preview-block]").forEach(s=>{s.dataset.previewBlock===e?(s.classList.add("preview-block-active"),it&&e&&s.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})):s.classList.remove("preview-block-active")}),x&&(x.style.borderColor=e?"rgba(156, 107, 255, 0.5)":"transparent")},ge=e=>{if(!c)return;c.innerHTML="";let t=(e==null?void 0:e.blocks)||[];if(Z&&(Z.textContent=bn(t.length)),t.length===0){c.classList.add("hidden"),U==null||U.classList.remove("hidden");return}c.classList.remove("hidden"),U==null||U.classList.add("hidden"),t.forEach(n=>{var Pt;let s=n.id===q,i=document.createElement("div");i.dataset.blockItem="true",i.dataset.blockId=n.id,i.setAttribute("role","option"),i.setAttribute("aria-selected",s?"true":"false"),i.tabIndex=0,i.className=["relative flex items-center gap-3 rounded-2xl border px-3 py-2 text-left transition",s?"bg-slate-100 border-[#9C6BFF]/40 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let r=document.createElement("span");r.className=`absolute inset-y-2 left-0 w-1 rounded-full bg-[#9C6BFF] ${s?"":"hidden"}`,i.appendChild(r);let g=document.createElement("div");g.className="flex flex-1 items-center gap-3";let y=document.createElement("div");y.className="hidden lg:flex cursor-grab flex-shrink-0 items-center text-lg text-slate-400",y.innerHTML="&#8801;",g.appendChild(y);let C=document.createElement("div");C.className="flex-1";let re=document.createElement("div");re.className="flex items-center gap-2 text-[11px] uppercase tracking-wide text-slate-500";let rt=document.createElement("span");rt.className="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600",rt.textContent=n.type;let lt=document.createElement("span");lt.className="text-slate-400",lt.textContent=n.status,re.appendChild(rt),re.appendChild(lt);let ct=document.createElement("p");ct.className="mt-1 text-sm font-semibold text-slate-900";let zn=n.settings&&n.settings.title||n.label||"Bloc sans titre";if(ct.textContent=zn,C.appendChild(re),C.appendChild(ct),(n.type||"").toLowerCase()==="collectiongrid"&&n.collectionId){let O=((Pt=te.find(Hn=>Hn.id===n.collectionId))==null?void 0:Pt.name)||n.collectionId,dt=document.createElement("p");dt.className="text-xs text-slate-400",dt.textContent=`Collection : ${O}`,C.appendChild(dt)}g.appendChild(C),i.appendChild(g);let He=document.createElement("div");He.className="flex flex-col gap-1 text-xs text-slate-400";let Oe=document.createElement("div");Oe.className="flex items-center gap-1 lg:hidden";let we=document.createElement("button");we.type="button",we.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",we.textContent="\u2191",we.addEventListener("click",O=>{O.stopPropagation(),At(n.id,-1)});let Se=document.createElement("button");Se.type="button",Se.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",Se.textContent="\u2193",Se.addEventListener("click",O=>{O.stopPropagation(),At(n.id,1)}),Oe.appendChild(we),Oe.appendChild(Se),He.appendChild(Oe);let Le=document.createElement("button");Le.type="button",Le.className="inline-flex items-center justify-center rounded-lg border border-transparent px-2 py-1 text-[12px] text-rose-500 hover:text-rose-700",Le.innerHTML="\u{1F5D1}\uFE0F",Le.addEventListener("click",O=>{O.stopPropagation(),qn(n.id)}),He.appendChild(Le),i.appendChild(He),i.addEventListener("click",()=>{ue(n.id)}),i.addEventListener("keydown",O=>{(O.key==="Enter"||O.key===" ")&&(O.preventDefault(),ue(n.id))}),c.appendChild(i)})},et=(e,t)=>{o.forEach(n=>{n.innerHTML="",e.forEach(s=>{let i=document.createElement("li"),r=document.createElement("button");r.type="button",r.dataset.pageId=s.id,r.className=["w-full flex items-center justify-between gap-3 px-3 py-2 text-left transition",t===s.id?"bg-[#9C6BFF]/10 text-slate-900 border border-[#9C6BFF]/40 rounded-xl shadow-sm":"text-slate-700 hover:bg-slate-50 rounded-xl"].join(" "),t===s.id?r.setAttribute("aria-current","page"):r.removeAttribute("aria-current"),r.innerHTML=`
            <div class="flex items-center gap-3">
              <span class="flex h-9 w-9 items-center justify-center rounded-xl border border-slate-200 bg-white text-slate-500">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6.5 4.5h7l4 4v11a1 1 0 0 1-1 1h-10a1 1 0 0 1-1-1v-14a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
                  <path d="M13.5 4.5v4a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.4"/>
                </svg>
              </span>
              <div class="flex flex-col">
                <span class="text-sm font-semibold">${s.title}</span>
                <span class="text-xs text-slate-500">${s.slug}</span>
              </div>
            </div>
          `,r.addEventListener("click",()=>{ee(s.id),st()||ot()}),i.appendChild(r),n.appendChild(i)})})},tt=()=>!l||!Array.isArray(l.blocks)?null:l.blocks.find(e=>e.id===q)||null,ue=e=>{if(!l)return;if(!e){q=null,ge(l),Pe(null),fe(null);return}let t=l.blocks.find(n=>n.id===e)||l.blocks[0]||null;q=(t==null?void 0:t.id)||null,ge(l),Pe(t),fe(q)},he=e=>{if(!l)return;let t={...l,blocks:e};An(t)},Fe=()=>window.matchMedia("(min-width: 1024px)").matches;function At(e,t){if(!l||!e||!t)return;let n=[...l.blocks||[]],s=n.findIndex(g=>g.id===e);if(s<0)return;let i=s+t;if(i<0||i>=n.length)return;let[r]=n.splice(s,1);n.splice(i,0,r),he(n),ee(l.id,{preserveBlock:!0}),ue(r.id)}function xn(e,t){if(!l||!e||!t||e===t)return;let n=[...l.blocks||[]],s=n.findIndex(g=>g.id===e),i=n.findIndex(g=>g.id===t);if(s<0||i<0)return;let[r]=n.splice(s,1);n.splice(i,0,r),he(n),ee(l.id,{preserveBlock:!0}),ue(r.id)}function Bt(){if(!c)return;let e=Fe();c.querySelectorAll("[data-block-item]").forEach(t=>{t.setAttribute("draggable",e?"true":"false")})}function Me(){I&&(I.classList.add("hidden"),ve=!1)}function Cn(){I&&(I.classList.remove("hidden"),ve=!0)}function En(){ve?Me():Cn()}function kn(e){var r;if(!l||!e)return;let t=hn[e];if(!t)return;let n=(l.blocks||[]).filter(g=>g.type===t.type).length+1,s=Ze(Qe(l.id,e),`${t.label} ${n}`,t.type,t.status,t.description,t.props,t.settings||{});if((t.type||"").toLowerCase()==="collectiongrid"){let g=((r=te[0])==null?void 0:r.id)||"";s.collectionId=g,s.settings.collectionId=g,s.settings.limit=s.settings.limit||6}let i=[...l.blocks||[],s];he(i),ee(l.id,{preserveBlock:!0}),ue(s.id),Me(),P("Bloc ajout\xE9")}function It(e){var s,i;if(!l)return;let t=(l.blocks||[]).filter(r=>r.id!==e),n=e===q?((s=t[0])==null?void 0:s.id)||null:q||((i=t[0])==null?void 0:i.id)||null;he(t),q=n,ee(l.id,{preserveBlock:!0}),q?ue(q):(Pe(null),fe(null)),P("Bloc supprim\xE9")}function nt(){F&&(F.classList.add("hidden"),F.classList.remove("flex"),$e=null)}function qn(e){if(!F){It(e);return}$e=e,F.classList.remove("hidden"),F.classList.add("flex")}let An=e=>{if(!e)return;let t=be(e);k=k.map(n=>n.id===t.id?t:n),l=t,on(t)},ee=(e,t={})=>{var i,r;let n=k.find(g=>g.id===e)||k[0]||null;l=n?be(n):null,_=(n==null?void 0:n.id)||null,(!t.preserveBlock||!l||!l.blocks.some(g=>g.id===q))&&(q=((r=(i=l==null?void 0:l.blocks)==null?void 0:i[0])==null?void 0:r.id)||null),_&&vn(_),et(k,_),wn(l),Sn(l),dn(l),ge(l),Pe(tt()),fe(q),Bt(),ve&&Me()},st=()=>window.matchMedia("(min-width: 1024px)").matches,Tt=()=>{ae&&(st()?(ae.classList.add("is-open"),M==null||M.classList.add("hidden"),document.body.classList.remove("overflow-hidden")):ae.classList.remove("is-open"))},Bn=()=>{!ae||st()||(ae.classList.add("is-open"),M==null||M.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},ot=()=>{ae&&(ae.classList.remove("is-open"),M==null||M.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))},In=()=>{!H||!ie||(H.classList.remove("hidden"),ie.classList.add("hidden"),N&&(N.textContent=""),je=!1,W&&(W.value="",W.focus()),G&&(G.value=""))},Nt=()=>{!H||!ie||(H.classList.add("hidden"),ie.classList.remove("hidden"),N&&(N.textContent=""),je=!1,H.reset())},Tn=()=>{!W||!G||je&&G.value.trim().length>0||(G.value=qt(W.value))},k=[],_=null,je=!1,l=null,q=null,ve=!1,$e=null,at="",it=!1,ye=null,te=[],Nn=e=>{let t={...e,props:Array.isArray(e.props)?e.props:[],settings:{...e.settings||{}}};return(t.type||"").toLowerCase()==="collectiongrid"&&(t.collectionId=t.collectionId||t.settings.collectionId||"",t.settings.collectionId=t.collectionId,t.settings.limit=t.settings.limit||6),t},be=e=>({...e,blocks:(e.blocks||[]).map(t=>Nn(t))}),Dn=async()=>{var e;if(!Et){te=[],ze();return}try{let t=await fetch(Et,{headers:{Accept:"application/json"}});if(!t.ok)throw new Error("Impossible de charger les collections.");let n=await t.json().catch(()=>[]);te=Array.isArray(n)?n:[];let s=((e=d==null?void 0:d.querySelector('[name="collection-grid-collection"]'))==null?void 0:e.value)||"";ze(s)}catch(t){console.error("[design] collections load",t),P("Collections indisponibles."),te=[],ze()}},ze=(e="")=>{if(!d)return;let t=d.querySelector('[name="collection-grid-collection"]');if(t){if(t.innerHTML="",!te.length){t.disabled=!0;let n=document.createElement("option");n.value="",n.textContent="Aucune collection disponible",t.appendChild(n);return}if(t.disabled=!1,e&&!te.some(n=>n.id===e)){let n=document.createElement("option");n.value=e,n.textContent=e,t.appendChild(n)}te.forEach(n=>{let s=document.createElement("option");s.value=n.id,s.textContent=n.name||n.id,t.appendChild(s)}),e&&(t.value=e)}};Dn(),Tt(),pn.forEach(e=>{e.addEventListener("click",Bn)}),mn.forEach(e=>{e.addEventListener("click",ot)}),M==null||M.addEventListener("click",ot),window.addEventListener("resize",()=>{Tt(),Bt()}),ie==null||ie.addEventListener("click",In),Ke==null||Ke.addEventListener("click",Nt),W==null||W.addEventListener("input",Tn),G==null||G.addEventListener("input",()=>{N&&(N.textContent=""),je=!0}),H==null||H.addEventListener("submit",async e=>{if(e.preventDefault(),!Q){N&&(N.textContent="Aucun site s\xE9lectionn\xE9.");return}if(!W||!G)return;let t=W.value.trim(),n=qt(G.value.trim()||t);if(!t||!n){N&&(N.textContent="Titre et slug sont requis.");return}N&&(N.textContent=""),de&&(de.disabled=!0,de.textContent="Cr\xE9ation...");try{let s=await sn({title:t,slug:n});if(!s||!s.id)throw new Error("R\xE9ponse invalide.");k=[...k,be(s)],Nt(),P("Page cr\xE9\xE9e"),ee(s.id)}catch(s){console.error("[design] create page failed",s),N&&(N.textContent=s.message||"Impossible de cr\xE9er la page.")}finally{de&&(de.disabled=!1,de.textContent="Cr\xE9er")}}),B==null||B.addEventListener("click",e=>{e.stopPropagation(),En()}),document.addEventListener("click",e=>{ve&&(I!=null&&I.contains(e.target)||B!=null&&B.contains(e.target)||Me())}),ne.forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();let n=e.dataset.blockAdd;kn(n)})}),oe==null||oe.addEventListener("click",()=>{nt()}),se==null||se.addEventListener("click",()=>{$e&&It($e),nt()}),F==null||F.addEventListener("click",e=>{e.target===F&&nt()}),d==null||d.addEventListener("input",e=>{var n,s;let t=e.target;if(!(!t||!t.name)&&(t.name==="group-columns-mobile"||t.name==="group-columns-desktop")){let i=((n=d.querySelector('[name="group-columns-mobile"]'))==null?void 0:n.value)||"1",r=((s=d.querySelector('[name="group-columns-desktop"]'))==null?void 0:s.value)||"3";Lt(i,r)}}),d==null||d.addEventListener("submit",un),Xe==null||Xe.addEventListener("click",e=>{e.preventDefault();let t=tt();t&&Ct(t)}),h==null||h.addEventListener("load",()=>{it=!0,Te("\xC0 jour"),fe(q)}),v==null||v.addEventListener("click",()=>{let e=window.open("","_blank");if(!e)return;e.opener=null;let t=e.document;t.open(),t.write(at||Ne()),t.close()});let Pn=e=>{let t=e.target.closest("[data-block-item]");!t||!Fe()||(X=t.dataset.blockId||null,X&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",X),t.classList.add("opacity-50")))},Dt=()=>{c==null||c.querySelectorAll("[data-block-item]").forEach(e=>e.classList.remove("opacity-50","ring-2","ring-[#9C6BFF]/50"))},Fn=()=>{X=null,Dt()},Mn=e=>{if(!X||!Fe())return;let t=e.target.closest("[data-block-item]");!t||t.dataset.blockId===X||(e.preventDefault(),t.classList.add("ring-2","ring-[#9C6BFF]/50"))},jn=e=>{let t=e.target.closest("[data-block-item]");t&&t.classList.remove("ring-2","ring-[#9C6BFF]/50")},$n=e=>{if(!X||!Fe())return;e.preventDefault();let t=e.target.closest("[data-block-item]"),n=X;X=null,Dt();let s=(t==null?void 0:t.dataset.blockId)||null;s&&xn(n,s)},X=null;c==null||c.addEventListener("dragstart",Pn),c==null||c.addEventListener("dragend",Fn),c==null||c.addEventListener("dragover",Mn),c==null||c.addEventListener("dragleave",jn),c==null||c.addEventListener("drop",$n),an()}function Zt(){let o=document.querySelector("[data-collection-list]");if(!o)return;let a=document.querySelector("[data-collection-empty]"),u=document.querySelector("[data-collection-items-empty]"),f=document.querySelector("[data-collection-items]"),h=document.querySelector("[data-collection-title]"),v=document.querySelector("[data-collection-description]"),w=document.querySelector("[data-collection-drawer]"),x=document.querySelector("[data-collection-drawer-backdrop]"),c=document.querySelectorAll("[data-collection-drawer-open]"),U=document.querySelectorAll("[data-collection-drawer-close]"),Z=ce((L==null?void 0:L.slugValue)||b.slug||""),B=Z?`/api/sites/${encodeURIComponent(Z)}/collections`:null,I=[],ne=null,F=()=>{w&&(w.classList.add("is-open"),w.style.transform="translateX(0)",x==null||x.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},se=()=>{w&&(w.classList.remove("is-open"),w.style.transform="",x==null||x.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))};c.forEach(m=>{m.addEventListener("click",F)}),U.forEach(m=>{m.addEventListener("click",se)}),x==null||x.addEventListener("click",se);let oe=()=>{if(o.innerHTML="",!I.length){a==null||a.classList.remove("hidden");return}a==null||a.classList.add("hidden"),I.forEach(m=>{let S=m.id===ne,p=document.createElement("button");p.type="button",p.dataset.collectionId=m.id,p.className=["w-full rounded-xl border px-3 py-2 text-left transition focus:outline-none focus:ring-2 focus:ring-[#9C6BFF]/40",S?"bg-[#F7F0FF] border-[#9C6BFF]/40 text-slate-900":"border-slate-200 text-slate-700 hover:border-[#9C6BFF]/40"].join(" "),p.setAttribute("role","option"),S?p.setAttribute("aria-current","true"):p.removeAttribute("aria-current"),p.innerHTML=`
          <div class="flex items-center justify-between gap-2">
            <div>
              <p class="text-sm font-semibold">${m.name||m.id}</p>
              <p class="text-xs text-slate-500">${m.description||""}</p>
            </div>
            <span class="text-[11px] uppercase tracking-wide text-slate-400">${m.type||""}</span>
          </div>
        `,p.addEventListener("click",()=>{$(m.id),window.matchMedia("(min-width: 1024px)").matches||se()}),o.appendChild(p)})},T=m=>{if(f){if(f.innerHTML="",!m||m.length===0){u==null||u.classList.remove("hidden");return}u==null||u.classList.add("hidden"),m.forEach(S=>{let p=document.createElement("article");p.className="rounded-2xl border border-slate-200 bg-white px-4 py-3 shadow-sm hover:border-[#9C6BFF]/40",p.innerHTML=`
          <div class="flex items-center justify-between gap-2">
            <div>
              <p class="text-sm font-semibold text-slate-900">${S.title||"Item"}</p>
              <p class="text-xs text-slate-500">${S.summary||""}</p>
            </div>
            <span class="text-[11px] uppercase tracking-wide ${(S.status||"").toLowerCase()==="publi\xE9"?"text-emerald-600":"text-amber-600"}">${S.status||""}</span>
          </div>
        `,f.appendChild(p)})}},$=async m=>{if(!m||ne===m)return;ne=m;let S=I.find(p=>p.id===m);if(h&&(h.textContent=(S==null?void 0:S.name)||"Collection"),v&&(v.textContent=(S==null?void 0:S.description)||""),oe(),!B){T([]);return}try{let p=await fetch(`${B}/${encodeURIComponent(m)}/items`,{headers:{Accept:"application/json"}});if(!p.ok)throw new Error("Impossible de charger les items.");let d=await p.json().catch(()=>({items:[]}));T(d.items||[])}catch(p){console.error("[content] items failed",p),P(p.message||"Impossible de charger les items."),T([])}};(async()=>{if(!B){a==null||a.classList.remove("hidden");return}try{let m=await fetch(B,{headers:{Accept:"application/json"}});if(!m.ok)throw new Error("Impossible de charger les collections.");let S=await m.json().catch(()=>[]);I=Array.isArray(S)?S:[],I.length>0?(ne=I[0].id,oe(),$(ne)):(oe(),T([]))}catch(m){console.error("[content] load collections",m),P(m.message||"Impossible de charger les collections.")}})()}});})();
