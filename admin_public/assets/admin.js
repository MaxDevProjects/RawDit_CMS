(()=>{document.addEventListener("DOMContentLoaded",()=>{console.log("[admin] Atelier charg\xE9");let Ct=document.querySelector("[data-logout]");Ct&&Ct.addEventListener("click",async()=>{Ct.disabled=!0;try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(s){console.error("[admin] Impossible de se d\xE9connecter",s)}finally{window.location.href="/admin/index.html"}});let We=document.querySelector("[data-admin-sidebar]"),de=document.querySelector("[data-admin-sidebar-overlay]"),Jt=document.querySelectorAll("[data-admin-sidebar-toggle]"),ln=document.querySelectorAll("[data-admin-sidebar-close]"),Et=document.body,it=!1,lt=()=>{if(!We)return;if(window.matchMedia("(min-width: 1024px)").matches){We.classList.remove("hidden"),de==null||de.classList.add("hidden"),Et.classList.remove("overflow-hidden");return}it?(We.classList.remove("hidden"),de==null||de.classList.remove("hidden"),Et.classList.add("overflow-hidden")):(We.classList.add("hidden"),de==null||de.classList.add("hidden"),Et.classList.remove("overflow-hidden"))},cn=()=>{it=!0,lt()},qt=()=>{it=!1,lt()};We&&Jt.length>0&&(Jt.forEach(s=>{s.addEventListener("click",cn)}),ln.forEach(s=>{s.addEventListener("click",qt)}),de==null||de.addEventListener("click",qt),window.addEventListener("resize",lt),window.addEventListener("keydown",s=>{s.key==="Escape"&&it&&qt()}),lt());let Wt="clower:currentSite",Gt="clower:currentSiteName",V={slug:null,name:""};(()=>{try{V.slug=window.localStorage.getItem(Wt),V.name=window.localStorage.getItem(Gt)||""}catch{V.slug=null,V.name=""}})();let kt=document.querySelectorAll("[data-site-card]"),dn=document.querySelectorAll("[data-site-select]"),Ge=document.querySelector("[data-current-site-name]"),_t=document.querySelector("[data-workspace-site-name]"),Yt=document.querySelector("[data-workspace-back-name]"),Ie=document.querySelector("[data-workspace-back-modal]"),un=document.querySelectorAll("[data-workspace-back]"),mn=document.querySelectorAll("[data-workspace-back-cancel]"),It=document.querySelector("[data-workspace-back-confirm]"),pn=document.querySelectorAll("[data-workspace-tab]"),At=document.querySelector("[data-site-toast]"),Kt=document.querySelector("[data-site-toast-message]"),fn=document.querySelectorAll("[data-site-create]"),oe=document.querySelector("[data-site-modal]"),Ce=document.querySelector("[data-site-form]"),pe=document.querySelector("[data-site-name]"),be=document.querySelector("[data-site-slug]"),ie=document.querySelector("[data-site-slug-error]"),xe=document.querySelector("[data-site-modal-error]"),gn=document.querySelectorAll("[data-site-modal-cancel]"),He=document.querySelector("[data-site-modal-submit]"),J=Sn(),ct=!1,dt=null,Bt=null,hn='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',Xt=s=>{if(!oe||oe.classList.contains("hidden")||s.key!=="Tab")return;let i=Array.from(oe.querySelectorAll(hn)).filter(S=>!S.hasAttribute("disabled")&&!S.getAttribute("aria-hidden"));if(i.length===0)return;let g=i[0],y=i[i.length-1];s.shiftKey?document.activeElement===g&&(s.preventDefault(),y.focus()):document.activeElement===y&&(s.preventDefault(),g.focus())},j=s=>{!At||!Kt||(Kt.textContent=s,At.classList.remove("hidden"),Bt&&clearTimeout(Bt),Bt=setTimeout(()=>{At.classList.add("hidden")},2500))};function Ee(s){return s?s.startsWith("/")?s:`/${s}`:""}function Ae(s){return(s==null?void 0:s.replace(/^\//,""))||""}let ut=(s,i)=>{let g=s?Ee(s):null;try{g&&(window.localStorage.setItem(Wt,g),V.slug=g),typeof i=="string"&&i.length>0&&(window.localStorage.setItem(Gt,i),V.name=i)}catch{V.slug=g||V.slug,V.name=i||V.name}},Zt=s=>{Ge&&s&&(Ge.textContent=s),_t&&s&&(_t.textContent=s),Yt&&s&&(Yt.textContent=s)},Tt=s=>{pn.forEach(i=>{let g=i.dataset.workspaceTab;if(!g)return;if(!s){i.href="#",i.classList.add("pointer-events-none","opacity-50","text-slate-400"),i.setAttribute("aria-disabled","true");return}let y=encodeURIComponent(Ae(s));i.href=`/admin/site/${y}/${g}`,i.classList.remove("pointer-events-none","opacity-50","text-slate-400"),i.removeAttribute("aria-disabled")})},mt=(s,i={})=>{if(!s)return;let g=Ee(s),y=i.siteName||V.name||(Ge==null?void 0:Ge.dataset.defaultSiteName)||"";kt.forEach(v=>{let F=Ee(v.dataset.siteCard||"")===g,u=v.querySelector("[data-site-active-badge]");F?(v.classList.add("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),v.classList.remove("border-slate-200"),u==null||u.classList.remove("hidden"),y=v.dataset.siteName||y):(v.classList.remove("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),v.classList.add("border-slate-200"),u==null||u.classList.add("hidden"))}),i.persist!==!1&&ut(g,i.siteName||y);let S=i.siteName||y;Zt(S),Tt(g)},yn=async(s,i)=>{let g=Ee(s);try{let y=await fetch("/api/sites/select",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slug:g})});if(!y.ok){let u=await y.json().catch(()=>({}));j(u.message||"Impossible de s\xE9lectionner ce site.");return}let S=await y.json().catch(()=>({})),v=Ee(S.slug||g),q=S.name||i;ut(v,q),mt(v,{siteName:q,persist:!1});let F=encodeURIComponent(Ae(v));window.location.href=`/admin/site/${F}/design`}catch(y){console.error("[admin] Impossible de s\xE9lectionner le site",y),j("Erreur inattendue lors de la s\xE9lection.")}},vn=async()=>{try{let s=await fetch("/api/sites/current",{credentials:"same-origin"});if(!s.ok){s.status===404&&J&&(window.location.href="/admin/sites");return}let i=await s.json(),g=Ee(i.slug);ut(g,i.name),mt(g,{siteName:i.name,persist:!1})}catch(s){console.warn("[admin] Impossible de r\xE9cup\xE9rer le site actif",s)}};(()=>{if(V.slug){mt(V.slug,{siteName:V.name,persist:!1});return}let s=document.querySelector('[data-site-card][data-site-default="true"]')||kt[0];s&&mt(s.dataset.siteCard,{siteName:s.dataset.siteName||"",persist:!1})})(),vn(),J?Tt(J.slugValue):V.slug&&Tt(V.slug),dn.forEach(s=>{s.addEventListener("click",()=>{if(s.disabled)return;let i=s.dataset.siteSelect,g=s.dataset.siteSelectName||"Ce site";i&&(s.disabled=!0,yn(i,g).finally(()=>{s.disabled=!1}))})});let _e=s=>s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),bn=s=>{let i=_e(s||"");return i?`/${i}`:""},xn=()=>{oe&&(dt=document.activeElement,oe.classList.remove("hidden"),oe.classList.add("flex"),ct=!1,Ce==null||Ce.reset(),ie&&(ie.textContent=""),xe&&(xe.textContent=""),be&&pe&&(be.value=_e(pe.value)),document.addEventListener("keydown",Xt),window.setTimeout(()=>{pe==null||pe.focus()},0))},pt=()=>{oe&&(oe.classList.add("hidden"),oe.classList.remove("flex"),document.removeEventListener("keydown",Xt),ct=!1,Ce==null||Ce.reset(),ie&&(ie.textContent=""),xe&&(xe.textContent=""),dt==null||dt.focus())};fn.forEach(s=>{s.addEventListener("click",xn)}),gn.forEach(s=>{s.addEventListener("click",pt)}),oe==null||oe.addEventListener("click",s=>{s.target===oe&&pt()}),pe==null||pe.addEventListener("input",()=>{be&&(!ct||be.value.trim().length===0)&&(be.value=_e(pe.value))}),be==null||be.addEventListener("input",()=>{ct=!0,ie&&(ie.textContent="")});let wn=()=>new Set(Array.from(kt).map(s=>Ee(s.dataset.siteCard||"")));Ce==null||Ce.addEventListener("submit",async s=>{if(s.preventDefault(),!pe||!be)return;let i=(pe.value||"").trim(),g=be.value||"";g||(g=i);let y=bn(g);if(!i||!y){ie&&(ie.textContent="Nom et slug sont requis.");return}if(wn().has(y)){ie&&(ie.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}ie&&(ie.textContent=""),xe&&(xe.textContent=""),He&&(He.disabled=!0,He.textContent="Cr\xE9ation...");try{let v=await fetch("/api/sites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:i,slug:y})});if(!v.ok){let W=await v.json().catch(()=>({})),I=W.message||"Impossible de cr\xE9er ce site.";xe&&(xe.textContent=I),W.field==="slug"&&ie&&(ie.textContent=I);return}let q=await v.json(),F=Ee((q==null?void 0:q.slug)||y),u=(q==null?void 0:q.name)||i;ut(F,u),pt();let U=encodeURIComponent(Ae(F));window.location.href=`/admin/site/${U}/design`}catch(v){console.error("[admin] Impossible de cr\xE9er le site",v),xe&&(xe.textContent="Erreur inattendue. R\xE9essaie dans un instant.")}finally{He&&(He.disabled=!1,He.textContent="Cr\xE9er")}}),window.addEventListener("keydown",s=>{s.key==="Escape"&&(oe&&!oe.classList.contains("hidden")&&pt(),Ie&&!Ie.classList.contains("hidden")&&Qt(),blockDeleteModal&&!blockDeleteModal.classList.contains("hidden")&&closeBlockDeleteModal(),blockLibraryOpen&&closeBlockLibrary())});function Sn(){let s=window.location.pathname.match(/^\/admin\/site\/([^/]+)(?:\/([^/]+))?/);return s?{slugPart:decodeURIComponent(s[1]),slugValue:Ee(decodeURIComponent(s[1])),section:s[2]||"design"}:null}function Ln(){return document.querySelector("[data-page-list]")?"design":document.querySelector("[data-collection-list]")?"content":document.querySelector("[data-media-grid]")?"media":document.querySelector("[data-deploy-form]")?"deploy":null}function Cn(){if(!Ie){window.location.href="/admin/sites";return}Ie.classList.remove("hidden"),Ie.classList.add("flex")}function Qt(){Ie&&(Ie.classList.add("hidden"),Ie.classList.remove("flex"))}un.forEach(s=>{s.addEventListener("click",Cn)}),mn.forEach(s=>{s.addEventListener("click",Qt)}),It==null||It.addEventListener("click",()=>{window.location.href="/admin/sites"});let Ye=(J==null?void 0:J.section)||Ln();Ye==="design"&&En(),Ye==="content"&&qn(),Ye==="media"&&An(),Ye==="deploy"&&kn(),Ye==="settings"&&In(),J&&V.name&&Zt(V.name);function En(){let s=document.querySelectorAll("[data-page-list]");if(s.length===0)return;let i=document.querySelector("[data-active-page-title]"),g=document.querySelector("[data-active-page-slug]"),y=document.querySelector("[data-page-preview-tags]"),S=document.querySelector("[data-page-preview-frame]"),v=document.querySelector("[data-preview-open]"),q=document.querySelector("[data-preview-status]"),F=document.querySelector("[data-preview-highlight]"),u=document.querySelector("[data-blocks-list]"),U=document.querySelector("[data-blocks-empty]"),W=document.querySelector("[data-block-count]"),I=document.querySelector("[data-block-library-toggle]"),A=document.querySelector("[data-block-library]"),k=document.querySelectorAll("[data-block-add]"),m=document.querySelector("[data-block-delete-modal]"),D=document.querySelector("[data-block-delete-confirm]"),Y=document.querySelector("[data-block-delete-cancel]"),$=document.querySelector("[data-block-detail-empty]"),K=document.querySelector("[data-block-detail-status]"),M=document.querySelector("[data-block-editor]"),ce=document.querySelector("[data-block-editor-block-name]"),G=document.querySelector("[data-block-editor-block-type]"),N=document.querySelector("[data-block-editor-unsupported]"),h=document.querySelector("[data-block-form]"),R=h?Array.from(h.querySelectorAll("[data-editor-section]")):[],x=h==null?void 0:h.querySelector('[name="collection-grid-collection"]'),z=h==null?void 0:h.querySelector("[data-collection-selection-info]"),P=document.querySelector("[data-block-form-cancel]"),O=h==null?void 0:h.querySelector("[data-group-preview-mobile]"),l=h==null?void 0:h.querySelector("[data-group-preview-desktop]"),d={hero:{section:"hero",labelField:"title",descriptionField:"subtitle",fields:{title:"hero-title",subtitle:"hero-subtitle",ctaLabel:"hero-cta-label",ctaUrl:"hero-cta-url",image:"hero-image",align:"hero-align"}},paragraphe:{section:"paragraph",labelField:"title",descriptionField:"content",fields:{title:"paragraph-title",content:"paragraph-content",align:"paragraph-align"}},image:{section:"image",labelField:"alt",fields:{src:"image-src",alt:"image-alt",showCaption:"image-caption-toggle",caption:"image-caption"}},groupe:{section:"group",fields:{layout:"group-layout",columnsMobile:"group-columns-mobile",columnsDesktop:"group-columns-desktop"}},collectiongrid:{section:"collection",fields:{collectionId:"collection-grid-collection",limit:"collection-grid-limit"}}},E={texte:"paragraphe",paragraph:"paragraphe",paragraphs:"paragraphe",paragraphes:"paragraphe",text:"paragraphe",hero:"hero",image:"image",groupe:"groupe",group:"groupe",collection:"collectiongrid",collectiongrid:"collectiongrid","collection-grid":"collectiongrid"},Z=(e,t)=>{if(!O||!l)return;let n=a=>Array.from({length:Number(a)||1}).map(()=>'<span class="block h-2 w-full rounded-full bg-slate-300"></span>').join("");O.innerHTML=n(e),l.innerHTML=n(t)},le=async()=>{if(!o)return[];let e=await fetch(o,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les pages.");let t=await e.json().catch(()=>[]);return Array.isArray(t)?t:[]},fe=async({title:e,slug:t})=>{if(!o)throw new Error("Site inconnu.");let n=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,slug:t})});if(!n.ok){let a=await n.json().catch(()=>({}));throw new Error(a.message||"Impossible de cr\xE9er la page.")}return n.json().catch(()=>({}))},Be=async e=>{if(!(!o||!(e!=null&&e.id)))try{let t=await fetch(`${o}/${encodeURIComponent(e.id)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let a=await t.json().catch(()=>({}));throw new Error(a.message||"Impossible de sauvegarder la page.")}let n=await t.json().catch(()=>({}));if(n!=null&&n.id){let a=st(n);return ae=ae.map(f=>f.id===a.id?a:f),(C==null?void 0:C.id)===a.id&&(C=a),a}return n}catch(t){console.error("[design] Save page failed",t),j(t.message||"Sauvegarde impossible.")}},ge=async()=>{if(!o){ae=[],Se=null,C=null,jt(ae,Se),Qe(null),$==null||$.classList.remove("hidden"),M==null||M.classList.add("hidden");return}try{let e=await le();if(ae=(Array.isArray(e)?e:[]).map(t=>st(t)),ae.length===0){Se=null,C=null,jt(ae,Se),Qe(null),$==null||$.classList.remove("hidden"),M==null||M.classList.add("hidden"),S&&(S.srcdoc=Q());return}Se=Re(ae),Me(Se)}catch(e){console.error("[design] Impossible de charger les pages",e),j("Impossible de charger les pages.")}},qe=e=>(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),he=e=>{if(!e)return null;let t=qe(e.type),n=E[t]||t;return d[n]||null},we=e=>{var n,a,f;if(!h||!M)return;e&&!e.settings&&(e.settings={});let t=he(e);if(ce&&(ce.textContent=(e==null?void 0:e.label)||"Bloc"),G&&(G.textContent=(e==null?void 0:e.type)||"Bloc"),!t){h.classList.add("hidden"),N==null||N.classList.remove("hidden"),h.dataset.blockId="";return}if(N==null||N.classList.add("hidden"),h.classList.remove("hidden"),h.reset(),h.dataset.blockId=e.id,R.forEach(w=>{w.dataset.editorSection===t.section?w.classList.remove("hidden"):w.classList.add("hidden")}),t.section==="collection"){let w=e.collectionId||((n=e.settings)==null?void 0:n.collectionId)||"";wt(w)}if(Object.entries(t.fields).forEach(([w,H])=>{var ze;let _=h.querySelector(`[name="${H}"]`);if(!_)return;let se=(ze=e.settings)==null?void 0:ze[w];_.type==="checkbox"?_.checked=!!se:_.type==="number"?_.value=se!=null?se:1:(_.tagName,_.value=se!=null?se:"")}),t.section==="group"){let w=((a=h.querySelector('[name="group-columns-mobile"]'))==null?void 0:a.value)||"1",H=((f=h.querySelector('[name="group-columns-desktop"]'))==null?void 0:f.value)||"3";Z(w,H)}},Te=e=>{if(!h||!e)return{};let t={};return Object.entries(e.fields).forEach(([n,a])=>{let f=h.querySelector(`[name="${a}"]`);if(f)if(f.type==="checkbox")t[n]=f.checked;else if(f.type==="number"){let w=Number(f.value);t[n]=Number.isFinite(w)?w:0}else f.tagName==="TEXTAREA"?t[n]=f.value||"":f.type==="select-one"?t[n]=f.value:t[n]=f.value||""}),t},X=e=>{if(q){if(!e){q.classList.add("hidden");return}q.classList.remove("hidden"),q.textContent=e}},Ne=e=>e?{id:e.id,title:e.title,slug:e.slug,badges:[...e.badges||[]],blocks:(e.blocks||[]).map(t=>{var n;return{id:t.id,type:t.type,label:t.label,status:t.status,description:t.description,props:t.props||[],settings:t.settings||{},collectionId:t.collectionId||((n=t.settings)==null?void 0:n.collectionId)||""}})}:null,Q=()=>'<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#475569;background:#fff;">Pr\xE9paration de la pr\xE9visualisation\u2026</body></html>',$e=e=>{if(!S||!e)return;let t=(J==null?void 0:J.slugValue)||V.slug||"",n={page:Ne(e),site:{title:V.name||"Site",slug:t}};Rt=!1,X("Actualisation\u2026"),S.srcdoc=Q(),nt&&nt.abort();let a=new AbortController;nt=a,fetch("/api/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n),signal:a.signal}).then(f=>{if(!f.ok)throw new Error("Preview error");return f.json()}).then(f=>{a.signal.aborted||(Dt=f.html||"",S.setAttribute("title",`Pr\xE9visualisation de la page ${e.title||""}`.trim()),S.srcdoc=Dt||Q(),X("\xC0 jour"))}).catch(f=>{a.signal.aborted||(console.error("[preview] Impossible de rendre la page",f),X("Erreur preview"),S.srcdoc='<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#be123c;background:#fff;">Erreur lors du rendu de la pr\xE9visualisation.</body></html>')}).finally(()=>{nt===a&&(nt=null)})},Pe=e=>{if(e.preventDefault(),!C||!re)return;let t=Ft(),n=he(t);if(!t||!n)return;let a=Te(n);if(n.section==="collection"){if(!a.collectionId){j("S\xE9lectionnez une collection.");return}a.limit=Math.max(1,Number(a.limit)||1)}let f=(C.blocks||[]).map(w=>{if(w.id!==t.id)return w;let H={...w.settings||{},...a},_={...w,settings:H};return n.labelField&&a[n.labelField]&&(_.label=a[n.labelField]),n.descriptionField&&a[n.descriptionField]&&(_.description=a[n.descriptionField]),n.section==="collection"&&(_.collectionId=a.collectionId,_.settings.collectionId=a.collectionId,_.settings.limit=a.limit),_});et(f),j("Bloc mis \xE0 jour"),Me(C.id,{preserveBlock:!0})},ye=document.querySelector("[data-page-drawer]"),te=document.querySelector("[data-page-drawer-backdrop]"),Ue=document.querySelectorAll("[data-page-drawer-open]"),je=document.querySelectorAll("[data-page-drawer-close]"),ue=document.querySelector("[data-add-page-toggle]"),ne=document.querySelector("[data-add-page-form]"),r=document.querySelector("[data-add-page-title]"),c=document.querySelector("[data-add-page-slug]"),B=document.querySelector("[data-add-page-cancel]"),b=document.querySelector("[data-add-page-error]"),me=ne==null?void 0:ne.querySelector('[type="submit"]'),Oe=Ae((J==null?void 0:J.slugValue)||V.slug||"default")||"default",ft=(J==null?void 0:J.slugValue)||V.slug||"",De=Ae(ft)||"",o=De?`/api/sites/${encodeURIComponent(De)}/pages`:null,p=De?`/api/sites/${encodeURIComponent(De)}/collections`:null,L={active:`clower:activePage:${Oe}`},T=(e,t,n,a,f,w=[],H={})=>{let _={id:e,label:t,type:n,status:a,description:f,props:w,settings:{...H}};return _.settings.collectionId&&(_.collectionId=_.settings.collectionId),_},ee={hero:{type:"Hero",label:"Hero de page",description:"Section pleine largeur avec CTA principal.",status:"Brouillon",props:[{label:"CTA",value:"D\xE9couvrir"},{label:"Hauteur",value:"80vh"}],settings:{title:"Titre du hero",subtitle:"",ctaLabel:"D\xE9couvrir",ctaUrl:"#",image:"",align:"center"}},paragraph:{type:"Paragraphe",label:"Bloc \xE9ditorial",description:"Paragraphe libre pour raconter votre histoire.",status:"Brouillon",props:[{label:"Longueur",value:"150 mots"}],settings:{title:"Titre du paragraphe",content:"",align:"left"}},image:{type:"Image",label:"Bloc image",description:"Visuel seul avec l\xE9gende optionnelle.",status:"Brouillon",props:[{label:"Ratio",value:"16:9"},{label:"L\xE9gende",value:"Inactive"}],settings:{src:"",alt:"",showCaption:!1,caption:""}},group:{type:"Groupe",label:"Groupe de sections",description:"Conteneur pour imbriquer plusieurs sous-blocs.",status:"Brouillon",props:[{label:"Disposition",value:"Verticale"}],settings:{layout:"grid",columnsMobile:"1",columnsDesktop:"3"}},collectiongrid:{type:"CollectionGrid",label:"Grille de contenus",description:"Affiche automatiquement les items d\u2019une collection.",status:"Brouillon",settings:{collectionId:"",limit:6}}},Ke=e=>{try{window.localStorage.setItem(L.active,e)}catch{}},Re=e=>{var t;try{let n=window.localStorage.getItem(L.active);if(n&&e.some(a=>a.id===n))return n}catch{}return((t=e[0])==null?void 0:t.id)||null},Fe=e=>!e||e<=0?"0 bloc":e===1?"1 bloc":`${e} blocs`,Xe=e=>{if(!e||e==="/")return"/";let t=_e(e.replace(/^\//,""));return t?`/${t}`:"/"},Ve=(e="page",t="block")=>`${e}-${t}-${Date.now().toString(36)}-${Math.floor(Math.random()*1e3)}`,$t=(e,t)=>[T(Ve(e,"intro"),"Introduction","Paragraphe","Brouillon",`Paragraphe introductif pour "${t}".`,[{label:"Longueur",value:"2 paragraphes"}],{title:`Introduction \xE0 ${t}`,content:"Ajoutez votre premier paragraphe de pr\xE9sentation.",align:"left"}),T(Ve(e,"content"),"Zone de contenu","Groupe","Brouillon","Section principale \xE0 composer avec textes et visuels.",[{label:"Colonnes",value:"Auto"}],{layout:"grid",columnsMobile:"1",columnsDesktop:"2"})],gt=e=>{i&&(i.textContent=(e==null?void 0:e.title)||"Page"),g&&(g.textContent=(e==null?void 0:e.slug)||"/")},Bn=e=>{if(!y)return;y.innerHTML="",(e&&e.badges&&e.badges.length>0?e.badges:["Structure en cours"]).forEach(n=>{let a=document.createElement("span");a.className="rounded-full bg-slate-100 px-3 py-1",a.textContent=n,y.appendChild(a)})},Tn=e=>{switch((e||"").toLowerCase()){case"en ligne":return"bg-emerald-50 text-emerald-700";case"brouillon":return"bg-amber-50 text-amber-700";default:return"bg-slate-100 text-slate-600"}},ht=e=>{if(!(!$||!M)){if(!e){$.classList.remove("hidden"),M.classList.add("hidden"),N==null||N.classList.add("hidden"),h==null||h.classList.add("hidden"),K==null||K.classList.add("hidden");return}$.classList.add("hidden"),M.classList.remove("hidden"),K&&(e.status?(K.textContent=e.status,K.className=`rounded-full px-3 py-1 text-xs font-semibold ${Tn(e.status)}`,K.classList.remove("hidden")):K.classList.add("hidden")),we(e)}},Ze=e=>{if(!S)return;let t=S.contentDocument;if(!t)return;t.querySelectorAll("[data-preview-block]").forEach(a=>{a.dataset.previewBlock===e?(a.classList.add("preview-block-active"),Rt&&e&&a.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})):a.classList.remove("preview-block-active")}),F&&(F.style.borderColor=e?"rgba(156, 107, 255, 0.5)":"transparent")},Qe=e=>{if(!u)return;u.innerHTML="";let t=(e==null?void 0:e.blocks)||[];if(W&&(W.textContent=Fe(t.length)),t.length===0){u.classList.add("hidden"),U==null||U.classList.remove("hidden");return}u.classList.remove("hidden"),U==null||U.classList.add("hidden"),t.forEach(n=>{var rn;let a=n.id===re,f=document.createElement("div");f.dataset.blockItem="true",f.dataset.blockId=n.id,f.setAttribute("role","option"),f.setAttribute("aria-selected",a?"true":"false"),f.tabIndex=0,f.className=["relative flex items-center gap-3 rounded-2xl border px-3 py-2 text-left transition",a?"bg-slate-100 border-[#9C6BFF]/40 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let w=document.createElement("span");w.className=`absolute inset-y-2 left-0 w-1 rounded-full bg-[#9C6BFF] ${a?"":"hidden"}`,f.appendChild(w);let H=document.createElement("div");H.className="flex flex-1 items-center gap-3";let _=document.createElement("div");_.className="hidden lg:flex cursor-grab flex-shrink-0 items-center text-lg text-slate-400",_.innerHTML="&#8801;",H.appendChild(_);let se=document.createElement("div");se.className="flex-1";let ze=document.createElement("div");ze.className="flex items-center gap-2 text-[11px] uppercase tracking-wide text-slate-500";let Ht=document.createElement("span");Ht.className="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600",Ht.textContent=n.type;let Ut=document.createElement("span");Ut.className="text-slate-400",Ut.textContent=n.status,ze.appendChild(Ht),ze.appendChild(Ut);let Ot=document.createElement("p");Ot.className="mt-1 text-sm font-semibold text-slate-900";let _n=n.settings&&n.settings.title||n.label||"Bloc sans titre";if(Ot.textContent=_n,se.appendChild(ze),se.appendChild(Ot),(n.type||"").toLowerCase()==="collectiongrid"&&n.collectionId){let ve=((rn=Le.find(Yn=>Yn.id===n.collectionId))==null?void 0:rn.name)||n.collectionId,Vt=document.createElement("p");Vt.className="text-xs text-slate-400",Vt.textContent=`Collection : ${ve}`,se.appendChild(Vt)}H.appendChild(se),f.appendChild(H);let St=document.createElement("div");St.className="flex flex-col gap-1 text-xs text-slate-400";let Lt=document.createElement("div");Lt.className="flex items-center gap-1 lg:hidden";let ot=document.createElement("button");ot.type="button",ot.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",ot.textContent="\u2191",ot.addEventListener("click",ve=>{ve.stopPropagation(),en(n.id,-1)});let at=document.createElement("button");at.type="button",at.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",at.textContent="\u2193",at.addEventListener("click",ve=>{ve.stopPropagation(),en(n.id,1)}),Lt.appendChild(ot),Lt.appendChild(at),St.appendChild(Lt);let rt=document.createElement("button");rt.type="button",rt.className="inline-flex items-center justify-center rounded-lg border border-transparent px-2 py-1 text-[12px] text-rose-500 hover:text-rose-700",rt.innerHTML="\u{1F5D1}\uFE0F",rt.addEventListener("click",ve=>{ve.stopPropagation(),Nn(n.id)}),St.appendChild(rt),f.appendChild(St),f.addEventListener("click",()=>{Je(n.id)}),f.addEventListener("keydown",ve=>{(ve.key==="Enter"||ve.key===" ")&&(ve.preventDefault(),Je(n.id))}),u.appendChild(f)})},jt=(e,t)=>{s.forEach(n=>{n.innerHTML="",e.forEach(a=>{let f=document.createElement("li"),w=document.createElement("button");w.type="button",w.dataset.pageId=a.id,w.className=["w-full flex items-center justify-between gap-3 px-3 py-2 text-left transition",t===a.id?"bg-[#9C6BFF]/10 text-slate-900 border border-[#9C6BFF]/40 rounded-xl shadow-sm":"text-slate-700 hover:bg-slate-50 rounded-xl"].join(" "),t===a.id?w.setAttribute("aria-current","page"):w.removeAttribute("aria-current"),w.innerHTML=`
            <div class="flex items-center gap-3">
              <span class="flex h-9 w-9 items-center justify-center rounded-xl border border-slate-200 bg-white text-slate-500">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6.5 4.5h7l4 4v11a1 1 0 0 1-1 1h-10a1 1 0 0 1-1-1v-14a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
                  <path d="M13.5 4.5v4a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.4"/>
                </svg>
              </span>
              <div class="flex flex-col">
                <span class="text-sm font-semibold">${a.title}</span>
                <span class="text-xs text-slate-500">${a.slug}</span>
              </div>
            </div>
          `,w.addEventListener("click",()=>{Me(a.id),Nt()||Pt()}),f.appendChild(w),n.appendChild(f)})})},Ft=()=>!C||!Array.isArray(C.blocks)?null:C.blocks.find(e=>e.id===re)||null,Je=e=>{if(!C)return;if(!e){re=null,Qe(C),ht(null),Ze(null);return}let t=C.blocks.find(n=>n.id===e)||C.blocks[0]||null;re=(t==null?void 0:t.id)||null,Qe(C),ht(t),Ze(re)},et=e=>{if(!C)return;let t={...C,blocks:e};Pn(t)},yt=()=>window.matchMedia("(min-width: 1024px)").matches;function en(e,t){if(!C||!e||!t)return;let n=[...C.blocks||[]],a=n.findIndex(H=>H.id===e);if(a<0)return;let f=a+t;if(f<0||f>=n.length)return;let[w]=n.splice(a,1);n.splice(f,0,w),et(n),Me(C.id,{preserveBlock:!0}),Je(w.id)}function $n(e,t){if(!C||!e||!t||e===t)return;let n=[...C.blocks||[]],a=n.findIndex(H=>H.id===e),f=n.findIndex(H=>H.id===t);if(a<0||f<0)return;let[w]=n.splice(a,1);n.splice(f,0,w),et(n),Me(C.id,{preserveBlock:!0}),Je(w.id)}function tn(){if(!u)return;let e=yt();u.querySelectorAll("[data-block-item]").forEach(t=>{t.setAttribute("draggable",e?"true":"false")})}function vt(){A&&(A.classList.add("hidden"),tt=!1)}function jn(){A&&(A.classList.remove("hidden"),tt=!0)}function Fn(){tt?vt():jn()}function Mn(e){var w;if(!C||!e)return;let t=ee[e];if(!t)return;let n=(C.blocks||[]).filter(H=>H.type===t.type).length+1,a=T(Ve(C.id,e),`${t.label} ${n}`,t.type,t.status,t.description,t.props,t.settings||{});if((t.type||"").toLowerCase()==="collectiongrid"){let H=((w=Le[0])==null?void 0:w.id)||"";a.collectionId=H,a.settings.collectionId=H,a.settings.limit=a.settings.limit||6}let f=[...C.blocks||[],a];et(f),Me(C.id,{preserveBlock:!0}),Je(a.id),vt(),j("Bloc ajout\xE9")}function nn(e){var a,f;if(!C)return;let t=(C.blocks||[]).filter(w=>w.id!==e),n=e===re?((a=t[0])==null?void 0:a.id)||null:re||((f=t[0])==null?void 0:f.id)||null;et(t),re=n,Me(C.id,{preserveBlock:!0}),re?Je(re):(ht(null),Ze(null)),j("Bloc supprim\xE9")}function Mt(){m&&(m.classList.add("hidden"),m.classList.remove("flex"),xt=null)}function Nn(e){if(!m){nn(e);return}xt=e,m.classList.remove("hidden"),m.classList.add("flex")}let Pn=e=>{if(!e)return;let t=st(e);ae=ae.map(n=>n.id===t.id?t:n),C=t,Be(t)},Me=(e,t={})=>{var f,w;let n=ae.find(H=>H.id===e)||ae[0]||null;C=n?st(n):null,Se=(n==null?void 0:n.id)||null,(!t.preserveBlock||!C||!C.blocks.some(H=>H.id===re))&&(re=((w=(f=C==null?void 0:C.blocks)==null?void 0:f[0])==null?void 0:w.id)||null),Se&&Ke(Se),jt(ae,Se),gt(C),Bn(C),$e(C),Qe(C),ht(Ft()),Ze(re),tn(),tt&&vt()},Nt=()=>window.matchMedia("(min-width: 1024px)").matches,sn=()=>{ye&&(Nt()?(ye.classList.add("is-open"),te==null||te.classList.add("hidden"),document.body.classList.remove("overflow-hidden")):ye.classList.remove("is-open"))},Dn=()=>{!ye||Nt()||(ye.classList.add("is-open"),te==null||te.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},Pt=()=>{ye&&(ye.classList.remove("is-open"),te==null||te.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))},Rn=()=>{!ne||!ue||(ne.classList.remove("hidden"),ue.classList.add("hidden"),b&&(b.textContent=""),bt=!1,r&&(r.value="",r.focus()),c&&(c.value=""))},on=()=>{!ne||!ue||(ne.classList.add("hidden"),ue.classList.remove("hidden"),b&&(b.textContent=""),bt=!1,ne.reset())},zn=()=>{!r||!c||bt&&c.value.trim().length>0||(c.value=Xe(r.value))},ae=[],Se=null,bt=!1,C=null,re=null,tt=!1,xt=null,Dt="",Rt=!1,nt=null,Le=[],Hn=e=>{let t={...e,props:Array.isArray(e.props)?e.props:[],settings:{...e.settings||{}}};return(t.type||"").toLowerCase()==="collectiongrid"&&(t.collectionId=t.collectionId||t.settings.collectionId||"",t.settings.collectionId=t.collectionId,t.settings.limit=t.settings.limit||6),t},st=e=>({...e,blocks:(e.blocks||[]).map(t=>Hn(t))}),Un=async()=>{if(!p){Le=[],wt();return}try{let e=await fetch(p,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les collections.");let t=await e.json().catch(()=>[]);Le=Array.isArray(t)?t:[];let n=(x==null?void 0:x.value)||"";wt(n)}catch(e){console.error("[design] collections load",e),j("Collections indisponibles."),Le=[],wt()}},zt=e=>{if(!z)return;if(!e){z.textContent=Le.length?"S\xE9lectionnez une collection pour afficher ses informations.":"Aucune collection disponible. Ajoutez-en depuis l\u2019onglet Contenus.";return}let t=Le.find(a=>a.id===e);if(!t){z.textContent=`Collection ${e}`;return}let n=[];t.description&&n.push(t.description),t.type&&n.push(`Type\xA0: ${t.type}`),z.textContent=n.join(" \xB7 ")||`Collection ${t.name||t.id}`},wt=(e="")=>{if(x){if(x.innerHTML="",!Le.length){x.disabled=!0;let t=document.createElement("option");t.value="",t.textContent="Aucune collection disponible",x.appendChild(t),zt("");return}if(x.disabled=!1,e&&!Le.some(t=>t.id===e)){let t=document.createElement("option");t.value=e,t.textContent=e,x.appendChild(t)}Le.forEach(t=>{let n=document.createElement("option");n.value=t.id;let a=t.name||t.id;n.textContent=t.type?`${a} \xB7 ${t.type}`:a,n.dataset.description=t.description||"",x.appendChild(n)}),e&&(x.value=e),zt(x.value||"")}};Un(),sn(),Ue.forEach(e=>{e.addEventListener("click",Dn)}),je.forEach(e=>{e.addEventListener("click",Pt)}),te==null||te.addEventListener("click",Pt),window.addEventListener("resize",()=>{sn(),tn()}),ue==null||ue.addEventListener("click",Rn),B==null||B.addEventListener("click",on),r==null||r.addEventListener("input",zn),c==null||c.addEventListener("input",()=>{b&&(b.textContent=""),bt=!0}),ne==null||ne.addEventListener("submit",async e=>{if(e.preventDefault(),!o){b&&(b.textContent="Aucun site s\xE9lectionn\xE9.");return}if(!r||!c)return;let t=r.value.trim(),n=Xe(c.value.trim()||t);if(!t||!n){b&&(b.textContent="Titre et slug sont requis.");return}b&&(b.textContent=""),me&&(me.disabled=!0,me.textContent="Cr\xE9ation...");try{let a=await fe({title:t,slug:n});if(!a||!a.id)throw new Error("R\xE9ponse invalide.");ae=[...ae,st(a)],on(),j("Page cr\xE9\xE9e"),Me(a.id)}catch(a){console.error("[design] create page failed",a),b&&(b.textContent=a.message||"Impossible de cr\xE9er la page.")}finally{me&&(me.disabled=!1,me.textContent="Cr\xE9er")}}),I==null||I.addEventListener("click",e=>{e.stopPropagation(),Fn()}),document.addEventListener("click",e=>{tt&&(A!=null&&A.contains(e.target)||I!=null&&I.contains(e.target)||vt())}),k.forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();let n=e.dataset.blockAdd;Mn(n)})}),Y==null||Y.addEventListener("click",()=>{Mt()}),D==null||D.addEventListener("click",()=>{xt&&nn(xt),Mt()}),m==null||m.addEventListener("click",e=>{e.target===m&&Mt()}),h==null||h.addEventListener("input",e=>{var n,a;let t=e.target;if(!(!t||!t.name)&&(t.name==="group-columns-mobile"||t.name==="group-columns-desktop")){let f=((n=h.querySelector('[name="group-columns-mobile"]'))==null?void 0:n.value)||"1",w=((a=h.querySelector('[name="group-columns-desktop"]'))==null?void 0:a.value)||"3";Z(f,w)}}),x==null||x.addEventListener("change",e=>{let t=e.target;zt((t==null?void 0:t.value)||"")}),h==null||h.addEventListener("submit",Pe),P==null||P.addEventListener("click",e=>{e.preventDefault();let t=Ft();t&&we(t)}),S==null||S.addEventListener("load",()=>{Rt=!0,X("\xC0 jour"),Ze(re)}),v==null||v.addEventListener("click",()=>{let e=window.open("","_blank");if(!e)return;e.opener=null;let t=e.document;t.open(),t.write(Dt||Q()),t.close()});let On=e=>{let t=e.target.closest("[data-block-item]");!t||!yt()||(ke=t.dataset.blockId||null,ke&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",ke),t.classList.add("opacity-50")))},an=()=>{u==null||u.querySelectorAll("[data-block-item]").forEach(e=>e.classList.remove("opacity-50","ring-2","ring-[#9C6BFF]/50"))},Vn=()=>{ke=null,an()},Jn=e=>{if(!ke||!yt())return;let t=e.target.closest("[data-block-item]");!t||t.dataset.blockId===ke||(e.preventDefault(),t.classList.add("ring-2","ring-[#9C6BFF]/50"))},Wn=e=>{let t=e.target.closest("[data-block-item]");t&&t.classList.remove("ring-2","ring-[#9C6BFF]/50")},Gn=e=>{if(!ke||!yt())return;e.preventDefault();let t=e.target.closest("[data-block-item]"),n=ke;ke=null,an();let a=(t==null?void 0:t.dataset.blockId)||null;a&&$n(n,a)},ke=null;u==null||u.addEventListener("dragstart",On),u==null||u.addEventListener("dragend",Vn),u==null||u.addEventListener("dragover",Jn),u==null||u.addEventListener("dragleave",Wn),u==null||u.addEventListener("drop",Gn),ge()}function qn(){var Oe,ft,De;let s=document.querySelector("[data-collection-list]");if(!s)return;let i=document.querySelector("[data-collection-empty]"),g=document.querySelector("[data-collection-items-empty]"),y=document.querySelector("[data-item-table-wrapper]"),S=document.querySelector("[data-item-table-body]"),v=document.querySelector("[data-collection-title]"),q=document.querySelector("[data-collection-description]"),F=document.querySelector("[data-collection-drawer]"),u=document.querySelector("[data-collection-drawer-backdrop]"),U=document.querySelectorAll("[data-collection-drawer-open]"),W=document.querySelectorAll("[data-collection-drawer-close]"),I=document.querySelector("[data-item-add]"),A=document.querySelector("[data-item-detail-empty]"),k=document.querySelector("[data-item-form]"),m=k?{title:k.querySelector('[name="item-title"]'),slug:k.querySelector('[name="item-slug"]'),excerpt:k.querySelector('[name="item-excerpt"]'),content:k.querySelector('[name="item-content"]'),image:k.querySelector('[name="item-image"]'),status:k.querySelector('[name="item-status"]')}:{},D=document.querySelector("[data-item-status-badge]"),Y=document.querySelector("[data-item-delete]"),$=document.querySelector("[data-item-delete-modal]"),K=document.querySelector("[data-item-delete-cancel]"),M=document.querySelector("[data-item-delete-confirm]"),ce=document.querySelector("[data-item-cancel]"),G=document.querySelector("[data-item-save]"),N="rounded-full px-3 py-1 text-xs font-semibold",h=Ae((J==null?void 0:J.slugValue)||V.slug||""),R=h?`/api/sites/${encodeURIComponent(h)}/collections`:null,x=[],z=[],P=null,O=null,l=!1,d=!1,E=null,Z=()=>{F&&(F.classList.add("is-open"),F.style.transform="translateX(0)",u==null||u.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},le=()=>{F&&(F.classList.remove("is-open"),F.style.transform="",u==null||u.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))};U.forEach(o=>{o.addEventListener("click",Z)}),W.forEach(o=>{o.addEventListener("click",le)}),u==null||u.addEventListener("click",le);let fe=o=>{let p=(o||"").trim();if(!p)return"";if(p==="/")return"/";let T=p.replace(/^\//,"").split("/").map(ee=>_e(ee||"")).filter(ee=>ee.length>0);return T.length?`/${T.join("/")}`:""},Be=o=>{if(!o)return"\u2014";let p=new Date(o);return Number.isNaN(p.getTime())?"\u2014":p.toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"})},ge=()=>{let o=x.find(p=>p.id===P);v&&(v.textContent=(o==null?void 0:o.name)||"S\xE9lectionnez une collection"),q&&(q.textContent=(o==null?void 0:o.description)||"")},qe=o=>{g&&(g.textContent=o||(P?"Aucun item dans cette collection pour le moment.":"Choisissez une collection dans le panneau de gauche."))},he=()=>{k&&(k.classList.add("hidden"),k.dataset.itemId=""),A==null||A.classList.remove("hidden"),D&&(D.className=`hidden ${N}`,D.textContent=""),Y&&(Y.disabled=!0)},we=()=>{k&&(k.classList.remove("hidden"),A==null||A.classList.add("hidden"))},Te=()=>{I&&(I.disabled=!P,I.disabled?I.classList.add("opacity-60","pointer-events-none"):I.classList.remove("opacity-60","pointer-events-none"))},X=o=>{if(!D)return;if(!o){D.className=`hidden ${N}`,D.textContent="";return}let p=o.toLowerCase(),L="bg-slate-100 text-slate-600 border border-slate-200";p==="publi\xE9"||p==="publie"?L="bg-emerald-50 text-emerald-700 border border-emerald-100":p==="brouillon"&&(L="bg-amber-50 text-amber-700 border border-amber-100"),D.className=`${N} ${L}`,D.textContent=o},Ne=()=>{if(s.innerHTML="",!x.length){i==null||i.classList.remove("hidden");return}i==null||i.classList.add("hidden"),x.forEach(o=>{let p=o.id===P,L=document.createElement("button");L.type="button",L.dataset.collectionId=o.id,L.className=["w-full rounded-xl border px-3 py-2 text-left transition focus:outline-none focus:ring-2 focus:ring-[#9C6BFF]/40",p?"bg-[#F7F0FF] border-[#9C6BFF]/40 text-slate-900":"border-slate-200 text-slate-700 hover:border-[#9C6BFF]/40"].join(" "),L.setAttribute("role","option"),p?L.setAttribute("aria-current","true"):L.removeAttribute("aria-current"),L.innerHTML=`
          <div class="flex items-center justify-between gap-2">
            <div>
              <p class="text-sm font-semibold">${o.name||o.id}</p>
              <p class="text-xs text-slate-500">${o.description||""}</p>
            </div>
            <span class="text-[11px] uppercase tracking-wide text-slate-400">${o.type||""}</span>
          </div>
        `,L.addEventListener("click",()=>{ue(o.id),window.matchMedia("(min-width: 1024px)").matches||le()}),s.appendChild(L)})},Q=()=>{if(S){if(S.innerHTML="",!z.length||!P){g==null||g.classList.remove("hidden"),qe(),y==null||y.classList.add("hidden");return}g==null||g.classList.add("hidden"),y==null||y.classList.remove("hidden"),z.forEach(o=>{let p=document.createElement("tr");p.dataset.itemId=o.id;let L=o.id===O&&!l;p.className=["cursor-pointer transition focus-within:bg-[#F7F0FF]/70 focus:outline-none",L?"bg-[#F7F0FF]/70":"hover:bg-slate-50"].join(" "),p.tabIndex=0,p.setAttribute("role","button"),L?p.setAttribute("aria-current","true"):p.removeAttribute("aria-current");let T=o.status||"Brouillon",ee=T.toLowerCase(),Ke=ee==="publi\xE9"||ee==="publie"?"bg-emerald-50 text-emerald-700 border border-emerald-100":"bg-amber-50 text-amber-700 border border-amber-100";p.innerHTML=`
          <td class="px-4 py-3 align-top">
            <div class="flex flex-col">
              <span class="text-sm font-semibold text-slate-900">${o.title||"Sans titre"}</span>
              <span class="text-xs text-slate-500">${o.summary||o.excerpt||""}</span>
            </div>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-600">${o.slug||""}</td>
          <td class="px-4 py-3 align-top">
            <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${Ke}">
              ${T}
            </span>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-500">${Be(o.updatedAt||o.createdAt)}</td>
        `;let Re=()=>{$e(o.id)};p.addEventListener("click",Re),p.addEventListener("keydown",Fe=>{(Fe.key==="Enter"||Fe.key===" ")&&(Fe.preventDefault(),Re())}),S.appendChild(p)})}},$e=o=>{let p=z.find(L=>L.id===o);p&&(O=p.id,l=!1,d=!0,Pe(p),Q())},Pe=o=>{if(!k||!o){he();return}we(),k.dataset.itemId=o.id,m.title&&(m.title.value=o.title||""),m.slug&&(m.slug.value=o.slug||""),m.excerpt&&(m.excerpt.value=o.summary||o.excerpt||""),m.content&&(m.content.value=o.content||""),m.image&&(m.image.value=o.image||""),m.status&&(m.status.value=o.status||"Brouillon"),X(o.status||"Brouillon"),Y&&(Y.disabled=!1)},ye=()=>{var o;k&&(l=!0,O=null,d=!1,k.dataset.itemId="",k.reset(),m.status&&(m.status.value="Brouillon"),m.slug&&(m.slug.value=""),X("Brouillon"),we(),Y&&(Y.disabled=!0),(o=m.title)==null||o.focus())},te=()=>{var Re,Fe,Xe,Ve,$t,gt;let o=(((Re=m.title)==null?void 0:Re.value)||"").trim(),p=(((Fe=m.slug)==null?void 0:Fe.value)||"").trim(),L=(((Xe=m.excerpt)==null?void 0:Xe.value)||"").trim(),T=(((Ve=m.content)==null?void 0:Ve.value)||"").trim(),ee=((($t=m.image)==null?void 0:$t.value)||"").trim(),Ke=((gt=m.status)==null?void 0:gt.value)||"Brouillon";return{title:o,slug:fe(p||o),summary:L,excerpt:L,content:T,image:ee,status:Ke}},Ue=o=>{G&&(G.disabled=o,G.textContent=o?"Enregistrement\u2026":"Enregistrer"),Y&&!l&&O&&(Y.disabled=o)},je=async o=>{if(!R)return[];let p=await fetch(`${R}/${encodeURIComponent(o)}/items`,{headers:{Accept:"application/json"}});if(!p.ok){let T=await p.json().catch(()=>({}));throw new Error(T.message||"Impossible de charger les items.")}let L=await p.json().catch(()=>({}));return Array.isArray(L.items)?L.items:[]},ue=async o=>{if(o&&(P=o,O=null,l=!1,d=!1,ge(),Te(),Ne(),he(),z=[],Q(),qe("Chargement des items\u2026"),g==null||g.classList.remove("hidden"),y==null||y.classList.add("hidden"),!!R))try{z=await je(o),Q(),z.length||qe()}catch(p){console.error("[content] items failed",p),j(p.message||"Impossible de charger les items."),z=[],Q()}},ne=async(o,p)=>{if(!R)throw new Error("Site inconnu.");let L=await fetch(`${R}/${encodeURIComponent(o)}/items`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});if(!L.ok){let T=await L.json().catch(()=>({}));throw new Error(T.message||"Impossible de cr\xE9er cet item.")}return L.json()},r=async(o,p,L)=>{if(!R)throw new Error("Site inconnu.");let T=await fetch(`${R}/${encodeURIComponent(o)}/items/${encodeURIComponent(p)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(L)});if(!T.ok){let ee=await T.json().catch(()=>({}));throw new Error(ee.message||"Impossible de sauvegarder cet item.")}return T.json()},c=async(o,p)=>{if(!R)throw new Error("Site inconnu.");let L=await fetch(`${R}/${encodeURIComponent(o)}/items/${encodeURIComponent(p)}`,{method:"DELETE"});if(!L.ok){let T=await L.json().catch(()=>({}));throw new Error(T.message||"Impossible de supprimer cet item.")}},B=async()=>{var o;if(!R){i==null||i.classList.remove("hidden"),P=null,z=[],Q(),ge(),Te();return}try{let p=await fetch(R,{headers:{Accept:"application/json"}});if(!p.ok)throw new Error("Impossible de charger les collections.");let L=await p.json().catch(()=>[]);if(x=Array.isArray(L)?L:[],Ne(),x.length>0){let T=((o=x.find(ee=>ee.id===P))==null?void 0:o.id)||x[0].id;ue(T)}else P=null,z=[],ge(),Te(),Q()}catch(p){console.error("[content] load collections",p),j(p.message||"Impossible de charger les collections.")}};I==null||I.addEventListener("click",()=>{if(!P){j("S\xE9lectionnez d\u2019abord une collection.");return}ye(),Q()}),ce==null||ce.addEventListener("click",o=>{if(o.preventDefault(),l){l=!1,O=null,he(),Q();return}if(O){let p=z.find(L=>L.id===O);Pe(p)}else he()}),(Oe=m.status)==null||Oe.addEventListener("change",()=>{X(m.status.value)}),(ft=m.title)==null||ft.addEventListener("input",()=>{!l||!m.slug||d||(m.slug.value=fe(m.title.value))}),(De=m.slug)==null||De.addEventListener("input",()=>{l&&(d=!0)}),k==null||k.addEventListener("submit",async o=>{var L;if(o.preventDefault(),!P){j("S\xE9lectionnez une collection.");return}let p=te();if(!p.title){j("Le titre est requis."),(L=m.title)==null||L.focus();return}Ue(!0);try{let T;l||!O?(T=await ne(P,p),z=[...z,T],j("Item cr\xE9\xE9")):(T=await r(P,O,p),z=z.map(ee=>ee.id===T.id?T:ee),j("Item mis \xE0 jour")),l=!1,O=T.id,Pe(T),Q()}catch(T){console.error("[content] save item failed",T),j(T.message||"Impossible de sauvegarder cet item.")}finally{Ue(!1)}});let b=()=>{$&&($.classList.add("hidden"),$.classList.remove("flex"),E=null)},me=()=>{!$||!O||(E=O,$.classList.remove("hidden"),$.classList.add("flex"))};Y==null||Y.addEventListener("click",o=>{o.preventDefault(),O&&me()}),K==null||K.addEventListener("click",()=>{b()}),$==null||$.addEventListener("click",o=>{o.target===$&&b()}),M==null||M.addEventListener("click",async()=>{if(!E||!P){b();return}M.disabled=!0,M.textContent="Suppression\u2026";try{await c(P,E),z=z.filter(o=>o.id!==E),O===E&&(O=null,he()),j("Item supprim\xE9"),Q()}catch(o){console.error("[content] delete item failed",o),j(o.message||"Impossible de supprimer cet item.")}finally{M.disabled=!1,M.textContent="Supprimer",b()}}),ge(),Te(),B()}function kn(){let s=document.querySelector("[data-deploy-form]");if(!s)return;let i=document.querySelector("[data-deploy-protocol]"),g=document.querySelector("[data-deploy-host]"),y=document.querySelector("[data-deploy-port]"),S=document.querySelector("[data-deploy-user]"),v=document.querySelector("[data-deploy-password]"),q=document.querySelector("[data-deploy-show-password]"),F=document.querySelector("[data-deploy-remote-path]"),u=document.querySelector("[data-deploy-feedback]"),U=document.querySelector("[data-deploy-save]"),W=document.querySelector("[data-deploy-test]"),I=document.querySelector("[data-deploy-trigger]"),A=document.querySelector("[data-deploy-history]"),k=document.querySelector("[data-deploy-log]"),m=Ae((J==null?void 0:J.slugValue)||V.slug||""),D=m?`/api/sites/${encodeURIComponent(m)}/deploy-config`:null,Y=m?`/api/sites/${encodeURIComponent(m)}/deploy`:null,$=m?`/api/sites/${encodeURIComponent(m)}/deploy-log`:null,K=!1,M=null,ce=l=>{let d=(l||"").trim();return d?d.startsWith("/")?d:`/${d}`:"/www"},G=(l,d="muted")=>{if(!u)return;let E="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold",Z=d==="success"?"bg-emerald-50 text-emerald-700 border border-emerald-100":d==="error"?"bg-rose-50 text-rose-700 border border-rose-100":"bg-slate-50 text-slate-600 border border-slate-100";if(!l){u.textContent="",u.className="text-sm text-slate-500";return}let le=d==="success"?"\u2705":d==="error"?"\u274C":"\u2139\uFE0F";u.innerHTML=`<span class="${E} ${Z}">${le}<span>${l}</span></span>`,u.className="text-sm"},N=(l=null)=>{M=l;let d=!!l,E='<svg class="h-4 w-4 animate-spin text-white" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>';U&&(U.disabled=d,U.innerHTML=l==="save"?`<span class="inline-flex items-center gap-2">${E}<span>Enregistrement\u2026</span></span>`:"Enregistrer"),W&&(W.disabled=d,W.innerHTML=l==="test"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-slate-200 border-t-slate-600"></span><span>Test en cours\u2026</span></span>':"Tester la connexion"),I&&(I.disabled=d&&l!==null,I.innerHTML=l==="deploy"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-white/60 border-t-white"></span><span>D\xE9ploiement\u2026</span></span>':"D\xE9ployer maintenant")},h=l=>{i&&(i.value=l.protocol||"sftp"),g&&(g.value=l.host||""),y&&(y.value=l.port||""),S&&(S.value=l.user||""),F&&(F.value=l.remotePath||"/www"),K=!!l.hasPassword,v&&(v.value="",v.placeholder=K?"Non affich\xE9":"Mot de passe")},R=(l=[])=>{if(A){if(A.innerHTML="",!l.length){let d=document.createElement("li");d.className="text-slate-500",d.textContent="Aucun d\xE9ploiement pour le moment.",A.appendChild(d);return}l.forEach(d=>{let E=document.createElement("li");E.className="flex items-center justify-between gap-2 rounded-xl border border-slate-200 px-3 py-2";let Z=d.status==="success"?'<span class="rounded-full bg-emerald-50 px-2 py-0.5 text-[11px] font-semibold text-emerald-700">Succ\xE8s</span>':'<span class="rounded-full bg-rose-50 px-2 py-0.5 text-[11px] font-semibold text-rose-700">\xC9chec</span>',le=d.finishedAt||d.startedAt||"",fe=d.durationMs&&Number(d.durationMs)>=0?`${Math.round(Number(d.durationMs)/1e3)}s`:"";E.innerHTML=`
          <div class="space-y-1">
            <div class="flex items-center gap-2">${Z}<span class="text-xs text-slate-500">${le}</span></div>
            <p class="text-sm text-slate-800">${d.message||""}</p>
          </div>
          <div class="text-xs text-slate-500">${fe}</div>
        `,E.dataset.deployId=d.id||"",E.addEventListener("click",()=>{d.logs&&k&&(k.textContent=d.logs.join(`
`))}),A.appendChild(E)})}},x=(l=[])=>{k&&(k.textContent=l.length?l.join(`
`):"Aucun log pour le moment.")},z=async()=>{var l;if($)try{let d=await fetch($,{headers:{Accept:"application/json"}});if(!d.ok){if(d.status===404){R([]),x(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw new Error("Impossible de charger l\u2019historique.")}let E=await d.json().catch(()=>({})),Z=Array.isArray(E.entries)?E.entries:[];R(Z),(l=Z[0])!=null&&l.logs&&x(Z[0].logs)}catch(d){console.error("[deploy] history failed",d)}},P=async()=>{if(!D){G("Aucun site actif s\xE9lectionn\xE9.","error");return}N("load");try{let l=await fetch(D,{headers:{Accept:"application/json"}}),d=await l.json().catch(()=>({}));l.ok?(h(d||{}),G("Configuration charg\xE9e.","muted")):(h(d||{}),G(d.message||"Configuration par d\xE9faut charg\xE9e.","muted"))}catch(l){console.error("[deploy] load failed",l),G(l.message||"Erreur lors du chargement.","error")}finally{N(null)}},O=()=>{let l={protocol:(i==null?void 0:i.value)||"sftp",host:(g==null?void 0:g.value.trim())||"",port:Number(y==null?void 0:y.value)||void 0,user:(S==null?void 0:S.value.trim())||"",remotePath:ce((F==null?void 0:F.value)||"/www")},d=(v==null?void 0:v.value)||"";return d.trim().length>0&&(l.password=d),l};s.addEventListener("submit",async l=>{if(l.preventDefault(),!D){G("Aucun site actif s\xE9lectionn\xE9.","error");return}let d=O();N("save");try{let E=await fetch(D,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(!E.ok){let le=await E.json().catch(()=>({}));throw new Error(le.message||"Sauvegarde impossible.")}let Z=await E.json();h(Z||{}),G("Configuration enregistr\xE9e.","success"),j("Configuration d\xE9ploiement sauvegard\xE9e")}catch(E){console.error("[deploy] save failed",E),G(E.message||"Erreur lors de la sauvegarde.","error")}finally{N(null)}}),W==null||W.addEventListener("click",async()=>{if(!D){G("Aucun site actif s\xE9lectionn\xE9.","error");return}let l=O();if(!l.host||!l.user||!l.remotePath){G("Remplissez les champs requis avant de tester.","error");return}N("test");try{let d=await fetch(`${D}/test`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}),E=await d.json().catch(()=>({}));if(!d.ok||E.success===!1){G(E.message||"Test de connexion \xE9chou\xE9.","error");return}G(E.message||"Connexion OK.","success"),j("Test de connexion r\xE9ussi")}catch(d){console.error("[deploy] test failed",d),G(d.message||"Test de connexion \xE9chou\xE9.","error")}finally{N(null)}}),I==null||I.addEventListener("click",async()=>{if(!Y){G("Aucun site actif s\xE9lectionn\xE9.","error");return}N("deploy"),x(["D\xE9ploiement en cours\u2026"]);try{let l=await fetch(Y,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(O())}),d=await l.json().catch(()=>({}));if(!l.ok){if(l.status===404){G("API d\xE9ploiement indisponible (red\xE9marre le serveur).","error"),x(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw x(d.logs||[]),new Error(d.message||"D\xE9ploiement \xE9chou\xE9.")}x(d.logs||[]),await z(),j("D\xE9ploiement termin\xE9")}catch(l){console.error("[deploy] run failed",l),G(l.message||"D\xE9ploiement \xE9chou\xE9.","error")}finally{N(null)}}),q==null||q.addEventListener("change",()=>{v&&(v.type=q.checked?"text":"password")}),P(),z()}function In(){let s=document.querySelector("[data-admin-password-form]");if(!s)return;let i=s.querySelector("[data-admin-password-feedback]"),g=s.querySelector("[data-admin-password-submit]"),y=(S,v="muted")=>{if(!i)return;let q=v==="success"?"text-emerald-600":v==="error"?"text-rose-600":"text-slate-500";i.textContent=S||"",i.className=`text-sm ${q}`};s.addEventListener("submit",async S=>{S.preventDefault();let v=new FormData(s),q=v.get("currentPassword")||"",F=v.get("newPassword")||"",u=v.get("confirmPassword")||"";if(!q||!F||!u){y("Compl\xE8te tous les champs.","error");return}g&&(g.disabled=!0),y("");try{let U=await fetch("/api/admin/password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({currentPassword:q,newPassword:F,confirmPassword:u})}),W=await U.json().catch(()=>({}));if(!U.ok||W.success===!1)throw new Error(W.message||"Impossible de mettre \xE0 jour le mot de passe.");y(W.message||"Mot de passe mis \xE0 jour.","success"),s.reset()}catch(U){console.error("[settings] change password failed",U),y(U.message||"Erreur lors de la mise \xE0 jour.","error")}finally{g&&(g.disabled=!1)}})}function An(){let s=document.querySelector("[data-media-grid]");if(!s)return;let i=document.querySelector("[data-media-empty]"),g=document.querySelector("[data-media-count]"),y=document.querySelector("[data-media-filter-type]"),S=document.querySelector("[data-media-detail-empty]"),v=document.querySelector("[data-media-detail]"),q=document.querySelector("[data-media-detail-preview]"),F=document.querySelector("[data-media-detail-name]"),u=document.querySelector("[data-media-detail-type]"),U=document.querySelector("[data-media-detail-size]"),W=document.querySelector("[data-media-detail-path]"),I=document.querySelector("[data-media-detail-used]"),A=document.querySelector("[data-media-alt-edit]"),k=document.querySelector("[data-media-save]"),m=document.querySelector("[data-media-delete]"),D=document.querySelector("[data-media-delete-modal]"),Y=document.querySelector("[data-media-delete-cancel]"),$=document.querySelector("[data-media-delete-confirm]"),K=document.querySelector("[data-media-upload-open]"),M=document.querySelector("[data-media-file-input]"),ce=document.querySelector("[data-media-upload-status]"),G=Ae((J==null?void 0:J.slugValue)||V.slug||""),N=G?`/api/sites/${encodeURIComponent(G)}/media`:null,h=[],R=[],x=null,z=null,P=null,O=!1,l=!1,d=!1,E=null,Z=r=>{let c=(r.type||"").toLowerCase(),B=(r.filename||"").toLowerCase();return c.includes("image")||/\.(png|jpe?g|webp|svg|gif)$/i.test(B)?"image":c.includes("pdf")||c.includes("doc")||/\.(pdf|docx?)$/i.test(B)?"document":c.includes("video")||/\.(mp4|mov|webm)$/i.test(B)?"video":"other"},le=r=>Z(r)==="image",fe=r=>{if(r.type)return r.type.toUpperCase();let c=(r.filename||"").split(".").pop();return c?c.toUpperCase():"FILE"},Be=r=>!r||r<=0?"\u2014":r<1024?`${r} o`:r<1024*1024?`${(r/1024).toFixed(1)} ko`:`${(r/(1024*1024)).toFixed(1)} Mo`,ge=()=>{v==null||v.classList.add("hidden"),S==null||S.classList.remove("hidden"),qe(),x=null,l=!1,X(!1),q&&(q.innerHTML='<span class="text-slate-400 text-sm">Aucun m\xE9dia s\xE9lectionn\xE9</span>'),F&&(F.textContent=""),u&&(u.textContent=""),U&&(U.textContent=""),A&&(A.value=""),W&&(W.textContent=""),I&&(I.innerHTML="")},qe=()=>{P=null,d=!1,O=!1,E&&(URL.revokeObjectURL(E),E=null),ce&&(ce.textContent="Aucun fichier s\xE9lectionn\xE9."),M&&(M.value="")},he=()=>{g&&(R.length?R.length===1?g.textContent="1 m\xE9dia":g.textContent=`${R.length} m\xE9dias`:g.textContent="0 m\xE9dia")},we=()=>{if(s.innerHTML="",!R.length){i==null||i.classList.remove("hidden"),ge();return}i==null||i.classList.add("hidden"),R.forEach(r=>{let c=document.createElement("button");c.type="button",c.dataset.mediaId=r.id;let B=r.id===x;c.className=["group relative flex flex-col rounded-2xl border px-3 py-3 text-left transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#9C6BFF]",B?"border-[#9C6BFF] bg-[#F7F0FF]/60 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let b=le(r)?`<img src="${r.path}" alt="${r.alt||r.filename}" class="h-full w-full object-cover" />`:'<div class="flex h-full w-full items-center justify-center text-3xl text-slate-400">\u{1F4C4}</div>';c.innerHTML=`
          <div class="relative aspect-[4/3] overflow-hidden rounded-xl bg-slate-100">
            ${b}
          </div>
          <div class="mt-2 space-y-1">
            <p class="text-sm font-semibold text-slate-900 truncate">${r.filename}</p>
            <p class="text-xs text-slate-500">
              ${fe(r)} \xB7 ${Be(r.size)}
            </p>
          </div>
        `,r.id===z&&(c.classList.add("ring-2","ring-[#9C6BFF]"),window.setTimeout(()=>{c.classList.remove("ring-2","ring-[#9C6BFF]")},1600)),c.addEventListener("click",()=>Ne(r.id)),s.appendChild(c)}),z=null},Te=r=>{if(I){if(I.innerHTML="",!r.usedIn||r.usedIn.length===0){let c=document.createElement("li");c.textContent="Non utilis\xE9",c.className="text-xs text-slate-400",I.appendChild(c);return}r.usedIn.forEach(c=>{let B=document.createElement("li");B.textContent=c,B.className="text-xs text-slate-600",I.appendChild(B)})}},X=r=>{if(k){if(d){k.textContent=r?"T\xE9l\xE9versement\u2026":"T\xE9l\xE9verser",k.disabled=r||!P,m&&m.classList.add("hidden");return}k.textContent=r?"Enregistrement\u2026":"Enregistrer",k.disabled=r||!l,m&&(m.classList.remove("hidden"),m.disabled=!x)}},Ne=r=>{let c=h.find(B=>B.id===r);if(!c){ge(),we();return}qe(),x=c.id,l=!1,X(!1),we(),S==null||S.classList.add("hidden"),v==null||v.classList.remove("hidden"),q&&(le(c)?q.innerHTML=`<img src="${c.path}" alt="${c.alt||c.filename}" class="h-full w-full rounded-2xl object-cover" />`:q.innerHTML='<div class="flex h-full w-full flex-col items-center justify-center gap-1 text-slate-400"><span class="text-3xl">\u{1F4C4}</span><span class="text-xs font-semibold">Document</span></div>'),F&&(F.textContent=c.filename||"Fichier"),u&&(u.textContent=fe(c)),U&&(U.textContent=Be(c.size)),A&&(A.value=c.alt||""),W&&(W.textContent=c.path||"\u2014"),Te(c)},Q=r=>{if(r){if(d=!0,l=!1,x=null,S==null||S.classList.add("hidden"),v==null||v.classList.remove("hidden"),E&&URL.revokeObjectURL(E),E=URL.createObjectURL(r),q&&(q.innerHTML=`<img src="${E}" alt="${r.name}" class="h-full w-full rounded-2xl object-cover" />`),F&&(F.textContent=r.name),u&&(u.textContent=fe({type:r.type,filename:r.name})),U&&(U.textContent=Be(r.size)),A&&!A.value.trim()&&(A.value=r.name.replace(/\.[^.]+$/,"").replace(/[-_]/g," ")),W&&(W.textContent="En attente de t\xE9l\xE9versement"),I){I.innerHTML="";let c=document.createElement("li");c.textContent="Non utilis\xE9",c.className="text-xs text-slate-400",I.appendChild(c)}X(!1)}},$e=()=>{let r=(y==null?void 0:y.value)||"all";r==="all"?R=[...h]:R=h.filter(c=>c.groupType===r),R.some(c=>c.id===x)||ge(),he(),we()},Pe=async()=>{if(!N){i==null||i.classList.remove("hidden");return}try{let r=await fetch(N,{headers:{Accept:"application/json"}});if(!r.ok)throw new Error("Impossible de charger les m\xE9dias.");let c=await r.json().catch(()=>({items:[]}));h=Array.isArray(c.items)?c.items.map(B=>({...B,groupType:Z(B)})):[],$e()}catch(r){console.error("[media] load failed",r),j(r.message||"Impossible de charger les m\xE9dias."),h=[],$e()}};y==null||y.addEventListener("change",()=>{$e()}),A==null||A.addEventListener("input",()=>{if(d){X(!1);return}x&&(l=!0,X(!1))});let ye=r=>{if(r){if(!r.type.startsWith("image/")){j("Seules les images sont accept\xE9es pour le moment.");return}if(r.size>4*1024*1024){j("Fichier trop volumineux (4 Mo max).");return}P=r,Q(r),ce&&(ce.textContent=`${r.name} \xB7 ${Be(r.size)}`)}},te=r=>new Promise((c,B)=>{let b=new FileReader;b.onload=()=>{let me=b.result||"",[,Oe=""]=String(me).split(",");c(Oe)},b.onerror=()=>B(new Error("Impossible de lire ce fichier.")),b.readAsDataURL(r)}),Ue=async()=>{if(!(!P||!N)){O=!0,X(!0);try{let r=await te(P),c={filename:P.name,type:P.type,size:P.size,alt:(A==null?void 0:A.value)||"",data:r},B=await fetch(N,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!B.ok){let me=await B.json().catch(()=>({}));throw new Error(me.message||"Upload impossible.")}let b=await B.json();b.groupType=Z(b),h=[...h,b],z=b.id,$e(),Ne(b.id),j("M\xE9dia ajout\xE9"),qe()}catch(r){console.error("[media] upload failed",r),j(r.message||"Impossible de t\xE9l\xE9verser ce m\xE9dia.")}finally{O=!1,P=null,X(!1)}}};K==null||K.addEventListener("click",()=>M==null?void 0:M.click()),M==null||M.addEventListener("change",()=>{M.files&&M.files[0]&&ye(M.files[0])});let je=()=>{D&&(D.classList.add("hidden"),D.classList.remove("flex"))},ue=()=>{if(!(!x||d)){if(D){D.classList.remove("hidden"),D.classList.add("flex");return}window.confirm("Supprimer ce m\xE9dia ?")&&ne()}},ne=async()=>{if(!x||!N){je();return}let r=()=>{m&&(m.disabled=!0),$&&($.disabled=!0,$.textContent="Suppression\u2026")},c=()=>{m&&(m.disabled=!1),$&&($.disabled=!1,$.textContent="Supprimer")};r();try{let B=await fetch(`${N}/${encodeURIComponent(x)}`,{method:"DELETE"});if(!B.ok){let b=await B.json().catch(()=>({}));throw new Error(b.message||"Suppression impossible.")}h=h.filter(b=>b.id!==x),R=R.filter(b=>b.id!==x),j("M\xE9dia supprim\xE9"),ge(),he(),we()}catch(B){console.error("[media] delete failed",B),j(B.message||"Impossible de supprimer ce m\xE9dia.")}finally{c(),je()}};Y==null||Y.addEventListener("click",je),D==null||D.addEventListener("click",r=>{r.target===D&&je()}),$==null||$.addEventListener("click",()=>ne()),m==null||m.addEventListener("click",ue),k==null||k.addEventListener("click",async()=>{if(d){Ue();return}if(!(!x||!N||!A)){X(!0);try{let r={alt:A.value||""},c=await fetch(`${N}/${encodeURIComponent(x)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!c.ok){let b=await c.json().catch(()=>({}));throw new Error(b.message||"Impossible de mettre \xE0 jour ce m\xE9dia.")}let B=await c.json();h=h.map(b=>b.id===x?{...b,...B}:b),R=R.map(b=>b.id===x?{...b,...B}:b),l=!1,X(!1),j("M\xE9dia mis \xE0 jour")}catch(r){console.error("[media] update failed",r),j(r.message||"\xC9chec de la mise \xE0 jour."),X(!1)}}}),Pe()}});})();
