(()=>{document.addEventListener("DOMContentLoaded",()=>{console.log("[admin] Atelier charg\xE9");let ao=document.querySelector("[data-logout]");ao&&ao.addEventListener("click",async()=>{ao.disabled=!0;try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(s){console.error("[admin] Impossible de se d\xE9connecter",s)}finally{window.location.href="/admin/index.html"}});let cs=document.querySelector("[data-admin-sidebar]"),ft=document.querySelector("[data-admin-sidebar-overlay]"),Do=document.querySelectorAll("[data-admin-sidebar-toggle]"),yn=document.querySelectorAll("[data-admin-sidebar-close]"),io=document.body,$s=!1,js=()=>{if(!cs)return;if(window.matchMedia("(min-width: 1024px)").matches){cs.classList.remove("hidden"),ft==null||ft.classList.add("hidden"),io.classList.remove("overflow-hidden");return}$s?(cs.classList.remove("hidden"),ft==null||ft.classList.remove("hidden"),io.classList.add("overflow-hidden")):(cs.classList.add("hidden"),ft==null||ft.classList.add("hidden"),io.classList.remove("overflow-hidden"))},bn=()=>{$s=!0,js()},lo=()=>{$s=!1,js()};cs&&Do.length>0&&(Do.forEach(s=>{s.addEventListener("click",bn)}),yn.forEach(s=>{s.addEventListener("click",lo)}),ft==null||ft.addEventListener("click",lo),window.addEventListener("resize",js),window.addEventListener("keydown",s=>{s.key==="Escape"&&$s&&lo()}),js());let Ho="clower:currentSite",Uo="clower:currentSiteName",Y={slug:null,name:""};(()=>{try{Y.slug=window.localStorage.getItem(Ho),Y.name=window.localStorage.getItem(Uo)||""}catch{Y.slug=null,Y.name=""}})();let co=document.querySelectorAll("[data-site-card]"),xn=document.querySelectorAll("[data-site-select]"),ds=document.querySelector("[data-current-site-name]"),Ro=document.querySelector("[data-workspace-site-name]"),zo=document.querySelector("[data-workspace-back-name]"),kt=document.querySelector("[data-workspace-back-modal]"),wn=document.querySelectorAll("[data-workspace-back]"),Sn=document.querySelectorAll("[data-workspace-back-cancel]"),uo=document.querySelector("[data-workspace-back-confirm]"),Ln=document.querySelectorAll("[data-workspace-tab]"),mo=document.querySelector("[data-site-toast]"),Oo=document.querySelector("[data-site-toast-message]"),kn=document.querySelectorAll("[data-site-create]"),rt=document.querySelector("[data-site-modal]"),Xe=document.querySelector("[data-site-form]"),Ve=Xe==null?void 0:Xe.querySelector('input[name="siteName"]'),Me=Xe==null?void 0:Xe.querySelector('input[name="siteSlug"]'),Je=document.querySelector("[data-site-slug-error]"),Ge=document.querySelector("[data-site-modal-error]"),En=document.querySelectorAll("[data-site-modal-cancel]"),Xt=document.querySelector("[data-site-modal-submit]"),O=Fn(),Bs=!1,fo=null,Vo='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',Qt=[],Jo=s=>Array.from(s.querySelectorAll(Vo)).filter(a=>!a.hasAttribute("disabled")&&!a.getAttribute("aria-hidden")),Cn=s=>{if(!Qt.length)return;let a=Qt[Qt.length-1],{modal:i,onClose:m}=a;if(s.key==="Escape"){s.preventDefault(),m==null||m();return}if(s.key!=="Tab")return;let h=Jo(i);if(!h.length)return;let x=h[0],R=h[h.length-1];s.shiftKey?document.activeElement===x&&(s.preventDefault(),R.focus()):document.activeElement===R&&(s.preventDefault(),x.focus())};document.addEventListener("keydown",Cn);let us=(s,a)=>{if(!s)return;Qt.push({modal:s,onClose:a,trigger:document.activeElement instanceof HTMLElement?document.activeElement:null});let i=Jo(s);window.setTimeout(()=>{var m,h;(h=(m=i[0]||s).focus)==null||h.call(m)},0)},ms=s=>{var m,h;let a=Qt.findIndex(x=>x.modal===s);if(a===-1)return;let[i]=Qt.splice(a,1);(h=(m=i.trigger)==null?void 0:m.focus)==null||h.call(m)},ee=document.querySelector("[data-mobile-panels-overlay]"),fs={left:document.querySelector('[data-mobile-panel="left"]'),right:document.querySelector('[data-mobile-panel="right"]')},Go=document.querySelectorAll("[data-mobile-panel-toggle]"),qn=document.querySelectorAll("[data-mobile-panel-close]"),ps={left:null,right:null},xt=null,Fs=()=>window.matchMedia("(min-width: 1024px)").matches,Ms=(s,a,i)=>{!s||!a||a.split(" ").map(m=>m.trim()).filter(Boolean).forEach(m=>s.classList[i](m))},po=(s,a)=>{if(!s)return;let i=s.dataset.mobilePanelHidden||"",m=s.dataset.mobilePanelVisible||"translate-x-0";a?(Ms(s,m,"remove"),Ms(s,i,"add"),s.classList.add("pointer-events-none"),s.classList.remove("pointer-events-auto"),s.setAttribute("aria-hidden","true"),s.dataset.mobilePanelOpen="false"):(Ms(s,i,"remove"),Ms(s,m,"add"),s.classList.remove("pointer-events-none"),s.classList.add("pointer-events-auto"),s.setAttribute("aria-hidden","false"),s.dataset.mobilePanelOpen="true")},gs=(s=xt)=>{var m;if(!s||Fs())return;let a=fs[s];if(!a)return;po(a,!0);let i=ps[s];i&&i.setAttribute("aria-expanded","false"),ps[s]=null,xt===s&&(ee==null||ee.classList.add("hidden"),ee==null||ee.classList.remove("pointer-events-auto"),ee==null||ee.classList.add("pointer-events-none"),ee==null||ee.setAttribute("aria-hidden","true"),document.body.classList.remove("overflow-hidden"),(m=i==null?void 0:i.focus)==null||m.call(i),xt=null)},An=(s,a)=>{if(!s||Fs())return;let i=fs[s];if(!i)return;xt&&xt!==s&&gs(xt),po(i,!1),xt=s,ps[s]=a||null,a&&a.setAttribute("aria-expanded","true"),ee==null||ee.classList.remove("hidden","pointer-events-none"),ee==null||ee.classList.add("pointer-events-auto"),ee==null||ee.setAttribute("aria-hidden","false"),document.body.classList.add("overflow-hidden");let m=i.querySelector(Vo);window.setTimeout(()=>{var h;(h=m==null?void 0:m.focus)==null||h.call(m)},0)},Wo=()=>{Fs()?(ee==null||ee.classList.add("hidden"),document.body.classList.remove("overflow-hidden"),xt=null,Object.keys(fs).forEach(s=>{let a=fs[s];if(!a)return;a.classList.remove("pointer-events-none"),a.classList.add("pointer-events-auto"),a.setAttribute("aria-hidden","false"),a.dataset.mobilePanelOpen="false";let i=ps[s];i==null||i.setAttribute("aria-expanded","false"),ps[s]=null})):(Object.entries(fs).forEach(([s,a])=>{a&&a.dataset.mobilePanelOpen!=="true"&&po(a,!0)}),xt||(ee==null||ee.classList.add("hidden","pointer-events-none"),ee==null||ee.classList.remove("pointer-events-auto"),ee==null||ee.setAttribute("aria-hidden","true")))};Go.length>0&&(Go.forEach(s=>{let a=s.dataset.mobilePanelToggle;s.addEventListener("click",()=>{xt===a?gs(a):An(a,s)})}),qn.forEach(s=>{let a=s.dataset.mobilePanelClose;s.addEventListener("click",()=>gs(a))}),ee==null||ee.addEventListener("click",()=>gs()),window.addEventListener("keydown",s=>{s.key==="Escape"&&xt&&!Fs()&&gs()}),window.addEventListener("resize",Wo),Wo());let $=s=>{!mo||!Oo||(Oo.textContent=s,mo.classList.remove("hidden"),fo&&clearTimeout(fo),fo=setTimeout(()=>{mo.classList.add("hidden")},2500))};function jt(s){return s?s.startsWith("/")?s:`/${s}`:""}function qe(s){return(s==null?void 0:s.replace(/^\//,""))||""}let Ps=(s,a)=>{let i=s?jt(s):null;try{i&&(window.localStorage.setItem(Ho,i),Y.slug=i),typeof a=="string"&&a.length>0&&(window.localStorage.setItem(Uo,a),Y.name=a)}catch{Y.slug=i||Y.slug,Y.name=a||Y.name}},Ko=s=>{ds&&s&&(ds.textContent=s),Ro&&s&&(Ro.textContent=s),zo&&s&&(zo.textContent=s)},go=s=>{Ln.forEach(a=>{let i=a.dataset.workspaceTab;if(!i)return;if(!s){a.href="#",a.classList.add("pointer-events-none","opacity-50","text-slate-400"),a.setAttribute("aria-disabled","true");return}let m=encodeURIComponent(qe(s));a.href=`/admin/site/${m}/${i}`,a.classList.remove("pointer-events-none","opacity-50","text-slate-400"),a.removeAttribute("aria-disabled")})},Ns=(s,a={})=>{if(!s)return;let i=jt(s),m=a.siteName||Y.name||(ds==null?void 0:ds.dataset.defaultSiteName)||"";co.forEach(x=>{let W=jt(x.dataset.siteCard||"")===i,U=x.querySelector("[data-site-active-badge]");W?(x.classList.add("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),x.classList.remove("border-slate-200"),U==null||U.classList.remove("hidden"),m=x.dataset.siteName||m):(x.classList.remove("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),x.classList.add("border-slate-200"),U==null||U.classList.add("hidden"))}),a.persist!==!1&&Ps(i,a.siteName||m);let h=a.siteName||m;Ko(h),go(i)},Tn=async(s,a)=>{let i=jt(s);try{let m=await fetch("/api/sites/select",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slug:i})});if(!m.ok){let U=await m.json().catch(()=>({}));$(U.message||"Impossible de s\xE9lectionner ce site.");return}let h=await m.json().catch(()=>({})),x=jt(h.slug||i),R=h.name||a;Ps(x,R),Ns(x,{siteName:R,persist:!1});let W=encodeURIComponent(qe(x));window.location.href=`/admin/site/${W}/design`}catch(m){console.error("[admin] Impossible de s\xE9lectionner le site",m),$("Erreur inattendue lors de la s\xE9lection.")}},In=async()=>{try{let s=await fetch("/api/sites/current",{credentials:"same-origin"});if(!s.ok){s.status===404&&O&&(window.location.href="/admin/sites");return}let a=await s.json(),i=jt(a.slug);Ps(i,a.name),Ns(i,{siteName:a.name,persist:!1})}catch(s){console.warn("[admin] Impossible de r\xE9cup\xE9rer le site actif",s)}};(()=>{if(Y.slug){Ns(Y.slug,{siteName:Y.name,persist:!1});return}let s=document.querySelector('[data-site-card][data-site-default="true"]')||co[0];s&&Ns(s.dataset.siteCard,{siteName:s.dataset.siteName||"",persist:!1})})(),In(),O?go(O.slugValue):Y.slug&&go(Y.slug),xn.forEach(s=>{s.addEventListener("click",()=>{if(s.disabled)return;let a=s.dataset.siteSelect,i=s.dataset.siteSelectName||"Ce site";a&&(s.disabled=!0,Tn(a,i).finally(()=>{s.disabled=!1}))})});let Jt=s=>(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),$n=s=>{let a=Jt(s||"");return a?`/${a}`:""},jn=()=>{rt&&(rt.classList.remove("hidden"),rt.classList.add("flex"),Bs=!1,Xe==null||Xe.reset(),Je&&(Je.textContent=""),Ge&&(Ge.textContent=""),Me&&Ve&&(Me.value=Jt(Ve.value)),us(rt,hs),window.setTimeout(()=>{Ve==null||Ve.focus()},0))},hs=()=>{rt&&(rt.classList.add("hidden"),rt.classList.remove("flex"),Bs=!1,Xe==null||Xe.reset(),Je&&(Je.textContent=""),Ge&&(Ge.textContent=""),ms(rt))};kn.forEach(s=>{s.addEventListener("click",jn)}),En.forEach(s=>{s.addEventListener("click",hs)}),rt==null||rt.addEventListener("click",s=>{s.target===rt&&hs()}),Ve==null||Ve.addEventListener("input",()=>{Me&&((!Bs||Me.value.trim().length===0)&&(Me.value=Jt(Ve.value)),Je&&(Je.textContent=""),Ge&&(Ge.textContent=""))}),Me==null||Me.addEventListener("focus",()=>{let s=(Me==null?void 0:Me.value)||"",a=(Ve==null?void 0:Ve.value)||"";!s.trim()&&a.trim()&&(Me.value=Jt(a))}),Me==null||Me.addEventListener("input",()=>{Bs=!0,Je&&(Je.textContent=""),Ge&&(Ge.textContent="")});let Bn=()=>new Set(Array.from(co).map(s=>jt(s.dataset.siteCard||"")));Xe==null||Xe.addEventListener("submit",async s=>{if(s.preventDefault(),console.log("[admin] Form submit - siteNameInput:",Ve,"siteSlugInput:",Me),!Ve||!Me){console.log("[admin] Missing inputs, aborting");return}let a=(Ve.value||"").trim(),i=(Me.value||"").trim();console.log("[admin] nameValue:",a,"slugValue:",i),!i&&a&&(i=Jt(a),Me.value=i,console.log("[admin] Auto-generated slug:",i));let m=$n(i);if(console.log("[admin] normalizedSlug:",m),!a){console.log("[admin] Name validation failed"),Ge&&(Ge.textContent="Le nom du site est requis."),Ve.focus();return}if(!m){console.log("[admin] Slug validation failed"),Je&&(Je.textContent="Le slug ne peut pas \xEAtre vide ou contenir uniquement des caract\xE8res sp\xE9ciaux."),Me.focus();return}if(Bn().has(m)){Je&&(Je.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}Je&&(Je.textContent=""),Ge&&(Ge.textContent=""),Xt&&(Xt.disabled=!0,Xt.textContent="Cr\xE9ation...");try{let x=await fetch("/api/sites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a,slug:m})});if(!x.ok){let se=await x.json().catch(()=>({})),g=se.message||"Impossible de cr\xE9er ce site.";Ge&&(Ge.textContent=g),se.field==="slug"&&Je&&(Je.textContent=g);return}let R=await x.json(),W=jt((R==null?void 0:R.slug)||m),U=(R==null?void 0:R.name)||a;Ps(W,U),hs();let ne=encodeURIComponent(qe(W));window.location.href=`/admin/site/${ne}/design`}catch(x){console.error("[admin] Impossible de cr\xE9er le site",x),Ge&&(Ge.textContent="Erreur inattendue. R\xE9essaie dans un instant.")}finally{Xt&&(Xt.disabled=!1,Xt.textContent="Cr\xE9er")}}),window.addEventListener("keydown",s=>{s.key==="Escape"&&(rt&&!rt.classList.contains("hidden")&&hs(),kt&&!kt.classList.contains("hidden")&&Ds(),blockDeleteModal&&!blockDeleteModal.classList.contains("hidden")&&closeBlockDeleteModal(),blockLibraryOpen&&closeBlockLibrary())});function Fn(){let s=window.location.pathname.match(/^\/admin\/site\/([^/]+)(?:\/([^/]+))?/);return s?{slugPart:decodeURIComponent(s[1]),slugValue:jt(decodeURIComponent(s[1])),section:s[2]||"design"}:null}function Mn(){return document.querySelector("[data-page-list]")?"design":document.querySelector("[data-collection-list]")?"content":document.querySelector("[data-media-grid]")?"media":document.querySelector("[data-deploy-form]")?"deploy":null}function Pn(){if(!kt){window.location.href="/admin/sites";return}kt.classList.remove("hidden"),kt.classList.add("flex"),us(kt,Ds)}function Ds(){kt&&(kt.classList.add("hidden"),kt.classList.remove("flex"),ms(kt))}wn.forEach(s=>{s.addEventListener("click",Pn)}),Sn.forEach(s=>{s.addEventListener("click",Ds)}),uo==null||uo.addEventListener("click",()=>{Ds(),window.location.href="/admin/sites"});let vs=(O==null?void 0:O.section)||Mn();vs==="design"&&Nn(),vs==="content"&&Dn(),vs==="media"&&Rn(),vs==="deploy"&&Hn(),vs==="settings"&&Un(),O&&Y.name&&Ko(Y.name);function Nn(){let s=document.querySelectorAll("[data-page-list]");if(s.length===0)return;let a=document.querySelector("[data-active-page-title]"),i=document.querySelector("[data-active-page-slug]"),m=document.querySelector("[data-page-preview-tags]"),h=document.querySelector("[data-page-preview-frame]"),x=document.querySelector("[data-preview-open]"),R=document.querySelector("[data-preview-status]"),W=document.querySelector("[data-preview-highlight]"),U=document.querySelector("[data-seo-toggle]"),ne=document.querySelector("[data-seo-panel]"),se=document.querySelector("[data-seo-close]"),g=document.querySelector("[data-seo-form]"),E=document.querySelector("[data-seo-title]"),C=document.querySelector("[data-seo-description]"),L=document.querySelector("[data-seo-indexed]"),M=document.querySelector("[data-seo-feedback]"),P=document.querySelector("[data-seo-save]"),N=document.querySelector("[data-page-accessibility-toggle]"),H=document.querySelector("[data-page-accessibility-panel]"),u=document.querySelector("[data-page-accessibility-close]"),q=document.querySelector("[data-page-accessibility-form]"),k=document.querySelector("[data-page-accessibility-nav]"),T=document.querySelector("[data-page-accessibility-main]"),te=document.querySelector("[data-page-accessibility-feedback]"),K=document.querySelector("[data-page-accessibility-save]"),X=document.querySelector("[data-page-props-toggle]"),he=document.querySelector("[data-page-props-panel]"),me=document.querySelector("[data-page-props-close]"),$e=document.querySelector("[data-page-props-form]"),fe=document.querySelector("[data-page-name]"),ke=document.querySelector("[data-page-title-input]"),Ae=document.querySelector("[data-page-slug-input]"),D=document.querySelector("[data-page-description]"),b=document.querySelector("[data-page-props-feedback]"),v=document.querySelector("[data-page-props-save]"),S=document.querySelector("[data-blocks-list]"),Z=document.querySelector("[data-blocks-empty]"),re=document.querySelector("[data-block-count]"),pe=document.querySelector("[data-block-library-toggle]"),ve=document.querySelector("[data-block-library]"),et=document.querySelectorAll("[data-block-add]"),ce=document.querySelector("[data-block-delete-modal]"),tt=document.querySelector("[data-block-delete-confirm]"),ge=document.querySelector("[data-block-delete-cancel]"),ae=document.querySelector("[data-block-detail-empty]"),Te=document.querySelector("[data-block-detail-status]"),je=document.querySelector("[data-block-editor]"),Bt=document.querySelector("[data-block-editor-block-name]"),Ft=document.querySelector("[data-block-editor-block-type]"),ye=document.querySelector("[data-block-editor-unsupported]"),A=document.querySelector("[data-block-form]"),de=A?Array.from(A.querySelectorAll("[data-editor-section]")):[],l=document.querySelectorAll("[data-block-tab]"),I="content",V=document.querySelectorAll("[data-left-tab]"),J=document.querySelector('[data-left-panel="blocks"]'),Ct=document.querySelector('[data-left-panel="pages"]'),wt="blocks",ys=e=>{wt=e,V.forEach(t=>{let o=t.dataset.leftTab===e;t.setAttribute("aria-selected",o?"true":"false"),o?(t.classList.add("text-[#9C6BFF]"),t.classList.remove("text-slate-500","hover:text-slate-700"),t.classList.add("after:absolute","after:bottom-0","after:left-0","after:right-0","after:h-0.5","after:bg-[#9C6BFF]")):(t.classList.remove("text-[#9C6BFF]"),t.classList.add("text-slate-500","hover:text-slate-700"),t.classList.remove("after:absolute","after:bottom-0","after:left-0","after:right-0","after:h-0.5","after:bg-[#9C6BFF]"))}),J&&J.classList.toggle("hidden",e!=="blocks"),Ct&&Ct.classList.toggle("hidden",e!=="pages")};V.forEach(e=>{e.addEventListener("click",()=>{ys(e.dataset.leftTab)})});let Gt=document.querySelector("[data-block-form-actions]"),Wt=document.querySelector("[data-block-form-autosave]"),bs=e=>{I=e,l.forEach(o=>{let r=o.dataset.blockTab===e;o.setAttribute("aria-selected",r?"true":"false"),r?(o.classList.add("text-[#9C6BFF]"),o.classList.remove("text-slate-500","hover:text-slate-700"),o.classList.add("after:absolute","after:bottom-0","after:left-0","after:right-0","after:h-0.5","after:bg-[#9C6BFF]")):(o.classList.remove("text-[#9C6BFF]"),o.classList.add("text-slate-500","hover:text-slate-700"),o.classList.remove("after:absolute","after:bottom-0","after:left-0","after:right-0","after:h-0.5","after:bg-[#9C6BFF]"))});let t=A==null?void 0:A.querySelector("[data-editor-section]:not(.hidden)");t&&t.querySelectorAll("[data-block-panel]").forEach(r=>{r.dataset.blockPanel===e?r.classList.remove("hidden"):r.classList.add("hidden")}),Gt&&Wt&&(e==="content"?(Gt.classList.remove("hidden"),Wt.classList.add("hidden")):(Gt.classList.add("hidden"),Wt.classList.remove("hidden")))};l.forEach(e=>{e.addEventListener("click",()=>{bs(e.dataset.blockTab)})});let be=A==null?void 0:A.querySelector('[name="collection-grid-collection"]'),ct=A==null?void 0:A.querySelector("[data-collection-selection-info]"),Pe=document.querySelector("[data-block-form-cancel]"),Ue=A==null?void 0:A.querySelector("[data-group-preview-mobile]"),De=A==null?void 0:A.querySelector("[data-group-preview-desktop]"),at=A==null?void 0:A.querySelector("[data-collection-preview-mobile]"),Ht=A==null?void 0:A.querySelector("[data-collection-preview-desktop]"),Mt={hero:{section:"hero",labelField:"title",descriptionField:"subtitle",fields:{title:"hero-title",subtitle:"hero-subtitle",ctaLabel:"hero-cta-label",ctaUrl:"hero-cta-url",image:"hero-image",layout:"hero-layout",height:"hero-height",contentAlign:"hero-content-align",horizontalAlign:"hero-horizontal-align",textAlign:"hero-text-align",overlay:"hero-overlay",titleSize:"hero-title-size",bg:"hero-bg",borderRadius:"hero-border-radius",shadow:"hero-shadow"}},paragraphe:{section:"paragraph",labelField:"title",descriptionField:"content",fields:{title:"paragraph-title",content:"paragraph-content",align:"paragraph-align",titleSize:"paragraph-title-size",textSize:"paragraph-text-size",spacing:"paragraph-spacing",bg:"paragraph-bg",borderRadius:"paragraph-border-radius",shadow:"paragraph-shadow"}},image:{section:"image",labelField:"alt",fields:{src:"image-src",alt:"image-alt",showCaption:"image-caption-toggle",caption:"image-caption",rounded:"image-rounded",shadow:"image-shadow",maxWidth:"image-max-width",height:"image-height",objectFit:"image-object-fit",align:"image-align",bg:"image-bg",borderRadius:"image-border-radius"}},groupe:{section:"group",fields:{columnsMobile:"group-columns-mobile",columnsDesktop:"group-columns-desktop",gap:"group-gap",itemsAlign:"group-items-align",mobileLayout:"group-mobile-layout",bg:"group-bg",borderRadius:"group-border-radius",shadow:"group-shadow"}},collectiongrid:{section:"collection",fields:{collectionId:"collection-grid-collection",limit:"collection-grid-limit",columnsMobile:"collection-columns-mobile",columnsDesktop:"collection-columns-desktop",gap:"collection-gap",itemsAlign:"collection-items-align",cardRounded:"collection-card-rounded",mobileLayout:"collection-mobile-layout",bg:"collection-bg",borderRadius:"collection-border-radius",shadow:"collection-shadow"}},form:{section:"form",labelField:"formTitle",fields:{formTitle:"form-title",actionUrl:"form-action-url",method:"form-method",serviceName:"form-service-name",submitLabel:"form-submit-label",successMessage:"form-success-message",maxWidth:"form-max-width",align:"form-align",buttonRounded:"form-button-rounded",spacing:"form-spacing",bg:"form-bg",borderRadius:"form-border-radius",shadow:"form-shadow"}},newsletterembed:{section:"newsletter",labelField:"title",fields:{title:"newsletter-title",serviceName:"newsletter-service-name",embedCode:"newsletter-embed-code",maxWidth:"newsletter-max-width",align:"newsletter-align",padding:"newsletter-padding",bg:"newsletter-bg",borderRadius:"newsletter-border-radius",shadow:"newsletter-shadow"}}},xs={texte:"paragraphe",paragraph:"paragraphe",paragraphs:"paragraphe",paragraphes:"paragraphe",text:"paragraphe",hero:"hero",image:"image",groupe:"groupe",group:"groupe",collection:"collectiongrid",collectiongrid:"collectiongrid","collection-grid":"collectiongrid",form:"form",formulaire:"form",contact:"form",newsletterembed:"newsletterembed",newsletter:"newsletterembed",embed:"newsletterembed"},wo={animation:"anim-type",animationDelay:"anim-delay",animationDuration:"anim-duration"};Object.values(Mt).forEach(e=>{e.fields={...e.fields,...wo}});let Kt=(e,t)=>{if(!Ue||!De)return;let o=r=>Array.from({length:Number(r)||1}).map(()=>'<span class="block h-2 w-full rounded-full bg-slate-300"></span>').join("");Ue.innerHTML=o(e),De.innerHTML=o(t)},ts=(e,t)=>{if(!at||!Ht)return;let o=r=>Array.from({length:Number(r)||1}).map(()=>'<span class="block h-2 w-full rounded-full bg-violet-300"></span>').join("");at.innerHTML=o(e),Ht.innerHTML=o(t)},Pt=async()=>{if(!vt)return[];let e=await fetch(vt,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les pages.");let t=await e.json().catch(()=>[]);return Array.isArray(t)?t:[]},zs=async({name:e,title:t,slug:o})=>{if(!vt)throw new Error("Site inconnu.");let r=await fetch(vt,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,title:t,slug:o})});if(!r.ok){let c=await r.json().catch(()=>({}));throw new Error(c.message||"Impossible de cr\xE9er la page.")}return r.json().catch(()=>({}))},qt=async e=>{if(!(!vt||!(e!=null&&e.id)))try{let t=await fetch(`${vt}/${encodeURIComponent(e.id)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let r=await t.json().catch(()=>({}));throw new Error(r.message||"Impossible de sauvegarder la page.")}let o=await t.json().catch(()=>({}));if(o!=null&&o.id){let r=_t(o);return oe=oe.map(c=>c.id===r.id?r:c),(f==null?void 0:f.id)===r.id&&(f=r),r}return o}catch(t){console.error("[design] Save page failed",t),$(t.message||"Sauvegarde impossible.")}},ws=async()=>{if(!vt){oe=[],Ne=null,f=null,Ot(oe,Ne),yt(null),ae==null||ae.classList.remove("hidden"),je==null||je.classList.add("hidden");return}try{let e=await Pt();if(oe=(Array.isArray(e)?e:[]).map(t=>_t(t)),oe.length===0){Ne=null,f=null,Ot(oe,Ne),yt(null),ae==null||ae.classList.remove("hidden"),je==null||je.classList.add("hidden"),h&&(h.srcdoc=Rt());return}Ne=rr(oe),Lt(Ne)}catch(e){console.error("[design] Impossible de charger les pages",e),$("Impossible de charger les pages.")}},Os=e=>(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),We=e=>{if(!e)return null;let t=Os(e.type),o=xs[t]||t;return Mt[o]||null},Vs=e=>{var o,r,c,p,y;if(!A||!je)return;e&&!e.settings&&(e.settings={});let t=We(e);if(Bt&&(Bt.textContent=(e==null?void 0:e.label)||"Bloc"),Ft&&(Ft.textContent=(e==null?void 0:e.type)||"Bloc"),!t){A.classList.add("hidden"),ye==null||ye.classList.remove("hidden"),A.dataset.blockId="";return}if(ye==null||ye.classList.add("hidden"),A.classList.remove("hidden"),A.reset(),A.dataset.blockId=e.id,de.forEach(B=>{B.dataset.editorSection===t.section?B.classList.remove("hidden"):B.classList.add("hidden")}),bs("content"),t.section==="collection"){let B=e.collectionId||((o=e.settings)==null?void 0:o.collectionId)||"";oo(B)}if(Object.entries(t.fields).forEach(([B,_])=>{var Ye,bt,Ee;let le=A.querySelector(`[name="${_}"]`);if(!le)return;let Se=(Ye=e.settings)==null?void 0:Ye[B];if(le.type==="checkbox")le.checked=!!Se;else if(le.type==="number"){let F=(Ee=(bt=le.dataset.default)!=null?bt:le.defaultValue)!=null?Ee:"";le.value=Se!=null?Se:F}else le.tagName,le.value=Se!=null?Se:""}),t.section==="group"){let B=((r=A.querySelector('[name="group-columns-mobile"]'))==null?void 0:r.value)||"1",_=((c=A.querySelector('[name="group-columns-desktop"]'))==null?void 0:c.value)||"3";Kt(B,_)}if(t.section==="collection"){let B=((p=A.querySelector('[name="collection-columns-mobile"]'))==null?void 0:p.value)||"1",_=((y=A.querySelector('[name="collection-columns-desktop"]'))==null?void 0:y.value)||"3";ts(B,_)}A.querySelectorAll("[data-color-select]").forEach(B=>{var Ye,bt;let _=B.options[B.selectedIndex],le=((Ye=_==null?void 0:_.dataset)==null?void 0:Ye.color)||"#ffffff",Se=(bt=B.closest(".relative"))==null?void 0:bt.querySelector("[data-color-preview]");Se&&(le==="transparent"?Se.style.background="repeating-conic-gradient(#ccc 0% 25%, white 0% 50%) 50% / 8px 8px":(Se.style.backgroundColor=le,Se.style.background=""))})},Ut=e=>{if(!A||!e)return{};let t={};return Object.entries(e.fields).forEach(([o,r])=>{let c=A.querySelector(`[name="${r}"]`);if(c)if(c.type==="checkbox")t[o]=c.checked;else if(c.type==="number"){let p=Number(c.value);t[o]=Number.isFinite(p)?p:0}else c.tagName==="TEXTAREA"?t[o]=c.value||"":c.type==="select-one"?t[o]=c.value:t[o]=c.value||""}),t},At=e=>{if(R){if(!e){R.classList.add("hidden");return}R.classList.remove("hidden"),R.textContent=e}},So=e=>{if(!e)return null;let t=o=>{var r;return{id:o.id,type:o.type,label:o.label,status:o.status,description:o.description,props:o.props||[],settings:o.settings||{},collectionId:o.collectionId||((r=o.settings)==null?void 0:r.collectionId)||"",children:(o.children||[]).map(t)}};return{id:e.id,name:e.name,title:e.title,slug:e.slug,description:e.description||"",badges:[...e.badges||[]],seo:e.seo||{},accessibility:e.accessibility||{},blocks:(e.blocks||[]).map(t)}},Rt=()=>'<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#475569;background:#fff;">Pr\xE9paration de la pr\xE9visualisation\u2026</body></html>',Lo=(e,t)=>{let o;return(...r)=>{clearTimeout(o),o=setTimeout(()=>e(...r),t)}},Js=async()=>{if(!f||!Oe)return;let e=as(),t=We(e);if(!e||!t)return;let o=Ut(t),r=(f.blocks||[]).map(p=>{if(p.id!==e.id)return p;let y={...p.settings||{},...o};return{...p,settings:y}}),c={...f,blocks:r};f=c;try{let p=await qt(c);if(p!=null&&p.id){let y=_t(p);f=y,oe=oe.map(B=>B.id===y.id?y:B)}}catch(p){console.warn("[design] auto-save appearance failed",p)}},ko=(e,t)=>{!h||!h.contentWindow||h.contentWindow.postMessage({type:"updateBlockStyles",blockId:e,settings:t},"*")},Eo=Lo(()=>{f&&Nt(f)},1500),Gs=(e,t)=>{ko(e,t),At("Modification\u2026"),Js().then(()=>{At("Sauvegard\xE9"),setTimeout(()=>At("\xC0 jour"),1500)}).catch(()=>At("Erreur de sauvegarde")),Eo()},Nt=e=>{if(!h||!e)return;let t=(O==null?void 0:O.slugValue)||Y.slug||"",o=oe.map(p=>({id:p.id,slug:p.slug,title:p.title,name:p.name,accessibility:p.accessibility})),r={page:So(e),site:{title:Y.name||"Site",slug:t,pages:o}};$o=!1,At("Actualisation\u2026"),h.srcdoc=Rt(),Ts&&Ts.abort();let c=new AbortController;Ts=c,fetch("/api/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r),signal:c.signal}).then(p=>{if(!p.ok)throw new Error("Preview error");return p.json()}).then(p=>{c.signal.aborted||(Io=p.html||"",h.setAttribute("title",`Pr\xE9visualisation de la page ${e.title||""}`.trim()),h.srcdoc=Io||Rt(),At("\xC0 jour"))}).catch(p=>{c.signal.aborted||(console.error("[preview] Impossible de rendre la page",p),At("Erreur preview"),h.srcdoc='<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#be123c;background:#fff;">Erreur lors du rendu de la pr\xE9visualisation.</body></html>')}).finally(()=>{Ts===c&&(Ts=null)})},ss=e=>{var p;if(e.preventDefault(),!f||!Oe)return;let t=as(),o=We(t);if(!t||!o)return;let r=Ut(o);if(o.section==="image"){let y=(r.alt||"").trim();if(r.alt=y,!y){$("Ajoute un texte alternatif pour cette image.","error"),(p=A==null?void 0:A.querySelector('[name="image-alt"]'))==null||p.focus();return}}if(o.section==="collection"){if(!r.collectionId){$("S\xE9lectionnez une collection.");return}r.limit=Math.max(1,Number(r.limit)||1)}let c=(f.blocks||[]).map(y=>{if(y.id!==t.id)return y;let B={...y.settings||{},...r},_={...y,settings:B};return o.labelField&&r[o.labelField]&&(_.label=r[o.labelField]),o.descriptionField&&r[o.descriptionField]&&(_.description=r[o.descriptionField]),o.section==="collection"&&(_.collectionId=r.collectionId,_.settings.collectionId=r.collectionId,_.settings.limit=r.limit),_});is(c),$("Bloc mis \xE0 jour"),Lt(f.id,{preserveBlock:!0})},Dt=document.querySelector("[data-page-drawer]"),st=document.querySelector("[data-page-drawer-backdrop]"),Ws=document.querySelectorAll("[data-page-drawer-open]"),Ks=document.querySelectorAll("[data-page-drawer-close]"),n=document.querySelector("[data-add-page-toggle]"),d=document.querySelector("[data-add-page-form]"),w=document.querySelector("[data-add-page-name]"),j=document.querySelector("[data-add-page-title]"),z=document.querySelector("[data-add-page-slug]"),ie=document.querySelector("[data-add-page-cancel]"),G=document.querySelector("[data-add-page-error]"),Q=d==null?void 0:d.querySelector('[type="submit"]'),Be=document.querySelector("[data-import-pages-toggle]"),xe=document.querySelector("[data-import-modal]"),Ke=document.querySelectorAll("[data-import-modal-close]"),we=document.querySelector("[data-import-dropzone]"),Re=document.querySelector("[data-import-file-input]"),ze=document.querySelector("[data-import-file-list]"),St=document.querySelector("[data-import-file-names]"),Ce=document.querySelector("[data-import-results]"),Ie=document.querySelector("[data-import-results-content]"),Ze=document.querySelector("[data-import-submit]"),os=document.querySelectorAll("[data-import-tab]"),Ss=document.querySelectorAll("[data-import-panel]"),ns=document.querySelector("[data-copy-template]"),Ls=document.querySelector("[data-template-json]"),_e=document.querySelector("[data-import-paste-json]"),Zt=document.querySelector("[data-format-json]"),dt=document.querySelector("[data-import-paste-error]"),gt=[],Tt="upload",ot=document.querySelector("[data-delete-page-modal]"),ks=document.querySelector("[data-delete-page-name]"),rs=document.querySelector("[data-delete-page-cancel]"),ht=document.querySelector("[data-delete-page-confirm]"),zt=null,Zs=qe((O==null?void 0:O.slugValue)||Y.slug||"default")||"default",sr=(O==null?void 0:O.slugValue)||Y.slug||"",_s=qe(sr)||"",vt=_s?`/api/sites/${encodeURIComponent(_s)}/pages`:null,Qo=_s?`/api/sites/${encodeURIComponent(_s)}/collections`:null,en={active:`clower:activePage:${Zs}`},Co=(e,t,o,r,c,p=[],y={})=>{let B={id:e,label:t,type:o,status:r,description:c,props:p,settings:{...y}};return B.settings.collectionId&&(B.collectionId=B.settings.collectionId),B},or={hero:{type:"Hero",label:"Hero de page",description:"Section pleine largeur avec CTA principal.",status:"Brouillon",props:[{label:"CTA",value:"D\xE9couvrir"},{label:"Hauteur",value:"80vh"}],settings:{title:"Titre du hero",subtitle:"",ctaLabel:"D\xE9couvrir",ctaUrl:"#",image:"",align:"center"}},paragraph:{type:"Paragraphe",label:"Bloc \xE9ditorial",description:"Paragraphe libre pour raconter votre histoire.",status:"Brouillon",props:[{label:"Longueur",value:"150 mots"}],settings:{title:"Titre du paragraphe",content:"",align:"left"}},image:{type:"Image",label:"Bloc image",description:"Visuel seul avec l\xE9gende optionnelle.",status:"Brouillon",props:[{label:"Ratio",value:"16:9"},{label:"L\xE9gende",value:"Inactive"}],settings:{src:"",alt:"",showCaption:!1,caption:""}},group:{type:"Groupe",label:"Groupe de sections",description:"Conteneur pour imbriquer plusieurs sous-blocs.",status:"Brouillon",props:[{label:"Disposition",value:"Verticale"}],settings:{layout:"grid",columnsMobile:"1",columnsDesktop:"3",mobileLayout:"stack"}},collectiongrid:{type:"CollectionGrid",label:"Grille de contenus",description:"Affiche automatiquement les items d\u2019une collection.",status:"Brouillon",settings:{collectionId:"",limit:6,mobileLayout:"stack"}},form:{type:"Form",label:"Formulaire de contact",description:"Formulaire avec envoi vers un service externe.",status:"Brouillon",settings:{formTitle:"Contactez-nous",actionUrl:"",method:"POST",serviceName:"",submitLabel:"Envoyer",successMessage:"Merci pour votre message !"}},newsletterembed:{type:"NewsletterEmbed",label:"Newsletter / Embed",description:"Int\xE9gration d'un formulaire newsletter externe (Brevo, Mailchimp\u2026).",status:"Brouillon",settings:{title:"Restez inform\xE9",serviceName:"",embedCode:""}}},nr=e=>{try{window.localStorage.setItem(en.active,e)}catch{}},rr=e=>{var t;try{let o=window.localStorage.getItem(en.active);if(o&&e.some(r=>r.id===o))return o}catch{}return((t=e[0])==null?void 0:t.id)||null},ar=e=>!e||e<=0?"0 bloc":e===1?"1 bloc":`${e} blocs`,tn=e=>{if(!e||e==="/")return"/";let t=Jt(e.replace(/^\//,""));return t?`/${t}`:"/"},qo=(e="page",t="block")=>`${e}-${t}-${Date.now().toString(36)}-${Math.floor(Math.random()*1e3)}`,Dr=(e,t)=>[Co(qo(e,"intro"),"Introduction","Paragraphe","Brouillon",`Paragraphe introductif pour "${t}".`,[{label:"Longueur",value:"2 paragraphes"}],{title:`Introduction \xE0 ${t}`,content:"Ajoutez votre premier paragraphe de pr\xE9sentation.",align:"left"}),Co(qo(e,"content"),"Zone de contenu","Groupe","Brouillon","Section principale \xE0 composer avec textes et visuels.",[{label:"Colonnes",value:"Auto"}],{layout:"grid",columnsMobile:"1",columnsDesktop:"2",mobileLayout:"stack"})],sn=e=>{a&&(a.textContent=(e==null?void 0:e.name)||(e==null?void 0:e.title)||"Page"),i&&(i.textContent=(e==null?void 0:e.slug)||"/")},ir=e=>{if(!m)return;m.innerHTML="",(e&&e.badges&&e.badges.length>0?e.badges:["Structure en cours"]).forEach(o=>{let r=document.createElement("span");r.className="rounded-full bg-slate-100 px-3 py-1",r.textContent=o,m.appendChild(r)})},lr=e=>{switch((e||"").toLowerCase()){case"en ligne":return"bg-emerald-50 text-emerald-700";case"brouillon":return"bg-amber-50 text-amber-700";default:return"bg-slate-100 text-slate-600"}},Ys=e=>{if(!(!ae||!je)){if(!e){ae.classList.remove("hidden"),je.classList.add("hidden"),ye==null||ye.classList.add("hidden"),A==null||A.classList.add("hidden"),Te==null||Te.classList.add("hidden");return}ae.classList.add("hidden"),je.classList.remove("hidden"),Te&&(e.status?(Te.textContent=e.status,Te.className=`rounded-full px-3 py-1 text-xs font-semibold ${lr(e.status)}`,Te.classList.remove("hidden")):Te.classList.add("hidden")),Vs(e)}},Es=e=>{if(!h)return;let t=h.contentDocument;if(!t)return;t.querySelectorAll("[data-preview-block]").forEach(r=>{r.dataset.previewBlock===e?(r.classList.add("preview-block-active"),$o&&e&&r.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})):r.classList.remove("preview-block-active")}),W&&(W.style.borderColor=e?"rgba(156, 107, 255, 0.5)":"transparent")},on=(e,t=!1,o=null)=>{var No;let r=e.id===Oe,c=(e.type||"").toLowerCase(),p=c==="groupe"||c==="group"||c==="sections"||c==="grid",y=document.createElement("div");y.dataset.blockItem="true",y.dataset.blockId=e.id,o&&(y.dataset.parentBlockId=o),p&&(y.dataset.isGroup="true"),y.setAttribute("role","option"),y.setAttribute("aria-selected",r?"true":"false"),y.setAttribute("draggable","true"),y.tabIndex=0,y.className=["relative flex items-center gap-3 rounded-2xl border px-3 py-2 text-left transition group",t?"ml-6 border-dashed":"",r?"bg-slate-100 border-[#9C6BFF]/40 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let B=document.createElement("span");B.className=`absolute inset-y-2 left-0 w-1 rounded-full bg-[#9C6BFF] ${r?"":"hidden"}`,y.appendChild(B);let _=document.createElement("div");_.className="flex flex-1 items-center gap-3";let le=document.createElement("div");le.className="hidden lg:flex cursor-grab active:cursor-grabbing flex-shrink-0 items-center text-lg text-slate-400 hover:text-slate-600 transition-colors select-none",le.innerHTML="\u22EE\u22EE",le.setAttribute("title","Glisser pour r\xE9ordonner"),_.appendChild(le);let Se=document.createElement("div");Se.className="flex-1";let Ye=document.createElement("div");Ye.className="flex items-center gap-2 text-[11px] uppercase tracking-wide text-slate-500";let bt=document.createElement("span");bt.className="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600",bt.textContent=e.type;let Ee=document.createElement("span");if(Ee.className="text-slate-400",Ee.textContent=e.status,Ye.appendChild(bt),p){let it=(e.children||[]).length,Yt=document.createElement("span");Yt.className="rounded-full bg-violet-100 px-2 py-0.5 text-[10px] font-semibold text-violet-600",Yt.textContent=`${it} \xE9l\xE9ment${it!==1?"s":""}`,Ye.appendChild(Yt)}Ye.appendChild(Ee);let F=document.createElement("p");F.className="mt-1 text-sm font-semibold text-slate-900";let ut=e.settings&&e.settings.title||e.label||"Bloc sans titre";if(F.textContent=ut,Se.appendChild(Ye),Se.appendChild(F),c==="collectiongrid"&&e.collectionId){let it=((No=It.find(Fr=>Fr.id===e.collectionId))==null?void 0:No.name)||e.collectionId,Yt=document.createElement("p");Yt.className="text-xs text-slate-400",Yt.textContent=`Collection : ${it}`,Se.appendChild(Yt)}_.appendChild(Se),y.appendChild(_);let Fe=document.createElement("div");Fe.className="flex flex-col gap-1 text-xs text-slate-400";let ue=document.createElement("div");ue.className="flex items-center gap-1 lg:hidden";let nt=document.createElement("button");nt.type="button",nt.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",nt.textContent="\u2191",nt.addEventListener("click",it=>{it.stopPropagation(),o?nn(o,e.id,-1):an(e.id,-1)});let mt=document.createElement("button");mt.type="button",mt.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",mt.textContent="\u2193",mt.addEventListener("click",it=>{it.stopPropagation(),o?nn(o,e.id,1):an(e.id,1)}),ue.appendChild(nt),ue.appendChild(mt),Fe.appendChild(ue);let He=document.createElement("button");return He.type="button",He.className="inline-flex items-center justify-center rounded-lg border border-transparent px-2 py-1 text-[12px] text-rose-500 hover:text-rose-700",He.innerHTML="\u{1F5D1}\uFE0F",He.addEventListener("click",it=>{it.stopPropagation(),o?ur(o,e.id):br(e.id)}),Fe.appendChild(He),y.appendChild(Fe),y.addEventListener("click",()=>{Vt(e.id,o)}),y.addEventListener("keydown",it=>{(it.key==="Enter"||it.key===" ")&&(it.preventDefault(),Vt(e.id,o))}),{item:y,isGroup:p,block:e}},cr=e=>{let t=document.createElement("div");return t.dataset.groupDropZone=e.id,t.className="ml-6 border-2 border-dashed border-slate-200 rounded-xl p-3 text-center text-xs text-slate-400 hover:border-violet-300 hover:bg-violet-50/50 transition-colors cursor-pointer",t.innerHTML='<span class="pointer-events-none">\u{1F4E6} Glissez un bloc ici ou cliquez pour ajouter</span>',t.addEventListener("dragover",o=>{o.preventDefault(),o.stopPropagation(),t.classList.add("border-violet-400","bg-violet-50")}),t.addEventListener("dragleave",o=>{o.stopPropagation(),t.classList.remove("border-violet-400","bg-violet-50")}),t.addEventListener("drop",o=>{o.preventDefault(),o.stopPropagation(),t.classList.remove("border-violet-400","bg-violet-50");let r=o.dataTransfer.getData("text/plain");r&&r!==e.id&&dr(r,e.id)}),t.addEventListener("click",()=>{mr(e.id)}),t},yt=e=>{if(!S)return;S.innerHTML="";let t=(e==null?void 0:e.blocks)||[];if(re&&(re.textContent=ar(t.length)),t.length===0){S.classList.add("hidden"),Z==null||Z.classList.remove("hidden");return}S.classList.remove("hidden"),Z==null||Z.classList.add("hidden"),t.forEach(o=>{let{item:r,isGroup:c}=on(o,!1,null);if(S.appendChild(r),c){(o.children||[]).forEach(B=>{let{item:_}=on(B,!0,o.id);S.appendChild(_)});let y=cr(o);S.appendChild(y)}})},dr=(e,t)=>{if(!f)return;let o=f.blocks.findIndex(B=>B.id===e),r=f.blocks.find(B=>B.id===t);if(o===-1||!r)return;let p=(f.blocks[o].type||"").toLowerCase();if(p==="groupe"||p==="group"){$("Impossible d'imbriquer des groupes","error");return}let[y]=f.blocks.splice(o,1);r.children||(r.children=[]),r.children.push(y),yt(f),savePageBlocks(),$("Bloc ajout\xE9 au groupe")},ur=(e,t)=>{if(!f)return;let o=f.blocks.find(y=>y.id===e);if(!o||!o.children)return;let r=o.children.findIndex(y=>y.id===t);if(r===-1)return;let[c]=o.children.splice(r,1),p=f.blocks.findIndex(y=>y.id===e);f.blocks.splice(p+1,0,c),yt(f),savePageBlocks(),$("Bloc sorti du groupe")},nn=(e,t,o)=>{if(!f)return;let r=f.blocks.find(B=>B.id===e);if(!r||!r.children)return;let c=r.children.findIndex(B=>B.id===t);if(c===-1)return;let p=c+o;if(p<0||p>=r.children.length)return;let[y]=r.children.splice(c,1);r.children.splice(p,0,y),yt(f),savePageBlocks()},mr=e=>{Cs=e,openBlockPicker()},Cs=null,fr=e=>{!ot||!e||(zt=e,ks&&(ks.textContent=e.title||e.id),ot.classList.remove("hidden"),ot.classList.add("flex"),us(ot,Xs))},Xs=()=>{ot&&(ot.classList.add("hidden"),ot.classList.remove("flex"),zt=null,ms(ot))},pr=async()=>{if(!vt||!zt)return;let e=zt.id,t=zt.title||e;ht&&(ht.disabled=!0,ht.textContent="Suppression...");try{let o=await fetch(`${vt}/${encodeURIComponent(e)}`,{method:"DELETE",credentials:"include"}),r=await o.json();if(!o.ok)throw new Error(r.message||"Erreur serveur");oe=oe.filter(c=>c.id!==e),Ne===e?oe.length>0?Lt(oe[0].id):(Ne=null,f=null,Ot(oe,null),yt(null),ae==null||ae.classList.remove("hidden"),je==null||je.classList.add("hidden"),h&&(h.srcdoc=Rt())):Ot(oe,Ne),Xs(),$(`Page "${t}" supprim\xE9e`)}catch(o){console.error("[pages] delete failed",o),$(o.message||"Erreur suppression")}finally{ht&&(ht.disabled=!1,ht.textContent="Supprimer")}},Ot=(e,t)=>{s.forEach(o=>{o.innerHTML="",e.forEach(r=>{var Se;let c=document.createElement("li");c.className="flex items-center gap-1";let p=document.createElement("button");p.type="button",p.dataset.pageId=r.id,p.className=["flex-1 flex items-center gap-3 px-3 py-2 text-left transition",t===r.id?"bg-[#9C6BFF]/10 text-slate-900 border border-[#9C6BFF]/40 rounded-xl shadow-sm":"text-slate-700 hover:bg-slate-50 rounded-xl"].join(" "),t===r.id?p.setAttribute("aria-current","page"):p.removeAttribute("aria-current");let y=r.name||r.title,_=((Se=r.accessibility)==null?void 0:Se.showInMainNav)===!1?'<span class="text-[10px] font-semibold text-amber-600">Masqu\xE9 du menu</span>':"";p.innerHTML=`
            <span class="flex h-9 w-9 items-center justify-center rounded-xl border border-slate-200 bg-white text-slate-500">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M6.5 4.5h7l4 4v11a1 1 0 0 1-1 1h-10a1 1 0 0 1-1-1v-14a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
                <path d="M13.5 4.5v4a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.4"/>
              </svg>
            </span>
            <div class="flex flex-col">
              <span class="text-sm font-semibold">${y}</span>
              <span class="text-xs text-slate-500">${r.slug}</span>
              ${_}
            </div>
          `,p.addEventListener("click",()=>{Lt(r.id),Ao()||To()}),c.appendChild(p);let le=document.createElement("button");le.type="button",le.className="flex-shrink-0 p-2 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition",le.title="Supprimer cette page",le.setAttribute("aria-label",`Supprimer ${y}`),le.innerHTML=`
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14ZM10 11v6M14 11v6"/>
            </svg>
          `,le.addEventListener("click",Ye=>{Ye.stopPropagation(),fr(r)}),c.appendChild(le),o.appendChild(c)})})},as=()=>{if(!f||!Array.isArray(f.blocks))return null;let e=f.blocks.find(t=>t.id===Oe);if(!e){for(let t of f.blocks)if(t.children&&(e=t.children.find(o=>o.id===Oe),e))break}return e||null},rn=null,Vt=(e,t=null)=>{if(!f)return;if(!e){Oe=null,rn=null,yt(f),Ys(null),Es(null);return}let o=null;if(o=f.blocks.find(r=>r.id===e),!o&&t){let r=f.blocks.find(c=>c.id===t);r&&r.children&&(o=r.children.find(c=>c.id===e))}if(!o){for(let r of f.blocks)if(r.children){let c=r.children.find(p=>p.id===e);if(c){o=c,t=r.id;break}}}o||(o=f.blocks[0]||null,t=null),Oe=(o==null?void 0:o.id)||null,rn=t,yt(f),Ys(o),Es(Oe)},is=e=>{if(!f)return;let t={...f,blocks:e};xr(t)},Qs=()=>window.matchMedia("(min-width: 1024px)").matches;function an(e,t){if(!f||!e||!t)return;let o=[...f.blocks||[]],r=o.findIndex(y=>y.id===e);if(r<0)return;let c=r+t;if(c<0||c>=o.length)return;let[p]=o.splice(r,1);o.splice(c,0,p),is(o),Lt(f.id,{preserveBlock:!0}),Vt(p.id)}function Hr(e,t){if(!f||!e||!t||e===t)return;let o=[...f.blocks||[]],r=o.findIndex(y=>y.id===e),c=o.findIndex(y=>y.id===t);if(r<0||c<0)return;let[p]=o.splice(r,1);o.splice(c,0,p),is(o),Lt(f.id,{preserveBlock:!0}),Vt(p.id)}function gr(e,t,o){if(!f||!e||!t||e===t)return;let r=[...f.blocks||[]],c=r.findIndex(_=>_.id===e),p=r.findIndex(_=>_.id===t);if(c<0||p<0)return;let[y]=r.splice(c,1);c<p&&p--;let B=o==="before"?p:p+1;r.splice(B,0,y),is(r),Lt(f.id,{preserveBlock:!0}),Vt(y.id)}function ln(){if(!S)return;let e=Qs();S.querySelectorAll("[data-block-item]").forEach(t=>{t.setAttribute("draggable",e?"true":"false")})}function qs(){ve&&(ve.classList.add("hidden"),As=!1)}function hr(){ve&&(ve.classList.remove("hidden"),As=!0)}function vr(){As?qs():hr()}function yr(e){var p;if(!f||!e)return;let t=or[e];if(!t)return;let o=(f.blocks||[]).filter(y=>y.type===t.type).length+1,r=Co(qo(f.id,e),`${t.label} ${o}`,t.type,t.status,t.description,t.props,t.settings||{});if((t.type||"").toLowerCase()==="collectiongrid"){let y=((p=It[0])==null?void 0:p.id)||"";r.collectionId=y,r.settings.collectionId=y,r.settings.limit=r.settings.limit||6}if(Cs){let y=f.blocks.find(B=>B.id===Cs);if(y){y.children||(y.children=[]),y.children.push(r),Cs=null,yt(f),savePageBlocks(),Vt(r.id,y.id),qs(),$("Bloc ajout\xE9 au groupe");return}Cs=null}let c=[...f.blocks||[],r];is(c),Lt(f.id,{preserveBlock:!0}),Vt(r.id),qs(),$("Bloc ajout\xE9")}function cn(e){var r,c;if(!f)return;let t=(f.blocks||[]).filter(p=>p.id!==e),o=e===Oe?((r=t[0])==null?void 0:r.id)||null:Oe||((c=t[0])==null?void 0:c.id)||null;is(t),Oe=o,Lt(f.id,{preserveBlock:!0}),Oe?Vt(Oe):(Ys(null),Es(null)),$("Bloc supprim\xE9")}function eo(){ce&&(ce.classList.add("hidden"),ce.classList.remove("flex"),so=null,ms(ce))}function br(e){if(!ce){cn(e);return}so=e,ce.classList.remove("hidden"),ce.classList.add("flex"),us(ce,eo)}let xr=e=>{if(!e)return;let t=_t(e);oe=oe.map(o=>o.id===t.id?t:o),f=t,qt(t)},Lt=(e,t={})=>{var c,p;let o=oe.find(y=>y.id===e)||oe[0]||null;f=o?_t(o):null,Ne=(o==null?void 0:o.id)||null,(!t.preserveBlock||!f||!f.blocks.some(y=>y.id===Oe))&&(Oe=((p=(c=f==null?void 0:f.blocks)==null?void 0:c[0])==null?void 0:p.id)||null),Ne&&nr(Ne),Ot(oe,Ne),sn(f),Po(),ir(f),Nt(f),yt(f),Ys(as()),Es(Oe),ln(),As&&qs()},Ao=()=>window.matchMedia("(min-width: 1024px)").matches,dn=()=>{Dt&&(Ao()?(Dt.classList.add("is-open"),st==null||st.classList.add("hidden"),document.body.classList.remove("overflow-hidden")):Dt.classList.remove("is-open"))},wr=()=>{!Dt||Ao()||(Dt.classList.add("is-open"),st==null||st.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},To=()=>{Dt&&(Dt.classList.remove("is-open"),st==null||st.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))},Sr=()=>{!d||!n||(d.classList.remove("hidden"),n.classList.add("hidden"),G&&(G.textContent=""),to=!1,w&&(w.value="",w.focus()),j&&(j.value=""),z&&(z.value=""))},un=()=>{!d||!n||(d.classList.add("hidden"),n.classList.remove("hidden"),G&&(G.textContent=""),to=!1,d.reset())},Lr=()=>{!w||!z||to&&z.value.trim().length>0||(z.value=tn(w.value))},oe=[],Ne=null,to=!1,f=null,Oe=null,As=!1,so=null,Io="",$o=!1,Ts=null,It=[],kr=e=>{let t={...e,props:Array.isArray(e.props)?e.props:[],settings:{...e.settings||{}}};return(t.type||"").toLowerCase()==="collectiongrid"&&(t.collectionId=t.collectionId||t.settings.collectionId||"",t.settings.collectionId=t.collectionId,t.settings.limit=t.settings.limit||6),t},_t=e=>{var t,o,r,c,p;return{...e,blocks:(e.blocks||[]).map(y=>kr(y)),seo:{title:(((t=e.seo)==null?void 0:t.title)||"").trim(),description:(((o=e.seo)==null?void 0:o.description)||"").trim(),indexed:typeof((r=e.seo)==null?void 0:r.indexed)=="boolean"?e.seo.indexed:null},accessibility:{showInMainNav:((c=e.accessibility)==null?void 0:c.showInMainNav)!==!1,mainLabel:(((p=e.accessibility)==null?void 0:p.mainLabel)||"").trim()}}},Er=async()=>{if(!Qo){It=[],oo();return}try{let e=await fetch(Qo,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les collections.");let t=await e.json().catch(()=>[]);It=Array.isArray(t)?t:[];let o=(be==null?void 0:be.value)||"";oo(o)}catch(e){console.error("[design] collections load",e),$("Collections indisponibles."),It=[],oo()}},jo=e=>{if(!ct)return;if(!e){ct.textContent=It.length?"S\xE9lectionnez une collection pour afficher ses informations.":"Aucune collection disponible. Ajoutez-en depuis l\u2019onglet Contenus.";return}let t=It.find(r=>r.id===e);if(!t){ct.textContent=`Collection ${e}`;return}let o=[];t.description&&o.push(t.description),t.type&&o.push(`Type\xA0: ${t.type}`),ct.textContent=o.join(" \xB7 ")||`Collection ${t.name||t.id}`},oo=(e="")=>{if(be){if(be.innerHTML="",!It.length){be.disabled=!0;let t=document.createElement("option");t.value="",t.textContent="Aucune collection disponible",be.appendChild(t),jo("");return}if(be.disabled=!1,e&&!It.some(t=>t.id===e)){let t=document.createElement("option");t.value=e,t.textContent=e,be.appendChild(t)}It.forEach(t=>{let o=document.createElement("option");o.value=t.id;let r=t.name||t.id;o.textContent=t.type?`${r} \xB7 ${t.type}`:r,o.dataset.description=t.description||"",be.appendChild(o)}),e&&(be.value=e),jo(be.value||"")}};Er(),dn(),Ws.forEach(e=>{e.addEventListener("click",wr)}),Ks.forEach(e=>{e.addEventListener("click",To)}),st==null||st.addEventListener("click",To),window.addEventListener("resize",()=>{dn(),ln()}),n==null||n.addEventListener("click",Sr),ie==null||ie.addEventListener("click",un),w==null||w.addEventListener("input",Lr),z==null||z.addEventListener("input",()=>{G&&(G.textContent=""),to=!0}),d==null||d.addEventListener("submit",async e=>{if(e.preventDefault(),!vt){G&&(G.textContent="Aucun site s\xE9lectionn\xE9.");return}if(!w||!z)return;let t=w.value.trim(),o=(j==null?void 0:j.value.trim())||t,r=tn(z.value.trim()||t);if(!t||!r){G&&(G.textContent="Nom et slug sont requis.");return}G&&(G.textContent=""),Q&&(Q.disabled=!0,Q.textContent="Cr\xE9ation...");try{let c=await zs({name:t,title:o,slug:r});if(!c||!c.id)throw new Error("R\xE9ponse invalide.");oe=[...oe,_t(c)],un(),$("Page cr\xE9\xE9e"),Lt(c.id)}catch(c){console.error("[design] create page failed",c),G&&(G.textContent=c.message||"Impossible de cr\xE9er la page.")}finally{Q&&(Q.disabled=!1,Q.textContent="Cr\xE9er")}});let Bo=()=>{_e&&(_e.value=""),dt&&(dt.classList.add("hidden"),dt.textContent="")},mn=()=>{if(!_e)return null;let e=_e.value.trim();if(!e)return dt&&dt.classList.add("hidden"),null;try{let t=JSON.parse(e);return dt&&dt.classList.add("hidden"),t}catch(t){return dt&&(dt.classList.remove("hidden"),dt.textContent=`\u274C JSON invalide : ${t.message}`),null}},Cr=()=>{if(!_e)return;let e=_e.value.trim();if(e)try{let t=JSON.parse(e);_e.value=JSON.stringify(t,null,2),mn()}catch{}},Is=()=>{if(Ze)if(Tt==="upload")Ze.disabled=gt.length===0;else if(Tt==="paste"){let e=mn();Ze.disabled=!e}else Ze.disabled=!0},qr=()=>{xe&&(xe.classList.remove("hidden"),xe.classList.add("flex"),gt=[],Tt="upload",Mo(),Bo(),Ce&&Ce.classList.add("hidden"),Ie&&(Ie.innerHTML=""),Is(),os.forEach(e=>{e.dataset.importTab==="upload"?(e.classList.add("bg-[#9C6BFF]","text-white"),e.classList.remove("border","border-slate-200","text-slate-700")):(e.classList.remove("bg-[#9C6BFF]","text-white"),e.classList.add("border","border-slate-200","text-slate-700"))}),Ss.forEach(e=>{e.dataset.importPanel==="upload"?e.classList.remove("hidden"):e.classList.add("hidden")}),us(xe,Fo))},Fo=()=>{xe&&(xe.classList.add("hidden"),xe.classList.remove("flex"),gt=[],Bo(),ms(xe))},Mo=()=>{if(!(!ze||!St)){if(gt.length===0){ze.classList.add("hidden"),Is();return}ze.classList.remove("hidden"),St.innerHTML=gt.map(e=>`<li class="flex items-center gap-2"><span class="text-lg">\u{1F4C4}</span>${e.name}</li>`).join(""),Is()}},fn=e=>{let t=Array.from(e).filter(o=>o.type==="application/json"||o.name.endsWith(".json"));if(t.length===0){$("Aucun fichier JSON valide.");return}gt=t,Mo()},Ar=async()=>{var o,r,c,p,y,B,_,le,Se,Ye,bt;if(!vt)return;let e=[];if(console.log("[import] activeImportTab:",Tt),Tt==="paste"){let Ee=(o=_e==null?void 0:_e.value)==null?void 0:o.trim();if(console.log("[import] paste text length:",Ee==null?void 0:Ee.length),!Ee){$("Aucun JSON \xE0 importer."),Ce&&Ie&&(Ce.classList.remove("hidden"),Ie.innerHTML='<p class="text-amber-600">\u26A0 Le champ de texte est vide.</p>');return}try{let F=JSON.parse(Ee);console.log("[import] parsed JSON:",F),console.log("[import] parsed type:",typeof F,Array.isArray(F)?"array":"not array"),F&&!Array.isArray(F)&&F.pages?(console.log("[import] detected pages+collections format"),e=F):Array.isArray(F)?e.push(...F):e.push(F),console.log("[import] pagesData prepared:",e)}catch(F){let ut=F.message.match(/position (\d+)/),Fe=F.message;if(ut){let ue=parseInt(ut[1],10),nt=Ee.substring(0,ue).split(`
`),mt=nt.length,He=nt[nt.length-1].length+1;Fe=`Ligne ${mt}, colonne ${He}: ${F.message}`}$(`Erreur JSON : ${Fe}`,"error"),console.error("[import] paste parse error",F),Ce&&Ie&&(Ce.classList.remove("hidden"),Ie.innerHTML=`
              <div class="text-rose-600">
                <p class="font-medium">\u2717 Erreur de syntaxe JSON</p>
                <p class="text-xs mt-1">${Fe}</p>
                <p class="text-xs mt-2 text-slate-500">V\xE9rifiez les virgules, guillemets et accolades.</p>
              </div>
            `);return}}else if(Tt==="upload"){if(gt.length===0)return;let Ee=[];for(let F of gt){let ut=await F.text();try{let Fe=JSON.parse(ut);Array.isArray(Fe)?e.push(...Fe):e.push(Fe)}catch(Fe){let ue=Fe.message.match(/position (\d+)/),nt=Fe.message;if(ue){let mt=parseInt(ue[1],10);nt=`Ligne ${ut.substring(0,mt).split(`
`).length}: ${Fe.message}`}Ee.push({file:F.name,error:nt}),console.error("[import] parse error",F.name,Fe)}}if(Ee.length>0){if(Ce&&Ie){Ce.classList.remove("hidden");let F='<div class="text-rose-600"><p class="font-medium">\u2717 Erreurs de syntaxe JSON</p><ul class="ml-4 text-xs mt-1">';Ee.forEach(ut=>{F+=`<li><strong>${ut.file}</strong>: ${ut.error}</li>`}),F+="</ul></div>",e.length>0&&(F+=`<p class="text-amber-600 mt-2 text-sm">\u26A0 ${e.length} page(s) valide(s) seront import\xE9e(s)</p>`),Ie.innerHTML=F}if(e.length===0){$("Tous les fichiers contiennent des erreurs JSON","error");return}}}else return;let t=Array.isArray(e)?e.length>0:e&&(((r=e.pages)==null?void 0:r.length)>0||e.title);if(console.log("[import] hasData check:",t,"pagesData:",e),!t){$("Aucune page valide \xE0 importer."),Ce&&Ie&&(Ce.classList.remove("hidden"),Ie.innerHTML=`
            <div class="text-amber-600">
              <p class="font-medium">\u26A0 Aucune page d\xE9tect\xE9e</p>
              <p class="text-xs mt-1">Le JSON doit contenir :</p>
              <ul class="text-xs ml-4 mt-1 list-disc">
                <li>Un objet page avec "title" : <code>{"title": "Ma page", ...}</code></li>
                <li>Un tableau de pages : <code>[{"title": "Page 1"}, {"title": "Page 2"}]</code></li>
                <li>Ou un objet combin\xE9 : <code>{"pages": [...], "collections": {...}}</code></li>
              </ul>
            </div>
          `);return}Ze&&(Ze.disabled=!0,Ze.textContent="Import..."),console.log("[import] Sending to server:",JSON.stringify(e).substring(0,500));try{let Ee=await fetch(`${vt}/import`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(e)});console.log("[import] Server response status:",Ee.status);let F=await Ee.json();if(console.log("[import] Server response body:",F),!Ee.ok)throw Ce&&Ie&&(Ce.classList.remove("hidden"),Ie.innerHTML=`
              <div class="text-rose-600">
                <p class="font-medium">\u2717 Erreur serveur</p>
                <p class="text-xs mt-1">${F.message||"Erreur inconnue"}</p>
                ${F.details?`<p class="text-xs mt-1 text-slate-500">${F.details}</p>`:""}
              </div>
            `),new Error(F.message||"Erreur serveur");if(Ce&&Ie){Ce.classList.remove("hidden");let ue="",nt=((c=F.imported)==null?void 0:c.length)>0||((p=F.collectionsCreated)==null?void 0:p.length)>0,mt=((y=F.errors)==null?void 0:y.length)>0;nt&&!mt?ue+='<div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-2"><p class="text-green-800 font-medium">\u2713 Import r\xE9ussi</p></div>':nt&&mt?ue+='<div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-2"><p class="text-amber-800 font-medium">\u26A0 Import partiel</p></div>':mt&&(ue+='<div class="bg-rose-50 border border-rose-200 rounded-lg p-3 mb-2"><p class="text-rose-800 font-medium">\u2717 Import \xE9chou\xE9</p></div>'),F.collectionsCreated&&F.collectionsCreated.length>0&&(ue+=`<p class="text-violet-700 mt-2">\u2713 ${F.collectionsCreated.length} collection(s) cr\xE9\xE9e(s)</p>`,ue+='<ul class="ml-4 text-xs text-slate-600">',F.collectionsCreated.forEach(He=>{ue+=`<li>${He.name} (${He.itemsCount} item${He.itemsCount>1?"s":""})</li>`}),ue+="</ul>"),F.imported&&F.imported.length>0&&(ue+=`<p class="text-green-700 mt-2">\u2713 ${F.imported.length} page(s) import\xE9e(s)</p>`,ue+='<ul class="ml-4 text-xs text-slate-600">',F.imported.forEach(He=>{ue+=`<li><strong>${He.title}</strong> \u2192 ${He.slug} (${He.action==="updated"?"mise \xE0 jour":"cr\xE9\xE9e"})</li>`}),ue+="</ul>"),F.errors&&F.errors.length>0&&(ue+=`<p class="text-rose-600 mt-3 font-medium">\u2717 ${F.errors.length} erreur(s)</p>`,ue+='<ul class="ml-4 text-xs text-rose-600 space-y-1 mt-1">',F.errors.forEach(He=>{ue+=`<li class="bg-rose-50 p-2 rounded"><strong>${He.title}</strong><br/><span class="text-rose-500">${He.error}</span></li>`}),ue+="</ul>"),Ie.innerHTML=ue}let ut=((B=F.imported)==null?void 0:B.length)>0||((_=F.collectionsCreated)==null?void 0:_.length)>0,Fe=((le=F.errors)==null?void 0:le.length)>0;if(F.imported&&F.imported.length>0&&(oe=await Pt(),Ot(oe,Ne),oe.length>0&&!Ne&&Lt(oe[0].id)),ut&&!Fe){let ue=(Se=F.collectionsCreated)!=null&&Se.length?` + ${F.collectionsCreated.length} collection(s)`:"";$(`\u2713 Import r\xE9ussi : ${((Ye=F.imported)==null?void 0:Ye.length)||0} page(s)${ue}`,"success")}else ut&&Fe?$(`\u26A0 Import partiel : ${((bt=F.imported)==null?void 0:bt.length)||0} page(s), ${F.errors.length} erreur(s)`,"warning"):Fe&&$(`\u2717 Import \xE9chou\xE9 : ${F.errors.length} erreur(s)`,"error");gt=[],Mo(),Bo()}catch(Ee){console.error("[import] failed",Ee),$(Ee.message||"Erreur import","error")}finally{Ze&&(Ze.disabled=!1,Ze.textContent="Importer")}};Be==null||Be.addEventListener("click",qr),Ke.forEach(e=>e.addEventListener("click",Fo)),xe==null||xe.addEventListener("click",e=>{e.target===xe&&Fo()}),Re==null||Re.addEventListener("change",e=>{fn(e.target.files)}),we==null||we.addEventListener("dragover",e=>{e.preventDefault(),we.classList.add("border-[#9C6BFF]","bg-[#9C6BFF]/10")}),we==null||we.addEventListener("dragleave",e=>{e.preventDefault(),we.classList.remove("border-[#9C6BFF]","bg-[#9C6BFF]/10")}),we==null||we.addEventListener("drop",e=>{e.preventDefault(),we.classList.remove("border-[#9C6BFF]","bg-[#9C6BFF]/10"),fn(e.dataTransfer.files)}),Ze==null||Ze.addEventListener("click",Ar),_e==null||_e.addEventListener("input",()=>{Is()}),Zt==null||Zt.addEventListener("click",Cr),os.forEach(e=>{e.addEventListener("click",()=>{let t=e.dataset.importTab;Tt=t,os.forEach(o=>{o.dataset.importTab===t?(o.classList.add("bg-[#9C6BFF]","text-white"),o.classList.remove("border","border-slate-200","text-slate-700")):(o.classList.remove("bg-[#9C6BFF]","text-white"),o.classList.add("border","border-slate-200","text-slate-700"))}),Ss.forEach(o=>{o.dataset.importPanel===t?o.classList.remove("hidden"):o.classList.add("hidden")}),Is()})}),ns==null||ns.addEventListener("click",async()=>{if(!Ls)return;let e=Ls.textContent||"";try{await navigator.clipboard.writeText(e),$("Template copi\xE9 !")}catch(t){console.error("[import] copy failed",t),$("Erreur copie")}}),rs==null||rs.addEventListener("click",Xs),ht==null||ht.addEventListener("click",pr),ot==null||ot.addEventListener("click",e=>{e.target===ot&&Xs()}),pe==null||pe.addEventListener("click",e=>{e.stopPropagation(),vr()}),document.addEventListener("click",e=>{As&&(ve!=null&&ve.contains(e.target)||pe!=null&&pe.contains(e.target)||qs())}),et.forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();let o=e.dataset.blockAdd;yr(o)})}),ge==null||ge.addEventListener("click",()=>{eo()}),tt==null||tt.addEventListener("click",()=>{so&&cn(so),eo()}),ce==null||ce.addEventListener("click",e=>{e.target===ce&&eo()}),A==null||A.addEventListener("input",e=>{var r,c,p,y;let t=e.target;if(!t||!t.name)return;if(t.name==="group-columns-mobile"||t.name==="group-columns-desktop"){let B=((r=A.querySelector('[name="group-columns-mobile"]'))==null?void 0:r.value)||"1",_=((c=A.querySelector('[name="group-columns-desktop"]'))==null?void 0:c.value)||"3";Kt(B,_)}if(t.name==="collection-columns-mobile"||t.name==="collection-columns-desktop"){let B=((p=A.querySelector('[name="collection-columns-mobile"]'))==null?void 0:p.value)||"1",_=((y=A.querySelector('[name="collection-columns-desktop"]'))==null?void 0:y.value)||"3";ts(B,_)}let o=t.closest("[data-block-panel]");if(o&&o.dataset.blockPanel==="appearance"){let B=as(),_=We(B);if(B&&_){let le=Ut(_);Gs(B.id,le)}}}),A==null||A.addEventListener("change",e=>{var r,c;let t=e.target;if(!t||!t.name)return;if(t.hasAttribute("data-color-select")){let p=t.options[t.selectedIndex],y=((r=p==null?void 0:p.dataset)==null?void 0:r.color)||"#ffffff",B=(c=t.closest(".relative"))==null?void 0:c.querySelector("[data-color-preview]");B&&(y==="transparent"?B.style.background="repeating-conic-gradient(#ccc 0% 25%, white 0% 50%) 50% / 8px 8px":(B.style.backgroundColor=y,B.style.background=""))}let o=t.closest("[data-block-panel]");if(o&&o.dataset.blockPanel==="appearance"){let p=as(),y=We(p);if(p&&y){let B=Ut(y);Gs(p.id,B)}}}),be==null||be.addEventListener("change",e=>{let t=e.target;jo((t==null?void 0:t.value)||"")}),A==null||A.addEventListener("submit",ss),Pe==null||Pe.addEventListener("click",e=>{e.preventDefault();let t=as();t&&Vs(t)}),h==null||h.addEventListener("load",()=>{$o=!0,At("\xC0 jour"),Es(Oe)}),x==null||x.addEventListener("click",()=>{let e=window.open("","_blank");if(!e)return;e.opener=null;let t=e.document;t.open(),t.write(Io||Rt()),t.close()});let pn=e=>{var t,o,r;ne&&(e?(ne.classList.remove("hidden"),f&&(E&&(E.value=((t=f.seo)==null?void 0:t.title)||""),C&&(C.value=((o=f.seo)==null?void 0:o.description)||""),L&&(L.checked=((r=f.seo)==null?void 0:r.indexed)!==!1))):ne.classList.add("hidden"))},no=(e,t="muted")=>{if(!M)return;let o=t==="success"?"text-emerald-600":t==="error"?"text-rose-600":"text-slate-500";M.textContent=e||"",M.className=`text-sm ${o}`};U==null||U.addEventListener("click",()=>{let e=ne&&!ne.classList.contains("hidden");pn(!e)}),se==null||se.addEventListener("click",()=>pn(!1)),g==null||g.addEventListener("submit",async e=>{var t;if(e.preventDefault(),!f){no("Aucune page active.","error");return}P&&(P.disabled=!0),no("");try{let o={title:((E==null?void 0:E.value)||"").trim(),description:((C==null?void 0:C.value)||"").trim(),indexed:(t=L==null?void 0:L.checked)!=null?t:!0},r={...f,seo:o},c=await qt(r);c&&(f=c,no("SEO enregistr\xE9.","success"),$("SEO mis \xE0 jour"),Nt(f))}catch(o){console.error("[seo] save failed",o),no(o.message||"Erreur lors de la sauvegarde.","error")}finally{P&&(P.disabled=!1)}});let Po=()=>{var e,t;if(!(!k&&!T)){if(!f){k&&(k.checked=!0),T&&(T.value="");return}k&&(k.checked=((e=f.accessibility)==null?void 0:e.showInMainNav)!==!1),T&&(T.value=((t=f.accessibility)==null?void 0:t.mainLabel)||"")}},gn=e=>{H&&(e?(Po(),H.classList.remove("hidden")):H.classList.add("hidden"))},ro=(e,t="muted")=>{if(!te)return;let o=t==="success"?"text-emerald-600":t==="error"?"text-rose-600":"text-slate-500";te.textContent=e||"",te.className=`text-sm ${o}`};N==null||N.addEventListener("click",()=>{let e=H&&!H.classList.contains("hidden");gn(!e)}),u==null||u.addEventListener("click",()=>gn(!1)),q==null||q.addEventListener("submit",async e=>{var t;if(e.preventDefault(),!f){ro("Aucune page active.","error");return}K&&(K.disabled=!0),ro("");try{let o={showInMainNav:(t=k==null?void 0:k.checked)!=null?t:!0,mainLabel:((T==null?void 0:T.value)||"").trim()},r={...f,accessibility:o},c=await qt(r);c&&(f=c,Po(),ro("Accessibilit\xE9 enregistr\xE9e.","success"),$("Accessibilit\xE9 mise \xE0 jour"),Ot(oe,Ne),Nt(f))}catch(o){console.error("[accessibility] save failed",o),ro(o.message||"Erreur lors de la sauvegarde.","error")}finally{K&&(K.disabled=!1)}});let hn=e=>{he&&(e?(he.classList.remove("hidden"),f&&(fe&&(fe.value=f.name||""),ke&&(ke.value=f.title||""),Ae&&(Ae.value=f.slug||""),D&&(D.value=f.description||""))):he.classList.add("hidden"))},ls=(e,t="muted")=>{if(!b)return;let o=t==="success"?"text-emerald-600":t==="error"?"text-rose-600":"text-slate-500";b.textContent=e||"",b.className=`text-sm ${o}`};X==null||X.addEventListener("click",()=>{let e=he&&!he.classList.contains("hidden");hn(!e)}),me==null||me.addEventListener("click",()=>hn(!1)),$e==null||$e.addEventListener("submit",async e=>{if(e.preventDefault(),!f){ls("Aucune page active.","error");return}v&&(v.disabled=!0),ls("");try{let t=((fe==null?void 0:fe.value)||"").trim(),o=((ke==null?void 0:ke.value)||"").trim(),r=((Ae==null?void 0:Ae.value)||"").trim(),c=((D==null?void 0:D.value)||"").trim();if(!o){ls("Le titre est requis.","error"),v&&(v.disabled=!1);return}if(!r||!r.startsWith("/")){ls("Le slug doit commencer par /.","error"),v&&(v.disabled=!1);return}let p={...f,name:t||o,title:o,slug:r,description:c},y=await qt(p);y&&(f=y,oe=oe.map(B=>B.id===y.id?y:B),ls("Propri\xE9t\xE9s enregistr\xE9es.","success"),$("Page mise \xE0 jour"),sn(f),Ot(oe,Ne),Nt(f))}catch(t){console.error("[page-props] save failed",t),ls(t.message||"Erreur lors de la sauvegarde.","error")}finally{v&&(v.disabled=!1)}});let Tr=e=>{let t=e.target.closest("[data-block-item]");if(!t||!Qs()){e.preventDefault();return}if($t=t.dataset.blockId||null,!$t){e.preventDefault();return}e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",$t),requestAnimationFrame(()=>{t.classList.add("opacity-50","scale-[0.98]","shadow-lg","ring-2","ring-[#9C6BFF]")})},vn=()=>{S==null||S.querySelectorAll("[data-block-item]").forEach(e=>{e.classList.remove("opacity-50","scale-[0.98]","shadow-lg","ring-2","ring-[#9C6BFF]","border-t-4","border-b-4","border-t-[#9C6BFF]","border-b-[#9C6BFF]","pt-6","pb-6")})},Ir=()=>{$t=null,vn()},$r=e=>{if(!$t||!Qs())return;let t=e.target.closest("[data-block-item]");if(!t||t.dataset.blockId===$t)return;e.preventDefault(),e.dataTransfer.dropEffect="move";let o=t.getBoundingClientRect(),r=o.top+o.height/2,c=e.clientY<r;S==null||S.querySelectorAll("[data-block-item]").forEach(p=>{p!==t&&p.dataset.blockId!==$t&&p.classList.remove("border-t-4","border-b-4","border-t-[#9C6BFF]","border-b-[#9C6BFF]","pt-6","pb-6")}),t.classList.remove("border-t-4","border-b-4","border-t-[#9C6BFF]","border-b-[#9C6BFF]","pt-6","pb-6"),c?t.classList.add("border-t-4","border-t-[#9C6BFF]","pt-6"):t.classList.add("border-b-4","border-b-[#9C6BFF]","pb-6"),t.dataset.dropPosition=c?"before":"after"},jr=e=>{let t=e.target.closest("[data-block-item]");if(!t)return;let o=e.relatedTarget;o&&t.contains(o)||(t.classList.remove("border-t-4","border-b-4","border-t-[#9C6BFF]","border-b-[#9C6BFF]","pt-6","pb-6"),delete t.dataset.dropPosition)},Br=e=>{if(!$t||!Qs())return;e.preventDefault();let t=e.target.closest("[data-block-item]"),o=$t,r=(t==null?void 0:t.dataset.dropPosition)||"after";$t=null,vn();let c=(t==null?void 0:t.dataset.blockId)||null;!c||o===c||gr(o,c,r)},$t=null;S==null||S.addEventListener("dragstart",Tr),S==null||S.addEventListener("dragend",Ir),S==null||S.addEventListener("dragover",$r),S==null||S.addEventListener("dragleave",jr),S==null||S.addEventListener("drop",Br),ws(),document.addEventListener("ai-page-updated",async e=>{var t;console.log("[design] Rafra\xEEchissement d\xE9clench\xE9 par IA",e.detail);try{let o=await Pt();if(oe=(Array.isArray(o)?o:[]).map(r=>_t(r)),(t=e.detail)!=null&&t.pageId){let r=oe.find(c=>c.id===e.detail.pageId);r&&(f=r,Ne=r.id,Nt(f),yt(f),$("Page mise \xE0 jour par l'IA"))}else if(Ne){let r=oe.find(c=>c.id===Ne);r&&(f=r,Nt(f),yt(f))}}catch(o){console.error("[design] Erreur rafra\xEEchissement IA:",o)}})}function Dn(){var st,Ws,Ks;let s=document.querySelector("[data-collection-list]");if(!s)return;let a={empty:document.querySelector('[data-content-view="empty"]'),header:document.querySelector('[data-content-view="header"]'),collection:document.querySelector('[data-content-view="collection"]'),footer:document.querySelector('[data-content-view="footer"]')},i=document.querySelectorAll("[data-content-section]"),m=document.querySelectorAll("[data-content-section-trigger]"),h=document.querySelector("[data-content-drawer]"),x=document.querySelector("[data-content-drawer-backdrop]"),R=document.querySelectorAll("[data-content-drawer-open]"),W=document.querySelectorAll("[data-content-drawer-close]"),U=document.querySelector("[data-header-status]"),ne=document.querySelector("[data-footer-status]"),se=document.querySelector("[data-collection-count]"),g={logo:document.querySelector('[name="header-logo"]'),logoAlt:document.querySelector('[name="header-logo-alt"]'),logoUrl:document.querySelector('[name="header-logo-url"]'),ctaText:document.querySelector('[name="header-cta-text"]'),ctaUrl:document.querySelector('[name="header-cta-url"]'),ctaStyle:document.querySelector('[name="header-cta-style"]'),position:document.querySelector('[name="header-position"]'),bg:document.querySelector('[name="header-bg"]')},E=document.querySelector("[data-header-nav-list]"),C=document.querySelector("[data-header-nav-add]"),L=document.querySelector("[data-header-save]"),M=document.querySelector("[data-template-header-nav-item]"),P=document.querySelector("[data-header-pages-list]"),N=[],H=[],u={linkedin:document.querySelector('[name="footer-social-linkedin"]'),twitter:document.querySelector('[name="footer-social-twitter"]'),instagram:document.querySelector('[name="footer-social-instagram"]'),facebook:document.querySelector('[name="footer-social-facebook"]'),youtube:document.querySelector('[name="footer-social-youtube"]'),github:document.querySelector('[name="footer-social-github"]'),copyright:document.querySelector('[name="footer-copyright"]'),legalUrl:document.querySelector('[name="footer-legal-url"]'),privacyUrl:document.querySelector('[name="footer-privacy-url"]'),bg:document.querySelector('[name="footer-bg"]'),columnsCount:document.querySelector('[name="footer-columns-count"]')},q=document.querySelector("[data-footer-columns-list]"),k=document.querySelector("[data-footer-column-add]"),T=document.querySelector("[data-footer-save]"),te=document.querySelector("[data-template-footer-column]"),K=document.querySelector("[data-template-footer-link]"),X=null,he={nav:[],logo:{},cta:{},style:{}},me={columns:[],socials:{},copyright:"",legal:{},style:{}},$e=qe((O==null?void 0:O.slugValue)||Y.slug||""),fe=$e,ke=$e?`/api/sites/${encodeURIComponent($e)}/layout`:null,Ae=n=>{Object.entries(a).forEach(([d,w])=>{w&&w.classList.toggle("hidden",d!==n)}),i.forEach(d=>{d.dataset.contentSection===n?d.dataset.active="true":delete d.dataset.active}),X=n},D=()=>{h==null||h.classList.add("is-open"),h&&(h.style.transform="translateX(0)"),x==null||x.classList.remove("hidden"),document.body.classList.add("overflow-hidden")},b=()=>{h==null||h.classList.remove("is-open"),h&&(h.style.transform=""),x==null||x.classList.add("hidden"),document.body.classList.remove("overflow-hidden")};R.forEach(n=>n.addEventListener("click",D)),W.forEach(n=>n.addEventListener("click",b)),x==null||x.addEventListener("click",b),i.forEach(n=>{n.addEventListener("click",()=>{let d=n.dataset.contentSection;(d==="header"||d==="footer")&&Ae(d),b()})}),m.forEach(n=>{n.addEventListener("click",()=>{let d=n.dataset.contentSectionTrigger;d&&Ae(d)})});let v=async()=>{if(!(!fe||!P))try{let n=await fetch(`/api/sites/${fe}/pages`,{credentials:"include"});if(!n.ok)throw new Error("Erreur chargement pages");N=await n.json(),S()}catch(n){console.error("[header] load pages error",n),P.innerHTML='<p class="text-xs text-red-500">Erreur chargement pages</p>'}},S=()=>{if(P){if(P.innerHTML="",N.length===0){P.innerHTML='<p class="text-xs text-slate-400 italic">Aucune page disponible</p>';return}N.forEach(n=>{let d=n.slug||n.id,w=n.name||n.title||d,j=d==="index"?"/":`/${d}`,z=H.some(Q=>Q.url===j),ie=document.createElement("label");ie.className="flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer transition-colors",ie.innerHTML=`
          <input type="checkbox" name="nav-page" value="${j}" data-page-title="${w}"
                 class="w-4 h-4 rounded border-slate-300 text-violet-600 focus:ring-violet-500"
                 ${z?"checked":""}>
          <span class="flex-1 text-sm text-slate-700">${w}</span>
          <span class="text-xs text-slate-400">${j}</span>
        `;let G=ie.querySelector("input");G.addEventListener("change",()=>{G.checked?H.some(Q=>Q.url===j)||H.push({label:w,url:j}):H=H.filter(Q=>Q.url!==j)}),P.appendChild(ie)})}},Z=()=>{var d,w,j,z,ie,G,Q,Be,xe,Ke,we,Re,ze;let n=[];return P==null||P.querySelectorAll('input[name="nav-page"]:checked').forEach(St=>{let Ce=St.value,Ie=St.dataset.pageTitle||Ce;n.push({label:Ie,url:Ce})}),{logo:{src:((w=(d=g.logo)==null?void 0:d.value)==null?void 0:w.trim())||"",alt:((z=(j=g.logoAlt)==null?void 0:j.value)==null?void 0:z.trim())||"",url:((G=(ie=g.logoUrl)==null?void 0:ie.value)==null?void 0:G.trim())||"/"},nav:n,cta:{text:((Be=(Q=g.ctaText)==null?void 0:Q.value)==null?void 0:Be.trim())||"",url:((Ke=(xe=g.ctaUrl)==null?void 0:xe.value)==null?void 0:Ke.trim())||"",style:((we=g.ctaStyle)==null?void 0:we.value)||"primary"},style:{position:((Re=g.position)==null?void 0:Re.value)||"static",bg:((ze=g.bg)==null?void 0:ze.value)||"bg-white"}}},re=async n=>{var w,j,z,ie,G,Q,Be,xe,Ke,we,Re;if(!n)return;g.logo&&(g.logo.value=((w=n.logo)==null?void 0:w.src)||""),g.logoAlt&&(g.logoAlt.value=((j=n.logo)==null?void 0:j.alt)||""),g.logoUrl&&(g.logoUrl.value=((z=n.logo)==null?void 0:z.url)||"/"),g.ctaText&&(g.ctaText.value=((ie=n.cta)==null?void 0:ie.text)||""),g.ctaUrl&&(g.ctaUrl.value=((G=n.cta)==null?void 0:G.url)||""),g.ctaStyle&&(g.ctaStyle.value=((Q=n.cta)==null?void 0:Q.style)||"primary"),g.position&&(g.position.value=((Be=n.style)==null?void 0:Be.position)||"static"),g.bg&&(g.bg.value=((xe=n.style)==null?void 0:xe.bg)||"bg-white"),H=n.nav||[],await v();let d=((Ke=n.logo)==null?void 0:Ke.src)||((we=n.nav)==null?void 0:we.length)>0||((Re=n.cta)==null?void 0:Re.text);U&&(U.classList.toggle("bg-green-500",!!d),U.classList.toggle("bg-slate-300",!d),U.title=d?"Configur\xE9":"Non configur\xE9")};L==null||L.addEventListener("click",async()=>{if(ke){L.disabled=!0,L.textContent="Enregistrement...";try{let n=Z();if(!(await fetch(`${ke}/header`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(n)})).ok)throw new Error("Erreur serveur");he=n,re(n),$("Header enregistr\xE9")}catch(n){console.error("[header] save error",n),$("Erreur lors de l'enregistrement","error")}finally{L.disabled=!1,L.textContent="Enregistrer"}}});let pe=(n,d="",w="")=>{if(!K||!n)return;let j=K.content.cloneNode(!0),z=j.querySelector("[data-footer-link]"),ie=j.querySelector('[name="link-label"]'),G=j.querySelector('[name="link-url"]'),Q=j.querySelector("[data-link-remove]");ie&&(ie.value=d),G&&(G.value=w),Q==null||Q.addEventListener("click",()=>z==null?void 0:z.remove()),n.appendChild(j)},ve=(n="",d=[])=>{if(!te||!q)return;let w=te.content.cloneNode(!0),j=w.querySelector("[data-footer-column]"),z=w.querySelector('[name="column-title"]'),ie=w.querySelector("[data-column-links]"),G=w.querySelector("[data-column-link-add]"),Q=w.querySelector("[data-column-remove]");z&&(z.value=n),d.forEach(Be=>pe(ie,Be.label,Be.url)),G==null||G.addEventListener("click",()=>pe(ie)),Q==null||Q.addEventListener("click",()=>j==null?void 0:j.remove()),q.appendChild(w)},et=()=>{var d,w,j,z,ie,G,Q,Be,xe,Ke,we,Re,ze,St,Ce,Ie,Ze,os,Ss,ns;let n=[];return q==null||q.querySelectorAll("[data-footer-column]").forEach(Ls=>{var dt,gt;let _e=((gt=(dt=Ls.querySelector('[name="column-title"]'))==null?void 0:dt.value)==null?void 0:gt.trim())||"",Zt=[];Ls.querySelectorAll("[data-footer-link]").forEach(Tt=>{var rs,ht,zt,Zs;let ot=((ht=(rs=Tt.querySelector('[name="link-label"]'))==null?void 0:rs.value)==null?void 0:ht.trim())||"",ks=((Zs=(zt=Tt.querySelector('[name="link-url"]'))==null?void 0:zt.value)==null?void 0:Zs.trim())||"";(ot||ks)&&Zt.push({label:ot,url:ks})}),(_e||Zt.length>0)&&n.push({title:_e,links:Zt})}),{columns:n,socials:{linkedin:((w=(d=u.linkedin)==null?void 0:d.value)==null?void 0:w.trim())||"",twitter:((z=(j=u.twitter)==null?void 0:j.value)==null?void 0:z.trim())||"",instagram:((G=(ie=u.instagram)==null?void 0:ie.value)==null?void 0:G.trim())||"",facebook:((Be=(Q=u.facebook)==null?void 0:Q.value)==null?void 0:Be.trim())||"",youtube:((Ke=(xe=u.youtube)==null?void 0:xe.value)==null?void 0:Ke.trim())||"",github:((Re=(we=u.github)==null?void 0:we.value)==null?void 0:Re.trim())||""},copyright:((St=(ze=u.copyright)==null?void 0:ze.value)==null?void 0:St.trim())||"",legal:{url:((Ie=(Ce=u.legalUrl)==null?void 0:Ce.value)==null?void 0:Ie.trim())||"",privacyUrl:((os=(Ze=u.privacyUrl)==null?void 0:Ze.value)==null?void 0:os.trim())||""},style:{bg:((Ss=u.bg)==null?void 0:Ss.value)||"bg-slate-900 text-white",columnsCount:((ns=u.columnsCount)==null?void 0:ns.value)||"4"}}},ce=n=>{var w,j,z,ie,G,Q,Be,xe,Ke,we,Re;if(!n)return;u.linkedin&&(u.linkedin.value=((w=n.socials)==null?void 0:w.linkedin)||""),u.twitter&&(u.twitter.value=((j=n.socials)==null?void 0:j.twitter)||""),u.instagram&&(u.instagram.value=((z=n.socials)==null?void 0:z.instagram)||""),u.facebook&&(u.facebook.value=((ie=n.socials)==null?void 0:ie.facebook)||""),u.youtube&&(u.youtube.value=((G=n.socials)==null?void 0:G.youtube)||""),u.github&&(u.github.value=((Q=n.socials)==null?void 0:Q.github)||""),u.copyright&&(u.copyright.value=n.copyright||""),u.legalUrl&&(u.legalUrl.value=((Be=n.legal)==null?void 0:Be.url)||""),u.privacyUrl&&(u.privacyUrl.value=((xe=n.legal)==null?void 0:xe.privacyUrl)||""),u.bg&&(u.bg.value=((Ke=n.style)==null?void 0:Ke.bg)||"bg-slate-900 text-white"),u.columnsCount&&(u.columnsCount.value=((we=n.style)==null?void 0:we.columnsCount)||"4"),q&&(q.innerHTML=""),(n.columns||[]).forEach(ze=>ve(ze.title,ze.links));let d=((Re=n.columns)==null?void 0:Re.length)>0||n.copyright||Object.values(n.socials||{}).some(ze=>ze);ne&&(ne.classList.toggle("bg-green-500",!!d),ne.classList.toggle("bg-slate-300",!d),ne.title=d?"Configur\xE9":"Non configur\xE9")};k==null||k.addEventListener("click",()=>ve()),T==null||T.addEventListener("click",async()=>{if(ke){T.disabled=!0,T.textContent="Enregistrement...";try{let n=et();if(!(await fetch(`${ke}/footer`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(n)})).ok)throw new Error("Erreur serveur");me=n,ce(n),$("Footer enregistr\xE9")}catch(n){console.error("[footer] save error",n),$("Erreur lors de l'enregistrement","error")}finally{T.disabled=!1,T.textContent="Enregistrer"}}}),(async()=>{if(ke)try{let n=await fetch(ke,{credentials:"include"});if(n.ok){let d=await n.json();d.header&&(he=d.header,re(d.header)),d.footer&&(me=d.footer,ce(d.footer))}}catch(n){console.error("[layout] load error",n)}})();let ge=document.querySelector("[data-collection-empty]"),ae=document.querySelector("[data-collection-items-empty]"),Te=document.querySelector("[data-item-table-wrapper]"),je=document.querySelector("[data-item-table-body]"),Bt=document.querySelector("[data-collection-title]"),Ft=document.querySelector("[data-collection-description]"),ye=document.querySelector("[data-item-add]"),A=document.querySelector("[data-item-detail-empty]"),de=document.querySelector("[data-item-form]"),l=de?{title:de.querySelector('[name="item-title"]'),slug:de.querySelector('[name="item-slug"]'),excerpt:de.querySelector('[name="item-excerpt"]'),content:de.querySelector('[name="item-content"]'),image:de.querySelector('[name="item-image"]'),ctaText:de.querySelector('[name="item-cta-text"]'),ctaUrl:de.querySelector('[name="item-cta-url"]'),status:de.querySelector('[name="item-status"]')}:{},I=document.querySelector("[data-item-status-badge]"),V=document.querySelector("[data-item-delete]"),J=document.querySelector("[data-item-delete-modal]"),Ct=document.querySelector("[data-item-delete-cancel]"),wt=document.querySelector("[data-item-delete-confirm]"),ys=document.querySelector("[data-item-cancel]"),Gt=document.querySelector("[data-item-save]"),Wt="rounded-full px-3 py-1 text-xs font-semibold",bs=qe((O==null?void 0:O.slugValue)||Y.slug||""),be=bs?`/api/sites/${encodeURIComponent(bs)}/collections`:null,ct=[],Pe=[],Ue=null,De=null,at=!1,Ht=!1,Mt=null,xs=n=>{let d=(n||"").trim();if(!d)return"";if(d==="/")return"/";let j=d.replace(/^\//,"").split("/").map(z=>Jt(z||"")).filter(z=>z.length>0);return j.length?`/${j.join("/")}`:""},wo=n=>{if(!n)return"\u2014";let d=new Date(n);return Number.isNaN(d.getTime())?"\u2014":d.toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"})},Kt=()=>{let n=ct.find(d=>d.id===Ue);Bt&&(Bt.textContent=(n==null?void 0:n.name)||"S\xE9lectionnez une collection"),Ft&&(Ft.textContent=(n==null?void 0:n.description)||"")},ts=n=>{ae&&(ae.textContent=n||(Ue?"Aucun item dans cette collection pour le moment.":"Choisissez une collection dans le panneau de gauche."))},Pt=()=>{de&&(de.classList.add("hidden"),de.dataset.itemId=""),A==null||A.classList.remove("hidden"),I&&(I.className=`hidden ${Wt}`,I.textContent=""),V&&(V.disabled=!0)},zs=()=>{de&&(de.classList.remove("hidden"),A==null||A.classList.add("hidden"))},qt=()=>{ye&&(ye.disabled=!Ue,ye.disabled?ye.classList.add("opacity-60","pointer-events-none"):ye.classList.remove("opacity-60","pointer-events-none"))},ws=n=>{if(!I)return;if(!n){I.className=`hidden ${Wt}`,I.textContent="";return}let d=n.toLowerCase(),w="bg-slate-100 text-slate-600 border border-slate-200";d==="publi\xE9"||d==="publie"?w="bg-emerald-50 text-emerald-700 border border-emerald-100":d==="brouillon"&&(w="bg-amber-50 text-amber-700 border border-amber-100"),I.className=`${Wt} ${w}`,I.textContent=n},Os=()=>{if(s.innerHTML="",se&&(se.textContent=ct.length),!ct.length){ge==null||ge.classList.remove("hidden");return}ge==null||ge.classList.add("hidden"),ct.forEach(n=>{let d=n.id===Ue,w=document.createElement("button");w.type="button",w.dataset.collectionId=n.id,w.className=["w-full rounded-xl border px-3 py-2 text-left transition focus:outline-none focus:ring-2 focus:ring-[#9C6BFF]/40",d?"bg-[#F7F0FF] border-[#9C6BFF]/40 text-slate-900":"border-slate-200 text-slate-700 hover:border-[#9C6BFF]/40"].join(" "),w.setAttribute("role","option"),d?w.setAttribute("aria-current","true"):w.removeAttribute("aria-current"),w.innerHTML=`
          <div class="flex items-center justify-between gap-2">
            <div>
              <p class="text-sm font-semibold">${n.name||n.id}</p>
              <p class="text-xs text-slate-500">${n.description||""}</p>
            </div>
            <span class="text-[11px] uppercase tracking-wide text-slate-400">${n.type||""}</span>
          </div>
        `,w.addEventListener("click",()=>{Js(n.id),window.matchMedia("(min-width: 1024px)").matches||b()}),s.appendChild(w)})},We=()=>{if(je){if(je.innerHTML="",!Pe.length||!Ue){ae==null||ae.classList.remove("hidden"),ts(),Te==null||Te.classList.add("hidden");return}ae==null||ae.classList.add("hidden"),Te==null||Te.classList.remove("hidden"),Pe.forEach(n=>{let d=document.createElement("tr");d.dataset.itemId=n.id;let w=n.id===De&&!at;d.className=["cursor-pointer transition focus-within:bg-[#F7F0FF]/70 focus:outline-none",w?"bg-[#F7F0FF]/70":"hover:bg-slate-50"].join(" "),d.tabIndex=0,d.setAttribute("role","button"),w?d.setAttribute("aria-current","true"):d.removeAttribute("aria-current");let j=n.status||"Brouillon",z=j.toLowerCase(),ie=z==="publi\xE9"||z==="publie"?"bg-emerald-50 text-emerald-700 border border-emerald-100":"bg-amber-50 text-amber-700 border border-amber-100";d.innerHTML=`
          <td class="px-4 py-3 align-top">
            <div class="flex flex-col">
              <span class="text-sm font-semibold text-slate-900">${n.title||"Sans titre"}</span>
              <span class="text-xs text-slate-500">${n.summary||n.excerpt||""}</span>
            </div>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-600">${n.slug||""}</td>
          <td class="px-4 py-3 align-top">
            <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${ie}">
              ${j}
            </span>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-500">${wo(n.updatedAt||n.createdAt)}</td>
        `;let G=()=>{Vs(n.id)};d.addEventListener("click",G),d.addEventListener("keydown",Q=>{(Q.key==="Enter"||Q.key===" ")&&(Q.preventDefault(),G())}),je.appendChild(d)})}},Vs=n=>{let d=Pe.find(w=>w.id===n);d&&(De=d.id,at=!1,Ht=!0,Ut(d),We())},Ut=n=>{var d,w;if(!de||!n){Pt();return}zs(),de.dataset.itemId=n.id,l.title&&(l.title.value=n.title||""),l.slug&&(l.slug.value=n.slug||""),l.excerpt&&(l.excerpt.value=n.summary||n.excerpt||""),l.content&&(l.content.value=n.content||""),l.image&&(l.image.value=n.image||""),l.ctaText&&(l.ctaText.value=((d=n.cta)==null?void 0:d.text)||n.ctaText||""),l.ctaUrl&&(l.ctaUrl.value=((w=n.cta)==null?void 0:w.url)||n.ctaUrl||""),l.status&&(l.status.value=n.status||"Brouillon"),ws(n.status||"Brouillon"),V&&(V.disabled=!1)},At=()=>{var n;de&&(at=!0,De=null,Ht=!1,de.dataset.itemId="",de.reset(),l.status&&(l.status.value="Brouillon"),l.slug&&(l.slug.value=""),ws("Brouillon"),zs(),V&&(V.disabled=!0),(n=l.title)==null||n.focus())},So=()=>{var xe,Ke,we,Re,ze,St,Ce,Ie;let n=(((xe=l.title)==null?void 0:xe.value)||"").trim(),d=(((Ke=l.slug)==null?void 0:Ke.value)||"").trim(),w=(((we=l.excerpt)==null?void 0:we.value)||"").trim(),j=(((Re=l.content)==null?void 0:Re.value)||"").trim(),z=(((ze=l.image)==null?void 0:ze.value)||"").trim(),ie=(((St=l.ctaText)==null?void 0:St.value)||"").trim(),G=(((Ce=l.ctaUrl)==null?void 0:Ce.value)||"").trim(),Q=((Ie=l.status)==null?void 0:Ie.value)||"Brouillon",Be=ie||G?{text:ie,url:G}:null;return{title:n,slug:xs(d||n),summary:w,excerpt:w,content:j,image:z,status:Q,...Be&&{cta:Be}}},Rt=n=>{Gt&&(Gt.disabled=n,Gt.textContent=n?"Enregistrement\u2026":"Enregistrer"),V&&!at&&De&&(V.disabled=n)},Lo=async n=>{if(!be)return[];let d=await fetch(`${be}/${encodeURIComponent(n)}/items`,{headers:{Accept:"application/json"}});if(!d.ok){let j=await d.json().catch(()=>({}));throw new Error(j.message||"Impossible de charger les items.")}let w=await d.json().catch(()=>({}));return Array.isArray(w.items)?w.items:[]},Js=async n=>{if(n&&(Ue=n,De=null,at=!1,Ht=!1,Ae("collection"),Kt(),qt(),Os(),Pt(),Pe=[],We(),ts("Chargement des items\u2026"),ae==null||ae.classList.remove("hidden"),Te==null||Te.classList.add("hidden"),!!be))try{Pe=await Lo(n),We(),Pe.length||ts()}catch(d){console.error("[content] items failed",d),$(d.message||"Impossible de charger les items."),Pe=[],We()}},ko=async(n,d)=>{if(!be)throw new Error("Site inconnu.");let w=await fetch(`${be}/${encodeURIComponent(n)}/items`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(!w.ok){let j=await w.json().catch(()=>({}));throw new Error(j.message||"Impossible de cr\xE9er cet item.")}return w.json()},Eo=async(n,d,w)=>{if(!be)throw new Error("Site inconnu.");let j=await fetch(`${be}/${encodeURIComponent(n)}/items/${encodeURIComponent(d)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(w)});if(!j.ok){let z=await j.json().catch(()=>({}));throw new Error(z.message||"Impossible de sauvegarder cet item.")}return j.json()},Gs=async(n,d)=>{if(!be)throw new Error("Site inconnu.");let w=await fetch(`${be}/${encodeURIComponent(n)}/items/${encodeURIComponent(d)}`,{method:"DELETE"});if(!w.ok){let j=await w.json().catch(()=>({}));throw new Error(j.message||"Impossible de supprimer cet item.")}},Nt=async()=>{var n;if(!be){ge==null||ge.classList.remove("hidden"),Ue=null,Pe=[],We(),Kt(),qt();return}try{let d=await fetch(be,{headers:{Accept:"application/json"}});if(!d.ok)throw new Error("Impossible de charger les collections.");let w=await d.json().catch(()=>[]);if(ct=Array.isArray(w)?w:[],Os(),ct.length>0){let j=((n=ct.find(z=>z.id===Ue))==null?void 0:n.id)||ct[0].id;Js(j)}else Ue=null,Pe=[],Kt(),qt(),We()}catch(d){console.error("[content] load collections",d),$(d.message||"Impossible de charger les collections.")}};ye==null||ye.addEventListener("click",()=>{if(!Ue){$("S\xE9lectionnez d\u2019abord une collection.");return}At(),We()}),ys==null||ys.addEventListener("click",n=>{if(n.preventDefault(),at){at=!1,De=null,Pt(),We();return}if(De){let d=Pe.find(w=>w.id===De);Ut(d)}else Pt()}),(st=l.status)==null||st.addEventListener("change",()=>{ws(l.status.value)}),(Ws=l.title)==null||Ws.addEventListener("input",()=>{!at||!l.slug||Ht||(l.slug.value=xs(l.title.value))}),(Ks=l.slug)==null||Ks.addEventListener("input",()=>{at&&(Ht=!0)}),de==null||de.addEventListener("submit",async n=>{var w;if(n.preventDefault(),!Ue){$("S\xE9lectionnez une collection.");return}let d=So();if(!d.title){$("Le titre est requis."),(w=l.title)==null||w.focus();return}Rt(!0);try{let j;at||!De?(j=await ko(Ue,d),Pe=[...Pe,j],$("Item cr\xE9\xE9")):(j=await Eo(Ue,De,d),Pe=Pe.map(z=>z.id===j.id?j:z),$("Item mis \xE0 jour")),at=!1,De=j.id,Ut(j),We()}catch(j){console.error("[content] save item failed",j),$(j.message||"Impossible de sauvegarder cet item.")}finally{Rt(!1)}});let ss=()=>{J&&(J.classList.add("hidden"),J.classList.remove("flex"),Mt=null)},Dt=()=>{!J||!De||(Mt=De,J.classList.remove("hidden"),J.classList.add("flex"))};V==null||V.addEventListener("click",n=>{n.preventDefault(),De&&Dt()}),Ct==null||Ct.addEventListener("click",()=>{ss()}),J==null||J.addEventListener("click",n=>{n.target===J&&ss()}),wt==null||wt.addEventListener("click",async()=>{if(!Mt||!Ue){ss();return}wt.disabled=!0,wt.textContent="Suppression\u2026";try{await Gs(Ue,Mt),Pe=Pe.filter(n=>n.id!==Mt),De===Mt&&(De=null,Pt()),$("Item supprim\xE9"),We()}catch(n){console.error("[content] delete item failed",n),$(n.message||"Impossible de supprimer cet item.")}finally{wt.disabled=!1,wt.textContent="Supprimer",ss()}}),Kt(),qt(),Nt()}function Hn(){let s=document.querySelector("[data-deploy-form]");if(!s)return;let a=document.querySelector("[data-deploy-protocol]"),i=document.querySelector("[data-deploy-host]"),m=document.querySelector("[data-deploy-port]"),h=document.querySelector("[data-deploy-user]"),x=document.querySelector("[data-deploy-password]"),R=document.querySelector("[data-deploy-show-password]"),W=document.querySelector("[data-deploy-remote-path]"),U=document.querySelector("[data-deploy-feedback]"),ne=document.querySelector("[data-deploy-save]"),se=document.querySelector("[data-deploy-test]"),g=document.querySelector("[data-deploy-trigger]"),E=document.querySelector("[data-deploy-history]"),C=document.querySelector("[data-deploy-log]"),L=qe((O==null?void 0:O.slugValue)||Y.slug||""),M=L?`/api/sites/${encodeURIComponent(L)}/deploy-config`:null,P=L?`/api/sites/${encodeURIComponent(L)}/deploy`:null,N=L?`/api/sites/${encodeURIComponent(L)}/deploy-log`:null,H=!1,u=null,q=b=>{let v=(b||"").trim();return v?v.startsWith("/")?v:`/${v}`:"/www"},k=(b,v="muted")=>{if(!U)return;let S="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold",Z=v==="success"?"bg-emerald-50 text-emerald-700 border border-emerald-100":v==="error"?"bg-rose-50 text-rose-700 border border-rose-100":"bg-slate-50 text-slate-600 border border-slate-100";if(!b){U.textContent="",U.className="text-sm text-slate-500";return}let re=v==="success"?"\u2705":v==="error"?"\u274C":"\u2139\uFE0F";U.innerHTML=`<span class="${S} ${Z}">${re}<span>${b}</span></span>`,U.className="text-sm"},T=(b=null)=>{u=b;let v=!!b,S='<svg class="h-4 w-4 animate-spin text-white" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>';ne&&(ne.disabled=v,ne.innerHTML=b==="save"?`<span class="inline-flex items-center gap-2">${S}<span>Enregistrement\u2026</span></span>`:"Enregistrer"),se&&(se.disabled=v,se.innerHTML=b==="test"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-slate-200 border-t-slate-600"></span><span>Test en cours\u2026</span></span>':"Tester la connexion"),g&&(g.disabled=v&&b!==null,g.innerHTML=b==="deploy"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-white/60 border-t-white"></span><span>D\xE9ploiement\u2026</span></span>':"D\xE9ployer maintenant")},te=b=>{a&&(a.value=b.protocol||"sftp"),i&&(i.value=b.host||""),m&&(m.value=b.port||""),h&&(h.value=b.user||""),W&&(W.value=b.remotePath||"/www"),H=!!b.hasPassword,x&&(x.value="",x.placeholder=H?"Non affich\xE9":"Mot de passe")},K=(b=[])=>{if(E){if(E.innerHTML="",!b.length){let v=document.createElement("li");v.className="text-slate-500",v.textContent="Aucun d\xE9ploiement pour le moment.",E.appendChild(v);return}b.forEach(v=>{let S=document.createElement("li");S.className="flex items-center justify-between gap-2 rounded-xl border border-slate-200 px-3 py-2";let Z=v.status==="success"?'<span class="rounded-full bg-emerald-50 px-2 py-0.5 text-[11px] font-semibold text-emerald-700">Succ\xE8s</span>':'<span class="rounded-full bg-rose-50 px-2 py-0.5 text-[11px] font-semibold text-rose-700">\xC9chec</span>',re=v.finishedAt||v.startedAt||"",pe=v.durationMs&&Number(v.durationMs)>=0?`${Math.round(Number(v.durationMs)/1e3)}s`:"";S.innerHTML=`
          <div class="space-y-1">
            <div class="flex items-center gap-2">${Z}<span class="text-xs text-slate-500">${re}</span></div>
            <p class="text-sm text-slate-800">${v.message||""}</p>
          </div>
          <div class="text-xs text-slate-500">${pe}</div>
        `,S.dataset.deployId=v.id||"",S.addEventListener("click",()=>{v.logs&&C&&(C.textContent=v.logs.join(`
`))}),E.appendChild(S)})}},X=(b=[])=>{C&&(C.textContent=b.length?b.join(`
`):"Aucun log pour le moment.")},he=async()=>{var b;if(N)try{let v=await fetch(N,{headers:{Accept:"application/json"}});if(!v.ok){if(v.status===404){K([]),X(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw new Error("Impossible de charger l\u2019historique.")}let S=await v.json().catch(()=>({})),Z=Array.isArray(S.entries)?S.entries:[];K(Z),(b=Z[0])!=null&&b.logs&&X(Z[0].logs)}catch(v){console.error("[deploy] history failed",v)}},me=async()=>{if(!M){k("Aucun site actif s\xE9lectionn\xE9.","error");return}T("load");try{let b=await fetch(M,{headers:{Accept:"application/json"}}),v=await b.json().catch(()=>({}));b.ok?(te(v||{}),k("Configuration charg\xE9e.","muted")):(te(v||{}),k(v.message||"Configuration par d\xE9faut charg\xE9e.","muted"))}catch(b){console.error("[deploy] load failed",b),k(b.message||"Erreur lors du chargement.","error")}finally{T(null)}},$e=()=>{let b={protocol:(a==null?void 0:a.value)||"sftp",host:(i==null?void 0:i.value.trim())||"",port:Number(m==null?void 0:m.value)||void 0,user:(h==null?void 0:h.value.trim())||"",remotePath:q((W==null?void 0:W.value)||"/www")},v=(x==null?void 0:x.value)||"";return v.trim().length>0&&(b.password=v),b};s.addEventListener("submit",async b=>{if(b.preventDefault(),!M){k("Aucun site actif s\xE9lectionn\xE9.","error");return}let v=$e();T("save");try{let S=await fetch(M,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(v)});if(!S.ok){let re=await S.json().catch(()=>({}));throw new Error(re.message||"Sauvegarde impossible.")}let Z=await S.json();te(Z||{}),k("Configuration enregistr\xE9e.","success"),$("Configuration d\xE9ploiement sauvegard\xE9e")}catch(S){console.error("[deploy] save failed",S),k(S.message||"Erreur lors de la sauvegarde.","error")}finally{T(null)}}),se==null||se.addEventListener("click",async()=>{if(!M){k("Aucun site actif s\xE9lectionn\xE9.","error");return}let b=$e();if(!b.host||!b.user||!b.remotePath){k("Remplissez les champs requis avant de tester.","error");return}T("test");try{let v=await fetch(`${M}/test`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)}),S=await v.json().catch(()=>({}));if(!v.ok||S.success===!1){k(S.message||"Test de connexion \xE9chou\xE9.","error");return}k(S.message||"Connexion OK.","success"),$("Test de connexion r\xE9ussi")}catch(v){console.error("[deploy] test failed",v),k(v.message||"Test de connexion \xE9chou\xE9.","error")}finally{T(null)}}),g==null||g.addEventListener("click",async()=>{if(!P){k("Aucun site actif s\xE9lectionn\xE9.","error");return}T("deploy"),X(["D\xE9ploiement en cours\u2026"]);try{let b=await fetch(P,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify($e())}),v=await b.json().catch(()=>({}));if(!b.ok){if(b.status===404){k("API d\xE9ploiement indisponible (red\xE9marre le serveur).","error"),X(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw X(v.logs||[]),new Error(v.message||"D\xE9ploiement \xE9chou\xE9.")}X(v.logs||[]),await he(),$("D\xE9ploiement termin\xE9")}catch(b){console.error("[deploy] run failed",b),k(b.message||"D\xE9ploiement \xE9chou\xE9.","error")}finally{T(null)}}),R==null||R.addEventListener("change",()=>{x&&(x.type=R.checked?"text":"password")});let fe=document.querySelector("[data-download-build]"),ke=document.querySelector("[data-download-feedback]"),Ae=L?`/api/sites/${encodeURIComponent(L)}/download`:null,D=(b,v="muted")=>{if(!ke)return;let S=v==="success"?"text-emerald-600":v==="error"?"text-rose-600":"text-slate-500";ke.textContent=b||"",ke.className=`text-sm ${S}`};fe==null||fe.addEventListener("click",async()=>{if(!Ae){D("Aucun site actif s\xE9lectionn\xE9.","error");return}fe.disabled=!0;let b=fe.innerHTML;fe.innerHTML=`
        <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <span>Build en cours...</span>
      `,D("G\xE9n\xE9ration du build en cours...","muted");try{let v=await fetch(Ae);if(!v.ok){let pe=await v.json().catch(()=>({}));throw new Error(pe.message||"Impossible de g\xE9n\xE9rer le ZIP.")}let S=await v.blob(),Z=window.URL.createObjectURL(S),re=document.createElement("a");re.href=Z,re.download=`${L}-build.zip`,document.body.appendChild(re),re.click(),document.body.removeChild(re),window.URL.revokeObjectURL(Z),D("T\xE9l\xE9chargement termin\xE9 !","success"),$("Build t\xE9l\xE9charg\xE9 avec succ\xE8s")}catch(v){console.error("[download] failed",v),D(v.message||"Erreur lors du t\xE9l\xE9chargement.","error")}finally{fe.disabled=!1,fe.innerHTML=b}}),me(),he()}function Un(){let s=document.querySelectorAll("[data-settings-tab]"),a=document.querySelectorAll("[data-settings-panel]"),i=document.querySelector("[data-admin-password-form]"),m=document.querySelector("[data-site-config-form]"),h=document.querySelector("[data-site-config-feedback]"),x=document.querySelector("[data-theme-form]"),R=g=>{s.forEach(E=>{let C=E.dataset.settingsTab===g;E.setAttribute("aria-selected",C?"true":"false"),E.classList.toggle("bg-[#9C6BFF]",C),E.classList.toggle("text-white",C)}),a.forEach(E=>{E.classList.toggle("hidden",E.dataset.settingsPanel!==g)})};if(s.forEach(g=>{g.addEventListener("click",()=>R(g.dataset.settingsTab||"account"))}),R("account"),i){let g=i.querySelector("[data-admin-password-feedback]"),E=i.querySelector("[data-admin-password-submit]"),C=(L,M="muted")=>{if(!g)return;let P=M==="success"?"text-emerald-600":M==="error"?"text-rose-600":"text-slate-500";g.textContent=L||"",g.className=`text-sm ${P}`};i.addEventListener("submit",async L=>{L.preventDefault();let M=new FormData(i),P=M.get("currentPassword")||"",N=M.get("newPassword")||"",H=M.get("confirmPassword")||"";if(!P||!N||!H){C("Compl\xE8te tous les champs.","error");return}E&&(E.disabled=!0),C("");try{let u=await fetch("/api/admin/password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({currentPassword:P,newPassword:N,confirmPassword:H})}),q=await u.json().catch(()=>({}));if(!u.ok||q.success===!1)throw new Error(q.message||"Impossible de mettre \xE0 jour le mot de passe.");C(q.message||"Mot de passe mis \xE0 jour.","success"),i.reset()}catch(u){console.error("[settings] change password failed",u),C(u.message||"Erreur lors de la mise \xE0 jour.","error")}finally{E&&(E.disabled=!1)}})}if(m){let g=m.querySelector("[data-site-name]"),E=m.querySelector("[data-site-language]"),C=m.querySelector("[data-site-tagline]"),L=m.querySelector("[data-site-save]"),M=(u,q="muted")=>{if(!h)return;let k=q==="success"?"text-emerald-600":q==="error"?"text-rose-600":"text-slate-500";h.textContent=u||"",h.className=`text-sm ${k}`},P=qe((O==null?void 0:O.slugValue)||Y.slug||""),N=P?`/api/sites/${encodeURIComponent(P)}/config/site`:null,H=async()=>{if(N)try{let u=await fetch(N,{headers:{Accept:"application/json"}});if(!u.ok)return;let q=await u.json().catch(()=>({}));g&&(g.value=q.name||""),E&&(E.value=q.language||"fr"),C&&(C.value=q.tagline||"")}catch(u){console.error("[settings] load site config failed",u)}};m.addEventListener("submit",async u=>{if(u.preventDefault(),!N){M("Aucun site actif.","error");return}if(!(g!=null&&g.value.trim())){M("Nom requis.","error");return}L&&(L.disabled=!0),M("");try{let q={name:(g==null?void 0:g.value)||"",language:(E==null?void 0:E.value)||"fr",tagline:(C==null?void 0:C.value)||""},k=await fetch(N,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(q)}),T=await k.json().catch(()=>({}));if(!k.ok||T.success===!1)throw new Error(T.message||"Sauvegarde impossible.");M(T.message||"Param\xE8tres enregistr\xE9s.","success")}catch(q){console.error("[settings] save site config failed",q),M(q.message||"Erreur lors de la sauvegarde.","error")}finally{L&&(L.disabled=!1)}}),H()}if(x){let g=qe((O==null?void 0:O.slugValue)||Y.slug||""),E=g?`/api/sites/${encodeURIComponent(g)}/config/theme`:null,C={primary:x.querySelector("[data-theme-primary]"),secondary:x.querySelector("[data-theme-secondary]"),accent:x.querySelector("[data-theme-accent]"),background:x.querySelector("[data-theme-background]"),text:x.querySelector("[data-theme-text]")},L=x.querySelector("[data-theme-headings]"),M=x.querySelector("[data-theme-body]"),P=x.querySelector("[data-theme-radius-small]"),N=x.querySelector("[data-theme-radius-medium]"),H=x.querySelector("[data-theme-radius-large]"),u=x.querySelector("[data-theme-preview]"),q=x.querySelector("[data-theme-feedback]"),k=x.querySelector("[data-theme-apply]"),T=["slate","gray","zinc","neutral","stone","red","orange","amber","yellow","lime","green","emerald","teal","cyan","sky","blue","indigo","violet","purple","fuchsia","pink","rose"],te=["50","100","200","300","400","500","600","700","800","900"],K=T.flatMap(D=>te.map(b=>`${D}-${b}`)),X=()=>{Object.values(C).forEach(D=>{!D||D.options.length||K.forEach(b=>{let v=document.createElement("option");v.value=b;let[S,Z]=b.split("-");v.textContent=`${S.charAt(0).toUpperCase()+S.slice(1)} ${Z}`,D.appendChild(v)})})},he=(D,b="muted")=>{if(!q)return;let v=b==="success"?"text-emerald-600":b==="error"?"text-rose-600":"text-slate-500";q.textContent=D||"",q.className=`text-sm ${v}`},me=()=>{var b,v,S,Z,re;if(!u)return;let D=pe=>{if(!pe)return null;if(pe==="white")return"#ffffff";if(pe==="black")return"#000000";if(pe==="transparent")return"transparent";let[ve,et]=pe.split("-");if(!ve||!et)return null;let tt={slate:"#e2e8f0",gray:"#d1d5db",zinc:"#d4d4d8",neutral:"#d4d4d4",stone:"#d6d3d1",red:"#ef4444",orange:"#f97316",amber:"#f59e0b",yellow:"#eab308",lime:"#84cc16",green:"#22c55e",emerald:"#10b981",teal:"#14b8a6",cyan:"#06b6d4",sky:"#0ea5e9",blue:"#3b82f6",indigo:"#6366f1",violet:"#8b5cf6",purple:"#a855f7",fuchsia:"#d946ef",pink:"#ec4899",rose:"#f43f5e"}[ve];if(!tt)return null;let ge=Number(et)||500,ae=Math.min(Math.max((ge-50)/900,0),1),Te=A=>A.match(/[A-Fa-f0-9]{2}/g).map(de=>parseInt(de,16)),[je,Bt,Ft]=Te(tt.replace("#","")),ye=A=>Math.round(255-(255-A)*ae);return`rgb(${ye(je)}, ${ye(Bt)}, ${ye(Ft)})`};u.style.setProperty("--color-primary",D((b=C.primary)==null?void 0:b.value)||"#9C6BFF"),u.style.setProperty("--color-secondary",D((v=C.secondary)==null?void 0:v.value)||"#0EA5E9"),u.style.setProperty("--color-accent",D((S=C.accent)==null?void 0:S.value)||"#F97316"),u.style.setProperty("--color-background",D((Z=C.background)==null?void 0:Z.value)||"#FFFFFF"),u.style.setProperty("--color-text",D((re=C.text)==null?void 0:re.value)||"#0F172A"),u.style.setProperty("--font-headings",(L==null?void 0:L.value)||"Inter, sans-serif"),u.style.setProperty("--font-body",(M==null?void 0:M.value)||"Inter, sans-serif"),u.style.setProperty("--radius-small",(P==null?void 0:P.value)||"8px"),u.style.setProperty("--radius-medium",(N==null?void 0:N.value)||"16px"),u.style.setProperty("--radius-large",(H==null?void 0:H.value)||"24px"),u.style.borderRadius=(N==null?void 0:N.value)||"16px"},$e=(D,b)=>{C[D]&&(C[D].value=b)},fe=D=>{var Z,re;if(!D)return;let b=D.options[D.selectedIndex],v=((Z=b==null?void 0:b.dataset)==null?void 0:Z.color)||"#ffffff",S=(re=D.closest(".relative"))==null?void 0:re.querySelector("[data-color-preview]");S&&(v==="transparent"?S.style.background="repeating-conic-gradient(#ccc 0% 25%, white 0% 50%) 50% / 8px 8px":(S.style.backgroundColor=v,S.style.background=""))},ke=()=>{Object.values(C).forEach(D=>{D&&(fe(D),D.addEventListener("change",()=>fe(D)))})};Object.keys(C).forEach(D=>{var b;(b=C[D])==null||b.addEventListener("change",me)}),[L,M,P,N,H].forEach(D=>{D==null||D.addEventListener("change",me)});let Ae=async()=>{var D,b,v,S,Z,re,pe,ve,et,ce;if(E)try{let tt=await fetch(E,{headers:{Accept:"application/json"}});if(!tt.ok)return;let ge=await tt.json().catch(()=>({}));$e("primary",((D=ge.colors)==null?void 0:D.primary)||"violet-500"),$e("secondary",((b=ge.colors)==null?void 0:b.secondary)||"indigo-400"),$e("accent",((v=ge.colors)==null?void 0:v.accent)||"emerald-500"),$e("background",((S=ge.colors)==null?void 0:S.background)||"slate-50"),$e("text",((Z=ge.colors)==null?void 0:Z.text)||"slate-900"),L&&(L.value=((re=ge.typography)==null?void 0:re.headings)||"Inter, sans-serif"),M&&(M.value=((pe=ge.typography)==null?void 0:pe.body)||"Inter, sans-serif"),P&&(P.value=((ve=ge.radius)==null?void 0:ve.small)||"8px"),N&&(N.value=((et=ge.radius)==null?void 0:et.medium)||"16px"),H&&(H.value=((ce=ge.radius)==null?void 0:ce.large)||"24px"),me(),Object.values(C).forEach(fe)}catch(tt){console.error("[settings] load theme failed",tt)}};X(),ke(),k==null||k.addEventListener("click",async D=>{var v,S,Z,re,pe;if(D.preventDefault(),!E){he("Aucun site actif.","error");return}let b={colors:{primary:((v=C.primary)==null?void 0:v.value)||"violet-500",secondary:((S=C.secondary)==null?void 0:S.value)||"indigo-400",accent:((Z=C.accent)==null?void 0:Z.value)||"emerald-500",background:((re=C.background)==null?void 0:re.value)||"slate-50",text:((pe=C.text)==null?void 0:pe.value)||"slate-900"},typography:{headings:(L==null?void 0:L.value)||"Inter, sans-serif",body:(M==null?void 0:M.value)||"Inter, sans-serif"},radius:{small:(P==null?void 0:P.value)||"8px",medium:(N==null?void 0:N.value)||"16px",large:(H==null?void 0:H.value)||"24px"}};k.disabled=!0,he("");try{let ve=await fetch(E,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)}),et=await ve.json().catch(()=>({}));if(!ve.ok||et.success===!1)throw new Error(et.message||"Application du th\xE8me \xE9chou\xE9e.");he(et.message||"Th\xE8me appliqu\xE9.","success"),me()}catch(ve){console.error("[settings] apply theme failed",ve),he(ve.message||"Erreur lors de l\u2019application du th\xE8me.","error")}finally{k.disabled=!1}}),X(),ke(),Ae(),me()}let W=document.querySelector("[data-seo-config-form]");if(W){let g=W.querySelector("[data-seo-index-all]"),E=W.querySelector("[data-seo-config-feedback]"),C=W.querySelector("[data-seo-save]"),L=qe((O==null?void 0:O.slugValue)||Y.slug||""),M=L?`/api/sites/${encodeURIComponent(L)}/config/site`:null,P=(H,u="muted")=>{if(!E)return;let q=u==="success"?"text-emerald-600":u==="error"?"text-rose-600":"text-slate-500";E.textContent=H||"",E.className=`text-sm ${q}`},N=async()=>{var H;if(M)try{let u=await fetch(M,{headers:{Accept:"application/json"}});if(!u.ok)return;let k=((H=(await u.json().catch(()=>({}))).seo)==null?void 0:H.indexAllPagesByDefault)!==!1;g&&(g.checked=k)}catch(u){console.error("[settings] load seo config failed",u)}};W.addEventListener("submit",async H=>{var u;if(H.preventDefault(),!M){P("Aucun site actif.","error");return}C&&(C.disabled=!0),P("");try{let q=await fetch(M,{headers:{Accept:"application/json"}}),k=q.ok?await q.json().catch(()=>({})):{},T={...k,seo:{...k.seo||{},indexAllPagesByDefault:(u=g==null?void 0:g.checked)!=null?u:!0}},te=await fetch(M,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(T)}),K=await te.json().catch(()=>({}));if(!te.ok||K.success===!1)throw new Error(K.message||"Sauvegarde impossible.");P(K.message||"Param\xE8tres SEO enregistr\xE9s.","success")}catch(q){console.error("[settings] save seo config failed",q),P(q.message||"Erreur lors de la sauvegarde.","error")}finally{C&&(C.disabled=!1)}}),N()}let U=document.querySelector("[data-analytics-form]");if(U){let g=U.querySelector("[data-analytics-head]"),E=U.querySelector("[data-analytics-body]"),C=U.querySelector("[data-analytics-feedback]"),L=U.querySelector("[data-analytics-save]"),M=qe((O==null?void 0:O.slugValue)||Y.slug||""),P=M?`/api/sites/${encodeURIComponent(M)}/config/site`:null,N=(u,q="muted")=>{if(!C)return;let k=q==="success"?"text-emerald-600":q==="error"?"text-rose-600":"text-slate-500";C.textContent=u||"",C.className=`text-sm ${k}`},H=async()=>{var u,q;if(P)try{let k=await fetch(P,{headers:{Accept:"application/json"}});if(!k.ok)return;let T=await k.json().catch(()=>({}));g&&(g.value=((u=T.analytics)==null?void 0:u.headCode)||""),E&&(E.value=((q=T.analytics)==null?void 0:q.bodyEndCode)||"")}catch(k){console.error("[settings] load analytics config failed",k)}};U.addEventListener("submit",async u=>{if(u.preventDefault(),!P){N("Aucun site actif.","error");return}L&&(L.disabled=!0),N("");try{let q=await fetch(P,{headers:{Accept:"application/json"}}),T={...q.ok?await q.json().catch(()=>({})):{},analytics:{headCode:(g==null?void 0:g.value)||"",bodyEndCode:(E==null?void 0:E.value)||""}},te=await fetch(P,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(T)}),K=await te.json().catch(()=>({}));if(!te.ok||K.success===!1)throw new Error(K.message||"Sauvegarde impossible.");N(K.message||"Scripts enregistr\xE9s.","success")}catch(q){console.error("[settings] save analytics config failed",q),N(q.message||"Erreur lors de la sauvegarde.","error")}finally{L&&(L.disabled=!1)}}),H()}let ne=document.querySelector("[data-accessibility-form]");if(ne){let g=ne.querySelector("[data-accessibility-animations]"),E=ne.querySelector("[data-accessibility-contrast]"),C=ne.querySelector("[data-accessibility-feedback]"),L=ne.querySelector("[data-accessibility-save]"),M=qe((O==null?void 0:O.slugValue)||Y.slug||""),P=M?`/api/sites/${encodeURIComponent(M)}/config/site`:null,N=(u,q="muted")=>{if(!C)return;let k=q==="success"?"text-emerald-600":q==="error"?"text-rose-600":"text-slate-500";C.textContent=u||"",C.className=`text-sm ${k}`},H=async()=>{var u,q;if(P)try{let k=await fetch(P,{headers:{Accept:"application/json"}});if(!k.ok)return;let T=await k.json().catch(()=>({}));g&&(g.checked=((u=T.accessibility)==null?void 0:u.animationsEnabled)!==!1),E&&(E.checked=((q=T.accessibility)==null?void 0:q.highContrast)===!0)}catch(k){console.error("[settings] load accessibility config failed",k)}};ne.addEventListener("submit",async u=>{var q,k;if(u.preventDefault(),!P){N("Aucun site actif.","error");return}L&&(L.disabled=!0),N("");try{let T=await fetch(P,{headers:{Accept:"application/json"}}),K={...T.ok?await T.json().catch(()=>({})):{},accessibility:{animationsEnabled:(q=g==null?void 0:g.checked)!=null?q:!0,highContrast:(k=E==null?void 0:E.checked)!=null?k:!1}},X=await fetch(P,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(K)}),he=await X.json().catch(()=>({}));if(!X.ok||he.success===!1)throw new Error(he.message||"Sauvegarde impossible.");N(he.message||"Pr\xE9f\xE9rences mises \xE0 jour.","success")}catch(T){console.error("[settings] save accessibility config failed",T),N(T.message||"Erreur lors de la sauvegarde.","error")}finally{L&&(L.disabled=!1)}}),H()}let se=document.querySelector("[data-ai-config-form]");if(se){let g=se.querySelector("[data-ai-api-key]"),E=se.querySelector("[data-ai-model]"),C=se.querySelector("[data-ai-project-prompt]"),L=se.querySelector("[data-ai-enabled]"),M=se.querySelector("[data-ai-feedback]"),P=se.querySelector("[data-ai-save]"),N=qe((O==null?void 0:O.slugValue)||Y.slug||""),H=N?`/api/sites/${encodeURIComponent(N)}/config/ai`:null,u=(k,T="muted")=>{if(!M)return;let te=T==="success"?"text-emerald-600":T==="error"?"text-rose-600":"text-slate-500";M.textContent=k||"",M.className=`text-sm ${te}`},q=async()=>{if(H)try{let k=await fetch(H,{headers:{Accept:"application/json"}});if(!k.ok)return;let T=await k.json().catch(()=>({}));g&&(g.value="",g.placeholder=T.hasApiKey?"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022":"Cl\xE9 API Gemini"),E&&(E.value=T.model||"gemini-2.5-flash"),C&&(C.value=T.projectPrompt||""),L&&(L.checked=T.enabled!==!1)}catch(k){console.error("[settings] load AI config failed",k)}};se.addEventListener("submit",async k=>{var T,te;if(k.preventDefault(),!H){u("Aucun site actif.","error");return}P&&(P.disabled=!0),u("");try{let K={model:(E==null?void 0:E.value)||"gemini-2.5-flash",projectPrompt:(C==null?void 0:C.value)||"",enabled:(T=L==null?void 0:L.checked)!=null?T:!0},X=(te=g==null?void 0:g.value)==null?void 0:te.trim();X&&(K.apiKey=X);let he=await fetch(H,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(K)}),me=await he.json().catch(()=>({}));if(!he.ok||me.success===!1)throw new Error(me.message||"Sauvegarde impossible.");u(me.message||"Configuration IA enregistr\xE9e.","success"),g&&(g.value="",g.placeholder="\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022")}catch(K){console.error("[settings] save AI config failed",K),u(K.message||"Erreur lors de la sauvegarde.","error")}finally{P&&(P.disabled=!1)}}),q()}}function Rn(){let s=document.querySelector("[data-media-grid]");if(!s)return;let a=document.querySelector("[data-media-empty]"),i=document.querySelector("[data-media-count]"),m=document.querySelector("[data-media-filter-type]"),h=document.querySelector("[data-media-detail-empty]"),x=document.querySelector("[data-media-detail]"),R=document.querySelector("[data-media-detail-preview]"),W=document.querySelector("[data-media-detail-name]"),U=document.querySelector("[data-media-detail-type]"),ne=document.querySelector("[data-media-detail-size]"),se=document.querySelector("[data-media-detail-path]"),g=document.querySelector("[data-media-detail-used]"),E=document.querySelector("[data-media-alt-edit]"),C=document.querySelector("[data-media-save]"),L=document.querySelector("[data-media-delete]"),M=document.querySelector("[data-media-delete-modal]"),P=document.querySelector("[data-media-delete-cancel]"),N=document.querySelector("[data-media-delete-confirm]"),H=document.querySelector("[data-media-upload-open]"),u=document.querySelector("[data-media-file-input]"),q=document.querySelector("[data-media-upload-status]"),k=qe((O==null?void 0:O.slugValue)||Y.slug||""),T=k?`/api/sites/${encodeURIComponent(k)}/media`:null,te=[],K=[],X=null,he=null,me=null,$e=!1,fe=!1,ke=!1,Ae=null,D=l=>{let I=(l.type||"").toLowerCase(),V=(l.filename||"").toLowerCase();return I.includes("image")||/\.(png|jpe?g|webp|svg|gif)$/i.test(V)?"image":I.includes("pdf")||I.includes("doc")||/\.(pdf|docx?)$/i.test(V)?"document":I.includes("video")||/\.(mp4|mov|webm)$/i.test(V)?"video":"other"},b=l=>D(l)==="image",v=l=>{if(l.type)return l.type.toUpperCase();let I=(l.filename||"").split(".").pop();return I?I.toUpperCase():"FILE"},S=l=>!l||l<=0?"\u2014":l<1024?`${l} o`:l<1024*1024?`${(l/1024).toFixed(1)} ko`:`${(l/(1024*1024)).toFixed(1)} Mo`,Z=()=>{x==null||x.classList.add("hidden"),h==null||h.classList.remove("hidden"),re(),X=null,fe=!1,ce(!1),R&&(R.innerHTML='<span class="text-slate-400 text-sm">Aucun m\xE9dia s\xE9lectionn\xE9</span>'),W&&(W.textContent=""),U&&(U.textContent=""),ne&&(ne.textContent=""),E&&(E.value=""),se&&(se.textContent=""),g&&(g.innerHTML="")},re=()=>{me=null,ke=!1,$e=!1,Ae&&(URL.revokeObjectURL(Ae),Ae=null),q&&(q.textContent="Aucun fichier s\xE9lectionn\xE9."),u&&(u.value="")},pe=()=>{i&&(K.length?K.length===1?i.textContent="1 m\xE9dia":i.textContent=`${K.length} m\xE9dias`:i.textContent="0 m\xE9dia")},ve=()=>{if(s.innerHTML="",!K.length){a==null||a.classList.remove("hidden"),Z();return}a==null||a.classList.add("hidden"),K.forEach(l=>{let I=document.createElement("button");I.type="button",I.dataset.mediaId=l.id;let V=l.id===X;I.className=["group relative flex flex-col rounded-2xl border px-3 py-3 text-left transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#9C6BFF]",V?"border-[#9C6BFF] bg-[#F7F0FF]/60 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let J=b(l)?`<img src="${l.path}" alt="${l.alt||l.filename}" class="h-full w-full object-cover" />`:'<div class="flex h-full w-full items-center justify-center text-3xl text-slate-400">\u{1F4C4}</div>';I.innerHTML=`
          <div class="relative aspect-[4/3] overflow-hidden rounded-xl bg-slate-100">
            ${J}
          </div>
          <div class="mt-2 space-y-1">
            <p class="text-sm font-semibold text-slate-900 truncate">${l.filename}</p>
            <p class="text-xs text-slate-500">
              ${v(l)} \xB7 ${S(l.size)}
            </p>
          </div>
        `,l.id===he&&(I.classList.add("ring-2","ring-[#9C6BFF]"),window.setTimeout(()=>{I.classList.remove("ring-2","ring-[#9C6BFF]")},1600)),I.addEventListener("click",()=>tt(l.id)),s.appendChild(I)}),he=null},et=l=>{if(g){if(g.innerHTML="",!l.usedIn||l.usedIn.length===0){let I=document.createElement("li");I.textContent="Non utilis\xE9",I.className="text-xs text-slate-400",g.appendChild(I);return}l.usedIn.forEach(I=>{let V=document.createElement("li");V.textContent=I,V.className="text-xs text-slate-600",g.appendChild(V)})}},ce=l=>{if(C){if(ke){C.textContent=l?"T\xE9l\xE9versement\u2026":"T\xE9l\xE9verser",C.disabled=l||!me,L&&L.classList.add("hidden");return}C.textContent=l?"Enregistrement\u2026":"Enregistrer",C.disabled=l||!fe,L&&(L.classList.remove("hidden"),L.disabled=!X)}},tt=l=>{let I=te.find(V=>V.id===l);if(!I){Z(),ve();return}re(),X=I.id,fe=!1,ce(!1),ve(),h==null||h.classList.add("hidden"),x==null||x.classList.remove("hidden"),R&&(b(I)?R.innerHTML=`<img src="${I.path}" alt="${I.alt||I.filename}" class="h-full w-full rounded-2xl object-cover" />`:R.innerHTML='<div class="flex h-full w-full flex-col items-center justify-center gap-1 text-slate-400"><span class="text-3xl">\u{1F4C4}</span><span class="text-xs font-semibold">Document</span></div>'),W&&(W.textContent=I.filename||"Fichier"),U&&(U.textContent=v(I)),ne&&(ne.textContent=S(I.size)),E&&(E.value=I.alt||""),se&&(se.textContent=I.path||"\u2014"),et(I)},ge=l=>{if(l){if(ke=!0,fe=!1,X=null,h==null||h.classList.add("hidden"),x==null||x.classList.remove("hidden"),Ae&&URL.revokeObjectURL(Ae),Ae=URL.createObjectURL(l),R&&(R.innerHTML=`<img src="${Ae}" alt="${l.name}" class="h-full w-full rounded-2xl object-cover" />`),W&&(W.textContent=l.name),U&&(U.textContent=v({type:l.type,filename:l.name})),ne&&(ne.textContent=S(l.size)),E&&!E.value.trim()&&(E.value=l.name.replace(/\.[^.]+$/,"").replace(/[-_]/g," ")),se&&(se.textContent="En attente de t\xE9l\xE9versement"),g){g.innerHTML="";let I=document.createElement("li");I.textContent="Non utilis\xE9",I.className="text-xs text-slate-400",g.appendChild(I)}ce(!1)}},ae=()=>{let l=(m==null?void 0:m.value)||"all";l==="all"?K=[...te]:K=te.filter(I=>I.groupType===l),K.some(I=>I.id===X)||Z(),pe(),ve()},Te=async()=>{if(!T){a==null||a.classList.remove("hidden");return}try{let l=await fetch(T,{headers:{Accept:"application/json"}});if(!l.ok)throw new Error("Impossible de charger les m\xE9dias.");let I=await l.json().catch(()=>({items:[]}));te=Array.isArray(I.items)?I.items.map(V=>({...V,groupType:D(V)})):[],ae()}catch(l){console.error("[media] load failed",l),$(l.message||"Impossible de charger les m\xE9dias."),te=[],ae()}};m==null||m.addEventListener("change",()=>{ae()}),E==null||E.addEventListener("input",()=>{if(ke){ce(!1);return}X&&(fe=!0,ce(!1))});let je=l=>{if(l){if(!l.type.startsWith("image/")){$("Seules les images sont accept\xE9es pour le moment.");return}if(l.size>4*1024*1024){$("Fichier trop volumineux (4 Mo max).");return}me=l,ge(l),q&&(q.textContent=`${l.name} \xB7 ${S(l.size)}`)}},Bt=l=>new Promise((I,V)=>{let J=new FileReader;J.onload=()=>{let Ct=J.result||"",[,wt=""]=String(Ct).split(",");I(wt)},J.onerror=()=>V(new Error("Impossible de lire ce fichier.")),J.readAsDataURL(l)}),Ft=async()=>{if(!(!me||!T)){$e=!0,ce(!0);try{let l=await Bt(me),I={filename:me.name,type:me.type,size:me.size,alt:(E==null?void 0:E.value)||"",data:l},V=await fetch(T,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(I)});if(!V.ok){let Ct=await V.json().catch(()=>({}));throw new Error(Ct.message||"Upload impossible.")}let J=await V.json();J.groupType=D(J),te=[...te,J],he=J.id,ae(),tt(J.id),$("M\xE9dia ajout\xE9"),re()}catch(l){console.error("[media] upload failed",l),$(l.message||"Impossible de t\xE9l\xE9verser ce m\xE9dia.")}finally{$e=!1,me=null,ce(!1)}}};H==null||H.addEventListener("click",()=>u==null?void 0:u.click()),u==null||u.addEventListener("change",()=>{u.files&&u.files[0]&&je(u.files[0])});let ye=()=>{M&&(M.classList.add("hidden"),M.classList.remove("flex"))},A=()=>{if(!(!X||ke)){if(M){M.classList.remove("hidden"),M.classList.add("flex");return}window.confirm("Supprimer ce m\xE9dia ?")&&de()}},de=async()=>{if(!X||!T){ye();return}let l=()=>{L&&(L.disabled=!0),N&&(N.disabled=!0,N.textContent="Suppression\u2026")},I=()=>{L&&(L.disabled=!1),N&&(N.disabled=!1,N.textContent="Supprimer")};l();try{let V=await fetch(`${T}/${encodeURIComponent(X)}`,{method:"DELETE"});if(!V.ok){let J=await V.json().catch(()=>({}));throw new Error(J.message||"Suppression impossible.")}te=te.filter(J=>J.id!==X),K=K.filter(J=>J.id!==X),$("M\xE9dia supprim\xE9"),Z(),pe(),ve()}catch(V){console.error("[media] delete failed",V),$(V.message||"Impossible de supprimer ce m\xE9dia.")}finally{I(),ye()}};P==null||P.addEventListener("click",ye),M==null||M.addEventListener("click",l=>{l.target===M&&ye()}),N==null||N.addEventListener("click",()=>de()),L==null||L.addEventListener("click",A),C==null||C.addEventListener("click",async()=>{if(ke){Ft();return}if(!(!X||!T||!E)){ce(!0);try{let l={alt:E.value||""},I=await fetch(`${T}/${encodeURIComponent(X)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(!I.ok){let J=await I.json().catch(()=>({}));throw new Error(J.message||"Impossible de mettre \xE0 jour ce m\xE9dia.")}let V=await I.json();te=te.map(J=>J.id===X?{...J,...V}:J),K=K.map(J=>J.id===X?{...J,...V}:J),fe=!1,ce(!1),$("M\xE9dia mis \xE0 jour")}catch(l){console.error("[media] update failed",l),$(l.message||"\xC9chec de la mise \xE0 jour."),ce(!1)}}}),Te()}let ho=document.getElementById("ai-chat-toggle"),es=document.getElementById("ai-chat-panel"),Qe=document.getElementById("ai-chat-overlay"),vo=document.getElementById("ai-chat-close"),yo=document.getElementById("ai-chat-clear"),bo=document.getElementById("ai-chat-form"),Et=document.getElementById("ai-chat-input"),Le=document.getElementById("ai-chat-messages"),Nr=document.getElementById("ai-chat-status"),pt=document.getElementById("ai-chat-no-api"),zn=document.querySelectorAll("[data-ai-quick]"),Hs=!1,xo=!1,Zo=!1,On=!1;function Vn(){es&&(Hs=!0,es.classList.remove("translate-x-full"),es.setAttribute("aria-hidden","false"),Qe==null||Qe.classList.remove("opacity-0","pointer-events-none"),Qe==null||Qe.classList.add("opacity-100"),document.body.classList.add("overflow-hidden"),Et==null||Et.focus(),Zo||Jn())}function Us(){es&&(Hs=!1,es.classList.add("translate-x-full"),es.setAttribute("aria-hidden","true"),Qe==null||Qe.classList.add("opacity-0","pointer-events-none"),Qe==null||Qe.classList.remove("opacity-100"),document.body.classList.remove("overflow-hidden"))}async function Jn(){let s=qe(Y.slug||"");if(!s){pt==null||pt.classList.remove("hidden");return}try{let a=await fetch(`/api/sites/${encodeURIComponent(s)}/config/ai`);if(!a.ok)throw new Error("Config check failed");let i=await a.json();Zo=!0,On=i.hasApiKey,!i.enabled||!i.hasApiKey?pt==null||pt.classList.remove("hidden"):(pt==null||pt.classList.add("hidden"),Gn())}catch(a){console.error("[AI] Config check failed:",a),pt==null||pt.classList.remove("hidden")}}async function Gn(){let s=qe(Y.slug||"");if(!(!s||!Le))try{let a=await fetch(`/api/sites/${encodeURIComponent(s)}/ai/history`);if(!a.ok)return;let i=await a.json();if(i.messages&&i.messages.length>0){let m=Le.querySelector("[data-ai-welcome]");m&&m.remove(),i.messages.forEach(h=>{Rs(h.content,h.role==="user"?"user":"assistant")}),Le.scrollTop=Le.scrollHeight}}catch(a){console.error("[AI] History load failed:",a)}}function Rs(s,a="assistant"){if(!Le)return;let i=document.createElement("div");if(i.className="flex gap-3",a==="user")i.innerHTML=`
        <div class="flex-1"></div>
        <div class="max-w-[80%] bg-violet-600 text-white rounded-2xl rounded-tr-none p-3">
          <p class="text-sm whitespace-pre-wrap">${lt(s)}</p>
        </div>
        <div class="w-8 h-8 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center">
          <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
        </div>
      `;else{let m=Kn(s);i.innerHTML=`
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-violet-500 to-indigo-600 flex-shrink-0 flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
          </svg>
        </div>
        <div class="flex-1 bg-slate-50 rounded-2xl rounded-tl-none p-3 overflow-x-auto">
          <div class="text-sm text-slate-700 prose prose-sm max-w-none [&>pre]:bg-slate-800 [&>pre]:text-slate-100 [&>pre]:rounded-lg [&>pre]:p-3 [&>pre]:overflow-x-auto [&>code]:bg-slate-200 [&>code]:px-1 [&>code]:rounded">${m}</div>
        </div>
      `}Le.appendChild(i),Le.scrollTop=Le.scrollHeight}function Wn(){if(!Le)return;let s=document.createElement("div");s.className="flex gap-3",s.id="ai-loading-indicator",s.innerHTML=`
      <div class="w-8 h-8 rounded-full bg-gradient-to-br from-violet-500 to-indigo-600 flex-shrink-0 flex items-center justify-center">
        <svg class="w-4 h-4 text-white animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
        </svg>
      </div>
      <div class="flex-1 bg-slate-50 rounded-2xl rounded-tl-none p-3">
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 bg-violet-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
          <div class="w-2 h-2 bg-violet-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
          <div class="w-2 h-2 bg-violet-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
        </div>
      </div>
    `,Le.appendChild(s),Le.scrollTop=Le.scrollHeight}function _o(){let s=document.getElementById("ai-loading-indicator");s==null||s.remove()}function Kn(s){if(!s)return"";let a=lt(s);return a=a.replace(/```(\w*)\n([\s\S]*?)```/g,(i,m,h)=>`<pre class="language-${m||"text"}"><code>${h.trim()}</code></pre>`),a=a.replace(/`([^`]+)`/g,"<code>$1</code>"),a=a.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),a=a.replace(/\*([^*]+)\*/g,"<em>$1</em>"),a=a.replace(/^### (.+)$/gm,'<h4 class="font-semibold text-slate-900 mt-3 mb-1">$1</h4>'),a=a.replace(/^## (.+)$/gm,'<h3 class="font-semibold text-slate-900 mt-3 mb-1">$1</h3>'),a=a.replace(/^# (.+)$/gm,'<h2 class="font-bold text-slate-900 mt-3 mb-2">$1</h2>'),a=a.replace(/^- (.+)$/gm,'<li class="ml-4">$1</li>'),a=a.replace(/^(\d+)\. (.+)$/gm,'<li class="ml-4">$2</li>'),a=a.replace(/\n\n/g,'</p><p class="mb-2">'),a='<p class="mb-2">'+a+"</p>",a=a.replace(/<p class="mb-2"><\/p>/g,""),a}function lt(s){let a=document.createElement("div");return a.textContent=s,a.innerHTML}async function Yo(s){let a=qe(Y.slug||"");if(!s||!a||xo)return;xo=!0,Et.disabled=!0;let i=Le==null?void 0:Le.querySelector("[data-ai-welcome]");i&&i.remove(),Rs(s,"user"),Wn();try{let m=await fetch(`/api/sites/${encodeURIComponent(a)}/ai/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:s})});if(_o(),!m.ok){let x=await m.json().catch(()=>({}));throw new Error(x.message||"Erreur de communication")}let h=await m.json();h.response&&Rs(h.response,"assistant"),h.editProposal&&Zn(h.editProposal),h.themeProposal&&_n(h.themeProposal)}catch(m){_o(),Rs(`\u274C Erreur: ${m.message}`,"assistant")}finally{xo=!1,Et.disabled=!1,Et.focus()}}function Zn(s){var m,h;if(!Le||!s)return;let a=document.createElement("div");a.className="flex gap-3 mt-2",a.dataset.proposalId=s.proposalId;let i="";if(s.changes&&(s.changes.title&&(i+=`<li>Titre \u2192 <strong>${lt(s.changes.title)}</strong></li>`),s.changes.description&&(i+=`<li>Description \u2192 ${lt(s.changes.description.substring(0,80))}...</li>`),s.changes.seo&&(s.changes.seo.metaTitle&&(i+=`<li>Meta title \u2192 ${lt(s.changes.seo.metaTitle)}</li>`),s.changes.seo.metaDescription&&(i+=`<li>Meta description \u2192 ${lt(s.changes.seo.metaDescription.substring(0,60))}...</li>`)),s.changes.blockUpdate&&(i+=`<li>Bloc "${s.changes.blockUpdate.blockId}" modifi\xE9</li>`,s.changes.blockUpdate.settings))){let x=s.changes.blockUpdate.settings;x.title&&(i+=`<li class="ml-4">\u2192 title: ${lt(x.title)}</li>`),x.content&&(i+='<li class="ml-4">\u2192 content modifi\xE9</li>')}a.innerHTML=`
      <div class="w-8 h-8 rounded-full bg-amber-500 flex-shrink-0 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
        </svg>
      </div>
      <div class="flex-1 bg-amber-50 border border-amber-200 rounded-2xl rounded-tl-none p-4">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-xs font-semibold text-amber-700 bg-amber-100 px-2 py-0.5 rounded">Proposition d'\xE9dition</span>
        </div>
        <p class="text-sm font-medium text-slate-800 mb-1">Page : ${lt(s.pageTitle||s.pageId)}</p>
        ${s.reason?`<p class="text-sm text-slate-600 mb-2">${lt(s.reason)}</p>`:""}
        <ul class="text-xs text-slate-600 space-y-1 mb-3 list-disc ml-4">
          ${i||"<li>Modifications propos\xE9es</li>"}
        </ul>
        <div class="flex gap-2">
          <button 
            class="ai-apply-edit px-3 py-1.5 text-xs font-medium text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg transition-colors flex items-center gap-1"
            data-proposal-id="${s.proposalId}"
          >
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Appliquer
          </button>
          <button 
            class="ai-reject-edit px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors flex items-center gap-1"
            data-proposal-id="${s.proposalId}"
          >
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            Rejeter
          </button>
        </div>
      </div>
    `,Le.appendChild(a),Le.scrollTop=Le.scrollHeight,(m=a.querySelector(".ai-apply-edit"))==null||m.addEventListener("click",Qn),(h=a.querySelector(".ai-reject-edit"))==null||h.addEventListener("click",Xo)}function _n(s){var h,x,R,W;if(!Le||!s)return;let a=document.createElement("div");a.className="flex gap-3 mt-2",a.dataset.proposalId=s.proposalId;let i="";if((h=s.changes)!=null&&h.colors){let U=s.changes.colors;for(let[ne,se]of Object.entries(U))i+=`<li class="flex items-center gap-2">
          <span class="w-4 h-4 rounded border border-slate-300" style="background: ${Yn(se)}"></span>
          <span>${ne}: <strong>${lt(se)}</strong></span>
        </li>`}let m="";if((x=s.changes)!=null&&x.typography){let U=s.changes.typography;U.headings&&(m+=`<li>Titres \u2192 <strong>${lt(U.headings)}</strong></li>`),U.body&&(m+=`<li>Textes \u2192 <strong>${lt(U.body)}</strong></li>`)}a.innerHTML=`
      <div class="w-8 h-8 rounded-full bg-purple-500 flex-shrink-0 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
        </svg>
      </div>
      <div class="flex-1 bg-purple-50 border border-purple-200 rounded-2xl rounded-tl-none p-4">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-xs font-semibold text-purple-700 bg-purple-100 px-2 py-0.5 rounded">Modification du th\xE8me</span>
        </div>
        ${s.reason?`<p class="text-sm text-slate-600 mb-3">${lt(s.reason)}</p>`:""}
        ${i?`
          <p class="text-xs font-medium text-slate-700 mb-1">Couleurs :</p>
          <ul class="text-xs text-slate-600 space-y-1 mb-3">${i}</ul>
        `:""}
        ${m?`
          <p class="text-xs font-medium text-slate-700 mb-1">Typographies :</p>
          <ul class="text-xs text-slate-600 space-y-1 mb-3 list-disc ml-4">${m}</ul>
        `:""}
        <div class="flex gap-2">
          <button 
            class="ai-apply-theme px-3 py-1.5 text-xs font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors flex items-center gap-1"
            data-proposal-id="${s.proposalId}"
          >
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Appliquer
          </button>
          <button 
            class="ai-reject-theme px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors flex items-center gap-1"
            data-proposal-id="${s.proposalId}"
          >
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            Rejeter
          </button>
        </div>
      </div>
    `,Le.appendChild(a),Le.scrollTop=Le.scrollHeight,(R=a.querySelector(".ai-apply-theme"))==null||R.addEventListener("click",Xn),(W=a.querySelector(".ai-reject-theme"))==null||W.addEventListener("click",Xo)}function Yn(s){return{white:"#ffffff",black:"#000000",transparent:"transparent","slate-50":"#f8fafc","slate-100":"#f1f5f9","slate-200":"#e2e8f0","slate-300":"#cbd5e1","slate-400":"#94a3b8","slate-500":"#64748b","slate-600":"#475569","slate-700":"#334155","slate-800":"#1e293b","slate-900":"#0f172a","gray-50":"#f9fafb","gray-100":"#f3f4f6","gray-200":"#e5e7eb","gray-300":"#d1d5db","gray-400":"#9ca3af","gray-500":"#6b7280","gray-600":"#4b5563","gray-700":"#374151","gray-800":"#1f2937","gray-900":"#111827","violet-50":"#f5f3ff","violet-100":"#ede9fe","violet-200":"#ddd6fe","violet-300":"#c4b5fd","violet-400":"#a78bfa","violet-500":"#8b5cf6","violet-600":"#7c3aed","violet-700":"#6d28d9","violet-800":"#5b21b6","violet-900":"#4c1d95","purple-50":"#faf5ff","purple-100":"#f3e8ff","purple-200":"#e9d5ff","purple-300":"#d8b4fe","purple-400":"#c084fc","purple-500":"#a855f7","purple-600":"#9333ea","purple-700":"#7e22ce","purple-800":"#6b21a8","purple-900":"#581c87","blue-50":"#eff6ff","blue-100":"#dbeafe","blue-200":"#bfdbfe","blue-300":"#93c5fd","blue-400":"#60a5fa","blue-500":"#3b82f6","blue-600":"#2563eb","blue-700":"#1d4ed8","blue-800":"#1e40af","blue-900":"#1e3a8a","emerald-50":"#ecfdf5","emerald-100":"#d1fae5","emerald-200":"#a7f3d0","emerald-300":"#6ee7b7","emerald-400":"#34d399","emerald-500":"#10b981","emerald-600":"#059669","emerald-700":"#047857","emerald-800":"#065f46","emerald-900":"#064e3b","teal-50":"#f0fdfa","teal-100":"#ccfbf1","teal-200":"#99f6e4","teal-300":"#5eead4","teal-400":"#2dd4bf","teal-500":"#14b8a6","teal-600":"#0d9488","teal-700":"#0f766e","teal-800":"#115e59","teal-900":"#134e4a","amber-50":"#fffbeb","amber-100":"#fef3c7","amber-200":"#fde68a","amber-300":"#fcd34d","amber-400":"#fbbf24","amber-500":"#f59e0b","amber-600":"#d97706","amber-700":"#b45309","amber-800":"#92400e","amber-900":"#78350f","red-50":"#fef2f2","red-100":"#fee2e2","red-200":"#fecaca","red-300":"#fca5a5","red-400":"#f87171","red-500":"#ef4444","red-600":"#dc2626","red-700":"#b91c1c","red-800":"#991b1b","red-900":"#7f1d1d"}[s]||"#9C6BFF"}async function Xn(s){var h;let a=(h=s.target.closest("[data-proposal-id]"))==null?void 0:h.dataset.proposalId,i=qe(Y.slug||"");if(!a||!i)return;let m=s.target.closest("button");m.disabled=!0,m.innerHTML='<span class="animate-spin">\u23F3</span> Application...';try{let x=await fetch(`/api/sites/${encodeURIComponent(i)}/ai/apply-theme`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({proposalId:a})}),R=await x.json();if(x.ok&&R.success){let W=document.querySelector(`[data-proposal-id="${a}"]`);W&&(W.innerHTML=`
            <div class="w-8 h-8 rounded-full bg-purple-500 flex-shrink-0 flex items-center justify-center">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <div class="flex-1 bg-purple-50 border border-purple-200 rounded-2xl rounded-tl-none p-3">
              <p class="text-sm text-purple-700">\u2705 Th\xE8me mis \xE0 jour avec succ\xE8s !</p>
              <p class="text-xs text-purple-600 mt-1">Rechargez la preview pour voir les changements.</p>
            </div>
          `),$("Th\xE8me mis \xE0 jour !"),document.dispatchEvent(new CustomEvent("ai-theme-updated",{detail:{updatedTheme:R.updatedTheme}}))}else throw new Error(R.message||"Erreur lors de l'application")}catch(x){m.disabled=!1,m.innerHTML='<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> R\xE9essayer',$(`Erreur: ${x.message}`)}}async function Qn(s){var h,x;let a=(h=s.target.closest("[data-proposal-id]"))==null?void 0:h.dataset.proposalId,i=qe(Y.slug||"");if(!a||!i)return;let m=s.target.closest("button");m.disabled=!0,m.innerHTML='<span class="animate-spin">\u23F3</span> Application...';try{let R=await fetch(`/api/sites/${encodeURIComponent(i)}/ai/apply-edit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({proposalId:a})}),W=await R.json();if(R.ok&&W.success){let U=document.querySelector(`[data-proposal-id="${a}"]`);U&&(U.innerHTML=`
            <div class="w-8 h-8 rounded-full bg-emerald-500 flex-shrink-0 flex items-center justify-center">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <div class="flex-1 bg-emerald-50 border border-emerald-200 rounded-2xl rounded-tl-none p-3">
              <p class="text-sm text-emerald-700">\u2705 Modifications appliqu\xE9es avec succ\xE8s !</p>
              <p class="text-xs text-emerald-600 mt-1">La preview se met \xE0 jour automatiquement.</p>
            </div>
          `),$("Modifications appliqu\xE9es !");let ne=((x=W.updatedPage)==null?void 0:x.id)||null;document.dispatchEvent(new CustomEvent("ai-page-updated",{detail:{pageId:ne,updatedPage:W.updatedPage}}))}else throw new Error(W.message||"Erreur lors de l'application")}catch(R){m.disabled=!1,m.innerHTML='<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> R\xE9essayer',$(`Erreur: ${R.message}`)}}async function Xo(s){var m;let a=(m=s.target.closest("[data-proposal-id]"))==null?void 0:m.dataset.proposalId,i=qe(Y.slug||"");if(!(!a||!i))try{await fetch(`/api/sites/${encodeURIComponent(i)}/ai/proposal/${a}`,{method:"DELETE"});let h=document.querySelector(`[data-proposal-id="${a}"]`);h&&(h.innerHTML=`
          <div class="w-8 h-8 rounded-full bg-slate-400 flex-shrink-0 flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </div>
          <div class="flex-1 bg-slate-100 rounded-2xl rounded-tl-none p-3">
            <p class="text-sm text-slate-500">Proposition rejet\xE9e.</p>
          </div>
        `)}catch(h){console.error("[AI] Reject edit error:",h)}}async function er(){let s=qe(Y.slug||"");if(!(!s||!Le))try{await fetch(`/api/sites/${encodeURIComponent(s)}/ai/history`,{method:"DELETE"}),Le.innerHTML="",Le.innerHTML=`
        <div class="flex gap-3" data-ai-welcome>
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-violet-500 to-indigo-600 flex-shrink-0 flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
            </svg>
          </div>
          <div class="flex-1 bg-slate-50 rounded-2xl rounded-tl-none p-3">
            <p class="text-sm text-slate-700">
              Salut ! \u{1F44B} Je suis ton assistant IA pour ce site. Je peux t'aider \xE0 :
            </p>
            <ul class="mt-2 text-sm text-slate-600 space-y-1">
              <li>\u{1F3A8} Sugg\xE9rer des palettes de couleurs</li>
              <li>\u270D\uFE0F G\xE9n\xE9rer du contenu pour tes blocs</li>
              <li>\u{1F4C4} Cr\xE9er des structures de pages</li>
              <li>\u{1F50D} Am\xE9liorer ton SEO</li>
              <li>\u270F\uFE0F <strong>Analyser et modifier tes pages</strong> (avec validation)</li>
            </ul>
          </div>
        </div>
      `,$("Historique effac\xE9")}catch(a){console.error("[AI] Clear history failed:",a),$("Erreur lors de l'effacement")}}let tr={colors:"Sugg\xE8re-moi 3 palettes de couleurs harmonieuses pour mon site. Pour chaque palette, donne les couleurs Tailwind: primary, secondary, accent, et background.",hero:"G\xE9n\xE8re un bloc Hero en JSON avec un titre accrocheur, un sous-titre engageant et un CTA.",seo:"Analyse mon site et sugg\xE8re des am\xE9liorations SEO pour le meta title et la meta description de ma page d'accueil.",landing:"G\xE9n\xE8re la structure JSON d'une landing page compl\xE8te avec: Hero, 3 sections de contenu, et un CTA final.",analyze:"Analyse le contenu de toutes mes pages et propose des am\xE9liorations concr\xE8tes. Pour chaque suggestion d'am\xE9lioration de texte ou de structure, utilise le format propose-edit pour que je puisse valider.",improveHome:"Analyse ma page d'accueil et propose une am\xE9lioration du titre ou du Hero pour le rendre plus impactant. Utilise le format propose-edit."};ho==null||ho.addEventListener("click",()=>{Hs?Us():Vn()}),vo==null||vo.addEventListener("click",Us),Qe==null||Qe.addEventListener("click",Us),yo==null||yo.addEventListener("click",()=>{confirm("Effacer tout l'historique de conversation ?")&&er()}),bo==null||bo.addEventListener("submit",s=>{var i;s.preventDefault();let a=(i=Et==null?void 0:Et.value)==null?void 0:i.trim();a&&(Et.value="",Yo(a))}),zn.forEach(s=>{s.addEventListener("click",()=>{let a=s.dataset.aiQuick,i=tr[a];i&&Yo(i)})}),document.addEventListener("keydown",s=>{s.key==="Escape"&&Hs&&Us()})});})();
