(()=>{document.addEventListener("DOMContentLoaded",()=>{console.log("[admin] Atelier charg\xE9");let C=document.querySelector("[data-logout]");C&&C.addEventListener("click",async()=>{C.disabled=!0;try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(e){console.error("[admin] Impossible de se d\xE9connecter",e)}finally{window.location.href="/admin/login.html"}});let h=document.querySelector("[data-admin-sidebar]"),i=document.querySelector("[data-admin-sidebar-overlay]"),B=document.querySelectorAll("[data-admin-sidebar-toggle]"),N=document.querySelectorAll("[data-admin-sidebar-close]"),p=document.body,g=!1,y=()=>{if(!h)return;if(window.matchMedia("(min-width: 1024px)").matches){h.classList.remove("hidden"),i==null||i.classList.add("hidden"),p.classList.remove("overflow-hidden");return}g?(h.classList.remove("hidden"),i==null||i.classList.remove("hidden"),p.classList.add("overflow-hidden")):(h.classList.add("hidden"),i==null||i.classList.add("hidden"),p.classList.remove("overflow-hidden"))},K=()=>{g=!0,y()},b=()=>{g=!1,y()};h&&B.length>0&&(B.forEach(e=>{e.addEventListener("click",K)}),N.forEach(e=>{e.addEventListener("click",b)}),i==null||i.addEventListener("click",b),window.addEventListener("resize",y),window.addEventListener("keydown",e=>{e.key==="Escape"&&g&&b()}),y());let x="clower:currentSite",q=document.querySelectorAll("[data-site-card]"),P=document.querySelectorAll("[data-site-select]"),S=document.querySelector("[data-current-site-name]"),k=document.querySelector("[data-site-toast]"),M=document.querySelector("[data-site-toast-message]"),_=document.querySelectorAll("[data-site-create]"),s=document.querySelector("[data-site-modal]"),u=document.querySelector("[data-site-form]"),r=document.querySelector("[data-site-name]"),d=document.querySelector("[data-site-slug]"),o=document.querySelector("[data-site-slug-error]"),c=document.querySelector("[data-site-modal-error]"),J=document.querySelectorAll("[data-site-modal-cancel]"),m=document.querySelector("[data-site-modal-submit]"),v=!1,A=null,R='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',D=e=>{if(!s||s.classList.contains("hidden")||e.key!=="Tab")return;let t=Array.from(s.querySelectorAll(R)).filter(w=>!w.hasAttribute("disabled")&&!w.getAttribute("aria-hidden"));if(t.length===0)return;let a=t[0],n=t[t.length-1];e.shiftKey?document.activeElement===a&&(e.preventDefault(),n.focus()):document.activeElement===n&&(e.preventDefault(),a.focus())},T=null,W=e=>{!k||!M||(M.textContent=e,k.classList.remove("hidden"),T&&clearTimeout(T),T=setTimeout(()=>{k.classList.add("hidden")},2500))},F=(e,t={})=>{if(!e)return;let a=(S==null?void 0:S.dataset.defaultSiteName)||"";if(q.forEach(n=>{let f=n.dataset.siteCard===e,l=n.querySelector("[data-site-active-badge]");f?(n.classList.add("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),n.classList.remove("border-slate-200"),l==null||l.classList.remove("hidden"),a=n.dataset.siteName||a):(n.classList.remove("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),n.classList.add("border-slate-200"),l==null||l.classList.add("hidden"))}),S&&a&&(S.textContent=a),t.persist!==!1)try{window.localStorage.setItem(x,e)}catch{}},I=(()=>{try{let t=window.localStorage.getItem(x);if(t)return t}catch{}let e=document.querySelector('[data-site-card][data-site-default="true"]')||q[0];return(e==null?void 0:e.dataset.siteCard)||null})();I&&F(I,{persist:!1}),P.forEach(e=>{e.addEventListener("click",()=>{let t=e.dataset.siteSelect,a=e.dataset.siteSelectName||"Ce site";t&&(F(t),W(`${a} est maintenant le site actif.`))})});let j=e=>e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),z=e=>{let t=j(e||"");return t?`/${t}`:""},Y=()=>{s&&(A=document.activeElement,s.classList.remove("hidden"),s.classList.add("flex"),v=!1,u==null||u.reset(),o&&(o.textContent=""),c&&(c.textContent=""),d&&r&&(d.value=z(r.value)),document.addEventListener("keydown",D),window.setTimeout(()=>{r==null||r.focus()},0))},L=()=>{s&&(s.classList.add("hidden"),s.classList.remove("flex"),document.removeEventListener("keydown",D),v=!1,u==null||u.reset(),o&&(o.textContent=""),c&&(c.textContent=""),A&&A.focus())};_.forEach(e=>{e.addEventListener("click",Y)}),J.forEach(e=>{e.addEventListener("click",L)}),s==null||s.addEventListener("click",e=>{e.target===s&&L()}),r==null||r.addEventListener("input",()=>{d&&(!v||d.value.trim().length===0)&&(d.value=j(r.value))}),d==null||d.addEventListener("input",()=>{v=!0,o&&(o.textContent="")});let G=()=>new Set(Array.from(q).map(e=>e.dataset.siteCard));u==null||u.addEventListener("submit",async e=>{if(e.preventDefault(),!r||!d)return;let t=(r.value||"").trim(),a=d.value||"";a||(a=t);let n=z(a);if(!t||!n){o&&(o.textContent="Nom et slug sont requis.");return}if(G().has(n)){o&&(o.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}o&&(o.textContent=""),c&&(c.textContent=""),m&&(m.disabled=!0,m.textContent="Cr\xE9ation...");try{let f=await fetch("/api/sites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,slug:n})});if(!f.ok){let V=await f.json().catch(()=>({})),$=V.message||"Impossible de cr\xE9er ce site.";c&&(c.textContent=$),V.field==="slug"&&o&&(o.textContent=$);return}let l=await f.json(),E=(l==null?void 0:l.slug)||n;E.startsWith("/")||(E=`/${E}`);try{window.localStorage.setItem(x,E)}catch{}L(),window.location.href="/admin/design.html"}catch(f){console.error("[admin] Impossible de cr\xE9er le site",f),c&&(c.textContent="Erreur inattendue. R\xE9essaie dans un instant.")}finally{m&&(m.disabled=!1,m.textContent="Cr\xE9er")}}),window.addEventListener("keydown",e=>{e.key==="Escape"&&s&&!s.classList.contains("hidden")&&L()})});})();
