(()=>{document.addEventListener("DOMContentLoaded",()=>{console.log("[admin] Atelier charg\xE9");let Gt=document.querySelector("[data-logout]");Gt&&Gt.addEventListener("click",async()=>{Gt.disabled=!0;try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(o){console.error("[admin] Impossible de se d\xE9connecter",o)}finally{window.location.href="/admin/index.html"}});let pt=document.querySelector("[data-admin-sidebar]"),we=document.querySelector("[data-admin-sidebar-overlay]"),bs=document.querySelectorAll("[data-admin-sidebar-toggle]"),Js=document.querySelectorAll("[data-admin-sidebar-close]"),_t=document.body,kt=!1,qt=()=>{if(!pt)return;if(window.matchMedia("(min-width: 1024px)").matches){pt.classList.remove("hidden"),we==null||we.classList.add("hidden"),_t.classList.remove("overflow-hidden");return}kt?(pt.classList.remove("hidden"),we==null||we.classList.remove("hidden"),_t.classList.add("overflow-hidden")):(pt.classList.add("hidden"),we==null||we.classList.add("hidden"),_t.classList.remove("overflow-hidden"))},Ws=()=>{kt=!0,qt()},Yt=()=>{kt=!1,qt()};pt&&bs.length>0&&(bs.forEach(o=>{o.addEventListener("click",Ws)}),Js.forEach(o=>{o.addEventListener("click",Yt)}),we==null||we.addEventListener("click",Yt),window.addEventListener("resize",qt),window.addEventListener("keydown",o=>{o.key==="Escape"&&kt&&Yt()}),qt());let xs="clower:currentSite",ws="clower:currentSiteName",Q={slug:null,name:""};(()=>{try{Q.slug=window.localStorage.getItem(xs),Q.name=window.localStorage.getItem(ws)||""}catch{Q.slug=null,Q.name=""}})();let Kt=document.querySelectorAll("[data-site-card]"),Gs=document.querySelectorAll("[data-site-select]"),ft=document.querySelector("[data-current-site-name]"),Ss=document.querySelector("[data-workspace-site-name]"),Ls=document.querySelector("[data-workspace-back-name]"),Ye=document.querySelector("[data-workspace-back-modal]"),_s=document.querySelectorAll("[data-workspace-back]"),Ys=document.querySelectorAll("[data-workspace-back-cancel]"),Xt=document.querySelector("[data-workspace-back-confirm]"),Ks=document.querySelectorAll("[data-workspace-tab]"),Zt=document.querySelector("[data-site-toast]"),Cs=document.querySelector("[data-site-toast-message]"),Xs=document.querySelectorAll("[data-site-create]"),ue=document.querySelector("[data-site-modal]"),He=document.querySelector("[data-site-form]"),ke=document.querySelector("[data-site-name]"),Be=document.querySelector("[data-site-slug]"),ye=document.querySelector("[data-site-slug-error]"),Te=document.querySelector("[data-site-modal-error]"),Zs=document.querySelectorAll("[data-site-modal-cancel]"),ot=document.querySelector("[data-site-modal-submit]"),z=an(),At=!1,Ft=null,Qt=null,Qs='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',Es=o=>{if(!ue||ue.classList.contains("hidden")||o.key!=="Tab")return;let g=Array.from(ue.querySelectorAll(Qs)).filter(I=>!I.hasAttribute("disabled")&&!I.getAttribute("aria-hidden"));if(g.length===0)return;let x=g[0],A=g[g.length-1];o.shiftKey?document.activeElement===x&&(o.preventDefault(),A.focus()):document.activeElement===A&&(o.preventDefault(),x.focus())},P=o=>{!Zt||!Cs||(Cs.textContent=o,Zt.classList.remove("hidden"),Qt&&clearTimeout(Qt),Qt=setTimeout(()=>{Zt.classList.add("hidden")},2500))};function ze(o){return o?o.startsWith("/")?o:`/${o}`:""}function Se(o){return(o==null?void 0:o.replace(/^\//,""))||""}let It=(o,g)=>{let x=o?ze(o):null;try{x&&(window.localStorage.setItem(xs,x),Q.slug=x),typeof g=="string"&&g.length>0&&(window.localStorage.setItem(ws,g),Q.name=g)}catch{Q.slug=x||Q.slug,Q.name=g||Q.name}},ks=o=>{ft&&o&&(ft.textContent=o),Ss&&o&&(Ss.textContent=o),Ls&&o&&(Ls.textContent=o)},es=o=>{Ks.forEach(g=>{let x=g.dataset.workspaceTab;if(!x)return;if(!o){g.href="#",g.classList.add("pointer-events-none","opacity-50","text-slate-400"),g.setAttribute("aria-disabled","true");return}let A=encodeURIComponent(Se(o));g.href=`/admin/site/${A}/${x}`,g.classList.remove("pointer-events-none","opacity-50","text-slate-400"),g.removeAttribute("aria-disabled")})},Bt=(o,g={})=>{if(!o)return;let x=ze(o),A=g.siteName||Q.name||(ft==null?void 0:ft.dataset.defaultSiteName)||"";Kt.forEach(C=>{let W=ze(C.dataset.siteCard||"")===x,$=C.querySelector("[data-site-active-badge]");W?(C.classList.add("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),C.classList.remove("border-slate-200"),$==null||$.classList.remove("hidden"),A=C.dataset.siteName||A):(C.classList.remove("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),C.classList.add("border-slate-200"),$==null||$.classList.add("hidden"))}),g.persist!==!1&&It(x,g.siteName||A);let I=g.siteName||A;ks(I),es(x)},en=async(o,g)=>{let x=ze(o);try{let A=await fetch("/api/sites/select",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slug:x})});if(!A.ok){let $=await A.json().catch(()=>({}));P($.message||"Impossible de s\xE9lectionner ce site.");return}let I=await A.json().catch(()=>({})),C=ze(I.slug||x),G=I.name||g;It(C,G),Bt(C,{siteName:G,persist:!1});let W=encodeURIComponent(Se(C));window.location.href=`/admin/site/${W}/design`}catch(A){console.error("[admin] Impossible de s\xE9lectionner le site",A),P("Erreur inattendue lors de la s\xE9lection.")}},tn=async()=>{try{let o=await fetch("/api/sites/current",{credentials:"same-origin"});if(!o.ok){o.status===404&&z&&(window.location.href="/admin/sites");return}let g=await o.json(),x=ze(g.slug);It(x,g.name),Bt(x,{siteName:g.name,persist:!1})}catch(o){console.warn("[admin] Impossible de r\xE9cup\xE9rer le site actif",o)}};(()=>{if(Q.slug){Bt(Q.slug,{siteName:Q.name,persist:!1});return}let o=document.querySelector('[data-site-card][data-site-default="true"]')||Kt[0];o&&Bt(o.dataset.siteCard,{siteName:o.dataset.siteName||"",persist:!1})})(),tn(),z?es(z.slugValue):Q.slug&&es(Q.slug),Gs.forEach(o=>{o.addEventListener("click",()=>{if(o.disabled)return;let g=o.dataset.siteSelect,x=o.dataset.siteSelectName||"Ce site";g&&(o.disabled=!0,en(g,x).finally(()=>{o.disabled=!1}))})});let gt=o=>o.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),sn=o=>{let g=gt(o||"");return g?`/${g}`:""},nn=()=>{ue&&(Ft=document.activeElement,ue.classList.remove("hidden"),ue.classList.add("flex"),At=!1,He==null||He.reset(),ye&&(ye.textContent=""),Te&&(Te.textContent=""),Be&&ke&&(Be.value=gt(ke.value)),document.addEventListener("keydown",Es),window.setTimeout(()=>{ke==null||ke.focus()},0))},Tt=()=>{ue&&(ue.classList.add("hidden"),ue.classList.remove("flex"),document.removeEventListener("keydown",Es),At=!1,He==null||He.reset(),ye&&(ye.textContent=""),Te&&(Te.textContent=""),Ft==null||Ft.focus())};Xs.forEach(o=>{o.addEventListener("click",nn)}),Zs.forEach(o=>{o.addEventListener("click",Tt)}),ue==null||ue.addEventListener("click",o=>{o.target===ue&&Tt()}),ke==null||ke.addEventListener("input",()=>{Be&&(!At||Be.value.trim().length===0)&&(Be.value=gt(ke.value))}),Be==null||Be.addEventListener("input",()=>{At=!0,ye&&(ye.textContent="")});let on=()=>new Set(Array.from(Kt).map(o=>ze(o.dataset.siteCard||"")));He==null||He.addEventListener("submit",async o=>{if(o.preventDefault(),!ke||!Be)return;let g=(ke.value||"").trim(),x=Be.value||"";x||(x=g);let A=sn(x);if(!g||!A){ye&&(ye.textContent="Nom et slug sont requis.");return}if(on().has(A)){ye&&(ye.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}ye&&(ye.textContent=""),Te&&(Te.textContent=""),ot&&(ot.disabled=!0,ot.textContent="Cr\xE9ation...");try{let C=await fetch("/api/sites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:g,slug:A})});if(!C.ok){let q=await C.json().catch(()=>({})),p=q.message||"Impossible de cr\xE9er ce site.";Te&&(Te.textContent=p),q.field==="slug"&&ye&&(ye.textContent=p);return}let G=await C.json(),W=ze((G==null?void 0:G.slug)||A),$=(G==null?void 0:G.name)||g;It(W,$),Tt();let F=encodeURIComponent(Se(W));window.location.href=`/admin/site/${F}/design`}catch(C){console.error("[admin] Impossible de cr\xE9er le site",C),Te&&(Te.textContent="Erreur inattendue. R\xE9essaie dans un instant.")}finally{ot&&(ot.disabled=!1,ot.textContent="Cr\xE9er")}}),window.addEventListener("keydown",o=>{o.key==="Escape"&&(ue&&!ue.classList.contains("hidden")&&Tt(),Ye&&!Ye.classList.contains("hidden")&&qs(),blockDeleteModal&&!blockDeleteModal.classList.contains("hidden")&&closeBlockDeleteModal(),blockLibraryOpen&&closeBlockLibrary())});function an(){let o=window.location.pathname.match(/^\/admin\/site\/([^/]+)(?:\/([^/]+))?/);return o?{slugPart:decodeURIComponent(o[1]),slugValue:ze(decodeURIComponent(o[1])),section:o[2]||"design"}:null}function rn(){return document.querySelector("[data-page-list]")?"design":document.querySelector("[data-collection-list]")?"content":document.querySelector("[data-media-grid]")?"media":document.querySelector("[data-deploy-form]")?"deploy":null}function ln(){if(!Ye){window.location.href="/admin/sites";return}Ye.classList.remove("hidden"),Ye.classList.add("flex")}function qs(){Ye&&(Ye.classList.add("hidden"),Ye.classList.remove("flex"))}_s.forEach(o=>{o.addEventListener("click",ln)}),Ys.forEach(o=>{o.addEventListener("click",qs)}),Xt==null||Xt.addEventListener("click",()=>{window.location.href="/admin/sites"});let ht=(z==null?void 0:z.section)||rn();ht==="design"&&cn(),ht==="content"&&dn(),ht==="media"&&pn(),ht==="deploy"&&un(),ht==="settings"&&mn(),z&&Q.name&&ks(Q.name);function cn(){let o=document.querySelectorAll("[data-page-list]");if(o.length===0)return;let g=document.querySelector("[data-active-page-title]"),x=document.querySelector("[data-active-page-slug]"),A=document.querySelector("[data-page-preview-tags]"),I=document.querySelector("[data-page-preview-frame]"),C=document.querySelector("[data-preview-open]"),G=document.querySelector("[data-preview-status]"),W=document.querySelector("[data-preview-highlight]"),$=document.querySelector("[data-seo-toggle]"),F=document.querySelector("[data-seo-panel]"),q=document.querySelector("[data-seo-close]"),p=document.querySelector("[data-seo-form]"),w=document.querySelector("[data-seo-title]"),f=document.querySelector("[data-seo-description]"),d=document.querySelector("[data-seo-indexed]"),E=document.querySelector("[data-seo-feedback]"),T=document.querySelector("[data-seo-save]"),a=document.querySelector("[data-blocks-list]"),k=document.querySelector("[data-blocks-empty]"),B=document.querySelector("[data-block-count]"),Z=document.querySelector("[data-block-library-toggle]"),U=document.querySelector("[data-block-library]"),_=document.querySelectorAll("[data-block-add]"),K=document.querySelector("[data-block-delete-modal]"),V=document.querySelector("[data-block-delete-confirm]"),D=document.querySelector("[data-block-delete-cancel]"),N=document.querySelector("[data-block-detail-empty]"),H=document.querySelector("[data-block-detail-status]"),h=document.querySelector("[data-block-editor]"),l=document.querySelector("[data-block-editor-block-name]"),u=document.querySelector("[data-block-editor-block-type]"),S=document.querySelector("[data-block-editor-unsupported]"),m=document.querySelector("[data-block-form]"),te=m?Array.from(m.querySelectorAll("[data-editor-section]")):[],oe=document.querySelectorAll("[data-block-tab]"),re="content",ne=document.querySelector("[data-block-form-actions]"),me=document.querySelector("[data-block-form-autosave]"),ie=e=>{re=e,oe.forEach(s=>{let n=s.dataset.blockTab===e;s.setAttribute("aria-selected",n?"true":"false"),n?(s.classList.add("text-[#9C6BFF]"),s.classList.remove("text-slate-500","hover:text-slate-700"),s.classList.add("after:absolute","after:bottom-0","after:left-0","after:right-0","after:h-0.5","after:bg-[#9C6BFF]")):(s.classList.remove("text-[#9C6BFF]"),s.classList.add("text-slate-500","hover:text-slate-700"),s.classList.remove("after:absolute","after:bottom-0","after:left-0","after:right-0","after:h-0.5","after:bg-[#9C6BFF]"))});let t=m==null?void 0:m.querySelector("[data-editor-section]:not(.hidden)");t&&t.querySelectorAll("[data-block-panel]").forEach(n=>{n.dataset.blockPanel===e?n.classList.remove("hidden"):n.classList.add("hidden")}),ne&&me&&(e==="content"?(ne.classList.remove("hidden"),me.classList.add("hidden")):(ne.classList.add("hidden"),me.classList.remove("hidden")))};oe.forEach(e=>{e.addEventListener("click",()=>{ie(e.dataset.blockTab)})});let J=m==null?void 0:m.querySelector('[name="collection-grid-collection"]'),xe=m==null?void 0:m.querySelector("[data-collection-selection-info]"),ae=document.querySelector("[data-block-form-cancel]"),$e=m==null?void 0:m.querySelector("[data-group-preview-mobile]"),le=m==null?void 0:m.querySelector("[data-group-preview-desktop]"),qe=m==null?void 0:m.querySelector("[data-collection-preview-mobile]"),Le=m==null?void 0:m.querySelector("[data-collection-preview-desktop]"),Ve={hero:{section:"hero",labelField:"title",descriptionField:"subtitle",fields:{title:"hero-title",subtitle:"hero-subtitle",ctaLabel:"hero-cta-label",ctaUrl:"hero-cta-url",image:"hero-image",layout:"hero-layout",height:"hero-height",contentAlign:"hero-content-align",overlay:"hero-overlay",titleSize:"hero-title-size",bg:"hero-bg",borderRadius:"hero-border-radius",shadow:"hero-shadow"}},paragraphe:{section:"paragraph",labelField:"title",descriptionField:"content",fields:{title:"paragraph-title",content:"paragraph-content",align:"paragraph-align",titleSize:"paragraph-title-size",textSize:"paragraph-text-size",spacing:"paragraph-spacing",bg:"paragraph-bg",borderRadius:"paragraph-border-radius",shadow:"paragraph-shadow"}},image:{section:"image",labelField:"alt",fields:{src:"image-src",alt:"image-alt",showCaption:"image-caption-toggle",caption:"image-caption",rounded:"image-rounded",shadow:"image-shadow",maxWidth:"image-max-width",align:"image-align",bg:"image-bg",borderRadius:"image-border-radius"}},groupe:{section:"group",fields:{columnsMobile:"group-columns-mobile",columnsDesktop:"group-columns-desktop",gap:"group-gap",itemsAlign:"group-items-align",bg:"group-bg",borderRadius:"group-border-radius",shadow:"group-shadow"}},collectiongrid:{section:"collection",fields:{collectionId:"collection-grid-collection",limit:"collection-grid-limit",columnsMobile:"collection-columns-mobile",columnsDesktop:"collection-columns-desktop",gap:"collection-gap",itemsAlign:"collection-items-align",cardRounded:"collection-card-rounded",bg:"collection-bg",borderRadius:"collection-border-radius",shadow:"collection-shadow"}},form:{section:"form",labelField:"formTitle",fields:{formTitle:"form-title",actionUrl:"form-action-url",method:"form-method",serviceName:"form-service-name",submitLabel:"form-submit-label",successMessage:"form-success-message",maxWidth:"form-max-width",align:"form-align",buttonRounded:"form-button-rounded",spacing:"form-spacing",bg:"form-bg",borderRadius:"form-border-radius",shadow:"form-shadow"}},newsletterembed:{section:"newsletter",labelField:"title",fields:{title:"newsletter-title",serviceName:"newsletter-service-name",embedCode:"newsletter-embed-code",maxWidth:"newsletter-max-width",align:"newsletter-align",padding:"newsletter-padding",bg:"newsletter-bg",borderRadius:"newsletter-border-radius",shadow:"newsletter-shadow"}}},Ze={texte:"paragraphe",paragraph:"paragraphe",paragraphs:"paragraphe",paragraphes:"paragraphe",text:"paragraphe",hero:"hero",image:"image",groupe:"groupe",group:"groupe",collection:"collectiongrid",collectiongrid:"collectiongrid","collection-grid":"collectiongrid",form:"form",formulaire:"form",contact:"form",newsletterembed:"newsletterembed",newsletter:"newsletterembed",embed:"newsletterembed"},Qe=(e,t)=>{if(!$e||!le)return;let s=n=>Array.from({length:Number(n)||1}).map(()=>'<span class="block h-2 w-full rounded-full bg-slate-300"></span>').join("");$e.innerHTML=s(e),le.innerHTML=s(t)},Je=(e,t)=>{if(!qe||!Le)return;let s=n=>Array.from({length:Number(n)||1}).map(()=>'<span class="block h-2 w-full rounded-full bg-violet-300"></span>').join("");qe.innerHTML=s(e),Le.innerHTML=s(t)},et=async()=>{if(!Ee)return[];let e=await fetch(Ee,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les pages.");let t=await e.json().catch(()=>[]);return Array.isArray(t)?t:[]},at=async({title:e,slug:t})=>{if(!Ee)throw new Error("Site inconnu.");let s=await fetch(Ee,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,slug:t})});if(!s.ok){let n=await s.json().catch(()=>({}));throw new Error(n.message||"Impossible de cr\xE9er la page.")}return s.json().catch(()=>({}))},c=async e=>{if(!(!Ee||!(e!=null&&e.id)))try{let t=await fetch(`${Ee}/${encodeURIComponent(e.id)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let n=await t.json().catch(()=>({}));throw new Error(n.message||"Impossible de sauvegarder la page.")}let s=await t.json().catch(()=>({}));if(s!=null&&s.id){let n=St(s);return ee=ee.map(i=>i.id===n.id?n:i),(v==null?void 0:v.id)===n.id&&(v=n),n}return s}catch(t){console.error("[design] Save page failed",t),P(t.message||"Sauvegarde impossible.")}},L=async()=>{if(!Ee){ee=[],ge=null,v=null,ct(ee,ge),lt(null),N==null||N.classList.remove("hidden"),h==null||h.classList.add("hidden");return}try{let e=await et();if(ee=(Array.isArray(e)?e:[]).map(t=>St(t)),ee.length===0){ge=null,v=null,ct(ee,ge),lt(null),N==null||N.classList.remove("hidden"),h==null||h.classList.add("hidden"),I&&(I.srcdoc=r());return}ge=Sn(ee),Fe(ge)}catch(e){console.error("[design] Impossible de charger les pages",e),P("Impossible de charger les pages.")}},Y=e=>(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),O=e=>{if(!e)return null;let t=Y(e.type),s=Ze[t]||t;return Ve[s]||null},Ke=e=>{var s,n,i,y,M;if(!m||!h)return;e&&!e.settings&&(e.settings={});let t=O(e);if(l&&(l.textContent=(e==null?void 0:e.label)||"Bloc"),u&&(u.textContent=(e==null?void 0:e.type)||"Bloc"),!t){m.classList.add("hidden"),S==null||S.classList.remove("hidden"),m.dataset.blockId="";return}if(S==null||S.classList.add("hidden"),m.classList.remove("hidden"),m.reset(),m.dataset.blockId=e.id,te.forEach(R=>{R.dataset.editorSection===t.section?R.classList.remove("hidden"):R.classList.add("hidden")}),ie("content"),t.section==="collection"){let R=e.collectionId||((s=e.settings)==null?void 0:s.collectionId)||"";zt(R)}if(Object.entries(t.fields).forEach(([R,se])=>{var mt;let he=m.querySelector(`[name="${se}"]`);if(!he)return;let be=(mt=e.settings)==null?void 0:mt[R];he.type==="checkbox"?he.checked=!!be:he.type==="number"?he.value=be!=null?be:1:(he.tagName,he.value=be!=null?be:"")}),t.section==="group"){let R=((n=m.querySelector('[name="group-columns-mobile"]'))==null?void 0:n.value)||"1",se=((i=m.querySelector('[name="group-columns-desktop"]'))==null?void 0:i.value)||"3";Qe(R,se)}if(t.section==="collection"){let R=((y=m.querySelector('[name="collection-columns-mobile"]'))==null?void 0:y.value)||"1",se=((M=m.querySelector('[name="collection-columns-desktop"]'))==null?void 0:M.value)||"3";Je(R,se)}},We=e=>{if(!m||!e)return{};let t={};return Object.entries(e.fields).forEach(([s,n])=>{let i=m.querySelector(`[name="${n}"]`);if(i)if(i.type==="checkbox")t[s]=i.checked;else if(i.type==="number"){let y=Number(i.value);t[s]=Number.isFinite(y)?y:0}else i.tagName==="TEXTAREA"?t[s]=i.value||"":i.type==="select-one"?t[s]=i.value:t[s]=i.value||""}),t},je=e=>{if(G){if(!e){G.classList.add("hidden");return}G.classList.remove("hidden"),G.textContent=e}},$t=e=>e?{id:e.id,title:e.title,slug:e.slug,badges:[...e.badges||[]],blocks:(e.blocks||[]).map(t=>{var s;return{id:t.id,type:t.type,label:t.label,status:t.status,description:t.description,props:t.props||[],settings:t.settings||{},collectionId:t.collectionId||((s=t.settings)==null?void 0:s.collectionId)||""}})}:null,r=()=>'<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#475569;background:#fff;">Pr\xE9paration de la pr\xE9visualisation\u2026</body></html>',b=(e,t)=>{let s;return(...n)=>{clearTimeout(s),s=setTimeout(()=>e(...n),t)}},j=null,X=()=>{if(!v||!de)return;let e=dt(),t=O(e);if(!e||!t)return;let s=We(t),n=(v.blocks||[]).map(y=>{if(y.id!==e.id)return y;let M={...y.settings||{},...s};return{...y,settings:M}}),i={...v,blocks:n};v=i,c(i)},ce=(e,t)=>{!I||!I.contentWindow||I.contentWindow.postMessage({type:"updateBlockStyles",blockId:e,settings:t},"*")},yt=b(()=>{X(),je("Sauvegard\xE9"),setTimeout(()=>je("\xC0 jour"),1500)},800),tt=b(()=>{v&&rt(v)},1500),Ge=(e,t)=>{ce(e,t),je("Modification\u2026"),yt(),tt()},rt=e=>{if(!I||!e)return;let t=(z==null?void 0:z.slugValue)||Q.slug||"",s={page:$t(e),site:{title:Q.name||"Site",slug:t}};fs=!1,je("Actualisation\u2026"),I.srcdoc=r(),wt&&wt.abort();let n=new AbortController;wt=n,fetch("/api/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s),signal:n.signal}).then(i=>{if(!i.ok)throw new Error("Preview error");return i.json()}).then(i=>{n.signal.aborted||(ps=i.html||"",I.setAttribute("title",`Pr\xE9visualisation de la page ${e.title||""}`.trim()),I.srcdoc=ps||r(),je("\xC0 jour"))}).catch(i=>{n.signal.aborted||(console.error("[preview] Impossible de rendre la page",i),je("Erreur preview"),I.srcdoc='<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#be123c;background:#fff;">Erreur lors du rendu de la pr\xE9visualisation.</body></html>')}).finally(()=>{wt===n&&(wt=null)})},jt=e=>{if(e.preventDefault(),!v||!de)return;let t=dt(),s=O(t);if(!t||!s)return;let n=We(s);if(s.section==="collection"){if(!n.collectionId){P("S\xE9lectionnez une collection.");return}n.limit=Math.max(1,Number(n.limit)||1)}let i=(v.blocks||[]).map(y=>{if(y.id!==t.id)return y;let M={...y.settings||{},...n},R={...y,settings:M};return s.labelField&&n[s.labelField]&&(R.label=n[s.labelField]),s.descriptionField&&n[s.descriptionField]&&(R.description=n[s.descriptionField]),s.section==="collection"&&(R.collectionId=n.collectionId,R.settings.collectionId=n.collectionId,R.settings.limit=n.limit),R});ut(i),P("Bloc mis \xE0 jour"),Fe(v.id,{preserveBlock:!0})},Pe=document.querySelector("[data-page-drawer]"),pe=document.querySelector("[data-page-drawer-backdrop]"),fn=document.querySelectorAll("[data-page-drawer-open]"),gn=document.querySelectorAll("[data-page-drawer-close]"),st=document.querySelector("[data-add-page-toggle]"),Ae=document.querySelector("[data-add-page-form]"),Ne=document.querySelector("[data-add-page-title]"),Me=document.querySelector("[data-add-page-slug]"),ts=document.querySelector("[data-add-page-cancel]"),ve=document.querySelector("[data-add-page-error]"),it=Ae==null?void 0:Ae.querySelector('[type="submit"]'),ss=document.querySelector("[data-import-pages-toggle]"),De=document.querySelector("[data-import-modal]"),hn=document.querySelectorAll("[data-import-modal-close]"),Ce=document.querySelector("[data-import-dropzone]"),ns=document.querySelector("[data-import-file-input]"),os=document.querySelector("[data-import-file-list]"),As=document.querySelector("[data-import-file-names]"),Pt=document.querySelector("[data-import-results]"),Nt=document.querySelector("[data-import-results-content]"),fe=document.querySelector("[data-import-submit]"),Fs=document.querySelectorAll("[data-import-tab]"),yn=document.querySelectorAll("[data-import-panel]"),as=document.querySelector("[data-copy-template]"),Is=document.querySelector("[data-template-json]"),Xe=[],Re=document.querySelector("[data-delete-page-modal]"),Bs=document.querySelector("[data-delete-page-name]"),rs=document.querySelector("[data-delete-page-cancel]"),_e=document.querySelector("[data-delete-page-confirm]"),vt=null,vn=Se((z==null?void 0:z.slugValue)||Q.slug||"default")||"default",bn=(z==null?void 0:z.slugValue)||Q.slug||"",Mt=Se(bn)||"",Ee=Mt?`/api/sites/${encodeURIComponent(Mt)}/pages`:null,Ts=Mt?`/api/sites/${encodeURIComponent(Mt)}/collections`:null,$s={active:`clower:activePage:${vn}`},is=(e,t,s,n,i,y=[],M={})=>{let R={id:e,label:t,type:s,status:n,description:i,props:y,settings:{...M}};return R.settings.collectionId&&(R.collectionId=R.settings.collectionId),R},xn={hero:{type:"Hero",label:"Hero de page",description:"Section pleine largeur avec CTA principal.",status:"Brouillon",props:[{label:"CTA",value:"D\xE9couvrir"},{label:"Hauteur",value:"80vh"}],settings:{title:"Titre du hero",subtitle:"",ctaLabel:"D\xE9couvrir",ctaUrl:"#",image:"",align:"center"}},paragraph:{type:"Paragraphe",label:"Bloc \xE9ditorial",description:"Paragraphe libre pour raconter votre histoire.",status:"Brouillon",props:[{label:"Longueur",value:"150 mots"}],settings:{title:"Titre du paragraphe",content:"",align:"left"}},image:{type:"Image",label:"Bloc image",description:"Visuel seul avec l\xE9gende optionnelle.",status:"Brouillon",props:[{label:"Ratio",value:"16:9"},{label:"L\xE9gende",value:"Inactive"}],settings:{src:"",alt:"",showCaption:!1,caption:""}},group:{type:"Groupe",label:"Groupe de sections",description:"Conteneur pour imbriquer plusieurs sous-blocs.",status:"Brouillon",props:[{label:"Disposition",value:"Verticale"}],settings:{layout:"grid",columnsMobile:"1",columnsDesktop:"3"}},collectiongrid:{type:"CollectionGrid",label:"Grille de contenus",description:"Affiche automatiquement les items d\u2019une collection.",status:"Brouillon",settings:{collectionId:"",limit:6}},form:{type:"Form",label:"Formulaire de contact",description:"Formulaire avec envoi vers un service externe.",status:"Brouillon",settings:{formTitle:"Contactez-nous",actionUrl:"",method:"POST",serviceName:"",submitLabel:"Envoyer",successMessage:"Merci pour votre message !"}},newsletterembed:{type:"NewsletterEmbed",label:"Newsletter / Embed",description:"Int\xE9gration d'un formulaire newsletter externe (Brevo, Mailchimp\u2026).",status:"Brouillon",settings:{title:"Restez inform\xE9",serviceName:"",embedCode:""}}},wn=e=>{try{window.localStorage.setItem($s.active,e)}catch{}},Sn=e=>{var t;try{let s=window.localStorage.getItem($s.active);if(s&&e.some(n=>n.id===s))return s}catch{}return((t=e[0])==null?void 0:t.id)||null},Ln=e=>!e||e<=0?"0 bloc":e===1?"1 bloc":`${e} blocs`,js=e=>{if(!e||e==="/")return"/";let t=gt(e.replace(/^\//,""));return t?`/${t}`:"/"},ls=(e="page",t="block")=>`${e}-${t}-${Date.now().toString(36)}-${Math.floor(Math.random()*1e3)}`,Xn=(e,t)=>[is(ls(e,"intro"),"Introduction","Paragraphe","Brouillon",`Paragraphe introductif pour "${t}".`,[{label:"Longueur",value:"2 paragraphes"}],{title:`Introduction \xE0 ${t}`,content:"Ajoutez votre premier paragraphe de pr\xE9sentation.",align:"left"}),is(ls(e,"content"),"Zone de contenu","Groupe","Brouillon","Section principale \xE0 composer avec textes et visuels.",[{label:"Colonnes",value:"Auto"}],{layout:"grid",columnsMobile:"1",columnsDesktop:"2"})],Cn=e=>{g&&(g.textContent=(e==null?void 0:e.title)||"Page"),x&&(x.textContent=(e==null?void 0:e.slug)||"/")},En=e=>{if(!A)return;A.innerHTML="",(e&&e.badges&&e.badges.length>0?e.badges:["Structure en cours"]).forEach(s=>{let n=document.createElement("span");n.className="rounded-full bg-slate-100 px-3 py-1",n.textContent=s,A.appendChild(n)})},kn=e=>{switch((e||"").toLowerCase()){case"en ligne":return"bg-emerald-50 text-emerald-700";case"brouillon":return"bg-amber-50 text-amber-700";default:return"bg-slate-100 text-slate-600"}},Dt=e=>{if(!(!N||!h)){if(!e){N.classList.remove("hidden"),h.classList.add("hidden"),S==null||S.classList.add("hidden"),m==null||m.classList.add("hidden"),H==null||H.classList.add("hidden");return}N.classList.add("hidden"),h.classList.remove("hidden"),H&&(e.status?(H.textContent=e.status,H.className=`rounded-full px-3 py-1 text-xs font-semibold ${kn(e.status)}`,H.classList.remove("hidden")):H.classList.add("hidden")),Ke(e)}},bt=e=>{if(!I)return;let t=I.contentDocument;if(!t)return;t.querySelectorAll("[data-preview-block]").forEach(n=>{n.dataset.previewBlock===e?(n.classList.add("preview-block-active"),fs&&e&&n.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})):n.classList.remove("preview-block-active")}),W&&(W.style.borderColor=e?"rgba(156, 107, 255, 0.5)":"transparent")},lt=e=>{if(!a)return;a.innerHTML="";let t=(e==null?void 0:e.blocks)||[];if(B&&(B.textContent=Ln(t.length)),t.length===0){a.classList.add("hidden"),k==null||k.classList.remove("hidden");return}a.classList.remove("hidden"),k==null||k.classList.add("hidden"),t.forEach(s=>{var Vs;let n=s.id===de,i=document.createElement("div");i.dataset.blockItem="true",i.dataset.blockId=s.id,i.setAttribute("role","option"),i.setAttribute("aria-selected",n?"true":"false"),i.setAttribute("draggable","true"),i.tabIndex=0,i.className=["relative flex items-center gap-3 rounded-2xl border px-3 py-2 text-left transition group",n?"bg-slate-100 border-[#9C6BFF]/40 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let y=document.createElement("span");y.className=`absolute inset-y-2 left-0 w-1 rounded-full bg-[#9C6BFF] ${n?"":"hidden"}`,i.appendChild(y);let M=document.createElement("div");M.className="flex flex-1 items-center gap-3";let R=document.createElement("div");R.className="hidden lg:flex cursor-grab active:cursor-grabbing flex-shrink-0 items-center text-lg text-slate-400 hover:text-slate-600 transition-colors select-none",R.innerHTML="\u22EE\u22EE",R.setAttribute("title","Glisser pour r\xE9ordonner"),M.appendChild(R);let se=document.createElement("div");se.className="flex-1";let he=document.createElement("div");he.className="flex items-center gap-2 text-[11px] uppercase tracking-wide text-slate-500";let be=document.createElement("span");be.className="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600",be.textContent=s.type;let mt=document.createElement("span");mt.className="text-slate-400",mt.textContent=s.status,he.appendChild(be),he.appendChild(mt);let ys=document.createElement("p");ys.className="mt-1 text-sm font-semibold text-slate-900";let Gn=s.settings&&s.settings.title||s.label||"Bloc sans titre";if(ys.textContent=Gn,se.appendChild(he),se.appendChild(ys),(s.type||"").toLowerCase()==="collectiongrid"&&s.collectionId){let Ie=((Vs=Oe.find(_n=>_n.id===s.collectionId))==null?void 0:Vs.name)||s.collectionId,vs=document.createElement("p");vs.className="text-xs text-slate-400",vs.textContent=`Collection : ${Ie}`,se.appendChild(vs)}M.appendChild(se),i.appendChild(M);let Jt=document.createElement("div");Jt.className="flex flex-col gap-1 text-xs text-slate-400";let Wt=document.createElement("div");Wt.className="flex items-center gap-1 lg:hidden";let Lt=document.createElement("button");Lt.type="button",Lt.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",Lt.textContent="\u2191",Lt.addEventListener("click",Ie=>{Ie.stopPropagation(),Ps(s.id,-1)});let Ct=document.createElement("button");Ct.type="button",Ct.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",Ct.textContent="\u2193",Ct.addEventListener("click",Ie=>{Ie.stopPropagation(),Ps(s.id,1)}),Wt.appendChild(Lt),Wt.appendChild(Ct),Jt.appendChild(Wt);let Et=document.createElement("button");Et.type="button",Et.className="inline-flex items-center justify-center rounded-lg border border-transparent px-2 py-1 text-[12px] text-rose-500 hover:text-rose-700",Et.innerHTML="\u{1F5D1}\uFE0F",Et.addEventListener("click",Ie=>{Ie.stopPropagation(),$n(s.id)}),Jt.appendChild(Et),i.appendChild(Jt),i.addEventListener("click",()=>{nt(s.id)}),i.addEventListener("keydown",Ie=>{(Ie.key==="Enter"||Ie.key===" ")&&(Ie.preventDefault(),nt(s.id))}),a.appendChild(i)})},qn=e=>{!Re||!e||(vt=e,Bs&&(Bs.textContent=e.title||e.id),Re.classList.remove("hidden"),Re.classList.add("flex"))},cs=()=>{Re&&(Re.classList.add("hidden"),Re.classList.remove("flex"),vt=null)},An=async()=>{if(!Ee||!vt)return;let e=vt.id,t=vt.title||e;_e&&(_e.disabled=!0,_e.textContent="Suppression...");try{let s=await fetch(`${Ee}/${encodeURIComponent(e)}`,{method:"DELETE",credentials:"include"}),n=await s.json();if(!s.ok)throw new Error(n.message||"Erreur serveur");ee=ee.filter(i=>i.id!==e),ge===e?ee.length>0?Fe(ee[0].id):(ge=null,v=null,ct(ee,null),lt(null),N==null||N.classList.remove("hidden"),h==null||h.classList.add("hidden"),I&&(I.srcdoc=r())):ct(ee,ge),cs(),P(`Page "${t}" supprim\xE9e`)}catch(s){console.error("[pages] delete failed",s),P(s.message||"Erreur suppression")}finally{_e&&(_e.disabled=!1,_e.textContent="Supprimer")}},ct=(e,t)=>{o.forEach(s=>{s.innerHTML="",e.forEach(n=>{let i=document.createElement("li");i.className="flex items-center gap-1";let y=document.createElement("button");y.type="button",y.dataset.pageId=n.id,y.className=["flex-1 flex items-center gap-3 px-3 py-2 text-left transition",t===n.id?"bg-[#9C6BFF]/10 text-slate-900 border border-[#9C6BFF]/40 rounded-xl shadow-sm":"text-slate-700 hover:bg-slate-50 rounded-xl"].join(" "),t===n.id?y.setAttribute("aria-current","page"):y.removeAttribute("aria-current"),y.innerHTML=`
            <span class="flex h-9 w-9 items-center justify-center rounded-xl border border-slate-200 bg-white text-slate-500">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M6.5 4.5h7l4 4v11a1 1 0 0 1-1 1h-10a1 1 0 0 1-1-1v-14a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
                <path d="M13.5 4.5v4a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.4"/>
              </svg>
            </span>
            <div class="flex flex-col">
              <span class="text-sm font-semibold">${n.title}</span>
              <span class="text-xs text-slate-500">${n.slug}</span>
            </div>
          `,y.addEventListener("click",()=>{Fe(n.id),us()||ms()}),i.appendChild(y);let M=document.createElement("button");M.type="button",M.className="flex-shrink-0 p-2 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition",M.title="Supprimer cette page",M.setAttribute("aria-label",`Supprimer ${n.title}`),M.innerHTML=`
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14ZM10 11v6M14 11v6"/>
            </svg>
          `,M.addEventListener("click",R=>{R.stopPropagation(),qn(n)}),i.appendChild(M),s.appendChild(i)})})},dt=()=>!v||!Array.isArray(v.blocks)?null:v.blocks.find(e=>e.id===de)||null,nt=e=>{if(!v)return;if(!e){de=null,lt(v),Dt(null),bt(null);return}let t=v.blocks.find(s=>s.id===e)||v.blocks[0]||null;de=(t==null?void 0:t.id)||null,lt(v),Dt(t),bt(de)},ut=e=>{if(!v)return;let t={...v,blocks:e};jn(t)},Rt=()=>window.matchMedia("(min-width: 1024px)").matches;function Ps(e,t){if(!v||!e||!t)return;let s=[...v.blocks||[]],n=s.findIndex(M=>M.id===e);if(n<0)return;let i=n+t;if(i<0||i>=s.length)return;let[y]=s.splice(n,1);s.splice(i,0,y),ut(s),Fe(v.id,{preserveBlock:!0}),nt(y.id)}function Zn(e,t){if(!v||!e||!t||e===t)return;let s=[...v.blocks||[]],n=s.findIndex(M=>M.id===e),i=s.findIndex(M=>M.id===t);if(n<0||i<0)return;let[y]=s.splice(n,1);s.splice(i,0,y),ut(s),Fe(v.id,{preserveBlock:!0}),nt(y.id)}function Fn(e,t,s){if(!v||!e||!t||e===t)return;let n=[...v.blocks||[]],i=n.findIndex(se=>se.id===e),y=n.findIndex(se=>se.id===t);if(i<0||y<0)return;let[M]=n.splice(i,1);i<y&&y--;let R=s==="before"?y:y+1;n.splice(R,0,M),ut(n),Fe(v.id,{preserveBlock:!0}),nt(M.id)}function Ns(){if(!a)return;let e=Rt();a.querySelectorAll("[data-block-item]").forEach(t=>{t.setAttribute("draggable",e?"true":"false")})}function Ot(){U&&(U.classList.add("hidden"),xt=!1)}function In(){U&&(U.classList.remove("hidden"),xt=!0)}function Bn(){xt?Ot():In()}function Tn(e){var y;if(!v||!e)return;let t=xn[e];if(!t)return;let s=(v.blocks||[]).filter(M=>M.type===t.type).length+1,n=is(ls(v.id,e),`${t.label} ${s}`,t.type,t.status,t.description,t.props,t.settings||{});if((t.type||"").toLowerCase()==="collectiongrid"){let M=((y=Oe[0])==null?void 0:y.id)||"";n.collectionId=M,n.settings.collectionId=M,n.settings.limit=n.settings.limit||6}let i=[...v.blocks||[],n];ut(i),Fe(v.id,{preserveBlock:!0}),nt(n.id),Ot(),P("Bloc ajout\xE9")}function Ms(e){var n,i;if(!v)return;let t=(v.blocks||[]).filter(y=>y.id!==e),s=e===de?((n=t[0])==null?void 0:n.id)||null:de||((i=t[0])==null?void 0:i.id)||null;ut(t),de=s,Fe(v.id,{preserveBlock:!0}),de?nt(de):(Dt(null),bt(null)),P("Bloc supprim\xE9")}function ds(){K&&(K.classList.add("hidden"),K.classList.remove("flex"),Ht=null)}function $n(e){if(!K){Ms(e);return}Ht=e,K.classList.remove("hidden"),K.classList.add("flex")}let jn=e=>{if(!e)return;let t=St(e);ee=ee.map(s=>s.id===t.id?t:s),v=t,c(t)},Fe=(e,t={})=>{var i,y;let s=ee.find(M=>M.id===e)||ee[0]||null;v=s?St(s):null,ge=(s==null?void 0:s.id)||null,(!t.preserveBlock||!v||!v.blocks.some(M=>M.id===de))&&(de=((y=(i=v==null?void 0:v.blocks)==null?void 0:i[0])==null?void 0:y.id)||null),ge&&wn(ge),ct(ee,ge),Cn(v),En(v),rt(v),lt(v),Dt(dt()),bt(de),Ns(),xt&&Ot()},us=()=>window.matchMedia("(min-width: 1024px)").matches,Ds=()=>{Pe&&(us()?(Pe.classList.add("is-open"),pe==null||pe.classList.add("hidden"),document.body.classList.remove("overflow-hidden")):Pe.classList.remove("is-open"))},Pn=()=>{!Pe||us()||(Pe.classList.add("is-open"),pe==null||pe.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},ms=()=>{Pe&&(Pe.classList.remove("is-open"),pe==null||pe.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))},Nn=()=>{!Ae||!st||(Ae.classList.remove("hidden"),st.classList.add("hidden"),ve&&(ve.textContent=""),Ut=!1,Ne&&(Ne.value="",Ne.focus()),Me&&(Me.value=""))},Rs=()=>{!Ae||!st||(Ae.classList.add("hidden"),st.classList.remove("hidden"),ve&&(ve.textContent=""),Ut=!1,Ae.reset())},Mn=()=>{!Ne||!Me||Ut&&Me.value.trim().length>0||(Me.value=js(Ne.value))},ee=[],ge=null,Ut=!1,v=null,de=null,xt=!1,Ht=null,ps="",fs=!1,wt=null,Oe=[],Dn=e=>{let t={...e,props:Array.isArray(e.props)?e.props:[],settings:{...e.settings||{}}};return(t.type||"").toLowerCase()==="collectiongrid"&&(t.collectionId=t.collectionId||t.settings.collectionId||"",t.settings.collectionId=t.collectionId,t.settings.limit=t.settings.limit||6),t},St=e=>{var t,s;return{...e,blocks:(e.blocks||[]).map(n=>Dn(n)),seo:{title:(((t=e.seo)==null?void 0:t.title)||"").trim(),description:(((s=e.seo)==null?void 0:s.description)||"").trim()}}},Rn=async()=>{if(!Ts){Oe=[],zt();return}try{let e=await fetch(Ts,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les collections.");let t=await e.json().catch(()=>[]);Oe=Array.isArray(t)?t:[];let s=(J==null?void 0:J.value)||"";zt(s)}catch(e){console.error("[design] collections load",e),P("Collections indisponibles."),Oe=[],zt()}},gs=e=>{if(!xe)return;if(!e){xe.textContent=Oe.length?"S\xE9lectionnez une collection pour afficher ses informations.":"Aucune collection disponible. Ajoutez-en depuis l\u2019onglet Contenus.";return}let t=Oe.find(n=>n.id===e);if(!t){xe.textContent=`Collection ${e}`;return}let s=[];t.description&&s.push(t.description),t.type&&s.push(`Type\xA0: ${t.type}`),xe.textContent=s.join(" \xB7 ")||`Collection ${t.name||t.id}`},zt=(e="")=>{if(J){if(J.innerHTML="",!Oe.length){J.disabled=!0;let t=document.createElement("option");t.value="",t.textContent="Aucune collection disponible",J.appendChild(t),gs("");return}if(J.disabled=!1,e&&!Oe.some(t=>t.id===e)){let t=document.createElement("option");t.value=e,t.textContent=e,J.appendChild(t)}Oe.forEach(t=>{let s=document.createElement("option");s.value=t.id;let n=t.name||t.id;s.textContent=t.type?`${n} \xB7 ${t.type}`:n,s.dataset.description=t.description||"",J.appendChild(s)}),e&&(J.value=e),gs(J.value||"")}};Rn(),Ds(),fn.forEach(e=>{e.addEventListener("click",Pn)}),gn.forEach(e=>{e.addEventListener("click",ms)}),pe==null||pe.addEventListener("click",ms),window.addEventListener("resize",()=>{Ds(),Ns()}),st==null||st.addEventListener("click",Nn),ts==null||ts.addEventListener("click",Rs),Ne==null||Ne.addEventListener("input",Mn),Me==null||Me.addEventListener("input",()=>{ve&&(ve.textContent=""),Ut=!0}),Ae==null||Ae.addEventListener("submit",async e=>{if(e.preventDefault(),!Ee){ve&&(ve.textContent="Aucun site s\xE9lectionn\xE9.");return}if(!Ne||!Me)return;let t=Ne.value.trim(),s=js(Me.value.trim()||t);if(!t||!s){ve&&(ve.textContent="Titre et slug sont requis.");return}ve&&(ve.textContent=""),it&&(it.disabled=!0,it.textContent="Cr\xE9ation...");try{let n=await at({title:t,slug:s});if(!n||!n.id)throw new Error("R\xE9ponse invalide.");ee=[...ee,St(n)],Rs(),P("Page cr\xE9\xE9e"),Fe(n.id)}catch(n){console.error("[design] create page failed",n),ve&&(ve.textContent=n.message||"Impossible de cr\xE9er la page.")}finally{it&&(it.disabled=!1,it.textContent="Cr\xE9er")}});let On=()=>{De&&(De.classList.remove("hidden"),De.classList.add("flex"),Xe=[],hs(),Pt&&Pt.classList.add("hidden"),Nt&&(Nt.innerHTML=""),fe&&(fe.disabled=!0))},Os=()=>{De&&(De.classList.add("hidden"),De.classList.remove("flex"),Xe=[])},hs=()=>{if(!(!os||!As)){if(Xe.length===0){os.classList.add("hidden"),fe&&(fe.disabled=!0);return}os.classList.remove("hidden"),As.innerHTML=Xe.map(e=>`<li class="flex items-center gap-2"><span class="text-lg">\u{1F4C4}</span>${e.name}</li>`).join(""),fe&&(fe.disabled=!1)}},Us=e=>{let t=Array.from(e).filter(s=>s.type==="application/json"||s.name.endsWith(".json"));if(t.length===0){P("Aucun fichier JSON valide.");return}Xe=t,hs()},Un=async()=>{if(!(!Ee||Xe.length===0)){fe&&(fe.disabled=!0,fe.textContent="Import...");try{let e=[];for(let n of Xe){let i=await n.text();try{let y=JSON.parse(i);Array.isArray(y)?e.push(...y):e.push(y)}catch(y){P(`Erreur JSON dans ${n.name}`),console.error("[import] parse error",n.name,y)}}if(e.length===0){P("Aucune page valide \xE0 importer.");return}let t=await fetch(`${Ee}/import`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(e)}),s=await t.json();if(!t.ok)throw new Error(s.message||"Erreur serveur");if(Pt&&Nt){Pt.classList.remove("hidden");let n="";s.imported&&s.imported.length>0&&(n+=`<p class="text-green-700">\u2713 ${s.imported.length} page(s) import\xE9e(s)</p>`,n+='<ul class="ml-4 text-xs text-slate-600">',s.imported.forEach(i=>{n+=`<li>${i.title} (${i.action==="updated"?"mise \xE0 jour":"cr\xE9\xE9e"})</li>`}),n+="</ul>"),s.errors&&s.errors.length>0&&(n+=`<p class="text-rose-600 mt-2">\u2717 ${s.errors.length} erreur(s)</p>`,n+='<ul class="ml-4 text-xs text-rose-500">',s.errors.forEach(i=>{n+=`<li>${i.title}: ${i.error}</li>`}),n+="</ul>"),Nt.innerHTML=n}s.imported&&s.imported.length>0&&(ee=await et(),ct(ee,ge),ee.length>0&&!ge&&Fe(ee[0].id),P(`${s.imported.length} page(s) import\xE9e(s)`)),Xe=[],hs()}catch(e){console.error("[import] failed",e),P(e.message||"Erreur import")}finally{fe&&(fe.disabled=!1,fe.textContent="Importer")}}};ss==null||ss.addEventListener("click",On),hn.forEach(e=>e.addEventListener("click",Os)),De==null||De.addEventListener("click",e=>{e.target===De&&Os()}),ns==null||ns.addEventListener("change",e=>{Us(e.target.files)}),Ce==null||Ce.addEventListener("dragover",e=>{e.preventDefault(),Ce.classList.add("border-[#9C6BFF]","bg-[#9C6BFF]/10")}),Ce==null||Ce.addEventListener("dragleave",e=>{e.preventDefault(),Ce.classList.remove("border-[#9C6BFF]","bg-[#9C6BFF]/10")}),Ce==null||Ce.addEventListener("drop",e=>{e.preventDefault(),Ce.classList.remove("border-[#9C6BFF]","bg-[#9C6BFF]/10"),Us(e.dataTransfer.files)}),fe==null||fe.addEventListener("click",Un),Fs.forEach(e=>{e.addEventListener("click",()=>{let t=e.dataset.importTab;Fs.forEach(s=>{s.dataset.importTab===t?(s.classList.add("bg-[#9C6BFF]","text-white"),s.classList.remove("border","border-slate-200","text-slate-700")):(s.classList.remove("bg-[#9C6BFF]","text-white"),s.classList.add("border","border-slate-200","text-slate-700"))}),yn.forEach(s=>{s.dataset.importPanel===t?s.classList.remove("hidden"):s.classList.add("hidden")})})}),as==null||as.addEventListener("click",async()=>{if(!Is)return;let e=Is.textContent||"";try{await navigator.clipboard.writeText(e),P("Template copi\xE9 !")}catch(t){console.error("[import] copy failed",t),P("Erreur copie")}}),rs==null||rs.addEventListener("click",cs),_e==null||_e.addEventListener("click",An),Re==null||Re.addEventListener("click",e=>{e.target===Re&&cs()}),Z==null||Z.addEventListener("click",e=>{e.stopPropagation(),Bn()}),document.addEventListener("click",e=>{xt&&(U!=null&&U.contains(e.target)||Z!=null&&Z.contains(e.target)||Ot())}),_.forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();let s=e.dataset.blockAdd;Tn(s)})}),D==null||D.addEventListener("click",()=>{ds()}),V==null||V.addEventListener("click",()=>{Ht&&Ms(Ht),ds()}),K==null||K.addEventListener("click",e=>{e.target===K&&ds()}),m==null||m.addEventListener("input",e=>{var n,i,y,M;let t=e.target;if(!t||!t.name)return;if(t.name==="group-columns-mobile"||t.name==="group-columns-desktop"){let R=((n=m.querySelector('[name="group-columns-mobile"]'))==null?void 0:n.value)||"1",se=((i=m.querySelector('[name="group-columns-desktop"]'))==null?void 0:i.value)||"3";Qe(R,se)}if(t.name==="collection-columns-mobile"||t.name==="collection-columns-desktop"){let R=((y=m.querySelector('[name="collection-columns-mobile"]'))==null?void 0:y.value)||"1",se=((M=m.querySelector('[name="collection-columns-desktop"]'))==null?void 0:M.value)||"3";Je(R,se)}let s=t.closest("[data-block-panel]");if(s&&s.dataset.blockPanel==="appearance"){let R=dt(),se=O(R);if(R&&se){let he=We(se);Ge(R.id,he)}}}),m==null||m.addEventListener("change",e=>{let t=e.target;if(!t||!t.name)return;let s=t.closest("[data-block-panel]");if(s&&s.dataset.blockPanel==="appearance"){let n=dt(),i=O(n);if(n&&i){let y=We(i);Ge(n.id,y)}}}),J==null||J.addEventListener("change",e=>{let t=e.target;gs((t==null?void 0:t.value)||"")}),m==null||m.addEventListener("submit",jt),ae==null||ae.addEventListener("click",e=>{e.preventDefault();let t=dt();t&&Ke(t)}),I==null||I.addEventListener("load",()=>{fs=!0,je("\xC0 jour"),bt(de)}),C==null||C.addEventListener("click",()=>{let e=window.open("","_blank");if(!e)return;e.opener=null;let t=e.document;t.open(),t.write(ps||r()),t.close()});let Hs=e=>{var t,s,n;F&&(e?(F.classList.remove("hidden"),v&&(w&&(w.value=((t=v.seo)==null?void 0:t.title)||""),f&&(f.value=((s=v.seo)==null?void 0:s.description)||""),d&&(d.checked=((n=v.seo)==null?void 0:n.indexed)!==!1))):F.classList.add("hidden"))},Vt=(e,t="muted")=>{if(!E)return;let s=t==="success"?"text-emerald-600":t==="error"?"text-rose-600":"text-slate-500";E.textContent=e||"",E.className=`text-sm ${s}`};$==null||$.addEventListener("click",()=>{let e=F&&!F.classList.contains("hidden");Hs(!e)}),q==null||q.addEventListener("click",()=>Hs(!1)),p==null||p.addEventListener("submit",async e=>{var t;if(e.preventDefault(),!v){Vt("Aucune page active.","error");return}T&&(T.disabled=!0),Vt("");try{let s={title:((w==null?void 0:w.value)||"").trim(),description:((f==null?void 0:f.value)||"").trim(),indexed:(t=d==null?void 0:d.checked)!=null?t:!0},n={...v,seo:s},i=await c(n);i&&(v=i,Vt("SEO enregistr\xE9.","success"),P("SEO mis \xE0 jour"),rt(v))}catch(s){console.error("[seo] save failed",s),Vt(s.message||"Erreur lors de la sauvegarde.","error")}finally{T&&(T.disabled=!1)}});let Hn=e=>{let t=e.target.closest("[data-block-item]");if(!t||!Rt()){e.preventDefault();return}if(Ue=t.dataset.blockId||null,!Ue){e.preventDefault();return}e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",Ue),requestAnimationFrame(()=>{t.classList.add("opacity-50","scale-[0.98]","shadow-lg","ring-2","ring-[#9C6BFF]")})},zs=()=>{a==null||a.querySelectorAll("[data-block-item]").forEach(e=>{e.classList.remove("opacity-50","scale-[0.98]","shadow-lg","ring-2","ring-[#9C6BFF]","border-t-4","border-b-4","border-t-[#9C6BFF]","border-b-[#9C6BFF]","pt-6","pb-6")})},zn=()=>{Ue=null,zs()},Vn=e=>{if(!Ue||!Rt())return;let t=e.target.closest("[data-block-item]");if(!t||t.dataset.blockId===Ue)return;e.preventDefault(),e.dataTransfer.dropEffect="move";let s=t.getBoundingClientRect(),n=s.top+s.height/2,i=e.clientY<n;a==null||a.querySelectorAll("[data-block-item]").forEach(y=>{y!==t&&y.dataset.blockId!==Ue&&y.classList.remove("border-t-4","border-b-4","border-t-[#9C6BFF]","border-b-[#9C6BFF]","pt-6","pb-6")}),t.classList.remove("border-t-4","border-b-4","border-t-[#9C6BFF]","border-b-[#9C6BFF]","pt-6","pb-6"),i?t.classList.add("border-t-4","border-t-[#9C6BFF]","pt-6"):t.classList.add("border-b-4","border-b-[#9C6BFF]","pb-6"),t.dataset.dropPosition=i?"before":"after"},Jn=e=>{let t=e.target.closest("[data-block-item]");if(!t)return;let s=e.relatedTarget;s&&t.contains(s)||(t.classList.remove("border-t-4","border-b-4","border-t-[#9C6BFF]","border-b-[#9C6BFF]","pt-6","pb-6"),delete t.dataset.dropPosition)},Wn=e=>{if(!Ue||!Rt())return;e.preventDefault();let t=e.target.closest("[data-block-item]"),s=Ue,n=(t==null?void 0:t.dataset.dropPosition)||"after";Ue=null,zs();let i=(t==null?void 0:t.dataset.blockId)||null;!i||s===i||Fn(s,i,n)},Ue=null;a==null||a.addEventListener("dragstart",Hn),a==null||a.addEventListener("dragend",zn),a==null||a.addEventListener("dragover",Vn),a==null||a.addEventListener("dragleave",Jn),a==null||a.addEventListener("drop",Wn),L()}function dn(){var We,je,$t;let o=document.querySelector("[data-collection-list]");if(!o)return;let g=document.querySelector("[data-collection-empty]"),x=document.querySelector("[data-collection-items-empty]"),A=document.querySelector("[data-item-table-wrapper]"),I=document.querySelector("[data-item-table-body]"),C=document.querySelector("[data-collection-title]"),G=document.querySelector("[data-collection-description]"),W=document.querySelector("[data-collection-drawer]"),$=document.querySelector("[data-collection-drawer-backdrop]"),F=document.querySelectorAll("[data-collection-drawer-open]"),q=document.querySelectorAll("[data-collection-drawer-close]"),p=document.querySelector("[data-item-add]"),w=document.querySelector("[data-item-detail-empty]"),f=document.querySelector("[data-item-form]"),d=f?{title:f.querySelector('[name="item-title"]'),slug:f.querySelector('[name="item-slug"]'),excerpt:f.querySelector('[name="item-excerpt"]'),content:f.querySelector('[name="item-content"]'),image:f.querySelector('[name="item-image"]'),status:f.querySelector('[name="item-status"]')}:{},E=document.querySelector("[data-item-status-badge]"),T=document.querySelector("[data-item-delete]"),a=document.querySelector("[data-item-delete-modal]"),k=document.querySelector("[data-item-delete-cancel]"),B=document.querySelector("[data-item-delete-confirm]"),Z=document.querySelector("[data-item-cancel]"),U=document.querySelector("[data-item-save]"),_="rounded-full px-3 py-1 text-xs font-semibold",K=Se((z==null?void 0:z.slugValue)||Q.slug||""),V=K?`/api/sites/${encodeURIComponent(K)}/collections`:null,D=[],N=[],H=null,h=null,l=!1,u=!1,S=null,m=()=>{W&&(W.classList.add("is-open"),W.style.transform="translateX(0)",$==null||$.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},te=()=>{W&&(W.classList.remove("is-open"),W.style.transform="",$==null||$.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))};F.forEach(r=>{r.addEventListener("click",m)}),q.forEach(r=>{r.addEventListener("click",te)}),$==null||$.addEventListener("click",te);let oe=r=>{let b=(r||"").trim();if(!b)return"";if(b==="/")return"/";let X=b.replace(/^\//,"").split("/").map(ce=>gt(ce||"")).filter(ce=>ce.length>0);return X.length?`/${X.join("/")}`:""},re=r=>{if(!r)return"\u2014";let b=new Date(r);return Number.isNaN(b.getTime())?"\u2014":b.toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"})},ne=()=>{let r=D.find(b=>b.id===H);C&&(C.textContent=(r==null?void 0:r.name)||"S\xE9lectionnez une collection"),G&&(G.textContent=(r==null?void 0:r.description)||"")},me=r=>{x&&(x.textContent=r||(H?"Aucun item dans cette collection pour le moment.":"Choisissez une collection dans le panneau de gauche."))},ie=()=>{f&&(f.classList.add("hidden"),f.dataset.itemId=""),w==null||w.classList.remove("hidden"),E&&(E.className=`hidden ${_}`,E.textContent=""),T&&(T.disabled=!0)},J=()=>{f&&(f.classList.remove("hidden"),w==null||w.classList.add("hidden"))},xe=()=>{p&&(p.disabled=!H,p.disabled?p.classList.add("opacity-60","pointer-events-none"):p.classList.remove("opacity-60","pointer-events-none"))},ae=r=>{if(!E)return;if(!r){E.className=`hidden ${_}`,E.textContent="";return}let b=r.toLowerCase(),j="bg-slate-100 text-slate-600 border border-slate-200";b==="publi\xE9"||b==="publie"?j="bg-emerald-50 text-emerald-700 border border-emerald-100":b==="brouillon"&&(j="bg-amber-50 text-amber-700 border border-amber-100"),E.className=`${_} ${j}`,E.textContent=r},$e=()=>{if(o.innerHTML="",!D.length){g==null||g.classList.remove("hidden");return}g==null||g.classList.add("hidden"),D.forEach(r=>{let b=r.id===H,j=document.createElement("button");j.type="button",j.dataset.collectionId=r.id,j.className=["w-full rounded-xl border px-3 py-2 text-left transition focus:outline-none focus:ring-2 focus:ring-[#9C6BFF]/40",b?"bg-[#F7F0FF] border-[#9C6BFF]/40 text-slate-900":"border-slate-200 text-slate-700 hover:border-[#9C6BFF]/40"].join(" "),j.setAttribute("role","option"),b?j.setAttribute("aria-current","true"):j.removeAttribute("aria-current"),j.innerHTML=`
          <div class="flex items-center justify-between gap-2">
            <div>
              <p class="text-sm font-semibold">${r.name||r.id}</p>
              <p class="text-xs text-slate-500">${r.description||""}</p>
            </div>
            <span class="text-[11px] uppercase tracking-wide text-slate-400">${r.type||""}</span>
          </div>
        `,j.addEventListener("click",()=>{et(r.id),window.matchMedia("(min-width: 1024px)").matches||te()}),o.appendChild(j)})},le=()=>{if(I){if(I.innerHTML="",!N.length||!H){x==null||x.classList.remove("hidden"),me(),A==null||A.classList.add("hidden");return}x==null||x.classList.add("hidden"),A==null||A.classList.remove("hidden"),N.forEach(r=>{let b=document.createElement("tr");b.dataset.itemId=r.id;let j=r.id===h&&!l;b.className=["cursor-pointer transition focus-within:bg-[#F7F0FF]/70 focus:outline-none",j?"bg-[#F7F0FF]/70":"hover:bg-slate-50"].join(" "),b.tabIndex=0,b.setAttribute("role","button"),j?b.setAttribute("aria-current","true"):b.removeAttribute("aria-current");let X=r.status||"Brouillon",ce=X.toLowerCase(),yt=ce==="publi\xE9"||ce==="publie"?"bg-emerald-50 text-emerald-700 border border-emerald-100":"bg-amber-50 text-amber-700 border border-amber-100";b.innerHTML=`
          <td class="px-4 py-3 align-top">
            <div class="flex flex-col">
              <span class="text-sm font-semibold text-slate-900">${r.title||"Sans titre"}</span>
              <span class="text-xs text-slate-500">${r.summary||r.excerpt||""}</span>
            </div>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-600">${r.slug||""}</td>
          <td class="px-4 py-3 align-top">
            <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${yt}">
              ${X}
            </span>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-500">${re(r.updatedAt||r.createdAt)}</td>
        `;let tt=()=>{qe(r.id)};b.addEventListener("click",tt),b.addEventListener("keydown",Ge=>{(Ge.key==="Enter"||Ge.key===" ")&&(Ge.preventDefault(),tt())}),I.appendChild(b)})}},qe=r=>{let b=N.find(j=>j.id===r);b&&(h=b.id,l=!1,u=!0,Le(b),le())},Le=r=>{if(!f||!r){ie();return}J(),f.dataset.itemId=r.id,d.title&&(d.title.value=r.title||""),d.slug&&(d.slug.value=r.slug||""),d.excerpt&&(d.excerpt.value=r.summary||r.excerpt||""),d.content&&(d.content.value=r.content||""),d.image&&(d.image.value=r.image||""),d.status&&(d.status.value=r.status||"Brouillon"),ae(r.status||"Brouillon"),T&&(T.disabled=!1)},Ve=()=>{var r;f&&(l=!0,h=null,u=!1,f.dataset.itemId="",f.reset(),d.status&&(d.status.value="Brouillon"),d.slug&&(d.slug.value=""),ae("Brouillon"),J(),T&&(T.disabled=!0),(r=d.title)==null||r.focus())},Ze=()=>{var tt,Ge,rt,jt,Pe,pe;let r=(((tt=d.title)==null?void 0:tt.value)||"").trim(),b=(((Ge=d.slug)==null?void 0:Ge.value)||"").trim(),j=(((rt=d.excerpt)==null?void 0:rt.value)||"").trim(),X=(((jt=d.content)==null?void 0:jt.value)||"").trim(),ce=(((Pe=d.image)==null?void 0:Pe.value)||"").trim(),yt=((pe=d.status)==null?void 0:pe.value)||"Brouillon";return{title:r,slug:oe(b||r),summary:j,excerpt:j,content:X,image:ce,status:yt}},Qe=r=>{U&&(U.disabled=r,U.textContent=r?"Enregistrement\u2026":"Enregistrer"),T&&!l&&h&&(T.disabled=r)},Je=async r=>{if(!V)return[];let b=await fetch(`${V}/${encodeURIComponent(r)}/items`,{headers:{Accept:"application/json"}});if(!b.ok){let X=await b.json().catch(()=>({}));throw new Error(X.message||"Impossible de charger les items.")}let j=await b.json().catch(()=>({}));return Array.isArray(j.items)?j.items:[]},et=async r=>{if(r&&(H=r,h=null,l=!1,u=!1,ne(),xe(),$e(),ie(),N=[],le(),me("Chargement des items\u2026"),x==null||x.classList.remove("hidden"),A==null||A.classList.add("hidden"),!!V))try{N=await Je(r),le(),N.length||me()}catch(b){console.error("[content] items failed",b),P(b.message||"Impossible de charger les items."),N=[],le()}},at=async(r,b)=>{if(!V)throw new Error("Site inconnu.");let j=await fetch(`${V}/${encodeURIComponent(r)}/items`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)});if(!j.ok){let X=await j.json().catch(()=>({}));throw new Error(X.message||"Impossible de cr\xE9er cet item.")}return j.json()},c=async(r,b,j)=>{if(!V)throw new Error("Site inconnu.");let X=await fetch(`${V}/${encodeURIComponent(r)}/items/${encodeURIComponent(b)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(j)});if(!X.ok){let ce=await X.json().catch(()=>({}));throw new Error(ce.message||"Impossible de sauvegarder cet item.")}return X.json()},L=async(r,b)=>{if(!V)throw new Error("Site inconnu.");let j=await fetch(`${V}/${encodeURIComponent(r)}/items/${encodeURIComponent(b)}`,{method:"DELETE"});if(!j.ok){let X=await j.json().catch(()=>({}));throw new Error(X.message||"Impossible de supprimer cet item.")}},Y=async()=>{var r;if(!V){g==null||g.classList.remove("hidden"),H=null,N=[],le(),ne(),xe();return}try{let b=await fetch(V,{headers:{Accept:"application/json"}});if(!b.ok)throw new Error("Impossible de charger les collections.");let j=await b.json().catch(()=>[]);if(D=Array.isArray(j)?j:[],$e(),D.length>0){let X=((r=D.find(ce=>ce.id===H))==null?void 0:r.id)||D[0].id;et(X)}else H=null,N=[],ne(),xe(),le()}catch(b){console.error("[content] load collections",b),P(b.message||"Impossible de charger les collections.")}};p==null||p.addEventListener("click",()=>{if(!H){P("S\xE9lectionnez d\u2019abord une collection.");return}Ve(),le()}),Z==null||Z.addEventListener("click",r=>{if(r.preventDefault(),l){l=!1,h=null,ie(),le();return}if(h){let b=N.find(j=>j.id===h);Le(b)}else ie()}),(We=d.status)==null||We.addEventListener("change",()=>{ae(d.status.value)}),(je=d.title)==null||je.addEventListener("input",()=>{!l||!d.slug||u||(d.slug.value=oe(d.title.value))}),($t=d.slug)==null||$t.addEventListener("input",()=>{l&&(u=!0)}),f==null||f.addEventListener("submit",async r=>{var j;if(r.preventDefault(),!H){P("S\xE9lectionnez une collection.");return}let b=Ze();if(!b.title){P("Le titre est requis."),(j=d.title)==null||j.focus();return}Qe(!0);try{let X;l||!h?(X=await at(H,b),N=[...N,X],P("Item cr\xE9\xE9")):(X=await c(H,h,b),N=N.map(ce=>ce.id===X.id?X:ce),P("Item mis \xE0 jour")),l=!1,h=X.id,Le(X),le()}catch(X){console.error("[content] save item failed",X),P(X.message||"Impossible de sauvegarder cet item.")}finally{Qe(!1)}});let O=()=>{a&&(a.classList.add("hidden"),a.classList.remove("flex"),S=null)},Ke=()=>{!a||!h||(S=h,a.classList.remove("hidden"),a.classList.add("flex"))};T==null||T.addEventListener("click",r=>{r.preventDefault(),h&&Ke()}),k==null||k.addEventListener("click",()=>{O()}),a==null||a.addEventListener("click",r=>{r.target===a&&O()}),B==null||B.addEventListener("click",async()=>{if(!S||!H){O();return}B.disabled=!0,B.textContent="Suppression\u2026";try{await L(H,S),N=N.filter(r=>r.id!==S),h===S&&(h=null,ie()),P("Item supprim\xE9"),le()}catch(r){console.error("[content] delete item failed",r),P(r.message||"Impossible de supprimer cet item.")}finally{B.disabled=!1,B.textContent="Supprimer",O()}}),ne(),xe(),Y()}function un(){let o=document.querySelector("[data-deploy-form]");if(!o)return;let g=document.querySelector("[data-deploy-protocol]"),x=document.querySelector("[data-deploy-host]"),A=document.querySelector("[data-deploy-port]"),I=document.querySelector("[data-deploy-user]"),C=document.querySelector("[data-deploy-password]"),G=document.querySelector("[data-deploy-show-password]"),W=document.querySelector("[data-deploy-remote-path]"),$=document.querySelector("[data-deploy-feedback]"),F=document.querySelector("[data-deploy-save]"),q=document.querySelector("[data-deploy-test]"),p=document.querySelector("[data-deploy-trigger]"),w=document.querySelector("[data-deploy-history]"),f=document.querySelector("[data-deploy-log]"),d=Se((z==null?void 0:z.slugValue)||Q.slug||""),E=d?`/api/sites/${encodeURIComponent(d)}/deploy-config`:null,T=d?`/api/sites/${encodeURIComponent(d)}/deploy`:null,a=d?`/api/sites/${encodeURIComponent(d)}/deploy-log`:null,k=!1,B=null,Z=l=>{let u=(l||"").trim();return u?u.startsWith("/")?u:`/${u}`:"/www"},U=(l,u="muted")=>{if(!$)return;let S="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold",m=u==="success"?"bg-emerald-50 text-emerald-700 border border-emerald-100":u==="error"?"bg-rose-50 text-rose-700 border border-rose-100":"bg-slate-50 text-slate-600 border border-slate-100";if(!l){$.textContent="",$.className="text-sm text-slate-500";return}let te=u==="success"?"\u2705":u==="error"?"\u274C":"\u2139\uFE0F";$.innerHTML=`<span class="${S} ${m}">${te}<span>${l}</span></span>`,$.className="text-sm"},_=(l=null)=>{B=l;let u=!!l,S='<svg class="h-4 w-4 animate-spin text-white" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>';F&&(F.disabled=u,F.innerHTML=l==="save"?`<span class="inline-flex items-center gap-2">${S}<span>Enregistrement\u2026</span></span>`:"Enregistrer"),q&&(q.disabled=u,q.innerHTML=l==="test"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-slate-200 border-t-slate-600"></span><span>Test en cours\u2026</span></span>':"Tester la connexion"),p&&(p.disabled=u&&l!==null,p.innerHTML=l==="deploy"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-white/60 border-t-white"></span><span>D\xE9ploiement\u2026</span></span>':"D\xE9ployer maintenant")},K=l=>{g&&(g.value=l.protocol||"sftp"),x&&(x.value=l.host||""),A&&(A.value=l.port||""),I&&(I.value=l.user||""),W&&(W.value=l.remotePath||"/www"),k=!!l.hasPassword,C&&(C.value="",C.placeholder=k?"Non affich\xE9":"Mot de passe")},V=(l=[])=>{if(w){if(w.innerHTML="",!l.length){let u=document.createElement("li");u.className="text-slate-500",u.textContent="Aucun d\xE9ploiement pour le moment.",w.appendChild(u);return}l.forEach(u=>{let S=document.createElement("li");S.className="flex items-center justify-between gap-2 rounded-xl border border-slate-200 px-3 py-2";let m=u.status==="success"?'<span class="rounded-full bg-emerald-50 px-2 py-0.5 text-[11px] font-semibold text-emerald-700">Succ\xE8s</span>':'<span class="rounded-full bg-rose-50 px-2 py-0.5 text-[11px] font-semibold text-rose-700">\xC9chec</span>',te=u.finishedAt||u.startedAt||"",oe=u.durationMs&&Number(u.durationMs)>=0?`${Math.round(Number(u.durationMs)/1e3)}s`:"";S.innerHTML=`
          <div class="space-y-1">
            <div class="flex items-center gap-2">${m}<span class="text-xs text-slate-500">${te}</span></div>
            <p class="text-sm text-slate-800">${u.message||""}</p>
          </div>
          <div class="text-xs text-slate-500">${oe}</div>
        `,S.dataset.deployId=u.id||"",S.addEventListener("click",()=>{u.logs&&f&&(f.textContent=u.logs.join(`
`))}),w.appendChild(S)})}},D=(l=[])=>{f&&(f.textContent=l.length?l.join(`
`):"Aucun log pour le moment.")},N=async()=>{var l;if(a)try{let u=await fetch(a,{headers:{Accept:"application/json"}});if(!u.ok){if(u.status===404){V([]),D(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw new Error("Impossible de charger l\u2019historique.")}let S=await u.json().catch(()=>({})),m=Array.isArray(S.entries)?S.entries:[];V(m),(l=m[0])!=null&&l.logs&&D(m[0].logs)}catch(u){console.error("[deploy] history failed",u)}},H=async()=>{if(!E){U("Aucun site actif s\xE9lectionn\xE9.","error");return}_("load");try{let l=await fetch(E,{headers:{Accept:"application/json"}}),u=await l.json().catch(()=>({}));l.ok?(K(u||{}),U("Configuration charg\xE9e.","muted")):(K(u||{}),U(u.message||"Configuration par d\xE9faut charg\xE9e.","muted"))}catch(l){console.error("[deploy] load failed",l),U(l.message||"Erreur lors du chargement.","error")}finally{_(null)}},h=()=>{let l={protocol:(g==null?void 0:g.value)||"sftp",host:(x==null?void 0:x.value.trim())||"",port:Number(A==null?void 0:A.value)||void 0,user:(I==null?void 0:I.value.trim())||"",remotePath:Z((W==null?void 0:W.value)||"/www")},u=(C==null?void 0:C.value)||"";return u.trim().length>0&&(l.password=u),l};o.addEventListener("submit",async l=>{if(l.preventDefault(),!E){U("Aucun site actif s\xE9lectionn\xE9.","error");return}let u=h();_("save");try{let S=await fetch(E,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)});if(!S.ok){let te=await S.json().catch(()=>({}));throw new Error(te.message||"Sauvegarde impossible.")}let m=await S.json();K(m||{}),U("Configuration enregistr\xE9e.","success"),P("Configuration d\xE9ploiement sauvegard\xE9e")}catch(S){console.error("[deploy] save failed",S),U(S.message||"Erreur lors de la sauvegarde.","error")}finally{_(null)}}),q==null||q.addEventListener("click",async()=>{if(!E){U("Aucun site actif s\xE9lectionn\xE9.","error");return}let l=h();if(!l.host||!l.user||!l.remotePath){U("Remplissez les champs requis avant de tester.","error");return}_("test");try{let u=await fetch(`${E}/test`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}),S=await u.json().catch(()=>({}));if(!u.ok||S.success===!1){U(S.message||"Test de connexion \xE9chou\xE9.","error");return}U(S.message||"Connexion OK.","success"),P("Test de connexion r\xE9ussi")}catch(u){console.error("[deploy] test failed",u),U(u.message||"Test de connexion \xE9chou\xE9.","error")}finally{_(null)}}),p==null||p.addEventListener("click",async()=>{if(!T){U("Aucun site actif s\xE9lectionn\xE9.","error");return}_("deploy"),D(["D\xE9ploiement en cours\u2026"]);try{let l=await fetch(T,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(h())}),u=await l.json().catch(()=>({}));if(!l.ok){if(l.status===404){U("API d\xE9ploiement indisponible (red\xE9marre le serveur).","error"),D(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw D(u.logs||[]),new Error(u.message||"D\xE9ploiement \xE9chou\xE9.")}D(u.logs||[]),await N(),P("D\xE9ploiement termin\xE9")}catch(l){console.error("[deploy] run failed",l),U(l.message||"D\xE9ploiement \xE9chou\xE9.","error")}finally{_(null)}}),G==null||G.addEventListener("change",()=>{C&&(C.type=G.checked?"text":"password")}),H(),N()}function mn(){let o=document.querySelectorAll("[data-settings-tab]"),g=document.querySelectorAll("[data-settings-panel]"),x=document.querySelector("[data-admin-password-form]"),A=document.querySelector("[data-site-config-form]"),I=document.querySelector("[data-site-config-feedback]"),C=document.querySelector("[data-theme-form]"),G=F=>{o.forEach(q=>{let p=q.dataset.settingsTab===F;q.setAttribute("aria-selected",p?"true":"false"),q.classList.toggle("bg-[#9C6BFF]",p),q.classList.toggle("text-white",p)}),g.forEach(q=>{q.classList.toggle("hidden",q.dataset.settingsPanel!==F)})};if(o.forEach(F=>{F.addEventListener("click",()=>G(F.dataset.settingsTab||"account"))}),G("account"),x){let F=x.querySelector("[data-admin-password-feedback]"),q=x.querySelector("[data-admin-password-submit]"),p=(w,f="muted")=>{if(!F)return;let d=f==="success"?"text-emerald-600":f==="error"?"text-rose-600":"text-slate-500";F.textContent=w||"",F.className=`text-sm ${d}`};x.addEventListener("submit",async w=>{w.preventDefault();let f=new FormData(x),d=f.get("currentPassword")||"",E=f.get("newPassword")||"",T=f.get("confirmPassword")||"";if(!d||!E||!T){p("Compl\xE8te tous les champs.","error");return}q&&(q.disabled=!0),p("");try{let a=await fetch("/api/admin/password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({currentPassword:d,newPassword:E,confirmPassword:T})}),k=await a.json().catch(()=>({}));if(!a.ok||k.success===!1)throw new Error(k.message||"Impossible de mettre \xE0 jour le mot de passe.");p(k.message||"Mot de passe mis \xE0 jour.","success"),x.reset()}catch(a){console.error("[settings] change password failed",a),p(a.message||"Erreur lors de la mise \xE0 jour.","error")}finally{q&&(q.disabled=!1)}})}if(A){let F=A.querySelector("[data-site-name]"),q=A.querySelector("[data-site-language]"),p=A.querySelector("[data-site-tagline]"),w=A.querySelector("[data-site-save]"),f=(a,k="muted")=>{if(!I)return;let B=k==="success"?"text-emerald-600":k==="error"?"text-rose-600":"text-slate-500";I.textContent=a||"",I.className=`text-sm ${B}`},d=Se((z==null?void 0:z.slugValue)||Q.slug||""),E=d?`/api/sites/${encodeURIComponent(d)}/config/site`:null,T=async()=>{if(E)try{let a=await fetch(E,{headers:{Accept:"application/json"}});if(!a.ok)return;let k=await a.json().catch(()=>({}));F&&(F.value=k.name||""),q&&(q.value=k.language||"fr"),p&&(p.value=k.tagline||"")}catch(a){console.error("[settings] load site config failed",a)}};A.addEventListener("submit",async a=>{if(a.preventDefault(),!E){f("Aucun site actif.","error");return}if(!(F!=null&&F.value.trim())){f("Nom requis.","error");return}w&&(w.disabled=!0),f("");try{let k={name:(F==null?void 0:F.value)||"",language:(q==null?void 0:q.value)||"fr",tagline:(p==null?void 0:p.value)||""},B=await fetch(E,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(k)}),Z=await B.json().catch(()=>({}));if(!B.ok||Z.success===!1)throw new Error(Z.message||"Sauvegarde impossible.");f(Z.message||"Param\xE8tres enregistr\xE9s.","success")}catch(k){console.error("[settings] save site config failed",k),f(k.message||"Erreur lors de la sauvegarde.","error")}finally{w&&(w.disabled=!1)}}),T()}if(C){let F=Se((z==null?void 0:z.slugValue)||Q.slug||""),q=F?`/api/sites/${encodeURIComponent(F)}/config/theme`:null,p={primary:C.querySelector("[data-theme-primary]"),secondary:C.querySelector("[data-theme-secondary]"),accent:C.querySelector("[data-theme-accent]"),background:C.querySelector("[data-theme-background]"),text:C.querySelector("[data-theme-text]")},w=C.querySelector("[data-theme-headings]"),f=C.querySelector("[data-theme-body]"),d=C.querySelector("[data-theme-radius-small]"),E=C.querySelector("[data-theme-radius-medium]"),T=C.querySelector("[data-theme-radius-large]"),a=C.querySelector("[data-theme-preview]"),k=C.querySelector("[data-theme-feedback]"),B=C.querySelector("[data-theme-apply]"),Z=["slate","gray","zinc","neutral","stone","red","orange","amber","yellow","lime","green","emerald","teal","cyan","sky","blue","indigo","violet","purple","fuchsia","pink","rose"],U=["50","100","200","300","400","500","600","700","800","900"],_=Z.flatMap(h=>U.map(l=>`${h}-${l}`)),K=()=>{Object.values(p).forEach(h=>{!h||h.options.length||_.forEach(l=>{let u=document.createElement("option");u.value=l;let[S,m]=l.split("-");u.textContent=`${S.charAt(0).toUpperCase()+S.slice(1)} ${m}`,h.appendChild(u)})})},V=(h,l="muted")=>{if(!k)return;let u=l==="success"?"text-emerald-600":l==="error"?"text-rose-600":"text-slate-500";k.textContent=h||"",k.className=`text-sm ${u}`},D=()=>{var l,u,S,m,te;if(!a)return;let h=oe=>{if(!oe)return null;let[re,ne]=oe.split("-"),ie={slate:"#e2e8f0",gray:"#d1d5db",zinc:"#d4d4d8",neutral:"#d4d4d4",stone:"#d6d3d1",red:"#ef4444",orange:"#f97316",amber:"#f59e0b",yellow:"#eab308",lime:"#84cc16",green:"#22c55e",emerald:"#10b981",teal:"#14b8a6",cyan:"#06b6d4",sky:"#0ea5e9",blue:"#3b82f6",indigo:"#6366f1",violet:"#8b5cf6",purple:"#a855f7",fuchsia:"#d946ef",pink:"#ec4899",rose:"#f43f5e"}[re];if(!ie)return null;let J=Number(ne)||500,xe=Math.min(Math.max((J-50)/900,0),1),ae=Ve=>Ve.match(/[A-Fa-f0-9]{2}/g).map(Ze=>parseInt(Ze,16)),[$e,le,qe]=ae(ie.replace("#","")),Le=Ve=>Math.round(255-(255-Ve)*xe);return`rgb(${Le($e)}, ${Le(le)}, ${Le(qe)})`};a.style.setProperty("--color-primary",h((l=p.primary)==null?void 0:l.value)||"#9C6BFF"),a.style.setProperty("--color-secondary",h((u=p.secondary)==null?void 0:u.value)||"#0EA5E9"),a.style.setProperty("--color-accent",h((S=p.accent)==null?void 0:S.value)||"#F97316"),a.style.setProperty("--color-background",h((m=p.background)==null?void 0:m.value)||"#FFFFFF"),a.style.setProperty("--color-text",h((te=p.text)==null?void 0:te.value)||"#0F172A"),a.style.setProperty("--font-headings",(w==null?void 0:w.value)||"Inter, sans-serif"),a.style.setProperty("--font-body",(f==null?void 0:f.value)||"Inter, sans-serif"),a.style.setProperty("--radius-small",(d==null?void 0:d.value)||"8px"),a.style.setProperty("--radius-medium",(E==null?void 0:E.value)||"16px"),a.style.setProperty("--radius-large",(T==null?void 0:T.value)||"24px"),a.style.borderRadius=(E==null?void 0:E.value)||"16px"},N=(h,l)=>{p[h]&&(p[h].value=l)};Object.keys(p).forEach(h=>{var l;(l=p[h])==null||l.addEventListener("change",D)}),[w,f,d,E,T].forEach(h=>{h==null||h.addEventListener("change",D)});let H=async()=>{var h,l,u,S,m,te,oe,re,ne,me;if(q)try{let ie=await fetch(q,{headers:{Accept:"application/json"}});if(!ie.ok)return;let J=await ie.json().catch(()=>({}));N("primary",((h=J.colors)==null?void 0:h.primary)||"violet-500"),N("secondary",((l=J.colors)==null?void 0:l.secondary)||"indigo-400"),N("accent",((u=J.colors)==null?void 0:u.accent)||"emerald-500"),N("background",((S=J.colors)==null?void 0:S.background)||"slate-50"),N("text",((m=J.colors)==null?void 0:m.text)||"slate-900"),w&&(w.value=((te=J.typography)==null?void 0:te.headings)||"Inter, sans-serif"),f&&(f.value=((oe=J.typography)==null?void 0:oe.body)||"Inter, sans-serif"),d&&(d.value=((re=J.radius)==null?void 0:re.small)||"8px"),E&&(E.value=((ne=J.radius)==null?void 0:ne.medium)||"16px"),T&&(T.value=((me=J.radius)==null?void 0:me.large)||"24px"),D()}catch(ie){console.error("[settings] load theme failed",ie)}};K(),B==null||B.addEventListener("click",async h=>{var u,S,m,te,oe;if(h.preventDefault(),!q){V("Aucun site actif.","error");return}let l={colors:{primary:((u=p.primary)==null?void 0:u.value)||"violet-500",secondary:((S=p.secondary)==null?void 0:S.value)||"indigo-400",accent:((m=p.accent)==null?void 0:m.value)||"emerald-500",background:((te=p.background)==null?void 0:te.value)||"slate-50",text:((oe=p.text)==null?void 0:oe.value)||"slate-900"},typography:{headings:(w==null?void 0:w.value)||"Inter, sans-serif",body:(f==null?void 0:f.value)||"Inter, sans-serif"},radius:{small:(d==null?void 0:d.value)||"8px",medium:(E==null?void 0:E.value)||"16px",large:(T==null?void 0:T.value)||"24px"}};B.disabled=!0,V("");try{let re=await fetch(q,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}),ne=await re.json().catch(()=>({}));if(!re.ok||ne.success===!1)throw new Error(ne.message||"Application du th\xE8me \xE9chou\xE9e.");V(ne.message||"Th\xE8me appliqu\xE9.","success"),D()}catch(re){console.error("[settings] apply theme failed",re),V(re.message||"Erreur lors de l\u2019application du th\xE8me.","error")}finally{B.disabled=!1}}),K(),H(),D()}let W=document.querySelector("[data-seo-config-form]");if(W){let F=W.querySelector("[data-seo-index-all]"),q=W.querySelector("[data-seo-config-feedback]"),p=W.querySelector("[data-seo-save]"),w=Se((z==null?void 0:z.slugValue)||Q.slug||""),f=w?`/api/sites/${encodeURIComponent(w)}/config/site`:null,d=(T,a="muted")=>{if(!q)return;let k=a==="success"?"text-emerald-600":a==="error"?"text-rose-600":"text-slate-500";q.textContent=T||"",q.className=`text-sm ${k}`},E=async()=>{var T;if(f)try{let a=await fetch(f,{headers:{Accept:"application/json"}});if(!a.ok)return;let B=((T=(await a.json().catch(()=>({}))).seo)==null?void 0:T.indexAllPagesByDefault)!==!1;F&&(F.checked=B)}catch(a){console.error("[settings] load seo config failed",a)}};W.addEventListener("submit",async T=>{var a;if(T.preventDefault(),!f){d("Aucun site actif.","error");return}p&&(p.disabled=!0),d("");try{let k=await fetch(f,{headers:{Accept:"application/json"}}),B=k.ok?await k.json().catch(()=>({})):{},Z={...B,seo:{...B.seo||{},indexAllPagesByDefault:(a=F==null?void 0:F.checked)!=null?a:!0}},U=await fetch(f,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(Z)}),_=await U.json().catch(()=>({}));if(!U.ok||_.success===!1)throw new Error(_.message||"Sauvegarde impossible.");d(_.message||"Param\xE8tres SEO enregistr\xE9s.","success")}catch(k){console.error("[settings] save seo config failed",k),d(k.message||"Erreur lors de la sauvegarde.","error")}finally{p&&(p.disabled=!1)}}),E()}let $=document.querySelector("[data-analytics-form]");if($){let F=$.querySelector("[data-analytics-head]"),q=$.querySelector("[data-analytics-body]"),p=$.querySelector("[data-analytics-feedback]"),w=$.querySelector("[data-analytics-save]"),f=Se((z==null?void 0:z.slugValue)||Q.slug||""),d=f?`/api/sites/${encodeURIComponent(f)}/config/site`:null,E=(a,k="muted")=>{if(!p)return;let B=k==="success"?"text-emerald-600":k==="error"?"text-rose-600":"text-slate-500";p.textContent=a||"",p.className=`text-sm ${B}`},T=async()=>{var a,k;if(d)try{let B=await fetch(d,{headers:{Accept:"application/json"}});if(!B.ok)return;let Z=await B.json().catch(()=>({}));F&&(F.value=((a=Z.analytics)==null?void 0:a.headCode)||""),q&&(q.value=((k=Z.analytics)==null?void 0:k.bodyEndCode)||"")}catch(B){console.error("[settings] load analytics config failed",B)}};$.addEventListener("submit",async a=>{if(a.preventDefault(),!d){E("Aucun site actif.","error");return}w&&(w.disabled=!0),E("");try{let k=await fetch(d,{headers:{Accept:"application/json"}}),Z={...k.ok?await k.json().catch(()=>({})):{},analytics:{headCode:(F==null?void 0:F.value)||"",bodyEndCode:(q==null?void 0:q.value)||""}},U=await fetch(d,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(Z)}),_=await U.json().catch(()=>({}));if(!U.ok||_.success===!1)throw new Error(_.message||"Sauvegarde impossible.");E(_.message||"Scripts enregistr\xE9s.","success")}catch(k){console.error("[settings] save analytics config failed",k),E(k.message||"Erreur lors de la sauvegarde.","error")}finally{w&&(w.disabled=!1)}}),T()}}function pn(){let o=document.querySelector("[data-media-grid]");if(!o)return;let g=document.querySelector("[data-media-empty]"),x=document.querySelector("[data-media-count]"),A=document.querySelector("[data-media-filter-type]"),I=document.querySelector("[data-media-detail-empty]"),C=document.querySelector("[data-media-detail]"),G=document.querySelector("[data-media-detail-preview]"),W=document.querySelector("[data-media-detail-name]"),$=document.querySelector("[data-media-detail-type]"),F=document.querySelector("[data-media-detail-size]"),q=document.querySelector("[data-media-detail-path]"),p=document.querySelector("[data-media-detail-used]"),w=document.querySelector("[data-media-alt-edit]"),f=document.querySelector("[data-media-save]"),d=document.querySelector("[data-media-delete]"),E=document.querySelector("[data-media-delete-modal]"),T=document.querySelector("[data-media-delete-cancel]"),a=document.querySelector("[data-media-delete-confirm]"),k=document.querySelector("[data-media-upload-open]"),B=document.querySelector("[data-media-file-input]"),Z=document.querySelector("[data-media-upload-status]"),U=Se((z==null?void 0:z.slugValue)||Q.slug||""),_=U?`/api/sites/${encodeURIComponent(U)}/media`:null,K=[],V=[],D=null,N=null,H=null,h=!1,l=!1,u=!1,S=null,m=c=>{let L=(c.type||"").toLowerCase(),Y=(c.filename||"").toLowerCase();return L.includes("image")||/\.(png|jpe?g|webp|svg|gif)$/i.test(Y)?"image":L.includes("pdf")||L.includes("doc")||/\.(pdf|docx?)$/i.test(Y)?"document":L.includes("video")||/\.(mp4|mov|webm)$/i.test(Y)?"video":"other"},te=c=>m(c)==="image",oe=c=>{if(c.type)return c.type.toUpperCase();let L=(c.filename||"").split(".").pop();return L?L.toUpperCase():"FILE"},re=c=>!c||c<=0?"\u2014":c<1024?`${c} o`:c<1024*1024?`${(c/1024).toFixed(1)} ko`:`${(c/(1024*1024)).toFixed(1)} Mo`,ne=()=>{C==null||C.classList.add("hidden"),I==null||I.classList.remove("hidden"),me(),D=null,l=!1,ae(!1),G&&(G.innerHTML='<span class="text-slate-400 text-sm">Aucun m\xE9dia s\xE9lectionn\xE9</span>'),W&&(W.textContent=""),$&&($.textContent=""),F&&(F.textContent=""),w&&(w.value=""),q&&(q.textContent=""),p&&(p.innerHTML="")},me=()=>{H=null,u=!1,h=!1,S&&(URL.revokeObjectURL(S),S=null),Z&&(Z.textContent="Aucun fichier s\xE9lectionn\xE9."),B&&(B.value="")},ie=()=>{x&&(V.length?V.length===1?x.textContent="1 m\xE9dia":x.textContent=`${V.length} m\xE9dias`:x.textContent="0 m\xE9dia")},J=()=>{if(o.innerHTML="",!V.length){g==null||g.classList.remove("hidden"),ne();return}g==null||g.classList.add("hidden"),V.forEach(c=>{let L=document.createElement("button");L.type="button",L.dataset.mediaId=c.id;let Y=c.id===D;L.className=["group relative flex flex-col rounded-2xl border px-3 py-3 text-left transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#9C6BFF]",Y?"border-[#9C6BFF] bg-[#F7F0FF]/60 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let O=te(c)?`<img src="${c.path}" alt="${c.alt||c.filename}" class="h-full w-full object-cover" />`:'<div class="flex h-full w-full items-center justify-center text-3xl text-slate-400">\u{1F4C4}</div>';L.innerHTML=`
          <div class="relative aspect-[4/3] overflow-hidden rounded-xl bg-slate-100">
            ${O}
          </div>
          <div class="mt-2 space-y-1">
            <p class="text-sm font-semibold text-slate-900 truncate">${c.filename}</p>
            <p class="text-xs text-slate-500">
              ${oe(c)} \xB7 ${re(c.size)}
            </p>
          </div>
        `,c.id===N&&(L.classList.add("ring-2","ring-[#9C6BFF]"),window.setTimeout(()=>{L.classList.remove("ring-2","ring-[#9C6BFF]")},1600)),L.addEventListener("click",()=>$e(c.id)),o.appendChild(L)}),N=null},xe=c=>{if(p){if(p.innerHTML="",!c.usedIn||c.usedIn.length===0){let L=document.createElement("li");L.textContent="Non utilis\xE9",L.className="text-xs text-slate-400",p.appendChild(L);return}c.usedIn.forEach(L=>{let Y=document.createElement("li");Y.textContent=L,Y.className="text-xs text-slate-600",p.appendChild(Y)})}},ae=c=>{if(f){if(u){f.textContent=c?"T\xE9l\xE9versement\u2026":"T\xE9l\xE9verser",f.disabled=c||!H,d&&d.classList.add("hidden");return}f.textContent=c?"Enregistrement\u2026":"Enregistrer",f.disabled=c||!l,d&&(d.classList.remove("hidden"),d.disabled=!D)}},$e=c=>{let L=K.find(Y=>Y.id===c);if(!L){ne(),J();return}me(),D=L.id,l=!1,ae(!1),J(),I==null||I.classList.add("hidden"),C==null||C.classList.remove("hidden"),G&&(te(L)?G.innerHTML=`<img src="${L.path}" alt="${L.alt||L.filename}" class="h-full w-full rounded-2xl object-cover" />`:G.innerHTML='<div class="flex h-full w-full flex-col items-center justify-center gap-1 text-slate-400"><span class="text-3xl">\u{1F4C4}</span><span class="text-xs font-semibold">Document</span></div>'),W&&(W.textContent=L.filename||"Fichier"),$&&($.textContent=oe(L)),F&&(F.textContent=re(L.size)),w&&(w.value=L.alt||""),q&&(q.textContent=L.path||"\u2014"),xe(L)},le=c=>{if(c){if(u=!0,l=!1,D=null,I==null||I.classList.add("hidden"),C==null||C.classList.remove("hidden"),S&&URL.revokeObjectURL(S),S=URL.createObjectURL(c),G&&(G.innerHTML=`<img src="${S}" alt="${c.name}" class="h-full w-full rounded-2xl object-cover" />`),W&&(W.textContent=c.name),$&&($.textContent=oe({type:c.type,filename:c.name})),F&&(F.textContent=re(c.size)),w&&!w.value.trim()&&(w.value=c.name.replace(/\.[^.]+$/,"").replace(/[-_]/g," ")),q&&(q.textContent="En attente de t\xE9l\xE9versement"),p){p.innerHTML="";let L=document.createElement("li");L.textContent="Non utilis\xE9",L.className="text-xs text-slate-400",p.appendChild(L)}ae(!1)}},qe=()=>{let c=(A==null?void 0:A.value)||"all";c==="all"?V=[...K]:V=K.filter(L=>L.groupType===c),V.some(L=>L.id===D)||ne(),ie(),J()},Le=async()=>{if(!_){g==null||g.classList.remove("hidden");return}try{let c=await fetch(_,{headers:{Accept:"application/json"}});if(!c.ok)throw new Error("Impossible de charger les m\xE9dias.");let L=await c.json().catch(()=>({items:[]}));K=Array.isArray(L.items)?L.items.map(Y=>({...Y,groupType:m(Y)})):[],qe()}catch(c){console.error("[media] load failed",c),P(c.message||"Impossible de charger les m\xE9dias."),K=[],qe()}};A==null||A.addEventListener("change",()=>{qe()}),w==null||w.addEventListener("input",()=>{if(u){ae(!1);return}D&&(l=!0,ae(!1))});let Ve=c=>{if(c){if(!c.type.startsWith("image/")){P("Seules les images sont accept\xE9es pour le moment.");return}if(c.size>4*1024*1024){P("Fichier trop volumineux (4 Mo max).");return}H=c,le(c),Z&&(Z.textContent=`${c.name} \xB7 ${re(c.size)}`)}},Ze=c=>new Promise((L,Y)=>{let O=new FileReader;O.onload=()=>{let Ke=O.result||"",[,We=""]=String(Ke).split(",");L(We)},O.onerror=()=>Y(new Error("Impossible de lire ce fichier.")),O.readAsDataURL(c)}),Qe=async()=>{if(!(!H||!_)){h=!0,ae(!0);try{let c=await Ze(H),L={filename:H.name,type:H.type,size:H.size,alt:(w==null?void 0:w.value)||"",data:c},Y=await fetch(_,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(L)});if(!Y.ok){let Ke=await Y.json().catch(()=>({}));throw new Error(Ke.message||"Upload impossible.")}let O=await Y.json();O.groupType=m(O),K=[...K,O],N=O.id,qe(),$e(O.id),P("M\xE9dia ajout\xE9"),me()}catch(c){console.error("[media] upload failed",c),P(c.message||"Impossible de t\xE9l\xE9verser ce m\xE9dia.")}finally{h=!1,H=null,ae(!1)}}};k==null||k.addEventListener("click",()=>B==null?void 0:B.click()),B==null||B.addEventListener("change",()=>{B.files&&B.files[0]&&Ve(B.files[0])});let Je=()=>{E&&(E.classList.add("hidden"),E.classList.remove("flex"))},et=()=>{if(!(!D||u)){if(E){E.classList.remove("hidden"),E.classList.add("flex");return}window.confirm("Supprimer ce m\xE9dia ?")&&at()}},at=async()=>{if(!D||!_){Je();return}let c=()=>{d&&(d.disabled=!0),a&&(a.disabled=!0,a.textContent="Suppression\u2026")},L=()=>{d&&(d.disabled=!1),a&&(a.disabled=!1,a.textContent="Supprimer")};c();try{let Y=await fetch(`${_}/${encodeURIComponent(D)}`,{method:"DELETE"});if(!Y.ok){let O=await Y.json().catch(()=>({}));throw new Error(O.message||"Suppression impossible.")}K=K.filter(O=>O.id!==D),V=V.filter(O=>O.id!==D),P("M\xE9dia supprim\xE9"),ne(),ie(),J()}catch(Y){console.error("[media] delete failed",Y),P(Y.message||"Impossible de supprimer ce m\xE9dia.")}finally{L(),Je()}};T==null||T.addEventListener("click",Je),E==null||E.addEventListener("click",c=>{c.target===E&&Je()}),a==null||a.addEventListener("click",()=>at()),d==null||d.addEventListener("click",et),f==null||f.addEventListener("click",async()=>{if(u){Qe();return}if(!(!D||!_||!w)){ae(!0);try{let c={alt:w.value||""},L=await fetch(`${_}/${encodeURIComponent(D)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!L.ok){let O=await L.json().catch(()=>({}));throw new Error(O.message||"Impossible de mettre \xE0 jour ce m\xE9dia.")}let Y=await L.json();K=K.map(O=>O.id===D?{...O,...Y}:O),V=V.map(O=>O.id===D?{...O,...Y}:O),l=!1,ae(!1),P("M\xE9dia mis \xE0 jour")}catch(c){console.error("[media] update failed",c),P(c.message||"\xC9chec de la mise \xE0 jour."),ae(!1)}}}),Le()}});})();
