(()=>{document.addEventListener("DOMContentLoaded",()=>{var Cr;console.log("[admin] Atelier charg\xE9");let Eo=document.querySelector("[data-logout]");Eo&&Eo.addEventListener("click",async()=>{Eo.disabled=!0;try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(o){console.error("[admin] Impossible de se d\xE9connecter",o)}finally{window.location.href="/admin/index.html"}});let Cs=document.querySelector("[data-admin-sidebar]"),vt=document.querySelector("[data-admin-sidebar-overlay]"),cr=document.querySelectorAll("[data-admin-sidebar-toggle]"),Xr=document.querySelectorAll("[data-admin-sidebar-close]"),qo=document.body,Zs=!1,Ks=()=>{if(!Cs)return;if(window.matchMedia("(min-width: 1024px)").matches){Cs.classList.remove("hidden"),vt==null||vt.classList.add("hidden"),qo.classList.remove("overflow-hidden");return}Zs?(Cs.classList.remove("hidden"),vt==null||vt.classList.remove("hidden"),qo.classList.add("overflow-hidden")):(Cs.classList.add("hidden"),vt==null||vt.classList.add("hidden"),qo.classList.remove("overflow-hidden"))},en=()=>{Zs=!0,Ks()},Ao=()=>{Zs=!1,Ks()};Cs&&cr.length>0&&(cr.forEach(o=>{o.addEventListener("click",en)}),Xr.forEach(o=>{o.addEventListener("click",Ao)}),vt==null||vt.addEventListener("click",Ao),window.addEventListener("resize",Ks),window.addEventListener("keydown",o=>{o.key==="Escape"&&Zs&&Ao()}),Ks());let dr="clower:currentSite",ur="clower:currentSiteName",re={slug:null,name:""};(()=>{try{let o=window.localStorage.getItem(dr);re.slug=o?$t(Pe(o)):null,re.name=window.localStorage.getItem(ur)||""}catch{re.slug=null,re.name=""}})();let To=document.querySelectorAll("[data-site-card]"),tn=document.querySelectorAll("[data-site-select]"),Es=document.querySelector("[data-current-site-name]"),mr=document.querySelector("[data-workspace-site-name]"),fr=document.querySelector("[data-workspace-back-name]"),It=document.querySelector("[data-workspace-back-modal]"),sn=document.querySelectorAll("[data-workspace-back]"),on=document.querySelectorAll("[data-workspace-back-cancel]"),Io=document.querySelector("[data-workspace-back-confirm]"),rn=document.querySelectorAll("[data-workspace-tab]"),$o=document.querySelector("[data-site-toast]"),pr=document.querySelector("[data-site-toast-message]"),nn=document.querySelectorAll("[data-site-create]"),dt=document.querySelector("[data-site-modal]"),at=document.querySelector("[data-site-form]"),Xe=at==null?void 0:at.querySelector('input[name="siteName"]'),Fe=at==null?void 0:at.querySelector('input[name="siteSlug"]'),et=document.querySelector("[data-site-slug-error]"),tt=document.querySelector("[data-site-modal-error]"),an=document.querySelectorAll("[data-site-modal-cancel]"),ms=document.querySelector("[data-site-modal-submit]"),Z=vn(),_s=!1,Bo=null,gr='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',fs=[],hr=o=>Array.from(o.querySelectorAll(gr)).filter(n=>!n.hasAttribute("disabled")&&!n.getAttribute("aria-hidden")),ln=o=>{if(!fs.length)return;let n=fs[fs.length-1],{modal:c,onClose:f}=n;if(o.key==="Escape"){o.preventDefault(),f==null||f();return}if(o.key!=="Tab")return;let p=hr(c);if(!p.length)return;let v=p[0],V=p[p.length-1];o.shiftKey?document.activeElement===v&&(o.preventDefault(),V.focus()):document.activeElement===V&&(o.preventDefault(),v.focus())};document.addEventListener("keydown",ln);let qs=(o,n)=>{if(!o)return;fs.push({modal:o,onClose:n,trigger:document.activeElement instanceof HTMLElement?document.activeElement:null});let c=hr(o);window.setTimeout(()=>{var f,p;(p=(f=c[0]||o).focus)==null||p.call(f)},0)},As=o=>{var f,p;let n=fs.findIndex(v=>v.modal===o);if(n===-1)return;let[c]=fs.splice(n,1);(p=(f=c.trigger)==null?void 0:f.focus)==null||p.call(f)},le=document.querySelector("[data-mobile-panels-overlay]"),he=document.querySelector("[data-mobile-panels-layer]"),xt={left:document.querySelector('[data-mobile-panel="left"]'),right:document.querySelector('[data-mobile-panel="right"]')},_t=null;he!=null&&he.parentElement&&(_t=document.createComment("mobile-panels-layer-placeholder"),he.parentElement.insertBefore(_t,he));let Yt=null;(Cr=xt.right)!=null&&Cr.parentElement&&(Yt=document.createComment("mobile-panel-right-placeholder"),xt.right.parentElement.insertBefore(Yt,xt.right));let yr=document.querySelectorAll("[data-mobile-panel-toggle]"),cn=document.querySelectorAll("[data-mobile-panel-close]"),Ts={left:null,right:null},Et=null,Qt=()=>window.matchMedia("(min-width: 1024px)").matches,dn=()=>{if(!(!he||!_t)){if(Qt()){let o=_t.parentElement;if(!o)return;(he.parentElement!==o||_t.nextSibling!==he)&&o.insertBefore(he,_t.nextSibling),he.dataset.mobilePanelPlacement="sidebar";return}he.parentElement!==document.body&&(document.body.appendChild(he),he.dataset.mobilePanelPlacement="overlay")}},un=()=>{let o=xt.right;if(!(!o||!Yt)){if(Qt()){let n=Yt.parentElement;if(!n)return;(o.parentElement!==n||Yt.nextSibling!==o)&&n.insertBefore(o,Yt.nextSibling),o.dataset.mobilePanelPlacement="sidebar";return}if(he){let n=xt.left;n&&n.parentElement===he?(o.parentElement!==he||o.previousSibling!==n)&&he.insertBefore(o,n.nextSibling):o.parentElement!==he&&he.appendChild(o),o.dataset.mobilePanelPlacement="overlay"}else o.parentElement!==document.body&&(document.body.appendChild(o),o.dataset.mobilePanelPlacement="overlay")}},br=()=>{dn(),un()};br();let Ys={};Object.entries(xt).forEach(([o,n])=>{if(!n)return;let c=Number(window.getComputedStyle(n).zIndex)||0;Ys[o]=c});let mn=(Object.values(Ys).reduce((o,n)=>Math.max(o,n||0),0)||150)+5,Qs=(o,n)=>{let c=xt[o];if(c){if(Qt()){c.style.removeProperty("z-index");return}n?c.style.zIndex=String(mn):Ys[o]?c.style.zIndex=String(Ys[o]):c.style.removeProperty("z-index")}},Ht=(o,n,c)=>{!o||!n||n.split(" ").map(f=>f.trim()).filter(Boolean).forEach(f=>o.classList[c](f))},Po=(o,n)=>{if(!o)return;let c=o.dataset.mobilePanelHidden||"",f=o.dataset.mobilePanelVisible||"translate-x-0";n?(Ht(o,f,"remove"),Ht(o,c,"add"),o.classList.add("pointer-events-none"),o.classList.remove("pointer-events-auto"),o.setAttribute("aria-hidden","true"),o.dataset.mobilePanelOpen="false"):(Ht(o,c,"remove"),Ht(o,f,"add"),o.classList.remove("pointer-events-none"),o.classList.add("pointer-events-auto"),o.setAttribute("aria-hidden","false"),o.dataset.mobilePanelOpen="true")},Is=(o=Et)=>{var f;if(!o||Qt())return;let n=xt[o];if(!n)return;Qs(o,!1),Po(n,!0);let c=Ts[o];c&&c.setAttribute("aria-expanded","false"),Ts[o]=null,Et===o&&(le==null||le.classList.add("hidden"),le==null||le.classList.remove("pointer-events-auto"),le==null||le.classList.add("pointer-events-none"),le==null||le.setAttribute("aria-hidden","true"),he==null||he.classList.add("pointer-events-none"),document.body.classList.remove("overflow-hidden"),(f=c==null?void 0:c.focus)==null||f.call(c),Et=null)},fn=(o,n)=>{if(!o||Qt())return;let c=xt[o];if(!c)return;Et&&Et!==o&&Is(Et),Po(c,!1),Qs(o,!0),Et=o,Ts[o]=n||null,n&&n.setAttribute("aria-expanded","true"),le==null||le.classList.remove("hidden","pointer-events-none"),le==null||le.classList.add("pointer-events-auto"),le==null||le.setAttribute("aria-hidden","false"),he==null||he.classList.remove("pointer-events-none"),document.body.classList.add("overflow-hidden");let f=c.querySelector(gr);window.setTimeout(()=>{var p;(p=f==null?void 0:f.focus)==null||p.call(f)},0)},vr=()=>{br(),Qt()?(le==null||le.classList.add("hidden"),he==null||he.classList.add("pointer-events-none"),document.body.classList.remove("overflow-hidden"),Et=null,Object.keys(xt).forEach(o=>{let n=xt[o];if(!n)return;Qs(o,!1),n.classList.remove("pointer-events-none"),n.classList.add("pointer-events-auto"),n.setAttribute("aria-hidden","false"),n.dataset.mobilePanelOpen="false";let c=Ts[o];c==null||c.setAttribute("aria-expanded","false"),Ts[o]=null})):(Object.entries(xt).forEach(([o,n])=>{n&&n.dataset.mobilePanelOpen!=="true"&&(Po(n,!0),Qs(o,!1))}),Et||(le==null||le.classList.add("hidden","pointer-events-none"),le==null||le.classList.remove("pointer-events-auto"),le==null||le.setAttribute("aria-hidden","true"),he==null||he.classList.add("pointer-events-none")))};yr.length>0&&(yr.forEach(o=>{let n=o.dataset.mobilePanelToggle;o.addEventListener("click",()=>{Et===n?Is(n):fn(n,o)})}),cn.forEach(o=>{let n=o.dataset.mobilePanelClose;o.addEventListener("click",()=>Is(n))}),le==null||le.addEventListener("click",()=>Is()),window.addEventListener("keydown",o=>{o.key==="Escape"&&Et&&!Qt()&&Is()}),window.addEventListener("resize",vr),vr());let M=o=>{!$o||!pr||(pr.textContent=o,$o.classList.remove("hidden"),Bo&&clearTimeout(Bo),Bo=setTimeout(()=>{$o.classList.add("hidden")},2500))};function $t(o){if(!o)return"";let n=`${o}`.trim();if(!n)return"";let c=n.replace(/^\/+/,"");return c?`/${c}`:"/"}function Pe(o){return o?`${o}`.replace(/^\/+/,""):""}let Xs=(o,n)=>{let c=o?$t(o):null;try{c&&(window.localStorage.setItem(dr,c),re.slug=c),typeof n=="string"&&n.length>0&&(window.localStorage.setItem(ur,n),re.name=n)}catch{re.slug=c||re.slug,re.name=n||re.name}},xr=o=>{Es&&o&&(Es.textContent=o),mr&&o&&(mr.textContent=o),fr&&o&&(fr.textContent=o)},jo=o=>{rn.forEach(n=>{let c=n.dataset.workspaceTab;if(!c)return;if(!o){n.href="#",n.classList.add("pointer-events-none","opacity-50","text-slate-400"),n.setAttribute("aria-disabled","true");return}let f=encodeURIComponent(Pe(o));n.href=`/admin/site/${f}/${c}`,n.classList.remove("pointer-events-none","opacity-50","text-slate-400"),n.removeAttribute("aria-disabled")})},eo=(o,n={})=>{if(!o)return;let c=$t(o),f=n.siteName||re.name||(Es==null?void 0:Es.dataset.defaultSiteName)||"";To.forEach(v=>{let H=$t(v.dataset.siteCard||"")===c,W=v.querySelector("[data-site-active-badge]");H?(v.classList.add("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),v.classList.remove("border-slate-200"),W==null||W.classList.remove("hidden"),f=v.dataset.siteName||f):(v.classList.remove("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),v.classList.add("border-slate-200"),W==null||W.classList.add("hidden"))}),n.persist!==!1&&Xs(c,n.siteName||f);let p=n.siteName||f;xr(p),jo(c)},pn=async(o,n)=>{let c=$t(o);try{let f=await fetch("/api/sites/select",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slug:c})});if(!f.ok){let W=await f.json().catch(()=>({}));M(W.message||"Impossible de s\xE9lectionner ce site.");return}let p=await f.json().catch(()=>({})),v=$t(p.slug||c),V=p.name||n;Xs(v,V),eo(v,{siteName:V,persist:!1});let H=encodeURIComponent(Pe(v));window.location.href=`/admin/site/${H}/design`}catch(f){console.error("[admin] Impossible de s\xE9lectionner le site",f),M("Erreur inattendue lors de la s\xE9lection.")}},gn=async()=>{try{let o=await fetch("/api/sites/current",{credentials:"same-origin"});if(!o.ok){o.status===404&&Z&&(window.location.href="/admin/sites");return}let n=await o.json(),c=$t(n.slug);Xs(c,n.name),eo(c,{siteName:n.name,persist:!1})}catch(o){console.warn("[admin] Impossible de r\xE9cup\xE9rer le site actif",o)}};(()=>{if(re.slug){eo(re.slug,{siteName:re.name,persist:!1});return}let o=document.querySelector('[data-site-card][data-site-default="true"]')||To[0];o&&eo(o.dataset.siteCard,{siteName:o.dataset.siteName||"",persist:!1})})(),gn(),Z?jo(Z.slugValue):re.slug&&jo(re.slug),tn.forEach(o=>{o.addEventListener("click",()=>{if(o.disabled)return;let n=o.dataset.siteSelect,c=o.dataset.siteSelectName||"Ce site";n&&(o.disabled=!0,pn(n,c).finally(()=>{o.disabled=!1}))})});let Xt=o=>(o||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),hn=o=>{let n=Xt(o||"");return n?`/${n}`:""},yn=()=>{dt&&(dt.classList.remove("hidden"),dt.classList.add("flex"),_s=!1,at==null||at.reset(),et&&(et.textContent=""),tt&&(tt.textContent=""),Fe&&Xe&&(Fe.value=Xt(Xe.value)),qs(dt,$s),window.setTimeout(()=>{Xe==null||Xe.focus()},0))},$s=()=>{dt&&(dt.classList.add("hidden"),dt.classList.remove("flex"),_s=!1,at==null||at.reset(),et&&(et.textContent=""),tt&&(tt.textContent=""),As(dt))};nn.forEach(o=>{o.addEventListener("click",yn)}),an.forEach(o=>{o.addEventListener("click",$s)}),dt==null||dt.addEventListener("click",o=>{o.target===dt&&$s()}),Xe==null||Xe.addEventListener("input",()=>{Fe&&((!_s||Fe.value.trim().length===0)&&(Fe.value=Xt(Xe.value)),et&&(et.textContent=""),tt&&(tt.textContent=""))}),Fe==null||Fe.addEventListener("focus",()=>{let o=(Fe==null?void 0:Fe.value)||"",n=(Xe==null?void 0:Xe.value)||"";!o.trim()&&n.trim()&&(Fe.value=Xt(n))}),Fe==null||Fe.addEventListener("input",()=>{_s=!0,et&&(et.textContent=""),tt&&(tt.textContent="")});let bn=()=>new Set(Array.from(To).map(o=>$t(o.dataset.siteCard||"")));at==null||at.addEventListener("submit",async o=>{if(o.preventDefault(),console.log("[admin] Form submit - siteNameInput:",Xe,"siteSlugInput:",Fe),!Xe||!Fe){console.log("[admin] Missing inputs, aborting");return}let n=(Xe.value||"").trim(),c=(Fe.value||"").trim();console.log("[admin] nameValue:",n,"slugValue:",c),!c&&n&&(c=Xt(n),Fe.value=c,console.log("[admin] Auto-generated slug:",c));let f=hn(c);if(console.log("[admin] normalizedSlug:",f),!n){console.log("[admin] Name validation failed"),tt&&(tt.textContent="Le nom du site est requis."),Xe.focus();return}if(!f){console.log("[admin] Slug validation failed"),et&&(et.textContent="Le slug ne peut pas \xEAtre vide ou contenir uniquement des caract\xE8res sp\xE9ciaux."),Fe.focus();return}if(bn().has(f)){et&&(et.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}et&&(et.textContent=""),tt&&(tt.textContent=""),ms&&(ms.disabled=!0,ms.textContent="Cr\xE9ation...");try{let v=await fetch("/api/sites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:n,slug:f})});if(!v.ok){let _=await v.json().catch(()=>({})),S=_.message||"Impossible de cr\xE9er ce site.";tt&&(tt.textContent=S),_.field==="slug"&&et&&(et.textContent=S);return}let V=await v.json(),H=$t((V==null?void 0:V.slug)||f),W=(V==null?void 0:V.name)||n;Xs(H,W),$s();let se=encodeURIComponent(Pe(H));window.location.href=`/admin/site/${se}/design`}catch(v){console.error("[admin] Impossible de cr\xE9er le site",v),tt&&(tt.textContent="Erreur inattendue. R\xE9essaie dans un instant.")}finally{ms&&(ms.disabled=!1,ms.textContent="Cr\xE9er")}}),window.addEventListener("keydown",o=>{o.key==="Escape"&&(dt&&!dt.classList.contains("hidden")&&$s(),It&&!It.classList.contains("hidden")&&to(),blockDeleteModal&&!blockDeleteModal.classList.contains("hidden")&&closeBlockDeleteModal(),blockLibraryOpen&&closeBlockLibrary())});function vn(){let o=window.location.pathname.match(/^\/admin\/site\/([^/]+)(?:\/([^/]+))?/);return o?{slugPart:decodeURIComponent(o[1]),slugValue:$t(decodeURIComponent(o[1])),section:o[2]||"design"}:null}function xn(){return document.querySelector("[data-page-list]")?"design":document.querySelector("[data-collection-list]")?"content":document.querySelector("[data-media-grid]")?"media":document.querySelector("[data-deploy-form]")?"deploy":null}function wn(){if(!It){window.location.href="/admin/sites";return}It.classList.remove("hidden"),It.classList.add("flex"),qs(It,to)}function to(){It&&(It.classList.add("hidden"),It.classList.remove("flex"),As(It))}sn.forEach(o=>{o.addEventListener("click",wn)}),on.forEach(o=>{o.addEventListener("click",to)}),Io==null||Io.addEventListener("click",()=>{to(),window.location.href="/admin/sites"});let es="repeating-conic-gradient(#ccc 0% 25%, white 0% 50%) 50% / 8px 8px",Sn=o=>{if(!o||typeof o!="string")return null;let n=o.trim().toLowerCase();if(n==="transparent")return null;let c=n.match(/^rgb\\(\\s*(\\d{1,3})\\s*,\\s*(\\d{1,3})\\s*,\\s*(\\d{1,3})\\s*\\)$/);if(c)return[Math.min(255,Math.max(0,Number(c[1]))),Math.min(255,Math.max(0,Number(c[2]))),Math.min(255,Math.max(0,Number(c[3])))];let f=n.match(/^#([a-f0-9]{3}|[a-f0-9]{6})$/);if(f){let p=f[1],v=p.length===3?p.split("").map(se=>`${se}${se}`).join(""):p,V=parseInt(v.slice(0,2),16),H=parseInt(v.slice(2,4),16),W=parseInt(v.slice(4,6),16);return[V,H,W]}return null},Mo=o=>{let n=Sn(o);if(!n)return"#0f172a";let[c,f,p]=n;return(.2126*c+.7152*f+.0722*p)/255>.62?"#0f172a":"#ffffff"},so=o=>{o&&Array.from(o.options).forEach(n=>{var f;let c=(f=n.dataset)==null?void 0:f.color;if(c){if(c==="transparent"){n.style.background=es,n.style.color="#475569";return}n.style.background=c,n.style.color=Mo(c)}})},Bs=(Z==null?void 0:Z.section)||xn();Bs==="design"&&Ln(),Bs==="content"&&kn(),Bs==="media"&&qn(),Bs==="deploy"&&Cn(),Bs==="settings"&&En(),Z&&re.name&&xr(re.name);function Ln(){let o=document.querySelectorAll("[data-page-list]");if(o.length===0)return;let n=document.querySelector("[data-active-page-title]"),c=document.querySelector("[data-active-page-slug]"),f=document.querySelector("[data-page-preview-tags]"),p=document.querySelector("[data-page-preview-frame]"),v=document.querySelector("[data-page-preview-frame-wrapper]"),V=document.querySelector("[data-page-preview-shell]"),H=document.querySelectorAll("[data-preview-view-button]"),W=document.querySelector("[data-page-preview-current-view]"),se=document.querySelector("[data-preview-open]"),_=document.querySelector("[data-preview-status]"),S=document.querySelector("[data-preview-highlight]"),T=document.querySelector("[data-seo-toggle]"),$=document.querySelector("[data-seo-panel]"),F=document.querySelector("[data-seo-close]"),P=document.querySelector("[data-seo-form]"),U=document.querySelector("[data-seo-title]"),k=document.querySelector("[data-seo-description]"),L=document.querySelector("[data-seo-indexed]"),w=document.querySelector("[data-seo-feedback]"),q=document.querySelector("[data-seo-save]"),E=document.querySelector("[data-page-accessibility-toggle]"),D=document.querySelector("[data-page-accessibility-panel]"),K=document.querySelector("[data-page-accessibility-close]"),te=document.querySelector("[data-page-accessibility-form]"),Q=document.querySelector("[data-page-accessibility-nav]"),ke=document.querySelector("[data-page-accessibility-main]"),Te=document.querySelector("[data-page-accessibility-feedback]"),Ge=document.querySelector("[data-page-accessibility-save]"),Ee=document.querySelector("[data-page-props-toggle]"),G=document.querySelector("[data-page-props-panel]"),Ie=document.querySelector("[data-page-props-close]"),$e=document.querySelector("[data-page-props-form]"),N=document.querySelector("[data-page-name]"),x=document.querySelector("[data-page-title-input]"),X=document.querySelector("[data-page-slug-input]"),J=document.querySelector("[data-page-description]"),g=document.querySelector("[data-page-props-feedback]"),R=document.querySelector("[data-page-props-save]"),I=document.querySelector("[data-blocks-list]"),oe=document.querySelector("[data-blocks-empty]"),ce=document.querySelector("[data-block-count]"),be=document.querySelector("[data-block-library-toggle]"),pe=document.querySelector("[data-block-library]"),Ce=document.querySelectorAll("[data-block-add]"),ge=document.querySelector("[data-block-delete-modal]"),Ne=document.querySelector("[data-block-delete-confirm]"),Ue=document.querySelector("[data-block-delete-cancel]"),xe=document.querySelector("[data-block-detail-empty]"),Me=document.querySelector("[data-block-detail-status]"),Re=document.querySelector("[data-block-editor]"),St=document.querySelector("[data-block-editor-block-name]"),b=document.querySelector("[data-block-editor-block-type]"),B=document.querySelector("[data-block-editor-unsupported]"),h=document.querySelector("[data-block-form]"),de=(e,t)=>{if(e){if(t==="transparent"){e.style.background=es,e.style.borderColor="#cbd5f5",e.style.boxShadow="";return}e.style.background=t,e.style.borderColor=t,e.style.boxShadow="0 0 0 1px rgba(15,23,42,0.15)"}},Pt=(e,t)=>{if(!e||!t||Array.from(e.options).some(r=>r.value===t))return;let s=document.createElement("option");s.value=t,s.textContent="Couleur personnalis\xE9e",s.dataset.color=t,t==="transparent"?(s.style.background=es,s.style.color="#475569"):(s.style.background=t,s.style.color=Mo(t)),e.appendChild(s),so(e)},ts=e=>{var l,m,C;if(!e)return;let t=e.options[e.selectedIndex],s=((l=t==null?void 0:t.dataset)==null?void 0:l.color)||"#ffffff",r=(m=e.closest(".relative"))==null?void 0:m.querySelector("[data-color-preview]");r&&(s==="transparent"?r.style.background=es:r.style.background=s);let i=(C=e.closest(".relative"))==null?void 0:C.querySelector("[data-theme-color-chip]");de(i,s)},ao=h?Array.from(h.querySelectorAll("[data-theme-color-select]")):[],Ro=e=>{var s;return(((s=e==null?void 0:e.getAttribute)==null?void 0:s.call(e,"name"))||"").endsWith("-bg")},Ps=[{label:"Couleur primaire",value:"theme-primary",cssVar:"--color-primary"},{label:"Couleur secondaire",value:"theme-secondary",cssVar:"--color-secondary"},{label:"Couleur accent",value:"theme-accent",cssVar:"--color-accent"},{label:"Fond",value:"theme-background",cssVar:"--color-background"},{label:"Texte",value:"theme-text",cssVar:"--color-text"}],Er=(e,t="#ffffff")=>{if(!e)return t;let s=getComputedStyle(document.documentElement).getPropertyValue(e);return s?s.trim():t},io=e=>{e&&(e.innerHTML="",Ps.forEach(({label:t,value:s,cssVar:r})=>{let i=document.createElement("option");i.value=s;let l=Er(r);i.textContent=t,i.dataset.color=l,l==="transparent"?(i.style.background=es,i.style.color="#475569"):(i.style.background=l,i.style.color=Mo(l)),e.appendChild(i)}),e.value=Ps[0].value,e.removeAttribute("disabled"),Ro(e)&&so(e),ts(e))},ut=()=>ao.forEach(io);ut(),document.addEventListener("ai-theme-updated",ut);let jt=h?Array.from(h.querySelectorAll("[data-editor-section]")):[],ze=e=>!h||!(e!=null&&e.section)?null:h.querySelector(`[data-editor-section="${e.section}"]`),Oe=document.querySelectorAll("[data-block-tab]"),Je="content",mt=document.querySelectorAll("[data-left-tab]"),Wt=document.querySelector('[data-left-panel="blocks"]'),Ut=document.querySelector('[data-left-panel="pages"]'),js="blocks",zo=e=>{js=e,mt.forEach(t=>{let s=t.dataset.leftTab===e;t.setAttribute("aria-selected",s?"true":"false"),s?(t.classList.add("text-[#9C6BFF]"),t.classList.remove("text-slate-500","hover:text-slate-700"),t.classList.add("after:absolute","after:bottom-0","after:left-0","after:right-0","after:h-0.5","after:bg-[#9C6BFF]")):(t.classList.remove("text-[#9C6BFF]"),t.classList.add("text-slate-500","hover:text-slate-700"),t.classList.remove("after:absolute","after:bottom-0","after:left-0","after:right-0","after:h-0.5","after:bg-[#9C6BFF]"))}),Wt&&Wt.classList.toggle("hidden",e!=="blocks"),Ut&&Ut.classList.toggle("hidden",e!=="pages")};mt.forEach(e=>{e.addEventListener("click",()=>{zo(e.dataset.leftTab)})});let Gt=document.querySelector("[data-block-form-actions]"),ss=document.querySelector("[data-block-form-autosave]"),Rt=e=>{Je=e,Oe.forEach(s=>{let r=s.dataset.blockTab===e;s.setAttribute("aria-selected",r?"true":"false"),r?(s.classList.add("text-[#9C6BFF]"),s.classList.remove("text-slate-500","hover:text-slate-700"),s.classList.add("after:absolute","after:bottom-0","after:left-0","after:right-0","after:h-0.5","after:bg-[#9C6BFF]")):(s.classList.remove("text-[#9C6BFF]"),s.classList.add("text-slate-500","hover:text-slate-700"),s.classList.remove("after:absolute","after:bottom-0","after:left-0","after:right-0","after:h-0.5","after:bg-[#9C6BFF]"))});let t=h==null?void 0:h.querySelector("[data-editor-section]:not(.hidden)");t&&t.querySelectorAll("[data-block-panel]").forEach(r=>{r.dataset.blockPanel===e?r.classList.remove("hidden"):r.classList.add("hidden")}),Gt&&ss&&(e==="content"?(Gt.classList.remove("hidden"),ss.classList.add("hidden")):(Gt.classList.add("hidden"),ss.classList.remove("hidden")))};Oe.forEach(e=>{e.addEventListener("click",()=>{Rt(e.dataset.blockTab)})});let We=h==null?void 0:h.querySelector('[name="collection-grid-collection"]'),zt=h==null?void 0:h.querySelector("[data-collection-selection-info]"),os=document.querySelector("[data-block-form-cancel]"),Ms=h==null?void 0:h.querySelector("[data-group-preview-mobile]"),gt=h==null?void 0:h.querySelector("[data-group-preview-desktop]"),lo=h==null?void 0:h.querySelector("[data-collection-preview-mobile]"),gs=h==null?void 0:h.querySelector("[data-collection-preview-desktop]"),co={hero:{section:"hero",labelField:"title",descriptionField:"subtitle",fields:{title:"hero-title",subtitle:"hero-subtitle",ctaLabel:"hero-cta-label",ctaUrl:"hero-cta-url",ctaTextColor:"hero-cta-text-color",image:"hero-image",layout:"hero-layout",imageWidth:"hero-image-width",imageHeight:"hero-image-height",imageObjectFit:"hero-image-object-fit",height:"hero-height",contentAlign:"hero-content-align",horizontalAlign:"hero-horizontal-align",textAlign:"hero-text-align",overlay:"hero-overlay",titleSize:"hero-title-size",bg:"hero-bg",borderRadius:"hero-border-radius",shadow:"hero-shadow",border:"hero-border"}},paragraphe:{section:"paragraph",labelField:"title",descriptionField:"content",fields:{title:"paragraph-title",content:"paragraph-content",align:"paragraph-align",titleSize:"paragraph-title-size",textSize:"paragraph-text-size",spacing:"paragraph-spacing",bg:"paragraph-bg",borderRadius:"paragraph-border-radius",shadow:"paragraph-shadow",border:"paragraph-border"}},image:{section:"image",labelField:"alt",fields:{src:"image-src",alt:"image-alt",showCaption:"image-caption-toggle",caption:"image-caption",rounded:"image-rounded",shadow:"image-shadow",maxWidth:"image-max-width",height:"image-height",objectFit:"image-object-fit",align:"image-align",bg:"image-bg",borderRadius:"image-border-radius",border:"image-border"}},groupe:{section:"group",fields:{columnsMobile:"group-columns-mobile",columnsDesktop:"group-columns-desktop",gap:"group-gap",itemsAlign:"group-items-align",mobileLayout:"group-mobile-layout",bg:"group-bg",borderRadius:"group-border-radius",shadow:"group-shadow",border:"group-border"}},collectiongrid:{section:"collection",fields:{collectionId:"collection-grid-collection",limit:"collection-grid-limit",columnsMobile:"collection-columns-mobile",columnsDesktop:"collection-columns-desktop",gap:"collection-gap",itemsAlign:"collection-items-align",cardRounded:"collection-card-rounded",mobileLayout:"collection-mobile-layout",bg:"collection-bg",borderRadius:"collection-border-radius",shadow:"collection-shadow",border:"collection-border"}},form:{section:"form",labelField:"formTitle",fields:{formTitle:"form-title",actionUrl:"form-action-url",method:"form-method",serviceName:"form-service-name",submitLabel:"form-submit-label",successMessage:"form-success-message",maxWidth:"form-max-width",align:"form-align",buttonRounded:"form-button-rounded",spacing:"form-spacing",bg:"form-bg",borderRadius:"form-border-radius",shadow:"form-shadow",border:"form-border"}},newsletterembed:{section:"newsletter",labelField:"title",fields:{title:"newsletter-title",serviceName:"newsletter-service-name",embedCode:"newsletter-embed-code",maxWidth:"newsletter-max-width",align:"newsletter-align",padding:"newsletter-padding",bg:"newsletter-bg",borderRadius:"newsletter-border-radius",shadow:"newsletter-shadow",border:"newsletter-border"}}},Vo={texte:"paragraphe",paragraph:"paragraphe",paragraphs:"paragraphe",paragraphes:"paragraphe",text:"paragraphe",hero:"hero",image:"image",groupe:"groupe",group:"groupe",collection:"collectiongrid",collectiongrid:"collectiongrid","collection-grid":"collectiongrid",form:"form",formulaire:"form",contact:"form",newsletterembed:"newsletterembed",newsletter:"newsletterembed",embed:"newsletterembed"},uo={animation:"anim-type",animationDelay:"anim-delay",animationDuration:"anim-duration"};Object.values(co).forEach(e=>{e.fields={...e.fields,...uo}});let mo=(e,t)=>{if(!Ms||!gt)return;let s=r=>Array.from({length:Number(r)||1}).map(()=>'<span class="block h-2 w-full rounded-full bg-slate-300"></span>').join("");Ms.innerHTML=s(e),gt.innerHTML=s(t)},Fs=(e,t)=>{if(!lo||!gs)return;let s=r=>Array.from({length:Number(r)||1}).map(()=>'<span class="block h-2 w-full rounded-full bg-violet-300"></span>').join("");lo.innerHTML=s(e),gs.innerHTML=s(t)},Ns=async()=>{if(!kt)return[];let e=await fetch(kt,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les pages.");let t=await e.json().catch(()=>[]);return Array.isArray(t)?t:[]},Oo=async({name:e,title:t,slug:s})=>{if(!kt)throw new Error("Site inconnu.");let r=await fetch(kt,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,title:t,slug:s})});if(!r.ok){let i=await r.json().catch(()=>({}));throw new Error(i.message||"Impossible de cr\xE9er la page.")}return r.json().catch(()=>({}))},rs=async e=>{if(!(!kt||!(e!=null&&e.id)))try{let t=await fetch(`${kt}/${encodeURIComponent(e.id)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let r=await t.json().catch(()=>({}));throw new Error(r.message||"Impossible de sauvegarder la page.")}let s=await t.json().catch(()=>({}));if(s!=null&&s.id){let r=ds(s);return fe=fe.map(i=>i.id===r.id?r:i),(u==null?void 0:u.id)===r.id&&(u=r),r}return s}catch(t){console.error("[design] Save page failed",t),M(t.message||"Sauvegarde impossible.")}},Jo=async()=>{if(!kt){fe=[],He=null,u=null,Kt(fe,He),Ct(null),xe==null||xe.classList.remove("hidden"),Re==null||Re.classList.add("hidden");return}try{let e=await Ns();if(fe=(Array.isArray(e)?e:[]).map(t=>ds(t)),fe.length===0){He=null,u=null,Kt(fe,He),Ct(null),xe==null||xe.classList.remove("hidden"),Re==null||Re.classList.add("hidden"),p&&(p.srcdoc=d());return}He=Wn(fe),Tt(He)}catch(e){console.error("[design] Impossible de charger les pages",e),M("Impossible de charger les pages.")}},hs=e=>(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),ns=e=>{if(!e)return null;let t=hs(e.type),s=Vo[t]||t;return co[s]||null},Ds=e=>{var i,l,m,C,z,ne,ae;if(!h||!Re)return;e&&!e.settings&&(e.settings={});let t=ns(e),s=ze(t)||h;if(St&&(St.textContent=(e==null?void 0:e.label)||"Bloc"),b&&(b.textContent=(e==null?void 0:e.type)||"Bloc"),!t){h.classList.add("hidden"),B==null||B.classList.remove("hidden"),h.dataset.blockId="";return}if(B==null||B.classList.add("hidden"),h.classList.remove("hidden"),h.reset(),h.dataset.blockId=e.id,jt.forEach(ve=>{ve.dataset.editorSection===t.section?ve.classList.remove("hidden"):ve.classList.add("hidden")}),Rt("content"),t.section==="collection"){let ve=e.collectionId||((i=e.settings)==null?void 0:i.collectionId)||"";Lo(ve)}if(Object.entries(t.fields).forEach(([ve,Le])=>{var nt,Be,ye;let ie=s.querySelector(`[name="${Le}"]`);if(!ie)return;let A=(nt=e.settings)==null?void 0:nt[ve];if(ie.type==="checkbox")ie.checked=!!A;else if(ie.type==="number"){let Qe=(ye=(Be=ie.dataset.default)!=null?Be:ie.defaultValue)!=null?ye:"";ie.value=A!=null?A:Qe}else ie.tagName,ie.value=A!=null?A:""}),t.section==="group"){let ve=((l=h.querySelector('[name="group-columns-mobile"]'))==null?void 0:l.value)||"1",Le=((m=h.querySelector('[name="group-columns-desktop"]'))==null?void 0:m.value)||"3";mo(ve,Le)}if(t.section==="collection"){let ve=((C=h.querySelector('[name="collection-columns-mobile"]'))==null?void 0:C.value)||"1",Le=((z=h.querySelector('[name="collection-columns-desktop"]'))==null?void 0:z.value)||"3";Fs(ve,Le)}let r=(ne=t.fields)==null?void 0:ne.bg;if(r){let ve=s.querySelector(`[name="${r}"]`);Pt(ve,(ae=e.settings)==null?void 0:ae.bg)}h.querySelectorAll("[data-color-select]").forEach(ts)},as=e=>{if(!h||!e)return{};let t=ze(e)||h,s={};return Object.entries(e.fields).forEach(([r,i])=>{var m,C;let l=t.querySelector(`[name="${i}"]`);if(l)if(l.type==="checkbox")s[r]=l.checked;else if(l.type==="number"){let z=Number(l.value);s[r]=Number.isFinite(z)?z:0}else if(l.tagName==="SELECT"){let z=(C=(m=l.dataset.default)!=null?m:l.value)!=null?C:"";s[r]=l.value||z}else l.tagName==="TEXTAREA"?s[r]=l.value||"":l.type==="select-one"?s[r]=l.value:s[r]=l.value||""}),s},qt=e=>{if(_){if(!e){_.classList.add("hidden");return}_.classList.remove("hidden"),_.textContent=e}},a=e=>{if(!e)return null;let t=s=>{var r;return{id:s.id,type:s.type,label:s.label,status:s.status,description:s.description,props:s.props||[],settings:s.settings||{},collectionId:s.collectionId||((r=s.settings)==null?void 0:r.collectionId)||"",children:(s.children||[]).map(t)}};return{id:e.id,name:e.name,title:e.title,slug:e.slug,description:e.description||"",badges:[...e.badges||[]],seo:e.seo||{},accessibility:e.accessibility||{},blocks:(e.blocks||[]).map(t)}},d=()=>'<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#475569;background:#fff;">Pr\xE9paration de la pr\xE9visualisation\u2026</body></html>',y=(e,t)=>{let s;return(...r)=>{clearTimeout(s),s=setTimeout(()=>e(...r),t)}},j=async()=>{if(!u||!Ye)return;let e=ls(),t=ns(e);if(!e||!t)return;let s=as(t),{blocks:r,didUpdate:i,foundParentId:l}=Rr(u.blocks||[],e.id,C=>{let z={...C.settings||{},...s};return{...C,settings:z}},cs);if(!i)return;cs=l;let m={...u,blocks:r};u=m;try{let C=await rs(m);if(C!=null&&C.id){let z=ds(C);u=z,fe=fe.map(ne=>ne.id===z.id?z:ne)}}catch(C){console.warn("[design] auto-save appearance failed",C)}},Y=(e,t)=>{!p||!p.contentWindow||p.contentWindow.postMessage({type:"updateBlockStyles",blockId:e,settings:t},"*")},ue=y(()=>{u&&O(u)},1500),me=(e,t)=>{Y(e,t),qt("Modification\u2026"),j().then(()=>{qt("Sauvegard\xE9"),setTimeout(()=>qt("\xC0 jour"),1500)}).catch(()=>qt("Erreur de sauvegarde")),ue()},O=e=>{if(!p||!e)return;let t=(Z==null?void 0:Z.slugValue)||re.slug||"",s=fe.map(l=>({id:l.id,slug:l.slug,title:l.title,name:l.name,accessibility:l.accessibility})),r={page:a(e),site:{title:re.name||"Site",slug:t,pages:s}};sr=!1,qt("Actualisation\u2026"),p.srcdoc=d(),Js&&Js.abort();let i=new AbortController;Js=i,fetch("/api/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r),signal:i.signal}).then(l=>{if(!l.ok)throw new Error("Preview error");return l.json()}).then(l=>{i.signal.aborted||(tr=l.html||"",p.setAttribute("title",`Pr\xE9visualisation de la page ${e.title||""}`.trim()),p.srcdoc=tr||d(),qt("\xC0 jour"))}).catch(l=>{i.signal.aborted||(console.error("[preview] Impossible de rendre la page",l),qt("Erreur preview"),p.srcdoc='<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#be123c;background:#fff;">Erreur lors du rendu de la pr\xE9visualisation.</body></html>')}).finally(()=>{Js===i&&(Js=null)})},we=e=>{var C;if(e.preventDefault(),!u||!Ye)return;let t=ls(),s=ns(t);if(!t||!s)return;let r=as(s);if(s.section==="image"){let z=(r.alt||"").trim();if(r.alt=z,!z){M("Ajoute un texte alternatif pour cette image.","error"),(C=h==null?void 0:h.querySelector('[name="image-alt"]'))==null||C.focus();return}}if(s.section==="collection"){if(!r.collectionId){M("S\xE9lectionnez une collection.");return}r.limit=Math.max(1,Number(r.limit)||1)}let{blocks:i,didUpdate:l,foundParentId:m}=Rr(u.blocks||[],t.id,z=>{let ne={...z.settings||{},...r},ae={...z,settings:ne};return s.labelField&&r[s.labelField]&&(ae.label=r[s.labelField]),s.descriptionField&&r[s.descriptionField]&&(ae.description=r[s.descriptionField]),s.section==="collection"&&(ae.collectionId=r.collectionId,ae.settings.collectionId=r.collectionId,ae.settings.limit=r.limit),ae},cs);l&&(cs=m,Ss(i),M("Bloc mis \xE0 jour"),Tt(u.id,{preserveBlock:!0}))},Se=document.querySelector("[data-page-drawer]"),ee=document.querySelector("[data-page-drawer-backdrop]"),je=document.querySelectorAll("[data-page-drawer-open]"),st=document.querySelectorAll("[data-page-drawer-close]"),qe=document.querySelector("[data-add-page-toggle]"),De=document.querySelector("[data-add-page-form]"),ot=document.querySelector("[data-add-page-name]"),At=document.querySelector("[data-add-page-title]"),ht=document.querySelector("[data-add-page-slug]"),ys=document.querySelector("[data-add-page-cancel]"),Ze=document.querySelector("[data-add-page-error]"),Vt=De==null?void 0:De.querySelector('[type="submit"]'),bs=document.querySelector("[data-import-pages-toggle]"),lt=document.querySelector("[data-import-modal]"),Hs=document.querySelectorAll("[data-import-modal-close]"),ct=document.querySelector("[data-import-dropzone]"),vs=document.querySelector("[data-import-file-input]"),xs=document.querySelector("[data-import-file-list]"),Us=document.querySelector("[data-import-file-names]"),Ke=document.querySelector("[data-import-results]"),_e=document.querySelector("[data-import-results-content]"),rt=document.querySelector("[data-import-submit]"),ws=document.querySelectorAll("[data-import-tab]"),Rs=document.querySelectorAll("[data-import-panel]"),Wo=document.querySelector("[data-copy-prompt]"),Go=document.querySelector("[data-copy-template]"),qr=document.querySelector("[data-template-json]"),Ar=document.querySelector("[data-import-ai-prompt]"),yt=document.querySelector("[data-import-paste-json]"),Zo=document.querySelector("[data-format-json]"),Mt=document.querySelector("[data-import-paste-error]"),Ot=[],is="upload",Lt=document.querySelector("[data-delete-page-modal]"),Tr=document.querySelector("[data-delete-page-name]"),Ko=document.querySelector("[data-delete-page-cancel]"),Jt=document.querySelector("[data-delete-page-confirm]"),zs=null,zn=Pe((Z==null?void 0:Z.slugValue)||re.slug||"default")||"default",Vn=(Z==null?void 0:Z.slugValue)||re.slug||"",fo=Pe(Vn)||"",kt=fo?`/api/sites/${encodeURIComponent(fo)}/pages`:null,Ir=fo?`/api/sites/${encodeURIComponent(fo)}/collections`:null,$r={active:`clower:activePage:${zn}`},_o=(e,t,s,r,i,l=[],m={})=>{let C={id:e,label:t,type:s,status:r,description:i,props:l,settings:{...m}};return C.settings.collectionId&&(C.collectionId=C.settings.collectionId),C},On={hero:{type:"Hero",label:"Hero de page",description:"Section pleine largeur avec CTA principal.",status:"Brouillon",props:[{label:"CTA",value:"D\xE9couvrir"},{label:"Hauteur",value:"80vh"}],settings:{title:"Titre du hero",subtitle:"",ctaLabel:"D\xE9couvrir",ctaUrl:"#",image:"",align:"center"}},paragraph:{type:"Paragraphe",label:"Bloc \xE9ditorial",description:"Paragraphe libre pour raconter votre histoire.",status:"Brouillon",props:[{label:"Longueur",value:"150 mots"}],settings:{title:"Titre du paragraphe",content:"",align:"left"}},image:{type:"Image",label:"Bloc image",description:"Visuel seul avec l\xE9gende optionnelle.",status:"Brouillon",props:[{label:"Ratio",value:"16:9"},{label:"L\xE9gende",value:"Inactive"}],settings:{src:"",alt:"",showCaption:!1,caption:""}},group:{type:"Groupe",label:"Groupe de sections",description:"Conteneur pour imbriquer plusieurs sous-blocs.",status:"Brouillon",props:[{label:"Disposition",value:"Verticale"}],settings:{layout:"grid",columnsMobile:"1",columnsDesktop:"3",mobileLayout:"stack"}},collectiongrid:{type:"CollectionGrid",label:"Grille de contenus",description:"Affiche automatiquement les items d\u2019une collection.",status:"Brouillon",settings:{collectionId:"",limit:6,mobileLayout:"stack"}},form:{type:"Form",label:"Formulaire de contact",description:"Formulaire avec envoi vers un service externe.",status:"Brouillon",settings:{formTitle:"Contactez-nous",actionUrl:"",method:"POST",serviceName:"",submitLabel:"Envoyer",successMessage:"Merci pour votre message !"}},newsletterembed:{type:"NewsletterEmbed",label:"Newsletter / Embed",description:"Int\xE9gration d'un formulaire newsletter externe (Brevo, Mailchimp\u2026).",status:"Brouillon",settings:{title:"Restez inform\xE9",serviceName:"",embedCode:""}}},Jn=e=>{try{window.localStorage.setItem($r.active,e)}catch{}},Wn=e=>{var t;try{let s=window.localStorage.getItem($r.active);if(s&&e.some(r=>r.id===s))return s}catch{}return((t=e[0])==null?void 0:t.id)||null},Gn=e=>!e||e<=0?"0 bloc":e===1?"1 bloc":`${e} blocs`,Br=e=>{if(!e||e==="/")return"/";let t=Xt(e.replace(/^\//,""));return t?`/${t}`:"/"},Yo=(e="page",t="block")=>`${e}-${t}-${Date.now().toString(36)}-${Math.floor(Math.random()*1e3)}`,Ia=(e,t)=>[_o(Yo(e,"intro"),"Introduction","Paragraphe","Brouillon",`Paragraphe introductif pour "${t}".`,[{label:"Longueur",value:"2 paragraphes"}],{title:`Introduction \xE0 ${t}`,content:"Ajoutez votre premier paragraphe de pr\xE9sentation.",align:"left"}),_o(Yo(e,"content"),"Zone de contenu","Groupe","Brouillon","Section principale \xE0 composer avec textes et visuels.",[{label:"Colonnes",value:"Auto"}],{layout:"grid",columnsMobile:"1",columnsDesktop:"2",mobileLayout:"stack"})],Pr=e=>{n&&(n.textContent=(e==null?void 0:e.name)||(e==null?void 0:e.title)||"Page"),c&&(c.textContent=(e==null?void 0:e.slug)||"/")},Zn=e=>{if(!f)return;f.innerHTML="",(e&&e.badges&&e.badges.length>0?e.badges:["Structure en cours"]).forEach(s=>{let r=document.createElement("span");r.className="rounded-full bg-slate-100 px-3 py-1",r.textContent=s,f.appendChild(r)})},Kn=e=>{switch((e||"").toLowerCase()){case"en ligne":return"bg-emerald-50 text-emerald-700";case"brouillon":return"bg-amber-50 text-amber-700";default:return"bg-slate-100 text-slate-600"}},po=e=>{if(!(!xe||!Re)){if(!e){xe.classList.remove("hidden"),Re.classList.add("hidden"),B==null||B.classList.add("hidden"),h==null||h.classList.add("hidden"),Me==null||Me.classList.add("hidden");return}xe.classList.add("hidden"),Re.classList.remove("hidden"),Me&&(e.status?(Me.textContent=e.status,Me.className=`rounded-full px-3 py-1 text-xs font-semibold ${Kn(e.status)}`,Me.classList.remove("hidden")):Me.classList.add("hidden")),Ds(e)}},_n=()=>{let e=getComputedStyle(document.documentElement).getPropertyValue("--color-accent");return e?e.trim():"#9C6BFF"},Vs=e=>{if(!p)return;let t=p.contentDocument;if(!t)return;if(t.querySelectorAll("[data-preview-block]").forEach(r=>{r.dataset.previewBlock===e?(r.classList.add("preview-block-active"),sr&&e&&r.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})):r.classList.remove("preview-block-active")}),S){let r=_n();S.style.borderColor=e?r:"transparent",S.style.opacity=e?"0.5":"0"}},jr={desktop:{width:"100%",height:"640px",maxWidth:"",margin:"0"},mobile:{width:"375px",height:"780px",maxWidth:"375px",margin:"0 auto"}},Mr=e=>{let t=jr[e]?e:"desktop";H.forEach(r=>{let i=r.dataset.previewView===t;r.setAttribute("aria-pressed",i?"true":"false"),i?(r.classList.add("bg-slate-900","text-white"),r.classList.remove("bg-slate-200","text-slate-500")):(r.classList.remove("bg-slate-900","text-white"),r.classList.add("bg-slate-200","text-slate-500"))});let s=jr[t];p&&(p.style.width=s.width,p.style.height=s.height,p.style.maxWidth=s.maxWidth,p.style.margin=s.margin),v&&(v.style.width="100%",v.style.minHeight=s.height,v.style.maxWidth=s.maxWidth||"100%"),V&&(V.dataset.previewShellView=t),W&&(W.textContent=t==="mobile"?"Vue mobile":"Vue bureau")},Fr=(e,t=!1,s=null)=>{var lr;let r=e.id===Ye,i=(e.type||"").toLowerCase(),l=i==="groupe"||i==="group"||i==="sections"||i==="grid",m=document.createElement("div");m.dataset.blockItem="true",m.dataset.blockId=e.id,s&&(m.dataset.parentBlockId=s),l&&(m.dataset.isGroup="true"),m.setAttribute("role","option"),m.setAttribute("aria-selected",r?"true":"false"),m.setAttribute("draggable","true"),m.tabIndex=0,m.className=["relative flex items-center gap-3 rounded-2xl border px-3 py-2 text-left transition group",t?"ml-6 border-dashed":"",r?"bg-slate-100 border-[#9C6BFF]/40 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let C=document.createElement("span");C.className=`absolute inset-y-2 left-0 w-1 rounded-full bg-[#9C6BFF] ${r?"":"hidden"}`,m.appendChild(C);let z=document.createElement("div");z.className="flex flex-1 items-center gap-3";let ne=document.createElement("div");ne.className="hidden lg:flex cursor-grab active:cursor-grabbing flex-shrink-0 items-center text-lg text-slate-400 hover:text-slate-600 transition-colors select-none",ne.innerHTML="\u22EE\u22EE",ne.setAttribute("title","Glisser pour r\xE9ordonner"),z.appendChild(ne);let ae=document.createElement("div");ae.className="flex-1";let ve=document.createElement("div");ve.className="flex items-center gap-2 text-[11px] uppercase tracking-wide text-slate-500";let Le=document.createElement("span");Le.className="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600",Le.textContent=e.type;let ie=document.createElement("span");if(ie.className="text-slate-400",ie.textContent=e.status,ve.appendChild(Le),l){let ft=(e.children||[]).length,us=document.createElement("span");us.className="rounded-full bg-violet-100 px-2 py-0.5 text-[10px] font-semibold text-violet-600",us.textContent=`${ft} \xE9l\xE9ment${ft!==1?"s":""}`,ve.appendChild(us)}ve.appendChild(ie);let A=document.createElement("p");A.className="mt-1 text-sm font-semibold text-slate-900";let nt=e.settings&&e.settings.title||e.label||"Bloc sans titre";if(A.textContent=nt,ae.appendChild(ve),ae.appendChild(A),i==="collectiongrid"&&e.collectionId){let ft=((lr=Nt.find(Ca=>Ca.id===e.collectionId))==null?void 0:lr.name)||e.collectionId,us=document.createElement("p");us.className="text-xs text-slate-400",us.textContent=`Collection : ${ft}`,ae.appendChild(us)}z.appendChild(ae),m.appendChild(z);let Be=document.createElement("div");Be.className="flex flex-col gap-1 text-xs text-slate-400";let ye=document.createElement("div");ye.className="flex items-center gap-1 lg:hidden";let Qe=document.createElement("button");Qe.type="button",Qe.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",Qe.textContent="\u2191",Qe.addEventListener("click",ft=>{ft.stopPropagation(),s?Ur(s,e.id,-1):zr(e.id,-1)});let bt=document.createElement("button");bt.type="button",bt.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",bt.textContent="\u2193",bt.addEventListener("click",ft=>{ft.stopPropagation(),s?Ur(s,e.id,1):zr(e.id,1)}),ye.appendChild(Qe),ye.appendChild(bt),Be.appendChild(ye);let Ve=document.createElement("button");return Ve.type="button",Ve.className="inline-flex items-center justify-center rounded-lg border border-transparent px-2 py-1 text-[12px] text-rose-500 hover:text-rose-700",Ve.innerHTML="\u{1F5D1}\uFE0F",Ve.addEventListener("click",ft=>{ft.stopPropagation(),s?ea(s,e.id):da(e.id)}),Be.appendChild(Ve),m.appendChild(Be),m.addEventListener("click",()=>{Ft(e.id,s)}),m.addEventListener("keydown",ft=>{(ft.key==="Enter"||ft.key===" ")&&(ft.preventDefault(),Ft(e.id,s))}),{item:m,isGroup:l,block:e}},Yn=e=>{let t=document.createElement("div");return t.dataset.groupDropZone=e.id,t.className="ml-6 border-2 border-dashed border-slate-200 rounded-xl p-3 text-center text-xs text-slate-400 hover:border-violet-300 hover:bg-violet-50/50 transition-colors cursor-pointer",t.innerHTML='<span class="pointer-events-none">\u{1F4E6} Glissez un bloc ici ou cliquez pour ajouter</span>',t.addEventListener("dragover",s=>{s.preventDefault(),s.stopPropagation(),t.classList.add("border-violet-400","bg-violet-50")}),t.addEventListener("dragleave",s=>{s.stopPropagation(),t.classList.remove("border-violet-400","bg-violet-50")}),t.addEventListener("drop",s=>{s.preventDefault(),s.stopPropagation(),t.classList.remove("border-violet-400","bg-violet-50");let r=s.dataTransfer.getData("text/plain");r&&r!==e.id&&Xn(r,e.id)}),t.addEventListener("click",()=>{sa(e.id)}),t},Ct=e=>{if(!I)return;I.innerHTML="";let t=(e==null?void 0:e.blocks)||[];if(ce&&(ce.textContent=Gn(t.length)),t.length===0){I.classList.add("hidden"),oe==null||oe.classList.remove("hidden");return}I.classList.remove("hidden"),oe==null||oe.classList.add("hidden"),t.forEach(s=>{let{item:r,isGroup:i}=Fr(s,!1,null);if(I.appendChild(r),i){(s.children||[]).forEach(C=>{let{item:z}=Fr(C,!0,s.id);I.appendChild(z)});let m=Yn(s);I.appendChild(m)}})},Qn=e=>{if(!u||!e)return null;for(let t=0;t<u.blocks.length;t++){let s=u.blocks[t],r=((s==null?void 0:s.type)||"").toLowerCase();if(!(r==="groupe"||r==="group"||r==="sections"||r==="grid")||!Array.isArray(s.children))continue;let l=s.children.findIndex(m=>m.id===e);if(l!==-1)return{groupId:s.id,groupIndex:t,childIndex:l}}return null},Nr=e=>{if(!u||!e)return null;let t=u.blocks.findIndex(l=>l.id===e);if(t!==-1){let[l]=u.blocks.splice(t,1);return{block:l,from:{type:"root",index:t}}}let s=Qn(e);if(!s)return null;let r=u.blocks.find(l=>l.id===s.groupId);if(!r||!Array.isArray(r.children))return null;let[i]=r.children.splice(s.childIndex,1);return{block:i,from:{type:"group",groupId:s.groupId,index:s.childIndex}}},go=(e,t)=>{if(!u||!e)return;let s=Math.min(Math.max(0,t!=null?t:u.blocks.length),u.blocks.length);u.blocks.splice(s,0,e)},ho=(e,t,s)=>{if(!u||!e||!t)return!1;let r=u.blocks.find(l=>l.id===t);if(!r)return!1;Array.isArray(r.children)||(r.children=[]);let i=Math.min(Math.max(0,s!=null?s:r.children.length),r.children.length);return r.children.splice(i,0,e),!0},Dr=(e,t,s=1)=>typeof e!="number"||e<0?null:t==="before"?e:e+s,yo=(e=null,t=null,s=null)=>{Ct(u),savePageBlocks(),e&&Ft(e,t),s&&M(s)},Xn=(e,t)=>{var l,m,C;if(!u||!e||!t||e===t)return;let s=u.blocks.find(z=>z.id===t);if(!s)return;let r=Nr(e);if(!(r!=null&&r.block))return;let i=(r.block.type||"").toLowerCase();if(i==="groupe"||i==="group"){M("Impossible d'imbriquer des groupes","error"),((l=r.from)==null?void 0:l.type)==="root"?go(r.block,r.from.index):((m=r.from)==null?void 0:m.type)==="group"&&ho(r.block,r.from.groupId,r.from.index);return}if(((C=r.from)==null?void 0:C.type)==="group"&&r.from.groupId===t){ho(r.block,r.from.groupId,r.from.index);return}Array.isArray(s.children)||(s.children=[]),s.children.push(r.block),yo(r.block.id,t,"Bloc ajout\xE9 au groupe")},ea=(e,t)=>{if(!u)return;let s=u.blocks.find(m=>m.id===e);if(!s||!s.children)return;let r=s.children.findIndex(m=>m.id===t);if(r===-1)return;let[i]=s.children.splice(r,1),l=u.blocks.findIndex(m=>m.id===e);u.blocks.splice(l+1,0,i),Ct(u),savePageBlocks(),M("Bloc sorti du groupe")},Qo=(e,t,s)=>{if(!u)return;let r=u.blocks.find(m=>m.id===e);if(!r||!Array.isArray(r.children))return;let i=r.children.findIndex(m=>m.id===t);if(i===-1)return;let[l]=r.children.splice(i,1);go(l,s),yo(l.id,null,"Bloc sorti du groupe")},ta=(e,t,s,r)=>{if(!u)return;let i=u.blocks.find(ae=>ae.id===e);if(!i||!Array.isArray(i.children))return;let l=i.children.findIndex(ae=>ae.id===t),m=i.children.findIndex(ae=>ae.id===s);if(l===-1||m===-1||t===s)return;let[C]=i.children.splice(l,1),z=l<m?m-1:m,ne=r==="before"?z:z+1;i.children.splice(ne,0,C),yo(C.id,e,null)},Hr=(e,t,s,r)=>{var z,ne,ae,ve;if(!u||!e||!t)return;let i=Nr(e);if(!(i!=null&&i.block))return;let l=(i.block.type||"").toLowerCase();if(l==="groupe"||l==="group"){M("Impossible d'imbriquer des groupes","error"),((z=i.from)==null?void 0:z.type)==="root"?go(i.block,i.from.index):((ne=i.from)==null?void 0:ne.type)==="group"&&ho(i.block,i.from.groupId,i.from.index);return}let m=u.blocks.find(Le=>Le.id===t);if(!m){((ae=i.from)==null?void 0:ae.type)==="root"?go(i.block,i.from.index):((ve=i.from)==null?void 0:ve.type)==="group"&&ho(i.block,i.from.groupId,i.from.index);return}Array.isArray(m.children)||(m.children=[]);let C=m.children.length;if(s){let Le=m.children.findIndex(A=>A.id===s),ie=Dr(Le,r,1);ie!==null&&(C=ie)}m.children.splice(C,0,i.block),yo(i.block.id,t,"Bloc ajout\xE9 au groupe")},Ur=(e,t,s)=>{if(!u)return;let r=u.blocks.find(C=>C.id===e);if(!r||!r.children)return;let i=r.children.findIndex(C=>C.id===t);if(i===-1)return;let l=i+s;if(l<0||l>=r.children.length)return;let[m]=r.children.splice(i,1);r.children.splice(l,0,m),Ct(u),savePageBlocks()},sa=e=>{Zt=e,openBlockPicker()},Zt=null,oa=e=>{!Lt||!e||(zs=e,Tr&&(Tr.textContent=e.title||e.id),Lt.classList.remove("hidden"),Lt.classList.add("flex"),qs(Lt,bo))},bo=()=>{Lt&&(Lt.classList.add("hidden"),Lt.classList.remove("flex"),zs=null,As(Lt))},ra=async()=>{if(!kt||!zs)return;let e=zs.id,t=zs.title||e;Jt&&(Jt.disabled=!0,Jt.textContent="Suppression...");try{let s=await fetch(`${kt}/${encodeURIComponent(e)}`,{method:"DELETE",credentials:"include"}),r=await s.json();if(!s.ok)throw new Error(r.message||"Erreur serveur");fe=fe.filter(i=>i.id!==e),He===e?fe.length>0?Tt(fe[0].id):(He=null,u=null,Kt(fe,null),Ct(null),xe==null||xe.classList.remove("hidden"),Re==null||Re.classList.add("hidden"),p&&(p.srcdoc=d())):Kt(fe,He),bo(),M(`Page "${t}" supprim\xE9e`)}catch(s){console.error("[pages] delete failed",s),M(s.message||"Erreur suppression")}finally{Jt&&(Jt.disabled=!1,Jt.textContent="Supprimer")}},Kt=(e,t)=>{o.forEach(s=>{s.innerHTML="",e.forEach(r=>{var ae;let i=document.createElement("li");i.className="flex items-center gap-1";let l=document.createElement("button");l.type="button",l.dataset.pageId=r.id,l.className=["flex-1 flex items-center gap-3 px-3 py-2 text-left transition",t===r.id?"bg-[#9C6BFF]/10 text-slate-900 border border-[#9C6BFF]/40 rounded-xl shadow-sm":"text-slate-700 hover:bg-slate-50 rounded-xl"].join(" "),t===r.id?l.setAttribute("aria-current","page"):l.removeAttribute("aria-current");let m=r.name||r.title,z=((ae=r.accessibility)==null?void 0:ae.showInMainNav)===!1?'<span class="text-[10px] font-semibold text-amber-600">Masqu\xE9 du menu</span>':"";l.innerHTML=`
            <span class="flex h-9 w-9 items-center justify-center rounded-xl border border-slate-200 bg-white text-slate-500">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M6.5 4.5h7l4 4v11a1 1 0 0 1-1 1h-10a1 1 0 0 1-1-1v-14a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
                <path d="M13.5 4.5v4a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.4"/>
              </svg>
            </span>
            <div class="flex flex-col">
              <span class="text-sm font-semibold">${m}</span>
              <span class="text-xs text-slate-500">${r.slug}</span>
              ${z}
            </div>
          `,l.addEventListener("click",()=>{Tt(r.id),Xo()||er()}),i.appendChild(l);let ne=document.createElement("button");ne.type="button",ne.className="flex-shrink-0 p-2 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition",ne.title="Supprimer cette page",ne.setAttribute("aria-label",`Supprimer ${m}`),ne.innerHTML=`
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14ZM10 11v6M14 11v6"/>
            </svg>
          `,ne.addEventListener("click",ve=>{ve.stopPropagation(),oa(r)}),i.appendChild(ne),s.appendChild(i)})})},ls=()=>{if(!u||!Array.isArray(u.blocks))return null;let e=u.blocks.find(t=>t.id===Ye);if(!e){for(let t of u.blocks)if(t.children&&(e=t.children.find(s=>s.id===Ye),e))break}return e||null},na=(e,t)=>{if(!e||!t)return!1;let s=r=>{for(let i of r||[])if(i&&(i.id===t||Array.isArray(i.children)&&s(i.children)))return!0;return!1};return s(e.blocks||[])},Rr=(e,t,s,r=null)=>{let i=!1,l=null,m=(z,ne=null)=>{let ae=!1;return{nodes:(z||[]).map(Le=>{if(!Le||!Le.id)return Le;if(Le.id===t&&(!r||r===ne))return i=!0,l=ne,ae=!0,s(Le);if(Array.isArray(Le.children)&&Le.children.length>0){let{nodes:ie,changed:A}=m(Le.children,Le.id);if(A)return ae=!0,{...Le,children:ie}}return Le}),changed:ae}};return{blocks:m(e,null).nodes,didUpdate:i,foundParentId:l}},cs=null,Ft=(e,t=null)=>{if(!u)return;if(!e){Ye=null,cs=null,Ct(u),po(null),Vs(null);return}let s=null;if(s=u.blocks.find(r=>r.id===e),!s&&t){let r=u.blocks.find(i=>i.id===t);r&&r.children&&(s=r.children.find(i=>i.id===e))}if(!s){for(let r of u.blocks)if(r.children){let i=r.children.find(l=>l.id===e);if(i){s=i,t=r.id;break}}}s||(s=u.blocks[0]||null,t=null),Ye=(s==null?void 0:s.id)||null,cs=t,Ct(u),po(s),Vs(Ye)},Ss=e=>{if(!u)return;let t={...u,blocks:e};ua(t)},vo=()=>window.matchMedia("(min-width: 1024px)").matches;function zr(e,t){if(!u||!e||!t)return;let s=[...u.blocks||[]],r=s.findIndex(m=>m.id===e);if(r<0)return;let i=r+t;if(i<0||i>=s.length)return;let[l]=s.splice(r,1);s.splice(i,0,l),Ss(s),Tt(u.id,{preserveBlock:!0}),Ft(l.id)}function $a(e,t){if(!u||!e||!t||e===t)return;let s=[...u.blocks||[]],r=s.findIndex(m=>m.id===e),i=s.findIndex(m=>m.id===t);if(r<0||i<0)return;let[l]=s.splice(r,1);s.splice(i,0,l),Ss(s),Tt(u.id,{preserveBlock:!0}),Ft(l.id)}function aa(e,t,s){if(!u||!e||!t||e===t)return;let r=[...u.blocks||[]],i=r.findIndex(z=>z.id===e),l=r.findIndex(z=>z.id===t);if(i<0||l<0)return;let[m]=r.splice(i,1);i<l&&l--;let C=s==="before"?l:l+1;r.splice(C,0,m),Ss(r),Tt(u.id,{preserveBlock:!0}),Ft(m.id)}function Vr(){if(!I)return;let e=vo();I.querySelectorAll("[data-block-item]").forEach(t=>{t.setAttribute("draggable",e?"true":"false")})}function Os(){pe&&(pe.classList.add("hidden"),Ls=!1,Zt=null)}function ia(){pe&&(pe.classList.remove("hidden"),Ls=!0)}function la(){Ls?Os():ia()}function ca(e){var l;if(!u||!e)return;let t=On[e];if(!t)return;let s=(u.blocks||[]).filter(m=>m.type===t.type).length+1,r=_o(Yo(u.id,e),`${t.label} ${s}`,t.type,t.status,t.description,t.props,t.settings||{});if((t.type||"").toLowerCase()==="collectiongrid"){let m=((l=Nt[0])==null?void 0:l.id)||"";r.collectionId=m,r.settings.collectionId=m,r.settings.limit=r.settings.limit||6}if(Zt){let m=u.blocks.find(C=>C.id===Zt);if(m){m.children||(m.children=[]),m.children.push(r),Zt=null,Ct(u),savePageBlocks(),Ft(r.id,m.id),Os(),M("Bloc ajout\xE9 au groupe");return}Zt=null}let i=[...u.blocks||[],r];Ss(i),Tt(u.id,{preserveBlock:!0}),Ft(r.id),Os(),M("Bloc ajout\xE9")}function Or(e){var r,i;if(!u)return;let t=(u.blocks||[]).filter(l=>l.id!==e),s=e===Ye?((r=t[0])==null?void 0:r.id)||null:Ye||((i=t[0])==null?void 0:i.id)||null;Ss(t),Ye=s,Tt(u.id,{preserveBlock:!0}),Ye?Ft(Ye):(po(null),Vs(null)),M("Bloc supprim\xE9")}function xo(){ge&&(ge.classList.add("hidden"),ge.classList.remove("flex"),So=null,As(ge))}function da(e){if(!ge){Or(e);return}So=e,ge.classList.remove("hidden"),ge.classList.add("flex"),qs(ge,xo)}let ua=e=>{if(!e)return;let t=ds(e);fe=fe.map(s=>s.id===t.id?t:s),u=t,rs(t)},Tt=(e,t={})=>{var i,l;let s=fe.find(m=>m.id===e)||fe[0]||null;u=s?ds(s):null,He=(s==null?void 0:s.id)||null,(!t.preserveBlock||!u||!na(u,Ye))&&(Ye=((l=(i=u==null?void 0:u.blocks)==null?void 0:i[0])==null?void 0:l.id)||null,cs=null),He&&Jn(He),Kt(fe,He),Pr(u),ir(),Zn(u),O(u),Ct(u),po(ls()),Vs(Ye),Vr(),Ls&&Os()},Xo=()=>window.matchMedia("(min-width: 1024px)").matches,Jr=()=>{Se&&(Xo()?(Se.classList.add("is-open"),ee==null||ee.classList.add("hidden"),document.body.classList.remove("overflow-hidden")):Se.classList.remove("is-open"))},ma=()=>{!Se||Xo()||(Se.classList.add("is-open"),ee==null||ee.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},er=()=>{Se&&(Se.classList.remove("is-open"),ee==null||ee.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))},fa=()=>{!De||!qe||(De.classList.remove("hidden"),qe.classList.add("hidden"),Ze&&(Ze.textContent=""),wo=!1,ot&&(ot.value="",ot.focus()),At&&(At.value=""),ht&&(ht.value=""))},Wr=()=>{!De||!qe||(De.classList.add("hidden"),qe.classList.remove("hidden"),Ze&&(Ze.textContent=""),wo=!1,De.reset())},pa=()=>{!ot||!ht||wo&&ht.value.trim().length>0||(ht.value=Br(ot.value))},fe=[],He=null,wo=!1,u=null,Ye=null,Ls=!1,So=null,tr="",sr=!1,Js=null,Nt=[],ga=e=>{let t={...e,props:Array.isArray(e.props)?e.props:[],settings:{...e.settings||{}}};return(t.type||"").toLowerCase()==="collectiongrid"&&(t.collectionId=t.collectionId||t.settings.collectionId||"",t.settings.collectionId=t.collectionId,t.settings.limit=t.settings.limit||6),t},ds=e=>{var t,s,r,i,l;return{...e,blocks:(e.blocks||[]).map(m=>ga(m)),seo:{title:(((t=e.seo)==null?void 0:t.title)||"").trim(),description:(((s=e.seo)==null?void 0:s.description)||"").trim(),indexed:typeof((r=e.seo)==null?void 0:r.indexed)=="boolean"?e.seo.indexed:null},accessibility:{showInMainNav:((i=e.accessibility)==null?void 0:i.showInMainNav)!==!1,mainLabel:(((l=e.accessibility)==null?void 0:l.mainLabel)||"").trim()}}},ha=async()=>{if(!Ir){Nt=[],Lo();return}try{let e=await fetch(Ir,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les collections.");let t=await e.json().catch(()=>[]);Nt=Array.isArray(t)?t:[];let s=(We==null?void 0:We.value)||"";Lo(s)}catch(e){console.error("[design] collections load",e),M("Collections indisponibles."),Nt=[],Lo()}},or=e=>{if(!zt)return;if(!e){zt.textContent=Nt.length?"S\xE9lectionnez une collection pour afficher ses informations.":"Aucune collection disponible. Ajoutez-en depuis l\u2019onglet Contenus.";return}let t=Nt.find(r=>r.id===e);if(!t){zt.textContent=`Collection ${e}`;return}let s=[];t.description&&s.push(t.description),t.type&&s.push(`Type\xA0: ${t.type}`),zt.textContent=s.join(" \xB7 ")||`Collection ${t.name||t.id}`},Lo=(e="")=>{if(We){if(We.innerHTML="",!Nt.length){We.disabled=!0;let t=document.createElement("option");t.value="",t.textContent="Aucune collection disponible",We.appendChild(t),or("");return}if(We.disabled=!1,e&&!Nt.some(t=>t.id===e)){let t=document.createElement("option");t.value=e,t.textContent=e,We.appendChild(t)}Nt.forEach(t=>{let s=document.createElement("option");s.value=t.id;let r=t.name||t.id;s.textContent=t.type?`${r} \xB7 ${t.type}`:r,s.dataset.description=t.description||"",We.appendChild(s)}),e&&(We.value=e),or(We.value||"")}};ha(),Jr(),je.forEach(e=>{e.addEventListener("click",ma)}),st.forEach(e=>{e.addEventListener("click",er)}),ee==null||ee.addEventListener("click",er),window.addEventListener("resize",()=>{Jr(),Vr()}),qe==null||qe.addEventListener("click",fa),ys==null||ys.addEventListener("click",Wr),ot==null||ot.addEventListener("input",pa),ht==null||ht.addEventListener("input",()=>{Ze&&(Ze.textContent=""),wo=!0}),De==null||De.addEventListener("submit",async e=>{if(e.preventDefault(),!kt){Ze&&(Ze.textContent="Aucun site s\xE9lectionn\xE9.");return}if(!ot||!ht)return;let t=ot.value.trim(),s=(At==null?void 0:At.value.trim())||t,r=Br(ht.value.trim()||t);if(!t||!r){Ze&&(Ze.textContent="Nom et slug sont requis.");return}Ze&&(Ze.textContent=""),Vt&&(Vt.disabled=!0,Vt.textContent="Cr\xE9ation...");try{let i=await Oo({name:t,title:s,slug:r});if(!i||!i.id)throw new Error("R\xE9ponse invalide.");fe=[...fe,ds(i)],Wr(),M("Page cr\xE9\xE9e"),Tt(i.id)}catch(i){console.error("[design] create page failed",i),Ze&&(Ze.textContent=i.message||"Impossible de cr\xE9er la page.")}finally{Vt&&(Vt.disabled=!1,Vt.textContent="Cr\xE9er")}});let rr=()=>{yt&&(yt.value=""),Mt&&(Mt.classList.add("hidden"),Mt.textContent="")},Gr=()=>{if(!yt)return null;let e=yt.value.trim();if(!e)return Mt&&Mt.classList.add("hidden"),null;try{let t=JSON.parse(e);return Mt&&Mt.classList.add("hidden"),t}catch(t){return Mt&&(Mt.classList.remove("hidden"),Mt.textContent=`\u274C JSON invalide : ${t.message}`),null}},ya=()=>{if(!yt)return;let e=yt.value.trim();if(e)try{let t=JSON.parse(e);yt.value=JSON.stringify(t,null,2),Gr()}catch{}},Ws=()=>{if(rt)if(is==="upload")rt.disabled=Ot.length===0;else if(is==="paste"){let e=Gr();rt.disabled=!e}else rt.disabled=!0},ba=()=>{lt&&(lt.classList.remove("hidden"),lt.classList.add("flex"),Ot=[],is="upload",ar(),rr(),Ke&&Ke.classList.add("hidden"),_e&&(_e.innerHTML=""),Ws(),ws.forEach(e=>{e.dataset.importTab==="upload"?(e.classList.add("bg-[#9C6BFF]","text-white"),e.classList.remove("border","border-slate-200","text-slate-700")):(e.classList.remove("bg-[#9C6BFF]","text-white"),e.classList.add("border","border-slate-200","text-slate-700"))}),Rs.forEach(e=>{e.dataset.importPanel==="upload"?e.classList.remove("hidden"):e.classList.add("hidden")}),qs(lt,nr))},nr=()=>{lt&&(lt.classList.add("hidden"),lt.classList.remove("flex"),Ot=[],rr(),As(lt))},ar=()=>{if(!(!xs||!Us)){if(Ot.length===0){xs.classList.add("hidden"),Ws();return}xs.classList.remove("hidden"),Us.innerHTML=Ot.map(e=>`<li class="flex items-center gap-2"><span class="text-lg">\u{1F4C4}</span>${e.name}</li>`).join(""),Ws()}},Zr=e=>{let t=Array.from(e).filter(s=>s.type==="application/json"||s.name.endsWith(".json"));if(t.length===0){M("Aucun fichier JSON valide.");return}Ot=t,ar()},va=async()=>{var s,r,i,l,m,C,z,ne,ae,ve,Le;if(!kt)return;let e=[];if(console.log("[import] activeImportTab:",is),is==="paste"){let ie=(s=yt==null?void 0:yt.value)==null?void 0:s.trim();if(console.log("[import] paste text length:",ie==null?void 0:ie.length),!ie){M("Aucun JSON \xE0 importer."),Ke&&_e&&(Ke.classList.remove("hidden"),_e.innerHTML='<p class="text-amber-600">\u26A0 Le champ de texte est vide.</p>');return}try{let A=JSON.parse(ie);console.log("[import] parsed JSON:",A),console.log("[import] parsed type:",typeof A,Array.isArray(A)?"array":"not array"),A&&!Array.isArray(A)&&A.pages?(console.log("[import] detected pages+collections format"),e=A):Array.isArray(A)?e.push(...A):e.push(A),console.log("[import] pagesData prepared:",e)}catch(A){let nt=A.message.match(/position (\d+)/),Be=A.message;if(nt){let ye=parseInt(nt[1],10),Qe=ie.substring(0,ye).split(`
`),bt=Qe.length,Ve=Qe[Qe.length-1].length+1;Be=`Ligne ${bt}, colonne ${Ve}: ${A.message}`}M(`Erreur JSON : ${Be}`,"error"),console.error("[import] paste parse error",A),Ke&&_e&&(Ke.classList.remove("hidden"),_e.innerHTML=`
              <div class="text-rose-600">
                <p class="font-medium">\u2717 Erreur de syntaxe JSON</p>
                <p class="text-xs mt-1">${Be}</p>
                <p class="text-xs mt-2 text-slate-500">V\xE9rifiez les virgules, guillemets et accolades.</p>
              </div>
            `);return}}else if(is==="upload"){if(Ot.length===0)return;let ie=[];for(let A of Ot){let nt=await A.text();try{let Be=JSON.parse(nt);Array.isArray(Be)?e.push(...Be):e.push(Be)}catch(Be){let ye=Be.message.match(/position (\d+)/),Qe=Be.message;if(ye){let bt=parseInt(ye[1],10);Qe=`Ligne ${nt.substring(0,bt).split(`
`).length}: ${Be.message}`}ie.push({file:A.name,error:Qe}),console.error("[import] parse error",A.name,Be)}}if(ie.length>0){if(Ke&&_e){Ke.classList.remove("hidden");let A='<div class="text-rose-600"><p class="font-medium">\u2717 Erreurs de syntaxe JSON</p><ul class="ml-4 text-xs mt-1">';ie.forEach(nt=>{A+=`<li><strong>${nt.file}</strong>: ${nt.error}</li>`}),A+="</ul></div>",e.length>0&&(A+=`<p class="text-amber-600 mt-2 text-sm">\u26A0 ${e.length} page(s) valide(s) seront import\xE9e(s)</p>`),_e.innerHTML=A}if(e.length===0){M("Tous les fichiers contiennent des erreurs JSON","error");return}}}else return;let t=Array.isArray(e)?e.length>0:e&&(((r=e.pages)==null?void 0:r.length)>0||e.title);if(console.log("[import] hasData check:",t,"pagesData:",e),!t){M("Aucune page valide \xE0 importer."),Ke&&_e&&(Ke.classList.remove("hidden"),_e.innerHTML=`
            <div class="text-amber-600">
              <p class="font-medium">\u26A0 Aucune page d\xE9tect\xE9e</p>
              <p class="text-xs mt-1">Le JSON doit contenir :</p>
              <ul class="text-xs ml-4 mt-1 list-disc">
                <li>Un objet page avec "title" : <code>{"title": "Ma page", ...}</code></li>
                <li>Un tableau de pages : <code>[{"title": "Page 1"}, {"title": "Page 2"}]</code></li>
                <li>Ou un objet combin\xE9 : <code>{"pages": [...], "collections": {...}}</code></li>
              </ul>
            </div>
          `);return}rt&&(rt.disabled=!0,rt.textContent="Import..."),console.log("[import] Sending to server:",JSON.stringify(e).substring(0,500));try{let ie=await fetch(`${kt}/import`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(e)});console.log("[import] Server response status:",ie.status);let A=await ie.json();if(console.log("[import] Server response body:",A),!ie.ok)throw Ke&&_e&&(Ke.classList.remove("hidden"),_e.innerHTML=`
              <div class="text-rose-600">
                <p class="font-medium">\u2717 Erreur serveur</p>
                <p class="text-xs mt-1">${A.message||"Erreur inconnue"}</p>
                ${A.details?`<p class="text-xs mt-1 text-slate-500">${A.details}</p>`:""}
              </div>
            `),new Error(A.message||"Erreur serveur");if(Ke&&_e){Ke.classList.remove("hidden");let ye="",Qe=((i=A.imported)==null?void 0:i.length)>0||((l=A.collectionsCreated)==null?void 0:l.length)>0,bt=((m=A.errors)==null?void 0:m.length)>0;Qe&&!bt?ye+='<div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-2"><p class="text-green-800 font-medium">\u2713 Import r\xE9ussi</p></div>':Qe&&bt?ye+='<div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-2"><p class="text-amber-800 font-medium">\u26A0 Import partiel</p></div>':bt&&(ye+='<div class="bg-rose-50 border border-rose-200 rounded-lg p-3 mb-2"><p class="text-rose-800 font-medium">\u2717 Import \xE9chou\xE9</p></div>'),A.collectionsCreated&&A.collectionsCreated.length>0&&(ye+=`<p class="text-violet-700 mt-2">\u2713 ${A.collectionsCreated.length} collection(s) cr\xE9\xE9e(s)</p>`,ye+='<ul class="ml-4 text-xs text-slate-600">',A.collectionsCreated.forEach(Ve=>{ye+=`<li>${Ve.name} (${Ve.itemsCount} item${Ve.itemsCount>1?"s":""})</li>`}),ye+="</ul>"),A.imported&&A.imported.length>0&&(ye+=`<p class="text-green-700 mt-2">\u2713 ${A.imported.length} page(s) import\xE9e(s)</p>`,ye+='<ul class="ml-4 text-xs text-slate-600">',A.imported.forEach(Ve=>{ye+=`<li><strong>${Ve.title}</strong> \u2192 ${Ve.slug} (${Ve.action==="updated"?"mise \xE0 jour":"cr\xE9\xE9e"})</li>`}),ye+="</ul>"),A.errors&&A.errors.length>0&&(ye+=`<p class="text-rose-600 mt-3 font-medium">\u2717 ${A.errors.length} erreur(s)</p>`,ye+='<ul class="ml-4 text-xs text-rose-600 space-y-1 mt-1">',A.errors.forEach(Ve=>{ye+=`<li class="bg-rose-50 p-2 rounded"><strong>${Ve.title}</strong><br/><span class="text-rose-500">${Ve.error}</span></li>`}),ye+="</ul>"),_e.innerHTML=ye}let nt=((C=A.imported)==null?void 0:C.length)>0||((z=A.collectionsCreated)==null?void 0:z.length)>0,Be=((ne=A.errors)==null?void 0:ne.length)>0;if(A.imported&&A.imported.length>0&&(fe=await Ns(),Kt(fe,He),fe.length>0&&!He&&Tt(fe[0].id)),nt&&!Be){let ye=(ae=A.collectionsCreated)!=null&&ae.length?` + ${A.collectionsCreated.length} collection(s)`:"";M(`\u2713 Import r\xE9ussi : ${((ve=A.imported)==null?void 0:ve.length)||0} page(s)${ye}`,"success")}else nt&&Be?M(`\u26A0 Import partiel : ${((Le=A.imported)==null?void 0:Le.length)||0} page(s), ${A.errors.length} erreur(s)`,"warning"):Be&&M(`\u2717 Import \xE9chou\xE9 : ${A.errors.length} erreur(s)`,"error");Ot=[],ar(),rr()}catch(ie){console.error("[import] failed",ie),M(ie.message||"Erreur import","error")}finally{rt&&(rt.disabled=!1,rt.textContent="Importer")}};bs==null||bs.addEventListener("click",ba),Hs.forEach(e=>e.addEventListener("click",nr)),lt==null||lt.addEventListener("click",e=>{e.target===lt&&nr()}),vs==null||vs.addEventListener("change",e=>{Zr(e.target.files)}),ct==null||ct.addEventListener("dragover",e=>{e.preventDefault(),ct.classList.add("border-[#9C6BFF]","bg-[#9C6BFF]/10")}),ct==null||ct.addEventListener("dragleave",e=>{e.preventDefault(),ct.classList.remove("border-[#9C6BFF]","bg-[#9C6BFF]/10")}),ct==null||ct.addEventListener("drop",e=>{e.preventDefault(),ct.classList.remove("border-[#9C6BFF]","bg-[#9C6BFF]/10"),Zr(e.dataTransfer.files)}),rt==null||rt.addEventListener("click",va),yt==null||yt.addEventListener("input",()=>{Ws()}),Zo==null||Zo.addEventListener("click",ya),ws.forEach(e=>{e.addEventListener("click",()=>{let t=e.dataset.importTab;is=t,ws.forEach(s=>{s.dataset.importTab===t?(s.classList.add("bg-[#9C6BFF]","text-white"),s.classList.remove("border","border-slate-200","text-slate-700")):(s.classList.remove("bg-[#9C6BFF]","text-white"),s.classList.add("border","border-slate-200","text-slate-700"))}),Rs.forEach(s=>{s.dataset.importPanel===t?s.classList.remove("hidden"):s.classList.add("hidden")}),Ws()})}),Go==null||Go.addEventListener("click",async()=>{if(!qr)return;let e=qr.textContent||"";try{await navigator.clipboard.writeText(e),M("Template copi\xE9 !")}catch(t){console.error("[import] copy failed",t),M("Erreur copie")}}),Wo==null||Wo.addEventListener("click",async()=>{if(!Ar)return;let e=Ar.textContent||"";try{await navigator.clipboard.writeText(e),M("Prompt copi\xE9 !")}catch(t){console.error("[import] copy prompt failed",t),M("Erreur copie")}}),Ko==null||Ko.addEventListener("click",bo),Jt==null||Jt.addEventListener("click",ra),Lt==null||Lt.addEventListener("click",e=>{e.target===Lt&&bo()}),be==null||be.addEventListener("click",e=>{if(e.stopPropagation(),!Ls){let t=ls(),s=((t==null?void 0:t.type)||"").toLowerCase();s==="groupe"||s==="group"?Zt=t.id:Zt=null}la()}),document.addEventListener("click",e=>{Ls&&(pe!=null&&pe.contains(e.target)||be!=null&&be.contains(e.target)||Os())}),Ce.forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();let s=e.dataset.blockAdd;ca(s)})}),Ue==null||Ue.addEventListener("click",()=>{xo()}),Ne==null||Ne.addEventListener("click",()=>{So&&Or(So),xo()}),ge==null||ge.addEventListener("click",e=>{e.target===ge&&xo()}),h==null||h.addEventListener("input",e=>{var r,i,l,m;let t=e.target;if(!t||!t.name)return;if(t.name==="group-columns-mobile"||t.name==="group-columns-desktop"){let C=((r=h.querySelector('[name="group-columns-mobile"]'))==null?void 0:r.value)||"1",z=((i=h.querySelector('[name="group-columns-desktop"]'))==null?void 0:i.value)||"3";mo(C,z)}if(t.name==="collection-columns-mobile"||t.name==="collection-columns-desktop"){let C=((l=h.querySelector('[name="collection-columns-mobile"]'))==null?void 0:l.value)||"1",z=((m=h.querySelector('[name="collection-columns-desktop"]'))==null?void 0:m.value)||"3";Fs(C,z)}let s=t.closest("[data-block-panel]");if(s&&s.dataset.blockPanel==="appearance"){let C=ls(),z=ns(C);if(C&&z){let ne=as(z);me(C.id,ne)}}}),h==null||h.addEventListener("change",e=>{var r,i;let t=e.target;if(!t||!t.name)return;if(t.hasAttribute("data-color-select")){let l=t.options[t.selectedIndex],m=((r=l==null?void 0:l.dataset)==null?void 0:r.color)||"#ffffff",C=(i=t.closest(".relative"))==null?void 0:i.querySelector("[data-color-preview]");C&&(m==="transparent"?C.style.background=es:C.style.background=m)}let s=t.closest("[data-block-panel]");if(s&&s.dataset.blockPanel==="appearance"){let l=ls(),m=ns(l);if(l&&m){let C=as(m);me(l.id,C)}}}),We==null||We.addEventListener("change",e=>{let t=e.target;or((t==null?void 0:t.value)||"")}),h==null||h.addEventListener("submit",we),os==null||os.addEventListener("click",e=>{e.preventDefault();let t=ls();t&&Ds(t)}),H.length>0&&(H.forEach(e=>{e.addEventListener("click",()=>{let t=e.dataset.previewView||"desktop";Mr(t)})}),Mr("desktop")),p==null||p.addEventListener("load",()=>{var r;sr=!0,qt("\xC0 jour"),Vs(Ye);let e=p==null?void 0:p.contentDocument;if(!e||!u||e.documentElement.dataset.rawditPreviewSelectBound==="true")return;if(e.documentElement.dataset.rawditPreviewSelectBound="true",!e.getElementById("rawdit-preview-select-style")){let i=e.createElement("style");i.id="rawdit-preview-select-style",i.textContent=`
	          [data-preview-block]{ cursor:pointer; }
	          [data-preview-block]:hover{ outline:2px solid var(--color-accent, #9C6BFF); outline-offset:2px; }
	        `,(r=e.head)==null||r.appendChild(i)}let t=i=>{let l=((i==null?void 0:i.type)||"").toLowerCase();return l==="groupe"||l==="group"||l==="sections"||l==="grid"},s=i=>{if(!u||!i||(u.blocks||[]).some(l=>l.id===i))return null;for(let l of u.blocks||[])if(!(!t(l)||!Array.isArray(l.children))&&l.children.some(m=>m.id===i))return l.id;return null};e.addEventListener("click",i=>{var ne,ae,ve;let l=i.target,m=(ne=l==null?void 0:l.closest)==null?void 0:ne.call(l,"[data-preview-block]"),C=((ae=m==null?void 0:m.getAttribute)==null?void 0:ae.call(m,"data-preview-block"))||"";if(!C)return;i.preventDefault(),i.stopPropagation(),(ve=i.stopImmediatePropagation)==null||ve.call(i);let z=s(C);Ft(C,z)},!0)}),se==null||se.addEventListener("click",()=>{let e=window.open("","_blank");if(!e)return;e.opener=null;let t=e.document;t.open(),t.write(tr||d()),t.close()});let Kr=e=>{var t,s,r;$&&(e?($.classList.remove("hidden"),u&&(U&&(U.value=((t=u.seo)==null?void 0:t.title)||""),k&&(k.value=((s=u.seo)==null?void 0:s.description)||""),L&&(L.checked=((r=u.seo)==null?void 0:r.indexed)!==!1))):$.classList.add("hidden"))},ko=(e,t="muted")=>{if(!w)return;let s=t==="success"?"text-emerald-600":t==="error"?"text-rose-600":"text-slate-500";w.textContent=e||"",w.className=`text-sm ${s}`};T==null||T.addEventListener("click",()=>{let e=$&&!$.classList.contains("hidden");Kr(!e)}),F==null||F.addEventListener("click",()=>Kr(!1)),P==null||P.addEventListener("submit",async e=>{var t;if(e.preventDefault(),!u){ko("Aucune page active.","error");return}q&&(q.disabled=!0),ko("");try{let s={title:((U==null?void 0:U.value)||"").trim(),description:((k==null?void 0:k.value)||"").trim(),indexed:(t=L==null?void 0:L.checked)!=null?t:!0},r={...u,seo:s},i=await rs(r);i&&(u=i,ko("SEO enregistr\xE9.","success"),M("SEO mis \xE0 jour"),O(u))}catch(s){console.error("[seo] save failed",s),ko(s.message||"Erreur lors de la sauvegarde.","error")}finally{q&&(q.disabled=!1)}});let ir=()=>{var e,t;if(!(!Q&&!ke)){if(!u){Q&&(Q.checked=!0),ke&&(ke.value="");return}Q&&(Q.checked=((e=u.accessibility)==null?void 0:e.showInMainNav)!==!1),ke&&(ke.value=((t=u.accessibility)==null?void 0:t.mainLabel)||"")}},_r=e=>{D&&(e?(ir(),D.classList.remove("hidden")):D.classList.add("hidden"))},Co=(e,t="muted")=>{if(!Te)return;let s=t==="success"?"text-emerald-600":t==="error"?"text-rose-600":"text-slate-500";Te.textContent=e||"",Te.className=`text-sm ${s}`};E==null||E.addEventListener("click",()=>{let e=D&&!D.classList.contains("hidden");_r(!e)}),K==null||K.addEventListener("click",()=>_r(!1)),te==null||te.addEventListener("submit",async e=>{var t;if(e.preventDefault(),!u){Co("Aucune page active.","error");return}Ge&&(Ge.disabled=!0),Co("");try{let s={showInMainNav:(t=Q==null?void 0:Q.checked)!=null?t:!0,mainLabel:((ke==null?void 0:ke.value)||"").trim()},r={...u,accessibility:s},i=await rs(r);i&&(u=i,ir(),Co("Accessibilit\xE9 enregistr\xE9e.","success"),M("Accessibilit\xE9 mise \xE0 jour"),Kt(fe,He),O(u))}catch(s){console.error("[accessibility] save failed",s),Co(s.message||"Erreur lors de la sauvegarde.","error")}finally{Ge&&(Ge.disabled=!1)}});let Yr=e=>{G&&(e?(G.classList.remove("hidden"),u&&(N&&(N.value=u.name||""),x&&(x.value=u.title||""),X&&(X.value=u.slug||""),J&&(J.value=u.description||""))):G.classList.add("hidden"))},ks=(e,t="muted")=>{if(!g)return;let s=t==="success"?"text-emerald-600":t==="error"?"text-rose-600":"text-slate-500";g.textContent=e||"",g.className=`text-sm ${s}`};Ee==null||Ee.addEventListener("click",()=>{let e=G&&!G.classList.contains("hidden");Yr(!e)}),Ie==null||Ie.addEventListener("click",()=>Yr(!1)),$e==null||$e.addEventListener("submit",async e=>{if(e.preventDefault(),!u){ks("Aucune page active.","error");return}R&&(R.disabled=!0),ks("");try{let t=((N==null?void 0:N.value)||"").trim(),s=((x==null?void 0:x.value)||"").trim(),r=((X==null?void 0:X.value)||"").trim(),i=((J==null?void 0:J.value)||"").trim();if(!s){ks("Le titre est requis.","error"),R&&(R.disabled=!1);return}if(!r||!r.startsWith("/")){ks("Le slug doit commencer par /.","error"),R&&(R.disabled=!1);return}let l={...u,name:t||s,title:s,slug:r,description:i},m=await rs(l);m&&(u=m,fe=fe.map(C=>C.id===m.id?m:C),ks("Propri\xE9t\xE9s enregistr\xE9es.","success"),M("Page mise \xE0 jour"),Pr(u),Kt(fe,He),O(u))}catch(t){console.error("[page-props] save failed",t),ks(t.message||"Erreur lors de la sauvegarde.","error")}finally{R&&(R.disabled=!1)}});let xa=e=>{let t=e.target.closest("[data-block-item]");if(!t||!vo()){e.preventDefault();return}if(Dt=t.dataset.blockId||null,Gs=t.dataset.parentBlockId||null,!Dt){e.preventDefault();return}e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",Dt),e.dataTransfer.setData("application/x-rawdit-parent",Gs||""),requestAnimationFrame(()=>{t.classList.add("opacity-50","scale-[0.98]","shadow-lg","ring-2","ring-[#9C6BFF]")})},Qr=()=>{I==null||I.querySelectorAll("[data-block-item]").forEach(e=>{e.classList.remove("opacity-50","scale-[0.98]","shadow-lg","ring-2","ring-[#9C6BFF]","border-t-4","border-b-4","border-t-[#9C6BFF]","border-b-[#9C6BFF]","pt-6","pb-6")})},wa=()=>{Dt=null,Gs=null,Qr()},Sa=e=>{if(!Dt||!vo())return;let t=e.target.closest("[data-block-item]");if(!t||t.dataset.blockId===Dt)return;e.preventDefault(),e.dataTransfer.dropEffect="move";let s=t.getBoundingClientRect(),r=s.top+s.height/2,i=e.clientY<r;I==null||I.querySelectorAll("[data-block-item]").forEach(l=>{l!==t&&l.dataset.blockId!==Dt&&l.classList.remove("border-t-4","border-b-4","border-t-[#9C6BFF]","border-b-[#9C6BFF]","pt-6","pb-6")}),t.classList.remove("border-t-4","border-b-4","border-t-[#9C6BFF]","border-b-[#9C6BFF]","pt-6","pb-6"),i?t.classList.add("border-t-4","border-t-[#9C6BFF]","pt-6"):t.classList.add("border-b-4","border-b-[#9C6BFF]","pb-6"),t.dataset.dropPosition=i?"before":"after"},La=e=>{let t=e.target.closest("[data-block-item]");if(!t)return;let s=e.relatedTarget;s&&t.contains(s)||(t.classList.remove("border-t-4","border-b-4","border-t-[#9C6BFF]","border-b-[#9C6BFF]","pt-6","pb-6"),delete t.dataset.dropPosition)},ka=e=>{if(!Dt||!vo())return;e.preventDefault();let t=e.target.closest("[data-block-item]"),s=Dt,r=Gs,i=(t==null?void 0:t.dataset.dropPosition)||"after";Dt=null,Gs=null,Qr();let l=(t==null?void 0:t.dataset.blockId)||null;if(!u||!s)return;if(!l){r&&Qo(r,s,u.blocks.length);return}if(s===l)return;let m=(t==null?void 0:t.dataset.parentBlockId)||null;if(r){if(m){if(m===r){ta(r,s,l,i);return}Hr(s,m,l,i);return}let C=u.blocks.findIndex(ne=>ne.id===l);if(C===-1){Qo(r,s,u.blocks.length);return}let z=Dr(C,i,1);Qo(r,s,z!=null?z:u.blocks.length);return}if(m){Hr(s,m,l,i);return}aa(s,l,i)},Dt=null,Gs=null;I==null||I.addEventListener("dragstart",xa),I==null||I.addEventListener("dragend",wa),I==null||I.addEventListener("dragover",Sa),I==null||I.addEventListener("dragleave",La),I==null||I.addEventListener("drop",ka),Jo(),document.addEventListener("ai-page-updated",async e=>{var t;console.log("[design] Rafra\xEEchissement d\xE9clench\xE9 par IA",e.detail);try{let s=await Ns();if(fe=(Array.isArray(s)?s:[]).map(r=>ds(r)),(t=e.detail)!=null&&t.pageId){let r=fe.find(i=>i.id===e.detail.pageId);r&&(u=r,He=r.id,O(u),Ct(u),M("Page mise \xE0 jour par l'IA"))}else if(He){let r=fe.find(i=>i.id===He);r&&(u=r,O(u),Ct(u))}}catch(s){console.error("[design] Erreur rafra\xEEchissement IA:",s)}})}function kn(){var Ds,as,qt;let o=document.querySelector("[data-collection-list]");if(!o)return;let n={empty:document.querySelector('[data-content-view="empty"]'),header:document.querySelector('[data-content-view="header"]'),collection:document.querySelector('[data-content-view="collection"]'),footer:document.querySelector('[data-content-view="footer"]')},c=document.querySelectorAll("[data-content-section]"),f=document.querySelectorAll("[data-content-section-trigger]"),p=document.querySelector("[data-header-status]"),v=document.querySelector("[data-footer-status]"),V=document.querySelector("[data-collection-count]"),H=document.querySelector("[data-item-panel]"),W=document.querySelectorAll("[data-item-panel-close]"),se=document.querySelector("[data-collection-empty]"),_=document.querySelector("[data-collection-items-empty]"),S=document.querySelector("[data-item-table-wrapper]"),T=document.querySelector("[data-item-table-body]"),$=document.querySelector("[data-collection-title]"),F=document.querySelector("[data-collection-description]"),P=document.querySelector("[data-item-add]"),U=document.querySelector("[data-item-detail-empty]"),k=document.querySelector("[data-item-form]"),L=k?{title:k.querySelector('[name="item-title"]'),slug:k.querySelector('[name="item-slug"]'),excerpt:k.querySelector('[name="item-excerpt"]'),content:k.querySelector('[name="item-content"]'),image:k.querySelector('[name="item-image"]'),ctaText:k.querySelector('[name="item-cta-text"]'),ctaUrl:k.querySelector('[name="item-cta-url"]'),status:k.querySelector('[name="item-status"]')}:{},w=document.querySelector("[data-item-status-badge]"),q=document.querySelector("[data-item-delete]"),E=document.querySelector("[data-item-delete-modal]"),D=document.querySelector("[data-item-delete-cancel]"),K=document.querySelector("[data-item-delete-confirm]"),te=document.querySelector("[data-item-cancel]"),Q=document.querySelector("[data-item-save]"),ke="rounded-full px-3 py-1 text-xs font-semibold",Te=()=>window.matchMedia("(min-width: 1024px)").matches,Ge=a=>{if(!H||Te())return;let d=H.dataset.itemPanelHidden||"",y=H.dataset.itemPanelVisible||"";a?(Ht(H,y,"remove"),Ht(H,d,"add"),H.classList.add("pointer-events-none"),H.dataset.itemPanelOpen="false"):(Ht(H,d,"remove"),Ht(H,y,"add"),H.classList.remove("pointer-events-none"),H.dataset.itemPanelOpen="true")},Ee=()=>{if(H){if(Te()){let a=H.dataset.itemPanelHidden||"";Ht(H,a,"remove"),H.classList.remove("pointer-events-none"),H.dataset.itemPanelOpen="true";return}k!=null&&k.classList.contains("hidden")?Ge(!0):Ge(!1)}};window.addEventListener("resize",Ee),W.forEach(a=>{a.addEventListener("click",d=>{d.preventDefault(),!Te()&&Rt()})}),Ee();let G={logo:document.querySelector('[name="header-logo"]'),logoAlt:document.querySelector('[name="header-logo-alt"]'),logoUrl:document.querySelector('[name="header-logo-url"]'),ctaText:document.querySelector('[name="header-cta-text"]'),ctaUrl:document.querySelector('[name="header-cta-url"]'),ctaStyle:document.querySelector('[name="header-cta-style"]'),ctaTextColor:document.querySelector('[name="header-cta-text-color"]'),position:document.querySelector('[name="header-position"]'),bg:document.querySelector('[name="header-bg"]')},Ie=document.querySelector("[data-header-nav-order-list]"),$e=document.querySelector("[data-header-save]"),N=document.querySelector("[data-template-header-nav-item]"),x=document.querySelector("[data-header-pages-list]"),X=[],J=[],g={linkedin:document.querySelector('[name="footer-social-linkedin"]'),twitter:document.querySelector('[name="footer-social-twitter"]'),instagram:document.querySelector('[name="footer-social-instagram"]'),facebook:document.querySelector('[name="footer-social-facebook"]'),youtube:document.querySelector('[name="footer-social-youtube"]'),github:document.querySelector('[name="footer-social-github"]'),copyright:document.querySelector('[name="footer-copyright"]'),legalUrl:document.querySelector('[name="footer-legal-url"]'),privacyUrl:document.querySelector('[name="footer-privacy-url"]'),bg:document.querySelector('[name="footer-bg"]'),columnsCount:document.querySelector('[name="footer-columns-count"]')},R=document.querySelector("[data-footer-columns-list]"),I=document.querySelector("[data-footer-column-add]"),oe=document.querySelector("[data-footer-save]"),ce=document.querySelector("[data-template-footer-column]"),be=document.querySelector("[data-template-footer-link]"),pe=null,Ce={nav:[],logo:{},cta:{},style:{}},ge={columns:[],socials:{},copyright:"",legal:{},style:{}},Ne=Pe((Z==null?void 0:Z.slugValue)||re.slug||""),Ue=Ne,xe=Ne?`/api/sites/${encodeURIComponent(Ne)}/layout`:null,Me=a=>{Object.entries(n).forEach(([d,y])=>{y&&y.classList.toggle("hidden",d!==a)}),c.forEach(d=>{d.dataset.contentSection===a?d.dataset.active="true":delete d.dataset.active}),pe=a};c.forEach(a=>{a.addEventListener("click",()=>{let d=a.dataset.contentSection;(d==="header"||d==="footer")&&Me(d)})}),f.forEach(a=>{a.addEventListener("click",()=>{let d=a.dataset.contentSectionTrigger;d&&Me(d)})});let Re=async()=>{if(!(!Ue||!x))try{let a=await fetch(`/api/sites/${Ue}/pages`,{credentials:"include"});if(!a.ok)throw new Error("Erreur chargement pages");X=await a.json(),B()}catch(a){console.error("[header] load pages error",a),x.innerHTML='<p class="text-xs text-red-500">Erreur chargement pages</p>'}},St=a=>{let d=(a||"").toString().trim();if(!d||d==="/"||d==="index")return"/";let y=d.toLowerCase();if(d.startsWith("#")||y.startsWith("mailto:")||y.startsWith("tel:")||/^[a-z]+:\/\//i.test(d))return d;if(d.startsWith("//")){let Y=d.slice(2);if(Y.includes("."))return d;let ue=Y.replace(/^\/+/,"").replace(/\/+$/,"");return ue?`/${ue}`:"/"}let j=d.replace(/^\/+/,"").replace(/\/+$/,"");return j?`/${j}`:"/"},b=(a,d="")=>{let y=(a||"").toString().trim();return y?St(y):d},B=()=>{if(x){if(x.innerHTML="",X.length===0){x.innerHTML='<p class="text-xs text-slate-400 italic">Aucune page disponible</p>';return}X.forEach(a=>{let d=a.slug||a.id||"",y=a.name||a.title||d,j=St(d),Y=J.some(O=>O.url===j),ue=document.createElement("label");ue.className="flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer transition-colors",ue.innerHTML=`
          <input type="checkbox" name="nav-page" value="${j}" data-page-title="${y}"
                 class="w-4 h-4 rounded border-slate-300 text-violet-600 focus:ring-violet-500"
                 ${Y?"checked":""}>
          <span class="flex-1 text-sm text-slate-700">${y}</span>
          <span class="text-xs text-slate-400">${j}</span>
        `;let me=ue.querySelector("input");me.addEventListener("change",()=>{if(me.checked){let O=J.findIndex(we=>we.url===j);O===-1?J.push({label:y,url:j}):J[O]={...J[O],label:y}}else J=J.filter(O=>O.url!==j);h()}),x.appendChild(ue)}),h()}},h=()=>{if(Ie){if(Ie.innerHTML="",!J||J.length===0){let a=document.createElement("p");a.className="text-xs text-slate-400 italic",a.textContent="Aucun lien de menu s\xE9lectionn\xE9.",Ie.appendChild(a);return}J.forEach((a,d)=>{let y=document.createElement("div");y.className="flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2",y.dataset.navUrl=a.url;let j=document.createElement("div");j.className="flex-1 min-w-0";let Y=document.createElement("p");Y.className="text-sm font-medium text-slate-800 truncate",Y.textContent=a.label||a.url;let ue=document.createElement("p");ue.className="text-[11px] text-slate-400 truncate",ue.textContent=a.url,j.appendChild(Y),j.appendChild(ue);let me=document.createElement("div");me.className="flex items-center gap-1";let O=document.createElement("button");O.type="button",O.className="rounded-lg border border-slate-200 px-2 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-50 disabled:opacity-40 disabled:hover:bg-transparent",O.textContent="\u2191",O.setAttribute("aria-label",`Monter ${a.label||a.url}`),O.disabled=d===0,O.addEventListener("click",()=>{if(d<=0)return;let ee=[...J],je=ee[d-1];ee[d-1]=ee[d],ee[d]=je,J=ee,h()});let we=document.createElement("button");we.type="button",we.className="rounded-lg border border-slate-200 px-2 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-50 disabled:opacity-40 disabled:hover:bg-transparent",we.textContent="\u2193",we.setAttribute("aria-label",`Descendre ${a.label||a.url}`),we.disabled=d===J.length-1,we.addEventListener("click",()=>{if(d>=J.length-1)return;let ee=[...J],je=ee[d+1];ee[d+1]=ee[d],ee[d]=je,J=ee,h()});let Se=document.createElement("button");Se.type="button",Se.className="rounded-lg border border-slate-200 px-2 py-1 text-xs font-semibold text-rose-700 hover:bg-rose-50",Se.textContent="\u2715",Se.setAttribute("aria-label",`Retirer ${a.label||a.url}`),Se.addEventListener("click",()=>{J=J.filter(je=>je.url!==a.url);let ee=x==null?void 0:x.querySelector(`input[name="nav-page"][value="${CSS.escape(a.url)}"]`);ee&&(ee.checked=!1),h()}),me.appendChild(O),me.appendChild(we),me.appendChild(Se),y.appendChild(j),y.appendChild(me),Ie.appendChild(y)})}},de=()=>{var d,y,j,Y,ue,me,O,we,Se,ee,je,st;let a=(J||[]).map(qe=>({label:(qe.label||qe.url||"").toString().trim(),url:St(qe.url)})).filter(qe=>qe.url);return{logo:{src:((y=(d=G.logo)==null?void 0:d.value)==null?void 0:y.trim())||"",alt:((Y=(j=G.logoAlt)==null?void 0:j.value)==null?void 0:Y.trim())||"",url:b((ue=G.logoUrl)==null?void 0:ue.value,"/")},nav:a,cta:{text:((O=(me=G.ctaText)==null?void 0:me.value)==null?void 0:O.trim())||"",url:b((we=G.ctaUrl)==null?void 0:we.value,""),style:((Se=G.ctaStyle)==null?void 0:Se.value)||"primary",textColor:((ee=G.ctaTextColor)==null?void 0:ee.value)||""},style:{position:((je=G.position)==null?void 0:je.value)||"static",bg:((st=G.bg)==null?void 0:st.value)||"bg-white"}}},Pt=async a=>{var y,j,Y,ue,me,O,we,Se,ee,je,st,qe;if(!a)return;G.logo&&(G.logo.value=((y=a.logo)==null?void 0:y.src)||""),G.logoAlt&&(G.logoAlt.value=((j=a.logo)==null?void 0:j.alt)||""),G.logoUrl&&(G.logoUrl.value=b((Y=a.logo)==null?void 0:Y.url,"/")),G.ctaText&&(G.ctaText.value=((ue=a.cta)==null?void 0:ue.text)||""),G.ctaUrl&&(G.ctaUrl.value=b((me=a.cta)==null?void 0:me.url,"")),G.ctaStyle&&(G.ctaStyle.value=((O=a.cta)==null?void 0:O.style)||"primary"),G.ctaTextColor&&(G.ctaTextColor.value=((we=a.cta)==null?void 0:we.textColor)||""),G.position&&(G.position.value=((Se=a.style)==null?void 0:Se.position)||"static"),G.bg&&(G.bg.value=((ee=a.style)==null?void 0:ee.bg)||"bg-white"),J=(a.nav||[]).map(De=>({...De,url:St(De.url)})),await Re();let d=((je=a.logo)==null?void 0:je.src)||((st=a.nav)==null?void 0:st.length)>0||((qe=a.cta)==null?void 0:qe.text);p&&(p.classList.toggle("bg-green-500",!!d),p.classList.toggle("bg-slate-300",!d),p.title=d?"Configur\xE9":"Non configur\xE9")};$e==null||$e.addEventListener("click",async()=>{if(xe){$e.disabled=!0,$e.textContent="Enregistrement...";try{let a=de();if(!(await fetch(`${xe}/header`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(a)})).ok)throw new Error("Erreur serveur");Ce=a,Pt(a),M("Header enregistr\xE9")}catch(a){console.error("[header] save error",a),M("Erreur lors de l'enregistrement","error")}finally{$e.disabled=!1,$e.textContent="Enregistrer"}}});let ts=(a,d="",y="")=>{if(!be||!a)return;let j=be.content.cloneNode(!0),Y=j.querySelector("[data-footer-link]"),ue=j.querySelector('[name="link-label"]'),me=j.querySelector('[name="link-url"]'),O=j.querySelector("[data-link-remove]");ue&&(ue.value=d),me&&(me.value=y),O==null||O.addEventListener("click",()=>Y==null?void 0:Y.remove()),a.appendChild(j)},ao=(a="",d=[])=>{if(!ce||!R)return;let y=ce.content.cloneNode(!0),j=y.querySelector("[data-footer-column]"),Y=y.querySelector('[name="column-title"]'),ue=y.querySelector("[data-column-links]"),me=y.querySelector("[data-column-link-add]"),O=y.querySelector("[data-column-remove]");Y&&(Y.value=a),d.forEach(we=>ts(ue,we.label,we.url)),me==null||me.addEventListener("click",()=>ts(ue)),O==null||O.addEventListener("click",()=>j==null?void 0:j.remove()),R.appendChild(y)},Ro=()=>{var d,y,j,Y,ue,me,O,we,Se,ee,je,st,qe,De,ot,At,ht,ys,Ze,Vt;let a=[];return R==null||R.querySelectorAll("[data-footer-column]").forEach(bs=>{var ct,vs;let lt=((vs=(ct=bs.querySelector('[name="column-title"]'))==null?void 0:ct.value)==null?void 0:vs.trim())||"",Hs=[];bs.querySelectorAll("[data-footer-link]").forEach(xs=>{var _e,rt,ws,Rs;let Us=((rt=(_e=xs.querySelector('[name="link-label"]'))==null?void 0:_e.value)==null?void 0:rt.trim())||"",Ke=((Rs=(ws=xs.querySelector('[name="link-url"]'))==null?void 0:ws.value)==null?void 0:Rs.trim())||"";(Us||Ke)&&Hs.push({label:Us,url:Ke})}),(lt||Hs.length>0)&&a.push({title:lt,links:Hs})}),{columns:a,socials:{linkedin:((y=(d=g.linkedin)==null?void 0:d.value)==null?void 0:y.trim())||"",twitter:((Y=(j=g.twitter)==null?void 0:j.value)==null?void 0:Y.trim())||"",instagram:((me=(ue=g.instagram)==null?void 0:ue.value)==null?void 0:me.trim())||"",facebook:((we=(O=g.facebook)==null?void 0:O.value)==null?void 0:we.trim())||"",youtube:((ee=(Se=g.youtube)==null?void 0:Se.value)==null?void 0:ee.trim())||"",github:((st=(je=g.github)==null?void 0:je.value)==null?void 0:st.trim())||""},copyright:((De=(qe=g.copyright)==null?void 0:qe.value)==null?void 0:De.trim())||"",legal:{url:((At=(ot=g.legalUrl)==null?void 0:ot.value)==null?void 0:At.trim())||"",privacyUrl:((ys=(ht=g.privacyUrl)==null?void 0:ht.value)==null?void 0:ys.trim())||""},style:{bg:((Ze=g.bg)==null?void 0:Ze.value)||"bg-slate-900 text-white",columnsCount:((Vt=g.columnsCount)==null?void 0:Vt.value)||"4"}}},Ps=a=>{var y,j,Y,ue,me,O,we,Se,ee,je,st;if(!a)return;g.linkedin&&(g.linkedin.value=((y=a.socials)==null?void 0:y.linkedin)||""),g.twitter&&(g.twitter.value=((j=a.socials)==null?void 0:j.twitter)||""),g.instagram&&(g.instagram.value=((Y=a.socials)==null?void 0:Y.instagram)||""),g.facebook&&(g.facebook.value=((ue=a.socials)==null?void 0:ue.facebook)||""),g.youtube&&(g.youtube.value=((me=a.socials)==null?void 0:me.youtube)||""),g.github&&(g.github.value=((O=a.socials)==null?void 0:O.github)||""),g.copyright&&(g.copyright.value=a.copyright||""),g.legalUrl&&(g.legalUrl.value=((we=a.legal)==null?void 0:we.url)||""),g.privacyUrl&&(g.privacyUrl.value=((Se=a.legal)==null?void 0:Se.privacyUrl)||""),g.bg&&(g.bg.value=((ee=a.style)==null?void 0:ee.bg)||"bg-slate-900 text-white"),g.columnsCount&&(g.columnsCount.value=((je=a.style)==null?void 0:je.columnsCount)||"4"),R&&(R.innerHTML=""),(a.columns||[]).forEach(qe=>ao(qe.title,qe.links));let d=((st=a.columns)==null?void 0:st.length)>0||a.copyright||Object.values(a.socials||{}).some(qe=>qe);v&&(v.classList.toggle("bg-green-500",!!d),v.classList.toggle("bg-slate-300",!d),v.title=d?"Configur\xE9":"Non configur\xE9")};I==null||I.addEventListener("click",()=>ao()),oe==null||oe.addEventListener("click",async()=>{if(xe){oe.disabled=!0,oe.textContent="Enregistrement...";try{let a=Ro();if(!(await fetch(`${xe}/footer`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(a)})).ok)throw new Error("Erreur serveur");ge=a,Ps(a),M("Footer enregistr\xE9")}catch(a){console.error("[footer] save error",a),M("Erreur lors de l'enregistrement","error")}finally{oe.disabled=!1,oe.textContent="Enregistrer"}}}),(async()=>{if(xe)try{let a=await fetch(xe,{credentials:"include"});if(a.ok){let d=await a.json();d.header&&(Ce=d.header,Pt(d.header)),d.footer&&(ge=d.footer,Ps(d.footer))}}catch(a){console.error("[layout] load error",a)}})();let io=Pe((Z==null?void 0:Z.slugValue)||re.slug||""),ut=io?`/api/sites/${encodeURIComponent(io)}/collections`:null,jt=[],ze=[],Oe=null,Je=null,mt=!1,Wt=!1,Ut=null,js=a=>{let d=(a||"").trim();if(!d)return"";if(d==="/")return"/";let j=d.replace(/^\//,"").split("/").map(Y=>Xt(Y||"")).filter(Y=>Y.length>0);return j.length?`/${j.join("/")}`:""},zo=a=>{if(!a)return"\u2014";let d=new Date(a);return Number.isNaN(d.getTime())?"\u2014":d.toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"})},Gt=()=>{let a=jt.find(d=>d.id===Oe);$&&($.textContent=(a==null?void 0:a.name)||"S\xE9lectionnez une collection"),F&&(F.textContent=(a==null?void 0:a.description)||"")},ss=a=>{_&&(_.textContent=a||(Oe?"Aucun item dans cette collection pour le moment.":"Choisissez une collection dans le panneau de gauche."))},Rt=()=>{k&&(k.classList.add("hidden"),k.dataset.itemId=""),U==null||U.classList.remove("hidden"),w&&(w.className=`hidden ${ke}`,w.textContent=""),q&&(q.disabled=!0),Ee()},We=()=>{k&&(k.classList.remove("hidden"),U==null||U.classList.add("hidden"),Ee())},zt=()=>{P&&(P.disabled=!Oe,P.disabled?P.classList.add("opacity-60","pointer-events-none"):P.classList.remove("opacity-60","pointer-events-none"))},os=a=>{if(!w)return;if(!a){w.className=`hidden ${ke}`,w.textContent="";return}let d=a.toLowerCase(),y="bg-slate-100 text-slate-600 border border-slate-200";d==="publi\xE9"||d==="publie"?y="bg-emerald-50 text-emerald-700 border border-emerald-100":d==="brouillon"&&(y="bg-amber-50 text-amber-700 border border-amber-100"),w.className=`${ke} ${y}`,w.textContent=a},Ms=()=>{if(o.innerHTML="",V&&(V.textContent=jt.length),!jt.length){se==null||se.classList.remove("hidden");return}se==null||se.classList.add("hidden"),jt.forEach(a=>{let d=a.id===Oe,y=document.createElement("button");y.type="button",y.dataset.collectionId=a.id,y.className=["w-full rounded-xl border px-3 py-2 text-left transition focus:outline-none focus:ring-2 focus:ring-[#9C6BFF]/40",d?"bg-[#F7F0FF] border-[#9C6BFF]/40 text-slate-900":"border-slate-200 text-slate-700 hover:border-[#9C6BFF]/40"].join(" "),y.setAttribute("role","option"),d?y.setAttribute("aria-current","true"):y.removeAttribute("aria-current"),y.innerHTML=`
          <div class="flex items-center justify-between gap-2">
            <div>
              <p class="text-sm font-semibold">${a.name||a.id}</p>
              <p class="text-xs text-slate-500">${a.description||""}</p>
            </div>
            <span class="text-[11px] uppercase tracking-wide text-slate-400">${a.type||""}</span>
          </div>
        `,y.addEventListener("click",()=>{Fs(a.id)}),o.appendChild(y)})},gt=()=>{if(T){if(T.innerHTML="",!ze.length||!Oe){_==null||_.classList.remove("hidden"),ss(),S==null||S.classList.add("hidden");return}_==null||_.classList.add("hidden"),S==null||S.classList.remove("hidden"),ze.forEach(a=>{let d=document.createElement("tr");d.dataset.itemId=a.id;let y=a.id===Je&&!mt;d.className=["cursor-pointer transition focus-within:bg-[#F7F0FF]/70 focus:outline-none",y?"bg-[#F7F0FF]/70":"hover:bg-slate-50"].join(" "),d.tabIndex=0,d.setAttribute("role","button"),y?d.setAttribute("aria-current","true"):d.removeAttribute("aria-current");let j=a.status||"Brouillon",Y=j.toLowerCase(),ue=Y==="publi\xE9"||Y==="publie"?"bg-emerald-50 text-emerald-700 border border-emerald-100":"bg-amber-50 text-amber-700 border border-amber-100";d.innerHTML=`
          <td class="px-4 py-3 align-top">
            <div class="flex flex-col">
              <span class="text-sm font-semibold text-slate-900">${a.title||"Sans titre"}</span>
              <span class="text-xs text-slate-500">${a.summary||a.excerpt||""}</span>
            </div>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-600">${a.slug||""}</td>
          <td class="px-4 py-3 align-top">
            <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${ue}">
              ${j}
            </span>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-500">${zo(a.updatedAt||a.createdAt)}</td>
        `;let me=()=>{lo(a.id)};d.addEventListener("click",me),d.addEventListener("keydown",O=>{(O.key==="Enter"||O.key===" ")&&(O.preventDefault(),me())}),T.appendChild(d)})}},lo=a=>{let d=ze.find(y=>y.id===a);d&&(Je=d.id,mt=!1,Wt=!0,gs(d),gt())},gs=a=>{var d,y;if(!k||!a){Rt();return}We(),k.dataset.itemId=a.id,L.title&&(L.title.value=a.title||""),L.slug&&(L.slug.value=a.slug||""),L.excerpt&&(L.excerpt.value=a.summary||a.excerpt||""),L.content&&(L.content.value=a.content||""),L.image&&(L.image.value=a.image||""),L.ctaText&&(L.ctaText.value=((d=a.cta)==null?void 0:d.text)||a.ctaText||""),L.ctaUrl&&(L.ctaUrl.value=((y=a.cta)==null?void 0:y.url)||a.ctaUrl||""),L.status&&(L.status.value=a.status||"Brouillon"),os(a.status||"Brouillon"),q&&(q.disabled=!1)},co=()=>{var a;k&&(mt=!0,Je=null,Wt=!1,k.dataset.itemId="",k.reset(),L.status&&(L.status.value="Brouillon"),L.slug&&(L.slug.value=""),os("Brouillon"),We(),q&&(q.disabled=!0),(a=L.title)==null||a.focus())},Vo=()=>{var Se,ee,je,st,qe,De,ot,At;let a=(((Se=L.title)==null?void 0:Se.value)||"").trim(),d=(((ee=L.slug)==null?void 0:ee.value)||"").trim(),y=(((je=L.excerpt)==null?void 0:je.value)||"").trim(),j=(((st=L.content)==null?void 0:st.value)||"").trim(),Y=(((qe=L.image)==null?void 0:qe.value)||"").trim(),ue=(((De=L.ctaText)==null?void 0:De.value)||"").trim(),me=(((ot=L.ctaUrl)==null?void 0:ot.value)||"").trim(),O=((At=L.status)==null?void 0:At.value)||"Brouillon",we=ue||me?{text:ue,url:me}:null;return{title:a,slug:js(d||a),summary:y,excerpt:y,content:j,image:Y,status:O,...we&&{cta:we}}},uo=a=>{Q&&(Q.disabled=a,Q.textContent=a?"Enregistrement\u2026":"Enregistrer"),q&&!mt&&Je&&(q.disabled=a)},mo=async a=>{if(!ut)return[];let d=await fetch(`${ut}/${encodeURIComponent(a)}/items`,{headers:{Accept:"application/json"}});if(!d.ok){let j=await d.json().catch(()=>({}));throw new Error(j.message||"Impossible de charger les items.")}let y=await d.json().catch(()=>({}));return Array.isArray(y.items)?y.items:[]},Fs=async a=>{if(a&&(Oe=a,Je=null,mt=!1,Wt=!1,Me("collection"),Gt(),zt(),Ms(),Rt(),ze=[],gt(),ss("Chargement des items\u2026"),_==null||_.classList.remove("hidden"),S==null||S.classList.add("hidden"),!!ut))try{ze=await mo(a),gt(),ze.length||ss()}catch(d){console.error("[content] items failed",d),M(d.message||"Impossible de charger les items."),ze=[],gt()}},Ns=async(a,d)=>{if(!ut)throw new Error("Site inconnu.");let y=await fetch(`${ut}/${encodeURIComponent(a)}/items`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(!y.ok){let j=await y.json().catch(()=>({}));throw new Error(j.message||"Impossible de cr\xE9er cet item.")}return y.json()},Oo=async(a,d,y)=>{if(!ut)throw new Error("Site inconnu.");let j=await fetch(`${ut}/${encodeURIComponent(a)}/items/${encodeURIComponent(d)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(y)});if(!j.ok){let Y=await j.json().catch(()=>({}));throw new Error(Y.message||"Impossible de sauvegarder cet item.")}return j.json()},rs=async(a,d)=>{if(!ut)throw new Error("Site inconnu.");let y=await fetch(`${ut}/${encodeURIComponent(a)}/items/${encodeURIComponent(d)}`,{method:"DELETE"});if(!y.ok){let j=await y.json().catch(()=>({}));throw new Error(j.message||"Impossible de supprimer cet item.")}},Jo=async()=>{var a;if(!ut){se==null||se.classList.remove("hidden"),Oe=null,ze=[],gt(),Gt(),zt();return}try{let d=await fetch(ut,{headers:{Accept:"application/json"}});if(!d.ok)throw new Error("Impossible de charger les collections.");let y=await d.json().catch(()=>[]);if(jt=Array.isArray(y)?y:[],Ms(),jt.length>0){let j=((a=jt.find(Y=>Y.id===Oe))==null?void 0:a.id)||jt[0].id;Fs(j)}else Oe=null,ze=[],Gt(),zt(),gt()}catch(d){console.error("[content] load collections",d),M(d.message||"Impossible de charger les collections.")}};P==null||P.addEventListener("click",()=>{if(!Oe){M("S\xE9lectionnez d\u2019abord une collection.");return}co(),gt()}),te==null||te.addEventListener("click",a=>{if(a.preventDefault(),mt){mt=!1,Je=null,Rt(),gt();return}if(Je){let d=ze.find(y=>y.id===Je);gs(d)}else Rt()}),(Ds=L.status)==null||Ds.addEventListener("change",()=>{os(L.status.value)}),(as=L.title)==null||as.addEventListener("input",()=>{!mt||!L.slug||Wt||(L.slug.value=js(L.title.value))}),(qt=L.slug)==null||qt.addEventListener("input",()=>{mt&&(Wt=!0)}),k==null||k.addEventListener("submit",async a=>{var y;if(a.preventDefault(),!Oe){M("S\xE9lectionnez une collection.");return}let d=Vo();if(!d.title){M("Le titre est requis."),(y=L.title)==null||y.focus();return}uo(!0);try{let j;mt||!Je?(j=await Ns(Oe,d),ze=[...ze,j],M("Item cr\xE9\xE9")):(j=await Oo(Oe,Je,d),ze=ze.map(Y=>Y.id===j.id?j:Y),M("Item mis \xE0 jour")),mt=!1,Je=j.id,gs(j),gt()}catch(j){console.error("[content] save item failed",j),M(j.message||"Impossible de sauvegarder cet item.")}finally{uo(!1)}});let hs=()=>{E&&(E.classList.add("hidden"),E.classList.remove("flex"),Ut=null)},ns=()=>{!E||!Je||(Ut=Je,E.classList.remove("hidden"),E.classList.add("flex"))};q==null||q.addEventListener("click",a=>{a.preventDefault(),Je&&ns()}),D==null||D.addEventListener("click",()=>{hs()}),E==null||E.addEventListener("click",a=>{a.target===E&&hs()}),K==null||K.addEventListener("click",async()=>{if(!Ut||!Oe){hs();return}K.disabled=!0,K.textContent="Suppression\u2026";try{await rs(Oe,Ut),ze=ze.filter(a=>a.id!==Ut),Je===Ut&&(Je=null,Rt()),M("Item supprim\xE9"),gt()}catch(a){console.error("[content] delete item failed",a),M(a.message||"Impossible de supprimer cet item.")}finally{K.disabled=!1,K.textContent="Supprimer",hs()}}),Gt(),zt(),Jo()}function Cn(){let o=document.querySelector("[data-deploy-form]");if(!o)return;let n=document.querySelector("[data-deploy-protocol]"),c=document.querySelector("[data-deploy-host]"),f=document.querySelector("[data-deploy-port]"),p=document.querySelector("[data-deploy-user]"),v=document.querySelector("[data-deploy-password]"),V=document.querySelector("[data-deploy-show-password]"),H=document.querySelector("[data-deploy-remote-path]"),W=document.querySelector("[data-deploy-feedback]"),se=document.querySelector("[data-deploy-save]"),_=document.querySelector("[data-deploy-test]"),S=document.querySelector("[data-deploy-trigger]"),T=document.querySelector("[data-deploy-history]"),$=document.querySelector("[data-deploy-log]"),F=Pe((Z==null?void 0:Z.slugValue)||re.slug||""),P=F?`/api/sites/${encodeURIComponent(F)}/deploy-config`:null,U=F?`/api/sites/${encodeURIComponent(F)}/deploy`:null,k=F?`/api/sites/${encodeURIComponent(F)}/deploy-log`:null,L=!1,w=null,q=N=>{let x=(N||"").trim();return x?x.startsWith("/")?x:`/${x}`:"/www"},E=(N,x="muted")=>{if(!W)return;let X="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold",J=x==="success"?"bg-emerald-50 text-emerald-700 border border-emerald-100":x==="error"?"bg-rose-50 text-rose-700 border border-rose-100":"bg-slate-50 text-slate-600 border border-slate-100";if(!N){W.textContent="",W.className="text-sm text-slate-500";return}let g=x==="success"?"\u2705":x==="error"?"\u274C":"\u2139\uFE0F";W.innerHTML=`<span class="${X} ${J}">${g}<span>${N}</span></span>`,W.className="text-sm"},D=(N=null)=>{w=N;let x=!!N,X='<svg class="h-4 w-4 animate-spin text-white" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>';se&&(se.disabled=x,se.innerHTML=N==="save"?`<span class="inline-flex items-center gap-2">${X}<span>Enregistrement\u2026</span></span>`:"Enregistrer"),_&&(_.disabled=x,_.innerHTML=N==="test"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-slate-200 border-t-slate-600"></span><span>Test en cours\u2026</span></span>':"Tester la connexion"),S&&(S.disabled=x&&N!==null,S.innerHTML=N==="deploy"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-white/60 border-t-white"></span><span>D\xE9ploiement\u2026</span></span>':"D\xE9ployer maintenant")},K=N=>{n&&(n.value=N.protocol||"sftp"),c&&(c.value=N.host||""),f&&(f.value=N.port||""),p&&(p.value=N.user||""),H&&(H.value=N.remotePath||"/www"),L=!!N.hasPassword,v&&(v.value="",v.placeholder=L?"Non affich\xE9":"Mot de passe")},te=(N=[])=>{if(T){if(T.innerHTML="",!N.length){let x=document.createElement("li");x.className="text-slate-500",x.textContent="Aucun d\xE9ploiement pour le moment.",T.appendChild(x);return}N.forEach(x=>{let X=document.createElement("li");X.className="flex items-center justify-between gap-2 rounded-xl border border-slate-200 px-3 py-2";let J=x.status==="success"?'<span class="rounded-full bg-emerald-50 px-2 py-0.5 text-[11px] font-semibold text-emerald-700">Succ\xE8s</span>':'<span class="rounded-full bg-rose-50 px-2 py-0.5 text-[11px] font-semibold text-rose-700">\xC9chec</span>',g=x.finishedAt||x.startedAt||"",R=x.durationMs&&Number(x.durationMs)>=0?`${Math.round(Number(x.durationMs)/1e3)}s`:"";X.innerHTML=`
          <div class="space-y-1">
            <div class="flex items-center gap-2">${J}<span class="text-xs text-slate-500">${g}</span></div>
            <p class="text-sm text-slate-800">${x.message||""}</p>
          </div>
          <div class="text-xs text-slate-500">${R}</div>
        `,X.dataset.deployId=x.id||"",X.addEventListener("click",()=>{x.logs&&$&&($.textContent=x.logs.join(`
`))}),T.appendChild(X)})}},Q=(N=[])=>{$&&($.textContent=N.length?N.join(`
`):"Aucun log pour le moment.")},ke=async()=>{var N;if(k)try{let x=await fetch(k,{headers:{Accept:"application/json"}});if(!x.ok){if(x.status===404){te([]),Q(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw new Error("Impossible de charger l\u2019historique.")}let X=await x.json().catch(()=>({})),J=Array.isArray(X.entries)?X.entries:[];te(J),(N=J[0])!=null&&N.logs&&Q(J[0].logs)}catch(x){console.error("[deploy] history failed",x)}},Te=async()=>{if(!P){E("Aucun site actif s\xE9lectionn\xE9.","error");return}D("load");try{let N=await fetch(P,{headers:{Accept:"application/json"}}),x=await N.json().catch(()=>({}));N.ok?(K(x||{}),E("Configuration charg\xE9e.","muted")):(K(x||{}),E(x.message||"Configuration par d\xE9faut charg\xE9e.","muted"))}catch(N){console.error("[deploy] load failed",N),E(N.message||"Erreur lors du chargement.","error")}finally{D(null)}},Ge=()=>{let N={protocol:(n==null?void 0:n.value)||"sftp",host:(c==null?void 0:c.value.trim())||"",port:Number(f==null?void 0:f.value)||void 0,user:(p==null?void 0:p.value.trim())||"",remotePath:q((H==null?void 0:H.value)||"/www")},x=(v==null?void 0:v.value)||"";return x.trim().length>0&&(N.password=x),N};o.addEventListener("submit",async N=>{if(N.preventDefault(),!P){E("Aucun site actif s\xE9lectionn\xE9.","error");return}let x=Ge();D("save");try{let X=await fetch(P,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(x)});if(!X.ok){let g=await X.json().catch(()=>({}));throw new Error(g.message||"Sauvegarde impossible.")}let J=await X.json();K(J||{}),E("Configuration enregistr\xE9e.","success"),M("Configuration d\xE9ploiement sauvegard\xE9e")}catch(X){console.error("[deploy] save failed",X),E(X.message||"Erreur lors de la sauvegarde.","error")}finally{D(null)}}),_==null||_.addEventListener("click",async()=>{if(!P){E("Aucun site actif s\xE9lectionn\xE9.","error");return}let N=Ge();if(!N.host||!N.user||!N.remotePath){E("Remplissez les champs requis avant de tester.","error");return}D("test");try{let x=await fetch(`${P}/test`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(N)}),X=await x.json().catch(()=>({}));if(!x.ok||X.success===!1){E(X.message||"Test de connexion \xE9chou\xE9.","error");return}E(X.message||"Connexion OK.","success"),M("Test de connexion r\xE9ussi")}catch(x){console.error("[deploy] test failed",x),E(x.message||"Test de connexion \xE9chou\xE9.","error")}finally{D(null)}}),S==null||S.addEventListener("click",async()=>{if(!U){E("Aucun site actif s\xE9lectionn\xE9.","error");return}D("deploy"),Q(["D\xE9ploiement en cours\u2026"]);try{let N=await fetch(U,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Ge())}),x=await N.json().catch(()=>({}));if(!N.ok){if(N.status===404){E("API d\xE9ploiement indisponible (red\xE9marre le serveur).","error"),Q(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw Q(x.logs||[]),new Error(x.message||"D\xE9ploiement \xE9chou\xE9.")}Q(x.logs||[]),await ke(),M("D\xE9ploiement termin\xE9")}catch(N){console.error("[deploy] run failed",N),E(N.message||"D\xE9ploiement \xE9chou\xE9.","error")}finally{D(null)}}),V==null||V.addEventListener("change",()=>{v&&(v.type=V.checked?"text":"password")});let Ee=document.querySelector("[data-download-build]"),G=document.querySelector("[data-download-feedback]"),Ie=F?`/api/sites/${encodeURIComponent(F)}/download`:null,$e=(N,x="muted")=>{if(!G)return;let X=x==="success"?"text-emerald-600":x==="error"?"text-rose-600":"text-slate-500";G.textContent=N||"",G.className=`text-sm ${X}`};Ee==null||Ee.addEventListener("click",async()=>{if(!Ie){$e("Aucun site actif s\xE9lectionn\xE9.","error");return}Ee.disabled=!0;let N=Ee.innerHTML;Ee.innerHTML=`
        <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <span>Build en cours...</span>
      `,$e("G\xE9n\xE9ration du build en cours...","muted");try{let x=await fetch(Ie);if(!x.ok){let R=await x.json().catch(()=>({}));throw new Error(R.message||"Impossible de g\xE9n\xE9rer le ZIP.")}let X=await x.blob(),J=window.URL.createObjectURL(X),g=document.createElement("a");g.href=J,g.download=`${F}-build.zip`,document.body.appendChild(g),g.click(),document.body.removeChild(g),window.URL.revokeObjectURL(J),$e("T\xE9l\xE9chargement termin\xE9 !","success"),M("Build t\xE9l\xE9charg\xE9 avec succ\xE8s")}catch(x){console.error("[download] failed",x),$e(x.message||"Erreur lors du t\xE9l\xE9chargement.","error")}finally{Ee.disabled=!1,Ee.innerHTML=N}}),Te(),ke()}function En(){let o=document.querySelectorAll("[data-settings-tab]"),n=document.querySelectorAll("[data-settings-panel]"),c=document.querySelector("[data-admin-password-form]"),f=document.querySelector("[data-site-config-form]"),p=document.querySelector("[data-site-config-feedback]"),v=document.querySelector("[data-theme-form]"),V=S=>{o.forEach(T=>{let $=T.dataset.settingsTab===S;T.setAttribute("aria-selected",$?"true":"false"),T.classList.toggle("bg-[#9C6BFF]",$),T.classList.toggle("text-white",$)}),n.forEach(T=>{T.classList.toggle("hidden",T.dataset.settingsPanel!==S)})};if(o.forEach(S=>{S.addEventListener("click",()=>V(S.dataset.settingsTab||"account"))}),V("account"),c){let S=c.querySelector("[data-admin-password-feedback]"),T=c.querySelector("[data-admin-password-submit]"),$=(F,P="muted")=>{if(!S)return;let U=P==="success"?"text-emerald-600":P==="error"?"text-rose-600":"text-slate-500";S.textContent=F||"",S.className=`text-sm ${U}`};c.addEventListener("submit",async F=>{F.preventDefault();let P=new FormData(c),U=P.get("currentPassword")||"",k=P.get("newPassword")||"",L=P.get("confirmPassword")||"";if(!U||!k||!L){$("Compl\xE8te tous les champs.","error");return}T&&(T.disabled=!0),$("");try{let w=await fetch("/api/admin/password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({currentPassword:U,newPassword:k,confirmPassword:L})}),q=await w.json().catch(()=>({}));if(!w.ok||q.success===!1)throw new Error(q.message||"Impossible de mettre \xE0 jour le mot de passe.");$(q.message||"Mot de passe mis \xE0 jour.","success"),c.reset()}catch(w){console.error("[settings] change password failed",w),$(w.message||"Erreur lors de la mise \xE0 jour.","error")}finally{T&&(T.disabled=!1)}})}if(f){let S=f.querySelector("[data-site-name]"),T=f.querySelector("[data-site-language]"),$=f.querySelector("[data-site-tagline]"),F=f.querySelector("[data-site-save]"),P=(w,q="muted")=>{if(!p)return;let E=q==="success"?"text-emerald-600":q==="error"?"text-rose-600":"text-slate-500";p.textContent=w||"",p.className=`text-sm ${E}`},U=Pe((Z==null?void 0:Z.slugValue)||re.slug||""),k=U?`/api/sites/${encodeURIComponent(U)}/config/site`:null,L=async()=>{if(k)try{let w=await fetch(k,{headers:{Accept:"application/json"}});if(!w.ok)return;let q=await w.json().catch(()=>({}));S&&(S.value=q.name||""),T&&(T.value=q.language||"fr"),$&&($.value=q.tagline||"")}catch(w){console.error("[settings] load site config failed",w)}};f.addEventListener("submit",async w=>{if(w.preventDefault(),!k){P("Aucun site actif.","error");return}if(!(S!=null&&S.value.trim())){P("Nom requis.","error");return}F&&(F.disabled=!0),P("");try{let q={name:(S==null?void 0:S.value)||"",language:(T==null?void 0:T.value)||"fr",tagline:($==null?void 0:$.value)||""},E=await fetch(k,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(q)}),D=await E.json().catch(()=>({}));if(!E.ok||D.success===!1)throw new Error(D.message||"Sauvegarde impossible.");P(D.message||"Param\xE8tres enregistr\xE9s.","success")}catch(q){console.error("[settings] save site config failed",q),P(q.message||"Erreur lors de la sauvegarde.","error")}finally{F&&(F.disabled=!1)}}),L()}if(v){let S=Pe((Z==null?void 0:Z.slugValue)||re.slug||""),T=S?`/api/sites/${encodeURIComponent(S)}/config/theme`:null,$={primary:v.querySelector("[data-theme-primary]"),secondary:v.querySelector("[data-theme-secondary]"),accent:v.querySelector("[data-theme-accent]"),background:v.querySelector("[data-theme-background]"),text:v.querySelector("[data-theme-text]")},F=v.querySelector("[data-theme-headings]"),P=v.querySelector("[data-theme-body]"),U=v.querySelector("[data-theme-radius-small]"),k=v.querySelector("[data-theme-radius-medium]"),L=v.querySelector("[data-theme-radius-large]"),w=v.querySelector("[data-theme-preview]"),q=v.querySelector("[data-theme-feedback]"),E=v.querySelector("[data-theme-apply]"),D={slate:"#e2e8f0",gray:"#d1d5db",zinc:"#d4d4d8",neutral:"#d4d4d4",stone:"#d6d3d1",red:"#ef4444",orange:"#f97316",amber:"#f59e0b",yellow:"#eab308",lime:"#84cc16",green:"#22c55e",emerald:"#10b981",teal:"#14b8a6",cyan:"#06b6d4",sky:"#0ea5e9",blue:"#3b82f6",indigo:"#6366f1",violet:"#8b5cf6",purple:"#a855f7",fuchsia:"#d946ef",pink:"#ec4899",rose:"#f43f5e"},K=g=>{if(!g)return null;if(g==="white")return"#ffffff";if(g==="black")return"#000000";if(g==="transparent")return"transparent";let[R,I]=g.split("-");if(!R||!I)return null;let oe=D[R];if(!oe)return null;let ce=Number(I)||500,be=Math.min(Math.max((ce-50)/900,0),1),pe=xe=>xe.replace("#","").match(/[A-Fa-f0-9]{2}/g).map(Me=>parseInt(Me,16)),[Ce,ge,Ne]=pe(oe),Ue=xe=>Math.round(255-(255-xe)*be);return`rgb(${Ue(Ce)}, ${Ue(ge)}, ${Ue(Ne)})`},te=["slate","gray","zinc","neutral","stone","red","orange","amber","yellow","lime","green","emerald","teal","cyan","sky","blue","indigo","violet","purple","fuchsia","pink","rose"],Q=["50","100","200","300","400","500","600","700","800","900"],ke=te.flatMap(g=>Q.map(R=>`${g}-${R}`)),Te=[{value:"white",label:"Blanc",color:"#ffffff",emoji:"\u2B1C"},{value:"transparent",label:"Transparent",color:"transparent",emoji:"\u2B1C"},{value:"black",label:"Noir",color:"#000000",emoji:"\u2B1B"}],Ge=(()=>{let g=[];return Te.forEach(({value:R,label:I,color:oe,emoji:ce})=>{g.push({value:R,label:`${ce} ${I}`,color:oe})}),ke.forEach(R=>{let[I,oe]=R.split("-"),ce=K(R)||"#ffffff";g.push({value:R,label:`${I.charAt(0).toUpperCase()+I.slice(1)} ${oe}`,color:ce})}),g})(),Ee=g=>typeof g=="string"?g.trim().toLowerCase():"",G=(g={})=>{Object.entries($).forEach(([R,I])=>{var ce;if(!I)return;let oe=Ee(g[R]);I.innerHTML="",Ge.forEach(({value:be,label:pe,color:Ce})=>{let ge=document.createElement("option");ge.value=be,ge.textContent=pe,ge.dataset.color=Ce,oe&&oe===be&&(ge.selected=!0),I.appendChild(ge)}),I.dataset.default=I.dataset.default||((ce=I.options[0])==null?void 0:ce.value)||"",!oe&&I.dataset.default&&(I.value=I.dataset.default),so(I)})},Ie=(g,R="muted")=>{if(!q)return;let I=R==="success"?"text-emerald-600":R==="error"?"text-rose-600":"text-slate-500";q.textContent=g||"",q.className=`text-sm ${I}`},$e=()=>{var R,I,oe,ce,be;if(!w)return;let g=pe=>{if(!pe)return null;if(pe==="white")return"#ffffff";if(pe==="black")return"#000000";if(pe==="transparent")return"transparent";let[Ce,ge]=pe.split("-");if(!Ce||!ge)return null;let Ue={slate:"#e2e8f0",gray:"#d1d5db",zinc:"#d4d4d8",neutral:"#d4d4d4",stone:"#d6d3d1",red:"#ef4444",orange:"#f97316",amber:"#f59e0b",yellow:"#eab308",lime:"#84cc16",green:"#22c55e",emerald:"#10b981",teal:"#14b8a6",cyan:"#06b6d4",sky:"#0ea5e9",blue:"#3b82f6",indigo:"#6366f1",violet:"#8b5cf6",purple:"#a855f7",fuchsia:"#d946ef",pink:"#ec4899",rose:"#f43f5e"}[Ce];if(!Ue)return null;let xe=Number(ge)||500,Me=Math.min(Math.max((xe-50)/900,0),1),Re=de=>de.match(/[A-Fa-f0-9]{2}/g).map(Pt=>parseInt(Pt,16)),[St,b,B]=Re(Ue.replace("#","")),h=de=>Math.round(255-(255-de)*Me);return`rgb(${h(St)}, ${h(b)}, ${h(B)})`};w.style.setProperty("--color-primary",K((R=$.primary)==null?void 0:R.value)||"#9C6BFF"),w.style.setProperty("--color-secondary",K((I=$.secondary)==null?void 0:I.value)||"#0EA5E9"),w.style.setProperty("--color-accent",K((oe=$.accent)==null?void 0:oe.value)||"#F97316"),w.style.setProperty("--color-background",K((ce=$.background)==null?void 0:ce.value)||"#FFFFFF"),w.style.setProperty("--color-text",K((be=$.text)==null?void 0:be.value)||"#0F172A"),w.style.setProperty("--font-headings",(F==null?void 0:F.value)||"Inter, sans-serif"),w.style.setProperty("--font-body",(P==null?void 0:P.value)||"Inter, sans-serif"),w.style.setProperty("--radius-small",(U==null?void 0:U.value)||"8px"),w.style.setProperty("--radius-medium",(k==null?void 0:k.value)||"16px"),w.style.setProperty("--radius-large",(L==null?void 0:L.value)||"24px"),w.style.borderRadius=(k==null?void 0:k.value)||"16px"},N=(g,R)=>{if(g){if(R==="transparent"){g.style.background="repeating-conic-gradient(#ccc 0% 25%, white 0% 50%) 50% / 8px 8px",g.style.borderColor="#cbd5f5",g.style.boxShadow="";return}g.style.background=R,g.style.borderColor=R,g.style.boxShadow="0 0 0 1px rgba(15,23,42,0.15)"}},x=g=>{var be,pe,Ce;if(!g)return;let R=g.options[g.selectedIndex],I=((be=R==null?void 0:R.dataset)==null?void 0:be.color)||"#ffffff",oe=(pe=g.closest(".relative"))==null?void 0:pe.querySelector("[data-color-preview]");oe&&(I==="transparent"?oe.style.background=es:oe.style.background=I);let ce=(Ce=g.closest(".relative"))==null?void 0:Ce.querySelector("[data-theme-color-chip]");N(ce,I)},X=()=>{Object.values($).forEach(g=>{g&&(so(g),x(g),g.addEventListener("change",()=>x(g)))})};Object.keys($).forEach(g=>{var R;(R=$[g])==null||R.addEventListener("change",$e)}),[F,P,U,k,L].forEach(g=>{g==null||g.addEventListener("change",$e)});let J=async()=>{var g,R,I,oe,ce;if(T)try{let be=await fetch(T,{headers:{Accept:"application/json"},credentials:"include"});if(!be.ok)return;let pe=await be.json().catch(()=>({})),Ce=pe.colors||{};G(Ce),Object.entries($).forEach(([ge,Ne])=>{if(!Ne)return;let Ue=Ce[ge],xe=Ee(Ue);xe?Ne.value=xe:Ue?Ne.value=Ue:Ne.dataset.default&&(Ne.value=Ne.dataset.default),x(Ne)}),F&&(F.value=((g=pe.typography)==null?void 0:g.headings)||"Inter, sans-serif"),P&&(P.value=((R=pe.typography)==null?void 0:R.body)||"Inter, sans-serif"),U&&(U.value=((I=pe.radius)==null?void 0:I.small)||"8px"),k&&(k.value=((oe=pe.radius)==null?void 0:oe.medium)||"16px"),L&&(L.value=((ce=pe.radius)==null?void 0:ce.large)||"24px"),$e()}catch(be){console.error("[settings] load theme failed",be)}};E==null||E.addEventListener("click",async g=>{var I,oe,ce,be,pe;if(g.preventDefault(),!T){Ie("Aucun site actif.","error");return}let R={colors:{primary:((I=$.primary)==null?void 0:I.value)||"violet-500",secondary:((oe=$.secondary)==null?void 0:oe.value)||"indigo-400",accent:((ce=$.accent)==null?void 0:ce.value)||"emerald-500",background:((be=$.background)==null?void 0:be.value)||"slate-50",text:((pe=$.text)==null?void 0:pe.value)||"slate-900"},typography:{headings:(F==null?void 0:F.value)||"Inter, sans-serif",body:(P==null?void 0:P.value)||"Inter, sans-serif"},radius:{small:(U==null?void 0:U.value)||"8px",medium:(k==null?void 0:k.value)||"16px",large:(L==null?void 0:L.value)||"24px"}};E.disabled=!0,Ie("");try{let Ce=await fetch(T,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(R)}),ge=await Ce.json().catch(()=>({}));if(!Ce.ok||ge.success===!1)throw new Error(ge.message||"Application du th\xE8me \xE9chou\xE9e.");await J(),Ie(ge.message||"Th\xE8me appliqu\xE9.","success")}catch(Ce){console.error("[settings] apply theme failed",Ce),Ie(Ce.message||"Erreur lors de l\u2019application du th\xE8me.","error")}finally{E.disabled=!1}}),G(),X(),J(),$e(),document.addEventListener("ai-theme-updated",()=>{J(),Ie("Th\xE8me mis \xE0 jour.","success")})}let H=document.querySelector("[data-seo-config-form]");if(H){let S=H.querySelector("[data-seo-index-all]"),T=H.querySelector("[data-seo-config-feedback]"),$=H.querySelector("[data-seo-save]"),F=Pe((Z==null?void 0:Z.slugValue)||re.slug||""),P=F?`/api/sites/${encodeURIComponent(F)}/config/site`:null,U=(L,w="muted")=>{if(!T)return;let q=w==="success"?"text-emerald-600":w==="error"?"text-rose-600":"text-slate-500";T.textContent=L||"",T.className=`text-sm ${q}`},k=async()=>{var L;if(P)try{let w=await fetch(P,{headers:{Accept:"application/json"}});if(!w.ok)return;let E=((L=(await w.json().catch(()=>({}))).seo)==null?void 0:L.indexAllPagesByDefault)!==!1;S&&(S.checked=E)}catch(w){console.error("[settings] load seo config failed",w)}};H.addEventListener("submit",async L=>{var w;if(L.preventDefault(),!P){U("Aucun site actif.","error");return}$&&($.disabled=!0),U("");try{let q=await fetch(P,{headers:{Accept:"application/json"}}),E=q.ok?await q.json().catch(()=>({})):{},D={...E,seo:{...E.seo||{},indexAllPagesByDefault:(w=S==null?void 0:S.checked)!=null?w:!0}},K=await fetch(P,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(D)}),te=await K.json().catch(()=>({}));if(!K.ok||te.success===!1)throw new Error(te.message||"Sauvegarde impossible.");U(te.message||"Param\xE8tres SEO enregistr\xE9s.","success")}catch(q){console.error("[settings] save seo config failed",q),U(q.message||"Erreur lors de la sauvegarde.","error")}finally{$&&($.disabled=!1)}}),k()}let W=document.querySelector("[data-analytics-form]");if(W){let S=W.querySelector("[data-analytics-head]"),T=W.querySelector("[data-analytics-body]"),$=W.querySelector("[data-analytics-feedback]"),F=W.querySelector("[data-analytics-save]"),P=Pe((Z==null?void 0:Z.slugValue)||re.slug||""),U=P?`/api/sites/${encodeURIComponent(P)}/config/site`:null,k=(w,q="muted")=>{if(!$)return;let E=q==="success"?"text-emerald-600":q==="error"?"text-rose-600":"text-slate-500";$.textContent=w||"",$.className=`text-sm ${E}`},L=async()=>{var w,q;if(U)try{let E=await fetch(U,{headers:{Accept:"application/json"}});if(!E.ok)return;let D=await E.json().catch(()=>({}));S&&(S.value=((w=D.analytics)==null?void 0:w.headCode)||""),T&&(T.value=((q=D.analytics)==null?void 0:q.bodyEndCode)||"")}catch(E){console.error("[settings] load analytics config failed",E)}};W.addEventListener("submit",async w=>{if(w.preventDefault(),!U){k("Aucun site actif.","error");return}F&&(F.disabled=!0),k("");try{let q=await fetch(U,{headers:{Accept:"application/json"}}),D={...q.ok?await q.json().catch(()=>({})):{},analytics:{headCode:(S==null?void 0:S.value)||"",bodyEndCode:(T==null?void 0:T.value)||""}},K=await fetch(U,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(D)}),te=await K.json().catch(()=>({}));if(!K.ok||te.success===!1)throw new Error(te.message||"Sauvegarde impossible.");k(te.message||"Scripts enregistr\xE9s.","success")}catch(q){console.error("[settings] save analytics config failed",q),k(q.message||"Erreur lors de la sauvegarde.","error")}finally{F&&(F.disabled=!1)}}),L()}let se=document.querySelector("[data-accessibility-form]");if(se){let S=se.querySelector("[data-accessibility-animations]"),T=se.querySelector("[data-accessibility-contrast]"),$=se.querySelector("[data-accessibility-feedback]"),F=se.querySelector("[data-accessibility-save]"),P=Pe((Z==null?void 0:Z.slugValue)||re.slug||""),U=P?`/api/sites/${encodeURIComponent(P)}/config/site`:null,k=(w,q="muted")=>{if(!$)return;let E=q==="success"?"text-emerald-600":q==="error"?"text-rose-600":"text-slate-500";$.textContent=w||"",$.className=`text-sm ${E}`},L=async()=>{var w,q;if(U)try{let E=await fetch(U,{headers:{Accept:"application/json"}});if(!E.ok)return;let D=await E.json().catch(()=>({}));S&&(S.checked=((w=D.accessibility)==null?void 0:w.animationsEnabled)!==!1),T&&(T.checked=((q=D.accessibility)==null?void 0:q.highContrast)===!0)}catch(E){console.error("[settings] load accessibility config failed",E)}};se.addEventListener("submit",async w=>{var q,E;if(w.preventDefault(),!U){k("Aucun site actif.","error");return}F&&(F.disabled=!0),k("");try{let D=await fetch(U,{headers:{Accept:"application/json"}}),te={...D.ok?await D.json().catch(()=>({})):{},accessibility:{animationsEnabled:(q=S==null?void 0:S.checked)!=null?q:!0,highContrast:(E=T==null?void 0:T.checked)!=null?E:!1}},Q=await fetch(U,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(te)}),ke=await Q.json().catch(()=>({}));if(!Q.ok||ke.success===!1)throw new Error(ke.message||"Sauvegarde impossible.");k(ke.message||"Pr\xE9f\xE9rences mises \xE0 jour.","success")}catch(D){console.error("[settings] save accessibility config failed",D),k(D.message||"Erreur lors de la sauvegarde.","error")}finally{F&&(F.disabled=!1)}}),L()}let _=document.querySelector("[data-ai-config-form]");if(_){let S=_.querySelector("[data-ai-api-key]"),T=_.querySelector("[data-ai-model]"),$=_.querySelector("[data-ai-project-prompt]"),F=_.querySelector("[data-ai-enabled]"),P=_.querySelector("[data-ai-feedback]"),U=_.querySelector("[data-ai-save]"),k=Pe((Z==null?void 0:Z.slugValue)||re.slug||""),L=k?`/api/sites/${encodeURIComponent(k)}/config/ai`:null,w=(E,D="muted")=>{if(!P)return;let K=D==="success"?"text-emerald-600":D==="error"?"text-rose-600":"text-slate-500";P.textContent=E||"",P.className=`text-sm ${K}`},q=async()=>{if(L)try{let E=await fetch(L,{headers:{Accept:"application/json"}});if(!E.ok)return;let D=await E.json().catch(()=>({}));S&&(S.value="",S.placeholder=D.hasApiKey?"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022":"Cl\xE9 API Gemini"),T&&(T.value=D.model||"gemini-2.5-flash"),$&&($.value=D.projectPrompt||""),F&&(F.checked=D.enabled!==!1)}catch(E){console.error("[settings] load AI config failed",E)}};_.addEventListener("submit",async E=>{var D,K;if(E.preventDefault(),!L){w("Aucun site actif.","error");return}U&&(U.disabled=!0),w("");try{let te={model:(T==null?void 0:T.value)||"gemini-2.5-flash",projectPrompt:($==null?void 0:$.value)||"",enabled:(D=F==null?void 0:F.checked)!=null?D:!0},Q=(K=S==null?void 0:S.value)==null?void 0:K.trim();Q&&(te.apiKey=Q);let ke=await fetch(L,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(te)}),Te=await ke.json().catch(()=>({}));if(!ke.ok||Te.success===!1)throw new Error(Te.message||"Sauvegarde impossible.");w(Te.message||"Configuration IA enregistr\xE9e.","success"),S&&(S.value="",S.placeholder="\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022")}catch(te){console.error("[settings] save AI config failed",te),w(te.message||"Erreur lors de la sauvegarde.","error")}finally{U&&(U.disabled=!1)}}),q()}}function qn(){let o=document.querySelector("[data-media-grid]");if(!o)return;let n=document.querySelector("[data-media-empty]"),c=document.querySelector("[data-media-count]"),f=document.querySelector("[data-media-filter-type]"),p=document.querySelector("[data-media-detail-empty]"),v=document.querySelector("[data-media-detail]"),V=document.querySelector("[data-media-detail-preview]"),H=document.querySelector("[data-media-detail-name]"),W=document.querySelector("[data-media-detail-type]"),se=document.querySelector("[data-media-detail-size]"),_=document.querySelector("[data-media-detail-path]"),S=document.querySelector("[data-media-detail-used]"),T=document.querySelector("[data-media-alt-edit]"),$=document.querySelector("[data-media-save]"),F=document.querySelector("[data-media-delete]"),P=document.querySelector("[data-media-delete-modal]"),U=document.querySelector("[data-media-delete-cancel]"),k=document.querySelector("[data-media-delete-confirm]"),L=document.querySelector("[data-media-upload-open]"),w=document.querySelector("[data-media-file-input]"),q=document.querySelector("[data-media-upload-status]"),E=Pe((Z==null?void 0:Z.slugValue)||re.slug||""),D=E?`/api/sites/${encodeURIComponent(E)}/media`:null,K=[],te=[],Q=null,ke=null,Te=null,Ge=!1,Ee=!1,G=!1,Ie=null,$e=b=>{let B=(b.type||"").toLowerCase(),h=(b.filename||"").toLowerCase();return B.includes("image")||/\.(png|jpe?g|webp|svg|gif)$/i.test(h)?"image":B.includes("pdf")||B.includes("doc")||/\.(pdf|docx?)$/i.test(h)?"document":B.includes("video")||/\.(mp4|mov|webm)$/i.test(h)?"video":"other"},N=b=>$e(b)==="image",x=b=>{if(b.type)return b.type.toUpperCase();let B=(b.filename||"").split(".").pop();return B?B.toUpperCase():"FILE"},X=b=>!b||b<=0?"\u2014":b<1024?`${b} o`:b<1024*1024?`${(b/1024).toFixed(1)} ko`:`${(b/(1024*1024)).toFixed(1)} Mo`,J=()=>{v==null||v.classList.add("hidden"),p==null||p.classList.remove("hidden"),g(),Q=null,Ee=!1,ce(!1),V&&(V.innerHTML='<span class="text-slate-400 text-sm">Aucun m\xE9dia s\xE9lectionn\xE9</span>'),H&&(H.textContent=""),W&&(W.textContent=""),se&&(se.textContent=""),T&&(T.value=""),_&&(_.textContent=""),S&&(S.innerHTML="")},g=()=>{Te=null,G=!1,Ge=!1,Ie&&(URL.revokeObjectURL(Ie),Ie=null),q&&(q.textContent="Aucun fichier s\xE9lectionn\xE9."),w&&(w.value="")},R=()=>{c&&(te.length?te.length===1?c.textContent="1 m\xE9dia":c.textContent=`${te.length} m\xE9dias`:c.textContent="0 m\xE9dia")},I=()=>{if(o.innerHTML="",!te.length){n==null||n.classList.remove("hidden"),J();return}n==null||n.classList.add("hidden"),te.forEach(b=>{let B=document.createElement("button");B.type="button",B.dataset.mediaId=b.id;let h=b.id===Q;B.className=["group relative flex flex-col rounded-2xl border px-3 py-3 text-left transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#9C6BFF]",h?"border-[#9C6BFF] bg-[#F7F0FF]/60 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let de=N(b)?`<img src="${b.path}" alt="${b.alt||b.filename}" class="h-full w-full object-cover" />`:'<div class="flex h-full w-full items-center justify-center text-3xl text-slate-400">\u{1F4C4}</div>';B.innerHTML=`
          <div class="relative aspect-[4/3] overflow-hidden rounded-xl bg-slate-100">
            ${de}
          </div>
          <div class="mt-2 space-y-1">
            <p class="text-sm font-semibold text-slate-900 truncate">${b.filename}</p>
            <p class="text-xs text-slate-500">
              ${x(b)} \xB7 ${X(b.size)}
            </p>
          </div>
        `,b.id===ke&&(B.classList.add("ring-2","ring-[#9C6BFF]"),window.setTimeout(()=>{B.classList.remove("ring-2","ring-[#9C6BFF]")},1600)),B.addEventListener("click",()=>be(b.id)),o.appendChild(B)}),ke=null},oe=b=>{if(S){if(S.innerHTML="",!b.usedIn||b.usedIn.length===0){let B=document.createElement("li");B.textContent="Non utilis\xE9",B.className="text-xs text-slate-400",S.appendChild(B);return}b.usedIn.forEach(B=>{let h=document.createElement("li");h.textContent=B,h.className="text-xs text-slate-600",S.appendChild(h)})}},ce=b=>{if($){if(G){$.textContent=b?"T\xE9l\xE9versement\u2026":"T\xE9l\xE9verser",$.disabled=b||!Te,F&&F.classList.add("hidden");return}$.textContent=b?"Enregistrement\u2026":"Enregistrer",$.disabled=b||!Ee,F&&(F.classList.remove("hidden"),F.disabled=!Q)}},be=b=>{let B=K.find(h=>h.id===b);if(!B){J(),I();return}g(),Q=B.id,Ee=!1,ce(!1),I(),p==null||p.classList.add("hidden"),v==null||v.classList.remove("hidden"),V&&(N(B)?V.innerHTML=`<img src="${B.path}" alt="${B.alt||B.filename}" class="h-full w-full rounded-2xl object-cover" />`:V.innerHTML='<div class="flex h-full w-full flex-col items-center justify-center gap-1 text-slate-400"><span class="text-3xl">\u{1F4C4}</span><span class="text-xs font-semibold">Document</span></div>'),H&&(H.textContent=B.filename||"Fichier"),W&&(W.textContent=x(B)),se&&(se.textContent=X(B.size)),T&&(T.value=B.alt||""),_&&(_.textContent=B.path||"\u2014"),oe(B)},pe=b=>{if(b){if(G=!0,Ee=!1,Q=null,p==null||p.classList.add("hidden"),v==null||v.classList.remove("hidden"),Ie&&URL.revokeObjectURL(Ie),Ie=URL.createObjectURL(b),V&&(V.innerHTML=`<img src="${Ie}" alt="${b.name}" class="h-full w-full rounded-2xl object-cover" />`),H&&(H.textContent=b.name),W&&(W.textContent=x({type:b.type,filename:b.name})),se&&(se.textContent=X(b.size)),T&&!T.value.trim()&&(T.value=b.name.replace(/\.[^.]+$/,"").replace(/[-_]/g," ")),_&&(_.textContent="En attente de t\xE9l\xE9versement"),S){S.innerHTML="";let B=document.createElement("li");B.textContent="Non utilis\xE9",B.className="text-xs text-slate-400",S.appendChild(B)}ce(!1)}},Ce=()=>{let b=(f==null?void 0:f.value)||"all";b==="all"?te=[...K]:te=K.filter(B=>B.groupType===b),te.some(B=>B.id===Q)||J(),R(),I()},ge=async()=>{if(!D){n==null||n.classList.remove("hidden");return}try{let b=await fetch(D,{headers:{Accept:"application/json"}});if(!b.ok)throw new Error("Impossible de charger les m\xE9dias.");let B=await b.json().catch(()=>({items:[]}));K=Array.isArray(B.items)?B.items.map(h=>({...h,groupType:$e(h)})):[],Ce()}catch(b){console.error("[media] load failed",b),M(b.message||"Impossible de charger les m\xE9dias."),K=[],Ce()}};f==null||f.addEventListener("change",()=>{Ce()}),T==null||T.addEventListener("input",()=>{if(G){ce(!1);return}Q&&(Ee=!0,ce(!1))});let Ne=b=>{if(b){if(!b.type.startsWith("image/")){M("Seules les images sont accept\xE9es pour le moment.");return}if(b.size>4*1024*1024){M("Fichier trop volumineux (4 Mo max).");return}Te=b,pe(b),q&&(q.textContent=`${b.name} \xB7 ${X(b.size)}`)}},Ue=b=>new Promise((B,h)=>{let de=new FileReader;de.onload=()=>{let Pt=de.result||"",[,ts=""]=String(Pt).split(",");B(ts)},de.onerror=()=>h(new Error("Impossible de lire ce fichier.")),de.readAsDataURL(b)}),xe=async()=>{if(!(!Te||!D)){Ge=!0,ce(!0);try{let b=await Ue(Te),B={filename:Te.name,type:Te.type,size:Te.size,alt:(T==null?void 0:T.value)||"",data:b},h=await fetch(D,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(B)});if(!h.ok){let Pt=await h.json().catch(()=>({}));throw new Error(Pt.message||"Upload impossible.")}let de=await h.json();de.groupType=$e(de),K=[...K,de],ke=de.id,Ce(),be(de.id),M("M\xE9dia ajout\xE9"),g()}catch(b){console.error("[media] upload failed",b),M(b.message||"Impossible de t\xE9l\xE9verser ce m\xE9dia.")}finally{Ge=!1,Te=null,ce(!1)}}};L==null||L.addEventListener("click",()=>w==null?void 0:w.click()),w==null||w.addEventListener("change",()=>{w.files&&w.files[0]&&Ne(w.files[0])});let Me=()=>{P&&(P.classList.add("hidden"),P.classList.remove("flex"))},Re=()=>{if(!(!Q||G)){if(P){P.classList.remove("hidden"),P.classList.add("flex");return}window.confirm("Supprimer ce m\xE9dia ?")&&St()}},St=async()=>{if(!Q||!D){Me();return}let b=()=>{F&&(F.disabled=!0),k&&(k.disabled=!0,k.textContent="Suppression\u2026")},B=()=>{F&&(F.disabled=!1),k&&(k.disabled=!1,k.textContent="Supprimer")};b();try{let h=await fetch(`${D}/${encodeURIComponent(Q)}`,{method:"DELETE"});if(!h.ok){let de=await h.json().catch(()=>({}));throw new Error(de.message||"Suppression impossible.")}K=K.filter(de=>de.id!==Q),te=te.filter(de=>de.id!==Q),M("M\xE9dia supprim\xE9"),J(),R(),I()}catch(h){console.error("[media] delete failed",h),M(h.message||"Impossible de supprimer ce m\xE9dia.")}finally{B(),Me()}};U==null||U.addEventListener("click",Me),P==null||P.addEventListener("click",b=>{b.target===P&&Me()}),k==null||k.addEventListener("click",()=>St()),F==null||F.addEventListener("click",Re),$==null||$.addEventListener("click",async()=>{if(G){xe();return}if(!(!Q||!D||!T)){ce(!0);try{let b={alt:T.value||""},B=await fetch(`${D}/${encodeURIComponent(Q)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)});if(!B.ok){let de=await B.json().catch(()=>({}));throw new Error(de.message||"Impossible de mettre \xE0 jour ce m\xE9dia.")}let h=await B.json();K=K.map(de=>de.id===Q?{...de,...h}:de),te=te.map(de=>de.id===Q?{...de,...h}:de),Ee=!1,ce(!1),M("M\xE9dia mis \xE0 jour")}catch(b){console.error("[media] update failed",b),M(b.message||"\xC9chec de la mise \xE0 jour."),ce(!1)}}}),ge()}let Fo=document.getElementById("ai-chat-toggle"),ps=document.getElementById("ai-chat-panel"),it=document.getElementById("ai-chat-overlay"),No=document.getElementById("ai-chat-close"),Do=document.getElementById("ai-chat-clear"),Ho=document.getElementById("ai-chat-form"),Bt=document.getElementById("ai-chat-input"),Ae=document.getElementById("ai-chat-messages"),Ta=document.getElementById("ai-chat-status"),wt=document.getElementById("ai-chat-no-api"),An=document.querySelectorAll("[data-ai-quick]"),oo=!1,Uo=!1,wr=!1,Tn=!1;function In(){ps&&(oo=!0,ps.classList.remove("translate-x-full"),ps.setAttribute("aria-hidden","false"),it==null||it.classList.remove("opacity-0","pointer-events-none"),it==null||it.classList.add("opacity-100"),document.body.classList.add("overflow-hidden"),Bt==null||Bt.focus(),wr||$n())}function ro(){ps&&(oo=!1,ps.classList.add("translate-x-full"),ps.setAttribute("aria-hidden","true"),it==null||it.classList.add("opacity-0","pointer-events-none"),it==null||it.classList.remove("opacity-100"),document.body.classList.remove("overflow-hidden"))}async function $n(){let o=Pe(re.slug||"");if(!o){wt==null||wt.classList.remove("hidden");return}try{let n=await fetch(`/api/sites/${encodeURIComponent(o)}/config/ai`);if(!n.ok)throw new Error("Config check failed");let c=await n.json();wr=!0,Tn=c.hasApiKey,!c.enabled||!c.hasApiKey?wt==null||wt.classList.remove("hidden"):(wt==null||wt.classList.add("hidden"),Bn())}catch(n){console.error("[AI] Config check failed:",n),wt==null||wt.classList.remove("hidden")}}async function Bn(){let o=Pe(re.slug||"");if(!(!o||!Ae))try{let n=await fetch(`/api/sites/${encodeURIComponent(o)}/ai/history`);if(!n.ok)return;let c=await n.json();if(c.messages&&c.messages.length>0){let f=Ae.querySelector("[data-ai-welcome]");f&&f.remove(),c.messages.forEach(p=>{no(p.content,p.role==="user"?"user":"assistant")}),Ae.scrollTop=Ae.scrollHeight}}catch(n){console.error("[AI] History load failed:",n)}}function no(o,n="assistant"){if(!Ae)return;let c=document.createElement("div");if(c.className="flex gap-3",n==="user")c.innerHTML=`
        <div class="flex-1"></div>
        <div class="max-w-[80%] bg-violet-600 text-white rounded-2xl rounded-tr-none p-3">
          <p class="text-sm whitespace-pre-wrap">${pt(o)}</p>
        </div>
        <div class="w-8 h-8 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center">
          <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
        </div>
      `;else{let f=jn(o);c.innerHTML=`
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-violet-500 to-indigo-600 flex-shrink-0 flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
          </svg>
        </div>
        <div class="flex-1 bg-slate-50 rounded-2xl rounded-tl-none p-3 overflow-x-auto">
          <div class="text-sm text-slate-700 prose prose-sm max-w-none [&>pre]:bg-slate-800 [&>pre]:text-slate-100 [&>pre]:rounded-lg [&>pre]:p-3 [&>pre]:overflow-x-auto [&>code]:bg-slate-200 [&>code]:px-1 [&>code]:rounded">${f}</div>
        </div>
      `}Ae.appendChild(c),Ae.scrollTop=Ae.scrollHeight}function Pn(){if(!Ae)return;let o=document.createElement("div");o.className="flex gap-3",o.id="ai-loading-indicator",o.innerHTML=`
      <div class="w-8 h-8 rounded-full bg-gradient-to-br from-violet-500 to-indigo-600 flex-shrink-0 flex items-center justify-center">
        <svg class="w-4 h-4 text-white animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
        </svg>
      </div>
      <div class="flex-1 bg-slate-50 rounded-2xl rounded-tl-none p-3">
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 bg-violet-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
          <div class="w-2 h-2 bg-violet-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
          <div class="w-2 h-2 bg-violet-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
        </div>
      </div>
    `,Ae.appendChild(o),Ae.scrollTop=Ae.scrollHeight}function Sr(){let o=document.getElementById("ai-loading-indicator");o==null||o.remove()}function jn(o){if(!o)return"";let n=pt(o);return n=n.replace(/```(\w*)\n([\s\S]*?)```/g,(c,f,p)=>`<pre class="language-${f||"text"}"><code>${p.trim()}</code></pre>`),n=n.replace(/`([^`]+)`/g,"<code>$1</code>"),n=n.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),n=n.replace(/\*([^*]+)\*/g,"<em>$1</em>"),n=n.replace(/^### (.+)$/gm,'<h4 class="font-semibold text-slate-900 mt-3 mb-1">$1</h4>'),n=n.replace(/^## (.+)$/gm,'<h3 class="font-semibold text-slate-900 mt-3 mb-1">$1</h3>'),n=n.replace(/^# (.+)$/gm,'<h2 class="font-bold text-slate-900 mt-3 mb-2">$1</h2>'),n=n.replace(/^- (.+)$/gm,'<li class="ml-4">$1</li>'),n=n.replace(/^(\d+)\. (.+)$/gm,'<li class="ml-4">$2</li>'),n=n.replace(/\n\n/g,'</p><p class="mb-2">'),n='<p class="mb-2">'+n+"</p>",n=n.replace(/<p class="mb-2"><\/p>/g,""),n}function pt(o){let n=document.createElement("div");return n.textContent=o,n.innerHTML}async function Lr(o){let n=Pe(re.slug||"");if(!o||!n||Uo)return;Uo=!0,Bt.disabled=!0;let c=Ae==null?void 0:Ae.querySelector("[data-ai-welcome]");c&&c.remove(),no(o,"user"),Pn();try{let f=await fetch(`/api/sites/${encodeURIComponent(n)}/ai/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:o})});if(Sr(),!f.ok){let v=await f.json().catch(()=>({}));throw new Error(v.message||"Erreur de communication")}let p=await f.json();p.response&&no(p.response,"assistant"),p.editProposal&&Mn(p.editProposal),p.themeProposal&&Fn(p.themeProposal)}catch(f){Sr(),no(`\u274C Erreur: ${f.message}`,"assistant")}finally{Uo=!1,Bt.disabled=!1,Bt.focus()}}function Mn(o){var f,p;if(!Ae||!o)return;let n=document.createElement("div");n.className="flex gap-3 mt-2",n.dataset.proposalId=o.proposalId;let c="";if(o.changes&&(o.changes.title&&(c+=`<li>Titre \u2192 <strong>${pt(o.changes.title)}</strong></li>`),o.changes.description&&(c+=`<li>Description \u2192 ${pt(o.changes.description.substring(0,80))}...</li>`),o.changes.seo&&(o.changes.seo.metaTitle&&(c+=`<li>Meta title \u2192 ${pt(o.changes.seo.metaTitle)}</li>`),o.changes.seo.metaDescription&&(c+=`<li>Meta description \u2192 ${pt(o.changes.seo.metaDescription.substring(0,60))}...</li>`)),o.changes.blockUpdate&&(c+=`<li>Bloc "${o.changes.blockUpdate.blockId}" modifi\xE9</li>`,o.changes.blockUpdate.settings))){let v=o.changes.blockUpdate.settings;v.title&&(c+=`<li class="ml-4">\u2192 title: ${pt(v.title)}</li>`),v.content&&(c+='<li class="ml-4">\u2192 content modifi\xE9</li>')}n.innerHTML=`
      <div class="w-8 h-8 rounded-full bg-amber-500 flex-shrink-0 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
        </svg>
      </div>
      <div class="flex-1 bg-amber-50 border border-amber-200 rounded-2xl rounded-tl-none p-4">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-xs font-semibold text-amber-700 bg-amber-100 px-2 py-0.5 rounded">Proposition d'\xE9dition</span>
        </div>
        <p class="text-sm font-medium text-slate-800 mb-1">Page : ${pt(o.pageTitle||o.pageId)}</p>
        ${o.reason?`<p class="text-sm text-slate-600 mb-2">${pt(o.reason)}</p>`:""}
        <ul class="text-xs text-slate-600 space-y-1 mb-3 list-disc ml-4">
          ${c||"<li>Modifications propos\xE9es</li>"}
        </ul>
        <div class="flex gap-2">
          <button 
            class="ai-apply-edit px-3 py-1.5 text-xs font-medium text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg transition-colors flex items-center gap-1"
            data-proposal-id="${o.proposalId}"
          >
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Appliquer
          </button>
          <button 
            class="ai-reject-edit px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors flex items-center gap-1"
            data-proposal-id="${o.proposalId}"
          >
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            Rejeter
          </button>
        </div>
      </div>
    `,Ae.appendChild(n),Ae.scrollTop=Ae.scrollHeight,(f=n.querySelector(".ai-apply-edit"))==null||f.addEventListener("click",Hn),(p=n.querySelector(".ai-reject-edit"))==null||p.addEventListener("click",kr)}function Fn(o){var p,v,V,H;if(!Ae||!o)return;let n=document.createElement("div");n.className="flex gap-3 mt-2",n.dataset.proposalId=o.proposalId;let c="";if((p=o.changes)!=null&&p.colors){let W=o.changes.colors;for(let[se,_]of Object.entries(W))c+=`<li class="flex items-center gap-2">
          <span class="w-4 h-4 rounded border border-slate-300" style="background: ${Nn(_)}"></span>
          <span>${se}: <strong>${pt(_)}</strong></span>
        </li>`}let f="";if((v=o.changes)!=null&&v.typography){let W=o.changes.typography;W.headings&&(f+=`<li>Titres \u2192 <strong>${pt(W.headings)}</strong></li>`),W.body&&(f+=`<li>Textes \u2192 <strong>${pt(W.body)}</strong></li>`)}n.innerHTML=`
      <div class="w-8 h-8 rounded-full bg-purple-500 flex-shrink-0 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
        </svg>
      </div>
      <div class="flex-1 bg-purple-50 border border-purple-200 rounded-2xl rounded-tl-none p-4">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-xs font-semibold text-purple-700 bg-purple-100 px-2 py-0.5 rounded">Modification du th\xE8me</span>
        </div>
        ${o.reason?`<p class="text-sm text-slate-600 mb-3">${pt(o.reason)}</p>`:""}
        ${c?`
          <p class="text-xs font-medium text-slate-700 mb-1">Couleurs :</p>
          <ul class="text-xs text-slate-600 space-y-1 mb-3">${c}</ul>
        `:""}
        ${f?`
          <p class="text-xs font-medium text-slate-700 mb-1">Typographies :</p>
          <ul class="text-xs text-slate-600 space-y-1 mb-3 list-disc ml-4">${f}</ul>
        `:""}
        <div class="flex gap-2">
          <button 
            class="ai-apply-theme px-3 py-1.5 text-xs font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors flex items-center gap-1"
            data-proposal-id="${o.proposalId}"
          >
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Appliquer
          </button>
          <button 
            class="ai-reject-theme px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors flex items-center gap-1"
            data-proposal-id="${o.proposalId}"
          >
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            Rejeter
          </button>
        </div>
      </div>
    `,Ae.appendChild(n),Ae.scrollTop=Ae.scrollHeight,(V=n.querySelector(".ai-apply-theme"))==null||V.addEventListener("click",Dn),(H=n.querySelector(".ai-reject-theme"))==null||H.addEventListener("click",kr)}function Nn(o){return{white:"#ffffff",black:"#000000",transparent:"transparent","slate-50":"#f8fafc","slate-100":"#f1f5f9","slate-200":"#e2e8f0","slate-300":"#cbd5e1","slate-400":"#94a3b8","slate-500":"#64748b","slate-600":"#475569","slate-700":"#334155","slate-800":"#1e293b","slate-900":"#0f172a","gray-50":"#f9fafb","gray-100":"#f3f4f6","gray-200":"#e5e7eb","gray-300":"#d1d5db","gray-400":"#9ca3af","gray-500":"#6b7280","gray-600":"#4b5563","gray-700":"#374151","gray-800":"#1f2937","gray-900":"#111827","violet-50":"#f5f3ff","violet-100":"#ede9fe","violet-200":"#ddd6fe","violet-300":"#c4b5fd","violet-400":"#a78bfa","violet-500":"#8b5cf6","violet-600":"#7c3aed","violet-700":"#6d28d9","violet-800":"#5b21b6","violet-900":"#4c1d95","purple-50":"#faf5ff","purple-100":"#f3e8ff","purple-200":"#e9d5ff","purple-300":"#d8b4fe","purple-400":"#c084fc","purple-500":"#a855f7","purple-600":"#9333ea","purple-700":"#7e22ce","purple-800":"#6b21a8","purple-900":"#581c87","blue-50":"#eff6ff","blue-100":"#dbeafe","blue-200":"#bfdbfe","blue-300":"#93c5fd","blue-400":"#60a5fa","blue-500":"#3b82f6","blue-600":"#2563eb","blue-700":"#1d4ed8","blue-800":"#1e40af","blue-900":"#1e3a8a","emerald-50":"#ecfdf5","emerald-100":"#d1fae5","emerald-200":"#a7f3d0","emerald-300":"#6ee7b7","emerald-400":"#34d399","emerald-500":"#10b981","emerald-600":"#059669","emerald-700":"#047857","emerald-800":"#065f46","emerald-900":"#064e3b","teal-50":"#f0fdfa","teal-100":"#ccfbf1","teal-200":"#99f6e4","teal-300":"#5eead4","teal-400":"#2dd4bf","teal-500":"#14b8a6","teal-600":"#0d9488","teal-700":"#0f766e","teal-800":"#115e59","teal-900":"#134e4a","amber-50":"#fffbeb","amber-100":"#fef3c7","amber-200":"#fde68a","amber-300":"#fcd34d","amber-400":"#fbbf24","amber-500":"#f59e0b","amber-600":"#d97706","amber-700":"#b45309","amber-800":"#92400e","amber-900":"#78350f","red-50":"#fef2f2","red-100":"#fee2e2","red-200":"#fecaca","red-300":"#fca5a5","red-400":"#f87171","red-500":"#ef4444","red-600":"#dc2626","red-700":"#b91c1c","red-800":"#991b1b","red-900":"#7f1d1d"}[o]||"#9C6BFF"}async function Dn(o){var p;let n=(p=o.target.closest("[data-proposal-id]"))==null?void 0:p.dataset.proposalId,c=Pe(re.slug||"");if(!n||!c)return;let f=o.target.closest("button");f.disabled=!0,f.innerHTML='<span class="animate-spin">\u23F3</span> Application...';try{let v=await fetch(`/api/sites/${encodeURIComponent(c)}/ai/apply-theme`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({proposalId:n})}),V=await v.json();if(v.ok&&V.success){let H=document.querySelector(`[data-proposal-id="${n}"]`);H&&(H.innerHTML=`
            <div class="w-8 h-8 rounded-full bg-purple-500 flex-shrink-0 flex items-center justify-center">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <div class="flex-1 bg-purple-50 border border-purple-200 rounded-2xl rounded-tl-none p-3">
              <p class="text-sm text-purple-700">\u2705 Th\xE8me mis \xE0 jour avec succ\xE8s !</p>
              <p class="text-xs text-purple-600 mt-1">Rechargez la preview pour voir les changements.</p>
            </div>
          `),M("Th\xE8me mis \xE0 jour !"),document.dispatchEvent(new CustomEvent("ai-theme-updated",{detail:{updatedTheme:V.updatedTheme}}))}else throw new Error(V.message||"Erreur lors de l'application")}catch(v){f.disabled=!1,f.innerHTML='<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> R\xE9essayer',M(`Erreur: ${v.message}`)}}async function Hn(o){var p,v;let n=(p=o.target.closest("[data-proposal-id]"))==null?void 0:p.dataset.proposalId,c=Pe(re.slug||"");if(!n||!c)return;let f=o.target.closest("button");f.disabled=!0,f.innerHTML='<span class="animate-spin">\u23F3</span> Application...';try{let V=await fetch(`/api/sites/${encodeURIComponent(c)}/ai/apply-edit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({proposalId:n})}),H=await V.json();if(V.ok&&H.success){let W=document.querySelector(`[data-proposal-id="${n}"]`);W&&(W.innerHTML=`
            <div class="w-8 h-8 rounded-full bg-emerald-500 flex-shrink-0 flex items-center justify-center">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <div class="flex-1 bg-emerald-50 border border-emerald-200 rounded-2xl rounded-tl-none p-3">
              <p class="text-sm text-emerald-700">\u2705 Modifications appliqu\xE9es avec succ\xE8s !</p>
              <p class="text-xs text-emerald-600 mt-1">La preview se met \xE0 jour automatiquement.</p>
            </div>
          `),M("Modifications appliqu\xE9es !");let se=((v=H.updatedPage)==null?void 0:v.id)||null;document.dispatchEvent(new CustomEvent("ai-page-updated",{detail:{pageId:se,updatedPage:H.updatedPage}}))}else throw new Error(H.message||"Erreur lors de l'application")}catch(V){f.disabled=!1,f.innerHTML='<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> R\xE9essayer',M(`Erreur: ${V.message}`)}}async function kr(o){var f;let n=(f=o.target.closest("[data-proposal-id]"))==null?void 0:f.dataset.proposalId,c=Pe(re.slug||"");if(!(!n||!c))try{await fetch(`/api/sites/${encodeURIComponent(c)}/ai/proposal/${n}`,{method:"DELETE"});let p=document.querySelector(`[data-proposal-id="${n}"]`);p&&(p.innerHTML=`
          <div class="w-8 h-8 rounded-full bg-slate-400 flex-shrink-0 flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </div>
          <div class="flex-1 bg-slate-100 rounded-2xl rounded-tl-none p-3">
            <p class="text-sm text-slate-500">Proposition rejet\xE9e.</p>
          </div>
        `)}catch(p){console.error("[AI] Reject edit error:",p)}}async function Un(){let o=Pe(re.slug||"");if(!(!o||!Ae))try{await fetch(`/api/sites/${encodeURIComponent(o)}/ai/history`,{method:"DELETE"}),Ae.innerHTML="",Ae.innerHTML=`
        <div class="flex gap-3" data-ai-welcome>
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-violet-500 to-indigo-600 flex-shrink-0 flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
            </svg>
          </div>
          <div class="flex-1 bg-slate-50 rounded-2xl rounded-tl-none p-3">
            <p class="text-sm text-slate-700">
              Salut ! \u{1F44B} Je suis ton assistant IA pour ce site. Je peux t'aider \xE0 :
            </p>
            <ul class="mt-2 text-sm text-slate-600 space-y-1">
              <li>\u{1F3A8} Sugg\xE9rer des palettes de couleurs</li>
              <li>\u270D\uFE0F G\xE9n\xE9rer du contenu pour tes blocs</li>
              <li>\u{1F4C4} Cr\xE9er des structures de pages</li>
              <li>\u{1F50D} Am\xE9liorer ton SEO</li>
              <li>\u270F\uFE0F <strong>Analyser et modifier tes pages</strong> (avec validation)</li>
            </ul>
          </div>
        </div>
      `,M("Historique effac\xE9")}catch(n){console.error("[AI] Clear history failed:",n),M("Erreur lors de l'effacement")}}let Rn={colors:"Sugg\xE8re-moi 3 palettes de couleurs harmonieuses pour mon site. Pour chaque palette, donne les couleurs Tailwind: primary, secondary, accent, et background.",hero:"G\xE9n\xE8re un bloc Hero en JSON avec un titre accrocheur, un sous-titre engageant et un CTA.",seo:"Analyse mon site et sugg\xE8re des am\xE9liorations SEO pour le meta title et la meta description de ma page d'accueil.",landing:"G\xE9n\xE8re la structure JSON d'une landing page compl\xE8te avec: Hero, 3 sections de contenu, et un CTA final.",analyze:"Analyse le contenu de toutes mes pages et propose des am\xE9liorations concr\xE8tes. Pour chaque suggestion d'am\xE9lioration de texte ou de structure, utilise le format propose-edit pour que je puisse valider.",improveHome:"Analyse ma page d'accueil et propose une am\xE9lioration du titre ou du Hero pour le rendre plus impactant. Utilise le format propose-edit."};Fo==null||Fo.addEventListener("click",()=>{oo?ro():In()}),No==null||No.addEventListener("click",ro),it==null||it.addEventListener("click",ro),Do==null||Do.addEventListener("click",()=>{confirm("Effacer tout l'historique de conversation ?")&&Un()}),Ho==null||Ho.addEventListener("submit",o=>{var c;o.preventDefault();let n=(c=Bt==null?void 0:Bt.value)==null?void 0:c.trim();n&&(Bt.value="",Lr(n))}),An.forEach(o=>{o.addEventListener("click",()=>{let n=o.dataset.aiQuick,c=Rn[n];c&&Lr(c)})}),document.addEventListener("keydown",o=>{o.key==="Escape"&&oo&&ro()})});})();
