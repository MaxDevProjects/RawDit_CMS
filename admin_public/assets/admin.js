(()=>{document.addEventListener("DOMContentLoaded",()=>{console.log("[admin] Atelier charg\xE9");let Ct=document.querySelector("[data-logout]");Ct&&Ct.addEventListener("click",async()=>{Ct.disabled=!0;try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(n){console.error("[admin] Impossible de se d\xE9connecter",n)}finally{window.location.href="/admin/index.html"}});let We=document.querySelector("[data-admin-sidebar]"),ye=document.querySelector("[data-admin-sidebar-overlay]"),Jt=document.querySelectorAll("[data-admin-sidebar-toggle]"),is=document.querySelectorAll("[data-admin-sidebar-close]"),Et=document.body,it=!1,lt=()=>{if(!We)return;if(window.matchMedia("(min-width: 1024px)").matches){We.classList.remove("hidden"),ye==null||ye.classList.add("hidden"),Et.classList.remove("overflow-hidden");return}it?(We.classList.remove("hidden"),ye==null||ye.classList.remove("hidden"),Et.classList.add("overflow-hidden")):(We.classList.add("hidden"),ye==null||ye.classList.add("hidden"),Et.classList.remove("overflow-hidden"))},ls=()=>{it=!0,lt()},qt=()=>{it=!1,lt()};We&&Jt.length>0&&(Jt.forEach(n=>{n.addEventListener("click",ls)}),is.forEach(n=>{n.addEventListener("click",qt)}),ye==null||ye.addEventListener("click",qt),window.addEventListener("resize",lt),window.addEventListener("keydown",n=>{n.key==="Escape"&&it&&qt()}),lt());let Wt="clower:currentSite",Gt="clower:currentSiteName",ee={slug:null,name:""};(()=>{try{ee.slug=window.localStorage.getItem(Wt),ee.name=window.localStorage.getItem(Gt)||""}catch{ee.slug=null,ee.name=""}})();let kt=document.querySelectorAll("[data-site-card]"),cs=document.querySelectorAll("[data-site-select]"),Ge=document.querySelector("[data-current-site-name]"),_t=document.querySelector("[data-workspace-site-name]"),Yt=document.querySelector("[data-workspace-back-name]"),Te=document.querySelector("[data-workspace-back-modal]"),ds=document.querySelectorAll("[data-workspace-back]"),us=document.querySelectorAll("[data-workspace-back-cancel]"),At=document.querySelector("[data-workspace-back-confirm]"),ms=document.querySelectorAll("[data-workspace-tab]"),It=document.querySelector("[data-site-toast]"),Kt=document.querySelector("[data-site-toast-message]"),ps=document.querySelectorAll("[data-site-create]"),ue=document.querySelector("[data-site-modal]"),ke=document.querySelector("[data-site-form]"),xe=document.querySelector("[data-site-name]"),Le=document.querySelector("[data-site-slug]"),fe=document.querySelector("[data-site-slug-error]"),Ce=document.querySelector("[data-site-modal-error]"),fs=document.querySelectorAll("[data-site-modal-cancel]"),He=document.querySelector("[data-site-modal-submit]"),X=ws(),ct=!1,dt=null,Bt=null,gs='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',Xt=n=>{if(!ue||ue.classList.contains("hidden")||n.key!=="Tab")return;let d=Array.from(ue.querySelectorAll(gs)).filter(q=>!q.hasAttribute("disabled")&&!q.getAttribute("aria-hidden"));if(d.length===0)return;let h=d[0],c=d[d.length-1];n.shiftKey?document.activeElement===h&&(n.preventDefault(),c.focus()):document.activeElement===c&&(n.preventDefault(),h.focus())},W=n=>{!It||!Kt||(Kt.textContent=n,It.classList.remove("hidden"),Bt&&clearTimeout(Bt),Bt=setTimeout(()=>{It.classList.add("hidden")},2500))};function Ae(n){return n?n.startsWith("/")?n:`/${n}`:""}function Ie(n){return(n==null?void 0:n.replace(/^\//,""))||""}let ut=(n,d)=>{let h=n?Ae(n):null;try{h&&(window.localStorage.setItem(Wt,h),ee.slug=h),typeof d=="string"&&d.length>0&&(window.localStorage.setItem(Gt,d),ee.name=d)}catch{ee.slug=h||ee.slug,ee.name=d||ee.name}},Zt=n=>{Ge&&n&&(Ge.textContent=n),_t&&n&&(_t.textContent=n),Yt&&n&&(Yt.textContent=n)},Tt=n=>{ms.forEach(d=>{let h=d.dataset.workspaceTab;if(!h)return;if(!n){d.href="#",d.classList.add("pointer-events-none","opacity-50","text-slate-400"),d.setAttribute("aria-disabled","true");return}let c=encodeURIComponent(Ie(n));d.href=`/admin/site/${c}/${h}`,d.classList.remove("pointer-events-none","opacity-50","text-slate-400"),d.removeAttribute("aria-disabled")})},mt=(n,d={})=>{if(!n)return;let h=Ae(n),c=d.siteName||ee.name||(Ge==null?void 0:Ge.dataset.defaultSiteName)||"";kt.forEach(E=>{let w=Ae(E.dataset.siteCard||"")===h,l=E.querySelector("[data-site-active-badge]");w?(E.classList.add("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),E.classList.remove("border-slate-200"),l==null||l.classList.remove("hidden"),c=E.dataset.siteName||c):(E.classList.remove("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),E.classList.add("border-slate-200"),l==null||l.classList.add("hidden"))}),d.persist!==!1&&ut(h,d.siteName||c);let q=d.siteName||c;Zt(q),Tt(h)},hs=async(n,d)=>{let h=Ae(n);try{let c=await fetch("/api/sites/select",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slug:h})});if(!c.ok){let l=await c.json().catch(()=>({}));W(l.message||"Impossible de s\xE9lectionner ce site.");return}let q=await c.json().catch(()=>({})),E=Ae(q.slug||h),b=q.name||d;ut(E,b),mt(E,{siteName:b,persist:!1});let w=encodeURIComponent(Ie(E));window.location.href=`/admin/site/${w}/design`}catch(c){console.error("[admin] Impossible de s\xE9lectionner le site",c),W("Erreur inattendue lors de la s\xE9lection.")}},ys=async()=>{try{let n=await fetch("/api/sites/current",{credentials:"same-origin"});if(!n.ok){n.status===404&&X&&(window.location.href="/admin/sites");return}let d=await n.json(),h=Ae(d.slug);ut(h,d.name),mt(h,{siteName:d.name,persist:!1})}catch(n){console.warn("[admin] Impossible de r\xE9cup\xE9rer le site actif",n)}};(()=>{if(ee.slug){mt(ee.slug,{siteName:ee.name,persist:!1});return}let n=document.querySelector('[data-site-card][data-site-default="true"]')||kt[0];n&&mt(n.dataset.siteCard,{siteName:n.dataset.siteName||"",persist:!1})})(),ys(),X?Tt(X.slugValue):ee.slug&&Tt(ee.slug),cs.forEach(n=>{n.addEventListener("click",()=>{if(n.disabled)return;let d=n.dataset.siteSelect,h=n.dataset.siteSelectName||"Ce site";d&&(n.disabled=!0,hs(d,h).finally(()=>{n.disabled=!1}))})});let _e=n=>n.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),vs=n=>{let d=_e(n||"");return d?`/${d}`:""},bs=()=>{ue&&(dt=document.activeElement,ue.classList.remove("hidden"),ue.classList.add("flex"),ct=!1,ke==null||ke.reset(),fe&&(fe.textContent=""),Ce&&(Ce.textContent=""),Le&&xe&&(Le.value=_e(xe.value)),document.addEventListener("keydown",Xt),window.setTimeout(()=>{xe==null||xe.focus()},0))},pt=()=>{ue&&(ue.classList.add("hidden"),ue.classList.remove("flex"),document.removeEventListener("keydown",Xt),ct=!1,ke==null||ke.reset(),fe&&(fe.textContent=""),Ce&&(Ce.textContent=""),dt==null||dt.focus())};ps.forEach(n=>{n.addEventListener("click",bs)}),fs.forEach(n=>{n.addEventListener("click",pt)}),ue==null||ue.addEventListener("click",n=>{n.target===ue&&pt()}),xe==null||xe.addEventListener("input",()=>{Le&&(!ct||Le.value.trim().length===0)&&(Le.value=_e(xe.value))}),Le==null||Le.addEventListener("input",()=>{ct=!0,fe&&(fe.textContent="")});let xs=()=>new Set(Array.from(kt).map(n=>Ae(n.dataset.siteCard||"")));ke==null||ke.addEventListener("submit",async n=>{if(n.preventDefault(),!xe||!Le)return;let d=(xe.value||"").trim(),h=Le.value||"";h||(h=d);let c=vs(h);if(!d||!c){fe&&(fe.textContent="Nom et slug sont requis.");return}if(xs().has(c)){fe&&(fe.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}fe&&(fe.textContent=""),Ce&&(Ce.textContent=""),He&&(He.disabled=!0,He.textContent="Cr\xE9ation...");try{let E=await fetch("/api/sites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:d,slug:c})});if(!E.ok){let O=await E.json().catch(()=>({})),k=O.message||"Impossible de cr\xE9er ce site.";Ce&&(Ce.textContent=k),O.field==="slug"&&fe&&(fe.textContent=k);return}let b=await E.json(),w=Ae((b==null?void 0:b.slug)||c),l=(b==null?void 0:b.name)||d;ut(w,l),pt();let _=encodeURIComponent(Ie(w));window.location.href=`/admin/site/${_}/design`}catch(E){console.error("[admin] Impossible de cr\xE9er le site",E),Ce&&(Ce.textContent="Erreur inattendue. R\xE9essaie dans un instant.")}finally{He&&(He.disabled=!1,He.textContent="Cr\xE9er")}}),window.addEventListener("keydown",n=>{n.key==="Escape"&&(ue&&!ue.classList.contains("hidden")&&pt(),Te&&!Te.classList.contains("hidden")&&Qt(),blockDeleteModal&&!blockDeleteModal.classList.contains("hidden")&&closeBlockDeleteModal(),blockLibraryOpen&&closeBlockLibrary())});function ws(){let n=window.location.pathname.match(/^\/admin\/site\/([^/]+)(?:\/([^/]+))?/);return n?{slugPart:decodeURIComponent(n[1]),slugValue:Ae(decodeURIComponent(n[1])),section:n[2]||"design"}:null}function Ss(){return document.querySelector("[data-page-list]")?"design":document.querySelector("[data-collection-list]")?"content":document.querySelector("[data-media-grid]")?"media":document.querySelector("[data-deploy-form]")?"deploy":null}function Ls(){if(!Te){window.location.href="/admin/sites";return}Te.classList.remove("hidden"),Te.classList.add("flex")}function Qt(){Te&&(Te.classList.add("hidden"),Te.classList.remove("flex"))}ds.forEach(n=>{n.addEventListener("click",Ls)}),us.forEach(n=>{n.addEventListener("click",Qt)}),At==null||At.addEventListener("click",()=>{window.location.href="/admin/sites"});let Ye=(X==null?void 0:X.section)||Ss();Ye==="design"&&Cs(),Ye==="content"&&Es(),Ye==="media"&&As(),Ye==="deploy"&&qs(),Ye==="settings"&&ks(),X&&ee.name&&Zt(ee.name);function Cs(){let n=document.querySelectorAll("[data-page-list]");if(n.length===0)return;let d=document.querySelector("[data-active-page-title]"),h=document.querySelector("[data-active-page-slug]"),c=document.querySelector("[data-page-preview-tags]"),q=document.querySelector("[data-page-preview-frame]"),E=document.querySelector("[data-preview-open]"),b=document.querySelector("[data-preview-status]"),w=document.querySelector("[data-preview-highlight]"),l=document.querySelector("[data-blocks-list]"),_=document.querySelector("[data-blocks-empty]"),O=document.querySelector("[data-block-count]"),k=document.querySelector("[data-block-library-toggle]"),T=document.querySelector("[data-block-library]"),I=document.querySelectorAll("[data-block-add]"),u=document.querySelector("[data-block-delete-modal]"),j=document.querySelector("[data-block-delete-confirm]"),D=document.querySelector("[data-block-delete-cancel]"),F=document.querySelector("[data-block-detail-empty]"),K=document.querySelector("[data-block-detail-status]"),$=document.querySelector("[data-block-editor]"),te=document.querySelector("[data-block-editor-block-name]"),R=document.querySelector("[data-block-editor-block-type]"),P=document.querySelector("[data-block-editor-unsupported]"),v=document.querySelector("[data-block-form]"),U=v?Array.from(v.querySelectorAll("[data-editor-section]")):[],x=v==null?void 0:v.querySelector('[name="collection-grid-collection"]'),Y=v==null?void 0:v.querySelector("[data-collection-selection-info]"),M=document.querySelector("[data-block-form-cancel]"),H=v==null?void 0:v.querySelector("[data-group-preview-mobile]"),i=v==null?void 0:v.querySelector("[data-group-preview-desktop]"),m={hero:{section:"hero",labelField:"title",descriptionField:"subtitle",fields:{title:"hero-title",subtitle:"hero-subtitle",ctaLabel:"hero-cta-label",ctaUrl:"hero-cta-url",image:"hero-image",align:"hero-align"}},paragraphe:{section:"paragraph",labelField:"title",descriptionField:"content",fields:{title:"paragraph-title",content:"paragraph-content",align:"paragraph-align"}},image:{section:"image",labelField:"alt",fields:{src:"image-src",alt:"image-alt",showCaption:"image-caption-toggle",caption:"image-caption"}},groupe:{section:"group",fields:{layout:"group-layout",columnsMobile:"group-columns-mobile",columnsDesktop:"group-columns-desktop"}},collectiongrid:{section:"collection",fields:{collectionId:"collection-grid-collection",limit:"collection-grid-limit"}}},N={texte:"paragraphe",paragraph:"paragraphe",paragraphs:"paragraphe",paragraphes:"paragraphe",text:"paragraphe",hero:"hero",image:"image",groupe:"groupe",group:"groupe",collection:"collectiongrid",collectiongrid:"collectiongrid","collection-grid":"collectiongrid"},f=(e,t)=>{if(!H||!i)return;let s=a=>Array.from({length:Number(a)||1}).map(()=>'<span class="block h-2 w-full rounded-full bg-slate-300"></span>').join("");H.innerHTML=s(e),i.innerHTML=s(t)},L=async()=>{if(!o)return[];let e=await fetch(o,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les pages.");let t=await e.json().catch(()=>[]);return Array.isArray(t)?t:[]},V=async({title:e,slug:t})=>{if(!o)throw new Error("Site inconnu.");let s=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,slug:t})});if(!s.ok){let a=await s.json().catch(()=>({}));throw new Error(a.message||"Impossible de cr\xE9er la page.")}return s.json().catch(()=>({}))},G=async e=>{if(!(!o||!(e!=null&&e.id)))try{let t=await fetch(`${o}/${encodeURIComponent(e.id)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let a=await t.json().catch(()=>({}));throw new Error(a.message||"Impossible de sauvegarder la page.")}let s=await t.json().catch(()=>({}));if(s!=null&&s.id){let a=nt(s);return me=me.map(y=>y.id===a.id?a:y),(B==null?void 0:B.id)===a.id&&(B=a),a}return s}catch(t){console.error("[design] Save page failed",t),W(t.message||"Sauvegarde impossible.")}},ae=async()=>{if(!o){me=[],Ee=null,B=null,jt(me,Ee),Qe(null),F==null||F.classList.remove("hidden"),$==null||$.classList.add("hidden");return}try{let e=await L();if(me=(Array.isArray(e)?e:[]).map(t=>nt(t)),me.length===0){Ee=null,B=null,jt(me,Ee),Qe(null),F==null||F.classList.remove("hidden"),$==null||$.classList.add("hidden"),q&&(q.srcdoc=re());return}Ee=Re(me),Pe(Ee)}catch(e){console.error("[design] Impossible de charger les pages",e),W("Impossible de charger les pages.")}},ne=e=>(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),oe=e=>{if(!e)return null;let t=ne(e.type),s=N[t]||t;return m[s]||null},ge=e=>{var s,a,y;if(!v||!$)return;e&&!e.settings&&(e.settings={});let t=oe(e);if(te&&(te.textContent=(e==null?void 0:e.label)||"Bloc"),R&&(R.textContent=(e==null?void 0:e.type)||"Bloc"),!t){v.classList.add("hidden"),P==null||P.classList.remove("hidden"),v.dataset.blockId="";return}if(P==null||P.classList.add("hidden"),v.classList.remove("hidden"),v.reset(),v.dataset.blockId=e.id,U.forEach(C=>{C.dataset.editorSection===t.section?C.classList.remove("hidden"):C.classList.add("hidden")}),t.section==="collection"){let C=e.collectionId||((s=e.settings)==null?void 0:s.collectionId)||"";wt(C)}if(Object.entries(t.fields).forEach(([C,Q])=>{var Ue;let se=v.querySelector(`[name="${Q}"]`);if(!se)return;let de=(Ue=e.settings)==null?void 0:Ue[C];se.type==="checkbox"?se.checked=!!de:se.type==="number"?se.value=de!=null?de:1:(se.tagName,se.value=de!=null?de:"")}),t.section==="group"){let C=((a=v.querySelector('[name="group-columns-mobile"]'))==null?void 0:a.value)||"1",Q=((y=v.querySelector('[name="group-columns-desktop"]'))==null?void 0:y.value)||"3";f(C,Q)}},he=e=>{if(!v||!e)return{};let t={};return Object.entries(e.fields).forEach(([s,a])=>{let y=v.querySelector(`[name="${a}"]`);if(y)if(y.type==="checkbox")t[s]=y.checked;else if(y.type==="number"){let C=Number(y.value);t[s]=Number.isFinite(C)?C:0}else y.tagName==="TEXTAREA"?t[s]=y.value||"":y.type==="select-one"?t[s]=y.value:t[s]=y.value||""}),t},Z=e=>{if(b){if(!e){b.classList.add("hidden");return}b.classList.remove("hidden"),b.textContent=e}},Ne=e=>e?{id:e.id,title:e.title,slug:e.slug,badges:[...e.badges||[]],blocks:(e.blocks||[]).map(t=>{var s;return{id:t.id,type:t.type,label:t.label,status:t.status,description:t.description,props:t.props||[],settings:t.settings||{},collectionId:t.collectionId||((s=t.settings)==null?void 0:s.collectionId)||""}})}:null,re=()=>'<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#475569;background:#fff;">Pr\xE9paration de la pr\xE9visualisation\u2026</body></html>',Fe=e=>{if(!q||!e)return;let t=(X==null?void 0:X.slugValue)||ee.slug||"",s={page:Ne(e),site:{title:ee.name||"Site",slug:t}};Rt=!1,Z("Actualisation\u2026"),q.srcdoc=re(),st&&st.abort();let a=new AbortController;st=a,fetch("/api/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s),signal:a.signal}).then(y=>{if(!y.ok)throw new Error("Preview error");return y.json()}).then(y=>{a.signal.aborted||(Dt=y.html||"",q.setAttribute("title",`Pr\xE9visualisation de la page ${e.title||""}`.trim()),q.srcdoc=Dt||re(),Z("\xC0 jour"))}).catch(y=>{a.signal.aborted||(console.error("[preview] Impossible de rendre la page",y),Z("Erreur preview"),q.srcdoc='<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#be123c;background:#fff;">Erreur lors du rendu de la pr\xE9visualisation.</body></html>')}).finally(()=>{st===a&&(st=null)})},Me=e=>{if(e.preventDefault(),!B||!pe)return;let t=$t(),s=oe(t);if(!t||!s)return;let a=he(s);if(s.section==="collection"){if(!a.collectionId){W("S\xE9lectionnez une collection.");return}a.limit=Math.max(1,Number(a.limit)||1)}let y=(B.blocks||[]).map(C=>{if(C.id!==t.id)return C;let Q={...C.settings||{},...a},se={...C,settings:Q};return s.labelField&&a[s.labelField]&&(se.label=a[s.labelField]),s.descriptionField&&a[s.descriptionField]&&(se.description=a[s.descriptionField]),s.section==="collection"&&(se.collectionId=a.collectionId,se.settings.collectionId=a.collectionId,se.settings.limit=a.limit),se});et(y),W("Bloc mis \xE0 jour"),Pe(B.id,{preserveBlock:!0})},we=document.querySelector("[data-page-drawer]"),le=document.querySelector("[data-page-drawer-backdrop]"),ze=document.querySelectorAll("[data-page-drawer-open]"),je=document.querySelectorAll("[data-page-drawer-close]"),ve=document.querySelector("[data-add-page-toggle]"),ce=document.querySelector("[data-add-page-form]"),r=document.querySelector("[data-add-page-title]"),p=document.querySelector("[data-add-page-slug]"),z=document.querySelector("[data-add-page-cancel]"),S=document.querySelector("[data-add-page-error]"),be=ce==null?void 0:ce.querySelector('[type="submit"]'),Oe=Ie((X==null?void 0:X.slugValue)||ee.slug||"default")||"default",ft=(X==null?void 0:X.slugValue)||ee.slug||"",De=Ie(ft)||"",o=De?`/api/sites/${encodeURIComponent(De)}/pages`:null,g=De?`/api/sites/${encodeURIComponent(De)}/collections`:null,A={active:`clower:activePage:${Oe}`},J=(e,t,s,a,y,C=[],Q={})=>{let se={id:e,label:t,type:s,status:a,description:y,props:C,settings:{...Q}};return se.settings.collectionId&&(se.collectionId=se.settings.collectionId),se},ie={hero:{type:"Hero",label:"Hero de page",description:"Section pleine largeur avec CTA principal.",status:"Brouillon",props:[{label:"CTA",value:"D\xE9couvrir"},{label:"Hauteur",value:"80vh"}],settings:{title:"Titre du hero",subtitle:"",ctaLabel:"D\xE9couvrir",ctaUrl:"#",image:"",align:"center"}},paragraph:{type:"Paragraphe",label:"Bloc \xE9ditorial",description:"Paragraphe libre pour raconter votre histoire.",status:"Brouillon",props:[{label:"Longueur",value:"150 mots"}],settings:{title:"Titre du paragraphe",content:"",align:"left"}},image:{type:"Image",label:"Bloc image",description:"Visuel seul avec l\xE9gende optionnelle.",status:"Brouillon",props:[{label:"Ratio",value:"16:9"},{label:"L\xE9gende",value:"Inactive"}],settings:{src:"",alt:"",showCaption:!1,caption:""}},group:{type:"Groupe",label:"Groupe de sections",description:"Conteneur pour imbriquer plusieurs sous-blocs.",status:"Brouillon",props:[{label:"Disposition",value:"Verticale"}],settings:{layout:"grid",columnsMobile:"1",columnsDesktop:"3"}},collectiongrid:{type:"CollectionGrid",label:"Grille de contenus",description:"Affiche automatiquement les items d\u2019une collection.",status:"Brouillon",settings:{collectionId:"",limit:6}}},Ke=e=>{try{window.localStorage.setItem(A.active,e)}catch{}},Re=e=>{var t;try{let s=window.localStorage.getItem(A.active);if(s&&e.some(a=>a.id===s))return s}catch{}return((t=e[0])==null?void 0:t.id)||null},$e=e=>!e||e<=0?"0 bloc":e===1?"1 bloc":`${e} blocs`,Xe=e=>{if(!e||e==="/")return"/";let t=_e(e.replace(/^\//,""));return t?`/${t}`:"/"},Ve=(e="page",t="block")=>`${e}-${t}-${Date.now().toString(36)}-${Math.floor(Math.random()*1e3)}`,Ft=(e,t)=>[J(Ve(e,"intro"),"Introduction","Paragraphe","Brouillon",`Paragraphe introductif pour "${t}".`,[{label:"Longueur",value:"2 paragraphes"}],{title:`Introduction \xE0 ${t}`,content:"Ajoutez votre premier paragraphe de pr\xE9sentation.",align:"left"}),J(Ve(e,"content"),"Zone de contenu","Groupe","Brouillon","Section principale \xE0 composer avec textes et visuels.",[{label:"Colonnes",value:"Auto"}],{layout:"grid",columnsMobile:"1",columnsDesktop:"2"})],gt=e=>{d&&(d.textContent=(e==null?void 0:e.title)||"Page"),h&&(h.textContent=(e==null?void 0:e.slug)||"/")},Is=e=>{if(!c)return;c.innerHTML="",(e&&e.badges&&e.badges.length>0?e.badges:["Structure en cours"]).forEach(s=>{let a=document.createElement("span");a.className="rounded-full bg-slate-100 px-3 py-1",a.textContent=s,c.appendChild(a)})},Bs=e=>{switch((e||"").toLowerCase()){case"en ligne":return"bg-emerald-50 text-emerald-700";case"brouillon":return"bg-amber-50 text-amber-700";default:return"bg-slate-100 text-slate-600"}},ht=e=>{if(!(!F||!$)){if(!e){F.classList.remove("hidden"),$.classList.add("hidden"),P==null||P.classList.add("hidden"),v==null||v.classList.add("hidden"),K==null||K.classList.add("hidden");return}F.classList.add("hidden"),$.classList.remove("hidden"),K&&(e.status?(K.textContent=e.status,K.className=`rounded-full px-3 py-1 text-xs font-semibold ${Bs(e.status)}`,K.classList.remove("hidden")):K.classList.add("hidden")),ge(e)}},Ze=e=>{if(!q)return;let t=q.contentDocument;if(!t)return;t.querySelectorAll("[data-preview-block]").forEach(a=>{a.dataset.previewBlock===e?(a.classList.add("preview-block-active"),Rt&&e&&a.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})):a.classList.remove("preview-block-active")}),w&&(w.style.borderColor=e?"rgba(156, 107, 255, 0.5)":"transparent")},Qe=e=>{if(!l)return;l.innerHTML="";let t=(e==null?void 0:e.blocks)||[];if(O&&(O.textContent=$e(t.length)),t.length===0){l.classList.add("hidden"),_==null||_.classList.remove("hidden");return}l.classList.remove("hidden"),_==null||_.classList.add("hidden"),t.forEach(s=>{var rs;let a=s.id===pe,y=document.createElement("div");y.dataset.blockItem="true",y.dataset.blockId=s.id,y.setAttribute("role","option"),y.setAttribute("aria-selected",a?"true":"false"),y.tabIndex=0,y.className=["relative flex items-center gap-3 rounded-2xl border px-3 py-2 text-left transition",a?"bg-slate-100 border-[#9C6BFF]/40 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let C=document.createElement("span");C.className=`absolute inset-y-2 left-0 w-1 rounded-full bg-[#9C6BFF] ${a?"":"hidden"}`,y.appendChild(C);let Q=document.createElement("div");Q.className="flex flex-1 items-center gap-3";let se=document.createElement("div");se.className="hidden lg:flex cursor-grab flex-shrink-0 items-center text-lg text-slate-400",se.innerHTML="&#8801;",Q.appendChild(se);let de=document.createElement("div");de.className="flex-1";let Ue=document.createElement("div");Ue.className="flex items-center gap-2 text-[11px] uppercase tracking-wide text-slate-500";let Ht=document.createElement("span");Ht.className="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600",Ht.textContent=s.type;let zt=document.createElement("span");zt.className="text-slate-400",zt.textContent=s.status,Ue.appendChild(Ht),Ue.appendChild(zt);let Ot=document.createElement("p");Ot.className="mt-1 text-sm font-semibold text-slate-900";let Gs=s.settings&&s.settings.title||s.label||"Bloc sans titre";if(Ot.textContent=Gs,de.appendChild(Ue),de.appendChild(Ot),(s.type||"").toLowerCase()==="collectiongrid"&&s.collectionId){let Se=((rs=qe.find(_s=>_s.id===s.collectionId))==null?void 0:rs.name)||s.collectionId,Vt=document.createElement("p");Vt.className="text-xs text-slate-400",Vt.textContent=`Collection : ${Se}`,de.appendChild(Vt)}Q.appendChild(de),y.appendChild(Q);let St=document.createElement("div");St.className="flex flex-col gap-1 text-xs text-slate-400";let Lt=document.createElement("div");Lt.className="flex items-center gap-1 lg:hidden";let ot=document.createElement("button");ot.type="button",ot.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",ot.textContent="\u2191",ot.addEventListener("click",Se=>{Se.stopPropagation(),es(s.id,-1)});let at=document.createElement("button");at.type="button",at.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",at.textContent="\u2193",at.addEventListener("click",Se=>{Se.stopPropagation(),es(s.id,1)}),Lt.appendChild(ot),Lt.appendChild(at),St.appendChild(Lt);let rt=document.createElement("button");rt.type="button",rt.className="inline-flex items-center justify-center rounded-lg border border-transparent px-2 py-1 text-[12px] text-rose-500 hover:text-rose-700",rt.innerHTML="\u{1F5D1}\uFE0F",rt.addEventListener("click",Se=>{Se.stopPropagation(),Ps(s.id)}),St.appendChild(rt),y.appendChild(St),y.addEventListener("click",()=>{Je(s.id)}),y.addEventListener("keydown",Se=>{(Se.key==="Enter"||Se.key===" ")&&(Se.preventDefault(),Je(s.id))}),l.appendChild(y)})},jt=(e,t)=>{n.forEach(s=>{s.innerHTML="",e.forEach(a=>{let y=document.createElement("li"),C=document.createElement("button");C.type="button",C.dataset.pageId=a.id,C.className=["w-full flex items-center justify-between gap-3 px-3 py-2 text-left transition",t===a.id?"bg-[#9C6BFF]/10 text-slate-900 border border-[#9C6BFF]/40 rounded-xl shadow-sm":"text-slate-700 hover:bg-slate-50 rounded-xl"].join(" "),t===a.id?C.setAttribute("aria-current","page"):C.removeAttribute("aria-current"),C.innerHTML=`
            <div class="flex items-center gap-3">
              <span class="flex h-9 w-9 items-center justify-center rounded-xl border border-slate-200 bg-white text-slate-500">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6.5 4.5h7l4 4v11a1 1 0 0 1-1 1h-10a1 1 0 0 1-1-1v-14a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
                  <path d="M13.5 4.5v4a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.4"/>
                </svg>
              </span>
              <div class="flex flex-col">
                <span class="text-sm font-semibold">${a.title}</span>
                <span class="text-xs text-slate-500">${a.slug}</span>
              </div>
            </div>
          `,C.addEventListener("click",()=>{Pe(a.id),Nt()||Mt()}),y.appendChild(C),s.appendChild(y)})})},$t=()=>!B||!Array.isArray(B.blocks)?null:B.blocks.find(e=>e.id===pe)||null,Je=e=>{if(!B)return;if(!e){pe=null,Qe(B),ht(null),Ze(null);return}let t=B.blocks.find(s=>s.id===e)||B.blocks[0]||null;pe=(t==null?void 0:t.id)||null,Qe(B),ht(t),Ze(pe)},et=e=>{if(!B)return;let t={...B,blocks:e};Ns(t)},yt=()=>window.matchMedia("(min-width: 1024px)").matches;function es(e,t){if(!B||!e||!t)return;let s=[...B.blocks||[]],a=s.findIndex(Q=>Q.id===e);if(a<0)return;let y=a+t;if(y<0||y>=s.length)return;let[C]=s.splice(a,1);s.splice(y,0,C),et(s),Pe(B.id,{preserveBlock:!0}),Je(C.id)}function Ts(e,t){if(!B||!e||!t||e===t)return;let s=[...B.blocks||[]],a=s.findIndex(Q=>Q.id===e),y=s.findIndex(Q=>Q.id===t);if(a<0||y<0)return;let[C]=s.splice(a,1);s.splice(y,0,C),et(s),Pe(B.id,{preserveBlock:!0}),Je(C.id)}function ts(){if(!l)return;let e=yt();l.querySelectorAll("[data-block-item]").forEach(t=>{t.setAttribute("draggable",e?"true":"false")})}function vt(){T&&(T.classList.add("hidden"),tt=!1)}function Fs(){T&&(T.classList.remove("hidden"),tt=!0)}function js(){tt?vt():Fs()}function $s(e){var C;if(!B||!e)return;let t=ie[e];if(!t)return;let s=(B.blocks||[]).filter(Q=>Q.type===t.type).length+1,a=J(Ve(B.id,e),`${t.label} ${s}`,t.type,t.status,t.description,t.props,t.settings||{});if((t.type||"").toLowerCase()==="collectiongrid"){let Q=((C=qe[0])==null?void 0:C.id)||"";a.collectionId=Q,a.settings.collectionId=Q,a.settings.limit=a.settings.limit||6}let y=[...B.blocks||[],a];et(y),Pe(B.id,{preserveBlock:!0}),Je(a.id),vt(),W("Bloc ajout\xE9")}function ss(e){var a,y;if(!B)return;let t=(B.blocks||[]).filter(C=>C.id!==e),s=e===pe?((a=t[0])==null?void 0:a.id)||null:pe||((y=t[0])==null?void 0:y.id)||null;et(t),pe=s,Pe(B.id,{preserveBlock:!0}),pe?Je(pe):(ht(null),Ze(null)),W("Bloc supprim\xE9")}function Pt(){u&&(u.classList.add("hidden"),u.classList.remove("flex"),xt=null)}function Ps(e){if(!u){ss(e);return}xt=e,u.classList.remove("hidden"),u.classList.add("flex")}let Ns=e=>{if(!e)return;let t=nt(e);me=me.map(s=>s.id===t.id?t:s),B=t,G(t)},Pe=(e,t={})=>{var y,C;let s=me.find(Q=>Q.id===e)||me[0]||null;B=s?nt(s):null,Ee=(s==null?void 0:s.id)||null,(!t.preserveBlock||!B||!B.blocks.some(Q=>Q.id===pe))&&(pe=((C=(y=B==null?void 0:B.blocks)==null?void 0:y[0])==null?void 0:C.id)||null),Ee&&Ke(Ee),jt(me,Ee),gt(B),Is(B),Fe(B),Qe(B),ht($t()),Ze(pe),ts(),tt&&vt()},Nt=()=>window.matchMedia("(min-width: 1024px)").matches,ns=()=>{we&&(Nt()?(we.classList.add("is-open"),le==null||le.classList.add("hidden"),document.body.classList.remove("overflow-hidden")):we.classList.remove("is-open"))},Ms=()=>{!we||Nt()||(we.classList.add("is-open"),le==null||le.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},Mt=()=>{we&&(we.classList.remove("is-open"),le==null||le.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))},Ds=()=>{!ce||!ve||(ce.classList.remove("hidden"),ve.classList.add("hidden"),S&&(S.textContent=""),bt=!1,r&&(r.value="",r.focus()),p&&(p.value=""))},os=()=>{!ce||!ve||(ce.classList.add("hidden"),ve.classList.remove("hidden"),S&&(S.textContent=""),bt=!1,ce.reset())},Rs=()=>{!r||!p||bt&&p.value.trim().length>0||(p.value=Xe(r.value))},me=[],Ee=null,bt=!1,B=null,pe=null,tt=!1,xt=null,Dt="",Rt=!1,st=null,qe=[],Us=e=>{let t={...e,props:Array.isArray(e.props)?e.props:[],settings:{...e.settings||{}}};return(t.type||"").toLowerCase()==="collectiongrid"&&(t.collectionId=t.collectionId||t.settings.collectionId||"",t.settings.collectionId=t.collectionId,t.settings.limit=t.settings.limit||6),t},nt=e=>({...e,blocks:(e.blocks||[]).map(t=>Us(t))}),Hs=async()=>{if(!g){qe=[],wt();return}try{let e=await fetch(g,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les collections.");let t=await e.json().catch(()=>[]);qe=Array.isArray(t)?t:[];let s=(x==null?void 0:x.value)||"";wt(s)}catch(e){console.error("[design] collections load",e),W("Collections indisponibles."),qe=[],wt()}},Ut=e=>{if(!Y)return;if(!e){Y.textContent=qe.length?"S\xE9lectionnez une collection pour afficher ses informations.":"Aucune collection disponible. Ajoutez-en depuis l\u2019onglet Contenus.";return}let t=qe.find(a=>a.id===e);if(!t){Y.textContent=`Collection ${e}`;return}let s=[];t.description&&s.push(t.description),t.type&&s.push(`Type\xA0: ${t.type}`),Y.textContent=s.join(" \xB7 ")||`Collection ${t.name||t.id}`},wt=(e="")=>{if(x){if(x.innerHTML="",!qe.length){x.disabled=!0;let t=document.createElement("option");t.value="",t.textContent="Aucune collection disponible",x.appendChild(t),Ut("");return}if(x.disabled=!1,e&&!qe.some(t=>t.id===e)){let t=document.createElement("option");t.value=e,t.textContent=e,x.appendChild(t)}qe.forEach(t=>{let s=document.createElement("option");s.value=t.id;let a=t.name||t.id;s.textContent=t.type?`${a} \xB7 ${t.type}`:a,s.dataset.description=t.description||"",x.appendChild(s)}),e&&(x.value=e),Ut(x.value||"")}};Hs(),ns(),ze.forEach(e=>{e.addEventListener("click",Ms)}),je.forEach(e=>{e.addEventListener("click",Mt)}),le==null||le.addEventListener("click",Mt),window.addEventListener("resize",()=>{ns(),ts()}),ve==null||ve.addEventListener("click",Ds),z==null||z.addEventListener("click",os),r==null||r.addEventListener("input",Rs),p==null||p.addEventListener("input",()=>{S&&(S.textContent=""),bt=!0}),ce==null||ce.addEventListener("submit",async e=>{if(e.preventDefault(),!o){S&&(S.textContent="Aucun site s\xE9lectionn\xE9.");return}if(!r||!p)return;let t=r.value.trim(),s=Xe(p.value.trim()||t);if(!t||!s){S&&(S.textContent="Titre et slug sont requis.");return}S&&(S.textContent=""),be&&(be.disabled=!0,be.textContent="Cr\xE9ation...");try{let a=await V({title:t,slug:s});if(!a||!a.id)throw new Error("R\xE9ponse invalide.");me=[...me,nt(a)],os(),W("Page cr\xE9\xE9e"),Pe(a.id)}catch(a){console.error("[design] create page failed",a),S&&(S.textContent=a.message||"Impossible de cr\xE9er la page.")}finally{be&&(be.disabled=!1,be.textContent="Cr\xE9er")}}),k==null||k.addEventListener("click",e=>{e.stopPropagation(),js()}),document.addEventListener("click",e=>{tt&&(T!=null&&T.contains(e.target)||k!=null&&k.contains(e.target)||vt())}),I.forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();let s=e.dataset.blockAdd;$s(s)})}),D==null||D.addEventListener("click",()=>{Pt()}),j==null||j.addEventListener("click",()=>{xt&&ss(xt),Pt()}),u==null||u.addEventListener("click",e=>{e.target===u&&Pt()}),v==null||v.addEventListener("input",e=>{var s,a;let t=e.target;if(!(!t||!t.name)&&(t.name==="group-columns-mobile"||t.name==="group-columns-desktop")){let y=((s=v.querySelector('[name="group-columns-mobile"]'))==null?void 0:s.value)||"1",C=((a=v.querySelector('[name="group-columns-desktop"]'))==null?void 0:a.value)||"3";f(y,C)}}),x==null||x.addEventListener("change",e=>{let t=e.target;Ut((t==null?void 0:t.value)||"")}),v==null||v.addEventListener("submit",Me),M==null||M.addEventListener("click",e=>{e.preventDefault();let t=$t();t&&ge(t)}),q==null||q.addEventListener("load",()=>{Rt=!0,Z("\xC0 jour"),Ze(pe)}),E==null||E.addEventListener("click",()=>{let e=window.open("","_blank");if(!e)return;e.opener=null;let t=e.document;t.open(),t.write(Dt||re()),t.close()});let zs=e=>{let t=e.target.closest("[data-block-item]");!t||!yt()||(Be=t.dataset.blockId||null,Be&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",Be),t.classList.add("opacity-50")))},as=()=>{l==null||l.querySelectorAll("[data-block-item]").forEach(e=>e.classList.remove("opacity-50","ring-2","ring-[#9C6BFF]/50"))},Os=()=>{Be=null,as()},Vs=e=>{if(!Be||!yt())return;let t=e.target.closest("[data-block-item]");!t||t.dataset.blockId===Be||(e.preventDefault(),t.classList.add("ring-2","ring-[#9C6BFF]/50"))},Js=e=>{let t=e.target.closest("[data-block-item]");t&&t.classList.remove("ring-2","ring-[#9C6BFF]/50")},Ws=e=>{if(!Be||!yt())return;e.preventDefault();let t=e.target.closest("[data-block-item]"),s=Be;Be=null,as();let a=(t==null?void 0:t.dataset.blockId)||null;a&&Ts(s,a)},Be=null;l==null||l.addEventListener("dragstart",zs),l==null||l.addEventListener("dragend",Os),l==null||l.addEventListener("dragover",Vs),l==null||l.addEventListener("dragleave",Js),l==null||l.addEventListener("drop",Ws),ae()}function Es(){var Oe,ft,De;let n=document.querySelector("[data-collection-list]");if(!n)return;let d=document.querySelector("[data-collection-empty]"),h=document.querySelector("[data-collection-items-empty]"),c=document.querySelector("[data-item-table-wrapper]"),q=document.querySelector("[data-item-table-body]"),E=document.querySelector("[data-collection-title]"),b=document.querySelector("[data-collection-description]"),w=document.querySelector("[data-collection-drawer]"),l=document.querySelector("[data-collection-drawer-backdrop]"),_=document.querySelectorAll("[data-collection-drawer-open]"),O=document.querySelectorAll("[data-collection-drawer-close]"),k=document.querySelector("[data-item-add]"),T=document.querySelector("[data-item-detail-empty]"),I=document.querySelector("[data-item-form]"),u=I?{title:I.querySelector('[name="item-title"]'),slug:I.querySelector('[name="item-slug"]'),excerpt:I.querySelector('[name="item-excerpt"]'),content:I.querySelector('[name="item-content"]'),image:I.querySelector('[name="item-image"]'),status:I.querySelector('[name="item-status"]')}:{},j=document.querySelector("[data-item-status-badge]"),D=document.querySelector("[data-item-delete]"),F=document.querySelector("[data-item-delete-modal]"),K=document.querySelector("[data-item-delete-cancel]"),$=document.querySelector("[data-item-delete-confirm]"),te=document.querySelector("[data-item-cancel]"),R=document.querySelector("[data-item-save]"),P="rounded-full px-3 py-1 text-xs font-semibold",v=Ie((X==null?void 0:X.slugValue)||ee.slug||""),U=v?`/api/sites/${encodeURIComponent(v)}/collections`:null,x=[],Y=[],M=null,H=null,i=!1,m=!1,N=null,f=()=>{w&&(w.classList.add("is-open"),w.style.transform="translateX(0)",l==null||l.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},L=()=>{w&&(w.classList.remove("is-open"),w.style.transform="",l==null||l.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))};_.forEach(o=>{o.addEventListener("click",f)}),O.forEach(o=>{o.addEventListener("click",L)}),l==null||l.addEventListener("click",L);let V=o=>{let g=(o||"").trim();if(!g)return"";if(g==="/")return"/";let J=g.replace(/^\//,"").split("/").map(ie=>_e(ie||"")).filter(ie=>ie.length>0);return J.length?`/${J.join("/")}`:""},G=o=>{if(!o)return"\u2014";let g=new Date(o);return Number.isNaN(g.getTime())?"\u2014":g.toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"})},ae=()=>{let o=x.find(g=>g.id===M);E&&(E.textContent=(o==null?void 0:o.name)||"S\xE9lectionnez une collection"),b&&(b.textContent=(o==null?void 0:o.description)||"")},ne=o=>{h&&(h.textContent=o||(M?"Aucun item dans cette collection pour le moment.":"Choisissez une collection dans le panneau de gauche."))},oe=()=>{I&&(I.classList.add("hidden"),I.dataset.itemId=""),T==null||T.classList.remove("hidden"),j&&(j.className=`hidden ${P}`,j.textContent=""),D&&(D.disabled=!0)},ge=()=>{I&&(I.classList.remove("hidden"),T==null||T.classList.add("hidden"))},he=()=>{k&&(k.disabled=!M,k.disabled?k.classList.add("opacity-60","pointer-events-none"):k.classList.remove("opacity-60","pointer-events-none"))},Z=o=>{if(!j)return;if(!o){j.className=`hidden ${P}`,j.textContent="";return}let g=o.toLowerCase(),A="bg-slate-100 text-slate-600 border border-slate-200";g==="publi\xE9"||g==="publie"?A="bg-emerald-50 text-emerald-700 border border-emerald-100":g==="brouillon"&&(A="bg-amber-50 text-amber-700 border border-amber-100"),j.className=`${P} ${A}`,j.textContent=o},Ne=()=>{if(n.innerHTML="",!x.length){d==null||d.classList.remove("hidden");return}d==null||d.classList.add("hidden"),x.forEach(o=>{let g=o.id===M,A=document.createElement("button");A.type="button",A.dataset.collectionId=o.id,A.className=["w-full rounded-xl border px-3 py-2 text-left transition focus:outline-none focus:ring-2 focus:ring-[#9C6BFF]/40",g?"bg-[#F7F0FF] border-[#9C6BFF]/40 text-slate-900":"border-slate-200 text-slate-700 hover:border-[#9C6BFF]/40"].join(" "),A.setAttribute("role","option"),g?A.setAttribute("aria-current","true"):A.removeAttribute("aria-current"),A.innerHTML=`
          <div class="flex items-center justify-between gap-2">
            <div>
              <p class="text-sm font-semibold">${o.name||o.id}</p>
              <p class="text-xs text-slate-500">${o.description||""}</p>
            </div>
            <span class="text-[11px] uppercase tracking-wide text-slate-400">${o.type||""}</span>
          </div>
        `,A.addEventListener("click",()=>{ve(o.id),window.matchMedia("(min-width: 1024px)").matches||L()}),n.appendChild(A)})},re=()=>{if(q){if(q.innerHTML="",!Y.length||!M){h==null||h.classList.remove("hidden"),ne(),c==null||c.classList.add("hidden");return}h==null||h.classList.add("hidden"),c==null||c.classList.remove("hidden"),Y.forEach(o=>{let g=document.createElement("tr");g.dataset.itemId=o.id;let A=o.id===H&&!i;g.className=["cursor-pointer transition focus-within:bg-[#F7F0FF]/70 focus:outline-none",A?"bg-[#F7F0FF]/70":"hover:bg-slate-50"].join(" "),g.tabIndex=0,g.setAttribute("role","button"),A?g.setAttribute("aria-current","true"):g.removeAttribute("aria-current");let J=o.status||"Brouillon",ie=J.toLowerCase(),Ke=ie==="publi\xE9"||ie==="publie"?"bg-emerald-50 text-emerald-700 border border-emerald-100":"bg-amber-50 text-amber-700 border border-amber-100";g.innerHTML=`
          <td class="px-4 py-3 align-top">
            <div class="flex flex-col">
              <span class="text-sm font-semibold text-slate-900">${o.title||"Sans titre"}</span>
              <span class="text-xs text-slate-500">${o.summary||o.excerpt||""}</span>
            </div>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-600">${o.slug||""}</td>
          <td class="px-4 py-3 align-top">
            <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${Ke}">
              ${J}
            </span>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-500">${G(o.updatedAt||o.createdAt)}</td>
        `;let Re=()=>{Fe(o.id)};g.addEventListener("click",Re),g.addEventListener("keydown",$e=>{($e.key==="Enter"||$e.key===" ")&&($e.preventDefault(),Re())}),q.appendChild(g)})}},Fe=o=>{let g=Y.find(A=>A.id===o);g&&(H=g.id,i=!1,m=!0,Me(g),re())},Me=o=>{if(!I||!o){oe();return}ge(),I.dataset.itemId=o.id,u.title&&(u.title.value=o.title||""),u.slug&&(u.slug.value=o.slug||""),u.excerpt&&(u.excerpt.value=o.summary||o.excerpt||""),u.content&&(u.content.value=o.content||""),u.image&&(u.image.value=o.image||""),u.status&&(u.status.value=o.status||"Brouillon"),Z(o.status||"Brouillon"),D&&(D.disabled=!1)},we=()=>{var o;I&&(i=!0,H=null,m=!1,I.dataset.itemId="",I.reset(),u.status&&(u.status.value="Brouillon"),u.slug&&(u.slug.value=""),Z("Brouillon"),ge(),D&&(D.disabled=!0),(o=u.title)==null||o.focus())},le=()=>{var Re,$e,Xe,Ve,Ft,gt;let o=(((Re=u.title)==null?void 0:Re.value)||"").trim(),g=((($e=u.slug)==null?void 0:$e.value)||"").trim(),A=(((Xe=u.excerpt)==null?void 0:Xe.value)||"").trim(),J=(((Ve=u.content)==null?void 0:Ve.value)||"").trim(),ie=(((Ft=u.image)==null?void 0:Ft.value)||"").trim(),Ke=((gt=u.status)==null?void 0:gt.value)||"Brouillon";return{title:o,slug:V(g||o),summary:A,excerpt:A,content:J,image:ie,status:Ke}},ze=o=>{R&&(R.disabled=o,R.textContent=o?"Enregistrement\u2026":"Enregistrer"),D&&!i&&H&&(D.disabled=o)},je=async o=>{if(!U)return[];let g=await fetch(`${U}/${encodeURIComponent(o)}/items`,{headers:{Accept:"application/json"}});if(!g.ok){let J=await g.json().catch(()=>({}));throw new Error(J.message||"Impossible de charger les items.")}let A=await g.json().catch(()=>({}));return Array.isArray(A.items)?A.items:[]},ve=async o=>{if(o&&(M=o,H=null,i=!1,m=!1,ae(),he(),Ne(),oe(),Y=[],re(),ne("Chargement des items\u2026"),h==null||h.classList.remove("hidden"),c==null||c.classList.add("hidden"),!!U))try{Y=await je(o),re(),Y.length||ne()}catch(g){console.error("[content] items failed",g),W(g.message||"Impossible de charger les items."),Y=[],re()}},ce=async(o,g)=>{if(!U)throw new Error("Site inconnu.");let A=await fetch(`${U}/${encodeURIComponent(o)}/items`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)});if(!A.ok){let J=await A.json().catch(()=>({}));throw new Error(J.message||"Impossible de cr\xE9er cet item.")}return A.json()},r=async(o,g,A)=>{if(!U)throw new Error("Site inconnu.");let J=await fetch(`${U}/${encodeURIComponent(o)}/items/${encodeURIComponent(g)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(A)});if(!J.ok){let ie=await J.json().catch(()=>({}));throw new Error(ie.message||"Impossible de sauvegarder cet item.")}return J.json()},p=async(o,g)=>{if(!U)throw new Error("Site inconnu.");let A=await fetch(`${U}/${encodeURIComponent(o)}/items/${encodeURIComponent(g)}`,{method:"DELETE"});if(!A.ok){let J=await A.json().catch(()=>({}));throw new Error(J.message||"Impossible de supprimer cet item.")}},z=async()=>{var o;if(!U){d==null||d.classList.remove("hidden"),M=null,Y=[],re(),ae(),he();return}try{let g=await fetch(U,{headers:{Accept:"application/json"}});if(!g.ok)throw new Error("Impossible de charger les collections.");let A=await g.json().catch(()=>[]);if(x=Array.isArray(A)?A:[],Ne(),x.length>0){let J=((o=x.find(ie=>ie.id===M))==null?void 0:o.id)||x[0].id;ve(J)}else M=null,Y=[],ae(),he(),re()}catch(g){console.error("[content] load collections",g),W(g.message||"Impossible de charger les collections.")}};k==null||k.addEventListener("click",()=>{if(!M){W("S\xE9lectionnez d\u2019abord une collection.");return}we(),re()}),te==null||te.addEventListener("click",o=>{if(o.preventDefault(),i){i=!1,H=null,oe(),re();return}if(H){let g=Y.find(A=>A.id===H);Me(g)}else oe()}),(Oe=u.status)==null||Oe.addEventListener("change",()=>{Z(u.status.value)}),(ft=u.title)==null||ft.addEventListener("input",()=>{!i||!u.slug||m||(u.slug.value=V(u.title.value))}),(De=u.slug)==null||De.addEventListener("input",()=>{i&&(m=!0)}),I==null||I.addEventListener("submit",async o=>{var A;if(o.preventDefault(),!M){W("S\xE9lectionnez une collection.");return}let g=le();if(!g.title){W("Le titre est requis."),(A=u.title)==null||A.focus();return}ze(!0);try{let J;i||!H?(J=await ce(M,g),Y=[...Y,J],W("Item cr\xE9\xE9")):(J=await r(M,H,g),Y=Y.map(ie=>ie.id===J.id?J:ie),W("Item mis \xE0 jour")),i=!1,H=J.id,Me(J),re()}catch(J){console.error("[content] save item failed",J),W(J.message||"Impossible de sauvegarder cet item.")}finally{ze(!1)}});let S=()=>{F&&(F.classList.add("hidden"),F.classList.remove("flex"),N=null)},be=()=>{!F||!H||(N=H,F.classList.remove("hidden"),F.classList.add("flex"))};D==null||D.addEventListener("click",o=>{o.preventDefault(),H&&be()}),K==null||K.addEventListener("click",()=>{S()}),F==null||F.addEventListener("click",o=>{o.target===F&&S()}),$==null||$.addEventListener("click",async()=>{if(!N||!M){S();return}$.disabled=!0,$.textContent="Suppression\u2026";try{await p(M,N),Y=Y.filter(o=>o.id!==N),H===N&&(H=null,oe()),W("Item supprim\xE9"),re()}catch(o){console.error("[content] delete item failed",o),W(o.message||"Impossible de supprimer cet item.")}finally{$.disabled=!1,$.textContent="Supprimer",S()}}),ae(),he(),z()}function qs(){let n=document.querySelector("[data-deploy-form]");if(!n)return;let d=document.querySelector("[data-deploy-protocol]"),h=document.querySelector("[data-deploy-host]"),c=document.querySelector("[data-deploy-port]"),q=document.querySelector("[data-deploy-user]"),E=document.querySelector("[data-deploy-password]"),b=document.querySelector("[data-deploy-show-password]"),w=document.querySelector("[data-deploy-remote-path]"),l=document.querySelector("[data-deploy-feedback]"),_=document.querySelector("[data-deploy-save]"),O=document.querySelector("[data-deploy-test]"),k=document.querySelector("[data-deploy-trigger]"),T=document.querySelector("[data-deploy-history]"),I=document.querySelector("[data-deploy-log]"),u=Ie((X==null?void 0:X.slugValue)||ee.slug||""),j=u?`/api/sites/${encodeURIComponent(u)}/deploy-config`:null,D=u?`/api/sites/${encodeURIComponent(u)}/deploy`:null,F=u?`/api/sites/${encodeURIComponent(u)}/deploy-log`:null,K=!1,$=null,te=i=>{let m=(i||"").trim();return m?m.startsWith("/")?m:`/${m}`:"/www"},R=(i,m="muted")=>{if(!l)return;let N="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold",f=m==="success"?"bg-emerald-50 text-emerald-700 border border-emerald-100":m==="error"?"bg-rose-50 text-rose-700 border border-rose-100":"bg-slate-50 text-slate-600 border border-slate-100";if(!i){l.textContent="",l.className="text-sm text-slate-500";return}let L=m==="success"?"\u2705":m==="error"?"\u274C":"\u2139\uFE0F";l.innerHTML=`<span class="${N} ${f}">${L}<span>${i}</span></span>`,l.className="text-sm"},P=(i=null)=>{$=i;let m=!!i,N='<svg class="h-4 w-4 animate-spin text-white" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>';_&&(_.disabled=m,_.innerHTML=i==="save"?`<span class="inline-flex items-center gap-2">${N}<span>Enregistrement\u2026</span></span>`:"Enregistrer"),O&&(O.disabled=m,O.innerHTML=i==="test"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-slate-200 border-t-slate-600"></span><span>Test en cours\u2026</span></span>':"Tester la connexion"),k&&(k.disabled=m&&i!==null,k.innerHTML=i==="deploy"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-white/60 border-t-white"></span><span>D\xE9ploiement\u2026</span></span>':"D\xE9ployer maintenant")},v=i=>{d&&(d.value=i.protocol||"sftp"),h&&(h.value=i.host||""),c&&(c.value=i.port||""),q&&(q.value=i.user||""),w&&(w.value=i.remotePath||"/www"),K=!!i.hasPassword,E&&(E.value="",E.placeholder=K?"Non affich\xE9":"Mot de passe")},U=(i=[])=>{if(T){if(T.innerHTML="",!i.length){let m=document.createElement("li");m.className="text-slate-500",m.textContent="Aucun d\xE9ploiement pour le moment.",T.appendChild(m);return}i.forEach(m=>{let N=document.createElement("li");N.className="flex items-center justify-between gap-2 rounded-xl border border-slate-200 px-3 py-2";let f=m.status==="success"?'<span class="rounded-full bg-emerald-50 px-2 py-0.5 text-[11px] font-semibold text-emerald-700">Succ\xE8s</span>':'<span class="rounded-full bg-rose-50 px-2 py-0.5 text-[11px] font-semibold text-rose-700">\xC9chec</span>',L=m.finishedAt||m.startedAt||"",V=m.durationMs&&Number(m.durationMs)>=0?`${Math.round(Number(m.durationMs)/1e3)}s`:"";N.innerHTML=`
          <div class="space-y-1">
            <div class="flex items-center gap-2">${f}<span class="text-xs text-slate-500">${L}</span></div>
            <p class="text-sm text-slate-800">${m.message||""}</p>
          </div>
          <div class="text-xs text-slate-500">${V}</div>
        `,N.dataset.deployId=m.id||"",N.addEventListener("click",()=>{m.logs&&I&&(I.textContent=m.logs.join(`
`))}),T.appendChild(N)})}},x=(i=[])=>{I&&(I.textContent=i.length?i.join(`
`):"Aucun log pour le moment.")},Y=async()=>{var i;if(F)try{let m=await fetch(F,{headers:{Accept:"application/json"}});if(!m.ok){if(m.status===404){U([]),x(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw new Error("Impossible de charger l\u2019historique.")}let N=await m.json().catch(()=>({})),f=Array.isArray(N.entries)?N.entries:[];U(f),(i=f[0])!=null&&i.logs&&x(f[0].logs)}catch(m){console.error("[deploy] history failed",m)}},M=async()=>{if(!j){R("Aucun site actif s\xE9lectionn\xE9.","error");return}P("load");try{let i=await fetch(j,{headers:{Accept:"application/json"}}),m=await i.json().catch(()=>({}));i.ok?(v(m||{}),R("Configuration charg\xE9e.","muted")):(v(m||{}),R(m.message||"Configuration par d\xE9faut charg\xE9e.","muted"))}catch(i){console.error("[deploy] load failed",i),R(i.message||"Erreur lors du chargement.","error")}finally{P(null)}},H=()=>{let i={protocol:(d==null?void 0:d.value)||"sftp",host:(h==null?void 0:h.value.trim())||"",port:Number(c==null?void 0:c.value)||void 0,user:(q==null?void 0:q.value.trim())||"",remotePath:te((w==null?void 0:w.value)||"/www")},m=(E==null?void 0:E.value)||"";return m.trim().length>0&&(i.password=m),i};n.addEventListener("submit",async i=>{if(i.preventDefault(),!j){R("Aucun site actif s\xE9lectionn\xE9.","error");return}let m=H();P("save");try{let N=await fetch(j,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)});if(!N.ok){let L=await N.json().catch(()=>({}));throw new Error(L.message||"Sauvegarde impossible.")}let f=await N.json();v(f||{}),R("Configuration enregistr\xE9e.","success"),W("Configuration d\xE9ploiement sauvegard\xE9e")}catch(N){console.error("[deploy] save failed",N),R(N.message||"Erreur lors de la sauvegarde.","error")}finally{P(null)}}),O==null||O.addEventListener("click",async()=>{if(!j){R("Aucun site actif s\xE9lectionn\xE9.","error");return}let i=H();if(!i.host||!i.user||!i.remotePath){R("Remplissez les champs requis avant de tester.","error");return}P("test");try{let m=await fetch(`${j}/test`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),N=await m.json().catch(()=>({}));if(!m.ok||N.success===!1){R(N.message||"Test de connexion \xE9chou\xE9.","error");return}R(N.message||"Connexion OK.","success"),W("Test de connexion r\xE9ussi")}catch(m){console.error("[deploy] test failed",m),R(m.message||"Test de connexion \xE9chou\xE9.","error")}finally{P(null)}}),k==null||k.addEventListener("click",async()=>{if(!D){R("Aucun site actif s\xE9lectionn\xE9.","error");return}P("deploy"),x(["D\xE9ploiement en cours\u2026"]);try{let i=await fetch(D,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(H())}),m=await i.json().catch(()=>({}));if(!i.ok){if(i.status===404){R("API d\xE9ploiement indisponible (red\xE9marre le serveur).","error"),x(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw x(m.logs||[]),new Error(m.message||"D\xE9ploiement \xE9chou\xE9.")}x(m.logs||[]),await Y(),W("D\xE9ploiement termin\xE9")}catch(i){console.error("[deploy] run failed",i),R(i.message||"D\xE9ploiement \xE9chou\xE9.","error")}finally{P(null)}}),b==null||b.addEventListener("change",()=>{E&&(E.type=b.checked?"text":"password")}),M(),Y()}function ks(){let n=document.querySelectorAll("[data-settings-tab]"),d=document.querySelectorAll("[data-settings-panel]"),h=document.querySelector("[data-admin-password-form]"),c=document.querySelector("[data-site-config-form]"),q=document.querySelector("[data-site-config-feedback]"),E=b=>{n.forEach(w=>{let l=w.dataset.settingsTab===b;w.setAttribute("aria-selected",l?"true":"false"),w.classList.toggle("bg-[#9C6BFF]",l),w.classList.toggle("text-white",l)}),d.forEach(w=>{w.classList.toggle("hidden",w.dataset.settingsPanel!==b)})};if(n.forEach(b=>{b.addEventListener("click",()=>E(b.dataset.settingsTab||"account"))}),E("account"),h){let b=h.querySelector("[data-admin-password-feedback]"),w=h.querySelector("[data-admin-password-submit]"),l=(_,O="muted")=>{if(!b)return;let k=O==="success"?"text-emerald-600":O==="error"?"text-rose-600":"text-slate-500";b.textContent=_||"",b.className=`text-sm ${k}`};h.addEventListener("submit",async _=>{_.preventDefault();let O=new FormData(h),k=O.get("currentPassword")||"",T=O.get("newPassword")||"",I=O.get("confirmPassword")||"";if(!k||!T||!I){l("Compl\xE8te tous les champs.","error");return}w&&(w.disabled=!0),l("");try{let u=await fetch("/api/admin/password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({currentPassword:k,newPassword:T,confirmPassword:I})}),j=await u.json().catch(()=>({}));if(!u.ok||j.success===!1)throw new Error(j.message||"Impossible de mettre \xE0 jour le mot de passe.");l(j.message||"Mot de passe mis \xE0 jour.","success"),h.reset()}catch(u){console.error("[settings] change password failed",u),l(u.message||"Erreur lors de la mise \xE0 jour.","error")}finally{w&&(w.disabled=!1)}})}if(c){let b=c.querySelector("[data-site-name]"),w=c.querySelector("[data-site-language]"),l=c.querySelector("[data-site-tagline]"),_=c.querySelector("[data-site-save]"),O=(f,L="muted")=>{if(!q)return;let V=L==="success"?"text-emerald-600":L==="error"?"text-rose-600":"text-slate-500";q.textContent=f||"",q.className=`text-sm ${V}`},k=Ie((X==null?void 0:X.slugValue)||ee.slug||""),T=k?`/api/sites/${encodeURIComponent(k)}/config/site`:null,I=k?`/api/sites/${encodeURIComponent(k)}/config/theme`:null,u=async()=>{if(T)try{let f=await fetch(T,{headers:{Accept:"application/json"}});if(!f.ok)return;let L=await f.json().catch(()=>({}));b&&(b.value=L.name||""),w&&(w.value=L.language||"fr"),l&&(l.value=L.tagline||"")}catch(f){console.error("[settings] load site config failed",f)}};c.addEventListener("submit",async f=>{if(f.preventDefault(),!T){O("Aucun site actif.","error");return}if(!(b!=null&&b.value.trim())){O("Nom requis.","error");return}_&&(_.disabled=!0),O("");try{let L={name:(b==null?void 0:b.value)||"",language:(w==null?void 0:w.value)||"fr",tagline:(l==null?void 0:l.value)||""},V=await fetch(T,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(L)}),G=await V.json().catch(()=>({}));if(!V.ok||G.success===!1)throw new Error(G.message||"Sauvegarde impossible.");O(G.message||"Param\xE8tres enregistr\xE9s.","success")}catch(L){console.error("[settings] save site config failed",L),O(L.message||"Erreur lors de la sauvegarde.","error")}finally{_&&(_.disabled=!1)}}),u();let j={primary:c.querySelector("[data-theme-primary]"),secondary:c.querySelector("[data-theme-secondary]"),accent:c.querySelector("[data-theme-accent]")},D={primary:c.querySelector("[data-theme-primary-hex]"),secondary:c.querySelector("[data-theme-secondary-hex]"),accent:c.querySelector("[data-theme-accent-hex]")},F=c.querySelector("[data-theme-headings]"),K=c.querySelector("[data-theme-body]"),$=c.querySelector("[data-theme-radius-small]"),te=c.querySelector("[data-theme-radius-medium]"),R=c.querySelector("[data-theme-radius-large]"),P=c.querySelector("[data-theme-preview]"),v=c.querySelector("[data-theme-feedback]"),U=c.querySelector("[data-theme-apply]"),x={primary:c.querySelector("[data-theme-palette-primary]"),secondary:c.querySelector("[data-theme-palette-secondary]"),accent:c.querySelector("[data-theme-palette-accent]")},Y=["#0EA5E9","#22D3EE","#10B981","#F97316","#F59E0B","#E11D48","#6366F1","#8B5CF6","#0F172A","#1E293B"],M=(f,L="muted")=>{if(!v)return;let V=L==="success"?"text-emerald-600":L==="error"?"text-rose-600":"text-slate-500";v.textContent=f||"",v.className=`text-sm ${V}`},H=()=>{var L,V,G;if(!P)return;let f={primary:((L=D.primary)==null?void 0:L.value)||"#9C6BFF",secondary:((V=D.secondary)==null?void 0:V.value)||"#0EA5E9",accent:((G=D.accent)==null?void 0:G.value)||"#F97316"};P.style.setProperty("--color-primary",f.primary),P.style.setProperty("--color-secondary",f.secondary),P.style.setProperty("--color-accent",f.accent),P.style.setProperty("--font-headings",(F==null?void 0:F.value)||"Inter, sans-serif"),P.style.setProperty("--font-body",(K==null?void 0:K.value)||"Inter, sans-serif"),P.style.setProperty("--radius-small",($==null?void 0:$.value)||"8px"),P.style.setProperty("--radius-medium",(te==null?void 0:te.value)||"16px"),P.style.setProperty("--radius-large",(R==null?void 0:R.value)||"24px"),P.style.borderRadius=(te==null?void 0:te.value)||"16px"},i=(f,L)=>{j[f]&&(j[f].value=L),D[f]&&(D[f].value=L)},m=f=>{let L=x[f];L&&(L.innerHTML="",Y.forEach(V=>{let G=document.createElement("button");G.type="button",G.className="h-7 w-7 rounded-full border border-slate-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-[#9C6BFF]",G.style.background=V,G.title=V,G.addEventListener("click",()=>{i(f,V),H()}),L.appendChild(G)}))};Object.keys(j).forEach(f=>{var L,V;(L=j[f])==null||L.addEventListener("input",()=>{let G=j[f].value;D[f]&&(D[f].value=G),H()}),(V=D[f])==null||V.addEventListener("input",()=>{let G=D[f].value;j[f]&&(j[f].value=G),H()}),m(f)}),[F,K,$,te,R].forEach(f=>{f==null||f.addEventListener("change",H)});let N=async()=>{var f,L,V,G,ae,ne,oe,ge;if(I)try{let he=await fetch(I,{headers:{Accept:"application/json"}});if(!he.ok)return;let Z=await he.json().catch(()=>({}));i("primary",((f=Z.colors)==null?void 0:f.primary)||"#9C6BFF"),i("secondary",((L=Z.colors)==null?void 0:L.secondary)||"#0EA5E9"),i("accent",((V=Z.colors)==null?void 0:V.accent)||"#F97316"),F&&(F.value=((G=Z.typography)==null?void 0:G.headings)||"Inter, sans-serif"),K&&(K.value=((ae=Z.typography)==null?void 0:ae.body)||"Inter, sans-serif"),$&&($.value=((ne=Z.radius)==null?void 0:ne.small)||"8px"),te&&(te.value=((oe=Z.radius)==null?void 0:oe.medium)||"16px"),R&&(R.value=((ge=Z.radius)==null?void 0:ge.large)||"24px"),H()}catch(he){console.error("[settings] load theme failed",he)}};c.addEventListener("submit",async f=>{}),U==null||U.addEventListener("click",async f=>{var V,G,ae;if(f.preventDefault(),!I){M("Aucun site actif.","error");return}let L={colors:{primary:((V=D.primary)==null?void 0:V.value)||"#9C6BFF",secondary:((G=D.secondary)==null?void 0:G.value)||"#0EA5E9",accent:((ae=D.accent)==null?void 0:ae.value)||"#F97316"},typography:{headings:(F==null?void 0:F.value)||"Inter, sans-serif",body:(K==null?void 0:K.value)||"Inter, sans-serif"},radius:{small:($==null?void 0:$.value)||"8px",medium:(te==null?void 0:te.value)||"16px",large:(R==null?void 0:R.value)||"24px"}};U.disabled=!0,M("");try{let ne=await fetch(I,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(L)}),oe=await ne.json().catch(()=>({}));if(!ne.ok||oe.success===!1)throw new Error(oe.message||"Application du th\xE8me \xE9chou\xE9e.");M(oe.message||"Th\xE8me appliqu\xE9.","success"),H()}catch(ne){console.error("[settings] apply theme failed",ne),M(ne.message||"Erreur lors de l\u2019application du th\xE8me.","error")}finally{U.disabled=!1}}),N(),H()}}function As(){let n=document.querySelector("[data-media-grid]");if(!n)return;let d=document.querySelector("[data-media-empty]"),h=document.querySelector("[data-media-count]"),c=document.querySelector("[data-media-filter-type]"),q=document.querySelector("[data-media-detail-empty]"),E=document.querySelector("[data-media-detail]"),b=document.querySelector("[data-media-detail-preview]"),w=document.querySelector("[data-media-detail-name]"),l=document.querySelector("[data-media-detail-type]"),_=document.querySelector("[data-media-detail-size]"),O=document.querySelector("[data-media-detail-path]"),k=document.querySelector("[data-media-detail-used]"),T=document.querySelector("[data-media-alt-edit]"),I=document.querySelector("[data-media-save]"),u=document.querySelector("[data-media-delete]"),j=document.querySelector("[data-media-delete-modal]"),D=document.querySelector("[data-media-delete-cancel]"),F=document.querySelector("[data-media-delete-confirm]"),K=document.querySelector("[data-media-upload-open]"),$=document.querySelector("[data-media-file-input]"),te=document.querySelector("[data-media-upload-status]"),R=Ie((X==null?void 0:X.slugValue)||ee.slug||""),P=R?`/api/sites/${encodeURIComponent(R)}/media`:null,v=[],U=[],x=null,Y=null,M=null,H=!1,i=!1,m=!1,N=null,f=r=>{let p=(r.type||"").toLowerCase(),z=(r.filename||"").toLowerCase();return p.includes("image")||/\.(png|jpe?g|webp|svg|gif)$/i.test(z)?"image":p.includes("pdf")||p.includes("doc")||/\.(pdf|docx?)$/i.test(z)?"document":p.includes("video")||/\.(mp4|mov|webm)$/i.test(z)?"video":"other"},L=r=>f(r)==="image",V=r=>{if(r.type)return r.type.toUpperCase();let p=(r.filename||"").split(".").pop();return p?p.toUpperCase():"FILE"},G=r=>!r||r<=0?"\u2014":r<1024?`${r} o`:r<1024*1024?`${(r/1024).toFixed(1)} ko`:`${(r/(1024*1024)).toFixed(1)} Mo`,ae=()=>{E==null||E.classList.add("hidden"),q==null||q.classList.remove("hidden"),ne(),x=null,i=!1,Z(!1),b&&(b.innerHTML='<span class="text-slate-400 text-sm">Aucun m\xE9dia s\xE9lectionn\xE9</span>'),w&&(w.textContent=""),l&&(l.textContent=""),_&&(_.textContent=""),T&&(T.value=""),O&&(O.textContent=""),k&&(k.innerHTML="")},ne=()=>{M=null,m=!1,H=!1,N&&(URL.revokeObjectURL(N),N=null),te&&(te.textContent="Aucun fichier s\xE9lectionn\xE9."),$&&($.value="")},oe=()=>{h&&(U.length?U.length===1?h.textContent="1 m\xE9dia":h.textContent=`${U.length} m\xE9dias`:h.textContent="0 m\xE9dia")},ge=()=>{if(n.innerHTML="",!U.length){d==null||d.classList.remove("hidden"),ae();return}d==null||d.classList.add("hidden"),U.forEach(r=>{let p=document.createElement("button");p.type="button",p.dataset.mediaId=r.id;let z=r.id===x;p.className=["group relative flex flex-col rounded-2xl border px-3 py-3 text-left transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#9C6BFF]",z?"border-[#9C6BFF] bg-[#F7F0FF]/60 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let S=L(r)?`<img src="${r.path}" alt="${r.alt||r.filename}" class="h-full w-full object-cover" />`:'<div class="flex h-full w-full items-center justify-center text-3xl text-slate-400">\u{1F4C4}</div>';p.innerHTML=`
          <div class="relative aspect-[4/3] overflow-hidden rounded-xl bg-slate-100">
            ${S}
          </div>
          <div class="mt-2 space-y-1">
            <p class="text-sm font-semibold text-slate-900 truncate">${r.filename}</p>
            <p class="text-xs text-slate-500">
              ${V(r)} \xB7 ${G(r.size)}
            </p>
          </div>
        `,r.id===Y&&(p.classList.add("ring-2","ring-[#9C6BFF]"),window.setTimeout(()=>{p.classList.remove("ring-2","ring-[#9C6BFF]")},1600)),p.addEventListener("click",()=>Ne(r.id)),n.appendChild(p)}),Y=null},he=r=>{if(k){if(k.innerHTML="",!r.usedIn||r.usedIn.length===0){let p=document.createElement("li");p.textContent="Non utilis\xE9",p.className="text-xs text-slate-400",k.appendChild(p);return}r.usedIn.forEach(p=>{let z=document.createElement("li");z.textContent=p,z.className="text-xs text-slate-600",k.appendChild(z)})}},Z=r=>{if(I){if(m){I.textContent=r?"T\xE9l\xE9versement\u2026":"T\xE9l\xE9verser",I.disabled=r||!M,u&&u.classList.add("hidden");return}I.textContent=r?"Enregistrement\u2026":"Enregistrer",I.disabled=r||!i,u&&(u.classList.remove("hidden"),u.disabled=!x)}},Ne=r=>{let p=v.find(z=>z.id===r);if(!p){ae(),ge();return}ne(),x=p.id,i=!1,Z(!1),ge(),q==null||q.classList.add("hidden"),E==null||E.classList.remove("hidden"),b&&(L(p)?b.innerHTML=`<img src="${p.path}" alt="${p.alt||p.filename}" class="h-full w-full rounded-2xl object-cover" />`:b.innerHTML='<div class="flex h-full w-full flex-col items-center justify-center gap-1 text-slate-400"><span class="text-3xl">\u{1F4C4}</span><span class="text-xs font-semibold">Document</span></div>'),w&&(w.textContent=p.filename||"Fichier"),l&&(l.textContent=V(p)),_&&(_.textContent=G(p.size)),T&&(T.value=p.alt||""),O&&(O.textContent=p.path||"\u2014"),he(p)},re=r=>{if(r){if(m=!0,i=!1,x=null,q==null||q.classList.add("hidden"),E==null||E.classList.remove("hidden"),N&&URL.revokeObjectURL(N),N=URL.createObjectURL(r),b&&(b.innerHTML=`<img src="${N}" alt="${r.name}" class="h-full w-full rounded-2xl object-cover" />`),w&&(w.textContent=r.name),l&&(l.textContent=V({type:r.type,filename:r.name})),_&&(_.textContent=G(r.size)),T&&!T.value.trim()&&(T.value=r.name.replace(/\.[^.]+$/,"").replace(/[-_]/g," ")),O&&(O.textContent="En attente de t\xE9l\xE9versement"),k){k.innerHTML="";let p=document.createElement("li");p.textContent="Non utilis\xE9",p.className="text-xs text-slate-400",k.appendChild(p)}Z(!1)}},Fe=()=>{let r=(c==null?void 0:c.value)||"all";r==="all"?U=[...v]:U=v.filter(p=>p.groupType===r),U.some(p=>p.id===x)||ae(),oe(),ge()},Me=async()=>{if(!P){d==null||d.classList.remove("hidden");return}try{let r=await fetch(P,{headers:{Accept:"application/json"}});if(!r.ok)throw new Error("Impossible de charger les m\xE9dias.");let p=await r.json().catch(()=>({items:[]}));v=Array.isArray(p.items)?p.items.map(z=>({...z,groupType:f(z)})):[],Fe()}catch(r){console.error("[media] load failed",r),W(r.message||"Impossible de charger les m\xE9dias."),v=[],Fe()}};c==null||c.addEventListener("change",()=>{Fe()}),T==null||T.addEventListener("input",()=>{if(m){Z(!1);return}x&&(i=!0,Z(!1))});let we=r=>{if(r){if(!r.type.startsWith("image/")){W("Seules les images sont accept\xE9es pour le moment.");return}if(r.size>4*1024*1024){W("Fichier trop volumineux (4 Mo max).");return}M=r,re(r),te&&(te.textContent=`${r.name} \xB7 ${G(r.size)}`)}},le=r=>new Promise((p,z)=>{let S=new FileReader;S.onload=()=>{let be=S.result||"",[,Oe=""]=String(be).split(",");p(Oe)},S.onerror=()=>z(new Error("Impossible de lire ce fichier.")),S.readAsDataURL(r)}),ze=async()=>{if(!(!M||!P)){H=!0,Z(!0);try{let r=await le(M),p={filename:M.name,type:M.type,size:M.size,alt:(T==null?void 0:T.value)||"",data:r},z=await fetch(P,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});if(!z.ok){let be=await z.json().catch(()=>({}));throw new Error(be.message||"Upload impossible.")}let S=await z.json();S.groupType=f(S),v=[...v,S],Y=S.id,Fe(),Ne(S.id),W("M\xE9dia ajout\xE9"),ne()}catch(r){console.error("[media] upload failed",r),W(r.message||"Impossible de t\xE9l\xE9verser ce m\xE9dia.")}finally{H=!1,M=null,Z(!1)}}};K==null||K.addEventListener("click",()=>$==null?void 0:$.click()),$==null||$.addEventListener("change",()=>{$.files&&$.files[0]&&we($.files[0])});let je=()=>{j&&(j.classList.add("hidden"),j.classList.remove("flex"))},ve=()=>{if(!(!x||m)){if(j){j.classList.remove("hidden"),j.classList.add("flex");return}window.confirm("Supprimer ce m\xE9dia ?")&&ce()}},ce=async()=>{if(!x||!P){je();return}let r=()=>{u&&(u.disabled=!0),F&&(F.disabled=!0,F.textContent="Suppression\u2026")},p=()=>{u&&(u.disabled=!1),F&&(F.disabled=!1,F.textContent="Supprimer")};r();try{let z=await fetch(`${P}/${encodeURIComponent(x)}`,{method:"DELETE"});if(!z.ok){let S=await z.json().catch(()=>({}));throw new Error(S.message||"Suppression impossible.")}v=v.filter(S=>S.id!==x),U=U.filter(S=>S.id!==x),W("M\xE9dia supprim\xE9"),ae(),oe(),ge()}catch(z){console.error("[media] delete failed",z),W(z.message||"Impossible de supprimer ce m\xE9dia.")}finally{p(),je()}};D==null||D.addEventListener("click",je),j==null||j.addEventListener("click",r=>{r.target===j&&je()}),F==null||F.addEventListener("click",()=>ce()),u==null||u.addEventListener("click",ve),I==null||I.addEventListener("click",async()=>{if(m){ze();return}if(!(!x||!P||!T)){Z(!0);try{let r={alt:T.value||""},p=await fetch(`${P}/${encodeURIComponent(x)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!p.ok){let S=await p.json().catch(()=>({}));throw new Error(S.message||"Impossible de mettre \xE0 jour ce m\xE9dia.")}let z=await p.json();v=v.map(S=>S.id===x?{...S,...z}:S),U=U.map(S=>S.id===x?{...S,...z}:S),i=!1,Z(!1),W("M\xE9dia mis \xE0 jour")}catch(r){console.error("[media] update failed",r),W(r.message||"\xC9chec de la mise \xE0 jour."),Z(!1)}}}),Me()}});})();
