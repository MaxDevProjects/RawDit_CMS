(()=>{document.addEventListener("DOMContentLoaded",()=>{console.log("[admin] Atelier charg\xE9");let $e=document.querySelector("[data-logout]");$e&&$e.addEventListener("click",async()=>{$e.disabled=!0;try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(s){console.error("[admin] Impossible de se d\xE9connecter",s)}finally{window.location.href="/admin/index.html"}});let de=document.querySelector("[data-admin-sidebar]"),F=document.querySelector("[data-admin-sidebar-overlay]"),rt=document.querySelectorAll("[data-admin-sidebar-toggle]"),At=document.querySelectorAll("[data-admin-sidebar-close]"),Ve=document.body,we=!1,Se=()=>{if(!de)return;if(window.matchMedia("(min-width: 1024px)").matches){de.classList.remove("hidden"),F==null||F.classList.add("hidden"),Ve.classList.remove("overflow-hidden");return}we?(de.classList.remove("hidden"),F==null||F.classList.remove("hidden"),Ve.classList.add("overflow-hidden")):(de.classList.add("hidden"),F==null||F.classList.add("hidden"),Ve.classList.remove("overflow-hidden"))},Tt=()=>{we=!0,Se()},He=()=>{we=!1,Se()};de&&rt.length>0&&(rt.forEach(s=>{s.addEventListener("click",Tt)}),At.forEach(s=>{s.addEventListener("click",He)}),F==null||F.addEventListener("click",He),window.addEventListener("resize",Se),window.addEventListener("keydown",s=>{s.key==="Escape"&&we&&He()}),Se());let it="clower:currentSite",lt="clower:currentSiteName",v={slug:null,name:""};(()=>{try{v.slug=window.localStorage.getItem(it),v.name=window.localStorage.getItem(lt)||""}catch{v.slug=null,v.name=""}})();let Oe=document.querySelectorAll("[data-site-card]"),It=document.querySelectorAll("[data-site-select]"),ue=document.querySelector("[data-current-site-name]"),ct=document.querySelector("[data-workspace-site-name]"),dt=document.querySelector("[data-workspace-back-name]"),K=document.querySelector("[data-workspace-back-modal]"),Ft=document.querySelectorAll("[data-workspace-back]"),Nt=document.querySelectorAll("[data-workspace-back-cancel]"),Re=document.querySelector("[data-workspace-back-confirm]"),Dt=document.querySelectorAll("[data-workspace-tab]"),ze=document.querySelector("[data-site-toast]"),ut=document.querySelector("[data-site-toast-message]"),Pt=document.querySelectorAll("[data-site-create]"),x=document.querySelector("[data-site-modal]"),_=document.querySelector("[data-site-form]"),P=document.querySelector("[data-site-name]"),V=document.querySelector("[data-site-slug]"),q=document.querySelector("[data-site-slug-error]"),H=document.querySelector("[data-site-modal-error]"),Mt=document.querySelectorAll("[data-site-modal-cancel]"),re=document.querySelector("[data-site-modal-submit]"),S=zt(),Le=!1,xe=null,We=null,jt='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',mt=s=>{if(!x||x.classList.contains("hidden")||s.key!=="Tab")return;let o=Array.from(x.querySelectorAll(jt)).filter(g=>!g.hasAttribute("disabled")&&!g.getAttribute("aria-hidden"));if(o.length===0)return;let d=o[0],f=o[o.length-1];s.shiftKey?document.activeElement===d&&(s.preventDefault(),f.focus()):document.activeElement===f&&(s.preventDefault(),d.focus())},O=s=>{!ze||!ut||(ut.textContent=s,ze.classList.remove("hidden"),We&&clearTimeout(We),We=setTimeout(()=>{ze.classList.add("hidden")},2500))};function J(s){return s?s.startsWith("/")?s:`/${s}`:""}function ie(s){return(s==null?void 0:s.replace(/^\//,""))||""}let Ce=(s,o)=>{let d=s?J(s):null;try{d&&(window.localStorage.setItem(it,d),v.slug=d),typeof o=="string"&&o.length>0&&(window.localStorage.setItem(lt,o),v.name=o)}catch{v.slug=d||v.slug,v.name=o||v.name}},pt=s=>{ue&&s&&(ue.textContent=s),ct&&s&&(ct.textContent=s),dt&&s&&(dt.textContent=s)},Ue=s=>{Dt.forEach(o=>{let d=o.dataset.workspaceTab;if(!d)return;if(!s){o.href="#",o.classList.add("pointer-events-none","opacity-50","text-slate-400"),o.setAttribute("aria-disabled","true");return}let f=encodeURIComponent(ie(s));o.href=`/admin/site/${f}/${d}`,o.classList.remove("pointer-events-none","opacity-50","text-slate-400"),o.removeAttribute("aria-disabled")})},ke=(s,o={})=>{if(!s)return;let d=J(s),f=o.siteName||v.name||(ue==null?void 0:ue.dataset.defaultSiteName)||"";Oe.forEach(h=>{let L=J(h.dataset.siteCard||"")===d,c=h.querySelector("[data-site-active-badge]");L?(h.classList.add("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),h.classList.remove("border-slate-200"),c==null||c.classList.remove("hidden"),f=h.dataset.siteName||f):(h.classList.remove("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),h.classList.add("border-slate-200"),c==null||c.classList.add("hidden"))}),o.persist!==!1&&Ce(d,o.siteName||f);let g=o.siteName||f;pt(g),Ue(d)},$t=async(s,o)=>{let d=J(s);try{let f=await fetch("/api/sites/select",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slug:d})});if(!f.ok){let c=await f.json().catch(()=>({}));O(c.message||"Impossible de s\xE9lectionner ce site.");return}let g=await f.json().catch(()=>({})),h=J(g.slug||d),y=g.name||o;Ce(h,y),ke(h,{siteName:y,persist:!1});let L=encodeURIComponent(ie(h));window.location.href=`/admin/site/${L}/design`}catch(f){console.error("[admin] Impossible de s\xE9lectionner le site",f),O("Erreur inattendue lors de la s\xE9lection.")}},Vt=async()=>{try{let s=await fetch("/api/sites/current",{credentials:"same-origin"});if(!s.ok){s.status===404&&S&&(window.location.href="/admin/sites");return}let o=await s.json(),d=J(o.slug);Ce(d,o.name),ke(d,{siteName:o.name,persist:!1})}catch(s){console.warn("[admin] Impossible de r\xE9cup\xE9rer le site actif",s)}};(()=>{if(v.slug){ke(v.slug,{siteName:v.name,persist:!1});return}let s=document.querySelector('[data-site-card][data-site-default="true"]')||Oe[0];s&&ke(s.dataset.siteCard,{siteName:s.dataset.siteName||"",persist:!1})})(),Vt(),S?Ue(S.slugValue):v.slug&&Ue(v.slug),It.forEach(s=>{s.addEventListener("click",()=>{if(s.disabled)return;let o=s.dataset.siteSelect,d=s.dataset.siteSelectName||"Ce site";o&&(s.disabled=!0,$t(o,d).finally(()=>{s.disabled=!1}))})});let Ee=s=>s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),Ht=s=>{let o=Ee(s||"");return o?`/${o}`:""},Ot=()=>{x&&(xe=document.activeElement,x.classList.remove("hidden"),x.classList.add("flex"),Le=!1,_==null||_.reset(),q&&(q.textContent=""),H&&(H.textContent=""),V&&P&&(V.value=Ee(P.value)),document.addEventListener("keydown",mt),window.setTimeout(()=>{P==null||P.focus()},0))},qe=()=>{x&&(x.classList.add("hidden"),x.classList.remove("flex"),document.removeEventListener("keydown",mt),Le=!1,_==null||_.reset(),q&&(q.textContent=""),H&&(H.textContent=""),xe==null||xe.focus())};Pt.forEach(s=>{s.addEventListener("click",Ot)}),Mt.forEach(s=>{s.addEventListener("click",qe)}),x==null||x.addEventListener("click",s=>{s.target===x&&qe()}),P==null||P.addEventListener("input",()=>{V&&(!Le||V.value.trim().length===0)&&(V.value=Ee(P.value))}),V==null||V.addEventListener("input",()=>{Le=!0,q&&(q.textContent="")});let Rt=()=>new Set(Array.from(Oe).map(s=>J(s.dataset.siteCard||"")));_==null||_.addEventListener("submit",async s=>{if(s.preventDefault(),!P||!V)return;let o=(P.value||"").trim(),d=V.value||"";d||(d=o);let f=Ht(d);if(!o||!f){q&&(q.textContent="Nom et slug sont requis.");return}if(Rt().has(f)){q&&(q.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}q&&(q.textContent=""),H&&(H.textContent=""),re&&(re.disabled=!0,re.textContent="Cr\xE9ation...");try{let h=await fetch("/api/sites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:o,slug:f})});if(!h.ok){let X=await h.json().catch(()=>({})),B=X.message||"Impossible de cr\xE9er ce site.";H&&(H.textContent=B),X.field==="slug"&&q&&(q.textContent=B);return}let y=await h.json(),L=J((y==null?void 0:y.slug)||f),c=(y==null?void 0:y.name)||o;Ce(L,c),qe();let R=encodeURIComponent(ie(L));window.location.href=`/admin/site/${R}/design`}catch(h){console.error("[admin] Impossible de cr\xE9er le site",h),H&&(H.textContent="Erreur inattendue. R\xE9essaie dans un instant.")}finally{re&&(re.disabled=!1,re.textContent="Cr\xE9er")}}),window.addEventListener("keydown",s=>{s.key==="Escape"&&(x&&!x.classList.contains("hidden")&&qe(),K&&!K.classList.contains("hidden")&&ft(),blockDeleteModal&&!blockDeleteModal.classList.contains("hidden")&&closeBlockDeleteModal(),blockLibraryOpen&&closeBlockLibrary())});function zt(){let s=window.location.pathname.match(/^\/admin\/site\/([^/]+)(?:\/([^/]+))?/);return s?{slugPart:decodeURIComponent(s[1]),slugValue:J(decodeURIComponent(s[1])),section:s[2]||"design"}:null}function Wt(){if(!K){window.location.href="/admin/sites";return}K.classList.remove("hidden"),K.classList.add("flex")}function ft(){K&&(K.classList.add("hidden"),K.classList.remove("flex"))}Ft.forEach(s=>{s.addEventListener("click",Wt)}),Nt.forEach(s=>{s.addEventListener("click",ft)}),Re==null||Re.addEventListener("click",()=>{window.location.href="/admin/sites"}),(S==null?void 0:S.section)==="design"&&Ut(),(S==null?void 0:S.section)==="content"&&_t(),S&&v.name&&pt(v.name);function Ut(){let s=document.querySelectorAll("[data-page-list]");if(s.length===0)return;let o=document.querySelector("[data-active-page-title]"),d=document.querySelector("[data-active-page-slug]"),f=document.querySelector("[data-page-preview-tags]"),g=document.querySelector("[data-page-preview-frame]"),h=document.querySelector("[data-preview-open]"),y=document.querySelector("[data-preview-status]"),L=document.querySelector("[data-preview-highlight]"),c=document.querySelector("[data-blocks-list]"),R=document.querySelector("[data-blocks-empty]"),X=document.querySelector("[data-block-count]"),B=document.querySelector("[data-block-library-toggle]"),A=document.querySelector("[data-block-library]"),ee=document.querySelectorAll("[data-block-add]"),N=document.querySelector("[data-block-delete-modal]"),te=document.querySelector("[data-block-delete-confirm]"),ne=document.querySelector("[data-block-delete-cancel]"),T=document.querySelector("[data-block-detail-empty]"),M=document.querySelector("[data-block-detail-status]"),j=document.querySelector("[data-block-editor]"),p=document.querySelector("[data-block-editor-block-name]"),w=document.querySelector("[data-block-editor-block-type]"),m=document.querySelector("[data-block-editor-unsupported]"),u=document.querySelector("[data-block-form]"),Jt=u?Array.from(u.querySelectorAll("[data-editor-section]")):[],_e=document.querySelector("[data-block-form-cancel]"),gt=u==null?void 0:u.querySelector("[data-group-preview-mobile]"),ht=u==null?void 0:u.querySelector("[data-group-preview-desktop]"),Gt={hero:{section:"hero",labelField:"title",descriptionField:"subtitle",fields:{title:"hero-title",subtitle:"hero-subtitle",ctaLabel:"hero-cta-label",ctaUrl:"hero-cta-url",image:"hero-image",align:"hero-align"}},paragraphe:{section:"paragraph",labelField:"title",descriptionField:"content",fields:{title:"paragraph-title",content:"paragraph-content",align:"paragraph-align"}},image:{section:"image",labelField:"alt",fields:{src:"image-src",alt:"image-alt",showCaption:"image-caption-toggle",caption:"image-caption"}},groupe:{section:"group",fields:{layout:"group-layout",columnsMobile:"group-columns-mobile",columnsDesktop:"group-columns-desktop"}}},Yt={texte:"paragraphe",paragraph:"paragraphe",paragraphs:"paragraphe",paragraphes:"paragraphe",text:"paragraphe",hero:"hero",image:"image",groupe:"groupe",group:"groupe"},vt=(e,t)=>{if(!gt||!ht)return;let n=a=>Array.from({length:Number(a)||1}).map(()=>'<span class="block h-2 w-full rounded-full bg-slate-300"></span>').join("");gt.innerHTML=n(e),ht.innerHTML=n(t)},Kt=async()=>{if(!Z)return[];let e=await fetch(Z,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les pages.");let t=await e.json().catch(()=>[]);return Array.isArray(t)?t:[]},Xt=async({title:e,slug:t})=>{if(!Z)throw new Error("Site inconnu.");let n=await fetch(Z,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,slug:t})});if(!n.ok){let a=await n.json().catch(()=>({}));throw new Error(a.message||"Impossible de cr\xE9er la page.")}return n.json().catch(()=>({}))},Zt=async e=>{if(!(!Z||!(e!=null&&e.id)))try{let t=await fetch(`${Z}/${encodeURIComponent(e.id)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let a=await t.json().catch(()=>({}));throw new Error(a.message||"Impossible de sauvegarder la page.")}let n=await t.json().catch(()=>({}));return n!=null&&n.id&&(C=C.map(a=>a.id===n.id?n:a),(i==null?void 0:i.id)===n.id&&(i=n)),n}catch(t){console.error("[design] Save page failed",t),O(t.message||"Sauvegarde impossible.")}},Qt=async()=>{if(!Z){C=[],U=null,i=null,Ke(C,U),pe(null),T==null||T.classList.remove("hidden"),j==null||j.classList.add("hidden");return}try{let e=await Kt();if(C=Array.isArray(e)?e:[],C.length===0){U=null,i=null,Ke(C,U),pe(null),T==null||T.classList.remove("hidden"),j==null||j.classList.add("hidden"),g&&(g.srcdoc=Ae());return}U=mn(C),Q(U)}catch(e){console.error("[design] Impossible de charger les pages",e),O("Impossible de charger les pages.")}},en=e=>(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),yt=e=>{if(!e)return null;let t=en(e.type),n=Yt[t]||t;return Gt[n]||null},bt=e=>{var n,a;if(!u||!j)return;e&&!e.settings&&(e.settings={});let t=yt(e);if(p&&(p.textContent=(e==null?void 0:e.label)||"Bloc"),w&&(w.textContent=(e==null?void 0:e.type)||"Bloc"),!t){u.classList.add("hidden"),m==null||m.classList.remove("hidden"),u.dataset.blockId="";return}if(m==null||m.classList.add("hidden"),u.classList.remove("hidden"),u.reset(),u.dataset.blockId=e.id,Jt.forEach(r=>{r.dataset.editorSection===t.section?r.classList.remove("hidden"):r.classList.add("hidden")}),Object.entries(t.fields).forEach(([r,l])=>{var oe;let b=u.querySelector(`[name="${l}"]`);if(!b)return;let E=(oe=e.settings)==null?void 0:oe[r];b.type==="checkbox"?b.checked=!!E:(b.tagName,b.value=E!=null?E:"")}),t.section==="group"){let r=((n=u.querySelector('[name="group-columns-mobile"]'))==null?void 0:n.value)||"1",l=((a=u.querySelector('[name="group-columns-desktop"]'))==null?void 0:a.value)||"3";vt(r,l)}},tn=e=>{if(!u||!e)return{};let t={};return Object.entries(e.fields).forEach(([n,a])=>{let r=u.querySelector(`[name="${a}"]`);r&&(r.type==="checkbox"?t[n]=r.checked:r.tagName==="TEXTAREA"?t[n]=r.value||"":r.type==="select-one"?t[n]=r.value:t[n]=r.value||"")}),t},Be=e=>{if(y){if(!e){y.classList.add("hidden");return}y.classList.remove("hidden"),y.textContent=e}},nn=e=>e?{id:e.id,title:e.title,slug:e.slug,badges:[...e.badges||[]],blocks:(e.blocks||[]).map(t=>({id:t.id,type:t.type,label:t.label,status:t.status,description:t.description,props:t.props||[],settings:t.settings||{}}))}:null,Ae=()=>'<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#475569;background:#fff;">Pr\xE9paration de la pr\xE9visualisation\u2026</body></html>',sn=e=>{if(!g||!e)return;let t={page:nn(e),site:{title:v.name||"Site",slug:v.slug||""}};nt=!1,Be("Actualisation\u2026"),g.srcdoc=Ae(),he&&he.abort();let n=new AbortController;he=n,fetch("/api/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:n.signal}).then(a=>{if(!a.ok)throw new Error("Preview error");return a.json()}).then(a=>{n.signal.aborted||(tt=a.html||"",g.setAttribute("title",`Pr\xE9visualisation de la page ${e.title||""}`.trim()),g.srcdoc=tt||Ae(),Be("\xC0 jour"))}).catch(a=>{n.signal.aborted||(console.error("[preview] Impossible de rendre la page",a),Be("Erreur preview"),g.srcdoc='<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#be123c;background:#fff;">Erreur lors du rendu de la pr\xE9visualisation.</body></html>')}).finally(()=>{he===n&&(he=null)})},an=e=>{if(e.preventDefault(),!i||!k)return;let t=Xe(),n=yt(t);if(!t||!n)return;let a=tn(n),r=(i.blocks||[]).map(l=>{if(l.id!==t.id)return l;let b={...l.settings||{},...a},E={...l,settings:b};return n.labelField&&a[n.labelField]&&(E.label=a[n.labelField]),n.descriptionField&&a[n.descriptionField]&&(E.description=a[n.descriptionField]),E});fe(r),O("Bloc mis \xE0 jour"),Q(i.id,{preserveBlock:!0})},se=document.querySelector("[data-page-drawer]"),D=document.querySelector("[data-page-drawer-backdrop]"),on=document.querySelectorAll("[data-page-drawer-open]"),rn=document.querySelectorAll("[data-page-drawer-close]"),ae=document.querySelector("[data-add-page-toggle]"),$=document.querySelector("[data-add-page-form]"),z=document.querySelector("[data-add-page-title]"),W=document.querySelector("[data-add-page-slug]"),Je=document.querySelector("[data-add-page-cancel]"),I=document.querySelector("[data-add-page-error]"),le=$==null?void 0:$.querySelector('[type="submit"]'),ln=ie((S==null?void 0:S.slugValue)||v.slug||"default")||"default",cn=(S==null?void 0:S.slugValue)||v.slug||"",wt=ie(cn)||"",Z=wt?`/api/sites/${encodeURIComponent(wt)}/pages`:null,St={active:`clower:activePage:${ln}`},Ge=(e,t,n,a,r,l=[],b={})=>({id:e,label:t,type:n,status:a,description:r,props:l,settings:{...b}}),dn={hero:{type:"Hero",label:"Hero de page",description:"Section pleine largeur avec CTA principal.",status:"Brouillon",props:[{label:"CTA",value:"D\xE9couvrir"},{label:"Hauteur",value:"80vh"}],settings:{title:"Titre du hero",subtitle:"",ctaLabel:"D\xE9couvrir",ctaUrl:"#",image:"",align:"center"}},paragraph:{type:"Paragraphe",label:"Bloc \xE9ditorial",description:"Paragraphe libre pour raconter votre histoire.",status:"Brouillon",props:[{label:"Longueur",value:"150 mots"}],settings:{title:"Titre du paragraphe",content:"",align:"left"}},image:{type:"Image",label:"Bloc image",description:"Visuel seul avec l\xE9gende optionnelle.",status:"Brouillon",props:[{label:"Ratio",value:"16:9"},{label:"L\xE9gende",value:"Inactive"}],settings:{src:"",alt:"",showCaption:!1,caption:""}},group:{type:"Groupe",label:"Groupe de sections",description:"Conteneur pour imbriquer plusieurs sous-blocs.",status:"Brouillon",props:[{label:"Disposition",value:"Verticale"}],settings:{layout:"grid",columnsMobile:"1",columnsDesktop:"3"}}},un=e=>{try{window.localStorage.setItem(St.active,e)}catch{}},mn=e=>{var t;try{let n=window.localStorage.getItem(St.active);if(n&&e.some(a=>a.id===n))return n}catch{}return((t=e[0])==null?void 0:t.id)||null},pn=e=>!e||e<=0?"0 bloc":e===1?"1 bloc":`${e} blocs`,Lt=e=>{if(!e||e==="/")return"/";let t=Ee(e.replace(/^\//,""));return t?`/${t}`:"/"},Ye=(e="page",t="block")=>`${e}-${t}-${Date.now().toString(36)}-${Math.floor(Math.random()*1e3)}`,Dn=(e,t)=>[Ge(Ye(e,"intro"),"Introduction","Paragraphe","Brouillon",`Paragraphe introductif pour "${t}".`,[{label:"Longueur",value:"2 paragraphes"}],{title:`Introduction \xE0 ${t}`,content:"Ajoutez votre premier paragraphe de pr\xE9sentation.",align:"left"}),Ge(Ye(e,"content"),"Zone de contenu","Groupe","Brouillon","Section principale \xE0 composer avec textes et visuels.",[{label:"Colonnes",value:"Auto"}],{layout:"grid",columnsMobile:"1",columnsDesktop:"2"})],fn=e=>{o&&(o.textContent=(e==null?void 0:e.title)||"Page"),d&&(d.textContent=(e==null?void 0:e.slug)||"/")},gn=e=>{if(!f)return;f.innerHTML="",(e&&e.badges&&e.badges.length>0?e.badges:["Structure en cours"]).forEach(n=>{let a=document.createElement("span");a.className="rounded-full bg-slate-100 px-3 py-1",a.textContent=n,f.appendChild(a)})},hn=e=>{switch((e||"").toLowerCase()){case"en ligne":return"bg-emerald-50 text-emerald-700";case"brouillon":return"bg-amber-50 text-amber-700";default:return"bg-slate-100 text-slate-600"}},Te=e=>{if(!(!T||!j)){if(!e){T.classList.remove("hidden"),j.classList.add("hidden"),m==null||m.classList.add("hidden"),u==null||u.classList.add("hidden"),M==null||M.classList.add("hidden");return}T.classList.add("hidden"),j.classList.remove("hidden"),M&&(e.status?(M.textContent=e.status,M.className=`rounded-full px-3 py-1 text-xs font-semibold ${hn(e.status)}`,M.classList.remove("hidden")):M.classList.add("hidden")),bt(e)}},me=e=>{if(!g)return;let t=g.contentDocument;if(!t)return;t.querySelectorAll("[data-preview-block]").forEach(a=>{a.dataset.previewBlock===e?(a.classList.add("preview-block-active"),nt&&e&&a.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})):a.classList.remove("preview-block-active")}),L&&(L.style.borderColor=e?"rgba(156, 107, 255, 0.5)":"transparent")},pe=e=>{if(!c)return;c.innerHTML="";let t=(e==null?void 0:e.blocks)||[];if(X&&(X.textContent=pn(t.length)),t.length===0){c.classList.add("hidden"),R==null||R.classList.remove("hidden");return}c.classList.remove("hidden"),R==null||R.classList.add("hidden"),t.forEach(n=>{let a=n.id===k,r=document.createElement("div");r.dataset.blockItem="true",r.dataset.blockId=n.id,r.setAttribute("role","option"),r.setAttribute("aria-selected",a?"true":"false"),r.tabIndex=0,r.className=["relative flex items-center gap-3 rounded-2xl border px-3 py-2 text-left transition",a?"bg-slate-100 border-[#9C6BFF]/40 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let l=document.createElement("span");l.className=`absolute inset-y-2 left-0 w-1 rounded-full bg-[#9C6BFF] ${a?"":"hidden"}`,r.appendChild(l);let b=document.createElement("div");b.className="flex flex-1 items-center gap-3";let E=document.createElement("div");E.className="hidden lg:flex cursor-grab flex-shrink-0 items-center text-lg text-slate-400",E.innerHTML="&#8801;",b.appendChild(E);let oe=document.createElement("div");oe.className="flex-1";let Pe=document.createElement("div");Pe.className="flex items-center gap-2 text-[11px] uppercase tracking-wide text-slate-500";let st=document.createElement("span");st.className="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600",st.textContent=n.type;let at=document.createElement("span");at.className="text-slate-400",at.textContent=n.status,Pe.appendChild(st),Pe.appendChild(at);let ot=document.createElement("p");ot.className="mt-1 text-sm font-semibold text-slate-900";let In=n.settings&&n.settings.title||n.label||"Bloc sans titre";ot.textContent=In,oe.appendChild(Pe),oe.appendChild(ot),b.appendChild(oe),r.appendChild(b);let Me=document.createElement("div");Me.className="flex flex-col gap-1 text-xs text-slate-400";let je=document.createElement("div");je.className="flex items-center gap-1 lg:hidden";let ve=document.createElement("button");ve.type="button",ve.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",ve.textContent="\u2191",ve.addEventListener("click",Y=>{Y.stopPropagation(),xt(n.id,-1)});let ye=document.createElement("button");ye.type="button",ye.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",ye.textContent="\u2193",ye.addEventListener("click",Y=>{Y.stopPropagation(),xt(n.id,1)}),je.appendChild(ve),je.appendChild(ye),Me.appendChild(je);let be=document.createElement("button");be.type="button",be.className="inline-flex items-center justify-center rounded-lg border border-transparent px-2 py-1 text-[12px] text-rose-500 hover:text-rose-700",be.innerHTML="\u{1F5D1}\uFE0F",be.addEventListener("click",Y=>{Y.stopPropagation(),Sn(n.id)}),Me.appendChild(be),r.appendChild(Me),r.addEventListener("click",()=>{ce(n.id)}),r.addEventListener("keydown",Y=>{(Y.key==="Enter"||Y.key===" ")&&(Y.preventDefault(),ce(n.id))}),c.appendChild(r)})},Ke=(e,t)=>{s.forEach(n=>{n.innerHTML="",e.forEach(a=>{let r=document.createElement("li"),l=document.createElement("button");l.type="button",l.dataset.pageId=a.id,l.className=["w-full flex items-center justify-between gap-3 px-3 py-2 text-left transition",t===a.id?"bg-[#9C6BFF]/10 text-slate-900 border border-[#9C6BFF]/40 rounded-xl shadow-sm":"text-slate-700 hover:bg-slate-50 rounded-xl"].join(" "),t===a.id?l.setAttribute("aria-current","page"):l.removeAttribute("aria-current"),l.innerHTML=`
            <div class="flex items-center gap-3">
              <span class="flex h-9 w-9 items-center justify-center rounded-xl border border-slate-200 bg-white text-slate-500">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6.5 4.5h7l4 4v11a1 1 0 0 1-1 1h-10a1 1 0 0 1-1-1v-14a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
                  <path d="M13.5 4.5v4a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.4"/>
                </svg>
              </span>
              <div class="flex flex-col">
                <span class="text-sm font-semibold">${a.title}</span>
                <span class="text-xs text-slate-500">${a.slug}</span>
              </div>
            </div>
          `,l.addEventListener("click",()=>{Q(a.id),Qe()||et()}),r.appendChild(l),n.appendChild(r)})})},Xe=()=>!i||!Array.isArray(i.blocks)?null:i.blocks.find(e=>e.id===k)||null,ce=e=>{if(!i)return;if(!e){k=null,pe(i),Te(null),me(null);return}let t=i.blocks.find(n=>n.id===e)||i.blocks[0]||null;k=(t==null?void 0:t.id)||null,pe(i),Te(t),me(k)},fe=e=>{if(!i)return;let t={...i,blocks:e};Ln(t)},Ie=()=>window.matchMedia("(min-width: 1024px)").matches;function xt(e,t){if(!i||!e||!t)return;let n=[...i.blocks||[]],a=n.findIndex(b=>b.id===e);if(a<0)return;let r=a+t;if(r<0||r>=n.length)return;let[l]=n.splice(a,1);n.splice(r,0,l),fe(n),Q(i.id,{preserveBlock:!0}),ce(l.id)}function vn(e,t){if(!i||!e||!t||e===t)return;let n=[...i.blocks||[]],a=n.findIndex(b=>b.id===e),r=n.findIndex(b=>b.id===t);if(a<0||r<0)return;let[l]=n.splice(a,1);n.splice(r,0,l),fe(n),Q(i.id,{preserveBlock:!0}),ce(l.id)}function Ct(){if(!c)return;let e=Ie();c.querySelectorAll("[data-block-item]").forEach(t=>{t.setAttribute("draggable",e?"true":"false")})}function Fe(){A&&(A.classList.add("hidden"),ge=!1)}function yn(){A&&(A.classList.remove("hidden"),ge=!0)}function bn(){ge?Fe():yn()}function wn(e){if(!i||!e)return;let t=dn[e];if(!t)return;let n=(i.blocks||[]).filter(l=>l.type===t.type).length+1,a=Ge(Ye(i.id,e),`${t.label} ${n}`,t.type,t.status,t.description,t.props,t.settings||{}),r=[...i.blocks||[],a];fe(r),Q(i.id,{preserveBlock:!0}),ce(a.id),Fe(),O("Bloc ajout\xE9")}function kt(e){var a,r;if(!i)return;let t=(i.blocks||[]).filter(l=>l.id!==e),n=e===k?((a=t[0])==null?void 0:a.id)||null:k||((r=t[0])==null?void 0:r.id)||null;fe(t),k=n,Q(i.id,{preserveBlock:!0}),k?ce(k):(Te(null),me(null)),O("Bloc supprim\xE9")}function Ze(){N&&(N.classList.add("hidden"),N.classList.remove("flex"),De=null)}function Sn(e){if(!N){kt(e);return}De=e,N.classList.remove("hidden"),N.classList.add("flex")}let Ln=e=>{e&&(C=C.map(t=>t.id===e.id?e:t),i=e,Zt(e))},Q=(e,t={})=>{var a,r;let n=C.find(l=>l.id===e)||C[0]||null;i=n,U=(n==null?void 0:n.id)||null,(!t.preserveBlock||!i||!i.blocks.some(l=>l.id===k))&&(k=((r=(a=i==null?void 0:i.blocks)==null?void 0:a[0])==null?void 0:r.id)||null),U&&un(U),Ke(C,U),fn(i),gn(i),sn(i),pe(i),Te(Xe()),me(k),Ct(),ge&&Fe()},Qe=()=>window.matchMedia("(min-width: 1024px)").matches,Et=()=>{se&&(Qe()?(se.classList.add("is-open"),D==null||D.classList.add("hidden"),document.body.classList.remove("overflow-hidden")):se.classList.remove("is-open"))},xn=()=>{!se||Qe()||(se.classList.add("is-open"),D==null||D.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},et=()=>{se&&(se.classList.remove("is-open"),D==null||D.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))},Cn=()=>{!$||!ae||($.classList.remove("hidden"),ae.classList.add("hidden"),I&&(I.textContent=""),Ne=!1,z&&(z.value="",z.focus()),W&&(W.value=""))},qt=()=>{!$||!ae||($.classList.add("hidden"),ae.classList.remove("hidden"),I&&(I.textContent=""),Ne=!1,$.reset())},kn=()=>{!z||!W||Ne&&W.value.trim().length>0||(W.value=Lt(z.value))},C=[],U=null,Ne=!1,i=null,k=null,ge=!1,De=null,tt="",nt=!1,he=null;Et(),on.forEach(e=>{e.addEventListener("click",xn)}),rn.forEach(e=>{e.addEventListener("click",et)}),D==null||D.addEventListener("click",et),window.addEventListener("resize",()=>{Et(),Ct()}),ae==null||ae.addEventListener("click",Cn),Je==null||Je.addEventListener("click",qt),z==null||z.addEventListener("input",kn),W==null||W.addEventListener("input",()=>{I&&(I.textContent=""),Ne=!0}),$==null||$.addEventListener("submit",async e=>{if(e.preventDefault(),!Z){I&&(I.textContent="Aucun site s\xE9lectionn\xE9.");return}if(!z||!W)return;let t=z.value.trim(),n=Lt(W.value.trim()||t);if(!t||!n){I&&(I.textContent="Titre et slug sont requis.");return}I&&(I.textContent=""),le&&(le.disabled=!0,le.textContent="Cr\xE9ation...");try{let a=await Xt({title:t,slug:n});if(!a||!a.id)throw new Error("R\xE9ponse invalide.");C=[...C,a],qt(),O("Page cr\xE9\xE9e"),Q(a.id)}catch(a){console.error("[design] create page failed",a),I&&(I.textContent=a.message||"Impossible de cr\xE9er la page.")}finally{le&&(le.disabled=!1,le.textContent="Cr\xE9er")}}),B==null||B.addEventListener("click",e=>{e.stopPropagation(),bn()}),document.addEventListener("click",e=>{ge&&(A!=null&&A.contains(e.target)||B!=null&&B.contains(e.target)||Fe())}),ee.forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();let n=e.dataset.blockAdd;wn(n)})}),ne==null||ne.addEventListener("click",()=>{Ze()}),te==null||te.addEventListener("click",()=>{De&&kt(De),Ze()}),N==null||N.addEventListener("click",e=>{e.target===N&&Ze()}),u==null||u.addEventListener("input",e=>{var n,a;let t=e.target;if(!(!t||!t.name)&&(t.name==="group-columns-mobile"||t.name==="group-columns-desktop")){let r=((n=u.querySelector('[name="group-columns-mobile"]'))==null?void 0:n.value)||"1",l=((a=u.querySelector('[name="group-columns-desktop"]'))==null?void 0:a.value)||"3";vt(r,l)}}),u==null||u.addEventListener("submit",an),_e==null||_e.addEventListener("click",e=>{e.preventDefault();let t=Xe();t&&bt(t)}),g==null||g.addEventListener("load",()=>{nt=!0,Be("\xC0 jour"),me(k)}),h==null||h.addEventListener("click",()=>{let e=window.open("","_blank");if(!e)return;e.opener=null;let t=e.document;t.open(),t.write(tt||Ae()),t.close()});let En=e=>{let t=e.target.closest("[data-block-item]");!t||!Ie()||(G=t.dataset.blockId||null,G&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",G),t.classList.add("opacity-50")))},Bt=()=>{c==null||c.querySelectorAll("[data-block-item]").forEach(e=>e.classList.remove("opacity-50","ring-2","ring-[#9C6BFF]/50"))},qn=()=>{G=null,Bt()},Bn=e=>{if(!G||!Ie())return;let t=e.target.closest("[data-block-item]");!t||t.dataset.blockId===G||(e.preventDefault(),t.classList.add("ring-2","ring-[#9C6BFF]/50"))},An=e=>{let t=e.target.closest("[data-block-item]");t&&t.classList.remove("ring-2","ring-[#9C6BFF]/50")},Tn=e=>{if(!G||!Ie())return;e.preventDefault();let t=e.target.closest("[data-block-item]"),n=G;G=null,Bt();let a=(t==null?void 0:t.dataset.blockId)||null;a&&vn(n,a)},G=null;c==null||c.addEventListener("dragstart",En),c==null||c.addEventListener("dragend",qn),c==null||c.addEventListener("dragover",Bn),c==null||c.addEventListener("dragleave",An),c==null||c.addEventListener("drop",Tn),Qt()}function _t(){let s=document.querySelector("[data-collection-list]");if(!s)return;let o=document.querySelector("[data-collection-empty]"),d=document.querySelector("[data-collection-items-empty]"),f=document.querySelector("[data-collection-items]"),g=document.querySelector("[data-collection-title]"),h=document.querySelector("[data-collection-description]"),y=document.querySelector("[data-collection-drawer]"),L=document.querySelector("[data-collection-drawer-backdrop]"),c=document.querySelectorAll("[data-collection-drawer-open]"),R=document.querySelectorAll("[data-collection-drawer-close]"),X=ie((S==null?void 0:S.slugValue)||v.slug||""),B=X?`/api/sites/${encodeURIComponent(X)}/collections`:null,A=[],ee=null,N=()=>{y&&(y.classList.add("is-open"),y.style.transform="translateX(0)",L==null||L.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},te=()=>{y&&(y.classList.remove("is-open"),y.style.transform="",L==null||L.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))};c.forEach(p=>{p.addEventListener("click",N)}),R.forEach(p=>{p.addEventListener("click",te)}),L==null||L.addEventListener("click",te);let ne=()=>{if(s.innerHTML="",!A.length){o==null||o.classList.remove("hidden");return}o==null||o.classList.add("hidden"),A.forEach(p=>{let w=p.id===ee,m=document.createElement("button");m.type="button",m.dataset.collectionId=p.id,m.className=["w-full rounded-xl border px-3 py-2 text-left transition focus:outline-none focus:ring-2 focus:ring-[#9C6BFF]/40",w?"bg-[#F7F0FF] border-[#9C6BFF]/40 text-slate-900":"border-slate-200 text-slate-700 hover:border-[#9C6BFF]/40"].join(" "),m.setAttribute("role","option"),w?m.setAttribute("aria-current","true"):m.removeAttribute("aria-current"),m.innerHTML=`
          <div class="flex items-center justify-between gap-2">
            <div>
              <p class="text-sm font-semibold">${p.name||p.id}</p>
              <p class="text-xs text-slate-500">${p.description||""}</p>
            </div>
            <span class="text-[11px] uppercase tracking-wide text-slate-400">${p.type||""}</span>
          </div>
        `,m.addEventListener("click",()=>{M(p.id),window.matchMedia("(min-width: 1024px)").matches||te()}),s.appendChild(m)})},T=p=>{if(f){if(f.innerHTML="",!p||p.length===0){d==null||d.classList.remove("hidden");return}d==null||d.classList.add("hidden"),p.forEach(w=>{let m=document.createElement("article");m.className="rounded-2xl border border-slate-200 bg-white px-4 py-3 shadow-sm hover:border-[#9C6BFF]/40",m.innerHTML=`
          <div class="flex items-center justify-between gap-2">
            <div>
              <p class="text-sm font-semibold text-slate-900">${w.title||"Item"}</p>
              <p class="text-xs text-slate-500">${w.summary||""}</p>
            </div>
            <span class="text-[11px] uppercase tracking-wide ${(w.status||"").toLowerCase()==="publi\xE9"?"text-emerald-600":"text-amber-600"}">${w.status||""}</span>
          </div>
        `,f.appendChild(m)})}},M=async p=>{if(!p||ee===p)return;ee=p;let w=A.find(m=>m.id===p);if(g&&(g.textContent=(w==null?void 0:w.name)||"Collection"),h&&(h.textContent=(w==null?void 0:w.description)||""),ne(),!B){T([]);return}try{let m=await fetch(`${B}/${encodeURIComponent(p)}/items`,{headers:{Accept:"application/json"}});if(!m.ok)throw new Error("Impossible de charger les items.");let u=await m.json().catch(()=>({items:[]}));T(u.items||[])}catch(m){console.error("[content] items failed",m),O(m.message||"Impossible de charger les items."),T([])}};(async()=>{if(!B){o==null||o.classList.remove("hidden");return}try{let p=await fetch(B,{headers:{Accept:"application/json"}});if(!p.ok)throw new Error("Impossible de charger les collections.");let w=await p.json().catch(()=>[]);A=Array.isArray(w)?w:[],A.length>0?(ee=A[0].id,ne(),M(ee)):(ne(),T([]))}catch(p){console.error("[content] load collections",p),O(p.message||"Impossible de charger les collections.")}})()}});})();
