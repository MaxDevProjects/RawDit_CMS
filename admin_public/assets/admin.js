(()=>{document.addEventListener("DOMContentLoaded",()=>{console.log("[admin] Atelier charg\xE9");let qt=document.querySelector("[data-logout]");qt&&qt.addEventListener("click",async()=>{qt.disabled=!0;try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(o){console.error("[admin] Impossible de se d\xE9connecter",o)}finally{window.location.href="/admin/index.html"}});let _e=document.querySelector("[data-admin-sidebar]"),pe=document.querySelector("[data-admin-sidebar-overlay]"),Gt=document.querySelectorAll("[data-admin-sidebar-toggle]"),us=document.querySelectorAll("[data-admin-sidebar-close]"),kt=document.body,dt=!1,ut=()=>{if(!_e)return;if(window.matchMedia("(min-width: 1024px)").matches){_e.classList.remove("hidden"),pe==null||pe.classList.add("hidden"),kt.classList.remove("overflow-hidden");return}dt?(_e.classList.remove("hidden"),pe==null||pe.classList.remove("hidden"),kt.classList.add("overflow-hidden")):(_e.classList.add("hidden"),pe==null||pe.classList.add("hidden"),kt.classList.remove("overflow-hidden"))},ms=()=>{dt=!0,ut()},At=()=>{dt=!1,ut()};_e&&Gt.length>0&&(Gt.forEach(o=>{o.addEventListener("click",ms)}),us.forEach(o=>{o.addEventListener("click",At)}),pe==null||pe.addEventListener("click",At),window.addEventListener("resize",ut),window.addEventListener("keydown",o=>{o.key==="Escape"&&dt&&At()}),ut());let _t="clower:currentSite",Yt="clower:currentSiteName",_={slug:null,name:""};(()=>{try{_.slug=window.localStorage.getItem(_t),_.name=window.localStorage.getItem(Yt)||""}catch{_.slug=null,_.name=""}})();let It=document.querySelectorAll("[data-site-card]"),ps=document.querySelectorAll("[data-site-select]"),Ye=document.querySelector("[data-current-site-name]"),Kt=document.querySelector("[data-workspace-site-name]"),Xt=document.querySelector("[data-workspace-back-name]"),Ne=document.querySelector("[data-workspace-back-modal]"),fs=document.querySelectorAll("[data-workspace-back]"),gs=document.querySelectorAll("[data-workspace-back-cancel]"),Tt=document.querySelector("[data-workspace-back-confirm]"),hs=document.querySelectorAll("[data-workspace-tab]"),Bt=document.querySelector("[data-site-toast]"),Zt=document.querySelector("[data-site-toast-message]"),ys=document.querySelectorAll("[data-site-create]"),ie=document.querySelector("[data-site-modal]"),Ie=document.querySelector("[data-site-form]"),he=document.querySelector("[data-site-name]"),Le=document.querySelector("[data-site-slug]"),de=document.querySelector("[data-site-slug-error]"),Ce=document.querySelector("[data-site-modal-error]"),vs=document.querySelectorAll("[data-site-modal-cancel]"),Ue=document.querySelector("[data-site-modal-submit]"),V=Es(),mt=!1,pt=null,Ft=null,bs='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',Qt=o=>{if(!ie||ie.classList.contains("hidden")||o.key!=="Tab")return;let d=Array.from(ie.querySelectorAll(bs)).filter(F=>!F.hasAttribute("disabled")&&!F.getAttribute("aria-hidden"));if(d.length===0)return;let h=d[0],C=d[d.length-1];o.shiftKey?document.activeElement===h&&(o.preventDefault(),C.focus()):document.activeElement===C&&(o.preventDefault(),h.focus())},H=o=>{!Bt||!Zt||(Zt.textContent=o,Bt.classList.remove("hidden"),Ft&&clearTimeout(Ft),Ft=setTimeout(()=>{Bt.classList.add("hidden")},2500))};function Te(o){return o?o.startsWith("/")?o:`/${o}`:""}function Ee(o){return(o==null?void 0:o.replace(/^\//,""))||""}let ft=(o,d)=>{let h=o?Te(o):null;try{h&&(window.localStorage.setItem(_t,h),_.slug=h),typeof d=="string"&&d.length>0&&(window.localStorage.setItem(Yt,d),_.name=d)}catch{_.slug=h||_.slug,_.name=d||_.name}},es=o=>{Ye&&o&&(Ye.textContent=o),Kt&&o&&(Kt.textContent=o),Xt&&o&&(Xt.textContent=o)},$t=o=>{hs.forEach(d=>{let h=d.dataset.workspaceTab;if(!h)return;if(!o){d.href="#",d.classList.add("pointer-events-none","opacity-50","text-slate-400"),d.setAttribute("aria-disabled","true");return}let C=encodeURIComponent(Ee(o));d.href=`/admin/site/${C}/${h}`,d.classList.remove("pointer-events-none","opacity-50","text-slate-400"),d.removeAttribute("aria-disabled")})},gt=(o,d={})=>{if(!o)return;let h=Te(o),C=d.siteName||_.name||(Ye==null?void 0:Ye.dataset.defaultSiteName)||"";It.forEach(S=>{let E=Te(S.dataset.siteCard||"")===h,f=S.querySelector("[data-site-active-badge]");E?(S.classList.add("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),S.classList.remove("border-slate-200"),f==null||f.classList.remove("hidden"),C=S.dataset.siteName||C):(S.classList.remove("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),S.classList.add("border-slate-200"),f==null||f.classList.add("hidden"))}),d.persist!==!1&&ft(h,d.siteName||C);let F=d.siteName||C;es(F),$t(h)},xs=async(o,d)=>{let h=Te(o);try{let C=await fetch("/api/sites/select",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slug:h})});if(!C.ok){let f=await C.json().catch(()=>({}));H(f.message||"Impossible de s\xE9lectionner ce site.");return}let F=await C.json().catch(()=>({})),S=Te(F.slug||h),z=F.name||d;ft(S,z),gt(S,{siteName:z,persist:!1});let E=encodeURIComponent(Ee(S));window.location.href=`/admin/site/${E}/design`}catch(C){console.error("[admin] Impossible de s\xE9lectionner le site",C),H("Erreur inattendue lors de la s\xE9lection.")}},ws=async()=>{try{let o=await fetch("/api/sites/current",{credentials:"same-origin"});if(!o.ok){o.status===404&&V&&(window.location.href="/admin/sites");return}let d=await o.json(),h=Te(d.slug);ft(h,d.name),gt(h,{siteName:d.name,persist:!1})}catch(o){console.warn("[admin] Impossible de r\xE9cup\xE9rer le site actif",o)}};(()=>{if(_.slug){gt(_.slug,{siteName:_.name,persist:!1});return}let o=document.querySelector('[data-site-card][data-site-default="true"]')||It[0];o&&gt(o.dataset.siteCard,{siteName:o.dataset.siteName||"",persist:!1})})(),ws(),V?$t(V.slugValue):_.slug&&$t(_.slug),ps.forEach(o=>{o.addEventListener("click",()=>{if(o.disabled)return;let d=o.dataset.siteSelect,h=o.dataset.siteSelectName||"Ce site";d&&(o.disabled=!0,xs(d,h).finally(()=>{o.disabled=!1}))})});let Ke=o=>o.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),Ss=o=>{let d=Ke(o||"");return d?`/${d}`:""},Ls=()=>{ie&&(pt=document.activeElement,ie.classList.remove("hidden"),ie.classList.add("flex"),mt=!1,Ie==null||Ie.reset(),de&&(de.textContent=""),Ce&&(Ce.textContent=""),Le&&he&&(Le.value=Ke(he.value)),document.addEventListener("keydown",Qt),window.setTimeout(()=>{he==null||he.focus()},0))},ht=()=>{ie&&(ie.classList.add("hidden"),ie.classList.remove("flex"),document.removeEventListener("keydown",Qt),mt=!1,Ie==null||Ie.reset(),de&&(de.textContent=""),Ce&&(Ce.textContent=""),pt==null||pt.focus())};ys.forEach(o=>{o.addEventListener("click",Ls)}),vs.forEach(o=>{o.addEventListener("click",ht)}),ie==null||ie.addEventListener("click",o=>{o.target===ie&&ht()}),he==null||he.addEventListener("input",()=>{Le&&(!mt||Le.value.trim().length===0)&&(Le.value=Ke(he.value))}),Le==null||Le.addEventListener("input",()=>{mt=!0,de&&(de.textContent="")});let Cs=()=>new Set(Array.from(It).map(o=>Te(o.dataset.siteCard||"")));Ie==null||Ie.addEventListener("submit",async o=>{if(o.preventDefault(),!he||!Le)return;let d=(he.value||"").trim(),h=Le.value||"";h||(h=d);let C=Ss(h);if(!d||!C){de&&(de.textContent="Nom et slug sont requis.");return}if(Cs().has(C)){de&&(de.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}de&&(de.textContent=""),Ce&&(Ce.textContent=""),Ue&&(Ue.disabled=!0,Ue.textContent="Cr\xE9ation...");try{let S=await fetch("/api/sites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:d,slug:C})});if(!S.ok){let P=await S.json().catch(()=>({})),L=P.message||"Impossible de cr\xE9er ce site.";Ce&&(Ce.textContent=L),P.field==="slug"&&de&&(de.textContent=L);return}let z=await S.json(),E=Te((z==null?void 0:z.slug)||C),f=(z==null?void 0:z.name)||d;ft(E,f),ht();let q=encodeURIComponent(Ee(E));window.location.href=`/admin/site/${q}/design`}catch(S){console.error("[admin] Impossible de cr\xE9er le site",S),Ce&&(Ce.textContent="Erreur inattendue. R\xE9essaie dans un instant.")}finally{Ue&&(Ue.disabled=!1,Ue.textContent="Cr\xE9er")}}),window.addEventListener("keydown",o=>{o.key==="Escape"&&(ie&&!ie.classList.contains("hidden")&&ht(),Ne&&!Ne.classList.contains("hidden")&&ts(),blockDeleteModal&&!blockDeleteModal.classList.contains("hidden")&&closeBlockDeleteModal(),blockLibraryOpen&&closeBlockLibrary())});function Es(){let o=window.location.pathname.match(/^\/admin\/site\/([^/]+)(?:\/([^/]+))?/);return o?{slugPart:decodeURIComponent(o[1]),slugValue:Te(decodeURIComponent(o[1])),section:o[2]||"design"}:null}function qs(){return document.querySelector("[data-page-list]")?"design":document.querySelector("[data-collection-list]")?"content":document.querySelector("[data-media-grid]")?"media":document.querySelector("[data-deploy-form]")?"deploy":null}function ks(){if(!Ne){window.location.href="/admin/sites";return}Ne.classList.remove("hidden"),Ne.classList.add("flex")}function ts(){Ne&&(Ne.classList.add("hidden"),Ne.classList.remove("flex"))}fs.forEach(o=>{o.addEventListener("click",ks)}),gs.forEach(o=>{o.addEventListener("click",ts)}),Tt==null||Tt.addEventListener("click",()=>{window.location.href="/admin/sites"});let Xe=(V==null?void 0:V.section)||qs();Xe==="design"&&As(),Xe==="content"&&Is(),Xe==="media"&&Fs(),Xe==="deploy"&&Ts(),Xe==="settings"&&Bs(),V&&_.name&&es(_.name);function As(){let o=document.querySelectorAll("[data-page-list]");if(o.length===0)return;let d=document.querySelector("[data-active-page-title]"),h=document.querySelector("[data-active-page-slug]"),C=document.querySelector("[data-page-preview-tags]"),F=document.querySelector("[data-page-preview-frame]"),S=document.querySelector("[data-preview-open]"),z=document.querySelector("[data-preview-status]"),E=document.querySelector("[data-preview-highlight]"),f=document.querySelector("[data-seo-toggle]"),q=document.querySelector("[data-seo-panel]"),P=document.querySelector("[data-seo-close]"),L=document.querySelector("[data-seo-form]"),k=document.querySelector("[data-seo-title]"),g=document.querySelector("[data-seo-description]"),u=document.querySelector("[data-seo-feedback]"),x=document.querySelector("[data-seo-save]"),p=document.querySelector("[data-blocks-list]"),M=document.querySelector("[data-blocks-empty]"),ne=document.querySelector("[data-block-count]"),J=document.querySelector("[data-block-library-toggle]"),te=document.querySelector("[data-block-library]"),Y=document.querySelectorAll("[data-block-add]"),U=document.querySelector("[data-block-delete-modal]"),W=document.querySelector("[data-block-delete-confirm]"),O=document.querySelector("[data-block-delete-cancel]"),j=document.querySelector("[data-block-detail-empty]"),y=document.querySelector("[data-block-detail-status]"),w=document.querySelector("[data-block-editor]"),N=document.querySelector("[data-block-editor-block-name]"),l=document.querySelector("[data-block-editor-block-type]"),r=document.querySelector("[data-block-editor-unsupported]"),c=document.querySelector("[data-block-form]"),K=c?Array.from(c.querySelectorAll("[data-editor-section]")):[],D=c==null?void 0:c.querySelector('[name="collection-grid-collection"]'),Z=c==null?void 0:c.querySelector("[data-collection-selection-info]"),ue=document.querySelector("[data-block-form-cancel]"),se=c==null?void 0:c.querySelector("[data-group-preview-mobile]"),Q=c==null?void 0:c.querySelector("[data-group-preview-desktop]"),fe={hero:{section:"hero",labelField:"title",descriptionField:"subtitle",fields:{title:"hero-title",subtitle:"hero-subtitle",ctaLabel:"hero-cta-label",ctaUrl:"hero-cta-url",image:"hero-image",align:"hero-align"}},paragraphe:{section:"paragraph",labelField:"title",descriptionField:"content",fields:{title:"paragraph-title",content:"paragraph-content",align:"paragraph-align"}},image:{section:"image",labelField:"alt",fields:{src:"image-src",alt:"image-alt",showCaption:"image-caption-toggle",caption:"image-caption"}},groupe:{section:"group",fields:{layout:"group-layout",columnsMobile:"group-columns-mobile",columnsDesktop:"group-columns-desktop"}},collectiongrid:{section:"collection",fields:{collectionId:"collection-grid-collection",limit:"collection-grid-limit"}},form:{section:"form",labelField:"formTitle",fields:{formTitle:"form-title",actionUrl:"form-action-url",method:"form-method",serviceName:"form-service-name",submitLabel:"form-submit-label",successMessage:"form-success-message"}},newsletterembed:{section:"newsletter",labelField:"title",fields:{title:"newsletter-title",serviceName:"newsletter-service-name",embedCode:"newsletter-embed-code"}}},ye={texte:"paragraphe",paragraph:"paragraphe",paragraphs:"paragraphe",paragraphes:"paragraphe",text:"paragraphe",hero:"hero",image:"image",groupe:"groupe",group:"groupe",collection:"collectiongrid",collectiongrid:"collectiongrid","collection-grid":"collectiongrid",form:"form",formulaire:"form",contact:"form",newsletterembed:"newsletterembed",newsletter:"newsletterembed",embed:"newsletterembed"},ve=(e,t)=>{if(!se||!Q)return;let s=a=>Array.from({length:Number(a)||1}).map(()=>'<span class="block h-2 w-full rounded-full bg-slate-300"></span>').join("");se.innerHTML=s(e),Q.innerHTML=s(t)},ae=async()=>{if(!we)return[];let e=await fetch(we,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les pages.");let t=await e.json().catch(()=>[]);return Array.isArray(t)?t:[]},Be=async({title:e,slug:t})=>{if(!we)throw new Error("Site inconnu.");let s=await fetch(we,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,slug:t})});if(!s.ok){let a=await s.json().catch(()=>({}));throw new Error(a.message||"Impossible de cr\xE9er la page.")}return s.json().catch(()=>({}))},oe=async e=>{if(!(!we||!(e!=null&&e.id)))try{let t=await fetch(`${we}/${encodeURIComponent(e.id)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let a=await t.json().catch(()=>({}));throw new Error(a.message||"Impossible de sauvegarder la page.")}let s=await t.json().catch(()=>({}));if(s!=null&&s.id){let a=rt(s);return le=le.map(b=>b.id===a.id?a:b),(A==null?void 0:A.id)===a.id&&(A=a),a}return s}catch(t){console.error("[design] Save page failed",t),H(t.message||"Sauvegarde impossible.")}},ge=async()=>{if(!we){le=[],ke=null,A=null,Nt(le,ke),st(null),j==null||j.classList.remove("hidden"),w==null||w.classList.add("hidden");return}try{let e=await ae();if(le=(Array.isArray(e)?e:[]).map(t=>rt(t)),le.length===0){ke=null,A=null,Nt(le,ke),st(null),j==null||j.classList.remove("hidden"),w==null||w.classList.add("hidden"),F&&(F.srcdoc=$e());return}ke=Ns(le),Pe(ke)}catch(e){console.error("[design] Impossible de charger les pages",e),H("Impossible de charger les pages.")}},Fe=e=>(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),Oe=e=>{if(!e)return null;let t=Fe(e.type),s=ye[t]||t;return fe[s]||null},ze=e=>{var s,a,b;if(!c||!w)return;e&&!e.settings&&(e.settings={});let t=Oe(e);if(N&&(N.textContent=(e==null?void 0:e.label)||"Bloc"),l&&(l.textContent=(e==null?void 0:e.type)||"Bloc"),!t){c.classList.add("hidden"),r==null||r.classList.remove("hidden"),c.dataset.blockId="";return}if(r==null||r.classList.add("hidden"),c.classList.remove("hidden"),c.reset(),c.dataset.blockId=e.id,K.forEach(I=>{I.dataset.editorSection===t.section?I.classList.remove("hidden"):I.classList.add("hidden")}),t.section==="collection"){let I=e.collectionId||((s=e.settings)==null?void 0:s.collectionId)||"";St(I)}if(Object.entries(t.fields).forEach(([I,G])=>{var Re;let X=c.querySelector(`[name="${G}"]`);if(!X)return;let re=(Re=e.settings)==null?void 0:Re[I];X.type==="checkbox"?X.checked=!!re:X.type==="number"?X.value=re!=null?re:1:(X.tagName,X.value=re!=null?re:"")}),t.section==="group"){let I=((a=c.querySelector('[name="group-columns-mobile"]'))==null?void 0:a.value)||"1",G=((b=c.querySelector('[name="group-columns-desktop"]'))==null?void 0:b.value)||"3";ve(I,G)}},He=e=>{if(!c||!e)return{};let t={};return Object.entries(e.fields).forEach(([s,a])=>{let b=c.querySelector(`[name="${a}"]`);if(b)if(b.type==="checkbox")t[s]=b.checked;else if(b.type==="number"){let I=Number(b.value);t[s]=Number.isFinite(I)?I:0}else b.tagName==="TEXTAREA"?t[s]=b.value||"":b.type==="select-one"?t[s]=b.value:t[s]=b.value||""}),t},be=e=>{if(z){if(!e){z.classList.add("hidden");return}z.classList.remove("hidden"),z.textContent=e}},Ve=e=>e?{id:e.id,title:e.title,slug:e.slug,badges:[...e.badges||[]],blocks:(e.blocks||[]).map(t=>{var s;return{id:t.id,type:t.type,label:t.label,status:t.status,description:t.description,props:t.props||[],settings:t.settings||{},collectionId:t.collectionId||((s=t.settings)==null?void 0:s.collectionId)||""}})}:null,$e=()=>'<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#475569;background:#fff;">Pr\xE9paration de la pr\xE9visualisation\u2026</body></html>',i=e=>{if(!F||!e)return;let t=(V==null?void 0:V.slugValue)||_.slug||"",s={page:Ve(e),site:{title:_.name||"Site",slug:t}};Ot=!1,be("Actualisation\u2026"),F.srcdoc=$e(),at&&at.abort();let a=new AbortController;at=a,fetch("/api/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s),signal:a.signal}).then(b=>{if(!b.ok)throw new Error("Preview error");return b.json()}).then(b=>{a.signal.aborted||(Ut=b.html||"",F.setAttribute("title",`Pr\xE9visualisation de la page ${e.title||""}`.trim()),F.srcdoc=Ut||$e(),be("\xC0 jour"))}).catch(b=>{a.signal.aborted||(console.error("[preview] Impossible de rendre la page",b),be("Erreur preview"),F.srcdoc='<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#be123c;background:#fff;">Erreur lors du rendu de la pr\xE9visualisation.</body></html>')}).finally(()=>{at===a&&(at=null)})},v=e=>{if(e.preventDefault(),!A||!ce)return;let t=Pt(),s=Oe(t);if(!t||!s)return;let a=He(s);if(s.section==="collection"){if(!a.collectionId){H("S\xE9lectionnez une collection.");return}a.limit=Math.max(1,Number(a.limit)||1)}let b=(A.blocks||[]).map(I=>{if(I.id!==t.id)return I;let G={...I.settings||{},...a},X={...I,settings:G};return s.labelField&&a[s.labelField]&&(X.label=a[s.labelField]),s.descriptionField&&a[s.descriptionField]&&(X.description=a[s.descriptionField]),s.section==="collection"&&(X.collectionId=a.collectionId,X.settings.collectionId=a.collectionId,X.settings.limit=a.limit),X});nt(b),H("Bloc mis \xE0 jour"),Pe(A.id,{preserveBlock:!0})},R=document.querySelector("[data-page-drawer]"),T=document.querySelector("[data-page-drawer-backdrop]"),Me=document.querySelectorAll("[data-page-drawer-open]"),Je=document.querySelectorAll("[data-page-drawer-close]"),qe=document.querySelector("[data-add-page-toggle]"),me=document.querySelector("[data-add-page-form]"),n=document.querySelector("[data-add-page-title]"),m=document.querySelector("[data-add-page-slug]"),B=document.querySelector("[data-add-page-cancel]"),$=document.querySelector("[data-add-page-error]"),ee=me==null?void 0:me.querySelector('[type="submit"]'),Ze=Ee((V==null?void 0:V.slugValue)||_.slug||"default")||"default",De=(V==null?void 0:V.slugValue)||_.slug||"",xe=Ee(De)||"",we=xe?`/api/sites/${encodeURIComponent(xe)}/pages`:null,Qe=xe?`/api/sites/${encodeURIComponent(xe)}/collections`:null,et={active:`clower:activePage:${Ze}`},We=(e,t,s,a,b,I=[],G={})=>{let X={id:e,label:t,type:s,status:a,description:b,props:I,settings:{...G}};return X.settings.collectionId&&(X.collectionId=X.settings.collectionId),X},$s={hero:{type:"Hero",label:"Hero de page",description:"Section pleine largeur avec CTA principal.",status:"Brouillon",props:[{label:"CTA",value:"D\xE9couvrir"},{label:"Hauteur",value:"80vh"}],settings:{title:"Titre du hero",subtitle:"",ctaLabel:"D\xE9couvrir",ctaUrl:"#",image:"",align:"center"}},paragraph:{type:"Paragraphe",label:"Bloc \xE9ditorial",description:"Paragraphe libre pour raconter votre histoire.",status:"Brouillon",props:[{label:"Longueur",value:"150 mots"}],settings:{title:"Titre du paragraphe",content:"",align:"left"}},image:{type:"Image",label:"Bloc image",description:"Visuel seul avec l\xE9gende optionnelle.",status:"Brouillon",props:[{label:"Ratio",value:"16:9"},{label:"L\xE9gende",value:"Inactive"}],settings:{src:"",alt:"",showCaption:!1,caption:""}},group:{type:"Groupe",label:"Groupe de sections",description:"Conteneur pour imbriquer plusieurs sous-blocs.",status:"Brouillon",props:[{label:"Disposition",value:"Verticale"}],settings:{layout:"grid",columnsMobile:"1",columnsDesktop:"3"}},collectiongrid:{type:"CollectionGrid",label:"Grille de contenus",description:"Affiche automatiquement les items d\u2019une collection.",status:"Brouillon",settings:{collectionId:"",limit:6}},form:{type:"Form",label:"Formulaire de contact",description:"Formulaire avec envoi vers un service externe.",status:"Brouillon",settings:{formTitle:"Contactez-nous",actionUrl:"",method:"POST",serviceName:"",submitLabel:"Envoyer",successMessage:"Merci pour votre message !"}},newsletterembed:{type:"NewsletterEmbed",label:"Newsletter / Embed",description:"Int\xE9gration d'un formulaire newsletter externe (Brevo, Mailchimp\u2026).",status:"Brouillon",settings:{title:"Restez inform\xE9",serviceName:"",embedCode:""}}},js=e=>{try{window.localStorage.setItem(et.active,e)}catch{}},Ns=e=>{var t;try{let s=window.localStorage.getItem(et.active);if(s&&e.some(a=>a.id===s))return s}catch{}return((t=e[0])==null?void 0:t.id)||null},Ps=e=>!e||e<=0?"0 bloc":e===1?"1 bloc":`${e} blocs`,ss=e=>{if(!e||e==="/")return"/";let t=Ke(e.replace(/^\//,""));return t?`/${t}`:"/"},jt=(e="page",t="block")=>`${e}-${t}-${Date.now().toString(36)}-${Math.floor(Math.random()*1e3)}`,rn=(e,t)=>[We(jt(e,"intro"),"Introduction","Paragraphe","Brouillon",`Paragraphe introductif pour "${t}".`,[{label:"Longueur",value:"2 paragraphes"}],{title:`Introduction \xE0 ${t}`,content:"Ajoutez votre premier paragraphe de pr\xE9sentation.",align:"left"}),We(jt(e,"content"),"Zone de contenu","Groupe","Brouillon","Section principale \xE0 composer avec textes et visuels.",[{label:"Colonnes",value:"Auto"}],{layout:"grid",columnsMobile:"1",columnsDesktop:"2"})],Ms=e=>{d&&(d.textContent=(e==null?void 0:e.title)||"Page"),h&&(h.textContent=(e==null?void 0:e.slug)||"/")},Ds=e=>{if(!C)return;C.innerHTML="",(e&&e.badges&&e.badges.length>0?e.badges:["Structure en cours"]).forEach(s=>{let a=document.createElement("span");a.className="rounded-full bg-slate-100 px-3 py-1",a.textContent=s,C.appendChild(a)})},Rs=e=>{switch((e||"").toLowerCase()){case"en ligne":return"bg-emerald-50 text-emerald-700";case"brouillon":return"bg-amber-50 text-amber-700";default:return"bg-slate-100 text-slate-600"}},yt=e=>{if(!(!j||!w)){if(!e){j.classList.remove("hidden"),w.classList.add("hidden"),r==null||r.classList.add("hidden"),c==null||c.classList.add("hidden"),y==null||y.classList.add("hidden");return}j.classList.add("hidden"),w.classList.remove("hidden"),y&&(e.status?(y.textContent=e.status,y.className=`rounded-full px-3 py-1 text-xs font-semibold ${Rs(e.status)}`,y.classList.remove("hidden")):y.classList.add("hidden")),ze(e)}},tt=e=>{if(!F)return;let t=F.contentDocument;if(!t)return;t.querySelectorAll("[data-preview-block]").forEach(a=>{a.dataset.previewBlock===e?(a.classList.add("preview-block-active"),Ot&&e&&a.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})):a.classList.remove("preview-block-active")}),E&&(E.style.borderColor=e?"rgba(156, 107, 255, 0.5)":"transparent")},st=e=>{if(!p)return;p.innerHTML="";let t=(e==null?void 0:e.blocks)||[];if(ne&&(ne.textContent=Ps(t.length)),t.length===0){p.classList.add("hidden"),M==null||M.classList.remove("hidden");return}p.classList.remove("hidden"),M==null||M.classList.add("hidden"),t.forEach(s=>{var ds;let a=s.id===ce,b=document.createElement("div");b.dataset.blockItem="true",b.dataset.blockId=s.id,b.setAttribute("role","option"),b.setAttribute("aria-selected",a?"true":"false"),b.tabIndex=0,b.className=["relative flex items-center gap-3 rounded-2xl border px-3 py-2 text-left transition",a?"bg-slate-100 border-[#9C6BFF]/40 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let I=document.createElement("span");I.className=`absolute inset-y-2 left-0 w-1 rounded-full bg-[#9C6BFF] ${a?"":"hidden"}`,b.appendChild(I);let G=document.createElement("div");G.className="flex flex-1 items-center gap-3";let X=document.createElement("div");X.className="hidden lg:flex cursor-grab flex-shrink-0 items-center text-lg text-slate-400",X.innerHTML="&#8801;",G.appendChild(X);let re=document.createElement("div");re.className="flex-1";let Re=document.createElement("div");Re.className="flex items-center gap-2 text-[11px] uppercase tracking-wide text-slate-500";let Ht=document.createElement("span");Ht.className="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600",Ht.textContent=s.type;let Vt=document.createElement("span");Vt.className="text-slate-400",Vt.textContent=s.status,Re.appendChild(Ht),Re.appendChild(Vt);let Jt=document.createElement("p");Jt.className="mt-1 text-sm font-semibold text-slate-900";let sn=s.settings&&s.settings.title||s.label||"Bloc sans titre";if(Jt.textContent=sn,re.appendChild(Re),re.appendChild(Jt),(s.type||"").toLowerCase()==="collectiongrid"&&s.collectionId){let Se=((ds=Ae.find(nn=>nn.id===s.collectionId))==null?void 0:ds.name)||s.collectionId,Wt=document.createElement("p");Wt.className="text-xs text-slate-400",Wt.textContent=`Collection : ${Se}`,re.appendChild(Wt)}G.appendChild(re),b.appendChild(G);let Ct=document.createElement("div");Ct.className="flex flex-col gap-1 text-xs text-slate-400";let Et=document.createElement("div");Et.className="flex items-center gap-1 lg:hidden";let it=document.createElement("button");it.type="button",it.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",it.textContent="\u2191",it.addEventListener("click",Se=>{Se.stopPropagation(),ns(s.id,-1)});let lt=document.createElement("button");lt.type="button",lt.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",lt.textContent="\u2193",lt.addEventListener("click",Se=>{Se.stopPropagation(),ns(s.id,1)}),Et.appendChild(it),Et.appendChild(lt),Ct.appendChild(Et);let ct=document.createElement("button");ct.type="button",ct.className="inline-flex items-center justify-center rounded-lg border border-transparent px-2 py-1 text-[12px] text-rose-500 hover:text-rose-700",ct.innerHTML="\u{1F5D1}\uFE0F",ct.addEventListener("click",Se=>{Se.stopPropagation(),Vs(s.id)}),Ct.appendChild(ct),b.appendChild(Ct),b.addEventListener("click",()=>{Ge(s.id)}),b.addEventListener("keydown",Se=>{(Se.key==="Enter"||Se.key===" ")&&(Se.preventDefault(),Ge(s.id))}),p.appendChild(b)})},Nt=(e,t)=>{o.forEach(s=>{s.innerHTML="",e.forEach(a=>{let b=document.createElement("li"),I=document.createElement("button");I.type="button",I.dataset.pageId=a.id,I.className=["w-full flex items-center justify-between gap-3 px-3 py-2 text-left transition",t===a.id?"bg-[#9C6BFF]/10 text-slate-900 border border-[#9C6BFF]/40 rounded-xl shadow-sm":"text-slate-700 hover:bg-slate-50 rounded-xl"].join(" "),t===a.id?I.setAttribute("aria-current","page"):I.removeAttribute("aria-current"),I.innerHTML=`
            <div class="flex items-center gap-3">
              <span class="flex h-9 w-9 items-center justify-center rounded-xl border border-slate-200 bg-white text-slate-500">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6.5 4.5h7l4 4v11a1 1 0 0 1-1 1h-10a1 1 0 0 1-1-1v-14a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
                  <path d="M13.5 4.5v4a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.4"/>
                </svg>
              </span>
              <div class="flex flex-col">
                <span class="text-sm font-semibold">${a.title}</span>
                <span class="text-xs text-slate-500">${a.slug}</span>
              </div>
            </div>
          `,I.addEventListener("click",()=>{Pe(a.id),Dt()||Rt()}),b.appendChild(I),s.appendChild(b)})})},Pt=()=>!A||!Array.isArray(A.blocks)?null:A.blocks.find(e=>e.id===ce)||null,Ge=e=>{if(!A)return;if(!e){ce=null,st(A),yt(null),tt(null);return}let t=A.blocks.find(s=>s.id===e)||A.blocks[0]||null;ce=(t==null?void 0:t.id)||null,st(A),yt(t),tt(ce)},nt=e=>{if(!A)return;let t={...A,blocks:e};Js(t)},vt=()=>window.matchMedia("(min-width: 1024px)").matches;function ns(e,t){if(!A||!e||!t)return;let s=[...A.blocks||[]],a=s.findIndex(G=>G.id===e);if(a<0)return;let b=a+t;if(b<0||b>=s.length)return;let[I]=s.splice(a,1);s.splice(b,0,I),nt(s),Pe(A.id,{preserveBlock:!0}),Ge(I.id)}function Us(e,t){if(!A||!e||!t||e===t)return;let s=[...A.blocks||[]],a=s.findIndex(G=>G.id===e),b=s.findIndex(G=>G.id===t);if(a<0||b<0)return;let[I]=s.splice(a,1);s.splice(b,0,I),nt(s),Pe(A.id,{preserveBlock:!0}),Ge(I.id)}function os(){if(!p)return;let e=vt();p.querySelectorAll("[data-block-item]").forEach(t=>{t.setAttribute("draggable",e?"true":"false")})}function bt(){te&&(te.classList.add("hidden"),ot=!1)}function Os(){te&&(te.classList.remove("hidden"),ot=!0)}function zs(){ot?bt():Os()}function Hs(e){var I;if(!A||!e)return;let t=$s[e];if(!t)return;let s=(A.blocks||[]).filter(G=>G.type===t.type).length+1,a=We(jt(A.id,e),`${t.label} ${s}`,t.type,t.status,t.description,t.props,t.settings||{});if((t.type||"").toLowerCase()==="collectiongrid"){let G=((I=Ae[0])==null?void 0:I.id)||"";a.collectionId=G,a.settings.collectionId=G,a.settings.limit=a.settings.limit||6}let b=[...A.blocks||[],a];nt(b),Pe(A.id,{preserveBlock:!0}),Ge(a.id),bt(),H("Bloc ajout\xE9")}function as(e){var a,b;if(!A)return;let t=(A.blocks||[]).filter(I=>I.id!==e),s=e===ce?((a=t[0])==null?void 0:a.id)||null:ce||((b=t[0])==null?void 0:b.id)||null;nt(t),ce=s,Pe(A.id,{preserveBlock:!0}),ce?Ge(ce):(yt(null),tt(null)),H("Bloc supprim\xE9")}function Mt(){U&&(U.classList.add("hidden"),U.classList.remove("flex"),wt=null)}function Vs(e){if(!U){as(e);return}wt=e,U.classList.remove("hidden"),U.classList.add("flex")}let Js=e=>{if(!e)return;let t=rt(e);le=le.map(s=>s.id===t.id?t:s),A=t,oe(t)},Pe=(e,t={})=>{var b,I;let s=le.find(G=>G.id===e)||le[0]||null;A=s?rt(s):null,ke=(s==null?void 0:s.id)||null,(!t.preserveBlock||!A||!A.blocks.some(G=>G.id===ce))&&(ce=((I=(b=A==null?void 0:A.blocks)==null?void 0:b[0])==null?void 0:I.id)||null),ke&&js(ke),Nt(le,ke),Ms(A),Ds(A),i(A),st(A),yt(Pt()),tt(ce),os(),ot&&bt()},Dt=()=>window.matchMedia("(min-width: 1024px)").matches,rs=()=>{R&&(Dt()?(R.classList.add("is-open"),T==null||T.classList.add("hidden"),document.body.classList.remove("overflow-hidden")):R.classList.remove("is-open"))},Ws=()=>{!R||Dt()||(R.classList.add("is-open"),T==null||T.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},Rt=()=>{R&&(R.classList.remove("is-open"),T==null||T.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))},Gs=()=>{!me||!qe||(me.classList.remove("hidden"),qe.classList.add("hidden"),$&&($.textContent=""),xt=!1,n&&(n.value="",n.focus()),m&&(m.value=""))},is=()=>{!me||!qe||(me.classList.add("hidden"),qe.classList.remove("hidden"),$&&($.textContent=""),xt=!1,me.reset())},_s=()=>{!n||!m||xt&&m.value.trim().length>0||(m.value=ss(n.value))},le=[],ke=null,xt=!1,A=null,ce=null,ot=!1,wt=null,Ut="",Ot=!1,at=null,Ae=[],Ys=e=>{let t={...e,props:Array.isArray(e.props)?e.props:[],settings:{...e.settings||{}}};return(t.type||"").toLowerCase()==="collectiongrid"&&(t.collectionId=t.collectionId||t.settings.collectionId||"",t.settings.collectionId=t.collectionId,t.settings.limit=t.settings.limit||6),t},rt=e=>{var t,s;return{...e,blocks:(e.blocks||[]).map(a=>Ys(a)),seo:{title:(((t=e.seo)==null?void 0:t.title)||"").trim(),description:(((s=e.seo)==null?void 0:s.description)||"").trim()}}},Ks=async()=>{if(!Qe){Ae=[],St();return}try{let e=await fetch(Qe,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les collections.");let t=await e.json().catch(()=>[]);Ae=Array.isArray(t)?t:[];let s=(D==null?void 0:D.value)||"";St(s)}catch(e){console.error("[design] collections load",e),H("Collections indisponibles."),Ae=[],St()}},zt=e=>{if(!Z)return;if(!e){Z.textContent=Ae.length?"S\xE9lectionnez une collection pour afficher ses informations.":"Aucune collection disponible. Ajoutez-en depuis l\u2019onglet Contenus.";return}let t=Ae.find(a=>a.id===e);if(!t){Z.textContent=`Collection ${e}`;return}let s=[];t.description&&s.push(t.description),t.type&&s.push(`Type\xA0: ${t.type}`),Z.textContent=s.join(" \xB7 ")||`Collection ${t.name||t.id}`},St=(e="")=>{if(D){if(D.innerHTML="",!Ae.length){D.disabled=!0;let t=document.createElement("option");t.value="",t.textContent="Aucune collection disponible",D.appendChild(t),zt("");return}if(D.disabled=!1,e&&!Ae.some(t=>t.id===e)){let t=document.createElement("option");t.value=e,t.textContent=e,D.appendChild(t)}Ae.forEach(t=>{let s=document.createElement("option");s.value=t.id;let a=t.name||t.id;s.textContent=t.type?`${a} \xB7 ${t.type}`:a,s.dataset.description=t.description||"",D.appendChild(s)}),e&&(D.value=e),zt(D.value||"")}};Ks(),rs(),Me.forEach(e=>{e.addEventListener("click",Ws)}),Je.forEach(e=>{e.addEventListener("click",Rt)}),T==null||T.addEventListener("click",Rt),window.addEventListener("resize",()=>{rs(),os()}),qe==null||qe.addEventListener("click",Gs),B==null||B.addEventListener("click",is),n==null||n.addEventListener("input",_s),m==null||m.addEventListener("input",()=>{$&&($.textContent=""),xt=!0}),me==null||me.addEventListener("submit",async e=>{if(e.preventDefault(),!we){$&&($.textContent="Aucun site s\xE9lectionn\xE9.");return}if(!n||!m)return;let t=n.value.trim(),s=ss(m.value.trim()||t);if(!t||!s){$&&($.textContent="Titre et slug sont requis.");return}$&&($.textContent=""),ee&&(ee.disabled=!0,ee.textContent="Cr\xE9ation...");try{let a=await Be({title:t,slug:s});if(!a||!a.id)throw new Error("R\xE9ponse invalide.");le=[...le,rt(a)],is(),H("Page cr\xE9\xE9e"),Pe(a.id)}catch(a){console.error("[design] create page failed",a),$&&($.textContent=a.message||"Impossible de cr\xE9er la page.")}finally{ee&&(ee.disabled=!1,ee.textContent="Cr\xE9er")}}),J==null||J.addEventListener("click",e=>{e.stopPropagation(),zs()}),document.addEventListener("click",e=>{ot&&(te!=null&&te.contains(e.target)||J!=null&&J.contains(e.target)||bt())}),Y.forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();let s=e.dataset.blockAdd;Hs(s)})}),O==null||O.addEventListener("click",()=>{Mt()}),W==null||W.addEventListener("click",()=>{wt&&as(wt),Mt()}),U==null||U.addEventListener("click",e=>{e.target===U&&Mt()}),c==null||c.addEventListener("input",e=>{var s,a;let t=e.target;if(!(!t||!t.name)&&(t.name==="group-columns-mobile"||t.name==="group-columns-desktop")){let b=((s=c.querySelector('[name="group-columns-mobile"]'))==null?void 0:s.value)||"1",I=((a=c.querySelector('[name="group-columns-desktop"]'))==null?void 0:a.value)||"3";ve(b,I)}}),D==null||D.addEventListener("change",e=>{let t=e.target;zt((t==null?void 0:t.value)||"")}),c==null||c.addEventListener("submit",v),ue==null||ue.addEventListener("click",e=>{e.preventDefault();let t=Pt();t&&ze(t)}),F==null||F.addEventListener("load",()=>{Ot=!0,be("\xC0 jour"),tt(ce)}),S==null||S.addEventListener("click",()=>{let e=window.open("","_blank");if(!e)return;e.opener=null;let t=e.document;t.open(),t.write(Ut||$e()),t.close()});let ls=e=>{var t,s;q&&(e?(q.classList.remove("hidden"),A&&(k&&(k.value=((t=A.seo)==null?void 0:t.title)||""),g&&(g.value=((s=A.seo)==null?void 0:s.description)||""))):q.classList.add("hidden"))},Lt=(e,t="muted")=>{if(!u)return;let s=t==="success"?"text-emerald-600":t==="error"?"text-rose-600":"text-slate-500";u.textContent=e||"",u.className=`text-sm ${s}`};f==null||f.addEventListener("click",()=>{let e=q&&!q.classList.contains("hidden");ls(!e)}),P==null||P.addEventListener("click",()=>ls(!1)),L==null||L.addEventListener("submit",async e=>{if(e.preventDefault(),!A){Lt("Aucune page active.","error");return}x&&(x.disabled=!0),Lt("");try{let t={title:((k==null?void 0:k.value)||"").trim(),description:((g==null?void 0:g.value)||"").trim()},s={...A,seo:t},a=await oe(s);a&&(A=a,Lt("SEO enregistr\xE9.","success"),H("SEO mis \xE0 jour"),i(A))}catch(t){console.error("[seo] save failed",t),Lt(t.message||"Erreur lors de la sauvegarde.","error")}finally{x&&(x.disabled=!1)}});let Xs=e=>{let t=e.target.closest("[data-block-item]");!t||!vt()||(je=t.dataset.blockId||null,je&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",je),t.classList.add("opacity-50")))},cs=()=>{p==null||p.querySelectorAll("[data-block-item]").forEach(e=>e.classList.remove("opacity-50","ring-2","ring-[#9C6BFF]/50"))},Zs=()=>{je=null,cs()},Qs=e=>{if(!je||!vt())return;let t=e.target.closest("[data-block-item]");!t||t.dataset.blockId===je||(e.preventDefault(),t.classList.add("ring-2","ring-[#9C6BFF]/50"))},en=e=>{let t=e.target.closest("[data-block-item]");t&&t.classList.remove("ring-2","ring-[#9C6BFF]/50")},tn=e=>{if(!je||!vt())return;e.preventDefault();let t=e.target.closest("[data-block-item]"),s=je;je=null,cs();let a=(t==null?void 0:t.dataset.blockId)||null;a&&Us(s,a)},je=null;p==null||p.addEventListener("dragstart",Xs),p==null||p.addEventListener("dragend",Zs),p==null||p.addEventListener("dragover",Qs),p==null||p.addEventListener("dragleave",en),p==null||p.addEventListener("drop",tn),ge()}function Is(){var Je,qe,me;let o=document.querySelector("[data-collection-list]");if(!o)return;let d=document.querySelector("[data-collection-empty]"),h=document.querySelector("[data-collection-items-empty]"),C=document.querySelector("[data-item-table-wrapper]"),F=document.querySelector("[data-item-table-body]"),S=document.querySelector("[data-collection-title]"),z=document.querySelector("[data-collection-description]"),E=document.querySelector("[data-collection-drawer]"),f=document.querySelector("[data-collection-drawer-backdrop]"),q=document.querySelectorAll("[data-collection-drawer-open]"),P=document.querySelectorAll("[data-collection-drawer-close]"),L=document.querySelector("[data-item-add]"),k=document.querySelector("[data-item-detail-empty]"),g=document.querySelector("[data-item-form]"),u=g?{title:g.querySelector('[name="item-title"]'),slug:g.querySelector('[name="item-slug"]'),excerpt:g.querySelector('[name="item-excerpt"]'),content:g.querySelector('[name="item-content"]'),image:g.querySelector('[name="item-image"]'),status:g.querySelector('[name="item-status"]')}:{},x=document.querySelector("[data-item-status-badge]"),p=document.querySelector("[data-item-delete]"),M=document.querySelector("[data-item-delete-modal]"),ne=document.querySelector("[data-item-delete-cancel]"),J=document.querySelector("[data-item-delete-confirm]"),te=document.querySelector("[data-item-cancel]"),Y=document.querySelector("[data-item-save]"),U="rounded-full px-3 py-1 text-xs font-semibold",W=Ee((V==null?void 0:V.slugValue)||_.slug||""),O=W?`/api/sites/${encodeURIComponent(W)}/collections`:null,j=[],y=[],w=null,N=null,l=!1,r=!1,c=null,K=()=>{E&&(E.classList.add("is-open"),E.style.transform="translateX(0)",f==null||f.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},D=()=>{E&&(E.classList.remove("is-open"),E.style.transform="",f==null||f.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))};q.forEach(n=>{n.addEventListener("click",K)}),P.forEach(n=>{n.addEventListener("click",D)}),f==null||f.addEventListener("click",D);let Z=n=>{let m=(n||"").trim();if(!m)return"";if(m==="/")return"/";let $=m.replace(/^\//,"").split("/").map(ee=>Ke(ee||"")).filter(ee=>ee.length>0);return $.length?`/${$.join("/")}`:""},ue=n=>{if(!n)return"\u2014";let m=new Date(n);return Number.isNaN(m.getTime())?"\u2014":m.toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"})},se=()=>{let n=j.find(m=>m.id===w);S&&(S.textContent=(n==null?void 0:n.name)||"S\xE9lectionnez une collection"),z&&(z.textContent=(n==null?void 0:n.description)||"")},Q=n=>{h&&(h.textContent=n||(w?"Aucun item dans cette collection pour le moment.":"Choisissez une collection dans le panneau de gauche."))},fe=()=>{g&&(g.classList.add("hidden"),g.dataset.itemId=""),k==null||k.classList.remove("hidden"),x&&(x.className=`hidden ${U}`,x.textContent=""),p&&(p.disabled=!0)},ye=()=>{g&&(g.classList.remove("hidden"),k==null||k.classList.add("hidden"))},ve=()=>{L&&(L.disabled=!w,L.disabled?L.classList.add("opacity-60","pointer-events-none"):L.classList.remove("opacity-60","pointer-events-none"))},ae=n=>{if(!x)return;if(!n){x.className=`hidden ${U}`,x.textContent="";return}let m=n.toLowerCase(),B="bg-slate-100 text-slate-600 border border-slate-200";m==="publi\xE9"||m==="publie"?B="bg-emerald-50 text-emerald-700 border border-emerald-100":m==="brouillon"&&(B="bg-amber-50 text-amber-700 border border-amber-100"),x.className=`${U} ${B}`,x.textContent=n},Be=()=>{if(o.innerHTML="",!j.length){d==null||d.classList.remove("hidden");return}d==null||d.classList.add("hidden"),j.forEach(n=>{let m=n.id===w,B=document.createElement("button");B.type="button",B.dataset.collectionId=n.id,B.className=["w-full rounded-xl border px-3 py-2 text-left transition focus:outline-none focus:ring-2 focus:ring-[#9C6BFF]/40",m?"bg-[#F7F0FF] border-[#9C6BFF]/40 text-slate-900":"border-slate-200 text-slate-700 hover:border-[#9C6BFF]/40"].join(" "),B.setAttribute("role","option"),m?B.setAttribute("aria-current","true"):B.removeAttribute("aria-current"),B.innerHTML=`
          <div class="flex items-center justify-between gap-2">
            <div>
              <p class="text-sm font-semibold">${n.name||n.id}</p>
              <p class="text-xs text-slate-500">${n.description||""}</p>
            </div>
            <span class="text-[11px] uppercase tracking-wide text-slate-400">${n.type||""}</span>
          </div>
        `,B.addEventListener("click",()=>{Ve(n.id),window.matchMedia("(min-width: 1024px)").matches||D()}),o.appendChild(B)})},oe=()=>{if(F){if(F.innerHTML="",!y.length||!w){h==null||h.classList.remove("hidden"),Q(),C==null||C.classList.add("hidden");return}h==null||h.classList.add("hidden"),C==null||C.classList.remove("hidden"),y.forEach(n=>{let m=document.createElement("tr");m.dataset.itemId=n.id;let B=n.id===N&&!l;m.className=["cursor-pointer transition focus-within:bg-[#F7F0FF]/70 focus:outline-none",B?"bg-[#F7F0FF]/70":"hover:bg-slate-50"].join(" "),m.tabIndex=0,m.setAttribute("role","button"),B?m.setAttribute("aria-current","true"):m.removeAttribute("aria-current");let $=n.status||"Brouillon",ee=$.toLowerCase(),Ze=ee==="publi\xE9"||ee==="publie"?"bg-emerald-50 text-emerald-700 border border-emerald-100":"bg-amber-50 text-amber-700 border border-amber-100";m.innerHTML=`
          <td class="px-4 py-3 align-top">
            <div class="flex flex-col">
              <span class="text-sm font-semibold text-slate-900">${n.title||"Sans titre"}</span>
              <span class="text-xs text-slate-500">${n.summary||n.excerpt||""}</span>
            </div>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-600">${n.slug||""}</td>
          <td class="px-4 py-3 align-top">
            <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${Ze}">
              ${$}
            </span>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-500">${ue(n.updatedAt||n.createdAt)}</td>
        `;let De=()=>{ge(n.id)};m.addEventListener("click",De),m.addEventListener("keydown",xe=>{(xe.key==="Enter"||xe.key===" ")&&(xe.preventDefault(),De())}),F.appendChild(m)})}},ge=n=>{let m=y.find(B=>B.id===n);m&&(N=m.id,l=!1,r=!0,Fe(m),oe())},Fe=n=>{if(!g||!n){fe();return}ye(),g.dataset.itemId=n.id,u.title&&(u.title.value=n.title||""),u.slug&&(u.slug.value=n.slug||""),u.excerpt&&(u.excerpt.value=n.summary||n.excerpt||""),u.content&&(u.content.value=n.content||""),u.image&&(u.image.value=n.image||""),u.status&&(u.status.value=n.status||"Brouillon"),ae(n.status||"Brouillon"),p&&(p.disabled=!1)},Oe=()=>{var n;g&&(l=!0,N=null,r=!1,g.dataset.itemId="",g.reset(),u.status&&(u.status.value="Brouillon"),u.slug&&(u.slug.value=""),ae("Brouillon"),ye(),p&&(p.disabled=!0),(n=u.title)==null||n.focus())},ze=()=>{var De,xe,we,Qe,et,We;let n=(((De=u.title)==null?void 0:De.value)||"").trim(),m=(((xe=u.slug)==null?void 0:xe.value)||"").trim(),B=(((we=u.excerpt)==null?void 0:we.value)||"").trim(),$=(((Qe=u.content)==null?void 0:Qe.value)||"").trim(),ee=(((et=u.image)==null?void 0:et.value)||"").trim(),Ze=((We=u.status)==null?void 0:We.value)||"Brouillon";return{title:n,slug:Z(m||n),summary:B,excerpt:B,content:$,image:ee,status:Ze}},He=n=>{Y&&(Y.disabled=n,Y.textContent=n?"Enregistrement\u2026":"Enregistrer"),p&&!l&&N&&(p.disabled=n)},be=async n=>{if(!O)return[];let m=await fetch(`${O}/${encodeURIComponent(n)}/items`,{headers:{Accept:"application/json"}});if(!m.ok){let $=await m.json().catch(()=>({}));throw new Error($.message||"Impossible de charger les items.")}let B=await m.json().catch(()=>({}));return Array.isArray(B.items)?B.items:[]},Ve=async n=>{if(n&&(w=n,N=null,l=!1,r=!1,se(),ve(),Be(),fe(),y=[],oe(),Q("Chargement des items\u2026"),h==null||h.classList.remove("hidden"),C==null||C.classList.add("hidden"),!!O))try{y=await be(n),oe(),y.length||Q()}catch(m){console.error("[content] items failed",m),H(m.message||"Impossible de charger les items."),y=[],oe()}},$e=async(n,m)=>{if(!O)throw new Error("Site inconnu.");let B=await fetch(`${O}/${encodeURIComponent(n)}/items`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)});if(!B.ok){let $=await B.json().catch(()=>({}));throw new Error($.message||"Impossible de cr\xE9er cet item.")}return B.json()},i=async(n,m,B)=>{if(!O)throw new Error("Site inconnu.");let $=await fetch(`${O}/${encodeURIComponent(n)}/items/${encodeURIComponent(m)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(B)});if(!$.ok){let ee=await $.json().catch(()=>({}));throw new Error(ee.message||"Impossible de sauvegarder cet item.")}return $.json()},v=async(n,m)=>{if(!O)throw new Error("Site inconnu.");let B=await fetch(`${O}/${encodeURIComponent(n)}/items/${encodeURIComponent(m)}`,{method:"DELETE"});if(!B.ok){let $=await B.json().catch(()=>({}));throw new Error($.message||"Impossible de supprimer cet item.")}},R=async()=>{var n;if(!O){d==null||d.classList.remove("hidden"),w=null,y=[],oe(),se(),ve();return}try{let m=await fetch(O,{headers:{Accept:"application/json"}});if(!m.ok)throw new Error("Impossible de charger les collections.");let B=await m.json().catch(()=>[]);if(j=Array.isArray(B)?B:[],Be(),j.length>0){let $=((n=j.find(ee=>ee.id===w))==null?void 0:n.id)||j[0].id;Ve($)}else w=null,y=[],se(),ve(),oe()}catch(m){console.error("[content] load collections",m),H(m.message||"Impossible de charger les collections.")}};L==null||L.addEventListener("click",()=>{if(!w){H("S\xE9lectionnez d\u2019abord une collection.");return}Oe(),oe()}),te==null||te.addEventListener("click",n=>{if(n.preventDefault(),l){l=!1,N=null,fe(),oe();return}if(N){let m=y.find(B=>B.id===N);Fe(m)}else fe()}),(Je=u.status)==null||Je.addEventListener("change",()=>{ae(u.status.value)}),(qe=u.title)==null||qe.addEventListener("input",()=>{!l||!u.slug||r||(u.slug.value=Z(u.title.value))}),(me=u.slug)==null||me.addEventListener("input",()=>{l&&(r=!0)}),g==null||g.addEventListener("submit",async n=>{var B;if(n.preventDefault(),!w){H("S\xE9lectionnez une collection.");return}let m=ze();if(!m.title){H("Le titre est requis."),(B=u.title)==null||B.focus();return}He(!0);try{let $;l||!N?($=await $e(w,m),y=[...y,$],H("Item cr\xE9\xE9")):($=await i(w,N,m),y=y.map(ee=>ee.id===$.id?$:ee),H("Item mis \xE0 jour")),l=!1,N=$.id,Fe($),oe()}catch($){console.error("[content] save item failed",$),H($.message||"Impossible de sauvegarder cet item.")}finally{He(!1)}});let T=()=>{M&&(M.classList.add("hidden"),M.classList.remove("flex"),c=null)},Me=()=>{!M||!N||(c=N,M.classList.remove("hidden"),M.classList.add("flex"))};p==null||p.addEventListener("click",n=>{n.preventDefault(),N&&Me()}),ne==null||ne.addEventListener("click",()=>{T()}),M==null||M.addEventListener("click",n=>{n.target===M&&T()}),J==null||J.addEventListener("click",async()=>{if(!c||!w){T();return}J.disabled=!0,J.textContent="Suppression\u2026";try{await v(w,c),y=y.filter(n=>n.id!==c),N===c&&(N=null,fe()),H("Item supprim\xE9"),oe()}catch(n){console.error("[content] delete item failed",n),H(n.message||"Impossible de supprimer cet item.")}finally{J.disabled=!1,J.textContent="Supprimer",T()}}),se(),ve(),R()}function Ts(){let o=document.querySelector("[data-deploy-form]");if(!o)return;let d=document.querySelector("[data-deploy-protocol]"),h=document.querySelector("[data-deploy-host]"),C=document.querySelector("[data-deploy-port]"),F=document.querySelector("[data-deploy-user]"),S=document.querySelector("[data-deploy-password]"),z=document.querySelector("[data-deploy-show-password]"),E=document.querySelector("[data-deploy-remote-path]"),f=document.querySelector("[data-deploy-feedback]"),q=document.querySelector("[data-deploy-save]"),P=document.querySelector("[data-deploy-test]"),L=document.querySelector("[data-deploy-trigger]"),k=document.querySelector("[data-deploy-history]"),g=document.querySelector("[data-deploy-log]"),u=Ee((V==null?void 0:V.slugValue)||_.slug||""),x=u?`/api/sites/${encodeURIComponent(u)}/deploy-config`:null,p=u?`/api/sites/${encodeURIComponent(u)}/deploy`:null,M=u?`/api/sites/${encodeURIComponent(u)}/deploy-log`:null,ne=!1,J=null,te=l=>{let r=(l||"").trim();return r?r.startsWith("/")?r:`/${r}`:"/www"},Y=(l,r="muted")=>{if(!f)return;let c="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold",K=r==="success"?"bg-emerald-50 text-emerald-700 border border-emerald-100":r==="error"?"bg-rose-50 text-rose-700 border border-rose-100":"bg-slate-50 text-slate-600 border border-slate-100";if(!l){f.textContent="",f.className="text-sm text-slate-500";return}let D=r==="success"?"\u2705":r==="error"?"\u274C":"\u2139\uFE0F";f.innerHTML=`<span class="${c} ${K}">${D}<span>${l}</span></span>`,f.className="text-sm"},U=(l=null)=>{J=l;let r=!!l,c='<svg class="h-4 w-4 animate-spin text-white" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>';q&&(q.disabled=r,q.innerHTML=l==="save"?`<span class="inline-flex items-center gap-2">${c}<span>Enregistrement\u2026</span></span>`:"Enregistrer"),P&&(P.disabled=r,P.innerHTML=l==="test"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-slate-200 border-t-slate-600"></span><span>Test en cours\u2026</span></span>':"Tester la connexion"),L&&(L.disabled=r&&l!==null,L.innerHTML=l==="deploy"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-white/60 border-t-white"></span><span>D\xE9ploiement\u2026</span></span>':"D\xE9ployer maintenant")},W=l=>{d&&(d.value=l.protocol||"sftp"),h&&(h.value=l.host||""),C&&(C.value=l.port||""),F&&(F.value=l.user||""),E&&(E.value=l.remotePath||"/www"),ne=!!l.hasPassword,S&&(S.value="",S.placeholder=ne?"Non affich\xE9":"Mot de passe")},O=(l=[])=>{if(k){if(k.innerHTML="",!l.length){let r=document.createElement("li");r.className="text-slate-500",r.textContent="Aucun d\xE9ploiement pour le moment.",k.appendChild(r);return}l.forEach(r=>{let c=document.createElement("li");c.className="flex items-center justify-between gap-2 rounded-xl border border-slate-200 px-3 py-2";let K=r.status==="success"?'<span class="rounded-full bg-emerald-50 px-2 py-0.5 text-[11px] font-semibold text-emerald-700">Succ\xE8s</span>':'<span class="rounded-full bg-rose-50 px-2 py-0.5 text-[11px] font-semibold text-rose-700">\xC9chec</span>',D=r.finishedAt||r.startedAt||"",Z=r.durationMs&&Number(r.durationMs)>=0?`${Math.round(Number(r.durationMs)/1e3)}s`:"";c.innerHTML=`
          <div class="space-y-1">
            <div class="flex items-center gap-2">${K}<span class="text-xs text-slate-500">${D}</span></div>
            <p class="text-sm text-slate-800">${r.message||""}</p>
          </div>
          <div class="text-xs text-slate-500">${Z}</div>
        `,c.dataset.deployId=r.id||"",c.addEventListener("click",()=>{r.logs&&g&&(g.textContent=r.logs.join(`
`))}),k.appendChild(c)})}},j=(l=[])=>{g&&(g.textContent=l.length?l.join(`
`):"Aucun log pour le moment.")},y=async()=>{var l;if(M)try{let r=await fetch(M,{headers:{Accept:"application/json"}});if(!r.ok){if(r.status===404){O([]),j(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw new Error("Impossible de charger l\u2019historique.")}let c=await r.json().catch(()=>({})),K=Array.isArray(c.entries)?c.entries:[];O(K),(l=K[0])!=null&&l.logs&&j(K[0].logs)}catch(r){console.error("[deploy] history failed",r)}},w=async()=>{if(!x){Y("Aucun site actif s\xE9lectionn\xE9.","error");return}U("load");try{let l=await fetch(x,{headers:{Accept:"application/json"}}),r=await l.json().catch(()=>({}));l.ok?(W(r||{}),Y("Configuration charg\xE9e.","muted")):(W(r||{}),Y(r.message||"Configuration par d\xE9faut charg\xE9e.","muted"))}catch(l){console.error("[deploy] load failed",l),Y(l.message||"Erreur lors du chargement.","error")}finally{U(null)}},N=()=>{let l={protocol:(d==null?void 0:d.value)||"sftp",host:(h==null?void 0:h.value.trim())||"",port:Number(C==null?void 0:C.value)||void 0,user:(F==null?void 0:F.value.trim())||"",remotePath:te((E==null?void 0:E.value)||"/www")},r=(S==null?void 0:S.value)||"";return r.trim().length>0&&(l.password=r),l};o.addEventListener("submit",async l=>{if(l.preventDefault(),!x){Y("Aucun site actif s\xE9lectionn\xE9.","error");return}let r=N();U("save");try{let c=await fetch(x,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!c.ok){let D=await c.json().catch(()=>({}));throw new Error(D.message||"Sauvegarde impossible.")}let K=await c.json();W(K||{}),Y("Configuration enregistr\xE9e.","success"),H("Configuration d\xE9ploiement sauvegard\xE9e")}catch(c){console.error("[deploy] save failed",c),Y(c.message||"Erreur lors de la sauvegarde.","error")}finally{U(null)}}),P==null||P.addEventListener("click",async()=>{if(!x){Y("Aucun site actif s\xE9lectionn\xE9.","error");return}let l=N();if(!l.host||!l.user||!l.remotePath){Y("Remplissez les champs requis avant de tester.","error");return}U("test");try{let r=await fetch(`${x}/test`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}),c=await r.json().catch(()=>({}));if(!r.ok||c.success===!1){Y(c.message||"Test de connexion \xE9chou\xE9.","error");return}Y(c.message||"Connexion OK.","success"),H("Test de connexion r\xE9ussi")}catch(r){console.error("[deploy] test failed",r),Y(r.message||"Test de connexion \xE9chou\xE9.","error")}finally{U(null)}}),L==null||L.addEventListener("click",async()=>{if(!p){Y("Aucun site actif s\xE9lectionn\xE9.","error");return}U("deploy"),j(["D\xE9ploiement en cours\u2026"]);try{let l=await fetch(p,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(N())}),r=await l.json().catch(()=>({}));if(!l.ok){if(l.status===404){Y("API d\xE9ploiement indisponible (red\xE9marre le serveur).","error"),j(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw j(r.logs||[]),new Error(r.message||"D\xE9ploiement \xE9chou\xE9.")}j(r.logs||[]),await y(),H("D\xE9ploiement termin\xE9")}catch(l){console.error("[deploy] run failed",l),Y(l.message||"D\xE9ploiement \xE9chou\xE9.","error")}finally{U(null)}}),z==null||z.addEventListener("change",()=>{S&&(S.type=z.checked?"text":"password")}),w(),y()}function Bs(){let o=document.querySelectorAll("[data-settings-tab]"),d=document.querySelectorAll("[data-settings-panel]"),h=document.querySelector("[data-admin-password-form]"),C=document.querySelector("[data-site-config-form]"),F=document.querySelector("[data-site-config-feedback]"),S=document.querySelector("[data-theme-form]"),z=E=>{o.forEach(f=>{let q=f.dataset.settingsTab===E;f.setAttribute("aria-selected",q?"true":"false"),f.classList.toggle("bg-[#9C6BFF]",q),f.classList.toggle("text-white",q)}),d.forEach(f=>{f.classList.toggle("hidden",f.dataset.settingsPanel!==E)})};if(o.forEach(E=>{E.addEventListener("click",()=>z(E.dataset.settingsTab||"account"))}),z("account"),h){let E=h.querySelector("[data-admin-password-feedback]"),f=h.querySelector("[data-admin-password-submit]"),q=(P,L="muted")=>{if(!E)return;let k=L==="success"?"text-emerald-600":L==="error"?"text-rose-600":"text-slate-500";E.textContent=P||"",E.className=`text-sm ${k}`};h.addEventListener("submit",async P=>{P.preventDefault();let L=new FormData(h),k=L.get("currentPassword")||"",g=L.get("newPassword")||"",u=L.get("confirmPassword")||"";if(!k||!g||!u){q("Compl\xE8te tous les champs.","error");return}f&&(f.disabled=!0),q("");try{let x=await fetch("/api/admin/password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({currentPassword:k,newPassword:g,confirmPassword:u})}),p=await x.json().catch(()=>({}));if(!x.ok||p.success===!1)throw new Error(p.message||"Impossible de mettre \xE0 jour le mot de passe.");q(p.message||"Mot de passe mis \xE0 jour.","success"),h.reset()}catch(x){console.error("[settings] change password failed",x),q(x.message||"Erreur lors de la mise \xE0 jour.","error")}finally{f&&(f.disabled=!1)}})}if(C){let E=C.querySelector("[data-site-name]"),f=C.querySelector("[data-site-language]"),q=C.querySelector("[data-site-tagline]"),P=C.querySelector("[data-site-save]"),L=(x,p="muted")=>{if(!F)return;let M=p==="success"?"text-emerald-600":p==="error"?"text-rose-600":"text-slate-500";F.textContent=x||"",F.className=`text-sm ${M}`},k=Ee((V==null?void 0:V.slugValue)||_.slug||""),g=k?`/api/sites/${encodeURIComponent(k)}/config/site`:null,u=async()=>{if(g)try{let x=await fetch(g,{headers:{Accept:"application/json"}});if(!x.ok)return;let p=await x.json().catch(()=>({}));E&&(E.value=p.name||""),f&&(f.value=p.language||"fr"),q&&(q.value=p.tagline||"")}catch(x){console.error("[settings] load site config failed",x)}};C.addEventListener("submit",async x=>{if(x.preventDefault(),!g){L("Aucun site actif.","error");return}if(!(E!=null&&E.value.trim())){L("Nom requis.","error");return}P&&(P.disabled=!0),L("");try{let p={name:(E==null?void 0:E.value)||"",language:(f==null?void 0:f.value)||"fr",tagline:(q==null?void 0:q.value)||""},M=await fetch(g,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)}),ne=await M.json().catch(()=>({}));if(!M.ok||ne.success===!1)throw new Error(ne.message||"Sauvegarde impossible.");L(ne.message||"Param\xE8tres enregistr\xE9s.","success")}catch(p){console.error("[settings] save site config failed",p),L(p.message||"Erreur lors de la sauvegarde.","error")}finally{P&&(P.disabled=!1)}}),u()}if(S){let E=Ee((V==null?void 0:V.slugValue)||_.slug||""),f=E?`/api/sites/${encodeURIComponent(E)}/config/theme`:null,q={primary:S.querySelector("[data-theme-primary]"),secondary:S.querySelector("[data-theme-secondary]"),accent:S.querySelector("[data-theme-accent]"),background:S.querySelector("[data-theme-background]"),text:S.querySelector("[data-theme-text]")},P=S.querySelector("[data-theme-headings]"),L=S.querySelector("[data-theme-body]"),k=S.querySelector("[data-theme-radius-small]"),g=S.querySelector("[data-theme-radius-medium]"),u=S.querySelector("[data-theme-radius-large]"),x=S.querySelector("[data-theme-preview]"),p=S.querySelector("[data-theme-feedback]"),M=S.querySelector("[data-theme-apply]"),ne=["slate","gray","zinc","neutral","stone","red","orange","amber","yellow","lime","green","emerald","teal","cyan","sky","blue","indigo","violet","purple","fuchsia","pink","rose"],J=["50","100","200","300","400","500","600","700","800","900"],te=ne.flatMap(y=>J.map(w=>`${y}-${w}`)),Y=()=>{Object.values(q).forEach(y=>{!y||y.options.length||te.forEach(w=>{let N=document.createElement("option");N.value=w;let[l,r]=w.split("-");N.textContent=`${l.charAt(0).toUpperCase()+l.slice(1)} ${r}`,y.appendChild(N)})})},U=(y,w="muted")=>{if(!p)return;let N=w==="success"?"text-emerald-600":w==="error"?"text-rose-600":"text-slate-500";p.textContent=y||"",p.className=`text-sm ${N}`},W=()=>{var w,N,l,r,c;if(!x)return;let y=K=>{if(!K)return null;let[D,Z]=K.split("-"),se={slate:"#e2e8f0",gray:"#d1d5db",zinc:"#d4d4d8",neutral:"#d4d4d4",stone:"#d6d3d1",red:"#ef4444",orange:"#f97316",amber:"#f59e0b",yellow:"#eab308",lime:"#84cc16",green:"#22c55e",emerald:"#10b981",teal:"#14b8a6",cyan:"#06b6d4",sky:"#0ea5e9",blue:"#3b82f6",indigo:"#6366f1",violet:"#8b5cf6",purple:"#a855f7",fuchsia:"#d946ef",pink:"#ec4899",rose:"#f43f5e"}[D];if(!se)return null;let Q=Number(Z)||500,fe=Math.min(Math.max((Q-50)/900,0),1),ye=ge=>ge.match(/[A-Fa-f0-9]{2}/g).map(Fe=>parseInt(Fe,16)),[ve,ae,Be]=ye(se.replace("#","")),oe=ge=>Math.round(255-(255-ge)*fe);return`rgb(${oe(ve)}, ${oe(ae)}, ${oe(Be)})`};x.style.setProperty("--color-primary",y((w=q.primary)==null?void 0:w.value)||"#9C6BFF"),x.style.setProperty("--color-secondary",y((N=q.secondary)==null?void 0:N.value)||"#0EA5E9"),x.style.setProperty("--color-accent",y((l=q.accent)==null?void 0:l.value)||"#F97316"),x.style.setProperty("--color-background",y((r=q.background)==null?void 0:r.value)||"#FFFFFF"),x.style.setProperty("--color-text",y((c=q.text)==null?void 0:c.value)||"#0F172A"),x.style.setProperty("--font-headings",(P==null?void 0:P.value)||"Inter, sans-serif"),x.style.setProperty("--font-body",(L==null?void 0:L.value)||"Inter, sans-serif"),x.style.setProperty("--radius-small",(k==null?void 0:k.value)||"8px"),x.style.setProperty("--radius-medium",(g==null?void 0:g.value)||"16px"),x.style.setProperty("--radius-large",(u==null?void 0:u.value)||"24px"),x.style.borderRadius=(g==null?void 0:g.value)||"16px"},O=(y,w)=>{q[y]&&(q[y].value=w)};Object.keys(q).forEach(y=>{var w;(w=q[y])==null||w.addEventListener("change",W)}),[P,L,k,g,u].forEach(y=>{y==null||y.addEventListener("change",W)});let j=async()=>{var y,w,N,l,r,c,K,D,Z,ue;if(f)try{let se=await fetch(f,{headers:{Accept:"application/json"}});if(!se.ok)return;let Q=await se.json().catch(()=>({}));O("primary",((y=Q.colors)==null?void 0:y.primary)||"violet-500"),O("secondary",((w=Q.colors)==null?void 0:w.secondary)||"indigo-400"),O("accent",((N=Q.colors)==null?void 0:N.accent)||"emerald-500"),O("background",((l=Q.colors)==null?void 0:l.background)||"slate-50"),O("text",((r=Q.colors)==null?void 0:r.text)||"slate-900"),P&&(P.value=((c=Q.typography)==null?void 0:c.headings)||"Inter, sans-serif"),L&&(L.value=((K=Q.typography)==null?void 0:K.body)||"Inter, sans-serif"),k&&(k.value=((D=Q.radius)==null?void 0:D.small)||"8px"),g&&(g.value=((Z=Q.radius)==null?void 0:Z.medium)||"16px"),u&&(u.value=((ue=Q.radius)==null?void 0:ue.large)||"24px"),W()}catch(se){console.error("[settings] load theme failed",se)}};Y(),M==null||M.addEventListener("click",async y=>{var N,l,r,c,K;if(y.preventDefault(),!f){U("Aucun site actif.","error");return}let w={colors:{primary:((N=q.primary)==null?void 0:N.value)||"violet-500",secondary:((l=q.secondary)==null?void 0:l.value)||"indigo-400",accent:((r=q.accent)==null?void 0:r.value)||"emerald-500",background:((c=q.background)==null?void 0:c.value)||"slate-50",text:((K=q.text)==null?void 0:K.value)||"slate-900"},typography:{headings:(P==null?void 0:P.value)||"Inter, sans-serif",body:(L==null?void 0:L.value)||"Inter, sans-serif"},radius:{small:(k==null?void 0:k.value)||"8px",medium:(g==null?void 0:g.value)||"16px",large:(u==null?void 0:u.value)||"24px"}};M.disabled=!0,U("");try{let D=await fetch(f,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(w)}),Z=await D.json().catch(()=>({}));if(!D.ok||Z.success===!1)throw new Error(Z.message||"Application du th\xE8me \xE9chou\xE9e.");U(Z.message||"Th\xE8me appliqu\xE9.","success"),W()}catch(D){console.error("[settings] apply theme failed",D),U(D.message||"Erreur lors de l\u2019application du th\xE8me.","error")}finally{M.disabled=!1}}),Y(),j(),W()}}function Fs(){let o=document.querySelector("[data-media-grid]");if(!o)return;let d=document.querySelector("[data-media-empty]"),h=document.querySelector("[data-media-count]"),C=document.querySelector("[data-media-filter-type]"),F=document.querySelector("[data-media-detail-empty]"),S=document.querySelector("[data-media-detail]"),z=document.querySelector("[data-media-detail-preview]"),E=document.querySelector("[data-media-detail-name]"),f=document.querySelector("[data-media-detail-type]"),q=document.querySelector("[data-media-detail-size]"),P=document.querySelector("[data-media-detail-path]"),L=document.querySelector("[data-media-detail-used]"),k=document.querySelector("[data-media-alt-edit]"),g=document.querySelector("[data-media-save]"),u=document.querySelector("[data-media-delete]"),x=document.querySelector("[data-media-delete-modal]"),p=document.querySelector("[data-media-delete-cancel]"),M=document.querySelector("[data-media-delete-confirm]"),ne=document.querySelector("[data-media-upload-open]"),J=document.querySelector("[data-media-file-input]"),te=document.querySelector("[data-media-upload-status]"),Y=Ee((V==null?void 0:V.slugValue)||_.slug||""),U=Y?`/api/sites/${encodeURIComponent(Y)}/media`:null,W=[],O=[],j=null,y=null,w=null,N=!1,l=!1,r=!1,c=null,K=i=>{let v=(i.type||"").toLowerCase(),R=(i.filename||"").toLowerCase();return v.includes("image")||/\.(png|jpe?g|webp|svg|gif)$/i.test(R)?"image":v.includes("pdf")||v.includes("doc")||/\.(pdf|docx?)$/i.test(R)?"document":v.includes("video")||/\.(mp4|mov|webm)$/i.test(R)?"video":"other"},D=i=>K(i)==="image",Z=i=>{if(i.type)return i.type.toUpperCase();let v=(i.filename||"").split(".").pop();return v?v.toUpperCase():"FILE"},ue=i=>!i||i<=0?"\u2014":i<1024?`${i} o`:i<1024*1024?`${(i/1024).toFixed(1)} ko`:`${(i/(1024*1024)).toFixed(1)} Mo`,se=()=>{S==null||S.classList.add("hidden"),F==null||F.classList.remove("hidden"),Q(),j=null,l=!1,ae(!1),z&&(z.innerHTML='<span class="text-slate-400 text-sm">Aucun m\xE9dia s\xE9lectionn\xE9</span>'),E&&(E.textContent=""),f&&(f.textContent=""),q&&(q.textContent=""),k&&(k.value=""),P&&(P.textContent=""),L&&(L.innerHTML="")},Q=()=>{w=null,r=!1,N=!1,c&&(URL.revokeObjectURL(c),c=null),te&&(te.textContent="Aucun fichier s\xE9lectionn\xE9."),J&&(J.value="")},fe=()=>{h&&(O.length?O.length===1?h.textContent="1 m\xE9dia":h.textContent=`${O.length} m\xE9dias`:h.textContent="0 m\xE9dia")},ye=()=>{if(o.innerHTML="",!O.length){d==null||d.classList.remove("hidden"),se();return}d==null||d.classList.add("hidden"),O.forEach(i=>{let v=document.createElement("button");v.type="button",v.dataset.mediaId=i.id;let R=i.id===j;v.className=["group relative flex flex-col rounded-2xl border px-3 py-3 text-left transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#9C6BFF]",R?"border-[#9C6BFF] bg-[#F7F0FF]/60 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let T=D(i)?`<img src="${i.path}" alt="${i.alt||i.filename}" class="h-full w-full object-cover" />`:'<div class="flex h-full w-full items-center justify-center text-3xl text-slate-400">\u{1F4C4}</div>';v.innerHTML=`
          <div class="relative aspect-[4/3] overflow-hidden rounded-xl bg-slate-100">
            ${T}
          </div>
          <div class="mt-2 space-y-1">
            <p class="text-sm font-semibold text-slate-900 truncate">${i.filename}</p>
            <p class="text-xs text-slate-500">
              ${Z(i)} \xB7 ${ue(i.size)}
            </p>
          </div>
        `,i.id===y&&(v.classList.add("ring-2","ring-[#9C6BFF]"),window.setTimeout(()=>{v.classList.remove("ring-2","ring-[#9C6BFF]")},1600)),v.addEventListener("click",()=>Be(i.id)),o.appendChild(v)}),y=null},ve=i=>{if(L){if(L.innerHTML="",!i.usedIn||i.usedIn.length===0){let v=document.createElement("li");v.textContent="Non utilis\xE9",v.className="text-xs text-slate-400",L.appendChild(v);return}i.usedIn.forEach(v=>{let R=document.createElement("li");R.textContent=v,R.className="text-xs text-slate-600",L.appendChild(R)})}},ae=i=>{if(g){if(r){g.textContent=i?"T\xE9l\xE9versement\u2026":"T\xE9l\xE9verser",g.disabled=i||!w,u&&u.classList.add("hidden");return}g.textContent=i?"Enregistrement\u2026":"Enregistrer",g.disabled=i||!l,u&&(u.classList.remove("hidden"),u.disabled=!j)}},Be=i=>{let v=W.find(R=>R.id===i);if(!v){se(),ye();return}Q(),j=v.id,l=!1,ae(!1),ye(),F==null||F.classList.add("hidden"),S==null||S.classList.remove("hidden"),z&&(D(v)?z.innerHTML=`<img src="${v.path}" alt="${v.alt||v.filename}" class="h-full w-full rounded-2xl object-cover" />`:z.innerHTML='<div class="flex h-full w-full flex-col items-center justify-center gap-1 text-slate-400"><span class="text-3xl">\u{1F4C4}</span><span class="text-xs font-semibold">Document</span></div>'),E&&(E.textContent=v.filename||"Fichier"),f&&(f.textContent=Z(v)),q&&(q.textContent=ue(v.size)),k&&(k.value=v.alt||""),P&&(P.textContent=v.path||"\u2014"),ve(v)},oe=i=>{if(i){if(r=!0,l=!1,j=null,F==null||F.classList.add("hidden"),S==null||S.classList.remove("hidden"),c&&URL.revokeObjectURL(c),c=URL.createObjectURL(i),z&&(z.innerHTML=`<img src="${c}" alt="${i.name}" class="h-full w-full rounded-2xl object-cover" />`),E&&(E.textContent=i.name),f&&(f.textContent=Z({type:i.type,filename:i.name})),q&&(q.textContent=ue(i.size)),k&&!k.value.trim()&&(k.value=i.name.replace(/\.[^.]+$/,"").replace(/[-_]/g," ")),P&&(P.textContent="En attente de t\xE9l\xE9versement"),L){L.innerHTML="";let v=document.createElement("li");v.textContent="Non utilis\xE9",v.className="text-xs text-slate-400",L.appendChild(v)}ae(!1)}},ge=()=>{let i=(C==null?void 0:C.value)||"all";i==="all"?O=[...W]:O=W.filter(v=>v.groupType===i),O.some(v=>v.id===j)||se(),fe(),ye()},Fe=async()=>{if(!U){d==null||d.classList.remove("hidden");return}try{let i=await fetch(U,{headers:{Accept:"application/json"}});if(!i.ok)throw new Error("Impossible de charger les m\xE9dias.");let v=await i.json().catch(()=>({items:[]}));W=Array.isArray(v.items)?v.items.map(R=>({...R,groupType:K(R)})):[],ge()}catch(i){console.error("[media] load failed",i),H(i.message||"Impossible de charger les m\xE9dias."),W=[],ge()}};C==null||C.addEventListener("change",()=>{ge()}),k==null||k.addEventListener("input",()=>{if(r){ae(!1);return}j&&(l=!0,ae(!1))});let Oe=i=>{if(i){if(!i.type.startsWith("image/")){H("Seules les images sont accept\xE9es pour le moment.");return}if(i.size>4*1024*1024){H("Fichier trop volumineux (4 Mo max).");return}w=i,oe(i),te&&(te.textContent=`${i.name} \xB7 ${ue(i.size)}`)}},ze=i=>new Promise((v,R)=>{let T=new FileReader;T.onload=()=>{let Me=T.result||"",[,Je=""]=String(Me).split(",");v(Je)},T.onerror=()=>R(new Error("Impossible de lire ce fichier.")),T.readAsDataURL(i)}),He=async()=>{if(!(!w||!U)){N=!0,ae(!0);try{let i=await ze(w),v={filename:w.name,type:w.type,size:w.size,alt:(k==null?void 0:k.value)||"",data:i},R=await fetch(U,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(v)});if(!R.ok){let Me=await R.json().catch(()=>({}));throw new Error(Me.message||"Upload impossible.")}let T=await R.json();T.groupType=K(T),W=[...W,T],y=T.id,ge(),Be(T.id),H("M\xE9dia ajout\xE9"),Q()}catch(i){console.error("[media] upload failed",i),H(i.message||"Impossible de t\xE9l\xE9verser ce m\xE9dia.")}finally{N=!1,w=null,ae(!1)}}};ne==null||ne.addEventListener("click",()=>J==null?void 0:J.click()),J==null||J.addEventListener("change",()=>{J.files&&J.files[0]&&Oe(J.files[0])});let be=()=>{x&&(x.classList.add("hidden"),x.classList.remove("flex"))},Ve=()=>{if(!(!j||r)){if(x){x.classList.remove("hidden"),x.classList.add("flex");return}window.confirm("Supprimer ce m\xE9dia ?")&&$e()}},$e=async()=>{if(!j||!U){be();return}let i=()=>{u&&(u.disabled=!0),M&&(M.disabled=!0,M.textContent="Suppression\u2026")},v=()=>{u&&(u.disabled=!1),M&&(M.disabled=!1,M.textContent="Supprimer")};i();try{let R=await fetch(`${U}/${encodeURIComponent(j)}`,{method:"DELETE"});if(!R.ok){let T=await R.json().catch(()=>({}));throw new Error(T.message||"Suppression impossible.")}W=W.filter(T=>T.id!==j),O=O.filter(T=>T.id!==j),H("M\xE9dia supprim\xE9"),se(),fe(),ye()}catch(R){console.error("[media] delete failed",R),H(R.message||"Impossible de supprimer ce m\xE9dia.")}finally{v(),be()}};p==null||p.addEventListener("click",be),x==null||x.addEventListener("click",i=>{i.target===x&&be()}),M==null||M.addEventListener("click",()=>$e()),u==null||u.addEventListener("click",Ve),g==null||g.addEventListener("click",async()=>{if(r){He();return}if(!(!j||!U||!k)){ae(!0);try{let i={alt:k.value||""},v=await fetch(`${U}/${encodeURIComponent(j)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!v.ok){let T=await v.json().catch(()=>({}));throw new Error(T.message||"Impossible de mettre \xE0 jour ce m\xE9dia.")}let R=await v.json();W=W.map(T=>T.id===j?{...T,...R}:T),O=O.map(T=>T.id===j?{...T,...R}:T),l=!1,ae(!1),H("M\xE9dia mis \xE0 jour")}catch(i){console.error("[media] update failed",i),H(i.message||"\xC9chec de la mise \xE0 jour."),ae(!1)}}}),Fe()}});})();
