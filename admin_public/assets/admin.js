(()=>{document.addEventListener("DOMContentLoaded",()=>{console.log("[admin] Atelier charg\xE9");let Ct=document.querySelector("[data-logout]");Ct&&Ct.addEventListener("click",async()=>{Ct.disabled=!0;try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(n){console.error("[admin] Impossible de se d\xE9connecter",n)}finally{window.location.href="/admin/index.html"}});let We=document.querySelector("[data-admin-sidebar]"),me=document.querySelector("[data-admin-sidebar-overlay]"),Jt=document.querySelectorAll("[data-admin-sidebar-toggle]"),is=document.querySelectorAll("[data-admin-sidebar-close]"),Et=document.body,it=!1,lt=()=>{if(!We)return;if(window.matchMedia("(min-width: 1024px)").matches){We.classList.remove("hidden"),me==null||me.classList.add("hidden"),Et.classList.remove("overflow-hidden");return}it?(We.classList.remove("hidden"),me==null||me.classList.remove("hidden"),Et.classList.add("overflow-hidden")):(We.classList.add("hidden"),me==null||me.classList.add("hidden"),Et.classList.remove("overflow-hidden"))},ls=()=>{it=!0,lt()},qt=()=>{it=!1,lt()};We&&Jt.length>0&&(Jt.forEach(n=>{n.addEventListener("click",ls)}),is.forEach(n=>{n.addEventListener("click",qt)}),me==null||me.addEventListener("click",qt),window.addEventListener("resize",lt),window.addEventListener("keydown",n=>{n.key==="Escape"&&it&&qt()}),lt());let Wt="clower:currentSite",Gt="clower:currentSiteName",Y={slug:null,name:""};(()=>{try{Y.slug=window.localStorage.getItem(Wt),Y.name=window.localStorage.getItem(Gt)||""}catch{Y.slug=null,Y.name=""}})();let kt=document.querySelectorAll("[data-site-card]"),cs=document.querySelectorAll("[data-site-select]"),Ge=document.querySelector("[data-current-site-name]"),_t=document.querySelector("[data-workspace-site-name]"),Yt=document.querySelector("[data-workspace-back-name]"),Be=document.querySelector("[data-workspace-back-modal]"),ds=document.querySelectorAll("[data-workspace-back]"),us=document.querySelectorAll("[data-workspace-back-cancel]"),It=document.querySelector("[data-workspace-back-confirm]"),ms=document.querySelectorAll("[data-workspace-tab]"),At=document.querySelector("[data-site-toast]"),Kt=document.querySelector("[data-site-toast-message]"),ps=document.querySelectorAll("[data-site-create]"),le=document.querySelector("[data-site-modal]"),Ee=document.querySelector("[data-site-form]"),ge=document.querySelector("[data-site-name]"),xe=document.querySelector("[data-site-slug]"),ue=document.querySelector("[data-site-slug-error]"),we=document.querySelector("[data-site-modal-error]"),fs=document.querySelectorAll("[data-site-modal-cancel]"),He=document.querySelector("[data-site-modal-submit]"),G=ws(),ct=!1,dt=null,Bt=null,gs='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',Xt=n=>{if(!le||le.classList.contains("hidden")||n.key!=="Tab")return;let i=Array.from(le.querySelectorAll(gs)).filter(w=>!w.hasAttribute("disabled")&&!w.getAttribute("aria-hidden"));if(i.length===0)return;let b=i[0],h=i[i.length-1];n.shiftKey?document.activeElement===b&&(n.preventDefault(),h.focus()):document.activeElement===h&&(n.preventDefault(),b.focus())},H=n=>{!At||!Kt||(Kt.textContent=n,At.classList.remove("hidden"),Bt&&clearTimeout(Bt),Bt=setTimeout(()=>{At.classList.add("hidden")},2500))};function qe(n){return n?n.startsWith("/")?n:`/${n}`:""}function ke(n){return(n==null?void 0:n.replace(/^\//,""))||""}let ut=(n,i)=>{let b=n?qe(n):null;try{b&&(window.localStorage.setItem(Wt,b),Y.slug=b),typeof i=="string"&&i.length>0&&(window.localStorage.setItem(Gt,i),Y.name=i)}catch{Y.slug=b||Y.slug,Y.name=i||Y.name}},Zt=n=>{Ge&&n&&(Ge.textContent=n),_t&&n&&(_t.textContent=n),Yt&&n&&(Yt.textContent=n)},Tt=n=>{ms.forEach(i=>{let b=i.dataset.workspaceTab;if(!b)return;if(!n){i.href="#",i.classList.add("pointer-events-none","opacity-50","text-slate-400"),i.setAttribute("aria-disabled","true");return}let h=encodeURIComponent(ke(n));i.href=`/admin/site/${h}/${b}`,i.classList.remove("pointer-events-none","opacity-50","text-slate-400"),i.removeAttribute("aria-disabled")})},mt=(n,i={})=>{if(!n)return;let b=qe(n),h=i.siteName||Y.name||(Ge==null?void 0:Ge.dataset.defaultSiteName)||"";kt.forEach(x=>{let F=qe(x.dataset.siteCard||"")===b,u=x.querySelector("[data-site-active-badge]");F?(x.classList.add("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),x.classList.remove("border-slate-200"),u==null||u.classList.remove("hidden"),h=x.dataset.siteName||h):(x.classList.remove("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),x.classList.add("border-slate-200"),u==null||u.classList.add("hidden"))}),i.persist!==!1&&ut(b,i.siteName||h);let w=i.siteName||h;Zt(w),Tt(b)},hs=async(n,i)=>{let b=qe(n);try{let h=await fetch("/api/sites/select",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slug:b})});if(!h.ok){let u=await h.json().catch(()=>({}));H(u.message||"Impossible de s\xE9lectionner ce site.");return}let w=await h.json().catch(()=>({})),x=qe(w.slug||b),N=w.name||i;ut(x,N),mt(x,{siteName:N,persist:!1});let F=encodeURIComponent(ke(x));window.location.href=`/admin/site/${F}/design`}catch(h){console.error("[admin] Impossible de s\xE9lectionner le site",h),H("Erreur inattendue lors de la s\xE9lection.")}},ys=async()=>{try{let n=await fetch("/api/sites/current",{credentials:"same-origin"});if(!n.ok){n.status===404&&G&&(window.location.href="/admin/sites");return}let i=await n.json(),b=qe(i.slug);ut(b,i.name),mt(b,{siteName:i.name,persist:!1})}catch(n){console.warn("[admin] Impossible de r\xE9cup\xE9rer le site actif",n)}};(()=>{if(Y.slug){mt(Y.slug,{siteName:Y.name,persist:!1});return}let n=document.querySelector('[data-site-card][data-site-default="true"]')||kt[0];n&&mt(n.dataset.siteCard,{siteName:n.dataset.siteName||"",persist:!1})})(),ys(),G?Tt(G.slugValue):Y.slug&&Tt(Y.slug),cs.forEach(n=>{n.addEventListener("click",()=>{if(n.disabled)return;let i=n.dataset.siteSelect,b=n.dataset.siteSelectName||"Ce site";i&&(n.disabled=!0,hs(i,b).finally(()=>{n.disabled=!1}))})});let _e=n=>n.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),vs=n=>{let i=_e(n||"");return i?`/${i}`:""},bs=()=>{le&&(dt=document.activeElement,le.classList.remove("hidden"),le.classList.add("flex"),ct=!1,Ee==null||Ee.reset(),ue&&(ue.textContent=""),we&&(we.textContent=""),xe&&ge&&(xe.value=_e(ge.value)),document.addEventListener("keydown",Xt),window.setTimeout(()=>{ge==null||ge.focus()},0))},pt=()=>{le&&(le.classList.add("hidden"),le.classList.remove("flex"),document.removeEventListener("keydown",Xt),ct=!1,Ee==null||Ee.reset(),ue&&(ue.textContent=""),we&&(we.textContent=""),dt==null||dt.focus())};ps.forEach(n=>{n.addEventListener("click",bs)}),fs.forEach(n=>{n.addEventListener("click",pt)}),le==null||le.addEventListener("click",n=>{n.target===le&&pt()}),ge==null||ge.addEventListener("input",()=>{xe&&(!ct||xe.value.trim().length===0)&&(xe.value=_e(ge.value))}),xe==null||xe.addEventListener("input",()=>{ct=!0,ue&&(ue.textContent="")});let xs=()=>new Set(Array.from(kt).map(n=>qe(n.dataset.siteCard||"")));Ee==null||Ee.addEventListener("submit",async n=>{if(n.preventDefault(),!ge||!xe)return;let i=(ge.value||"").trim(),b=xe.value||"";b||(b=i);let h=vs(b);if(!i||!h){ue&&(ue.textContent="Nom et slug sont requis.");return}if(xs().has(h)){ue&&(ue.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}ue&&(ue.textContent=""),we&&(we.textContent=""),He&&(He.disabled=!0,He.textContent="Cr\xE9ation...");try{let x=await fetch("/api/sites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:i,slug:h})});if(!x.ok){let J=await x.json().catch(()=>({})),j=J.message||"Impossible de cr\xE9er ce site.";we&&(we.textContent=j),J.field==="slug"&&ue&&(ue.textContent=j);return}let N=await x.json(),F=qe((N==null?void 0:N.slug)||h),u=(N==null?void 0:N.name)||i;ut(F,u),pt();let V=encodeURIComponent(ke(F));window.location.href=`/admin/site/${V}/design`}catch(x){console.error("[admin] Impossible de cr\xE9er le site",x),we&&(we.textContent="Erreur inattendue. R\xE9essaie dans un instant.")}finally{He&&(He.disabled=!1,He.textContent="Cr\xE9er")}}),window.addEventListener("keydown",n=>{n.key==="Escape"&&(le&&!le.classList.contains("hidden")&&pt(),Be&&!Be.classList.contains("hidden")&&Qt(),blockDeleteModal&&!blockDeleteModal.classList.contains("hidden")&&closeBlockDeleteModal(),blockLibraryOpen&&closeBlockLibrary())});function ws(){let n=window.location.pathname.match(/^\/admin\/site\/([^/]+)(?:\/([^/]+))?/);return n?{slugPart:decodeURIComponent(n[1]),slugValue:qe(decodeURIComponent(n[1])),section:n[2]||"design"}:null}function Ss(){return document.querySelector("[data-page-list]")?"design":document.querySelector("[data-collection-list]")?"content":document.querySelector("[data-media-grid]")?"media":document.querySelector("[data-deploy-form]")?"deploy":null}function Ls(){if(!Be){window.location.href="/admin/sites";return}Be.classList.remove("hidden"),Be.classList.add("flex")}function Qt(){Be&&(Be.classList.add("hidden"),Be.classList.remove("flex"))}ds.forEach(n=>{n.addEventListener("click",Ls)}),us.forEach(n=>{n.addEventListener("click",Qt)}),It==null||It.addEventListener("click",()=>{window.location.href="/admin/sites"});let Ye=(G==null?void 0:G.section)||Ss();Ye==="design"&&Cs(),Ye==="content"&&Es(),Ye==="media"&&Is(),Ye==="deploy"&&qs(),Ye==="settings"&&ks(),G&&Y.name&&Zt(Y.name);function Cs(){let n=document.querySelectorAll("[data-page-list]");if(n.length===0)return;let i=document.querySelector("[data-active-page-title]"),b=document.querySelector("[data-active-page-slug]"),h=document.querySelector("[data-page-preview-tags]"),w=document.querySelector("[data-page-preview-frame]"),x=document.querySelector("[data-preview-open]"),N=document.querySelector("[data-preview-status]"),F=document.querySelector("[data-preview-highlight]"),u=document.querySelector("[data-blocks-list]"),V=document.querySelector("[data-blocks-empty]"),J=document.querySelector("[data-block-count]"),j=document.querySelector("[data-block-library-toggle]"),q=document.querySelector("[data-block-library]"),S=document.querySelectorAll("[data-block-add]"),d=document.querySelector("[data-block-delete-modal]"),P=document.querySelector("[data-block-delete-confirm]"),z=document.querySelector("[data-block-delete-cancel]"),I=document.querySelector("[data-block-detail-empty]"),W=document.querySelector("[data-block-detail-status]"),$=document.querySelector("[data-block-editor]"),Q=document.querySelector("[data-block-editor-block-name]"),O=document.querySelector("[data-block-editor-block-type]"),M=document.querySelector("[data-block-editor-unsupported]"),f=document.querySelector("[data-block-form]"),U=f?Array.from(f.querySelectorAll("[data-editor-section]")):[],L=f==null?void 0:f.querySelector('[name="collection-grid-collection"]'),p=f==null?void 0:f.querySelector("[data-collection-selection-info]"),y=document.querySelector("[data-block-form-cancel]"),A=f==null?void 0:f.querySelector("[data-group-preview-mobile]"),l=f==null?void 0:f.querySelector("[data-group-preview-desktop]"),c={hero:{section:"hero",labelField:"title",descriptionField:"subtitle",fields:{title:"hero-title",subtitle:"hero-subtitle",ctaLabel:"hero-cta-label",ctaUrl:"hero-cta-url",image:"hero-image",align:"hero-align"}},paragraphe:{section:"paragraph",labelField:"title",descriptionField:"content",fields:{title:"paragraph-title",content:"paragraph-content",align:"paragraph-align"}},image:{section:"image",labelField:"alt",fields:{src:"image-src",alt:"image-alt",showCaption:"image-caption-toggle",caption:"image-caption"}},groupe:{section:"group",fields:{layout:"group-layout",columnsMobile:"group-columns-mobile",columnsDesktop:"group-columns-desktop"}},collectiongrid:{section:"collection",fields:{collectionId:"collection-grid-collection",limit:"collection-grid-limit"}}},C={texte:"paragraphe",paragraph:"paragraphe",paragraphs:"paragraphe",paragraphes:"paragraphe",text:"paragraphe",hero:"hero",image:"image",groupe:"groupe",group:"groupe",collection:"collectiongrid",collectiongrid:"collectiongrid","collection-grid":"collectiongrid"},K=(e,t)=>{if(!A||!l)return;let s=a=>Array.from({length:Number(a)||1}).map(()=>'<span class="block h-2 w-full rounded-full bg-slate-300"></span>').join("");A.innerHTML=s(e),l.innerHTML=s(t)},ee=async()=>{if(!o)return[];let e=await fetch(o,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les pages.");let t=await e.json().catch(()=>[]);return Array.isArray(t)?t:[]},oe=async({title:e,slug:t})=>{if(!o)throw new Error("Site inconnu.");let s=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,slug:t})});if(!s.ok){let a=await s.json().catch(()=>({}));throw new Error(a.message||"Impossible de cr\xE9er la page.")}return s.json().catch(()=>({}))},te=async e=>{if(!(!o||!(e!=null&&e.id)))try{let t=await fetch(`${o}/${encodeURIComponent(e.id)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let a=await t.json().catch(()=>({}));throw new Error(a.message||"Impossible de sauvegarder la page.")}let s=await t.json().catch(()=>({}));if(s!=null&&s.id){let a=nt(s);return ce=ce.map(v=>v.id===a.id?a:v),(T==null?void 0:T.id)===a.id&&(T=a),a}return s}catch(t){console.error("[design] Save page failed",t),H(t.message||"Sauvegarde impossible.")}},he=async()=>{if(!o){ce=[],Le=null,T=null,$t(ce,Le),Qe(null),I==null||I.classList.remove("hidden"),$==null||$.classList.add("hidden");return}try{let e=await ee();if(ce=(Array.isArray(e)?e:[]).map(t=>nt(t)),ce.length===0){Le=null,T=null,$t(ce,Le),Qe(null),I==null||I.classList.remove("hidden"),$==null||$.classList.add("hidden"),w&&(w.srcdoc=se());return}Le=Re(ce),Ne(Le)}catch(e){console.error("[design] Impossible de charger les pages",e),H("Impossible de charger les pages.")}},Ie=e=>(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),ye=e=>{if(!e)return null;let t=Ie(e.type),s=C[t]||t;return c[s]||null},Se=e=>{var s,a,v;if(!f||!$)return;e&&!e.settings&&(e.settings={});let t=ye(e);if(Q&&(Q.textContent=(e==null?void 0:e.label)||"Bloc"),O&&(O.textContent=(e==null?void 0:e.type)||"Bloc"),!t){f.classList.add("hidden"),M==null||M.classList.remove("hidden"),f.dataset.blockId="";return}if(M==null||M.classList.add("hidden"),f.classList.remove("hidden"),f.reset(),f.dataset.blockId=e.id,U.forEach(k=>{k.dataset.editorSection===t.section?k.classList.remove("hidden"):k.classList.add("hidden")}),t.section==="collection"){let k=e.collectionId||((s=e.settings)==null?void 0:s.collectionId)||"";wt(k)}if(Object.entries(t.fields).forEach(([k,_])=>{var Ue;let X=f.querySelector(`[name="${_}"]`);if(!X)return;let ie=(Ue=e.settings)==null?void 0:Ue[k];X.type==="checkbox"?X.checked=!!ie:X.type==="number"?X.value=ie!=null?ie:1:(X.tagName,X.value=ie!=null?ie:"")}),t.section==="group"){let k=((a=f.querySelector('[name="group-columns-mobile"]'))==null?void 0:a.value)||"1",_=((v=f.querySelector('[name="group-columns-desktop"]'))==null?void 0:v.value)||"3";K(k,_)}},Te=e=>{if(!f||!e)return{};let t={};return Object.entries(e.fields).forEach(([s,a])=>{let v=f.querySelector(`[name="${a}"]`);if(v)if(v.type==="checkbox")t[s]=v.checked;else if(v.type==="number"){let k=Number(v.value);t[s]=Number.isFinite(k)?k:0}else v.tagName==="TEXTAREA"?t[s]=v.value||"":v.type==="select-one"?t[s]=v.value:t[s]=v.value||""}),t},Z=e=>{if(N){if(!e){N.classList.add("hidden");return}N.classList.remove("hidden"),N.textContent=e}},Pe=e=>e?{id:e.id,title:e.title,slug:e.slug,badges:[...e.badges||[]],blocks:(e.blocks||[]).map(t=>{var s;return{id:t.id,type:t.type,label:t.label,status:t.status,description:t.description,props:t.props||[],settings:t.settings||{},collectionId:t.collectionId||((s=t.settings)==null?void 0:s.collectionId)||""}})}:null,se=()=>'<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#475569;background:#fff;">Pr\xE9paration de la pr\xE9visualisation\u2026</body></html>',je=e=>{if(!w||!e)return;let t=(G==null?void 0:G.slugValue)||Y.slug||"",s={page:Pe(e),site:{title:Y.name||"Site",slug:t}};Rt=!1,Z("Actualisation\u2026"),w.srcdoc=se(),st&&st.abort();let a=new AbortController;st=a,fetch("/api/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s),signal:a.signal}).then(v=>{if(!v.ok)throw new Error("Preview error");return v.json()}).then(v=>{a.signal.aborted||(Dt=v.html||"",w.setAttribute("title",`Pr\xE9visualisation de la page ${e.title||""}`.trim()),w.srcdoc=Dt||se(),Z("\xC0 jour"))}).catch(v=>{a.signal.aborted||(console.error("[preview] Impossible de rendre la page",v),Z("Erreur preview"),w.srcdoc='<!DOCTYPE html><html><body style="font-family:Inter,sans-serif;padding:40px;color:#be123c;background:#fff;">Erreur lors du rendu de la pr\xE9visualisation.</body></html>')}).finally(()=>{st===a&&(st=null)})},Me=e=>{if(e.preventDefault(),!T||!de)return;let t=Ft(),s=ye(t);if(!t||!s)return;let a=Te(s);if(s.section==="collection"){if(!a.collectionId){H("S\xE9lectionnez une collection.");return}a.limit=Math.max(1,Number(a.limit)||1)}let v=(T.blocks||[]).map(k=>{if(k.id!==t.id)return k;let _={...k.settings||{},...a},X={...k,settings:_};return s.labelField&&a[s.labelField]&&(X.label=a[s.labelField]),s.descriptionField&&a[s.descriptionField]&&(X.description=a[s.descriptionField]),s.section==="collection"&&(X.collectionId=a.collectionId,X.settings.collectionId=a.collectionId,X.settings.limit=a.limit),X});et(v),H("Bloc mis \xE0 jour"),Ne(T.id,{preserveBlock:!0})},ve=document.querySelector("[data-page-drawer]"),ae=document.querySelector("[data-page-drawer-backdrop]"),ze=document.querySelectorAll("[data-page-drawer-open]"),$e=document.querySelectorAll("[data-page-drawer-close]"),pe=document.querySelector("[data-add-page-toggle]"),re=document.querySelector("[data-add-page-form]"),r=document.querySelector("[data-add-page-title]"),m=document.querySelector("[data-add-page-slug]"),D=document.querySelector("[data-add-page-cancel]"),E=document.querySelector("[data-add-page-error]"),fe=re==null?void 0:re.querySelector('[type="submit"]'),Oe=ke((G==null?void 0:G.slugValue)||Y.slug||"default")||"default",ft=(G==null?void 0:G.slugValue)||Y.slug||"",De=ke(ft)||"",o=De?`/api/sites/${encodeURIComponent(De)}/pages`:null,g=De?`/api/sites/${encodeURIComponent(De)}/collections`:null,B={active:`clower:activePage:${Oe}`},R=(e,t,s,a,v,k=[],_={})=>{let X={id:e,label:t,type:s,status:a,description:v,props:k,settings:{..._}};return X.settings.collectionId&&(X.collectionId=X.settings.collectionId),X},ne={hero:{type:"Hero",label:"Hero de page",description:"Section pleine largeur avec CTA principal.",status:"Brouillon",props:[{label:"CTA",value:"D\xE9couvrir"},{label:"Hauteur",value:"80vh"}],settings:{title:"Titre du hero",subtitle:"",ctaLabel:"D\xE9couvrir",ctaUrl:"#",image:"",align:"center"}},paragraph:{type:"Paragraphe",label:"Bloc \xE9ditorial",description:"Paragraphe libre pour raconter votre histoire.",status:"Brouillon",props:[{label:"Longueur",value:"150 mots"}],settings:{title:"Titre du paragraphe",content:"",align:"left"}},image:{type:"Image",label:"Bloc image",description:"Visuel seul avec l\xE9gende optionnelle.",status:"Brouillon",props:[{label:"Ratio",value:"16:9"},{label:"L\xE9gende",value:"Inactive"}],settings:{src:"",alt:"",showCaption:!1,caption:""}},group:{type:"Groupe",label:"Groupe de sections",description:"Conteneur pour imbriquer plusieurs sous-blocs.",status:"Brouillon",props:[{label:"Disposition",value:"Verticale"}],settings:{layout:"grid",columnsMobile:"1",columnsDesktop:"3"}},collectiongrid:{type:"CollectionGrid",label:"Grille de contenus",description:"Affiche automatiquement les items d\u2019une collection.",status:"Brouillon",settings:{collectionId:"",limit:6}}},Ke=e=>{try{window.localStorage.setItem(B.active,e)}catch{}},Re=e=>{var t;try{let s=window.localStorage.getItem(B.active);if(s&&e.some(a=>a.id===s))return s}catch{}return((t=e[0])==null?void 0:t.id)||null},Fe=e=>!e||e<=0?"0 bloc":e===1?"1 bloc":`${e} blocs`,Xe=e=>{if(!e||e==="/")return"/";let t=_e(e.replace(/^\//,""));return t?`/${t}`:"/"},Ve=(e="page",t="block")=>`${e}-${t}-${Date.now().toString(36)}-${Math.floor(Math.random()*1e3)}`,jt=(e,t)=>[R(Ve(e,"intro"),"Introduction","Paragraphe","Brouillon",`Paragraphe introductif pour "${t}".`,[{label:"Longueur",value:"2 paragraphes"}],{title:`Introduction \xE0 ${t}`,content:"Ajoutez votre premier paragraphe de pr\xE9sentation.",align:"left"}),R(Ve(e,"content"),"Zone de contenu","Groupe","Brouillon","Section principale \xE0 composer avec textes et visuels.",[{label:"Colonnes",value:"Auto"}],{layout:"grid",columnsMobile:"1",columnsDesktop:"2"})],gt=e=>{i&&(i.textContent=(e==null?void 0:e.title)||"Page"),b&&(b.textContent=(e==null?void 0:e.slug)||"/")},As=e=>{if(!h)return;h.innerHTML="",(e&&e.badges&&e.badges.length>0?e.badges:["Structure en cours"]).forEach(s=>{let a=document.createElement("span");a.className="rounded-full bg-slate-100 px-3 py-1",a.textContent=s,h.appendChild(a)})},Bs=e=>{switch((e||"").toLowerCase()){case"en ligne":return"bg-emerald-50 text-emerald-700";case"brouillon":return"bg-amber-50 text-amber-700";default:return"bg-slate-100 text-slate-600"}},ht=e=>{if(!(!I||!$)){if(!e){I.classList.remove("hidden"),$.classList.add("hidden"),M==null||M.classList.add("hidden"),f==null||f.classList.add("hidden"),W==null||W.classList.add("hidden");return}I.classList.add("hidden"),$.classList.remove("hidden"),W&&(e.status?(W.textContent=e.status,W.className=`rounded-full px-3 py-1 text-xs font-semibold ${Bs(e.status)}`,W.classList.remove("hidden")):W.classList.add("hidden")),Se(e)}},Ze=e=>{if(!w)return;let t=w.contentDocument;if(!t)return;t.querySelectorAll("[data-preview-block]").forEach(a=>{a.dataset.previewBlock===e?(a.classList.add("preview-block-active"),Rt&&e&&a.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})):a.classList.remove("preview-block-active")}),F&&(F.style.borderColor=e?"rgba(156, 107, 255, 0.5)":"transparent")},Qe=e=>{if(!u)return;u.innerHTML="";let t=(e==null?void 0:e.blocks)||[];if(J&&(J.textContent=Fe(t.length)),t.length===0){u.classList.add("hidden"),V==null||V.classList.remove("hidden");return}u.classList.remove("hidden"),V==null||V.classList.add("hidden"),t.forEach(s=>{var rs;let a=s.id===de,v=document.createElement("div");v.dataset.blockItem="true",v.dataset.blockId=s.id,v.setAttribute("role","option"),v.setAttribute("aria-selected",a?"true":"false"),v.tabIndex=0,v.className=["relative flex items-center gap-3 rounded-2xl border px-3 py-2 text-left transition",a?"bg-slate-100 border-[#9C6BFF]/40 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let k=document.createElement("span");k.className=`absolute inset-y-2 left-0 w-1 rounded-full bg-[#9C6BFF] ${a?"":"hidden"}`,v.appendChild(k);let _=document.createElement("div");_.className="flex flex-1 items-center gap-3";let X=document.createElement("div");X.className="hidden lg:flex cursor-grab flex-shrink-0 items-center text-lg text-slate-400",X.innerHTML="&#8801;",_.appendChild(X);let ie=document.createElement("div");ie.className="flex-1";let Ue=document.createElement("div");Ue.className="flex items-center gap-2 text-[11px] uppercase tracking-wide text-slate-500";let Ht=document.createElement("span");Ht.className="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600",Ht.textContent=s.type;let zt=document.createElement("span");zt.className="text-slate-400",zt.textContent=s.status,Ue.appendChild(Ht),Ue.appendChild(zt);let Ot=document.createElement("p");Ot.className="mt-1 text-sm font-semibold text-slate-900";let Gs=s.settings&&s.settings.title||s.label||"Bloc sans titre";if(Ot.textContent=Gs,ie.appendChild(Ue),ie.appendChild(Ot),(s.type||"").toLowerCase()==="collectiongrid"&&s.collectionId){let be=((rs=Ce.find(_s=>_s.id===s.collectionId))==null?void 0:rs.name)||s.collectionId,Vt=document.createElement("p");Vt.className="text-xs text-slate-400",Vt.textContent=`Collection : ${be}`,ie.appendChild(Vt)}_.appendChild(ie),v.appendChild(_);let St=document.createElement("div");St.className="flex flex-col gap-1 text-xs text-slate-400";let Lt=document.createElement("div");Lt.className="flex items-center gap-1 lg:hidden";let ot=document.createElement("button");ot.type="button",ot.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",ot.textContent="\u2191",ot.addEventListener("click",be=>{be.stopPropagation(),es(s.id,-1)});let at=document.createElement("button");at.type="button",at.className="rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-500",at.textContent="\u2193",at.addEventListener("click",be=>{be.stopPropagation(),es(s.id,1)}),Lt.appendChild(ot),Lt.appendChild(at),St.appendChild(Lt);let rt=document.createElement("button");rt.type="button",rt.className="inline-flex items-center justify-center rounded-lg border border-transparent px-2 py-1 text-[12px] text-rose-500 hover:text-rose-700",rt.innerHTML="\u{1F5D1}\uFE0F",rt.addEventListener("click",be=>{be.stopPropagation(),Ns(s.id)}),St.appendChild(rt),v.appendChild(St),v.addEventListener("click",()=>{Je(s.id)}),v.addEventListener("keydown",be=>{(be.key==="Enter"||be.key===" ")&&(be.preventDefault(),Je(s.id))}),u.appendChild(v)})},$t=(e,t)=>{n.forEach(s=>{s.innerHTML="",e.forEach(a=>{let v=document.createElement("li"),k=document.createElement("button");k.type="button",k.dataset.pageId=a.id,k.className=["w-full flex items-center justify-between gap-3 px-3 py-2 text-left transition",t===a.id?"bg-[#9C6BFF]/10 text-slate-900 border border-[#9C6BFF]/40 rounded-xl shadow-sm":"text-slate-700 hover:bg-slate-50 rounded-xl"].join(" "),t===a.id?k.setAttribute("aria-current","page"):k.removeAttribute("aria-current"),k.innerHTML=`
            <div class="flex items-center gap-3">
              <span class="flex h-9 w-9 items-center justify-center rounded-xl border border-slate-200 bg-white text-slate-500">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6.5 4.5h7l4 4v11a1 1 0 0 1-1 1h-10a1 1 0 0 1-1-1v-14a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
                  <path d="M13.5 4.5v4a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.4"/>
                </svg>
              </span>
              <div class="flex flex-col">
                <span class="text-sm font-semibold">${a.title}</span>
                <span class="text-xs text-slate-500">${a.slug}</span>
              </div>
            </div>
          `,k.addEventListener("click",()=>{Ne(a.id),Pt()||Mt()}),v.appendChild(k),s.appendChild(v)})})},Ft=()=>!T||!Array.isArray(T.blocks)?null:T.blocks.find(e=>e.id===de)||null,Je=e=>{if(!T)return;if(!e){de=null,Qe(T),ht(null),Ze(null);return}let t=T.blocks.find(s=>s.id===e)||T.blocks[0]||null;de=(t==null?void 0:t.id)||null,Qe(T),ht(t),Ze(de)},et=e=>{if(!T)return;let t={...T,blocks:e};Ps(t)},yt=()=>window.matchMedia("(min-width: 1024px)").matches;function es(e,t){if(!T||!e||!t)return;let s=[...T.blocks||[]],a=s.findIndex(_=>_.id===e);if(a<0)return;let v=a+t;if(v<0||v>=s.length)return;let[k]=s.splice(a,1);s.splice(v,0,k),et(s),Ne(T.id,{preserveBlock:!0}),Je(k.id)}function Ts(e,t){if(!T||!e||!t||e===t)return;let s=[...T.blocks||[]],a=s.findIndex(_=>_.id===e),v=s.findIndex(_=>_.id===t);if(a<0||v<0)return;let[k]=s.splice(a,1);s.splice(v,0,k),et(s),Ne(T.id,{preserveBlock:!0}),Je(k.id)}function ts(){if(!u)return;let e=yt();u.querySelectorAll("[data-block-item]").forEach(t=>{t.setAttribute("draggable",e?"true":"false")})}function vt(){q&&(q.classList.add("hidden"),tt=!1)}function js(){q&&(q.classList.remove("hidden"),tt=!0)}function $s(){tt?vt():js()}function Fs(e){var k;if(!T||!e)return;let t=ne[e];if(!t)return;let s=(T.blocks||[]).filter(_=>_.type===t.type).length+1,a=R(Ve(T.id,e),`${t.label} ${s}`,t.type,t.status,t.description,t.props,t.settings||{});if((t.type||"").toLowerCase()==="collectiongrid"){let _=((k=Ce[0])==null?void 0:k.id)||"";a.collectionId=_,a.settings.collectionId=_,a.settings.limit=a.settings.limit||6}let v=[...T.blocks||[],a];et(v),Ne(T.id,{preserveBlock:!0}),Je(a.id),vt(),H("Bloc ajout\xE9")}function ss(e){var a,v;if(!T)return;let t=(T.blocks||[]).filter(k=>k.id!==e),s=e===de?((a=t[0])==null?void 0:a.id)||null:de||((v=t[0])==null?void 0:v.id)||null;et(t),de=s,Ne(T.id,{preserveBlock:!0}),de?Je(de):(ht(null),Ze(null)),H("Bloc supprim\xE9")}function Nt(){d&&(d.classList.add("hidden"),d.classList.remove("flex"),xt=null)}function Ns(e){if(!d){ss(e);return}xt=e,d.classList.remove("hidden"),d.classList.add("flex")}let Ps=e=>{if(!e)return;let t=nt(e);ce=ce.map(s=>s.id===t.id?t:s),T=t,te(t)},Ne=(e,t={})=>{var v,k;let s=ce.find(_=>_.id===e)||ce[0]||null;T=s?nt(s):null,Le=(s==null?void 0:s.id)||null,(!t.preserveBlock||!T||!T.blocks.some(_=>_.id===de))&&(de=((k=(v=T==null?void 0:T.blocks)==null?void 0:v[0])==null?void 0:k.id)||null),Le&&Ke(Le),$t(ce,Le),gt(T),As(T),je(T),Qe(T),ht(Ft()),Ze(de),ts(),tt&&vt()},Pt=()=>window.matchMedia("(min-width: 1024px)").matches,ns=()=>{ve&&(Pt()?(ve.classList.add("is-open"),ae==null||ae.classList.add("hidden"),document.body.classList.remove("overflow-hidden")):ve.classList.remove("is-open"))},Ms=()=>{!ve||Pt()||(ve.classList.add("is-open"),ae==null||ae.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},Mt=()=>{ve&&(ve.classList.remove("is-open"),ae==null||ae.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))},Ds=()=>{!re||!pe||(re.classList.remove("hidden"),pe.classList.add("hidden"),E&&(E.textContent=""),bt=!1,r&&(r.value="",r.focus()),m&&(m.value=""))},os=()=>{!re||!pe||(re.classList.add("hidden"),pe.classList.remove("hidden"),E&&(E.textContent=""),bt=!1,re.reset())},Rs=()=>{!r||!m||bt&&m.value.trim().length>0||(m.value=Xe(r.value))},ce=[],Le=null,bt=!1,T=null,de=null,tt=!1,xt=null,Dt="",Rt=!1,st=null,Ce=[],Us=e=>{let t={...e,props:Array.isArray(e.props)?e.props:[],settings:{...e.settings||{}}};return(t.type||"").toLowerCase()==="collectiongrid"&&(t.collectionId=t.collectionId||t.settings.collectionId||"",t.settings.collectionId=t.collectionId,t.settings.limit=t.settings.limit||6),t},nt=e=>({...e,blocks:(e.blocks||[]).map(t=>Us(t))}),Hs=async()=>{if(!g){Ce=[],wt();return}try{let e=await fetch(g,{headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Impossible de charger les collections.");let t=await e.json().catch(()=>[]);Ce=Array.isArray(t)?t:[];let s=(L==null?void 0:L.value)||"";wt(s)}catch(e){console.error("[design] collections load",e),H("Collections indisponibles."),Ce=[],wt()}},Ut=e=>{if(!p)return;if(!e){p.textContent=Ce.length?"S\xE9lectionnez une collection pour afficher ses informations.":"Aucune collection disponible. Ajoutez-en depuis l\u2019onglet Contenus.";return}let t=Ce.find(a=>a.id===e);if(!t){p.textContent=`Collection ${e}`;return}let s=[];t.description&&s.push(t.description),t.type&&s.push(`Type\xA0: ${t.type}`),p.textContent=s.join(" \xB7 ")||`Collection ${t.name||t.id}`},wt=(e="")=>{if(L){if(L.innerHTML="",!Ce.length){L.disabled=!0;let t=document.createElement("option");t.value="",t.textContent="Aucune collection disponible",L.appendChild(t),Ut("");return}if(L.disabled=!1,e&&!Ce.some(t=>t.id===e)){let t=document.createElement("option");t.value=e,t.textContent=e,L.appendChild(t)}Ce.forEach(t=>{let s=document.createElement("option");s.value=t.id;let a=t.name||t.id;s.textContent=t.type?`${a} \xB7 ${t.type}`:a,s.dataset.description=t.description||"",L.appendChild(s)}),e&&(L.value=e),Ut(L.value||"")}};Hs(),ns(),ze.forEach(e=>{e.addEventListener("click",Ms)}),$e.forEach(e=>{e.addEventListener("click",Mt)}),ae==null||ae.addEventListener("click",Mt),window.addEventListener("resize",()=>{ns(),ts()}),pe==null||pe.addEventListener("click",Ds),D==null||D.addEventListener("click",os),r==null||r.addEventListener("input",Rs),m==null||m.addEventListener("input",()=>{E&&(E.textContent=""),bt=!0}),re==null||re.addEventListener("submit",async e=>{if(e.preventDefault(),!o){E&&(E.textContent="Aucun site s\xE9lectionn\xE9.");return}if(!r||!m)return;let t=r.value.trim(),s=Xe(m.value.trim()||t);if(!t||!s){E&&(E.textContent="Titre et slug sont requis.");return}E&&(E.textContent=""),fe&&(fe.disabled=!0,fe.textContent="Cr\xE9ation...");try{let a=await oe({title:t,slug:s});if(!a||!a.id)throw new Error("R\xE9ponse invalide.");ce=[...ce,nt(a)],os(),H("Page cr\xE9\xE9e"),Ne(a.id)}catch(a){console.error("[design] create page failed",a),E&&(E.textContent=a.message||"Impossible de cr\xE9er la page.")}finally{fe&&(fe.disabled=!1,fe.textContent="Cr\xE9er")}}),j==null||j.addEventListener("click",e=>{e.stopPropagation(),$s()}),document.addEventListener("click",e=>{tt&&(q!=null&&q.contains(e.target)||j!=null&&j.contains(e.target)||vt())}),S.forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();let s=e.dataset.blockAdd;Fs(s)})}),z==null||z.addEventListener("click",()=>{Nt()}),P==null||P.addEventListener("click",()=>{xt&&ss(xt),Nt()}),d==null||d.addEventListener("click",e=>{e.target===d&&Nt()}),f==null||f.addEventListener("input",e=>{var s,a;let t=e.target;if(!(!t||!t.name)&&(t.name==="group-columns-mobile"||t.name==="group-columns-desktop")){let v=((s=f.querySelector('[name="group-columns-mobile"]'))==null?void 0:s.value)||"1",k=((a=f.querySelector('[name="group-columns-desktop"]'))==null?void 0:a.value)||"3";K(v,k)}}),L==null||L.addEventListener("change",e=>{let t=e.target;Ut((t==null?void 0:t.value)||"")}),f==null||f.addEventListener("submit",Me),y==null||y.addEventListener("click",e=>{e.preventDefault();let t=Ft();t&&Se(t)}),w==null||w.addEventListener("load",()=>{Rt=!0,Z("\xC0 jour"),Ze(de)}),x==null||x.addEventListener("click",()=>{let e=window.open("","_blank");if(!e)return;e.opener=null;let t=e.document;t.open(),t.write(Dt||se()),t.close()});let zs=e=>{let t=e.target.closest("[data-block-item]");!t||!yt()||(Ae=t.dataset.blockId||null,Ae&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",Ae),t.classList.add("opacity-50")))},as=()=>{u==null||u.querySelectorAll("[data-block-item]").forEach(e=>e.classList.remove("opacity-50","ring-2","ring-[#9C6BFF]/50"))},Os=()=>{Ae=null,as()},Vs=e=>{if(!Ae||!yt())return;let t=e.target.closest("[data-block-item]");!t||t.dataset.blockId===Ae||(e.preventDefault(),t.classList.add("ring-2","ring-[#9C6BFF]/50"))},Js=e=>{let t=e.target.closest("[data-block-item]");t&&t.classList.remove("ring-2","ring-[#9C6BFF]/50")},Ws=e=>{if(!Ae||!yt())return;e.preventDefault();let t=e.target.closest("[data-block-item]"),s=Ae;Ae=null,as();let a=(t==null?void 0:t.dataset.blockId)||null;a&&Ts(s,a)},Ae=null;u==null||u.addEventListener("dragstart",zs),u==null||u.addEventListener("dragend",Os),u==null||u.addEventListener("dragover",Vs),u==null||u.addEventListener("dragleave",Js),u==null||u.addEventListener("drop",Ws),he()}function Es(){var Oe,ft,De;let n=document.querySelector("[data-collection-list]");if(!n)return;let i=document.querySelector("[data-collection-empty]"),b=document.querySelector("[data-collection-items-empty]"),h=document.querySelector("[data-item-table-wrapper]"),w=document.querySelector("[data-item-table-body]"),x=document.querySelector("[data-collection-title]"),N=document.querySelector("[data-collection-description]"),F=document.querySelector("[data-collection-drawer]"),u=document.querySelector("[data-collection-drawer-backdrop]"),V=document.querySelectorAll("[data-collection-drawer-open]"),J=document.querySelectorAll("[data-collection-drawer-close]"),j=document.querySelector("[data-item-add]"),q=document.querySelector("[data-item-detail-empty]"),S=document.querySelector("[data-item-form]"),d=S?{title:S.querySelector('[name="item-title"]'),slug:S.querySelector('[name="item-slug"]'),excerpt:S.querySelector('[name="item-excerpt"]'),content:S.querySelector('[name="item-content"]'),image:S.querySelector('[name="item-image"]'),status:S.querySelector('[name="item-status"]')}:{},P=document.querySelector("[data-item-status-badge]"),z=document.querySelector("[data-item-delete]"),I=document.querySelector("[data-item-delete-modal]"),W=document.querySelector("[data-item-delete-cancel]"),$=document.querySelector("[data-item-delete-confirm]"),Q=document.querySelector("[data-item-cancel]"),O=document.querySelector("[data-item-save]"),M="rounded-full px-3 py-1 text-xs font-semibold",f=ke((G==null?void 0:G.slugValue)||Y.slug||""),U=f?`/api/sites/${encodeURIComponent(f)}/collections`:null,L=[],p=[],y=null,A=null,l=!1,c=!1,C=null,K=()=>{F&&(F.classList.add("is-open"),F.style.transform="translateX(0)",u==null||u.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},ee=()=>{F&&(F.classList.remove("is-open"),F.style.transform="",u==null||u.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))};V.forEach(o=>{o.addEventListener("click",K)}),J.forEach(o=>{o.addEventListener("click",ee)}),u==null||u.addEventListener("click",ee);let oe=o=>{let g=(o||"").trim();if(!g)return"";if(g==="/")return"/";let R=g.replace(/^\//,"").split("/").map(ne=>_e(ne||"")).filter(ne=>ne.length>0);return R.length?`/${R.join("/")}`:""},te=o=>{if(!o)return"\u2014";let g=new Date(o);return Number.isNaN(g.getTime())?"\u2014":g.toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"})},he=()=>{let o=L.find(g=>g.id===y);x&&(x.textContent=(o==null?void 0:o.name)||"S\xE9lectionnez une collection"),N&&(N.textContent=(o==null?void 0:o.description)||"")},Ie=o=>{b&&(b.textContent=o||(y?"Aucun item dans cette collection pour le moment.":"Choisissez une collection dans le panneau de gauche."))},ye=()=>{S&&(S.classList.add("hidden"),S.dataset.itemId=""),q==null||q.classList.remove("hidden"),P&&(P.className=`hidden ${M}`,P.textContent=""),z&&(z.disabled=!0)},Se=()=>{S&&(S.classList.remove("hidden"),q==null||q.classList.add("hidden"))},Te=()=>{j&&(j.disabled=!y,j.disabled?j.classList.add("opacity-60","pointer-events-none"):j.classList.remove("opacity-60","pointer-events-none"))},Z=o=>{if(!P)return;if(!o){P.className=`hidden ${M}`,P.textContent="";return}let g=o.toLowerCase(),B="bg-slate-100 text-slate-600 border border-slate-200";g==="publi\xE9"||g==="publie"?B="bg-emerald-50 text-emerald-700 border border-emerald-100":g==="brouillon"&&(B="bg-amber-50 text-amber-700 border border-amber-100"),P.className=`${M} ${B}`,P.textContent=o},Pe=()=>{if(n.innerHTML="",!L.length){i==null||i.classList.remove("hidden");return}i==null||i.classList.add("hidden"),L.forEach(o=>{let g=o.id===y,B=document.createElement("button");B.type="button",B.dataset.collectionId=o.id,B.className=["w-full rounded-xl border px-3 py-2 text-left transition focus:outline-none focus:ring-2 focus:ring-[#9C6BFF]/40",g?"bg-[#F7F0FF] border-[#9C6BFF]/40 text-slate-900":"border-slate-200 text-slate-700 hover:border-[#9C6BFF]/40"].join(" "),B.setAttribute("role","option"),g?B.setAttribute("aria-current","true"):B.removeAttribute("aria-current"),B.innerHTML=`
          <div class="flex items-center justify-between gap-2">
            <div>
              <p class="text-sm font-semibold">${o.name||o.id}</p>
              <p class="text-xs text-slate-500">${o.description||""}</p>
            </div>
            <span class="text-[11px] uppercase tracking-wide text-slate-400">${o.type||""}</span>
          </div>
        `,B.addEventListener("click",()=>{pe(o.id),window.matchMedia("(min-width: 1024px)").matches||ee()}),n.appendChild(B)})},se=()=>{if(w){if(w.innerHTML="",!p.length||!y){b==null||b.classList.remove("hidden"),Ie(),h==null||h.classList.add("hidden");return}b==null||b.classList.add("hidden"),h==null||h.classList.remove("hidden"),p.forEach(o=>{let g=document.createElement("tr");g.dataset.itemId=o.id;let B=o.id===A&&!l;g.className=["cursor-pointer transition focus-within:bg-[#F7F0FF]/70 focus:outline-none",B?"bg-[#F7F0FF]/70":"hover:bg-slate-50"].join(" "),g.tabIndex=0,g.setAttribute("role","button"),B?g.setAttribute("aria-current","true"):g.removeAttribute("aria-current");let R=o.status||"Brouillon",ne=R.toLowerCase(),Ke=ne==="publi\xE9"||ne==="publie"?"bg-emerald-50 text-emerald-700 border border-emerald-100":"bg-amber-50 text-amber-700 border border-amber-100";g.innerHTML=`
          <td class="px-4 py-3 align-top">
            <div class="flex flex-col">
              <span class="text-sm font-semibold text-slate-900">${o.title||"Sans titre"}</span>
              <span class="text-xs text-slate-500">${o.summary||o.excerpt||""}</span>
            </div>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-600">${o.slug||""}</td>
          <td class="px-4 py-3 align-top">
            <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${Ke}">
              ${R}
            </span>
          </td>
          <td class="px-4 py-3 align-top text-sm text-slate-500">${te(o.updatedAt||o.createdAt)}</td>
        `;let Re=()=>{je(o.id)};g.addEventListener("click",Re),g.addEventListener("keydown",Fe=>{(Fe.key==="Enter"||Fe.key===" ")&&(Fe.preventDefault(),Re())}),w.appendChild(g)})}},je=o=>{let g=p.find(B=>B.id===o);g&&(A=g.id,l=!1,c=!0,Me(g),se())},Me=o=>{if(!S||!o){ye();return}Se(),S.dataset.itemId=o.id,d.title&&(d.title.value=o.title||""),d.slug&&(d.slug.value=o.slug||""),d.excerpt&&(d.excerpt.value=o.summary||o.excerpt||""),d.content&&(d.content.value=o.content||""),d.image&&(d.image.value=o.image||""),d.status&&(d.status.value=o.status||"Brouillon"),Z(o.status||"Brouillon"),z&&(z.disabled=!1)},ve=()=>{var o;S&&(l=!0,A=null,c=!1,S.dataset.itemId="",S.reset(),d.status&&(d.status.value="Brouillon"),d.slug&&(d.slug.value=""),Z("Brouillon"),Se(),z&&(z.disabled=!0),(o=d.title)==null||o.focus())},ae=()=>{var Re,Fe,Xe,Ve,jt,gt;let o=(((Re=d.title)==null?void 0:Re.value)||"").trim(),g=(((Fe=d.slug)==null?void 0:Fe.value)||"").trim(),B=(((Xe=d.excerpt)==null?void 0:Xe.value)||"").trim(),R=(((Ve=d.content)==null?void 0:Ve.value)||"").trim(),ne=(((jt=d.image)==null?void 0:jt.value)||"").trim(),Ke=((gt=d.status)==null?void 0:gt.value)||"Brouillon";return{title:o,slug:oe(g||o),summary:B,excerpt:B,content:R,image:ne,status:Ke}},ze=o=>{O&&(O.disabled=o,O.textContent=o?"Enregistrement\u2026":"Enregistrer"),z&&!l&&A&&(z.disabled=o)},$e=async o=>{if(!U)return[];let g=await fetch(`${U}/${encodeURIComponent(o)}/items`,{headers:{Accept:"application/json"}});if(!g.ok){let R=await g.json().catch(()=>({}));throw new Error(R.message||"Impossible de charger les items.")}let B=await g.json().catch(()=>({}));return Array.isArray(B.items)?B.items:[]},pe=async o=>{if(o&&(y=o,A=null,l=!1,c=!1,he(),Te(),Pe(),ye(),p=[],se(),Ie("Chargement des items\u2026"),b==null||b.classList.remove("hidden"),h==null||h.classList.add("hidden"),!!U))try{p=await $e(o),se(),p.length||Ie()}catch(g){console.error("[content] items failed",g),H(g.message||"Impossible de charger les items."),p=[],se()}},re=async(o,g)=>{if(!U)throw new Error("Site inconnu.");let B=await fetch(`${U}/${encodeURIComponent(o)}/items`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)});if(!B.ok){let R=await B.json().catch(()=>({}));throw new Error(R.message||"Impossible de cr\xE9er cet item.")}return B.json()},r=async(o,g,B)=>{if(!U)throw new Error("Site inconnu.");let R=await fetch(`${U}/${encodeURIComponent(o)}/items/${encodeURIComponent(g)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(B)});if(!R.ok){let ne=await R.json().catch(()=>({}));throw new Error(ne.message||"Impossible de sauvegarder cet item.")}return R.json()},m=async(o,g)=>{if(!U)throw new Error("Site inconnu.");let B=await fetch(`${U}/${encodeURIComponent(o)}/items/${encodeURIComponent(g)}`,{method:"DELETE"});if(!B.ok){let R=await B.json().catch(()=>({}));throw new Error(R.message||"Impossible de supprimer cet item.")}},D=async()=>{var o;if(!U){i==null||i.classList.remove("hidden"),y=null,p=[],se(),he(),Te();return}try{let g=await fetch(U,{headers:{Accept:"application/json"}});if(!g.ok)throw new Error("Impossible de charger les collections.");let B=await g.json().catch(()=>[]);if(L=Array.isArray(B)?B:[],Pe(),L.length>0){let R=((o=L.find(ne=>ne.id===y))==null?void 0:o.id)||L[0].id;pe(R)}else y=null,p=[],he(),Te(),se()}catch(g){console.error("[content] load collections",g),H(g.message||"Impossible de charger les collections.")}};j==null||j.addEventListener("click",()=>{if(!y){H("S\xE9lectionnez d\u2019abord une collection.");return}ve(),se()}),Q==null||Q.addEventListener("click",o=>{if(o.preventDefault(),l){l=!1,A=null,ye(),se();return}if(A){let g=p.find(B=>B.id===A);Me(g)}else ye()}),(Oe=d.status)==null||Oe.addEventListener("change",()=>{Z(d.status.value)}),(ft=d.title)==null||ft.addEventListener("input",()=>{!l||!d.slug||c||(d.slug.value=oe(d.title.value))}),(De=d.slug)==null||De.addEventListener("input",()=>{l&&(c=!0)}),S==null||S.addEventListener("submit",async o=>{var B;if(o.preventDefault(),!y){H("S\xE9lectionnez une collection.");return}let g=ae();if(!g.title){H("Le titre est requis."),(B=d.title)==null||B.focus();return}ze(!0);try{let R;l||!A?(R=await re(y,g),p=[...p,R],H("Item cr\xE9\xE9")):(R=await r(y,A,g),p=p.map(ne=>ne.id===R.id?R:ne),H("Item mis \xE0 jour")),l=!1,A=R.id,Me(R),se()}catch(R){console.error("[content] save item failed",R),H(R.message||"Impossible de sauvegarder cet item.")}finally{ze(!1)}});let E=()=>{I&&(I.classList.add("hidden"),I.classList.remove("flex"),C=null)},fe=()=>{!I||!A||(C=A,I.classList.remove("hidden"),I.classList.add("flex"))};z==null||z.addEventListener("click",o=>{o.preventDefault(),A&&fe()}),W==null||W.addEventListener("click",()=>{E()}),I==null||I.addEventListener("click",o=>{o.target===I&&E()}),$==null||$.addEventListener("click",async()=>{if(!C||!y){E();return}$.disabled=!0,$.textContent="Suppression\u2026";try{await m(y,C),p=p.filter(o=>o.id!==C),A===C&&(A=null,ye()),H("Item supprim\xE9"),se()}catch(o){console.error("[content] delete item failed",o),H(o.message||"Impossible de supprimer cet item.")}finally{$.disabled=!1,$.textContent="Supprimer",E()}}),he(),Te(),D()}function qs(){let n=document.querySelector("[data-deploy-form]");if(!n)return;let i=document.querySelector("[data-deploy-protocol]"),b=document.querySelector("[data-deploy-host]"),h=document.querySelector("[data-deploy-port]"),w=document.querySelector("[data-deploy-user]"),x=document.querySelector("[data-deploy-password]"),N=document.querySelector("[data-deploy-show-password]"),F=document.querySelector("[data-deploy-remote-path]"),u=document.querySelector("[data-deploy-feedback]"),V=document.querySelector("[data-deploy-save]"),J=document.querySelector("[data-deploy-test]"),j=document.querySelector("[data-deploy-trigger]"),q=document.querySelector("[data-deploy-history]"),S=document.querySelector("[data-deploy-log]"),d=ke((G==null?void 0:G.slugValue)||Y.slug||""),P=d?`/api/sites/${encodeURIComponent(d)}/deploy-config`:null,z=d?`/api/sites/${encodeURIComponent(d)}/deploy`:null,I=d?`/api/sites/${encodeURIComponent(d)}/deploy-log`:null,W=!1,$=null,Q=l=>{let c=(l||"").trim();return c?c.startsWith("/")?c:`/${c}`:"/www"},O=(l,c="muted")=>{if(!u)return;let C="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold",K=c==="success"?"bg-emerald-50 text-emerald-700 border border-emerald-100":c==="error"?"bg-rose-50 text-rose-700 border border-rose-100":"bg-slate-50 text-slate-600 border border-slate-100";if(!l){u.textContent="",u.className="text-sm text-slate-500";return}let ee=c==="success"?"\u2705":c==="error"?"\u274C":"\u2139\uFE0F";u.innerHTML=`<span class="${C} ${K}">${ee}<span>${l}</span></span>`,u.className="text-sm"},M=(l=null)=>{$=l;let c=!!l,C='<svg class="h-4 w-4 animate-spin text-white" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>';V&&(V.disabled=c,V.innerHTML=l==="save"?`<span class="inline-flex items-center gap-2">${C}<span>Enregistrement\u2026</span></span>`:"Enregistrer"),J&&(J.disabled=c,J.innerHTML=l==="test"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-slate-200 border-t-slate-600"></span><span>Test en cours\u2026</span></span>':"Tester la connexion"),j&&(j.disabled=c&&l!==null,j.innerHTML=l==="deploy"?'<span class="inline-flex items-center gap-2"><span class="h-4 w-4 animate-spin rounded-full border-2 border-white/60 border-t-white"></span><span>D\xE9ploiement\u2026</span></span>':"D\xE9ployer maintenant")},f=l=>{i&&(i.value=l.protocol||"sftp"),b&&(b.value=l.host||""),h&&(h.value=l.port||""),w&&(w.value=l.user||""),F&&(F.value=l.remotePath||"/www"),W=!!l.hasPassword,x&&(x.value="",x.placeholder=W?"Non affich\xE9":"Mot de passe")},U=(l=[])=>{if(q){if(q.innerHTML="",!l.length){let c=document.createElement("li");c.className="text-slate-500",c.textContent="Aucun d\xE9ploiement pour le moment.",q.appendChild(c);return}l.forEach(c=>{let C=document.createElement("li");C.className="flex items-center justify-between gap-2 rounded-xl border border-slate-200 px-3 py-2";let K=c.status==="success"?'<span class="rounded-full bg-emerald-50 px-2 py-0.5 text-[11px] font-semibold text-emerald-700">Succ\xE8s</span>':'<span class="rounded-full bg-rose-50 px-2 py-0.5 text-[11px] font-semibold text-rose-700">\xC9chec</span>',ee=c.finishedAt||c.startedAt||"",oe=c.durationMs&&Number(c.durationMs)>=0?`${Math.round(Number(c.durationMs)/1e3)}s`:"";C.innerHTML=`
          <div class="space-y-1">
            <div class="flex items-center gap-2">${K}<span class="text-xs text-slate-500">${ee}</span></div>
            <p class="text-sm text-slate-800">${c.message||""}</p>
          </div>
          <div class="text-xs text-slate-500">${oe}</div>
        `,C.dataset.deployId=c.id||"",C.addEventListener("click",()=>{c.logs&&S&&(S.textContent=c.logs.join(`
`))}),q.appendChild(C)})}},L=(l=[])=>{S&&(S.textContent=l.length?l.join(`
`):"Aucun log pour le moment.")},p=async()=>{var l;if(I)try{let c=await fetch(I,{headers:{Accept:"application/json"}});if(!c.ok){if(c.status===404){U([]),L(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw new Error("Impossible de charger l\u2019historique.")}let C=await c.json().catch(()=>({})),K=Array.isArray(C.entries)?C.entries:[];U(K),(l=K[0])!=null&&l.logs&&L(K[0].logs)}catch(c){console.error("[deploy] history failed",c)}},y=async()=>{if(!P){O("Aucun site actif s\xE9lectionn\xE9.","error");return}M("load");try{let l=await fetch(P,{headers:{Accept:"application/json"}}),c=await l.json().catch(()=>({}));l.ok?(f(c||{}),O("Configuration charg\xE9e.","muted")):(f(c||{}),O(c.message||"Configuration par d\xE9faut charg\xE9e.","muted"))}catch(l){console.error("[deploy] load failed",l),O(l.message||"Erreur lors du chargement.","error")}finally{M(null)}},A=()=>{let l={protocol:(i==null?void 0:i.value)||"sftp",host:(b==null?void 0:b.value.trim())||"",port:Number(h==null?void 0:h.value)||void 0,user:(w==null?void 0:w.value.trim())||"",remotePath:Q((F==null?void 0:F.value)||"/www")},c=(x==null?void 0:x.value)||"";return c.trim().length>0&&(l.password=c),l};n.addEventListener("submit",async l=>{if(l.preventDefault(),!P){O("Aucun site actif s\xE9lectionn\xE9.","error");return}let c=A();M("save");try{let C=await fetch(P,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!C.ok){let ee=await C.json().catch(()=>({}));throw new Error(ee.message||"Sauvegarde impossible.")}let K=await C.json();f(K||{}),O("Configuration enregistr\xE9e.","success"),H("Configuration d\xE9ploiement sauvegard\xE9e")}catch(C){console.error("[deploy] save failed",C),O(C.message||"Erreur lors de la sauvegarde.","error")}finally{M(null)}}),J==null||J.addEventListener("click",async()=>{if(!P){O("Aucun site actif s\xE9lectionn\xE9.","error");return}let l=A();if(!l.host||!l.user||!l.remotePath){O("Remplissez les champs requis avant de tester.","error");return}M("test");try{let c=await fetch(`${P}/test`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}),C=await c.json().catch(()=>({}));if(!c.ok||C.success===!1){O(C.message||"Test de connexion \xE9chou\xE9.","error");return}O(C.message||"Connexion OK.","success"),H("Test de connexion r\xE9ussi")}catch(c){console.error("[deploy] test failed",c),O(c.message||"Test de connexion \xE9chou\xE9.","error")}finally{M(null)}}),j==null||j.addEventListener("click",async()=>{if(!z){O("Aucun site actif s\xE9lectionn\xE9.","error");return}M("deploy"),L(["D\xE9ploiement en cours\u2026"]);try{let l=await fetch(z,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(A())}),c=await l.json().catch(()=>({}));if(!l.ok){if(l.status===404){O("API d\xE9ploiement indisponible (red\xE9marre le serveur).","error"),L(["API d\xE9ploiement indisponible (red\xE9marre le serveur)."]);return}throw L(c.logs||[]),new Error(c.message||"D\xE9ploiement \xE9chou\xE9.")}L(c.logs||[]),await p(),H("D\xE9ploiement termin\xE9")}catch(l){console.error("[deploy] run failed",l),O(l.message||"D\xE9ploiement \xE9chou\xE9.","error")}finally{M(null)}}),N==null||N.addEventListener("change",()=>{x&&(x.type=N.checked?"text":"password")}),y(),p()}function ks(){let n=document.querySelector("[data-admin-password-form]"),i=document.querySelector("[data-site-config-form]"),b=document.querySelector("[data-site-config-feedback]");if(n){let h=n.querySelector("[data-admin-password-feedback]"),w=n.querySelector("[data-admin-password-submit]"),x=(N,F="muted")=>{if(!h)return;let u=F==="success"?"text-emerald-600":F==="error"?"text-rose-600":"text-slate-500";h.textContent=N||"",h.className=`text-sm ${u}`};n.addEventListener("submit",async N=>{N.preventDefault();let F=new FormData(n),u=F.get("currentPassword")||"",V=F.get("newPassword")||"",J=F.get("confirmPassword")||"";if(!u||!V||!J){x("Compl\xE8te tous les champs.","error");return}w&&(w.disabled=!0),x("");try{let j=await fetch("/api/admin/password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({currentPassword:u,newPassword:V,confirmPassword:J})}),q=await j.json().catch(()=>({}));if(!j.ok||q.success===!1)throw new Error(q.message||"Impossible de mettre \xE0 jour le mot de passe.");x(q.message||"Mot de passe mis \xE0 jour.","success"),n.reset()}catch(j){console.error("[settings] change password failed",j),x(j.message||"Erreur lors de la mise \xE0 jour.","error")}finally{w&&(w.disabled=!1)}})}if(i){let h=i.querySelector("[data-site-name]"),w=i.querySelector("[data-site-language]"),x=i.querySelector("[data-site-tagline]"),N=i.querySelector("[data-site-save]"),F=(p,y="muted")=>{if(!b)return;let A=y==="success"?"text-emerald-600":y==="error"?"text-rose-600":"text-slate-500";b.textContent=p||"",b.className=`text-sm ${A}`},u=ke((G==null?void 0:G.slugValue)||Y.slug||""),V=u?`/api/sites/${encodeURIComponent(u)}/config/site`:null,J=u?`/api/sites/${encodeURIComponent(u)}/config/theme`:null,j=async()=>{if(V)try{let p=await fetch(V,{headers:{Accept:"application/json"}});if(!p.ok)return;let y=await p.json().catch(()=>({}));h&&(h.value=y.name||""),w&&(w.value=y.language||"fr"),x&&(x.value=y.tagline||"")}catch(p){console.error("[settings] load site config failed",p)}};i.addEventListener("submit",async p=>{if(p.preventDefault(),!V){F("Aucun site actif.","error");return}if(!(h!=null&&h.value.trim())){F("Nom requis.","error");return}N&&(N.disabled=!0),F("");try{let y={name:(h==null?void 0:h.value)||"",language:(w==null?void 0:w.value)||"fr",tagline:(x==null?void 0:x.value)||""},A=await fetch(V,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(y)}),l=await A.json().catch(()=>({}));if(!A.ok||l.success===!1)throw new Error(l.message||"Sauvegarde impossible.");F(l.message||"Param\xE8tres enregistr\xE9s.","success")}catch(y){console.error("[settings] save site config failed",y),F(y.message||"Erreur lors de la sauvegarde.","error")}finally{N&&(N.disabled=!1)}}),j();let q={primary:i.querySelector("[data-theme-primary]"),secondary:i.querySelector("[data-theme-secondary]"),accent:i.querySelector("[data-theme-accent]")},S={primary:i.querySelector("[data-theme-primary-hex]"),secondary:i.querySelector("[data-theme-secondary-hex]"),accent:i.querySelector("[data-theme-accent-hex]")},d=i.querySelector("[data-theme-headings]"),P=i.querySelector("[data-theme-body]"),z=i.querySelector("[data-theme-radius-small]"),I=i.querySelector("[data-theme-radius-medium]"),W=i.querySelector("[data-theme-radius-large]"),$=i.querySelector("[data-theme-preview]"),Q=i.querySelector("[data-theme-feedback]"),O=i.querySelector("[data-theme-apply]"),M=(p,y="muted")=>{if(!Q)return;let A=y==="success"?"text-emerald-600":y==="error"?"text-rose-600":"text-slate-500";Q.textContent=p||"",Q.className=`text-sm ${A}`},f=()=>{var y,A,l;if(!$)return;let p={primary:((y=S.primary)==null?void 0:y.value)||"#9C6BFF",secondary:((A=S.secondary)==null?void 0:A.value)||"#0EA5E9",accent:((l=S.accent)==null?void 0:l.value)||"#F97316"};$.style.setProperty("--color-primary",p.primary),$.style.setProperty("--color-secondary",p.secondary),$.style.setProperty("--color-accent",p.accent),$.style.setProperty("--font-headings",(d==null?void 0:d.value)||"Inter, sans-serif"),$.style.setProperty("--font-body",(P==null?void 0:P.value)||"Inter, sans-serif"),$.style.setProperty("--radius-small",(z==null?void 0:z.value)||"8px"),$.style.setProperty("--radius-medium",(I==null?void 0:I.value)||"16px"),$.style.setProperty("--radius-large",(W==null?void 0:W.value)||"24px"),$.style.borderRadius=(I==null?void 0:I.value)||"16px"},U=(p,y)=>{q[p]&&(q[p].value=y),S[p]&&(S[p].value=y)};Object.keys(q).forEach(p=>{var y,A;(y=q[p])==null||y.addEventListener("input",()=>{let l=q[p].value;S[p]&&(S[p].value=l),f()}),(A=S[p])==null||A.addEventListener("input",()=>{let l=S[p].value;q[p]&&(q[p].value=l),f()})}),[d,P,z,I,W].forEach(p=>{p==null||p.addEventListener("change",f)});let L=async()=>{var p,y,A,l,c,C,K,ee;if(J)try{let oe=await fetch(J,{headers:{Accept:"application/json"}});if(!oe.ok)return;let te=await oe.json().catch(()=>({}));U("primary",((p=te.colors)==null?void 0:p.primary)||"#9C6BFF"),U("secondary",((y=te.colors)==null?void 0:y.secondary)||"#0EA5E9"),U("accent",((A=te.colors)==null?void 0:A.accent)||"#F97316"),d&&(d.value=((l=te.typography)==null?void 0:l.headings)||"Inter, sans-serif"),P&&(P.value=((c=te.typography)==null?void 0:c.body)||"Inter, sans-serif"),z&&(z.value=((C=te.radius)==null?void 0:C.small)||"8px"),I&&(I.value=((K=te.radius)==null?void 0:K.medium)||"16px"),W&&(W.value=((ee=te.radius)==null?void 0:ee.large)||"24px"),f()}catch(oe){console.error("[settings] load theme failed",oe)}};i.addEventListener("submit",async p=>{}),O==null||O.addEventListener("click",async p=>{var A,l,c;if(p.preventDefault(),!J){M("Aucun site actif.","error");return}let y={colors:{primary:((A=S.primary)==null?void 0:A.value)||"#9C6BFF",secondary:((l=S.secondary)==null?void 0:l.value)||"#0EA5E9",accent:((c=S.accent)==null?void 0:c.value)||"#F97316"},typography:{headings:(d==null?void 0:d.value)||"Inter, sans-serif",body:(P==null?void 0:P.value)||"Inter, sans-serif"},radius:{small:(z==null?void 0:z.value)||"8px",medium:(I==null?void 0:I.value)||"16px",large:(W==null?void 0:W.value)||"24px"}};O.disabled=!0,M("");try{let C=await fetch(J,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(y)}),K=await C.json().catch(()=>({}));if(!C.ok||K.success===!1)throw new Error(K.message||"Application du th\xE8me \xE9chou\xE9e.");M(K.message||"Th\xE8me appliqu\xE9.","success"),f()}catch(C){console.error("[settings] apply theme failed",C),M(C.message||"Erreur lors de l\u2019application du th\xE8me.","error")}finally{O.disabled=!1}}),L(),f()}}function Is(){let n=document.querySelector("[data-media-grid]");if(!n)return;let i=document.querySelector("[data-media-empty]"),b=document.querySelector("[data-media-count]"),h=document.querySelector("[data-media-filter-type]"),w=document.querySelector("[data-media-detail-empty]"),x=document.querySelector("[data-media-detail]"),N=document.querySelector("[data-media-detail-preview]"),F=document.querySelector("[data-media-detail-name]"),u=document.querySelector("[data-media-detail-type]"),V=document.querySelector("[data-media-detail-size]"),J=document.querySelector("[data-media-detail-path]"),j=document.querySelector("[data-media-detail-used]"),q=document.querySelector("[data-media-alt-edit]"),S=document.querySelector("[data-media-save]"),d=document.querySelector("[data-media-delete]"),P=document.querySelector("[data-media-delete-modal]"),z=document.querySelector("[data-media-delete-cancel]"),I=document.querySelector("[data-media-delete-confirm]"),W=document.querySelector("[data-media-upload-open]"),$=document.querySelector("[data-media-file-input]"),Q=document.querySelector("[data-media-upload-status]"),O=ke((G==null?void 0:G.slugValue)||Y.slug||""),M=O?`/api/sites/${encodeURIComponent(O)}/media`:null,f=[],U=[],L=null,p=null,y=null,A=!1,l=!1,c=!1,C=null,K=r=>{let m=(r.type||"").toLowerCase(),D=(r.filename||"").toLowerCase();return m.includes("image")||/\.(png|jpe?g|webp|svg|gif)$/i.test(D)?"image":m.includes("pdf")||m.includes("doc")||/\.(pdf|docx?)$/i.test(D)?"document":m.includes("video")||/\.(mp4|mov|webm)$/i.test(D)?"video":"other"},ee=r=>K(r)==="image",oe=r=>{if(r.type)return r.type.toUpperCase();let m=(r.filename||"").split(".").pop();return m?m.toUpperCase():"FILE"},te=r=>!r||r<=0?"\u2014":r<1024?`${r} o`:r<1024*1024?`${(r/1024).toFixed(1)} ko`:`${(r/(1024*1024)).toFixed(1)} Mo`,he=()=>{x==null||x.classList.add("hidden"),w==null||w.classList.remove("hidden"),Ie(),L=null,l=!1,Z(!1),N&&(N.innerHTML='<span class="text-slate-400 text-sm">Aucun m\xE9dia s\xE9lectionn\xE9</span>'),F&&(F.textContent=""),u&&(u.textContent=""),V&&(V.textContent=""),q&&(q.value=""),J&&(J.textContent=""),j&&(j.innerHTML="")},Ie=()=>{y=null,c=!1,A=!1,C&&(URL.revokeObjectURL(C),C=null),Q&&(Q.textContent="Aucun fichier s\xE9lectionn\xE9."),$&&($.value="")},ye=()=>{b&&(U.length?U.length===1?b.textContent="1 m\xE9dia":b.textContent=`${U.length} m\xE9dias`:b.textContent="0 m\xE9dia")},Se=()=>{if(n.innerHTML="",!U.length){i==null||i.classList.remove("hidden"),he();return}i==null||i.classList.add("hidden"),U.forEach(r=>{let m=document.createElement("button");m.type="button",m.dataset.mediaId=r.id;let D=r.id===L;m.className=["group relative flex flex-col rounded-2xl border px-3 py-3 text-left transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#9C6BFF]",D?"border-[#9C6BFF] bg-[#F7F0FF]/60 shadow-sm":"border-slate-200 hover:border-[#9C6BFF]/40"].join(" ");let E=ee(r)?`<img src="${r.path}" alt="${r.alt||r.filename}" class="h-full w-full object-cover" />`:'<div class="flex h-full w-full items-center justify-center text-3xl text-slate-400">\u{1F4C4}</div>';m.innerHTML=`
          <div class="relative aspect-[4/3] overflow-hidden rounded-xl bg-slate-100">
            ${E}
          </div>
          <div class="mt-2 space-y-1">
            <p class="text-sm font-semibold text-slate-900 truncate">${r.filename}</p>
            <p class="text-xs text-slate-500">
              ${oe(r)} \xB7 ${te(r.size)}
            </p>
          </div>
        `,r.id===p&&(m.classList.add("ring-2","ring-[#9C6BFF]"),window.setTimeout(()=>{m.classList.remove("ring-2","ring-[#9C6BFF]")},1600)),m.addEventListener("click",()=>Pe(r.id)),n.appendChild(m)}),p=null},Te=r=>{if(j){if(j.innerHTML="",!r.usedIn||r.usedIn.length===0){let m=document.createElement("li");m.textContent="Non utilis\xE9",m.className="text-xs text-slate-400",j.appendChild(m);return}r.usedIn.forEach(m=>{let D=document.createElement("li");D.textContent=m,D.className="text-xs text-slate-600",j.appendChild(D)})}},Z=r=>{if(S){if(c){S.textContent=r?"T\xE9l\xE9versement\u2026":"T\xE9l\xE9verser",S.disabled=r||!y,d&&d.classList.add("hidden");return}S.textContent=r?"Enregistrement\u2026":"Enregistrer",S.disabled=r||!l,d&&(d.classList.remove("hidden"),d.disabled=!L)}},Pe=r=>{let m=f.find(D=>D.id===r);if(!m){he(),Se();return}Ie(),L=m.id,l=!1,Z(!1),Se(),w==null||w.classList.add("hidden"),x==null||x.classList.remove("hidden"),N&&(ee(m)?N.innerHTML=`<img src="${m.path}" alt="${m.alt||m.filename}" class="h-full w-full rounded-2xl object-cover" />`:N.innerHTML='<div class="flex h-full w-full flex-col items-center justify-center gap-1 text-slate-400"><span class="text-3xl">\u{1F4C4}</span><span class="text-xs font-semibold">Document</span></div>'),F&&(F.textContent=m.filename||"Fichier"),u&&(u.textContent=oe(m)),V&&(V.textContent=te(m.size)),q&&(q.value=m.alt||""),J&&(J.textContent=m.path||"\u2014"),Te(m)},se=r=>{if(r){if(c=!0,l=!1,L=null,w==null||w.classList.add("hidden"),x==null||x.classList.remove("hidden"),C&&URL.revokeObjectURL(C),C=URL.createObjectURL(r),N&&(N.innerHTML=`<img src="${C}" alt="${r.name}" class="h-full w-full rounded-2xl object-cover" />`),F&&(F.textContent=r.name),u&&(u.textContent=oe({type:r.type,filename:r.name})),V&&(V.textContent=te(r.size)),q&&!q.value.trim()&&(q.value=r.name.replace(/\.[^.]+$/,"").replace(/[-_]/g," ")),J&&(J.textContent="En attente de t\xE9l\xE9versement"),j){j.innerHTML="";let m=document.createElement("li");m.textContent="Non utilis\xE9",m.className="text-xs text-slate-400",j.appendChild(m)}Z(!1)}},je=()=>{let r=(h==null?void 0:h.value)||"all";r==="all"?U=[...f]:U=f.filter(m=>m.groupType===r),U.some(m=>m.id===L)||he(),ye(),Se()},Me=async()=>{if(!M){i==null||i.classList.remove("hidden");return}try{let r=await fetch(M,{headers:{Accept:"application/json"}});if(!r.ok)throw new Error("Impossible de charger les m\xE9dias.");let m=await r.json().catch(()=>({items:[]}));f=Array.isArray(m.items)?m.items.map(D=>({...D,groupType:K(D)})):[],je()}catch(r){console.error("[media] load failed",r),H(r.message||"Impossible de charger les m\xE9dias."),f=[],je()}};h==null||h.addEventListener("change",()=>{je()}),q==null||q.addEventListener("input",()=>{if(c){Z(!1);return}L&&(l=!0,Z(!1))});let ve=r=>{if(r){if(!r.type.startsWith("image/")){H("Seules les images sont accept\xE9es pour le moment.");return}if(r.size>4*1024*1024){H("Fichier trop volumineux (4 Mo max).");return}y=r,se(r),Q&&(Q.textContent=`${r.name} \xB7 ${te(r.size)}`)}},ae=r=>new Promise((m,D)=>{let E=new FileReader;E.onload=()=>{let fe=E.result||"",[,Oe=""]=String(fe).split(",");m(Oe)},E.onerror=()=>D(new Error("Impossible de lire ce fichier.")),E.readAsDataURL(r)}),ze=async()=>{if(!(!y||!M)){A=!0,Z(!0);try{let r=await ae(y),m={filename:y.name,type:y.type,size:y.size,alt:(q==null?void 0:q.value)||"",data:r},D=await fetch(M,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)});if(!D.ok){let fe=await D.json().catch(()=>({}));throw new Error(fe.message||"Upload impossible.")}let E=await D.json();E.groupType=K(E),f=[...f,E],p=E.id,je(),Pe(E.id),H("M\xE9dia ajout\xE9"),Ie()}catch(r){console.error("[media] upload failed",r),H(r.message||"Impossible de t\xE9l\xE9verser ce m\xE9dia.")}finally{A=!1,y=null,Z(!1)}}};W==null||W.addEventListener("click",()=>$==null?void 0:$.click()),$==null||$.addEventListener("change",()=>{$.files&&$.files[0]&&ve($.files[0])});let $e=()=>{P&&(P.classList.add("hidden"),P.classList.remove("flex"))},pe=()=>{if(!(!L||c)){if(P){P.classList.remove("hidden"),P.classList.add("flex");return}window.confirm("Supprimer ce m\xE9dia ?")&&re()}},re=async()=>{if(!L||!M){$e();return}let r=()=>{d&&(d.disabled=!0),I&&(I.disabled=!0,I.textContent="Suppression\u2026")},m=()=>{d&&(d.disabled=!1),I&&(I.disabled=!1,I.textContent="Supprimer")};r();try{let D=await fetch(`${M}/${encodeURIComponent(L)}`,{method:"DELETE"});if(!D.ok){let E=await D.json().catch(()=>({}));throw new Error(E.message||"Suppression impossible.")}f=f.filter(E=>E.id!==L),U=U.filter(E=>E.id!==L),H("M\xE9dia supprim\xE9"),he(),ye(),Se()}catch(D){console.error("[media] delete failed",D),H(D.message||"Impossible de supprimer ce m\xE9dia.")}finally{m(),$e()}};z==null||z.addEventListener("click",$e),P==null||P.addEventListener("click",r=>{r.target===P&&$e()}),I==null||I.addEventListener("click",()=>re()),d==null||d.addEventListener("click",pe),S==null||S.addEventListener("click",async()=>{if(c){ze();return}if(!(!L||!M||!q)){Z(!0);try{let r={alt:q.value||""},m=await fetch(`${M}/${encodeURIComponent(L)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!m.ok){let E=await m.json().catch(()=>({}));throw new Error(E.message||"Impossible de mettre \xE0 jour ce m\xE9dia.")}let D=await m.json();f=f.map(E=>E.id===L?{...E,...D}:E),U=U.map(E=>E.id===L?{...E,...D}:E),l=!1,Z(!1),H("M\xE9dia mis \xE0 jour")}catch(r){console.error("[media] update failed",r),H(r.message||"\xC9chec de la mise \xE0 jour."),Z(!1)}}}),Me()}});})();
