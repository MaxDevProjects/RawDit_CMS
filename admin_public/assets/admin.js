(()=>{document.addEventListener("DOMContentLoaded",()=>{console.log("[admin] Atelier charg\xE9");let Z=document.querySelector("[data-logout]");Z&&Z.addEventListener("click",async()=>{Z.disabled=!0;try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(e){console.error("[admin] Impossible de se d\xE9connecter",e)}finally{window.location.href="/admin/index.html"}});let B=document.querySelector("[data-admin-sidebar]"),g=document.querySelector("[data-admin-sidebar-overlay]"),ce=document.querySelectorAll("[data-admin-sidebar-toggle]"),Ce=document.querySelectorAll("[data-admin-sidebar-close]"),G=document.body,D=!1,$=()=>{if(!B)return;if(window.matchMedia("(min-width: 1024px)").matches){B.classList.remove("hidden"),g==null||g.classList.add("hidden"),G.classList.remove("overflow-hidden");return}D?(B.classList.remove("hidden"),g==null||g.classList.remove("hidden"),G.classList.add("overflow-hidden")):(B.classList.add("hidden"),g==null||g.classList.add("hidden"),G.classList.remove("overflow-hidden"))},Ee=()=>{D=!0,$()},Q=()=>{D=!1,$()};B&&ce.length>0&&(ce.forEach(e=>{e.addEventListener("click",Ee)}),Ce.forEach(e=>{e.addEventListener("click",Q)}),g==null||g.addEventListener("click",Q),window.addEventListener("resize",$),window.addEventListener("keydown",e=>{e.key==="Escape"&&D&&Q()}),$());let le="clower:currentSite",de="clower:currentSiteName",c={slug:null,name:""};(()=>{try{c.slug=window.localStorage.getItem(le),c.name=window.localStorage.getItem(de)||""}catch{c.slug=null,c.name=""}})();let X=document.querySelectorAll("[data-site-card]"),ke=document.querySelectorAll("[data-site-select]"),F=document.querySelector("[data-current-site-name]"),ue=document.querySelector("[data-workspace-site-name]"),me=document.querySelector("[data-workspace-back-name]"),A=document.querySelector("[data-workspace-back-modal]"),qe=document.querySelectorAll("[data-workspace-back]"),Ae=document.querySelectorAll("[data-workspace-back-cancel]"),ee=document.querySelector("[data-workspace-back-confirm]"),Te=document.querySelectorAll("[data-workspace-tab]"),te=document.querySelector("[data-site-toast]"),fe=document.querySelector("[data-site-toast-message]"),Ne=document.querySelectorAll("[data-site-create]"),u=document.querySelector("[data-site-modal]"),C=document.querySelector("[data-site-form]"),h=document.querySelector("[data-site-name]"),S=document.querySelector("[data-site-slug]"),f=document.querySelector("[data-site-slug-error]"),y=document.querySelector("[data-site-modal-error]"),Ie=document.querySelectorAll("[data-site-modal-cancel]"),P=document.querySelector("[data-site-modal-submit]"),b=je(),j=!1,z=null,se=null,Pe='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',pe=e=>{if(!u||u.classList.contains("hidden")||e.key!=="Tab")return;let s=Array.from(u.querySelectorAll(Pe)).filter(v=>!v.hasAttribute("disabled")&&!v.getAttribute("aria-hidden"));if(s.length===0)return;let a=s[0],o=s[s.length-1];e.shiftKey?document.activeElement===a&&(e.preventDefault(),o.focus()):document.activeElement===o&&(e.preventDefault(),a.focus())},ge=e=>{!te||!fe||(fe.textContent=e,te.classList.remove("hidden"),se&&clearTimeout(se),se=setTimeout(()=>{te.classList.add("hidden")},2500))},E=e=>e?e.startsWith("/")?e:`/${e}`:"",H=e=>(e==null?void 0:e.replace(/^\//,""))||"",V=(e,s)=>{let a=e?E(e):null;try{a&&(window.localStorage.setItem(le,a),c.slug=a),typeof s=="string"&&s.length>0&&(window.localStorage.setItem(de,s),c.name=s)}catch{c.slug=a||c.slug,c.name=s||c.name}},he=e=>{F&&e&&(F.textContent=e),ue&&e&&(ue.textContent=e),me&&e&&(me.textContent=e)},ne=e=>{Te.forEach(s=>{let a=s.dataset.workspaceTab;if(!a)return;if(!e){s.href="#",s.classList.add("pointer-events-none","opacity-50","text-slate-400"),s.setAttribute("aria-disabled","true");return}let o=encodeURIComponent(H(e));s.href=`/admin/site/${o}/${a}`,s.classList.remove("pointer-events-none","opacity-50","text-slate-400"),s.removeAttribute("aria-disabled")})},O=(e,s={})=>{if(!e)return;let a=E(e),o=s.siteName||c.name||(F==null?void 0:F.dataset.defaultSiteName)||"";X.forEach(r=>{let k=E(r.dataset.siteCard||"")===a,d=r.querySelector("[data-site-active-badge]");k?(r.classList.add("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),r.classList.remove("border-slate-200"),d==null||d.classList.remove("hidden"),o=r.dataset.siteName||o):(r.classList.remove("border-[#9C6BFF]","ring-2","ring-[#9C6BFF]","shadow-md"),r.classList.add("border-slate-200"),d==null||d.classList.add("hidden"))}),s.persist!==!1&&V(a,s.siteName||o);let v=s.siteName||o;he(v),ne(a)},Be=async(e,s)=>{let a=E(e);try{let o=await fetch("/api/sites/select",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slug:a})});if(!o.ok){let d=await o.json().catch(()=>({}));ge(d.message||"Impossible de s\xE9lectionner ce site.");return}let v=await o.json().catch(()=>({})),r=E(v.slug||a),m=v.name||s;V(r,m),O(r,{siteName:m,persist:!1});let k=encodeURIComponent(H(r));window.location.href=`/admin/site/${k}/design`}catch(o){console.error("[admin] Impossible de s\xE9lectionner le site",o),ge("Erreur inattendue lors de la s\xE9lection.")}},Fe=async()=>{try{let e=await fetch("/api/sites/current",{credentials:"same-origin"});if(!e.ok){e.status===404&&b&&(window.location.href="/admin/sites");return}let s=await e.json(),a=E(s.slug);V(a,s.name),O(a,{siteName:s.name,persist:!1})}catch(e){console.warn("[admin] Impossible de r\xE9cup\xE9rer le site actif",e)}};(()=>{if(c.slug){O(c.slug,{siteName:c.name,persist:!1});return}let e=document.querySelector('[data-site-card][data-site-default="true"]')||X[0];e&&O(e.dataset.siteCard,{siteName:e.dataset.siteName||"",persist:!1})})(),Fe(),b?ne(b.slugValue):c.slug&&ne(c.slug),ke.forEach(e=>{e.addEventListener("click",()=>{if(e.disabled)return;let s=e.dataset.siteSelect,a=e.dataset.siteSelectName||"Ce site";s&&(e.disabled=!0,Be(s,a).finally(()=>{e.disabled=!1}))})});let R=e=>e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),Me=e=>{let s=R(e||"");return s?`/${s}`:""},De=()=>{u&&(z=document.activeElement,u.classList.remove("hidden"),u.classList.add("flex"),j=!1,C==null||C.reset(),f&&(f.textContent=""),y&&(y.textContent=""),S&&h&&(S.value=R(h.value)),document.addEventListener("keydown",pe),window.setTimeout(()=>{h==null||h.focus()},0))},W=()=>{u&&(u.classList.add("hidden"),u.classList.remove("flex"),document.removeEventListener("keydown",pe),j=!1,C==null||C.reset(),f&&(f.textContent=""),y&&(y.textContent=""),z==null||z.focus())};Ne.forEach(e=>{e.addEventListener("click",De)}),Ie.forEach(e=>{e.addEventListener("click",W)}),u==null||u.addEventListener("click",e=>{e.target===u&&W()}),h==null||h.addEventListener("input",()=>{S&&(!j||S.value.trim().length===0)&&(S.value=R(h.value))}),S==null||S.addEventListener("input",()=>{j=!0,f&&(f.textContent="")});let $e=()=>new Set(Array.from(X).map(e=>E(e.dataset.siteCard||"")));C==null||C.addEventListener("submit",async e=>{if(e.preventDefault(),!h||!S)return;let s=(h.value||"").trim(),a=S.value||"";a||(a=s);let o=Me(a);if(!s||!o){f&&(f.textContent="Nom et slug sont requis.");return}if($e().has(o)){f&&(f.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}f&&(f.textContent=""),y&&(y.textContent=""),P&&(P.disabled=!0,P.textContent="Cr\xE9ation...");try{let r=await fetch("/api/sites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s,slug:o})});if(!r.ok){let K=await r.json().catch(()=>({})),U=K.message||"Impossible de cr\xE9er ce site.";y&&(y.textContent=U),K.field==="slug"&&f&&(f.textContent=U);return}let m=await r.json(),k=E((m==null?void 0:m.slug)||o),d=(m==null?void 0:m.name)||s;V(k,d),W();let p=encodeURIComponent(H(k));window.location.href=`/admin/site/${p}/design`}catch(r){console.error("[admin] Impossible de cr\xE9er le site",r),y&&(y.textContent="Erreur inattendue. R\xE9essaie dans un instant.")}finally{P&&(P.disabled=!1,P.textContent="Cr\xE9er")}}),window.addEventListener("keydown",e=>{e.key==="Escape"&&(u&&!u.classList.contains("hidden")&&W(),A&&!A.classList.contains("hidden")&&ve())});function je(){let e=window.location.pathname.match(/^\/admin\/site\/([^/]+)(?:\/([^/]+))?/);return e?{slugPart:decodeURIComponent(e[1]),slugValue:E(decodeURIComponent(e[1])),section:e[2]||"design"}:null}function ze(){if(!A){window.location.href="/admin/sites";return}A.classList.remove("hidden"),A.classList.add("flex")}function ve(){A&&(A.classList.add("hidden"),A.classList.remove("flex"))}qe.forEach(e=>{e.addEventListener("click",ze)}),Ae.forEach(e=>{e.addEventListener("click",ve)}),ee==null||ee.addEventListener("click",()=>{window.location.href="/admin/sites"}),(b==null?void 0:b.section)==="design"&&He(),b&&c.name&&he(c.name);function He(){let e=document.querySelectorAll("[data-page-list]");if(e.length===0)return;let s=document.querySelector("[data-active-page-title]"),a=document.querySelector("[data-active-page-slug]"),o=document.querySelector("[data-page-preview-title]"),v=document.querySelector("[data-page-preview-description]"),r=document.querySelector("[data-page-preview-tags]"),m=document.querySelector("[data-block-list]"),k=document.querySelector("[data-block-count]"),d=document.querySelector("[data-page-drawer]"),p=document.querySelector("[data-page-drawer-backdrop]"),K=document.querySelectorAll("[data-page-drawer-open]"),U=document.querySelectorAll("[data-page-drawer-close]"),I=document.querySelector("[data-add-page-toggle]"),T=document.querySelector("[data-add-page-form]"),w=document.querySelector("[data-add-page-title]"),L=document.querySelector("[data-add-page-slug]"),ae=document.querySelector("[data-add-page-cancel]"),x=document.querySelector("[data-add-page-error]"),Se=H((b==null?void 0:b.slugValue)||c.slug||"default")||"default",_={pages:`clower:pages:${Se}`,active:`clower:activePage:${Se}`},Ve=[{id:"home",title:"Accueil",slug:"/",description:"Hero immersif avec CTA, mise en avant des services et preuve sociale.",badges:["Hero","Services","CTA"],blocks:[{label:"Hero principal",type:"Hero",status:"En ligne"},{label:"Services cl\xE9s",type:"Sections",status:"En ligne"},{label:"Preuves clients",type:"Logos",status:"En ligne"}]},{id:"services",title:"Services",slug:"/services",description:"D\xE9tail des offres avec mise en page \xE9ditoriale et appels \xE0 l\u2019action.",badges:["Offres","Storytelling","CTA"],blocks:[{label:"Introduction",type:"Texte",status:"En ligne"},{label:"Offres d\xE9taill\xE9es",type:"Cards",status:"En ligne"},{label:"\xC9tudes de cas",type:"Portfolio",status:"Brouillon"}]},{id:"realisations",title:"R\xE9alisations",slug:"/realisations",description:"S\xE9lection de projets r\xE9cents avec focus sur les r\xE9sultats.",badges:["Portfolio","Stats","Confiance"],blocks:[{label:"Projets vedettes",type:"Grid",status:"En ligne"},{label:"Chiffres cl\xE9s",type:"Stats",status:"En ligne"},{label:"Avis clients",type:"Quotes",status:"Brouillon"}]},{id:"contact",title:"Contact",slug:"/contact",description:"Formulaire de prise de contact simple et acc\xE8s aux coordonn\xE9es.",badges:["Formulaire","CTA","Infos"],blocks:[{label:"Header court",type:"Texte",status:"En ligne"},{label:"Formulaire",type:"Form",status:"En ligne"},{label:"Coordonn\xE9es",type:"Infos",status:"En ligne"}]}],ye=t=>t.map(n=>({...n,badges:[...n.badges||[]],blocks:[...n.blocks||[]]})),Oe=()=>{try{let t=window.localStorage.getItem(_.pages);if(t){let n=JSON.parse(t);if(Array.isArray(n))return ye(n)}}catch{}return ye(Ve)},Re=t=>{try{window.localStorage.setItem(_.pages,JSON.stringify(t))}catch{}},We=t=>{try{window.localStorage.setItem(_.active,t)}catch{}},Ke=t=>{var n;try{let i=window.localStorage.getItem(_.active);if(i&&t.some(l=>l.id===i))return i}catch{}return((n=t[0])==null?void 0:n.id)||null},Ue=t=>!t||t<=0?"0 bloc":t===1?"1 bloc":`${t} blocs`,be=t=>{if(!t||t==="/")return"/";let n=R(t.replace(/^\//,""));return n?`/${n}`:"/"},_e=t=>{s&&(s.textContent=(t==null?void 0:t.title)||"Page"),a&&(a.textContent=(t==null?void 0:t.slug)||"/")},Je=t=>{t&&(o&&(o.textContent=t.title),v&&(v.textContent=t.description||"S\xE9lectionnez une page pour afficher son aper\xE7u."),r&&(r.innerHTML="",(t.badges&&t.badges.length>0?t.badges:["Aucun bloc"]).forEach(i=>{let l=document.createElement("span");l.className="rounded-full bg-slate-100 px-3 py-1",l.textContent=i,r.appendChild(l)})))},Ye=t=>{if(!m)return;m.innerHTML="";let n=(t==null?void 0:t.blocks)||[];if(n.length===0){let i=document.createElement("p");i.className="text-sm text-slate-600",i.textContent="Aucun bloc pour cette page.",m.appendChild(i)}else n.forEach(i=>{let l=document.createElement("div");l.className="flex items-start gap-3 rounded-xl border border-slate-200 bg-white px-3 py-2 shadow-sm hover:border-[#9C6BFF]/50",l.innerHTML=`
            <div class="mt-1 h-2 w-2 rounded-full bg-[#9C6BFF]"></div>
            <div class="flex-1">
              <p class="text-sm font-semibold text-slate-900">${i.label}</p>
              <p class="text-xs text-slate-500">${i.type}</p>
            </div>
            <span class="rounded-full bg-emerald-50 px-2.5 py-1 text-[11px] font-semibold text-emerald-700">${i.status}</span>
          `,m.appendChild(l)});k&&(k.textContent=Ue(n.length))},we=(t,n)=>{e.forEach(i=>{i.innerHTML="",t.forEach(l=>{let Y=document.createElement("li"),N=document.createElement("button");N.type="button",N.dataset.pageId=l.id,N.className=["w-full flex items-center justify-between gap-3 px-3 py-2 text-left transition",n===l.id?"bg-[#9C6BFF]/10 text-slate-900 border border-[#9C6BFF]/40 rounded-xl shadow-sm":"text-slate-700 hover:bg-slate-50 rounded-xl"].join(" "),n===l.id?N.setAttribute("aria-current","page"):N.removeAttribute("aria-current"),N.innerHTML=`
            <div class="flex items-center gap-3">
              <span class="flex h-9 w-9 items-center justify-center rounded-xl border border-slate-200 bg-white text-slate-500">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6.5 4.5h7l4 4v11a1 1 0 0 1-1 1h-10a1 1 0 0 1-1-1v-14a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
                  <path d="M13.5 4.5v4a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.4"/>
                </svg>
              </span>
              <div class="flex flex-col">
                <span class="text-sm font-semibold">${l.title}</span>
                <span class="text-xs text-slate-500">${l.slug}</span>
              </div>
            </div>
          `,N.addEventListener("click",()=>{oe(l.id),ie()||re()}),Y.appendChild(N),i.appendChild(Y)})})},oe=t=>{let n=q.find(i=>i.id===t)||q[0];M=(n==null?void 0:n.id)||null,We(M||""),we(q,M),_e(n),Je(n),Ye(n)},ie=()=>window.matchMedia("(min-width: 1024px)").matches,Le=()=>{d&&(ie()?(d.classList.add("is-open"),p==null||p.classList.add("hidden"),document.body.classList.remove("overflow-hidden")):d.classList.remove("is-open"))},Ze=()=>{!d||ie()||(d.classList.add("is-open"),p==null||p.classList.remove("hidden"),document.body.classList.add("overflow-hidden"))},re=()=>{d&&(d.classList.remove("is-open"),p==null||p.classList.add("hidden"),document.body.classList.remove("overflow-hidden"))},Ge=()=>{!T||!I||(T.classList.remove("hidden"),I.classList.add("hidden"),x&&(x.textContent=""),J=!1,w&&(w.value="",w.focus()),L&&(L.value=""))},xe=()=>{!T||!I||(T.classList.add("hidden"),I.classList.remove("hidden"),x&&(x.textContent=""),J=!1,T.reset())},Qe=()=>{!w||!L||J&&L.value.trim().length>0||(L.value=be(w.value))},q=Oe(),M=Ke(q),J=!1;we(q,M),oe(M),Le(),K.forEach(t=>{t.addEventListener("click",Ze)}),U.forEach(t=>{t.addEventListener("click",re)}),p==null||p.addEventListener("click",re),window.addEventListener("resize",Le),I==null||I.addEventListener("click",Ge),ae==null||ae.addEventListener("click",xe),w==null||w.addEventListener("input",Qe),L==null||L.addEventListener("input",()=>{x&&(x.textContent=""),J=!0}),T==null||T.addEventListener("submit",t=>{if(t.preventDefault(),!w||!L)return;let n=w.value.trim(),i=be(L.value.trim()||n);if(!n||!i){x&&(x.textContent="Titre et slug sont requis.");return}if(q.some(Y=>Y.slug===i)){x&&(x.textContent="Ce slug est d\xE9j\xE0 utilis\xE9.");return}let l={id:`${Date.now()}`,title:n,slug:i,description:`Nouvelle page "${n}" pr\xEAte \xE0 \xEAtre maquett\xE9e.`,badges:["Layout","Texte"],blocks:[{label:"Introduction",type:"Texte",status:"Brouillon"},{label:"Zone de contenu",type:"Section",status:"Brouillon"}]};q=[...q,l],Re(q),xe(),oe(l.id)})}});})();
