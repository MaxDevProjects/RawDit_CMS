<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {% set seoTitle = page.seo.title if page.seo and page.seo.title else page.title %}
    {% set seoDescription = page.seo.description if page.seo and page.seo.description else '' %}
    <title>{{ seoTitle or 'Page' }} – {{ site.title or 'Site' }}</title>
    {% if seoDescription %}
    <meta name="description" content="{{ seoDescription }}" />
    {% endif %}
    {# US9.B1 - noindex meta for non-indexed pages #}
    {% set globalIndexDefault = site.seo.indexAllPagesByDefault if site.seo and site.seo.indexAllPagesByDefault is defined else true %}
    {% set pageIndexed = page.seo.indexed if page.seo and page.seo.indexed is defined else globalIndexDefault %}
    {% if not pageIndexed %}
    <meta name="robots" content="noindex, nofollow" />
    {% endif %}
    {% set slugPath = '' %}
    {% if site and site.slug %}
      {% set slugPath = site.slug %}
    {% elseif site and site.slugValue %}
      {% set slugPath = site.slugValue %}
    {% endif %}
    {% set slugPart = slugPath %}
    {% if slugPart and (slugPart | first) == '/' %}
      {% set slugPart = slugPart | slice(1) %}
    {% endif %}
    {% if slugPart %}
      {% set assetBase = '/sites/' ~ slugPart ~ '/assets' %}
    {% else %}
      {% set assetBase = '/assets' %}
    {% endif %}
    <link rel="stylesheet" href="{{ assetBase }}/theme.css" />
    <link rel="stylesheet" href="{{ assetBase }}/site.css" />
    {# US9.B2 - Analytics head code injection #}
    {% if site.analytics and site.analytics.headCode %}
    {{ site.analytics.headCode | safe }}
    {% endif %}
  </head>
  <body class="font-['Inter'] text-slate-900">
    {% set collectionMap = collections or {} %}
    <header class="bg-white shadow-sm border-b border-slate-100">
      <div class="max-w-5xl mx-auto px-6 py-8 space-y-2">
        <p class="text-xs uppercase tracking-[0.2em] text-slate-400">Preview responsive</p>
        <h1 class="text-3xl font-bold">{{ site.title or 'Site' }}</h1>
        <p class="text-sm text-slate-500">{{ page.slug or '/' }}</p>
      </div>
    </header>

    <main class="max-w-5xl mx-auto px-6 py-10 space-y-6">
      {# Helper pour normaliser les classes - ajoute le préfixe si manquant #}
      {% macro normalizeClass(value, prefix, defaultValue) %}
        {%- if not value -%}
          {{- defaultValue -}}
        {%- elif value | string | first == prefix | first or value | string | slice(0, prefix | length) == prefix -%}
          {{- value -}}
        {%- else -%}
          {{- prefix ~ value -}}
        {%- endif -%}
      {% endmacro %}

      {% for block in page.blocks or [] %}
        {% set raw_type = (block.type or '') %}
        {% set type = raw_type | lower %}
        {% set settings = block.settings or {} %}
        {% if type == 'hero' %}
          {% set content_align = settings.contentAlign or 'items-center' %}
          {% set has_image = settings.image %}
          {# Layout (position image/texte) #}
          {% set layout = settings.layout or 'flex-col' %}
          {% set is_row = 'row' in layout %}
          {% set is_reverse = 'reverse' in layout %}
          {# Hauteur de section #}
          {% set height = settings.height or 'min-h-[50vh]' %}
          {# Overlay #}
          {% set overlay = settings.overlay or 'bg-black/0' %}
          {# Taille du titre #}
          {% set title_size = settings.titleSize or 'text-4xl' %}
          {# Style card #}
          {% set hero_bg = settings.bg if settings.bg and 'bg-' in settings.bg else 'bg-gradient-to-br from-violet-50 to-white' %}
          {% set hero_radius = settings.borderRadius if settings.borderRadius and 'rounded' in settings.borderRadius else 'rounded-3xl' %}
          {% set hero_shadow = settings.shadow if settings.shadow and 'shadow' in settings.shadow else 'shadow-none' %}
          {# Classes de grille selon layout #}
          {% if is_row %}
            {% set grid_class = 'grid gap-10 lg:grid-cols-2 ' ~ content_align %}
          {% else %}
            {% set grid_class = 'flex flex-col gap-8 ' ~ content_align %}
          {% endif %}
          <section
            data-preview-block="{{ block.id }}"
            class="relative overflow-hidden {{ hero_bg }} {{ hero_radius }} {{ hero_shadow }} {{ height }} px-10 py-16"
          >
            {# Overlay sur l'image de fond si présent #}
            {% if overlay != 'bg-black/0' %}
              <div class="absolute inset-0 {{ overlay }}"></div>
            {% endif %}
            <div class="relative z-10 {{ grid_class }} {% if is_reverse %}lg:flex-row-reverse{% endif %}">
              {# Contenu texte #}
              <div class="flex flex-col gap-4 {% if is_row %}{% else %}items-center text-center{% endif %}" {% if is_reverse %}style="order: 2"{% endif %}>
                <p class="text-xs uppercase tracking-[0.3em] text-violet-400">
                  {{ block.status or 'Brouillon' }}
                </p>
                <h2 class="{{ title_size }} font-bold leading-tight">
                  {{ settings.title or block.label or 'Titre du hero' }}
                </h2>
                <p class="text-lg text-slate-600 max-w-2xl">
                  {{ settings.subtitle or block.description or 'Ajoutez un sous-titre inspirant pour ce hero.' }}
                </p>
                {% if settings.ctaLabel %}
                  <a
                    href="{{ settings.ctaUrl or '#' }}"
                    class="inline-flex w-fit items-center justify-center rounded-full bg-violet-600 px-5 py-2 text-white text-sm font-semibold hover:bg-violet-500"
                  >
                    {{ settings.ctaLabel }}
                  </a>
                {% endif %}
              </div>
              {# Image #}
              {% if has_image %}
                <div class="flex justify-center {% if is_row %}lg:justify-end{% endif %}" {% if is_reverse %}style="order: 1"{% endif %}>
                  <div class="relative w-full max-w-sm overflow-hidden rounded-[2rem] border border-white/60 shadow-2xl ring-1 ring-violet-100/80">
                    <div
                      class="h-64 w-full bg-slate-200 bg-cover bg-center"
                      style="{{ 'background-image:url(' ~ settings.image ~ ');' }}"
                      aria-label="Illustration du hero"
                    ></div>
                    <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-black/10 to-transparent"></div>
                  </div>
                </div>
              {% endif %}
            </div>
          </section>
        {% elif type == 'paragraphe' or type == 'texte' %}
          {% set text_class = settings.align if settings.align and 'text-' in settings.align else 'text-left' %}
          {% set para_bg = settings.bg if settings.bg and 'bg-' in settings.bg else 'bg-white' %}
          {% set para_radius = settings.borderRadius if settings.borderRadius and 'rounded' in settings.borderRadius else 'rounded-2xl' %}
          {% set para_shadow = settings.shadow if settings.shadow and 'shadow' in settings.shadow else 'shadow-sm' %}
          {# Tailles du titre et du texte #}
          {% set title_size = settings.titleSize or 'text-2xl' %}
          {% set text_size = settings.textSize or 'text-base' %}
          {% set spacing = settings.spacing or 'space-y-4' %}
          <section
            data-preview-block="{{ block.id }}"
            class="{{ para_bg }} {{ para_radius }} {{ para_shadow }} p-8 border border-slate-100 {{ text_class }} {{ spacing }}"
          >
            <h3 class="{{ title_size }} font-semibold mb-2">
              {{ settings.title or block.label or 'Titre du paragraphe' }}
            </h3>
            <p class="{{ text_size }} text-slate-600">
              {{ settings.content or block.description or 'Ajoutez votre texte éditorial ici.' }}
            </p>
          </section>
        {% elif type == 'image' %}
          {% set src = settings.src or '' %}
          {% set img_bg = settings.bg if settings.bg and 'bg-' in settings.bg else 'bg-white' %}
          {% set img_radius = settings.borderRadius if settings.borderRadius and 'rounded' in settings.borderRadius else 'rounded-2xl' %}
          {% set img_shadow = settings.shadow if settings.shadow and 'shadow' in settings.shadow else 'shadow-sm' %}
          <figure
            data-preview-block="{{ block.id }}"
            class="{{ img_bg }} {{ img_radius }} {{ img_shadow }} border border-slate-100 p-4 space-y-3"
          >
            <div
              class="h-64 w-full rounded-2xl bg-slate-200 bg-cover bg-center"
              style="{{ src and ('background-image:url(' ~ src ~ ');') or '' }}"
            ></div>
            <div>
              <h3 class="text-xl font-semibold">{{ block.label or 'Bloc image' }}</h3>
              <p class="text-sm text-slate-500">{{ block.description or 'Illustration' }}</p>
            </div>
            {% if settings.showCaption and settings.caption %}
              <figcaption class="text-xs text-slate-500">{{ settings.caption }}</figcaption>
            {% endif %}
          </figure>
        {% elif type == 'groupe' or type == 'sections' or type == 'grid' %}
          {% set mobile_class = settings.columnsMobile if settings.columnsMobile and 'grid-cols' in settings.columnsMobile else 'grid-cols-1' %}
          {% set desktop_class = settings.columnsDesktop if settings.columnsDesktop and 'grid-cols' in settings.columnsDesktop else 'md:grid-cols-3' %}
          {% set gap_class = settings.gap if settings.gap and 'gap-' in settings.gap else 'gap-4' %}
          {% set items_align = settings.itemsAlign if settings.itemsAlign and 'items-' in settings.itemsAlign else 'items-start' %}
          {% set group_bg = settings.bg if settings.bg and 'bg-' in settings.bg else 'bg-white' %}
          {% set group_radius = settings.borderRadius if settings.borderRadius and 'rounded' in settings.borderRadius else 'rounded-2xl' %}
          {% set group_shadow = settings.shadow if settings.shadow and 'shadow' in settings.shadow else 'shadow-sm' %}
          <section
            data-preview-block="{{ block.id }}"
            class="{{ group_bg }} {{ group_radius }} {{ group_shadow }} border border-slate-100 p-6 space-y-3"
          >
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-lg font-semibold">{{ block.label or 'Bloc groupe' }}</h3>
                <p class="text-sm text-slate-500">
                  {{ block.description or 'Disposition responsive' }}
                </p>
              </div>
              <span class="text-xs text-slate-400">
                {{ mobile_class }} · {{ desktop_class }}
              </span>
            </div>
          <div class="grid {{ gap_class }} {{ mobile_class }} {{ desktop_class }} {{ items_align }}">
            <div class="h-24 rounded-2xl bg-slate-50 border border-slate-100"></div>
            <div class="h-24 rounded-2xl bg-slate-50 border border-slate-100"></div>
            <div class="h-24 rounded-2xl bg-slate-50 border border-slate-100"></div>
            <div class="h-24 rounded-2xl bg-slate-50 border border-slate-100"></div>
          </div>
        </section>
        {% elif type == 'collectiongrid' or type == 'collection grid' or raw_type == 'CollectionGrid' %}
          {% set cid = block.collectionId or settings.collectionId %}
          {% set limit = settings.limit or 6 %}
          {% set allItems = collectionMap[cid] or [] %}
          {% set itemCount = allItems | length %}
          {% set coll_mobile = settings.columnsMobile if settings.columnsMobile and 'grid-cols' in settings.columnsMobile else 'grid-cols-1' %}
          {% set coll_desktop = settings.columnsDesktop if settings.columnsDesktop and 'grid-cols' in settings.columnsDesktop else 'md:grid-cols-2' %}
          {% set coll_gap = settings.gap if settings.gap and 'gap-' in settings.gap else 'gap-3' %}
          {% set coll_card_rounded = settings.cardRounded if settings.cardRounded and 'rounded' in settings.cardRounded else 'rounded-2xl' %}
          {% set coll_bg = settings.bg if settings.bg and 'bg-' in settings.bg else 'bg-white' %}
          {% set coll_radius = settings.borderRadius if settings.borderRadius and 'rounded' in settings.borderRadius else 'rounded-2xl' %}
          {% set coll_shadow = settings.shadow if settings.shadow and 'shadow' in settings.shadow else 'shadow-sm' %}
          <section
            data-preview-block="{{ block.id }}"
            class="{{ coll_bg }} {{ coll_radius }} {{ coll_shadow }} border border-slate-100 p-6 space-y-3"
          >
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-lg font-semibold">{{ block.label or 'Grille de contenus' }}</h3>
                <p class="text-sm text-slate-500">
                  {{ block.description or 'Items issus de la collection sélectionnée.' }}
                </p>
              </div>
              <span class="text-xs text-slate-400">{{ itemCount }} item(s)</span>
            </div>
            {% if itemCount == 0 %}
              <p class="text-sm text-slate-500">Aucun item disponible dans cette collection.</p>
            {% else %}
              <div class="grid {{ coll_gap }} {{ coll_mobile }} {{ coll_desktop }}">
                {% for item in allItems %}
                  {% if loop.index0 < limit %}
                  <article class="{{ coll_card_rounded }} border border-slate-100 bg-slate-50 p-4 space-y-2">
                    <p class="text-xs uppercase tracking-[0.2em] text-slate-400">{{ item.status or '' }}</p>
                    <h4 class="text-lg font-semibold text-slate-900">{{ item.title or 'Item' }}</h4>
                    <p class="text-sm text-slate-600">{{ item.summary or item.excerpt or '' }}</p>
                  </article>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          </section>
        {% elif type == 'form' or type == 'formulaire' or raw_type == 'Form' %}
          {% set formTitle = settings.formTitle or 'Contactez-nous' %}
          {% set actionUrl = settings.actionUrl or '#' %}
          {% set method = settings.method or 'POST' %}
          {% set submitLabel = settings.submitLabel or 'Envoyer' %}
          {% set form_max_width = settings.maxWidth if settings.maxWidth and 'max-w-' in settings.maxWidth else 'max-w-lg' %}
          {% set form_align = settings.align if settings.align and ('mx-' in settings.align or 'ml-' in settings.align) else 'mx-auto' %}
          {% set form_spacing = settings.spacing if settings.spacing and 'space-y-' in settings.spacing else 'space-y-4' %}
          {% set form_btn_rounded = settings.buttonRounded if settings.buttonRounded and 'rounded' in settings.buttonRounded else 'rounded-xl' %}
          {% set form_bg = settings.bg if settings.bg and 'bg-' in settings.bg else 'bg-gradient-to-br from-violet-50 to-white' %}
          {% set form_radius = settings.borderRadius if settings.borderRadius and 'rounded' in settings.borderRadius else 'rounded-2xl' %}
          {% set form_shadow = settings.shadow if settings.shadow and 'shadow' in settings.shadow else 'shadow-none' %}
          <section
            data-preview-block="{{ block.id }}"
            class="{{ form_bg }} {{ form_radius }} {{ form_shadow }} {{ form_max_width }} {{ form_align }} border border-violet-100 p-8 space-y-6"
          >
            <div>
              <h3 class="text-2xl font-bold text-slate-900">{{ formTitle }}</h3>
              <p class="text-sm text-slate-500">{{ block.description or 'Envoyez-nous un message.' }}</p>
            </div>
            <form action="{{ actionUrl }}" method="{{ method }}" class="{{ form_spacing }}">
              <div class="grid gap-4 md:grid-cols-2">
                <label class="block space-y-1">
                  <span class="text-sm font-medium text-slate-700">Nom</span>
                  <input type="text" name="name" required
                    class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-sm focus:border-violet-400 focus:ring-2 focus:ring-violet-100"
                    placeholder="Votre nom" />
                </label>
                <label class="block space-y-1">
                  <span class="text-sm font-medium text-slate-700">Email</span>
                  <input type="email" name="email" required
                    class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-sm focus:border-violet-400 focus:ring-2 focus:ring-violet-100"
                    placeholder="votre@email.com" />
                </label>
              </div>
              <label class="block space-y-1">
                <span class="text-sm font-medium text-slate-700">Message</span>
                <textarea name="message" rows="4" required
                  class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-sm focus:border-violet-400 focus:ring-2 focus:ring-violet-100"
                  placeholder="Votre message..."></textarea>
              </label>
              <div class="flex items-center justify-between">
                <p class="text-xs text-slate-400">
                  {% if settings.serviceName %}Service : {{ settings.serviceName }}{% endif %}
                </p>
                <button type="submit"
                  class="{{ form_btn_rounded }} bg-violet-600 px-6 py-2.5 text-sm font-semibold text-white hover:bg-violet-500 focus:ring-2 focus:ring-violet-300">
                  {{ submitLabel }}
                </button>
              </div>
            </form>
          </section>
        {% elif type == 'newsletterembed' or type == 'newsletter' or raw_type == 'NewsletterEmbed' %}
          {% set nlTitle = settings.title or 'Restez informé' %}
          {% set embedCode = settings.embedCode or '' %}
          {% set nl_max_width = settings.maxWidth if settings.maxWidth and 'max-w-' in settings.maxWidth else 'max-w-lg' %}
          {% set nl_align = settings.align if settings.align and ('mx-' in settings.align or 'ml-' in settings.align) else 'mx-auto' %}
          {% set nl_padding = settings.padding if settings.padding and 'p-' in settings.padding else 'p-8' %}
          {% set nl_bg = settings.bg if settings.bg and 'bg-' in settings.bg else 'bg-gradient-to-br from-sky-50 to-white' %}
          {% set nl_radius = settings.borderRadius if settings.borderRadius and 'rounded' in settings.borderRadius else 'rounded-2xl' %}
          {% set nl_shadow = settings.shadow if settings.shadow and 'shadow' in settings.shadow else 'shadow-none' %}
          <section
            data-preview-block="{{ block.id }}"
            class="{{ nl_bg }} {{ nl_radius }} {{ nl_shadow }} {{ nl_max_width }} {{ nl_align }} {{ nl_padding }} border border-sky-100 space-y-4"
          >
            <div>
              <h3 class="text-2xl font-bold text-slate-900">{{ nlTitle }}</h3>
              <p class="text-sm text-slate-500">{{ block.description or 'Inscrivez-vous à notre newsletter.' }}</p>
              {% if settings.serviceName %}
                <p class="text-xs text-slate-400 mt-1">Via {{ settings.serviceName }}</p>
              {% endif %}
            </div>
            {% if embedCode %}
              <div class="newsletter-embed rounded-xl overflow-hidden">
                {{ embedCode | safe }}
              </div>
            {% else %}
              <div class="rounded-xl border border-dashed border-sky-200 bg-sky-50/50 p-6 text-center text-sm text-slate-500">
                Collez le code embed de votre service newsletter dans les paramètres du bloc.
              </div>
            {% endif %}
          </section>
        {% else %}
          <section
            data-preview-block="{{ block.id }}"
            class="bg-white rounded-2xl border border-dashed border-slate-300 p-6 text-sm text-slate-500"
          >
            Ce type de bloc ("{{ block.type or 'Bloc' }}") n'a pas encore de preview dédiée.
          </section>
        {% endif %}
      {% else %}
        <section class="bg-white rounded-2xl border border-dashed border-slate-300 p-8 text-center text-slate-500">
          Ajoutez vos premiers blocs pour visualiser la page.
        </section>
      {% endfor %}
    </main>
    {# US9.B2 - Analytics body end code injection #}
    {% if site.analytics and site.analytics.bodyEndCode %}
    {{ site.analytics.bodyEndCode | safe }}
    {% endif %}
  </body>
</html>
